# Nexus安全密码管理方案

## 概述

在企业环境中，安全地管理Nexus仓库的认证信息至关重要。本文档将详细介绍如何安全地存储和使用Nexus仓库的账号密码，确保密码不泄露的同时，实现不同包访问不同Nexus仓库的需求。

## 安全风险分析

### 常见安全风险

1. **明文密码存储**
   - 在代码仓库中提交包含明文密码的配置文件
   - 在共享环境中暴露敏感信息

2. **密码复用**
   - 多个仓库使用相同的密码
   - 长期不更换密码

3. **权限过度**
   - 使用管理员账户进行日常操作
   - 赋予不必要的权限

4. **日志泄露**
   - 在日志中记录敏感信息
   - 错误信息中包含认证详情

5. **传输安全**
   - 使用HTTP而非HTTPS传输认证信息
   - 未加密的认证令牌

## 安全密码管理方案

### 方案一：环境变量管理

这是最简单且安全的方法，适用于大多数开发场景。

#### 1. 基本实现

**Windows (PowerShell):**
```powershell
# 设置环境变量
$env:NEXUS_COMPANY_USERNAME = "company-user"
$env:NEXUS_COMPANY_PASSWORD = "secure-password"
$env:NEXUS_PROJECT_USERNAME = "project-user"
$env:NEXUS_PROJECT_PASSWORD = "another-secure-password"

# 生成Base64编码的认证Token
$env:NEXUS_COMPANY_AUTH_TOKEN = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($env:NEXUS_COMPANY_USERNAME):$($env:NEXUS_COMPANY_PASSWORD)"))
$env:NEXUS_PROJECT_AUTH_TOKEN = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($env:NEXUS_PROJECT_USERNAME):$($env:NEXUS_PROJECT_PASSWORD)"))
```

**Linux/macOS:**
```bash
# 设置环境变量
export NEXUS_COMPANY_USERNAME="company-user"
export NEXUS_COMPANY_PASSWORD="secure-password"
export NEXUS_PROJECT_USERNAME="project-user"
export NEXUS_PROJECT_PASSWORD="another-secure-password"

# 生成Base64编码的认证Token
export NEXUS_COMPANY_AUTH_TOKEN=$(echo -n "${NEXUS_COMPANY_USERNAME}:${NEXUS_COMPANY_PASSWORD}" | base64)
export NEXUS_PROJECT_AUTH_TOKEN=$(echo -n "${NEXUS_PROJECT_USERNAME}:${NEXUS_PROJECT_PASSWORD}" | base64)
```

#### 2. 在.npmrc中使用环境变量

```ini
# 公司内部包配置
@company:registry=https://nexus.company.com/repository/npm-private/
@company:_authToken=${NEXUS_COMPANY_AUTH_TOKEN}

# 项目特定包配置
@project:registry=https://nexus.company.com/repository/npm-project/
@project:_authToken=${NEXUS_PROJECT_AUTH_TOKEN}
```

#### 3. 环境变量持久化

**Windows (系统环境变量):**
```powershell
# 设置用户级环境变量
[System.Environment]::SetEnvironmentVariable('NEXUS_COMPANY_USERNAME', 'company-user', 'User')
[System.Environment]::SetEnvironmentVariable('NEXUS_COMPANY_PASSWORD', 'secure-password', 'User')

# 设置系统级环境变量（需要管理员权限）
[System.Environment]::SetEnvironmentVariable('NEXUS_COMPANY_USERNAME', 'company-user', 'Machine')
```

**Linux/macOS (.bashrc 或 .zshrc):**
```bash
# 添加到 ~/.bashrc 或 ~/.zshrc
export NEXUS_COMPANY_USERNAME="company-user"
export NEXUS_COMPANY_PASSWORD="secure-password"
export NEXUS_PROJECT_USERNAME="project-user"
export NEXUS_PROJECT_PASSWORD="another-secure-password"

# 生成认证Token
export NEXUS_COMPANY_AUTH_TOKEN=$(echo -n "${NEXUS_COMPANY_USERNAME}:${NEXUS_COMPANY_PASSWORD}" | base64)
export NEXUS_PROJECT_AUTH_TOKEN=$(echo -n "${NEXUS_PROJECT_USERNAME}:${NEXUS_PROJECT_PASSWORD}" | base64)
```

### 方案二：使用.npm-auth文件

NPM支持将认证信息存储在单独的文件中，可以更好地控制访问权限。

#### 1. 创建.npm-auth文件

在用户主目录创建 `.npmrc` 和 `.npm-auth` 文件：

**~/.npmrc:**
```ini
@company:registry=https://nexus.company.com/repository/npm-private/
@project:registry=https://nexus.company.com/repository/npm-project/
```

**~/.npm-auth:**
```ini
//nexus.company.com/repository/npm-private/:username=company-user
//nexus.company.com/repository/npm-private/:_password=base64-encoded-password
//nexus.company.com/repository/npm-project/:username=project-user
//nexus.company.com/repository/npm-project/:_password=base64-encoded-password
```

#### 2. 设置文件权限

```bash
# 设置文件权限，仅允许所有者读写
chmod 600 ~/.npm-auth
chmod 644 ~/.npmrc

# 验证权限设置
ls -la ~/.npm*
```

#### 3. 使用.npm-auth的注意事项

- 确保文件权限设置正确
- 定期检查文件完整性
- 在版本控制中排除此文件

### 方案三：使用npm-login命令

使用NPM内置的登录命令安全地存储认证信息。

#### 1. 基本用法

```bash
# 为特定作用域登录
npm login --scope=@company --registry=https://nexus.company.com/repository/npm-private/

# 输入用户名、密码和邮箱
Username: company-user
Password: [hidden]
Email: user@company.com
```

#### 2. 验证登录状态

```bash
# 检查当前配置
npm config list

# 检查特定作用域的配置
npm config get @company:registry
npm config get @company:_authToken
```

#### 3. 登出

```bash
# 登出特定作用域
npm logout --scope=@company --registry=https://nexus.company.com/repository/npm-private/

# 登出所有
npm logout
```

### 方案四：使用密钥管理系统

对于企业级应用，推荐使用专业的密钥管理系统。

#### 1. 使用HashiCorp Vault

**安装和配置Vault:**
```bash
# 安装Vault CLI
npm install -g @hashicorp/vault-cli

# 设置Vault地址和认证
export VAULT_ADDR='https://vault.company.com'
vault login
```

**存储和获取密钥:**
```bash
# 存储Nexus认证信息
vault kv put secret/nexus/company username="company-user" password="secure-password"
vault kv put secret/nexus/project username="project-user" password="another-secure-password"

# 获取认证信息并设置环境变量
export NEXUS_COMPANY_USERNAME=$(vault kv get -field=username secret/nexus/company)
export NEXUS_COMPANY_PASSWORD=$(vault kv get -field=password secret/nexus/company)
export NEXUS_PROJECT_USERNAME=$(vault kv get -field=username secret/nexus/project)
export NEXUS_PROJECT_PASSWORD=$(vault kv get -field=password secret/nexus/project)

# 生成认证Token
export NEXUS_COMPANY_AUTH_TOKEN=$(echo -n "${NEXUS_COMPANY_USERNAME}:${NEXUS_COMPANY_PASSWORD}" | base64)
export NEXUS_PROJECT_AUTH_TOKEN=$(echo -n "${NEXUS_PROJECT_USERNAME}:${NEXUS_PROJECT_PASSWORD}" | base64)
```

**自动化脚本示例:**
```bash
#!/bin/bash
# setup-npm-auth.sh

# 从Vault获取认证信息
get_nexus_credentials() {
  local repo=$1
  local username=$(vault kv get -field=username secret/nexus/$repo)
  local password=$(vault kv get -field=password secret/nexus/$repo)
  echo "$(echo -n "${username}:${password}" | base64)"
}

# 设置环境变量
export NEXUS_COMPANY_AUTH_TOKEN=$(get_nexus_credentials "company")
export NEXUS_PROJECT_AUTH_TOKEN=$(get_nexus_credentials "project")

# 更新.npmrc
cat > ~/.npmrc << EOF
@company:registry=https://nexus.company.com/repository/npm-private/
@company:_authToken=${NEXUS_COMPANY_AUTH_TOKEN}

@project:registry=https://nexus.company.com/repository/npm-project/
@project:_authToken=${NEXUS_PROJECT_AUTH_TOKEN}
EOF

echo "NPM authentication configured successfully"
```

#### 2. 使用AWS Secrets Manager

**安装和配置AWS CLI:**
```bash
# 安装AWS CLI
pip install awscli

# 配置AWS凭证
aws configure
```

**存储和获取密钥:**
```bash
# 存储Nexus认证信息
aws secretsmanager create-secret --name nexus/company --secret-string '{"username":"company-user","password":"secure-password"}'
aws secretsmanager create-secret --name nexus/project --secret-string '{"username":"project-user","password":"another-secure-password"}'

# 获取认证信息
aws secretsmanager get-secret-value --secret-id nexus/company --query SecretString --output text
```

**使用AWS SDK获取密钥:**
```javascript
// get-nexus-credentials.js
const AWS = require('aws-sdk');
const secretsManager = new AWS.SecretsManager();

async function getNexusCredentials(secretName) {
  try {
    const data = await secretsManager.getSecretValue({ SecretId: secretName }).promise();
    if ('SecretString' in data) {
      return JSON.parse(data.SecretString);
    } else {
      let buff = new Buffer(data.SecretBinary, 'base64');
      return JSON.parse(buff.toString('ascii'));
    }
  } catch (err) {
    console.error(err);
    throw err;
  }
}

async function setupNpmAuth() {
  try {
    // 获取认证信息
    const companyCreds = await getNexusCredentials('nexus/company');
    const projectCreds = await getNexusCredentials('nexus/project');
    
    // 生成Base64编码的认证Token
    const companyAuthToken = Buffer.from(`${companyCreds.username}:${companyCreds.password}`).toString('base64');
    const projectAuthToken = Buffer.from(`${projectCreds.username}:${projectCreds.password}`).toString('base64');
    
    // 更新.npmrc文件
    const fs = require('fs');
    const npmrcContent = `
@company:registry=https://nexus.company.com/repository/npm-private/
@company:_authToken=${companyAuthToken}

@project:registry=https://nexus.company.com/repository/npm-project/
@project:_authToken=${projectAuthToken}
`;
    
    fs.writeFileSync(process.env.HOME + '/.npmrc', npmrcContent.trim());
    console.log('NPM authentication configured successfully');
  } catch (err) {
    console.error('Failed to configure NPM authentication:', err);
    process.exit(1);
  }
}

setupNpmAuth();
```

#### 3. 使用Azure Key Vault

**安装和配置Azure CLI:**
```bash
# 安装Azure CLI
pip install azure-cli

# 登录Azure
az login
```

**存储和获取密钥:**
```bash
# 存储Nexus认证信息
az keyvault secret set --vault-name "my-keyvault" --name "nexus-company-username" --value "company-user"
az keyvault secret set --vault-name "my-keyvault" --name "nexus-company-password" --value "secure-password"
az keyvault secret set --vault-name "my-keyvault" --name "nexus-project-username" --value "project-user"
az keyvault secret set --vault-name "my-keyvault" --name "nexus-project-password" --value "another-secure-password"

# 获取认证信息
az keyvault secret show --vault-name "my-keyvault" --name "nexus-company-username" --query value -o tsv
az keyvault secret show --vault-name "my-keyvault" --name "nexus-company-password" --query value -o tsv
```

### 方案五：使用Docker Secrets

对于容器化环境，可以使用Docker Secrets管理敏感信息。

#### 1. 创建Docker Secrets

```bash
# 创建Nexus认证信息作为Docker Secrets
echo -n "company-user" | docker secret create nexus_company_username -
echo -n "secure-password" | docker secret create nexus_company_password -
echo -n "project-user" | docker secret create nexus_project_username -
echo -n "another-secure-password" | docker secret create nexus_project_password -
```

#### 2. 在Docker Compose中使用

```yaml
# docker-compose.yml
version: '3.7'

services:
  app:
    image: node:16
    command: sh -c "npm install && npm start"
    secrets:
      - nexus_company_username
      - nexus_company_password
      - nexus_project_username
      - nexus_project_password
    environment:
      - NEXUS_COMPANY_USERNAME_FILE=/run/secrets/nexus_company_username
      - NEXUS_COMPANY_PASSWORD_FILE=/run/secrets/nexus_company_password
      - NEXUS_PROJECT_USERNAME_FILE=/run/secrets/nexus_project_username
      - NEXUS_PROJECT_PASSWORD_FILE=/run/secrets/nexus_project_password
    volumes:
      - ./setup-npm-auth.sh:/usr/local/bin/setup-npm-auth.sh
    entrypoint: ["/usr/local/bin/setup-npm-auth.sh"]

secrets:
  nexus_company_username:
    external: true
  nexus_company_password:
    external: true
  nexus_project_username:
    external: true
  nexus_project_password:
    external: true
```

#### 3. 设置脚本

```bash
#!/bin/bash
# setup-npm-auth.sh

# 从Docker Secrets读取认证信息
NEXUS_COMPANY_USERNAME=$(cat $NEXUS_COMPANY_USERNAME_FILE)
NEXUS_COMPANY_PASSWORD=$(cat $NEXUS_COMPANY_PASSWORD_FILE)
NEXUS_PROJECT_USERNAME=$(cat $NEXUS_PROJECT_USERNAME_FILE)
NEXUS_PROJECT_PASSWORD=$(cat $NEXUS_PROJECT_PASSWORD_FILE)

# 生成Base64编码的认证Token
NEXUS_COMPANY_AUTH_TOKEN=$(echo -n "${NEXUS_COMPANY_USERNAME}:${NEXUS_COMPANY_PASSWORD}" | base64)
NEXUS_PROJECT_AUTH_TOKEN=$(echo -n "${NEXUS_PROJECT_USERNAME}:${NEXUS_PROJECT_PASSWORD}" | base64)

# 更新.npmrc文件
cat > ~/.npmrc << EOF
@company:registry=https://nexus.company.com/repository/npm-private/
@company:_authToken=${NEXUS_COMPANY_AUTH_TOKEN}

@project:registry=https://nexus.company.com/repository/npm-project/
@project:_authToken=${NEXUS_PROJECT_AUTH_TOKEN}
EOF

# 执行原始命令
exec "$@"
```

## CI/CD集成

### GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          
      - name: Configure NPM
        run: |
          echo "@company:registry=https://nexus.company.com/repository/npm-private/" >> ~/.npmrc
          echo "@company:_authToken=${{ secrets.NEXUS_COMPANY_AUTH_TOKEN }}" >> ~/.npmrc
          echo "@project:registry=https://nexus.company.com/repository/npm-project/" >> ~/.npmrc
          echo "@project:_authToken=${{ secrets.NEXUS_PROJECT_AUTH_TOKEN }}" >> ~/.npmrc
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
```

### Jenkins

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        NEXUS_COMPANY_AUTH_TOKEN = credentials('nexus-company-auth-token')
        NEXUS_PROJECT_AUTH_TOKEN = credentials('nexus-project-auth-token')
    }
    
    stages {
        stage('Setup') {
            steps {
                sh '''
                    echo "@company:registry=https://nexus.company.com/repository/npm-private/" >> ~/.npmrc
                    echo "@company:_authToken=${NEXUS_COMPANY_AUTH_TOKEN}" >> ~/.npmrc
                    echo "@project:registry=https://nexus.company.com/repository/npm-project/" >> ~/.npmrc
                    echo "@project:_authToken=${NEXUS_PROJECT_AUTH_TOKEN}" >> ~/.npmrc
                '''
            }
        }
        
        stage('Install') {
            steps {
                sh 'npm ci'
            }
        }
        
        stage('Test') {
            steps {
                sh 'npm test'
            }
        }
    }
}
```

## 安全最佳实践

### 1. 密码策略

- **复杂度要求**：使用包含大小写字母、数字和特殊字符的强密码
- **定期更换**：设置密码过期策略，定期更换密码
- **唯一性**：不同仓库使用不同的密码
- **长度要求**：密码长度至少12个字符

### 2. 访问控制

- **最小权限原则**：仅授予必要的最小权限
- **角色分离**：不同角色使用不同的认证信息
- **IP限制**：限制访问来源IP范围
- **时间限制**：限制访问时间窗口

### 3. 审计和监控

- **访问日志**：记录所有仓库访问日志
- **异常检测**：监控异常访问模式
- **定期审计**：定期审计认证信息使用情况
- **告警机制**：设置安全事件告警

### 4. 加密和传输

- **HTTPS**：始终使用HTTPS传输认证信息
- **加密存储**：敏感信息加密存储
- **安全传输**：使用安全通道传输认证信息
- **证书验证**：验证服务器证书有效性

### 5. 开发环境安全

- **环境隔离**：开发、测试、生产环境使用不同的认证信息
- **本地开发**：避免在本地开发环境使用生产认证信息
- **代码审查**：审查代码中是否包含敏感信息
- **Git忽略**：确保敏感文件不被提交到版本控制

## 常见安全问题与解决方案

### 1. 密码泄露

**问题**：密码意外泄露到代码仓库或日志中。

**解决方案**：
- 使用环境变量或密钥管理系统
- 在.gitignore中排除敏感文件
- 使用pre-commit钩子检查敏感信息
- 定期扫描代码仓库中的敏感信息

### 2. 认证失效

**问题**：认证信息过期或失效导致构建失败。

**解决方案**：
- 实现自动更新认证信息的机制
- 设置认证信息过期提醒
- 使用短期有效的认证Token
- 实现认证信息缓存和刷新机制

### 3. 权限不足

**问题**：认证信息有效但权限不足导致操作失败。

**解决方案**：
- 明确每个仓库所需的权限
- 定期审查和更新权限设置
- 使用角色基础的访问控制
- 实现权限申请和审批流程

### 4. 性能问题

**问题**：认证过程影响构建性能。

**解决方案**：
- 使用认证信息缓存
- 优化认证信息获取流程
- 并行处理多个仓库的认证
- 使用连接池减少认证开销

## 总结

安全地管理Nexus仓库的认证信息是企业级应用开发中的重要环节。通过选择合适的管理方案并遵循安全最佳实践，可以有效地保护敏感信息，同时确保开发流程的顺畅。

关键点包括：
1. 避免在代码中硬编码敏感信息
2. 使用专业的密钥管理系统
3. 实施严格的访问控制和审计
4. 定期更新和轮换认证信息
5. 在CI/CD流程中安全地使用认证信息

根据企业的具体需求和安全要求，可以选择适合的方案或组合多种方案，以实现最佳的安全性和可用性平衡。