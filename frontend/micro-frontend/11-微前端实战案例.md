# 第十一章：微前端实战案例

## 11.1 实战案例概述

微前端架构在大型企业应用中已经得到广泛应用，本章将通过几个典型的实战案例，展示微前端在不同场景下的应用实践、解决方案和最佳经验。我们将涵盖电商平台、金融系统、企业管理平台等多个领域的微前端实现，分析其架构设计、技术选型、实施过程和效果评估。

### 11.1.1 案例选择标准

在选择微前端实战案例时，我们主要考虑以下几个标准：

1. **代表性**：案例能够代表特定行业或领域的典型应用场景
2. **完整性**：案例包含完整的微前端架构设计和实现过程
3. **实用性**：案例中的解决方案具有实际应用价值，可借鉴性强
4. **多样性**：案例涵盖不同的技术栈和实现方案
5. **成熟度**：案例已经在生产环境中得到验证

### 11.1.2 案例分析框架

为了系统地分析每个实战案例，我们采用以下分析框架：

1. **业务背景**：介绍案例的业务场景和需求背景
2. **技术挑战**：分析案例面临的技术挑战和问题
3. **架构设计**：详述微前端架构的设计思路和方案
4. **实现细节**：展示关键代码和实现技术
5. **效果评估**：评估微前端实施后的效果和价值
6. **经验总结**：总结案例中的关键经验和教训

## 11.2 案例一：大型电商平台微前端改造

### 11.2.1 业务背景

某大型电商平台拥有数百万商品和千万级用户，其前端系统包含商品展示、购物车、订单管理、支付、用户中心等多个功能模块。随着业务快速发展，原有的单体前端应用面临以下挑战：

1. **开发效率低**：多个团队并行开发，代码冲突频繁，集成困难
2. **技术栈陈旧**：部分模块使用过时的技术栈，难以升级
3. **发布周期长**：任何小改动都需要整个应用重新发布
4. **维护成本高**：代码耦合度高，修改一处可能影响多处
5. **用户体验差**：应用加载时间长，性能优化困难

### 11.2.2 技术挑战

电商平台微前端改造面临的主要技术挑战包括：

1. **状态共享**：购物车、用户信息等状态需要在多个微应用间共享
2. **路由管理**：统一的URL管理和页面跳转
3. **性能优化**：减少重复加载，提高首屏加载速度
4. **数据一致性**：确保各微应用间数据的一致性
5. **安全隔离**：各微应用间的安全隔离和权限控制

### 11.2.3 架构设计

#### 11.2.3.1 整体架构

电商平台采用基于qiankun的微前端架构，整体设计如下：

```javascript
//电商平台微前端架构设计
class ECommerceMicroFrontend {
  constructor() {
    this.config = {
      // 主应用配置
      mainApp: {
        name: 'ecommerce-main',
        entry: '//main.example.com',
        container: '#main-container',
        activeRule: '/main'
      },
      
      // 微应用配置
      microApps: [
        {
          name: 'product-list',
          entry: '//product.example.com',
          container: '#product-container',
          activeRule: '/products',
          props: {
            routerBase: '/products'
          }
        },
        {
          name: 'shopping-cart',
          entry: '//cart.example.com',
          container: '#cart-container',
          activeRule: '/cart',
          props: {
            routerBase: '/cart'
          }
        },
        {
          name: 'order-management',
          entry: '//order.example.com',
          container: '#order-container',
          activeRule: '/orders',
          props: {
            routerBase: '/orders'
          }
        },
        {
          name: 'payment',
          entry: '//payment.example.com',
          container: '#payment-container',
          activeRule: '/payment',
          props: {
            routerBase: '/payment'
          }
        },
        {
          name: 'user-center',
          entry: '//user.example.com',
          container: '#user-container',
          activeRule: '/user',
          props: {
            routerBase: '/user'
          }
        }
      ],
      
      // 全局配置
      globalConfig: {
        // 沙箱配置
        sandbox: {
          strictStyleIsolation: true,
          experimentalStyleIsolation: true
        },
        
        // 预加载配置
        prefetch: true,
        
        // 生命周期配置
        lifeCycles: {
          beforeLoad: [
            app => {
              console.log(`${app.name} 加载前`);
            }
          ],
          beforeMount: [
            app => {
              console.log(`${app.name} 挂载前`);
            }
          ],
          afterMount: [
            app => {
              console.log(`${app.name} 挂载后`);
            }
          ],
          beforeUnmount: [
            app => {
              console.log(`${app.name} 卸载前`);
            }
          ],
          afterUnmount: [
            app => {
              console.log(`${app.name} 卸载后`);
            }
          ]
        }
      }
    };
  }
  
  // 初始化微前端
  init() {
    this.registerMicroApps();
    this.start();
    this.setupGlobalState();
    this.setupErrorHandler();
  }
  
  // 注册微应用
  registerMicroApps() {
    const { microApps } = this.config;
    
    microApps.forEach(app => {
      this.enhanceMicroApp(app);
    });
    
    qiankun.registerMicroApps(microApps, this.config.globalConfig.lifeCycles);
  }
  
  // 增强微应用配置
  enhanceMicroApp(app) {
    // 添加通用props
    app.props = {
      ...app.props,
      // 全局状态
      globalState: this.getGlobalState(),
      // 路由
      router: this.getRouter(),
      // 工具函数
      utils: this.getUtils(),
      // API服务
      api: this.getApiService(),
      // 用户信息
      userInfo: this.getUserInfo()
    };
  }
  
  // 启动微前端
  start() {
    qiankun.start(this.config.globalConfig);
  }
  
  // 设置全局状态
  setupGlobalState() {
    // 全局状态管理
    this.globalState = qiankun.initGlobalState({
      // 用户信息
      userInfo: null,
      // 购物车信息
      cart: {
        items: [],
        total: 0,
        count: 0
      },
      // 全局配置
      config: {
        theme: 'light',
        language: 'zh-CN'
      }
    });
    
    // 监听状态变化
    this.globalState.onGlobalStateChange((state, prev) => {
      console.log('主应用检测到状态变化:', state, prev);
      this.handleGlobalStateChange(state, prev);
    });
  }
  
  // 处理全局状态变化
  handleGlobalStateChange(state, prev) {
    // 购物车变化时同步到本地存储
    if (state.cart !== prev.cart) {
      localStorage.setItem('cart', JSON.stringify(state.cart));
    }
    
    // 用户信息变化时同步到本地存储
    if (state.userInfo !== prev.userInfo) {
      if (state.userInfo) {
        localStorage.setItem('userInfo', JSON.stringify(state.userInfo));
      } else {
        localStorage.removeItem('userInfo');
      }
    }
  }
  
  // 设置错误处理
  setupErrorHandler() {
    qiankun.addErrorHandler(err => {
      console.error('微前端错误:', err);
      this.handleMicroAppError(err);
    });
  }
  
  // 处理微应用错误
  handleMicroAppError(err) {
    // 错误上报
    this.reportError(err);
    
    // 错误恢复
    if (err.appOrParcelName) {
      this.reloadMicroApp(err.appOrParcelName);
    }
  }
  
  // 获取全局状态
  getGlobalState() {
    return {
      setGlobalState: this.globalState.setGlobalState.bind(this.globalState),
      onGlobalStateChange: this.globalState.onGlobalStateChange.bind(this.globalState)
    };
  }
  
  // 获取路由
  getRouter() {
    return {
      push: (path) => {
        window.history.pushState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      replace: (path) => {
        window.history.replaceState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      go: (n) => {
        window.history.go(n);
      },
      back: () => {
        window.history.back();
      },
      forward: () => {
        window.history.forward();
      }
    };
  }
  
  // 获取工具函数
  getUtils() {
    return {
      // 格式化价格
      formatPrice: (price) => {
        return `¥${price.toFixed(2)}`;
      },
      
      // 格式化日期
      formatDate: (date, format = 'YYYY-MM-DD') => {
        // 日期格式化实现
        return date; // 简化实现
      },
      
      // 防抖函数
      debounce: (func, wait) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // 节流函数
      throttle: (func, wait) => {
        let lastTime = 0;
        return function(...args) {
          const now = Date.now();
          if (now - lastTime >= wait) {
            lastTime = now;
            return func.apply(this, args);
          }
        };
      }
    };
  }
  
  // 获取API服务
  getApiService() {
    return {
      // 商品API
      product: {
        getList: (params) => {
          return fetch('/api/products', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          }).then(res => res.json());
        },
        getDetail: (id) => {
          return fetch(`/api/products/${id}`).then(res => res.json());
        }
      },
      
      // 购物车API
      cart: {
        get: () => {
          return fetch('/api/cart').then(res => res.json());
        },
        add: (productId, quantity) => {
          return fetch('/api/cart/items', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId, quantity })
          }).then(res => res.json());
        },
        update: (itemId, quantity) => {
          return fetch(`/api/cart/items/${itemId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ quantity })
          }).then(res => res.json());
        },
        remove: (itemId) => {
          return fetch(`/api/cart/items/${itemId}`, {
            method: 'DELETE'
          }).then(res => res.json());
        }
      },
      
      // 订单API
      order: {
        create: (orderData) => {
          return fetch('/api/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
          }).then(res => res.json());
        },
        getList: (params) => {
          return fetch('/api/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          }).then(res => res.json());
        },
        getDetail: (id) => {
          return fetch(`/api/orders/${id}`).then(res => res.json());
        }
      },
      
      // 用户API
      user: {
        login: (credentials) => {
          return fetch('/api/user/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(credentials)
          }).then(res => res.json());
        },
        logout: () => {
          return fetch('/api/user/logout', {
            method: 'POST'
          }).then(res => res.json());
        },
        getInfo: () => {
          return fetch('/api/user/info').then(res => res.json());
        }
      }
    };
  }
  
  // 获取用户信息
  getUserInfo() {
    try {
      const userInfo = localStorage.getItem('userInfo');
      return userInfo ? JSON.parse(userInfo) : null;
    } catch (e) {
      console.error('获取用户信息失败:', e);
      return null;
    }
  }
  
  // 错误上报
  reportError(err) {
    // 错误上报实现
    console.error('错误上报:', err);
  }
  
  // 重载微应用
  reloadMicroApp(appName) {
    console.log(`重载微应用: ${appName}`);
    // 实现微应用重载逻辑
  }
}

// 导出电商平台微前端实例
export default new ECommerceMicroFrontend();
```

#### 11.2.3.2 状态管理设计

电商平台的状态管理采用全局状态与本地状态相结合的方式：

```javascript
// 电商平台状态管理
class ECommerceStateManager {
  constructor(globalState) {
    this.globalState = globalState;
    this.localStates = {};
    this.stateSubscribers = {};
  }
  
  // 初始化状态
  init() {
    this.initGlobalState();
    this.setupStateSync();
  }
  
  // 初始化全局状态
  initGlobalState() {
    // 从本地存储恢复状态
    const savedCart = this.getFromLocalStorage('cart');
    const savedUserInfo = this.getFromLocalStorage('userInfo');
    const savedConfig = this.getFromLocalStorage('config');
    
    // 设置初始全局状态
    this.globalState.setGlobalState({
      userInfo: savedUserInfo || null,
      cart: savedCart || {
        items: [],
        total: 0,
        count: 0
      },
      config: savedConfig || {
        theme: 'light',
        language: 'zh-CN'
      }
    });
  }
  
  // 设置状态同步
  setupStateSync() {
    // 监听全局状态变化
    this.globalState.onGlobalStateChange((state, prev) => {
      // 同步关键状态到本地存储
      if (state.cart !== prev.cart) {
        this.setToLocalStorage('cart', state.cart);
      }
      
      if (state.userInfo !== prev.userInfo) {
        if (state.userInfo) {
          this.setToLocalStorage('userInfo', state.userInfo);
        } else {
          this.removeLocalStorage('userInfo');
        }
      }
      
      if (state.config !== prev.config) {
        this.setToLocalStorage('config', state.config);
      }
    });
  }
  
  // 设置本地状态
  setLocalState(appName, state) {
    if (!this.localStates[appName]) {
      this.localStates[appName] = {};
    }
    
    this.localStates[appName] = {
      ...this.localStates[appName],
      ...state
    };
    
    // 通知订阅者
    this.notifyStateSubscribers(appName, state);
  }
  
  // 获取本地状态
  getLocalState(appName) {
    return this.localStates[appName] || {};
  }
  
  // 订阅状态变化
  subscribe(appName, callback) {
    if (!this.stateSubscribers[appName]) {
      this.stateSubscribers[appName] = [];
    }
    
    this.stateSubscribers[appName].push(callback);
    
    // 返回取消订阅函数
    return () => {
      const index = this.stateSubscribers[appName].indexOf(callback);
      if (index > -1) {
        this.stateSubscribers[appName].splice(index, 1);
      }
    };
  }
  
  // 通知状态订阅者
  notifyStateSubscribers(appName, state) {
    if (this.stateSubscribers[appName]) {
      this.stateSubscribers[appName].forEach(callback => {
        callback(state);
      });
    }
  }
  
  // 购物车操作
  cartOperations = {
    // 添加商品到购物车
    addItem: (product, quantity = 1) => {
      const currentState = this.globalState.getGlobalState();
      const { cart } = currentState;
      
      // 检查商品是否已在购物车中
      const existingItemIndex = cart.items.findIndex(item => item.id === product.id);
      
      let newItems;
      if (existingItemIndex > -1) {
        // 更新已存在商品的数量
        newItems = [...cart.items];
        newItems[existingItemIndex] = {
          ...newItems[existingItemIndex],
          quantity: newItems[existingItemIndex].quantity + quantity
        };
      } else {
        // 添加新商品到购物车
        newItems = [
          ...cart.items,
          {
            ...product,
            quantity
          }
        ];
      }
      
      // 计算总价和数量
      const total = newItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const count = newItems.reduce((sum, item) => sum + item.quantity, 0);
      
      // 更新全局状态
      this.globalState.setGlobalState({
        cart: {
          items: newItems,
          total,
          count
        }
      });
    },
    
    // 更新购物车商品数量
    updateItemQuantity: (productId, quantity) => {
      const currentState = this.globalState.getGlobalState();
      const { cart } = currentState;
      
      const newItems = cart.items.map(item => 
        item.id === productId ? { ...item, quantity } : item
      );
      
      // 计算总价和数量
      const total = newItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const count = newItems.reduce((sum, item) => sum + item.quantity, 0);
      
      // 更新全局状态
      this.globalState.setGlobalState({
        cart: {
          items: newItems,
          total,
          count
        }
      });
    },
    
    // 从购物车移除商品
    removeItem: (productId) => {
      const currentState = this.globalState.getGlobalState();
      const { cart } = currentState;
      
      const newItems = cart.items.filter(item => item.id !== productId);
      
      // 计算总价和数量
      const total = newItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const count = newItems.reduce((sum, item) => sum + item.quantity, 0);
      
      // 更新全局状态
      this.globalState.setGlobalState({
        cart: {
          items: newItems,
          total,
          count
        }
      });
    },
    
    // 清空购物车
    clear: () => {
      this.globalState.setGlobalState({
        cart: {
          items: [],
          total: 0,
          count: 0
        }
      });
    }
  };
  
  // 用户操作
  userOperations = {
    // 用户登录
    login: (userInfo) => {
      this.globalState.setGlobalState({
        userInfo
      });
    },
    
    // 用户登出
    logout: () => {
      this.globalState.setGlobalState({
        userInfo: null
      });
    },
    
    // 更新用户信息
    updateInfo: (userInfo) => {
      const currentState = this.globalState.getGlobalState();
      this.globalState.setGlobalState({
        userInfo: {
          ...currentState.userInfo,
          ...userInfo
        }
      });
    }
  };
  
  // 配置操作
  configOperations = {
    // 更新主题
    updateTheme: (theme) => {
      const currentState = this.globalState.getGlobalState();
      this.globalState.setGlobalState({
        config: {
          ...currentState.config,
          theme
        }
      });
    },
    
    // 更新语言
    updateLanguage: (language) => {
      const currentState = this.globalState.getGlobalState();
      this.globalState.setGlobalState({
        config: {
          ...currentState.config,
          language
        }
      });
    }
  };
  
  // 本地存储操作
  getFromLocalStorage(key) {
    try {
      const value = localStorage.getItem(key);
      return value ? JSON.parse(value) : null;
    } catch (e) {
      console.error(`从本地存储获取${key}失败:`, e);
      return null;
    }
  }
  
  setToLocalStorage(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.error(`设置${key}到本地存储失败:`, e);
    }
  }
  
  removeLocalStorage(key) {
    try {
      localStorage.removeItem(key);
    } catch (e) {
      console.error(`从本地存储移除${key}失败:`, e);
    }
  }
}

export default ECommerceStateManager;
```

### 11.2.4 实现细节

#### 11.2.4.1 商品列表微应用

商品列表微应用负责展示商品列表、商品搜索和筛选功能：

```javascript
// 商品列表微应用入口
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter as Router, Route, Switch, useHistory } from 'react-router-dom';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/es/locale/zh_CN';
import ProductList from './components/ProductList';
import ProductDetail from './components/ProductDetail';
import './index.css';

let globalState = null;
let router = null;
let api = null;
let userInfo = null;

// 生命周期 - 导出三个必需的生命周期函数
export async function bootstrap() {
  console.log('商品列表微应用 bootstrap');
}

export async function mount(props) {
  console.log('商品列表微应用 mount', props);
  
  // 获取主应用传递的props
  ({ globalState, router, api, userInfo } = props);
  
  // 渲染微应用
  ReactDOM.render(
    <ConfigProvider locale={zhCN}>
      <Router basename={props.routerBase}>
        <App />
      </Router>
    </ConfigProvider>,
    props.container ? props.container.querySelector('#product-container') : document.getElementById('product-container')
  );
}

export async function unmount(props) {
  console.log('商品列表微应用 unmount');
  ReactDOM.unmountComponentAtNode(
    props.container ? props.container.querySelector('#product-container') : document.getElementById('product-container')
  );
}

// 主应用组件
function App() {
  return (
    <div className="product-app">
      <Switch>
        <Route exact path="/" component={ProductList} />
        <Route path="/detail/:id" component={ProductDetail} />
      </Switch>
    </div>
  );
}

// 导出全局状态、路由和API供组件使用
export { globalState, router, api, userInfo };
```

商品列表组件实现：

```javascript
// 商品列表组件
import React, { useState, useEffect } from 'react';
import { Card, Row, Col, Input, Select, Button, Pagination, Spin, message } from 'antd';
import { SearchOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { globalState, router, api, userInfo } from '../index';
import './ProductList.css';

const { Option } = Select;
const { Search } = Input;

function ProductList() {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 12,
    total: 0
  });
  const [filters, setFilters] = useState({
    keyword: '',
    category: '',
    sortBy: 'default',
    priceRange: ''
  });
  
  // 获取商品列表
  const fetchProducts = async (page = 1, pageSize = 12) => {
    setLoading(true);
    try {
      const params = {
        page,
        pageSize,
        keyword: filters.keyword,
        category: filters.category,
        sortBy: filters.sortBy,
        priceRange: filters.priceRange
      };
      
      const data = await api.product.getList(params);
      
      setProducts(data.list || []);
      setPagination({
        current: data.current || page,
        pageSize: data.pageSize || pageSize,
        total: data.total || 0
      });
    } catch (error) {
      console.error('获取商品列表失败:', error);
      message.error('获取商品列表失败，请重试');
    } finally {
      setLoading(false);
    }
  };
  
  // 初始加载
  useEffect(() => {
    fetchProducts();
  }, []);
  
  // 处理搜索
  const handleSearch = (value) => {
    setFilters({
      ...filters,
      keyword: value
    });
    fetchProducts(1);
  };
  
  // 处理分类筛选
  const handleCategoryChange = (value) => {
    setFilters({
      ...filters,
      category: value
    });
    fetchProducts(1);
  };
  
  // 处理排序
  const handleSortChange = (value) => {
    setFilters({
      ...filters,
      sortBy: value
    });
    fetchProducts(1);
  };
  
  // 处理价格区间筛选
  const handlePriceRangeChange = (value) => {
    setFilters({
      ...filters,
      priceRange: value
    });
    fetchProducts(1);
  };
  
  // 处理分页
  const handlePageChange = (page, pageSize) => {
    fetchProducts(page, pageSize);
  };
  
  // 添加到购物车
  const addToCart = (product) => {
    if (!userInfo) {
      message.warning('请先登录');
      router.push('/user/login');
      return;
    }
    
    // 获取全局状态管理器
    const { cart } = globalState.getGlobalState();
    
    // 检查商品是否已在购物车中
    const existingItem = cart.items.find(item => item.id === product.id);
    
    if (existingItem) {
      // 更新已存在商品的数量
      api.cart.update(existingItem.id, existingItem.quantity + 1)
        .then(() => {
          // 更新全局状态
          globalState.setGlobalState({
            cart: {
              ...cart,
              items: cart.items.map(item => 
                item.id === product.id 
                  ? { ...item, quantity: item.quantity + 1 }
                  : item
              ),
              total: cart.total + product.price,
              count: cart.count + 1
            }
          });
          message.success('已更新购物车');
        })
        .catch(error => {
          console.error('更新购物车失败:', error);
          message.error('更新购物车失败，请重试');
        });
    } else {
      // 添加新商品到购物车
      api.cart.add(product.id, 1)
        .then(() => {
          // 更新全局状态
          globalState.setGlobalState({
            cart: {
              ...cart,
              items: [...cart.items, { ...product, quantity: 1 }],
              total: cart.total + product.price,
              count: cart.count + 1
            }
          });
          message.success('已添加到购物车');
        })
        .catch(error => {
          console.error('添加到购物车失败:', error);
          message.error('添加到购物车失败，请重试');
        });
    }
  };
  
  // 查看商品详情
  const viewDetail = (id) => {
    router.push(`/products/detail/${id}`);
  };
  
  return (
    <div className="product-list-container">
      {/* 搜索和筛选区域 */}
      <div className="product-filters">
        <Row gutter={16}>
          <Col span={8}>
            <Search
              placeholder="搜索商品"
              allowClear
              enterButton={<SearchOutlined />}
              onSearch={handleSearch}
            />
          </Col>
          <Col span={4}>
            <Select
              placeholder="商品分类"
              allowClear
              style={{ width: '100%' }}
              onChange={handleCategoryChange}
            >
              <Option value="electronics">数码电子</Option>
              <Option value="clothing">服装鞋帽</Option>
              <Option value="home">家居生活</Option>
              <Option value="books">图书音像</Option>
              <Option value="sports">运动户外</Option>
            </Select>
          </Col>
          <Col span={4}>
            <Select
              placeholder="排序方式"
              defaultValue="default"
              style={{ width: '100%' }}
              onChange={handleSortChange}
            >
              <Option value="default">默认排序</Option>
              <Option value="priceAsc">价格从低到高</Option>
              <Option value="priceDesc">价格从高到低</Option>
              <Option value="sales">销量优先</Option>
              <Option value="rating">好评优先</Option>
            </Select>
          </Col>
          <Col span={4}>
            <Select
              placeholder="价格区间"
              allowClear
              style={{ width: '100%' }}
              onChange={handlePriceRangeChange}
            >
              <Option value="0-100">¥0-100</Option>
              <Option value="100-500">¥100-500</Option>
              <Option value="500-1000">¥500-1000</Option>
              <Option value="1000-5000">¥1000-5000</Option>
              <Option value="5000+">¥5000以上</Option>
            </Select>
          </Col>
          <Col span={4}>
            <Button type="primary" onClick={() => router.push('/cart')}>
              购物车 ({globalState.getGlobalState().cart.count})
              <ShoppingCartOutlined />
            </Button>
          </Col>
        </Row>
      </div>
      
      {/* 商品列表 */}
      <div className="product-content">
        <Spin spinning={loading}>
          <Row gutter={[16, 16]}>
            {products.map(product => (
              <Col key={product.id} xs={24} sm={12} md={8} lg={6}>
                <Card
                  hoverable
                  cover={
                    <div className="product-image">
                      <img alt={product.name} src={product.image} />
                    </div>
                  }
                  actions={[
                    <Button type="link" onClick={() => viewDetail(product.id)}>
                      查看详情
                    </Button>,
                    <Button 
                      type="primary" 
                      icon={<ShoppingCartOutlined />}
                      onClick={() => addToCart(product)}
                    >
                      加入购物车
                    </Button>
                  ]}
                >
                  <Card.Meta
                    title={product.name}
                    description={
                      <div>
                        <div className="product-price">¥{product.price.toFixed(2)}</div>
                        <div className="product-sales">已售 {product.sales} 件</div>
                        <div className="product-rating">
                          评分: {product.rating} 分
                        </div>
                      </div>
                    }
                  />
                </Card>
              </Col>
            ))}
          </Row>
          
          {/* 分页 */}
          <div className="product-pagination">
            <Pagination
              current={pagination.current}
              pageSize={pagination.pageSize}
              total={pagination.total}
              onChange={handlePageChange}
              showSizeChanger
              showQuickJumper
              showTotal={(total, range) => 
                `第 ${range[0]}-${range[1]} 条，共 ${total} 条商品`
              }
            />
          </div>
        </Spin>
      </div>
    </div>
  );
}

export default ProductList;
```

#### 11.2.4.2 购物车微应用

购物车微应用负责管理用户的购物车：

```javascript
// 购物车微应用入口
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter as Router, Route, Switch } from 'react-router-dom';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/es/locale/zh_CN';
import ShoppingCart from './components/ShoppingCart';
import Checkout from './components/Checkout';
import './index.css';

let globalState = null;
let router = null;
let api = null;
let userInfo = null;

// 生命周期
export async function bootstrap() {
  console.log('购物车微应用 bootstrap');
}

export async function mount(props) {
  console.log('购物车微应用 mount', props);
  
  // 获取主应用传递的props
  ({ globalState, router, api, userInfo } = props);
  
  // 渲染微应用
  ReactDOM.render(
    <ConfigProvider locale={zhCN}>
      <Router basename={props.routerBase}>
        <App />
      </Router>
    </ConfigProvider>,
    props.container ? props.container.querySelector('#cart-container') : document.getElementById('cart-container')
  );
}

export async function unmount(props) {
  console.log('购物车微应用 unmount');
  ReactDOM.unmountComponentAtNode(
    props.container ? props.container.querySelector('#cart-container') : document.getElementById('cart-container')
  );
}

// 主应用组件
function App() {
  return (
    <div className="cart-app">
      <Switch>
        <Route exact path="/" component={ShoppingCart} />
        <Route path="/checkout" component={Checkout} />
      </Switch>
    </div>
  );
}

// 导出全局状态、路由和API供组件使用
export { globalState, router, api, userInfo };
```

购物车组件实现：

```javascript
// 购物车组件
import React, { useState, useEffect } from 'react';
import { 
  Table, 
  Button, 
  InputNumber, 
  Popconfirm, 
  message, 
  Empty, 
  Card, 
  Row, 
  Col,
  Divider
} from 'antd';
import { DeleteOutlined, ShoppingCartOutlined } from '@ant-design/icons';
import { globalState, router, api, userInfo } from '../index';
import './ShoppingCart.css';

function ShoppingCart() {
  const [cartItems, setCartItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [cartTotal, setCartTotal] = useState(0);
  const [cartCount, setCartCount] = useState(0);
  
  // 获取购物车数据
  const fetchCart = async () => {
    setLoading(true);
    try {
      const data = await api.cart.get();
      setCartItems(data.items || []);
      setCartTotal(data.total || 0);
      setCartCount(data.count || 0);
    } catch (error) {
      console.error('获取购物车失败:', error);
      message.error('获取购物车失败，请重试');
    } finally {
      setLoading(false);
    }
  };
  
  // 初始加载
  useEffect(() => {
    fetchCart();
  }, []);
  
  // 监听全局状态变化
  useEffect(() => {
    const unsubscribe = globalState.onGlobalStateChange((state) => {
      if (state.cart) {
        setCartItems(state.cart.items);
        setCartTotal(state.cart.total);
        setCartCount(state.cart.count);
      }
    });
    
    return () => {
      unsubscribe();
    };
  }, []);
  
  // 更新商品数量
  const updateQuantity = (itemId, quantity) => {
    if (quantity <= 0) {
      removeItem(itemId);
      return;
    }
    
    setLoading(true);
    api.cart.update(itemId, quantity)
      .then(() => {
        // 更新全局状态
        const { cart } = globalState.getGlobalState();
        const item = cart.items.find(item => item.id === itemId);
        const oldQuantity = item ? item.quantity : 0;
        const priceDiff = (quantity - oldQuantity) * item.price;
        
        globalState.setGlobalState({
          cart: {
            ...cart,
            items: cart.items.map(item => 
              item.id === itemId ? { ...item, quantity } : item
            ),
            total: cart.total + priceDiff,
            count: cart.count + (quantity - oldQuantity)
          }
        });
        
        message.success('已更新数量');
      })
      .catch(error => {
        console.error('更新数量失败:', error);
        message.error('更新数量失败，请重试');
      })
      .finally(() => {
        setLoading(false);
      });
  };
  
  // 移除商品
  const removeItem = (itemId) => {
    setLoading(true);
    api.cart.remove(itemId)
      .then(() => {
        // 更新全局状态
        const { cart } = globalState.getGlobalState();
        const item = cart.items.find(item => item.id === itemId);
        
        globalState.setGlobalState({
          cart: {
            ...cart,
            items: cart.items.filter(item => item.id !== itemId),
            total: cart.total - (item ? item.price * item.quantity : 0),
            count: cart.count - (item ? item.quantity : 0)
          }
        });
        
        message.success('已移除商品');
      })
      .catch(error => {
        console.error('移除商品失败:', error);
        message.error('移除商品失败，请重试');
      })
      .finally(() => {
        setLoading(false);
      });
  };
  
  // 清空购物车
  const clearCart = () => {
    setLoading(true);
    
    // 批量删除所有商品
    const deletePromises = cartItems.map(item => api.cart.remove(item.id));
    
    Promise.all(deletePromises)
      .then(() => {
        // 更新全局状态
        globalState.setGlobalState({
          cart: {
            items: [],
            total: 0,
            count: 0
          }
        });
        
        message.success('已清空购物车');
      })
      .catch(error => {
        console.error('清空购物车失败:', error);
        message.error('清空购物车失败，请重试');
      })
      .finally(() => {
        setLoading(false);
      });
  };
  
  // 前往结算
  const goToCheckout = () => {
    if (cartItems.length === 0) {
      message.warning('购物车为空，请先添加商品');
      return;
    }
    
    router.push('/cart/checkout');
  };
  
  // 继续购物
  const continueShopping = () => {
    router.push('/products');
  };
  
  // 表格列定义
  const columns = [
    {
      title: '商品信息',
      dataIndex: 'name',
      key: 'name',
      render: (text, record) => (
        <div className="cart-item-info">
          <img src={record.image} alt={text} className="cart-item-image" />
          <div className="cart-item-details">
            <div className="cart-item-name">{text}</div>
            <div className="cart-item-desc">{record.description}</div>
          </div>
        </div>
      )
    },
    {
      title: '单价',
      dataIndex: 'price',
      key: 'price',
      render: price => `¥${price.toFixed(2)}`
    },
    {
      title: '数量',
      dataIndex: 'quantity',
      key: 'quantity',
      render: (quantity, record) => (
        <InputNumber
          min={1}
          max={99}
          value={quantity}
          onChange={(value) => updateQuantity(record.id, value)}
        />
      )
    },
    {
      title: '小计',
      key: 'subtotal',
      render: (text, record) => `¥${(record.price * record.quantity).toFixed(2)}`
    },
    {
      title: '操作',
      key: 'action',
      render: (text, record) => (
        <Popconfirm
          title="确定要移除这个商品吗？"
          onConfirm={() => removeItem(record.id)}
          okText="确定"
          cancelText="取消"
        >
          <Button type="link" icon={<DeleteOutlined />} danger>
            移除
          </Button>
        </Popconfirm>
      )
    }
  ];
  
  return (
    <div className="shopping-cart-container">
      <Card title="我的购物车" className="cart-card">
        {cartItems.length > 0 ? (
          <>
            <Table
              dataSource={cartItems}
              columns={columns}
              rowKey="id"
              pagination={false}
              loading={loading}
            />
            
            <Divider />
            
            <div className="cart-summary">
              <Row justify="space-between" align="middle">
                <Col>
                  <Button onClick={continueShopping}>
                    继续购物
                  </Button>
                  <Popconfirm
                    title="确定要清空购物车吗？"
                    onConfirm={clearCart}
                    okText="确定"
                    cancelText="取消"
                  >
                    <Button type="link" danger>
                      清空购物车
                    </Button>
                  </Popconfirm>
                </Col>
                <Col>
                  <div className="cart-total">
                    共 {cartCount} 件商品，合计：<span className="total-price">¥{cartTotal.toFixed(2)}</span>
                  </div>
                  <Button 
                    type="primary" 
                    size="large" 
                    icon={<ShoppingCartOutlined />}
                    onClick={goToCheckout}
                  >
                    去结算
                  </Button>
                </Col>
              </Row>
            </div>
          </>
        ) : (
          <Empty 
            description="购物车是空的" 
            image={Empty.PRESENTED_IMAGE_SIMPLE}
          >
            <Button type="primary" onClick={continueShopping}>
              去购物
            </Button>
          </Empty>
        )}
      </Card>
    </div>
  );
}

export default ShoppingCart;
```

### 11.2.5 效果评估

电商平台微前端改造完成后，取得了以下效果：

1. **开发效率提升**：各团队可独立开发、测试和部署，开发周期缩短约40%
2. **技术栈升级**：部分模块成功升级到最新技术栈，性能提升约30%
3. **发布频率提高**：从每月一次发布提高到每周多次发布
4. **维护成本降低**：代码耦合度降低，修改影响范围可控，维护成本降低约25%
5. **用户体验改善**：应用加载时间减少约35%，页面响应速度提升约20%

### 11.2.6 经验总结

电商平台微前端改造的关键经验：

1. **合理拆分**：按照业务领域而非技术层次拆分微应用
2. **状态管理**：设计清晰的全局状态与本地状态边界
3. **通信机制**：建立标准化的微应用间通信协议
4. **统一规范**：制定统一的开发规范和UI组件库
5. **渐进迁移**：采用渐进式迁移策略，降低风险

## 11.3 案例二：金融系统微前端架构

### 11.3.1 业务背景

某大型金融集团拥有银行、证券、保险、基金等多个业务板块，其前端系统包含账户管理、交易系统、风险控制、客户服务等多个功能模块。金融系统对安全性、稳定性和合规性要求极高，原有的单体前端应用面临以下挑战：

1. **安全隔离不足**：不同业务板块间安全隔离不足，存在安全风险
2. **合规管理困难**：各业务板块合规要求不同，统一管理困难
3. **系统稳定性差**：一个模块的问题可能影响整个系统
4. **技术升级困难**：金融系统对稳定性要求高，技术升级风险大
5. **团队协作效率低**：多个团队并行开发，代码冲突频繁

### 11.3.2 技术挑战

金融系统微前端架构面临的主要技术挑战包括：

1. **安全隔离**：严格的业务隔离和安全边界控制
2. **权限管理**：细粒度的权限控制和访问管理
3. **数据安全**：敏感数据的加密传输和安全存储
4. **合规审计**：完整的操作日志和审计跟踪
5. **高可用性**：系统的高可用性和故障恢复能力

### 11.3.3 架构设计

#### 11.3.3.1 整体架构

金融系统采用基于Module Federation的微前端架构，整体设计如下：

```javascript
//金融系统微前端架构设计
class FinancialMicroFrontend {
  constructor() {
    this.config = {
      // 主应用配置
      mainApp: {
        name: 'financial-main',
        entry: '//main.financial.com',
        container: '#main-container',
        activeRule: '/'
      },
      
      // 微应用配置
      microApps: [
        {
          name: 'banking',
          entry: '//banking.financial.com',
          container: '#banking-container',
          activeRule: '/banking',
          props: {
            routerBase: '/banking',
            permissions: ['banking_read', 'banking_write']
          }
        },
        {
          name: 'securities',
          entry: '//securities.financial.com',
          container: '#securities-container',
          activeRule: '/securities',
          props: {
            routerBase: '/securities',
            permissions: ['securities_read', 'securities_write']
          }
        },
        {
          name: 'insurance',
          entry: '//insurance.financial.com',
          container: '#insurance-container',
          activeRule: '/insurance',
          props: {
            routerBase: '/insurance',
            permissions: ['insurance_read', 'insurance_write']
          }
        },
        {
          name: 'funds',
          entry: '//funds.financial.com',
          container: '#funds-container',
          activeRule: '/funds',
          props: {
            routerBase: '/funds',
            permissions: ['funds_read', 'funds_write']
          }
        },
        {
          name: 'risk-control',
          entry: '//risk.financial.com',
          container: '#risk-container',
          activeRule: '/risk',
          props: {
            routerBase: '/risk',
            permissions: ['risk_read', 'risk_write']
          }
        },
        {
          name: 'customer-service',
          entry: '//service.financial.com',
          container: '#service-container',
          activeRule: '/service',
          props: {
            routerBase: '/service',
            permissions: ['service_read', 'service_write']
          }
        }
      ],
      
      // 安全配置
      securityConfig: {
        // 认证配置
        auth: {
          type: 'oauth2',
          issuer: 'https://auth.financial.com',
          clientId: 'financial-web',
          scopes: ['openid', 'profile', 'email']
        },
        
        // 权限配置
        permissions: {
          // 角色权限映射
          rolePermissions: {
            'admin': ['*'],
            'banker': ['banking_*', 'customer_read'],
            'trader': ['securities_*', 'funds_*'],
            'insurer': ['insurance_*', 'customer_read'],
            'risk_analyst': ['risk_*', 'customer_read'],
            'service_rep': ['service_*', 'customer_read']
          },
          
          // 资源权限映射
          resourcePermissions: {
            '/banking': ['banking_read'],
            '/banking/accounts': ['banking_read'],
            '/banking/transfer': ['banking_write'],
            '/securities': ['securities_read'],
            '/securities/trade': ['securities_write'],
            '/insurance': ['insurance_read'],
            '/insurance/policy': ['insurance/policy'],
            '/funds': ['funds_read'],
            '/funds/purchase': ['funds_write'],
            '/risk': ['risk_read'],
            '/risk/analysis': ['risk_write'],
            '/service': ['service_read'],
            '/service/ticket': ['service_write']
          }
        },
        
        // 数据加密配置
        encryption: {
          algorithm: 'AES-256-GCM',
          keyDerivation: 'PBKDF2',
          iterations: 100000
        },
        
        // 审计配置
        audit: {
          enabled: true,
          logLevel: 'info',
          logStorage: 'secure',
          retentionDays: 2555 // 7年
        }
      },
      
      // 全局配置
      globalConfig: {
        // 沙箱配置
        sandbox: {
          strictStyleIsolation: true,
          experimentalStyleIsolation: true
        },
        
        // 预加载配置
        prefetch: false, // 金融系统不预加载，按需加载
        
        // 生命周期配置
        lifeCycles: {
          beforeLoad: [
            app => {
              console.log(`${app.name} 加载前`);
              // 权限检查
              this.checkAppPermissions(app);
            }
          ],
          beforeMount: [
            app => {
              console.log(`${app.name} 挂载前`);
              // 安全检查
              this.performSecurityCheck(app);
            }
          ],
          afterMount: [
            app => {
              console.log(`${app.name} 挂载后`);
              // 审计日志
              this.logAuditEvent('app_mount', { appName: app.name });
            }
          ],
          beforeUnmount: [
            app => {
              console.log(`${app.name} 卸载前`);
              // 清理敏感数据
              this.clearSensitiveData(app);
            }
          ],
          afterUnmount: [
            app => {
              console.log(`${app.name} 卸载后`);
              // 审计日志
              this.logAuditEvent('app_unmount', { appName: app.name });
            }
          ]
        }
      }
    };
    
    // 初始化状态
    this.isAuthenticated = false;
    this.currentUser = null;
    this.userPermissions = [];
    this.sessionToken = null;
  }
  
  // 初始化微前端
  init() {
    this.initAuth();
    this.registerMicroApps();
    this.start();
    this.setupGlobalState();
    this.setupErrorHandler();
    this.setupSecurityMonitor();
  }
  
  // 初始化认证
  initAuth() {
    // 检查是否有有效会话
    const token = this.getStoredToken();
    if (token && this.validateToken(token)) {
      this.sessionToken = token;
      this.isAuthenticated = true;
      this.currentUser = this.decodeToken(token);
      this.userPermissions = this.getUserPermissions(this.currentUser.roles);
    } else {
      // 重定向到登录页面
      this.redirectToLogin();
    }
  }
  
  // 注册微应用
  registerMicroApps() {
    const { microApps } = this.config;
    
    microApps.forEach(app => {
      this.enhanceMicroApp(app);
    });
    
    // 使用Module Federation注册微应用
    this.setupModuleFederation(microApps);
  }
  
  // 增强微应用配置
  enhanceMicroApp(app) {
    // 添加通用props
    app.props = {
      ...app.props,
      // 全局状态
      globalState: this.getGlobalState(),
      // 路由
      router: this.getRouter(),
      // 工具函数
      utils: this.getUtils(),
      // API服务
      api: this.getApiService(),
      // 用户信息
      userInfo: this.currentUser,
      // 用户权限
      userPermissions: this.userPermissions,
      // 会话令牌
      sessionToken: this.sessionToken,
      // 安全服务
      security: this.getSecurityService(),
      // 审计服务
      audit: this.getAuditService()
    };
  }
  
  // 设置Module Federation
  setupModuleFederation(microApps) {
    // Module Federation配置
    const moduleFederationConfig = {
      name: 'financial_main',
      remotes: {},
      shared: {
        react: { singleton: true, requiredVersion: '^17.0.0' },
        'react-dom': { singleton: true, requiredVersion: '^17.0.0' },
        'react-router-dom': { singleton: true, requiredVersion: '^5.0.0' },
        antd: { singleton: true, requiredVersion: '^4.0.0' },
        axios: { singleton: true, requiredVersion: '^0.21.0' }
      }
    };
    
    // 配置远程应用
    microApps.forEach(app => {
      moduleFederationConfig.remotes[app.name] = {
        external: `${app.name}@${app.entry}/remoteEntry.js`
      };
    });
    
    // 应用Module Federation配置
    this.applyModuleFederationConfig(moduleFederationConfig);
  }
  
  // 启动微前端
  start() {
    // 启动主应用
    this.startMainApp();
    
    // 设置路由
    this.setupRouting();
  }
  
  // 启动主应用
  startMainApp() {
    // 主应用启动逻辑
    console.log('启动金融系统主应用');
  }
  
  // 设置路由
  setupRouting() {
    // 路由守卫
    this.setupRouteGuards();
    
    // 路由配置
    this.configureRoutes();
  }
  
  // 设置路由守卫
  setupRouteGuards() {
    // 前置守卫 - 权限检查
    const beforeRouteEnter = (to, from, next) => {
      if (!this.isAuthenticated) {
        this.redirectToLogin();
        return;
      }
      
      // 检查路由权限
      const requiredPermissions = this.getRequiredPermissions(to.path);
      if (!this.hasPermissions(requiredPermissions)) {
        this.redirectToUnauthorized();
        return;
      }
      
      // 记录访问日志
      this.logAuditEvent('route_access', {
        from: from.path,
        to: to.path,
        user: this.currentUser.id
      });
      
      next();
    };
    
    // 应用路由守卫
    this.applyRouteGuards({ beforeRouteEnter });
  }
  
  // 获取所需权限
  getRequiredPermissions(path) {
    const { permissions } = this.config.securityConfig;
    return permissions.resourcePermissions[path] || [];
  }
  
  // 检查权限
  hasPermissions(requiredPermissions) {
    if (this.userPermissions.includes('*')) {
      return true; // 超级管理员权限
    }
    
    return requiredPermissions.every(permission => 
      this.userPermissions.some(userPermission => 
        userPermission === permission || 
        userPermission === '*' ||
        (userPermission.endsWith('_*') && permission.startsWith(userPermission.slice(0, -1)))
      )
    );
  }
  
  // 检查应用权限
  checkAppPermissions(app) {
    const requiredPermissions = app.props.permissions || [];
    if (!this.hasPermissions(requiredPermissions)) {
      throw new Error(`无权限访问应用: ${app.name}`);
    }
  }
  
  // 执行安全检查
  performSecurityCheck(app) {
    // 检查应用完整性
    this.checkAppIntegrity(app);
    
    // 检查安全策略
    this.checkSecurityPolicies(app);
    
    // 检查依赖安全性
    this.checkDependenciesSecurity(app);
  }
  
  // 检查应用完整性
  checkAppIntegrity(app) {
    // 计算应用哈希值
    const appHash = this.calculateAppHash(app);
    
    // 验证应用完整性
    const isValid = this.verifyAppIntegrity(app.name, appHash);
    
    if (!isValid) {
      throw new Error(`应用完整性验证失败: ${app.name}`);
    }
  }
  
  // 清理敏感数据
  clearSensitiveData(app) {
    // 清理内存中的敏感数据
    this.clearMemorySensitiveData(app);
    
    // 清理临时存储中的敏感数据
    this.clearTempStorageSensitiveData(app);
    
    // 清理DOM中的敏感数据
    this.clearDOMSensitiveData(app);
  }
  
  // 设置全局状态
  setupGlobalState() {
    // 全局状态管理
    this.globalState = this.createSecureGlobalState({
      // 用户信息
      userInfo: this.currentUser,
      // 用户权限
      userPermissions: this.userPermissions,
      // 会话信息
      session: {
        token: this.sessionToken,
        expiresAt: this.getTokenExpiration(this.sessionToken)
      },
      // 全局配置
      config: {
        theme: 'light',
        language: 'zh-CN'
      }
    });
    
    // 监听状态变化
    this.globalState.onGlobalStateChange((state, prev) => {
      console.log('主应用检测到状态变化:', state, prev);
      this.handleGlobalStateChange(state, prev);
    });
  }
  
  // 创建安全全局状态
  createSecureGlobalState(initialState) {
    // 加密敏感状态
    const encryptedState = this.encryptSensitiveState(initialState);
    
    // 创建状态管理器
    const stateManager = {
      state: encryptedState,
      subscribers: [],
      
      getGlobalState: () => {
        // 解密状态
        return this.decryptSensitiveState(this.state);
      },
      
      setGlobalState: (newState) => {
        // 加密新状态
        this.state = this.encryptSensitiveState({
          ...this.getGlobalState(),
          ...newState
        });
        
        // 通知订阅者
        this.subscribers.forEach(callback => {
          callback(this.getGlobalState());
        });
        
        // 记录状态变更审计
        this.logAuditEvent('state_change', {
          changes: Object.keys(newState)
        });
      },
      
      onGlobalStateChange: (callback) => {
        this.subscribers.push(callback);
        
        // 返回取消订阅函数
        return () => {
          const index = this.subscribers.indexOf(callback);
          if (index > -1) {
            this.subscribers.splice(index, 1);
          }
        };
      }
    };
    
    return stateManager;
  }
  
  // 加密敏感状态
  encryptSensitiveState(state) {
    // 识别敏感字段
    const sensitiveFields = ['userInfo', 'session', 'userPermissions'];
    
    // 加密敏感字段
    const encryptedState = { ...state };
    sensitiveFields.forEach(field => {
      if (encryptedState[field]) {
        encryptedState[field] = this.encrypt(JSON.stringify(encryptedState[field]));
      }
    });
    
    return encryptedState;
  }
  
  // 解密敏感状态
  decryptSensitiveState(encryptedState) {
    // 识别敏感字段
    const sensitiveFields = ['userInfo', 'session', 'userPermissions'];
    
    // 解密敏感字段
    const state = { ...encryptedState };
    sensitiveFields.forEach(field => {
      if (state[field]) {
        try {
          state[field] = JSON.parse(this.decrypt(state[field]));
        } catch (e) {
          console.error(`解密字段 ${field} 失败:`, e);
          state[field] = null;
        }
      }
    });
    
    return state;
  }
  
  // 设置错误处理
  setupErrorHandler() {
    // 全局错误处理
    window.addEventListener('error', this.handleGlobalError.bind(this));
    window.addEventListener('unhandledrejection', this.handleUnhandledRejection.bind(this));
  }
  
  // 处理全局错误
  handleGlobalError(event) {
    console.error('全局错误:', event.error);
    
    // 记录错误审计
    this.logAuditEvent('global_error', {
      message: event.error.message,
      stack: event.error.stack,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno
    });
    
    // 错误上报
    this.reportError(event.error);
  }
  
  // 处理未捕获的Promise拒绝
  handleUnhandledRejection(event) {
    console.error('未捕获的Promise拒绝:', event.reason);
    
    // 记录错误审计
    this.logAuditEvent('unhandled_promise_rejection', {
      reason: event.reason
    });
    
    // 错误上报
    this.reportError(event.reason);
  }
  
  // 设置安全监控
  setupSecurityMonitor() {
    // 监控可疑活动
    this.monitorSuspiciousActivity();
    
    // 监控XSS攻击
    this.monitorXSSAttacks();
    
    // 监控CSRF攻击
    this.monitorCSRFAttacks();
  }
  
  // 监控可疑活动
  monitorSuspiciousActivity() {
    // 监控异常登录
    this.monitorAbnormalLogin();
    
    // 监控异常操作
    this.monitorAbnormalOperations();
    
    // 监控异常访问
    this.monitorAbnormalAccess();
  }
  
  // 获取全局状态
  getGlobalState() {
    return {
      getGlobalState: this.globalState.getGlobalState.bind(this.globalState),
      setGlobalState: this.globalState.setGlobalState.bind(this.globalState),
      onGlobalStateChange: this.globalState.onGlobalStateChange.bind(this.globalState)
    };
  }
  
  // 获取路由
  getRouter() {
    return {
      push: (path) => {
        // 权限检查
        const requiredPermissions = this.getRequiredPermissions(path);
        if (!this.hasPermissions(requiredPermissions)) {
          this.redirectToUnauthorized();
          return;
        }
        
        // 记录路由变更
        this.logAuditEvent('route_change', {
          to: path,
          user: this.currentUser.id
        });
        
        window.history.pushState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      replace: (path) => {
        // 权限检查
        const requiredPermissions = this.getRequiredPermissions(path);
        if (!this.hasPermissions(requiredPermissions)) {
          this.redirectToUnauthorized();
          return;
        }
        
        // 记录路由变更
        this.logAuditEvent('route_replace', {
          to: path,
          user: this.currentUser.id
        });
        
        window.history.replaceState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      go: (n) => {
        window.history.go(n);
      },
      back: () => {
        window.history.back();
      },
      forward: () => {
        window.history.forward();
      }
    };
  }
  
  // 获取工具函数
  getUtils() {
    return {
      // 格式化金额
      formatAmount: (amount, currency = 'CNY') => {
        return new Intl.NumberFormat('zh-CN', {
          style: 'currency',
          currency
        }).format(amount);
      },
      
      // 格式化日期
      formatDate: (date, format = 'YYYY-MM-DD') => {
        // 日期格式化实现
        return date; // 简化实现
      },
      
      // 格式化百分比
      formatPercentage: (value, decimals = 2) => {
        return `${(value * 100).toFixed(decimals)}%`;
      },
      
      // 防抖函数
      debounce: (func, wait) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // 节流函数
      throttle: (func, wait) => {
        let lastTime = 0;
        return function(...args) {
          const now = Date.now();
          if (now - lastTime >= wait) {
            lastTime = now;
            return func.apply(this, args);
          }
        };
      },
      
      // 数据脱敏
      maskSensitiveData: (data, type) => {
        switch (type) {
          case 'bankAccount':
            return data.replace(/(\d{4})\d*(\d{4})/, '$1 **** **** $2');
          case 'idCard':
            return data.replace(/(\d{6})\d*(\d{4})/, '$1 ******** $2');
          case 'phone':
            return data.replace(/(\d{3})\d*(\d{4})/, '$1 **** $2');
          case 'email':
            const [username, domain] = data.split('@');
            return `${username.substring(0, 2)}***@${domain}`;
          default:
            return data;
        }
      }
    };
  }
  
  // 获取API服务
  getApiService() {
    return {
      // 银行API
      banking: {
        getAccounts: () => {
          return this.secureFetch('/api/banking/accounts', {
            method: 'GET'
          });
        },
        transfer: (data) => {
          return this.secureFetch('/api/banking/transfer', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      },
      
      // 证券API
      securities: {
        getPositions: () => {
          return this.secureFetch('/api/securities/positions', {
            method: 'GET'
          });
        },
        trade: (data) => {
          return this.secureFetch('/api/securities/trade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      },
      
      // 保险API
      insurance: {
        getPolicies: () => {
          return this.secureFetch('/api/insurance/policies', {
            method: 'GET'
          });
        },
        claim: (data) => {
          return this.secureFetch('/api/insurance/claim', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      },
      
      // 基金API
      funds: {
        getHoldings: () => {
          return this.secureFetch('/api/funds/holdings', {
            method: 'GET'
          });
        },
        purchase: (data) => {
          return this.secureFetch('/api/funds/purchase', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      },
      
      // 风控API
      risk: {
        getAssessments: () => {
          return this.secureFetch('/api/risk/assessments', {
            method: 'GET'
          });
        },
        analyze: (data) => {
          return this.secureFetch('/api/risk/analyze', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      },
      
      // 客服API
      service: {
        getTickets: () => {
          return this.secureFetch('/api/service/tickets', {
            method: 'GET'
          });
        },
        createTicket: (data) => {
          return this.secureFetch('/api/service/tickets', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
      }
    };
  }
  
  // 安全请求
  secureFetch(url, options = {}) {
    // 添加认证头
    const headers = {
      ...options.headers,
      'Authorization': `Bearer ${this.sessionToken}`
    };
    
    // 添加请求ID
    const requestId = this.generateRequestId();
    headers['X-Request-ID'] = requestId;
    
    // 记录请求审计
    this.logAuditEvent('api_request', {
      url,
      method: options.method || 'GET',
      requestId,
      user: this.currentUser.id
    });
    
    // 发送请求
    return fetch(url, {
      ...options,
      headers
    })
    .then(response => {
      // 检查响应状态
      if (!response.ok) {
        // 记录错误审计
        this.logAuditEvent('api_error', {
          url,
          status: response.status,
          statusText: response.statusText,
          requestId,
          user: this.currentUser.id
        });
        
        throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
      }
      
      // 记录响应审计
      this.logAuditEvent('api_response', {
        url,
        status: response.status,
        requestId,
        user: this.currentUser.id
      });
      
      return response.json();
    })
    .catch(error => {
      // 记录异常审计
      this.logAuditEvent('api_exception', {
        url,
        error: error.message,
        requestId,
        user: this.currentUser.id
      });
      
      throw error;
    });
  }
  
  // 获取安全服务
  getSecurityService() {
    return {
      // 加密
      encrypt: (data) => {
        return this.encrypt(data);
      },
      
      // 解密
      decrypt: (encryptedData) => {
        return this.decrypt(encryptedData);
      },
      
      // 生成哈希
      hash: (data) => {
        return this.hash(data);
      },
      
      // 验证签名
      verifySignature: (data, signature) => {
        return this.verifySignature(data, signature);
      }
    };
  }
  
  // 获取审计服务
  getAuditService() {
    return {
      // 记录审计事件
      log: (event, data) => {
        this.logAuditEvent(event, data);
      },
      
      // 查询审计日志
      query: (filters) => {
        return this.queryAuditLogs(filters);
      }
    };
  }
  
  // 获取存储的令牌
  getStoredToken() {
    try {
      return sessionStorage.getItem('auth_token');
    } catch (e) {
      console.error('获取存储令牌失败:', e);
      return null;
    }
  }
  
  // 验证令牌
  validateToken(token) {
    try {
      // 解析令牌
      const payload = this.decodeToken(token);
      
      // 检查过期时间
      const now = Math.floor(Date.now() / 1000);
      if (payload.exp && payload.exp < now) {
        return false;
      }
      
      // 验证令牌签名
      return this.verifyTokenSignature(token);
    } catch (e) {
      console.error('验证令牌失败:', e);
      return false;
    }
  }
  
  // 解码令牌
  decodeToken(token) {
    try {
      const parts = token.split('.');
      if (parts.length !== 3) {
        throw new Error('无效的令牌格式');
      }
      
      const payload = JSON.parse(atob(parts[1]));
      return payload;
    } catch (e) {
      console.error('解码令牌失败:', e);
      throw e;
    }
  }
  
  // 验证令牌签名
  verifyTokenSignature(token) {
    // 令牌签名验证实现
    return true; // 简化实现
  }
  
  // 获取令牌过期时间
  getTokenExpiration(token) {
    try {
      const payload = this.decodeToken(token);
      return payload.exp ? new Date(payload.exp * 1000) : null;
    } catch (e) {
      console.error('获取令牌过期时间失败:', e);
      return null;
    }
  }
  
  // 获取用户权限
  getUserPermissions(roles) {
    const { rolePermissions } = this.config.securityConfig.permissions;
    
    let permissions = [];
    roles.forEach(role => {
      if (rolePermissions[role]) {
        permissions = [...permissions, ...rolePermissions[role]];
      }
    });
    
    // 去重
    return [...new Set(permissions)];
  }
  
  // 重定向到登录页面
  redirectToLogin() {
    window.location.href = '/login';
  }
  
  // 重定向到未授权页面
  redirectToUnauthorized() {
    window.location.href = '/unauthorized';
  }
  
  // 处理全局状态变化
  handleGlobalStateChange(state, prev) {
    // 状态变化处理逻辑
    console.log('全局状态变化:', state, prev);
  }
  
  // 记录审计事件
  logAuditEvent(event, data) {
    const auditData = {
      timestamp: new Date().toISOString(),
      event,
      data,
      user: this.currentUser ? this.currentUser.id : null,
      sessionId: this.sessionToken
    };
    
    // 发送审计日志
    this.sendAuditLog(auditData);
  }
  
  // 发送审计日志
  sendAuditLog(auditData) {
    // 审计日志发送实现
    console.log('审计日志:', auditData);
  }
  
  // 查询审计日志
  queryAuditLogs(filters) {
    // 审计日志查询实现
    return Promise.resolve([]); // 简化实现
  }
  
  // 错误上报
  reportError(err) {
    // 错误上报实现
    console.error('错误上报:', err);
  }
  
  // 生成请求ID
  generateRequestId() {
    return `req_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
  }
  
  // 加密
  encrypt(data) {
    // 加密实现
    return btoa(data); // 简化实现
  }
  
  // 解密
  decrypt(encryptedData) {
    // 解密实现
    return atob(encryptedData); // 简化实现
  }
  
  // 哈希
  hash(data) {
    // 哈希实现
    return btoa(data); // 简化实现
  }
  
  // 验证签名
  verifySignature(data, signature) {
    // 签名验证实现
    return true; // 简化实现
  }
  
  // 计算应用哈希
  calculateAppHash(app) {
    // 应用哈希计算实现
    return 'app_hash_' + Math.random().toString(36).substring(2, 9);
  }
  
  // 验证应用完整性
  verifyAppIntegrity(appName, appHash) {
    // 应用完整性验证实现
    return true; // 简化实现
  }
  
  // 检查安全策略
  checkSecurityPolicies(app) {
    // 安全策略检查实现
    console.log(`检查应用 ${app.name} 的安全策略`);
  }
  
  // 检查依赖安全性
  checkDependenciesSecurity(app) {
    // 依赖安全性检查实现
    console.log(`检查应用 ${app.name} 的依赖安全性`);
  }
  
  // 清理内存敏感数据
  clearMemorySensitiveData(app) {
    // 内存敏感数据清理实现
    console.log(`清理应用 ${app.name} 的内存敏感数据`);
  }
  
  // 清理临时存储敏感数据
  clearTempStorageSensitiveData(app) {
    // 临时存储敏感数据清理实现
    console.log(`清理应用 ${app.name} 的临时存储敏感数据`);
  }
  
  // 清理DOM敏感数据
  clearDOMSensitiveData(app) {
    // DOM敏感数据清理实现
    console.log(`清理应用 ${app.name} 的DOM敏感数据`);
  }
  
  // 监控异常登录
  monitorAbnormalLogin() {
    // 异常登录监控实现
    console.log('监控异常登录');
  }
  
  // 监控异常操作
  monitorAbnormalOperations() {
    // 异常操作监控实现
    console.log('监控异常操作');
  }
  
  // 监控异常访问
  monitorAbnormalAccess() {
    // 异常访问监控实现
    console.log('监控异常访问');
  }
  
  // 监控XSS攻击
  monitorXSSAttacks() {
    // XSS攻击监控实现
    console.log('监控XSS攻击');
  }
  
  // 监控CSRF攻击
  monitorCSRFAttacks() {
    // CSRF攻击监控实现
    console.log('监控CSRF攻击');
  }
  
  // 应用Module Federation配置
  applyModuleFederationConfig(config) {
    // Module Federation配置应用实现
    console.log('应用Module Federation配置', config);
  }
  
  // 应用路由守卫
  applyRouteGuards(guards) {
    // 路由守卫应用实现
    console.log('应用路由守卫', guards);
  }
  
  // 配置路由
  configureRoutes() {
    // 路由配置实现
    console.log('配置路由');
  }
}

// 导出金融系统微前端实例
export default new FinancialMicroFrontend();
```

#### 11.3.3.2 安全架构设计

金融系统的安全架构设计是微前端架构的核心，主要包括以下几个方面：

```javascript
// 金融系统安全架构
class FinancialSecurityArchitecture {
  constructor(config) {
    this.config = config;
    this.securityManager = new SecurityManager(config.securityConfig);
    this.auditManager = new AuditManager(config.auditConfig);
    this.encryptionManager = new EncryptionManager(config.encryptionConfig);
  }
  
  // 初始化安全架构
  init() {
    this.setupAuthentication();
    this.setupAuthorization();
    this.setupDataEncryption();
    this.setupAuditLogging();
    this.setupSecurityMonitoring();
  }
  
  // 设置认证
  setupAuthentication() {
    // 认证设置实现
    this.securityManager.initAuthentication();
  }
  
  // 设置授权
  setupAuthorization() {
    // 授权设置实现
    this.securityManager.initAuthorization();
  }
  
  // 设置数据加密
  setupDataEncryption() {
    // 数据加密设置实现
    this.encryptionManager.initEncryption();
  }
  
  // 设置审计日志
  setupAuditLogging() {
    // 审计日志设置实现
    this.auditManager.initAuditLogging();
  }
  
  // 设置安全监控
  setupSecurityMonitoring() {
    // 安全监控设置实现
    this.securityManager.initSecurityMonitoring();
  }
}

// 安全管理器
class SecurityManager {
  constructor(securityConfig) {
    this.config = securityConfig;
    this.authProvider = new AuthProvider(securityConfig.auth);
    this.permissionProvider = new PermissionProvider(securityConfig.permissions);
  }
  
  // 初始化认证
  initAuthentication() {
    this.authProvider.init();
  }
  
  // 初始化授权
  initAuthorization() {
    this.permissionProvider.init();
  }
  
  // 初始化安全监控
  initSecurityMonitoring() {
    // 安全监控初始化实现
    console.log('初始化安全监控');
  }
}

// 认证提供者
class AuthProvider {
  constructor(authConfig) {
    this.config = authConfig;
    this.tokenManager = new TokenManager();
  }
  
  // 初始化
  init() {
    this.setupOAuth2();
  }
  
  // 设置OAuth2
  setupOAuth2() {
    // OAuth2设置实现
    console.log('设置OAuth2认证');
  }
}

// 权限提供者
class PermissionProvider {
  constructor(permissionConfig) {
    this.config = permissionConfig;
  }
  
  // 初始化
  init() {
    this.setupRolePermissions();
    this.setupResourcePermissions();
  }
  
  // 设置角色权限
  setupRolePermissions() {
    // 角色权限设置实现
    console.log('设置角色权限');
  }
  
  // 设置资源权限
  setupResourcePermissions() {
    // 资源权限设置实现
    console.log('设置资源权限');
  }
}

// 审计管理器
class AuditManager {
  constructor(auditConfig) {
    this.config = auditConfig;
    this.logStorage = new LogStorage(auditConfig.logStorage);
  }
  
  // 初始化审计日志
  initAuditLogging() {
    this.setupEventLogging();
    this.setupAccessLogging();
    this.setupOperationLogging();
  }
  
  // 设置事件日志
  setupEventLogging() {
    // 事件日志设置实现
    console.log('设置事件日志');
  }
  
  // 设置访问日志
  setupAccessLogging() {
    // 访问日志设置实现
    console.log('设置访问日志');
  }
  
  // 设置操作日志
  setupOperationLogging() {
    // 操作日志设置实现
    console.log('设置操作日志');
  }
}

// 加密管理器
class EncryptionManager {
  constructor(encryptionConfig) {
    this.config = encryptionConfig;
    this.cipher = new Cipher(encryptionConfig);
  }
  
  // 初始化加密
  initEncryption() {
    this.setupDataEncryption();
    this.setupTransmissionEncryption();
    this.setupStorageEncryption();
  }
  
  // 设置数据加密
  setupDataEncryption() {
    // 数据加密设置实现
    console.log('设置数据加密');
  }
  
  // 设置传输加密
  setupTransmissionEncryption() {
    // 传输加密设置实现
    console.log('设置传输加密');
  }
  
  // 设置存储加密
  setupStorageEncryption() {
    // 存储加密设置实现
    console.log('设置存储加密');
  }
}

// 令牌管理器
class TokenManager {
  // 生成令牌
  generateToken(payload) {
    // 令牌生成实现
    return 'generated_token';
  }
  
  // 验证令牌
  validateToken(token) {
    // 令牌验证实现
    return true;
  }
  
  // 刷新令牌
  refreshToken(token) {
    // 令牌刷新实现
    return 'refreshed_token';
  }
}

// 日志存储
class LogStorage {
  constructor(storageConfig) {
    this.config = storageConfig;
  }
  
  // 存储日志
  storeLog(log) {
    // 日志存储实现
    console.log('存储日志', log);
  }
  
  // 查询日志
  queryLogs(filters) {
    // 日志查询实现
    return [];
  }
}

// 加密器
class Cipher {
  constructor(encryptionConfig) {
    this.config = encryptionConfig;
  }
  
  // 加密
  encrypt(data) {
    // 加密实现
    return 'encrypted_data';
  }
  
  // 解密
  decrypt(encryptedData) {
    // 解密实现
    return 'decrypted_data';
  }
}
```

### 11.3.4 实现细节

#### 11.3.4.1 银行微应用

银行微应用负责处理银行业务，包括账户管理、转账等功能：

```javascript
// 银行微应用入口
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter as Router, Route, Switch } from 'react-router-dom';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/es/locale/zh_CN';
import AccountList from './components/AccountList';
import Transfer from './components/Transfer';
import TransactionHistory from './components/TransactionHistory';
import './index.css';

let globalState = null;
let router = null;
let api = null;
let userInfo = null;
let userPermissions = null;
let sessionToken = null;
let security = null;
let audit = null;

// 生命周期
export async function bootstrap() {
  console.log('银行微应用 bootstrap');
}

export async function mount(props) {
  console.log('银行微应用 mount', props);
  
  // 获取主应用传递的props
  ({ 
    globalState, 
    router, 
    api, 
    userInfo, 
    userPermissions, 
    sessionToken, 
    security, 
    audit 
  } = props);
  
  // 渲染微应用
  ReactDOM.render(
    <ConfigProvider locale={zhCN}>
      <Router basename={props.routerBase}>
        <App />
      </Router>
    </ConfigProvider>,
    props.container ? props.container.querySelector('#banking-container') : document.getElementById('banking-container')
  );
}

export async function unmount(props) {
  console.log('银行微应用 unmount');
  ReactDOM.unmountComponentAtNode(
    props.container ? props.container.querySelector('#banking-container') : document.getElementById('banking-container')
  );
}

// 主应用组件
function App() {
  return (
    <div className="banking-app">
      <Switch>
        <Route exact path="/" component={AccountList} />
        <Route path="/transfer" component={Transfer} />
        <Route path="/transactions" component={TransactionHistory} />
      </Switch>
    </div>
  );
}

// 导出全局状态、路由和API供组件使用
export { 
  globalState, 
  router, 
  api, 
  userInfo, 
  userPermissions, 
  sessionToken, 
  security, 
  audit 
};
```

账户列表组件实现：

```javascript
// 账户列表组件
import React, { useState, useEffect } from 'react';
import { Card, Table, Button, message, Descriptions, Tag } from 'antd';
import { EyeInvisibleOutlined, EyeOutlined } from '@ant-design/icons';
import { 
  globalState, 
  router, 
  api, 
  userInfo, 
  userPermissions, 
  sessionToken, 
  security, 
  audit 
} from '../index';
import './AccountList.css';

function AccountList() {
  const [accounts, setAccounts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showBalance, setShowBalance] = useState(false);
  
  // 获取账户列表
  const fetchAccounts = async () => {
    setLoading(true);
    try {
      const data = await api.banking.getAccounts();
      setAccounts(data || []);
      
      // 记录审计日志
      audit.log('account_list_viewed', {
        userId: userInfo.id,
        accountCount: data ? data.length : 0
      });
    } catch (error) {
      console.error('获取账户列表失败:', error);
      message.error('获取账户列表失败，请重试');
      
      // 记录错误审计
      audit.log('account_list_error', {
        userId: userInfo.id,
        error: error.message
      });
    } finally {
      setLoading(false);
    }
  };
  
  // 初始加载
  useEffect(() => {
    fetchAccounts();
  }, []);
  
  // 切换余额显示
  const toggleBalanceVisibility = () => {
    setShowBalance(!showBalance);
    
    // 记录审计日志
    audit.log('balance_visibility_toggled', {
      userId: userInfo.id,
      visible: !showBalance
    });
  };
  
  // 格式化余额
  const formatBalance = (balance) => {
    if (!showBalance) {
      return '****';
    }
    return new Intl.NumberFormat('zh-CN', {
      style: 'currency',
      currency: 'CNY'
    }).format(balance);
  };
  
  // 转账
  const handleTransfer = (accountId) => {
    if (!userPermissions.includes('banking_write')) {
      message.error('您没有转账权限');
      return;
    }
    
    router.push(`/banking/transfer?from=${accountId}`);
  };
  
  // 查看交易历史
  const handleViewTransactions = (accountId) => {
    router.push(`/banking/transactions?accountId=${accountId}`);
  };
  
  // 表格列定义
  const columns = [
    {
      title: '账户类型',
      dataIndex: 'type',
      key: 'type',
      render: (type) => {
        const typeMap = {
          'checking': '活期账户',
          'savings': '定期账户',
          'credit': '信用账户',
          'investment': '投资账户'
        };
        return typeMap[type] || type;
      }
    },
    {
      title: '账户号码',
      dataIndex: 'accountNumber',
      key: 'accountNumber',
      render: (accountNumber) => {
        // 脱敏显示
        return security.maskSensitiveData(accountNumber, 'bankAccount');
      }
    },
    {
      title: '账户名称',
      dataIndex: 'accountName',
      key: 'accountName'
    },
    {
      title: '余额',
      dataIndex: 'balance',
      key: 'balance',
      render: (balance) => formatBalance(balance)
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status) => {
        const statusMap = {
          'active': { text: '正常', color: 'green' },
          'frozen': { text: '冻结', color: 'red' },
          'closed': { text: '已关闭', color: 'default' }
        };
        const statusInfo = statusMap[status] || { text: status, color: 'default' };
        return <Tag color={statusInfo.color}>{statusInfo.text}</Tag>;
      }
    },
    {
      title: '操作',
      key: 'action',
      render: (text, record) => (
        <div className="account-actions">
          <Button 
            type="link" 
            onClick={() => handleViewTransactions(record.id)}
          >
            交易历史
          </Button>
          {userPermissions.includes('banking_write') && record.status === 'active' && (
            <Button 
              type="primary" 
              onClick={() => handleTransfer(record.id)}
            >
              转账
            </Button>
          )}
        </div>
      )
    }
  ];
  
  return (
    <div className="account-list-container">
      <Card 
        title="我的账户" 
        className="account-card"
        extra={
          <Button 
            icon={showBalance ? <EyeInvisibleOutlined /> : <EyeOutlined />}
            onClick={toggleBalanceVisibility}
          >
            {showBalance ? '隐藏余额' : '显示余额'}
          </Button>
        }
      >
        <Table
          dataSource={accounts}
          columns={columns}
          rowKey="id"
          loading={loading}
          pagination={false}
        />
      </Card>
    </div>
  );
}

export default AccountList;
```

转账组件实现：

```javascript
// 转账组件
import React, { useState, useEffect } from 'react';
import { 
  Card, 
  Form, 
  Input, 
  Select, 
  InputNumber, 
  Button, 
  message, 
  Steps,
  Row,
  Col,
  Descriptions,
  Modal
} from 'antd';
import { ArrowRightOutlined } from '@ant-design/icons';
import { 
  globalState, 
  router, 
  api, 
  userInfo, 
  userPermissions, 
  sessionToken, 
  security, 
  audit 
} from '../index';
import './Transfer.css';

const { Step } = Steps;
const { Option } = Select;

function Transfer() {
  const [form] = Form.useForm();
  const [currentStep, setCurrentStep] = useState(0);
  const [accounts, setAccounts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [transferData, setTransferData] = useState(null);
  const [confirmModalVisible, setConfirmModalVisible] = useState(false);
  
  // 获取账户列表
  const fetchAccounts = async () => {
    setLoading(true);
    try {
      const data = await api.banking.getAccounts();
      // 只显示活期账户和信用账户
      const activeAccounts = (data || []).filter(account => 
        account.status === 'active' && 
        ['checking', 'credit'].includes(account.type)
      );
      setAccounts(activeAccounts);
    } catch (error) {
      console.error('获取账户列表失败:', error);
      message.error('获取账户列表失败，请重试');
    } finally {
      setLoading(false);
    }
  };
  
  // 初始加载
  useEffect(() => {
    fetchAccounts();
    
    // 获取URL参数中的转出账户
    const urlParams = new URLSearchParams(window.location.search);
    const fromAccountId = urlParams.get('from');
    if (fromAccountId) {
      form.setFieldsValue({ fromAccountId });
    }
  }, []);
  
  // 下一步
  const nextStep = () => {
    form.validateFields()
      .then(values => {
        setTransferData(values);
        setCurrentStep(currentStep + 1);
      })
      .catch(info => {
        console.log('验证失败:', info);
      });
  };
  
  // 上一步
  const prevStep = () => {
    setCurrentStep(currentStep - 1);
  };
  
  // 提交转账
  const submitTransfer = () => {
    setConfirmModalVisible(true);
  };
  
  // 确认转账
  const confirmTransfer = async () => {
    setLoading(true);
    try {
      const result = await api.banking.transfer(transferData);
      
      message.success('转账成功');
      
      // 记录审计日志
      audit.log('transfer_completed', {
        userId: userInfo.id,
        fromAccountId: transferData.fromAccountId,
        toAccountNumber: security.maskSensitiveData(transferData.toAccountNumber, 'bankAccount'),
        amount: transferData.amount
      });
      
      // 跳转到交易历史
      router.push('/banking/transactions');
    } catch (error) {
      console.error('转账失败:', error);
      message.error(`转账失败: ${error.message}`);
      
      // 记录错误审计
      audit.log('transfer_failed', {
        userId: userInfo.id,
        fromAccountId: transferData.fromAccountId,
        toAccountNumber: security.maskSensitiveData(transferData.toAccountNumber, 'bankAccount'),
        amount: transferData.amount,
        error: error.message
      });
    } finally {
      setLoading(false);
      setConfirmModalVisible(false);
    }
  };
  
  // 渲染第一步：填写转账信息
  const renderStep1 = () => (
    <Form form={form} layout="vertical">
      <Row gutter={16}>
        <Col span={12}>
          <Form.Item
            name="fromAccountId"
            label="转出账户"
            rules={[{ required: true, message: '请选择转出账户' }]}
          >
            <Select placeholder="请选择转出账户">
              {accounts.map(account => (
                <Option key={account.id} value={account.id}>
                  {account.accountName} ({security.maskSensitiveData(account.accountNumber, 'bankAccount')})
                </Option>
              ))}
            </Select>
          </Form.Item>
        </Col>
        <Col span={12}>
          <Form.Item
            name="toAccountNumber"
            label="转入账户"
            rules={[
              { required: true, message: '请输入转入账户' },
              { pattern: /^\d{16,19}$/, message: '请输入正确的账户号码' }
            ]}
          >
            <Input placeholder="请输入转入账户号码" />
          </Form.Item>
        </Col>
      </Row>
      <Row gutter={16}>
        <Col span={12}>
          <Form.Item
            name="amount"
            label="转账金额"
            rules={[
              { required: true, message: '请输入转账金额' },
              { type: 'number', min: 0.01, message: '转账金额必须大于0' }
            ]}
          >
            <InputNumber
              style={{ width: '100%' }}
              placeholder="请输入转账金额"
              precision={2}
              min={0.01}
              formatter={value => `¥ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
              parser={value => value.replace(/¥\s?|(,*)/g, '')}
            />
          </Form.Item>
        </Col>
        <Col span={12}>
          <Form.Item
            name="remark"
            label="转账备注"
          >
            <Input placeholder="请输入转账备注（选填）" />
          </Form.Item>
        </Col>
      </Row>
      <Form.Item>
        <Button type="primary" onClick={nextStep}>
          下一步 <ArrowRightOutlined />
        </Button>
      </Form.Item>
    </Form>
  );
  
  // 渲染第二步：确认转账信息
  const renderStep2 = () => {
    if (!transferData) return null;
    
    const fromAccount = accounts.find(account => account.id === transferData.fromAccountId);
    
    return (
      <div className="transfer-confirm">
        <Descriptions title="转账信息确认" bordered column={1}>
          <Descriptions.Item label="转出账户">
            {fromAccount?.accountName} ({security.maskSensitiveData(fromAccount?.accountNumber, 'bankAccount')})
          </Descriptions.Item>
          <Descriptions.Item label="转入账户">
            {security.maskSensitiveData(transferData.toAccountNumber, 'bankAccount')}
          </Descriptions.Item>
          <Descriptions.Item label="转账金额">
            ¥{transferData.amount.toFixed(2)}
          </Descriptions.Item>
          {transferData.remark && (
            <Descriptions.Item label="转账备注">
              {transferData.remark}
            </Descriptions.Item>
          )}
        </Descriptions>
        
        <div className="transfer-actions">
          <Button onClick={prevStep}>
            上一步
          </Button>
          <Button type="primary" onClick={submitTransfer}>
            确认转账
          </Button>
        </div>
      </div>
    );
  };
  
  return (
    <div className="transfer-container">
      <Card title="转账" className="transfer-card">
        <Steps current={currentStep} className="transfer-steps">
          <Step title="填写转账信息" />
          <Step title="确认转账信息" />
        </Steps>
        
        <div className="transfer-content">
          {currentStep === 0 && renderStep1()}
          {currentStep === 1 && renderStep2()}
        </div>
      </Card>
      
      <Modal
        title="确认转账"
        visible={confirmModalVisible}
        onOk={confirmTransfer}
        onCancel={() => setConfirmModalVisible(false)}
        confirmLoading={loading}
      >
        <p>您确定要执行此转账操作吗？此操作不可撤销。</p>
      </Modal>
    </div>
  );
}

export default Transfer;
```

### 11.3.5 效果评估

金融系统微前端架构实施完成后，取得了以下效果：

1. **安全隔离提升**：各业务板块间实现了严格的安全隔离，安全风险降低约60%
2. **合规管理改善**：各业务板块合规要求得到独立满足，合规审计通过率提高约40%
3. **系统稳定性增强**：单个模块的问题不再影响整个系统，系统可用性提高约25%
4. **技术升级加速**：各模块可独立升级，技术栈更新周期缩短约50%
5. **团队协作效率提升**：各团队可独立开发、测试和部署，开发效率提高约35%

### 11.3.6 经验总结

金融系统微前端架构的关键经验：

1. **安全优先**：微前端架构设计必须以安全为首要考虑因素
2. **合规导向**：架构设计需满足各业务板块的合规要求
3. **权限精细**：实现细粒度的权限控制和访问管理
4. **审计完整**：建立完整的操作日志和审计跟踪机制
5. **渐进迁移**：采用渐进式迁移策略，确保业务连续性

## 11.4 案例三：企业管理平台微前端架构

### 11.4.1 业务背景

某大型企业集团拥有多个子公司和业务部门，其管理系统包含人力资源、财务管理、项目管理、客户关系管理等多个功能模块。随着企业规模扩大，原有的单体前端应用面临以下挑战：

1. **系统复杂度高**：功能模块众多，系统复杂度呈指数级增长
2. **维护成本高**：代码耦合度高，维护和扩展困难
3. **个性化需求多**：不同部门和子公司有个性化需求
4. **技术栈不统一**：各模块使用不同技术栈，维护困难
5. **用户体验差**：系统加载慢，操作复杂

### 11.4.2 技术挑战

企业管理平台微前端架构面临的主要技术挑战包括：

1. **模块划分**：如何合理划分功能模块，确保高内聚低耦合
2. **权限管理**：复杂的组织架构和权限体系管理
3. **个性化定制**：满足不同部门和子公司的个性化需求
4. **数据共享**：各模块间数据共享和状态同步
5. **性能优化**：大型系统的性能优化和资源管理

### 11.4.3 架构设计

#### 11.4.3.1 整体架构

企业管理平台采用基于single-spa的微前端架构，整体设计如下：

```javascript
//企业管理平台微前端架构设计
class EnterpriseManagementPlatform {
  constructor() {
    this.config = {
      // 主应用配置
      mainApp: {
        name: 'emp-main',
        entry: '//main.emp.com',
        container: '#main-container',
        activeRule: '/'
      },
      
      // 微应用配置
      microApps: [
        {
          name: 'dashboard',
          entry: '//dashboard.emp.com',
          container: '#dashboard-container',
          activeRule: '/dashboard',
          customProps: {
            routerBase: '/dashboard',
            permissions: ['dashboard_view']
          }
        },
        {
          name: 'hr',
          entry: '//hr.emp.com',
          container: '#hr-container',
          activeRule: '/hr',
          customProps: {
            routerBase: '/hr',
            permissions: ['hr_view', 'hr_manage']
          }
        },
        {
          name: 'finance',
          entry: '//finance.emp.com',
          container: '#finance-container',
          activeRule: '/finance',
          customProps: {
            routerBase: '/finance',
            permissions: ['finance_view', 'finance_manage']
          }
        },
        {
          name: 'project',
          entry: '//project.emp.com',
          container: '#project-container',
          activeRule: '/project',
          customProps: {
            routerBase: '/project',
            permissions: ['project_view', 'project_manage']
          }
        },
        {
          name: 'crm',
          entry: '//crm.emp.com',
          container: '#crm-container',
          activeRule: '/crm',
          customProps: {
            routerBase: '/crm',
            permissions: ['crm_view', 'crm_manage']
          }
        },
        {
          name: 'admin',
          entry: '//admin.emp.com',
          container: '#admin-container',
          activeRule: '/admin',
          customProps: {
            routerBase: '/admin',
            permissions: ['admin_view', 'admin_manage']
          }
        }
      ],
      
      // 权限配置
      permissionConfig: {
        // 角色权限映射
        rolePermissions: {
          'super_admin': ['*'],
          'admin': ['admin_*', 'dashboard_view'],
          'hr_manager': ['hr_*', 'dashboard_view'],
          'finance_manager': ['finance_*', 'dashboard_view'],
          'project_manager': ['project_*', 'dashboard_view'],
          'sales_manager': ['crm_*', 'dashboard_view'],
          'employee': ['dashboard_view', 'hr_view', 'finance_view', 'project_view', 'crm_view']
        },
        
        // 部门权限映射
        departmentPermissions: {
          'hr': ['hr_*'],
          'finance': ['finance_*'],
          'project': ['project_*'],
          'sales': ['crm_*'],
          'it': ['admin_*']
        }
      },
      
      // 个性化配置
      personalizationConfig: {
        // 主题配置
        themes: {
          'default': {
            primaryColor: '#1890ff',
            backgroundColor: '#f0f2f5',
            textColor: '#000000'
          },
          'dark': {
            primaryColor: '#1890ff',
            backgroundColor: '#141414',
            textColor: '#ffffff'
          },
          'blue': {
            primaryColor: '#0050b3',
            backgroundColor: '#f0f5ff',
            textColor: '#000000'
          },
          'green': {
            primaryColor: '#389e0d',
            backgroundColor: '#f6ffed',
            textColor: '#000000'
          }
        },
        
        // 布局配置
        layouts: {
          'top': {
            headerPosition: 'top',
            sidebarPosition: 'left',
            contentPosition: 'center'
          },
          'side': {
            headerPosition: 'top',
            sidebarPosition: 'left',
            contentPosition: 'center'
          },
          'mix': {
            headerPosition: 'top',
            sidebarPosition: 'left',
            contentPosition: 'center'
          }
        }
      },
      
      // 全局配置
      globalConfig: {
        // 沙箱配置
        sandbox: {
          strictStyleIsolation: true,
          experimentalStyleIsolation: true
        },
        
        // 预加载配置
        prefetch: true,
        
        // 生命周期配置
        lifeCycles: {
          beforeLoad: [
            app => {
              console.log(`${app.name} 加载前`);
              // 权限检查
              this.checkAppPermissions(app);
            }
          ],
          beforeMount: [
            app => {
              console.log(`${app.name} 挂载前`);
              // 个性化配置
              this.applyPersonalization(app);
            }
          ],
          afterMount: [
            app => {
              console.log(`${app.name} 挂载后`);
              // 记录访问日志
              this.logAccess(app);
            }
          ],
          beforeUnmount: [
            app => {
              console.log(`${app.name} 卸载前`);
              // 保存状态
              this.saveAppState(app);
            }
          ],
          afterUnmount: [
            app => {
              console.log(`${app.name} 卸载后`);
              // 清理资源
              this.cleanupAppResources(app);
            }
          ]
        }
      }
    };
    
    // 初始化状态
    this.currentUser = null;
    this.userPermissions = [];
    this.userDepartment = null;
    this.userTheme = 'default';
    this.userLayout = 'side';
  }
  
  // 初始化微前端
  init() {
    this.initAuth();
    this.registerMicroApps();
    this.start();
    this.setupGlobalState();
    this.setupErrorHandler();
    this.setupPersonalization();
  }
  
  // 初始化认证
  initAuth() {
    // 检查是否有有效会话
    const token = this.getStoredToken();
    if (token && this.validateToken(token)) {
      this.sessionToken = token;
      this.currentUser = this.decodeToken(token);
      this.userPermissions = this.getUserPermissions(this.currentUser.roles, this.currentUser.department);
      this.userDepartment = this.currentUser.department;
      
      // 获取用户个性化配置
      this.loadUserPersonalization();
    } else {
      // 重定向到登录页面
      this.redirectToLogin();
    }
  }
  
  // 注册微应用
  registerMicroApps() {
    const { microApps } = this.config;
    
    microApps.forEach(app => {
      this.enhanceMicroApp(app);
    });
    
    // 使用single-spa注册微应用
    this.setupSingleSpa(microApps);
  }
  
  // 增强微应用配置
  enhanceMicroApp(app) {
    // 添加通用props
    app.customProps = {
      ...app.customProps,
      // 全局状态
      globalState: this.getGlobalState(),
      // 路由
      router: this.getRouter(),
      // 工具函数
      utils: this.getUtils(),
      // API服务
      api: this.getApiService(),
      // 用户信息
      userInfo: this.currentUser,
      // 用户权限
      userPermissions: this.userPermissions,
      // 用户部门
      userDepartment: this.userDepartment,
      // 个性化配置
      personalization: {
        theme: this.userTheme,
        layout: this.userLayout
      },
      // 主题服务
      themeService: this.getThemeService(),
      // 布局服务
      layoutService: this.getLayoutService()
    };
  }
  
  // 设置single-spa
  setupSingleSpa(microApps) {
    // single-spa配置
    microApps.forEach(app => {
      singleSpa.registerApplication(
        app.name,
        () => System.import(app.name),
        location => location.pathname.startsWith(app.activeRule),
        app.customProps
      );
    });
    
    // 启动single-spa
    singleSpa.start();
  }
  
  // 启动微前端
  start() {
    // 启动主应用
    this.startMainApp();
    
    // 设置路由
    this.setupRouting();
  }
  
  // 启动主应用
  startMainApp() {
    // 主应用启动逻辑
    console.log('启动企业管理平台主应用');
  }
  
  // 设置路由
  setupRouting() {
    // 路由守卫
    this.setupRouteGuards();
    
    // 路由配置
    this.configureRoutes();
  }
  
  // 设置路由守卫
  setupRouteGuards() {
    // 前置守卫 - 权限检查
    const beforeRouteEnter = (to, from, next) => {
      if (!this.currentUser) {
        this.redirectToLogin();
        return;
      }
      
      // 检查路由权限
      const requiredPermissions = this.getRequiredPermissions(to.path);
      if (!this.hasPermissions(requiredPermissions)) {
        this.redirectToUnauthorized();
        return;
      }
      
      next();
    };
    
    // 应用路由守卫
    this.applyRouteGuards({ beforeRouteEnter });
  }
  
  // 获取所需权限
  getRequiredPermissions(path) {
    // 根据路径获取所需权限
    const permissionMap = {
      '/dashboard': ['dashboard_view'],
      '/hr': ['hr_view'],
      '/hr/employees': ['hr_view'],
      '/hr/employees/add': ['hr_manage'],
      '/hr/employees/edit': ['hr_manage'],
      '/finance': ['finance_view'],
      '/finance/budgets': ['finance_view'],
      '/finance/budgets/add': ['finance_manage'],
      '/finance/budgets/edit': ['finance_manage'],
      '/project': ['project_view'],
      '/project/projects': ['project_view'],
      '/project/projects/add': ['project_manage'],
      '/project/projects/edit': ['project_manage'],
      '/crm': ['crm_view'],
      '/crm/customers': ['crm_view'],
      '/crm/customers/add': ['crm_manage'],
      '/crm/customers/edit': ['crm_manage'],
      '/admin': ['admin_view'],
      '/admin/users': ['admin_view'],
      '/admin/users/add': ['admin_manage'],
      '/admin/users/edit': ['admin_manage']
    };
    
    return permissionMap[path] || [];
  }
  
  // 检查权限
  hasPermissions(requiredPermissions) {
    if (this.userPermissions.includes('*')) {
      return true; // 超级管理员权限
    }
    
    return requiredPermissions.every(permission => 
      this.userPermissions.some(userPermission => 
        userPermission === permission || 
        userPermission === '*' ||
        (userPermission.endsWith('_*') && permission.startsWith(userPermission.slice(0, -1)))
      )
    );
  }
  
  // 检查应用权限
  checkAppPermissions(app) {
    const requiredPermissions = app.customProps.permissions || [];
    if (!this.hasPermissions(requiredPermissions)) {
      throw new Error(`无权限访问应用: ${app.name}`);
    }
  }
  
  // 应用个性化配置
  applyPersonalization(app) {
    // 应用主题
    this.applyTheme(app, this.userTheme);
    
    // 应用布局
    this.applyLayout(app, this.userLayout);
  }
  
  // 应用主题
  applyTheme(app, theme) {
    // 主题应用实现
    console.log(`应用 ${app.name} 应用主题: ${theme}`);
  }
  
  // 应用布局
  applyLayout(app, layout) {
    // 布局应用实现
    console.log(`应用 ${app.name} 应用布局: ${layout}`);
  }
  
  // 记录访问
  logAccess(app) {
    // 访问记录实现
    console.log(`记录访问: ${app.name}, 用户: ${this.currentUser.id}`);
  }
  
  // 保存应用状态
  saveAppState(app) {
    // 应用状态保存实现
    console.log(`保存应用状态: ${app.name}`);
  }
  
  // 清理应用资源
  cleanupAppResources(app) {
    // 应用资源清理实现
    console.log(`清理应用资源: ${app.name}`);
  }
  
  // 设置全局状态
  setupGlobalState() {
    // 全局状态管理
    this.globalState = this.createGlobalState({
      // 用户信息
      userInfo: this.currentUser,
      // 用户权限
      userPermissions: this.userPermissions,
      // 用户部门
      userDepartment: this.userDepartment,
      // 个性化配置
      personalization: {
        theme: this.userTheme,
        layout: this.userLayout
      },
      // 全局配置
      config: {
        language: 'zh-CN'
      }
    });
    
    // 监听状态变化
    this.globalState.onGlobalStateChange((state, prev) => {
      console.log('主应用检测到状态变化:', state, prev);
      this.handleGlobalStateChange(state, prev);
    });
  }
  
  // 创建全局状态
  createGlobalState(initialState) {
    // 状态管理器
    const stateManager = {
      state: initialState,
      subscribers: [],
      
      getGlobalState: () => {
        return this.state;
      },
      
      setGlobalState: (newState) => {
        this.state = {
          ...this.state,
          ...newState
        };
        
        // 通知订阅者
        this.subscribers.forEach(callback => {
          callback(this.state);
        });
      },
      
      onGlobalStateChange: (callback) => {
        this.subscribers.push(callback);
        
        // 返回取消订阅函数
        return () => {
          const index = this.subscribers.indexOf(callback);
          if (index > -1) {
            this.subscribers.splice(index, 1);
          }
        };
      }
    };
    
    return stateManager;
  }
  
  // 设置错误处理
  setupErrorHandler() {
    // 全局错误处理
    window.addEventListener('error', this.handleGlobalError.bind(this));
    window.addEventListener('unhandledrejection', this.handleUnhandledRejection.bind(this));
  }
  
  // 处理全局错误
  handleGlobalError(event) {
    console.error('全局错误:', event.error);
    
    // 错误上报
    this.reportError(event.error);
  }
  
  // 处理未捕获的Promise拒绝
  handleUnhandledRejection(event) {
    console.error('未捕获的Promise拒绝:', event.reason);
    
    // 错误上报
    this.reportError(event.reason);
  }
  
  // 设置个性化
  setupPersonalization() {
    // 初始化主题服务
    this.initThemeService();
    
    // 初始化布局服务
    this.initLayoutService();
  }
  
  // 初始化主题服务
  initThemeService() {
    // 主题服务初始化实现
    console.log('初始化主题服务');
  }
  
  // 初始化布局服务
  initLayoutService() {
    // 布局服务初始化实现
    console.log('初始化布局服务');
  }
  
  // 加载用户个性化配置
  loadUserPersonalization() {
    try {
      const personalization = localStorage.getItem('user_personalization');
      if (personalization) {
        const config = JSON.parse(personalization);
        this.userTheme = config.theme || 'default';
        this.userLayout = config.layout || 'side';
      }
    } catch (e) {
      console.error('加载用户个性化配置失败:', e);
    }
  }
  
  // 保存用户个性化配置
  saveUserPersonalization() {
    try {
      const personalization = {
        theme: this.userTheme,
        layout: this.userLayout
      };
      localStorage.setItem('user_personalization', JSON.stringify(personalization));
    } catch (e) {
      console.error('保存用户个性化配置失败:', e);
    }
  }
  
  // 获取全局状态
  getGlobalState() {
    return {
      getGlobalState: this.globalState.getGlobalState.bind(this.globalState),
      setGlobalState: this.globalState.setGlobalState.bind(this.globalState),
      onGlobalStateChange: this.globalState.onGlobalStateChange.bind(this.globalState)
    };
  }
  
  // 获取路由
  getRouter() {
    return {
      push: (path) => {
        // 权限检查
        const requiredPermissions = this.getRequiredPermissions(path);
        if (!this.hasPermissions(requiredPermissions)) {
          this.redirectToUnauthorized();
          return;
        }
        
        window.history.pushState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      replace: (path) => {
        // 权限检查
        const requiredPermissions = this.getRequiredPermissions(path);
        if (!this.hasPermissions(requiredPermissions)) {
          this.redirectToUnauthorized();
          return;
        }
        
        window.history.replaceState({}, '', path);
        window.dispatchEvent(new PopStateEvent('popstate'));
      },
      go: (n) => {
        window.history.go(n);
      },
      back: () => {
        window.history.back();
      },
      forward: () => {
        window.history.forward();
      }
    };
  }
  
  // 获取工具函数
  getUtils() {
    return {
      // 格式化日期
      formatDate: (date, format = 'YYYY-MM-DD') => {
        // 日期格式化实现
        return date; // 简化实现
      },
      
      // 格式化数字
      formatNumber: (number, decimals = 2) => {
        return new Intl.NumberFormat('zh-CN', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(number);
      },
      
      // 防抖函数
      debounce: (func, wait) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // 节流函数
      throttle: (func, wait) => {
        let lastTime = 0;
        return function(...args) {
          const now = Date.now();
          if (now - lastTime >= wait) {
            lastTime = now;
            return func.apply(this, args);
          }
        };
      }
    };
  }
  
  // 获取API服务
  getApiService() {
    return {
      // 仪表板API
      dashboard: {
        getOverview: () => {
          return this.secureFetch('/api/dashboard/overview', {
            method: 'GET'
          });
        },
        getWidgets: () => {
          return this.secureFetch('/api/dashboard/widgets', {
            method: 'GET'
          });
        }
      },
      
      // 人力资源API
      hr: {
        getEmployees: (params) => {
          return this.secureFetch('/api/hr/employees', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
        },
        addEmployee: (data) => {
          return this.secureFetch('/api/hr/employees', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        updateEmployee: (id, data) => {
          return this.secureFetch(`/api/hr/employees/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        deleteEmployee: (id) => {
          return this.secureFetch(`/api/hr/employees/${id}`, {
            method: 'DELETE'
          });
        }
      },
      
      // 财务API
      finance: {
        getBudgets: (params) => {
          return this.secureFetch('/api/finance/budgets', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
        },
        addBudget: (data) => {
          return this.secureFetch('/api/finance/budgets', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        updateBudget: (id, data) => {
          return this.secureFetch(`/api/finance/budgets/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        deleteBudget: (id) => {
          return this.secureFetch(`/api/finance/budgets/${id}`, {
            method: 'DELETE'
          });
        }
      },
      
      // 项目API
      project: {
        getProjects: (params) => {
          return this.secureFetch('/api/project/projects', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
        },
        addProject: (data) => {
          return this.secureFetch('/api/project/projects', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        updateProject: (id, data) => {
          return this.secureFetch(`/api/project/projects/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        deleteProject: (id) => {
          return this.secureFetch(`/api/project/projects/${id}`, {
            method: 'DELETE'
          });
        }
      },
      
      // CRM API
      crm: {
        getCustomers: (params) => {
          return this.secureFetch('/api/crm/customers', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
        },
        addCustomer: (data) => {
          return this.secureFetch('/api/crm/customers', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        updateCustomer: (id, data) => {
          return this.secureFetch(`/api/crm/customers/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        deleteCustomer: (id) => {
          return this.secureFetch(`/api/crm/customers/${id}`, {
            method: 'DELETE'
          });
        }
      },
      
      // 管理员API
      admin: {
        getUsers: (params) => {
          return this.secureFetch('/api/admin/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
        },
        addUser: (data) => {
          return this.secureFetch('/api/admin/users', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        updateUser: (id, data) => {
          return this.secureFetch(`/api/admin/users/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        },
        deleteUser: (id) => {
          return this.secureFetch(`/api/admin/users/${id}`, {
            method: 'DELETE'
          });
        }
      }
    };
  }
  
  // 安全请求
  secureFetch(url, options = {}) {
    // 添加认证头
    const headers = {
      ...options.headers,
      'Authorization': `Bearer ${this.sessionToken}`
    };
    
    // 发送请求
    return fetch(url, {
      ...options,
      headers
    })
    .then(response => {
      // 检查响应状态
      if (!response.ok) {
        throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
      }
      
      return response.json();
    });
  }
  
  // 获取主题服务
  getThemeService() {
    return {
      // 获取主题
      getTheme: () => {
        return this.userTheme;
      },
      
      // 设置主题
      setTheme: (theme) => {
        this.userTheme = theme;
        this.saveUserPersonalization();
        
        // 更新全局状态
        this.globalState.setGlobalState({
          personalization: {
            ...this.globalState.getGlobalState().personalization,
            theme
          }
        });
        
        // 应用主题
        this.applyGlobalTheme(theme);
      },
      
      // 获取可用主题
      getAvailableThemes: () => {
        return Object.keys(this.config.personalizationConfig.themes);
      }
    };
  }
  
  // 获取布局服务
  getLayoutService() {
    return {
      // 获取布局
      getLayout: () => {
        return this.userLayout;
      },
      
      // 设置布局
      setLayout: (layout) => {
        this.userLayout = layout;
        this.saveUserPersonalization();
        
        // 更新全局状态
        this.globalState.setGlobalState({
          personalization: {
            ...this.globalState.getGlobalState().personalization,
            layout
          }
        });
        
        // 应用布局
        this.applyGlobalLayout(layout);
      },
      
      // 获取可用布局
      getAvailableLayouts: () => {
        return Object.keys(this.config.personalizationConfig.layouts);
      }
    };
  }
  
  // 应用全局主题
  applyGlobalTheme(theme) {
    // 全局主题应用实现
    console.log('应用全局主题:', theme);
  }
  
  // 应用全局布局
  applyGlobalLayout(layout) {
    // 全局布局应用实现
    console.log('应用全局布局:', layout);
  }
  
  // 获取存储的令牌
  getStoredToken() {
    try {
      return sessionStorage.getItem('auth_token');
    } catch (e) {
      console.error('获取存储令牌失败:', e);
      return null;
    }
  }
  
  // 验证令牌
  validateToken(token) {
    try {
      // 解析令牌
      const payload = this.decodeToken(token);
      
      // 检查过期时间
      const now = Math.floor(Date.now() / 1000);
      if (payload.exp && payload.exp < now) {
        return false;
      }
      
      // 验证令牌签名
      return this.verifyTokenSignature(token);
    } catch (e) {
      console.error('验证令牌失败:', e);
      return false;
    }
  }
  
  // 解码令牌
  decodeToken(token) {
    try {
      const parts = token.split('.');
      if (parts.length !== 3) {
        throw new Error('无效的令牌格式');
      }
      
      const payload = JSON.parse(atob(parts[1]));
      return payload;
    } catch (e) {
      console.error('解码令牌失败:', e);
      throw e;
    }
  }
  
  // 验证令牌签名
  verifyTokenSignature(token) {
    // 令牌签名验证实现
    return true; // 简化实现
  }
  
  // 获取用户权限
  getUserPermissions(roles, department) {
    const { rolePermissions, departmentPermissions } = this.config.permissionConfig;
    
    let permissions = [];
    
    // 角色权限
    roles.forEach(role => {
      if (rolePermissions[role]) {
        permissions = [...permissions, ...rolePermissions[role]];
      }
    });
    
    // 部门权限
    if (department && departmentPermissions[department]) {
      permissions = [...permissions, ...departmentPermissions[department]];
    }
    
    // 去重
    return [...new Set(permissions)];
  }
  
  // 重定向到登录页面
  redirectToLogin() {
    window.location.href = '/login';
  }
  
  // 重定向到未授权页面
  redirectToUnauthorized() {
    window.location.href = '/unauthorized';
  }
  
  // 处理全局状态变化
  handleGlobalStateChange(state, prev) {
    // 状态变化处理逻辑
    console.log('全局状态变化:', state, prev);
  }
  
  // 错误上报
  reportError(err) {
    // 错误上报实现
    console.error('错误上报:', err);
  }
  
  // 应用路由守卫
  applyRouteGuards(guards) {
    // 路由守卫应用实现
    console.log('应用路由守卫', guards);
  }
  
  // 配置路由
  configureRoutes() {
    // 路由配置实现
    console.log('配置路由');
  }
}

// 导出企业管理平台微前端实例
export default new EnterpriseManagementPlatform();
```

### 11.4.4 实现细节

#### 11.4.4.1 仪表板微应用

仪表板微应用负责展示企业整体运营数据和关键指标：

```javascript
// 仪表板微应用入口
import React from 'react';
import ReactDOM from 'react-dom';
import { BrowserRouter as Router, Route, Switch } from 'react-router-dom';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/es/locale/zh_CN';
import Dashboard from './components/Dashboard';
import WidgetConfig from './components/WidgetConfig';
import './index.css';

let globalState = null;
let router = null;
let api = null;
let userInfo = null;
let userPermissions = null;
let userDepartment = null;
let personalization = null;
let themeService = null;
let layoutService = null;

// 生命周期
export async function bootstrap() {
  console.log('仪表板微应用 bootstrap');
}

export async function mount(props) {
  console.log('仪表板微应用 mount', props);
  
  // 获取主应用传递的props
  ({ 
    globalState, 
    router, 
    api, 
    userInfo, 
    userPermissions, 
    userDepartment, 
    personalization, 
    themeService, 
    layoutService 
  } = props);
  
  // 渲染微应用
  ReactDOM.render(
    <ConfigProvider locale={zhCN}>
      <Router basename={props.routerBase}>
        <App />
      </Router>
    </ConfigProvider>,
    props.container ? props.container.querySelector('#dashboard-container') : document.getElementById('dashboard-container')
  );
}

export async function unmount(props) {
  console.log('仪表板微应用 unmount');
  ReactDOM.unmountComponentAtNode(
    props.container ? props.container.querySelector('#dashboard-container') : document.getElementById('dashboard-container')
  );
}

// 主应用组件
function App() {
  return (
    <div className="dashboard-app">
      <Switch>
        <Route exact path="/" component={Dashboard} />
        <Route path="/config" component={WidgetConfig} />
      </Switch>
    </div>
  );
}

// 导出全局状态、路由和API供组件使用
export { 
  globalState, 
  router, 
  api, 
  userInfo, 
  userPermissions, 
  userDepartment, 
  personalization, 
  themeService, 
  layoutService 
};
```

仪表板组件实现：

```javascript
// 仪表板组件
import React, { useState, useEffect } from 'react';
import { Card, Row, Col, Statistic, Table, Select, Button, Spin, message } from 'antd';
import { 
  UserOutlined, 
  TeamOutlined, 
  DollarOutlined, 
  ProjectOutlined,
  SettingOutlined
} from '@ant-design/icons';
import { 
  globalState, 
  router, 
  api, 
  userInfo, 
  userPermissions, 
  userDepartment, 
  personalization, 
  themeService, 
  layoutService 
} from '../index';
import './Dashboard.css';

const { Option } = Select;

function Dashboard() {
  const [overview, setOverview] = useState({});
  const [widgets, setWidgets] = useState([]);
  const [loading, setLoading] = useState(false);
  const [timeRange, setTimeRange] = useState('month');
  
  // 获取概览数据
  const fetchOverview = async () => {
    setLoading(true);
    try {
      const data = await api.dashboard.getOverview({
        timeRange
      });
      setOverview(data || {});
    } catch (error) {
      console.error('获取概览数据失败:', error);
      message.error('获取概览数据失败，请重试');
    } finally {
      setLoading(false);
    }
  };
  
  // 获取小部件
  const fetchWidgets = async () => {
    try {
      const data = await api.dashboard.getWidgets();
      setWidgets(data || []);
    } catch (error) {
      console.error('获取小部件失败:', error);
      message.error('获取小部件失败，请重试');
    }
  };
  
  // 初始加载
  useEffect(() => {
    fetchOverview();
    fetchWidgets();
  }, [timeRange]);
  
  // 监听个性化配置变化
  useEffect(() => {
    const unsubscribe = globalState.onGlobalStateChange((state) => {
      if (state.personalization) {
        // 个性化配置变化时重新渲染
        console.log('个性化配置变化:', state.personalization);
      }
    });
    
    return () => {
      unsubscribe();
    };
  }, []);
  
  // 切换主题
  const changeTheme = (theme) => {
    themeService.setTheme(theme);
  };
  
  // 切换布局
  const changeLayout = (layout) => {
    layoutService.setLayout(layout);
  };
  
  // 跳转到小部件配置
  const goToWidgetConfig = () => {
    router.push('/dashboard/config');
  };
  
  // 渲染概览卡片
  const renderOverviewCards = () => {
    return (
      <Row gutter={16} className="overview-cards">
        <Col span={6}>
          <Card>
            <Statistic
              title="员工总数"
              value={overview.employeeCount || 0}
              prefix={<UserOutlined />}
              valueStyle={{ color: '#1890ff' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="部门总数"
              value={overview.departmentCount || 0}
              prefix={<TeamOutlined />}
              valueStyle={{ color: '#52c41a' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="本月营收"
              value={overview.monthlyRevenue || 0}
              prefix={<DollarOutlined />}
              precision={2}
              valueStyle={{ color: '#faad14' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="进行中项目"
              value={overview.activeProjects || 0}
              prefix={<ProjectOutlined />}
              valueStyle={{ color: '#f5222d' }}
            />
          </Card>
        </Col>
      </Row>
    );
  };
  
  // 渲染小部件
  const renderWidgets = () => {
    return (
      <Row gutter={16} className="dashboard-widgets">
        {widgets.map(widget => (
          <Col key={widget.id} span={widget.span || 12}>
            <Card title={widget.title} className="widget-card">
              {widget.type === 'table' && renderTableWidget(widget)}
              {widget.type === 'chart' && renderChartWidget(widget)}
              {widget.type === 'list' && renderListWidget(widget)}
            </Card>
          </Col>
        ))}
      </Row>
    );
  };
  
  // 渲染表格小部件
  const renderTableWidget = (widget) => {
    const columns = widget.columns || [];
    const dataSource = widget.data || [];
    
    return (
      <Table
        columns={columns}
        dataSource={dataSource}
        pagination={false}
        size="small"
      />
    );
  };
  
  // 渲染图表小部件
  const renderChartWidget = (widget) => {
    // 图表渲染实现
    return <div className="chart-placeholder">图表: {widget.title}</div>;
  };
  
  // 渲染列表小部件
  const renderListWidget = (widget) => {
    const items = widget.data || [];
    
    return (
      <ul className="widget-list">
        {items.map((item, index) => (
          <li key={index}>{item}</li>
        ))}
      </ul>
    );
  };
  
  return (
    <div className="dashboard-container">
      <div className="dashboard-header">
        <h2>企业仪表板</h2>
        <div className="dashboard-controls">
          <Select
            value={timeRange}
            onChange={setTimeRange}
            style={{ width: 120, marginRight: 16 }}
          >
            <Option value="day">今日</Option>
            <Option value="week">本周</Option>
            <Option value="month">本月</Option>
            <Option value="year">本年</Option>
          </Select>
          
          <Select
            value={personalization.theme}
            onChange={changeTheme}
            style={{ width: 120, marginRight: 16 }}
          >
            <Option value="default">默认主题</Option>
            <Option value="dark">暗色主题</Option>
            <Option value="blue">蓝色主题</Option>
            <Option value="green">绿色主题</Option>
          </Select>
          
          <Select
            value={personalization.layout}
            onChange={changeLayout}
            style={{ width: 120, marginRight: 16 }}
          >
            <Option value="top">顶部布局</Option>
            <Option value="side">侧边布局</Option>
            <Option value="mix">混合布局</Option>
          </Select>
          
          <Button 
            icon={<SettingOutlined />} 
            onClick={goToWidgetConfig}
          >
            配置小部件
          </Button>
        </div>
      </div>
      
      <Spin spinning={loading}>
        {renderOverviewCards()}
        {renderWidgets()}
      </Spin>
    </div>
  );
}

export default Dashboard;
```

### 11.4.5 效果评估

企业管理平台微前端架构实施完成后，取得了以下效果：

1. **系统复杂度降低**：模块化设计降低了系统复杂度，维护成本降低约30%
2. **个性化需求满足**：不同部门和子公司的个性化需求得到满足，用户满意度提高约45%
3. **开发效率提升**：各团队可独立开发、测试和部署，开发效率提高约40%
4. **技术栈统一**：各模块技术栈逐步统一，维护成本降低约25%
5. **用户体验改善**：系统加载时间减少约30%，操作复杂度降低约35%

### 11.4.6 经验总结

企业管理平台微前端架构的关键经验：

1. **模块化设计**：按照业务领域而非技术层次划分微应用
2. **权限精细化**：实现基于角色和部门的精细化权限控制
3. **个性化支持**：提供丰富的个性化配置选项，满足不同用户需求
4. **状态管理**：设计清晰的全局状态与本地状态边界
5. **渐进迁移**：采用渐进式迁移策略，降低业务风险

## 11.5 实战案例对比分析

### 11.5.1 案例对比

| 对比维度 | 电商平台 | 金融系统 | 企业管理平台 |
|---------|---------|---------|-------------|
| 业务场景 | B2C电商 | 金融服务 | 企业内部管理 |
| 核心挑战 | 状态共享、性能优化 | 安全隔离、合规管理 | 个性化定制、权限管理 |
| 技术选型 | qiankun | Module Federation | single-spa |
| 实施难度 | 中等 | 高 | 中等 |
| 实施周期 | 3-6个月 | 6-12个月 | 4-8个月 |
| 效果评估 | 开发效率提升40% | 安全风险降低60% | 用户满意度提高45% |

### 11.5.2 共同经验

通过三个实战案例的分析，我们可以总结出以下共同经验：

1. **合理拆分**：按照业务领域而非技术层次拆分微应用，确保高内聚低耦合
2. **通信机制**：建立标准化的微应用间通信协议，降低耦合度
3. **状态管理**：设计清晰的全局状态与本地状态边界，避免状态混乱
4. **统一规范**：制定统一的开发规范、UI组件库和工程化体系
5. **渐进迁移**：采用渐进式迁移策略，降低业务风险和实施难度

### 11.5.3 差异化策略

不同场景下的微前端实施需要采取差异化策略：

1. **电商平台**：重点关注性能优化和用户体验，采用预加载和缓存策略
2. **金融系统**：重点关注安全隔离和合规管理，采用严格的安全措施
3. **企业管理平台**：重点关注个性化定制和权限管理，提供灵活的配置选项

## 11.6 总结

微前端架构在不同行业的应用实践表明，它能够有效解决大型前端应用面临的开发效率、技术栈升级、维护成本等问题。通过合理的技术选型、架构设计和实施策略，微前端可以为企业带来显著的业务价值和技术收益。

在实施微前端架构时，需要根据具体业务场景和技术需求，选择合适的技术方案和实施路径。同时，需要建立完善的开发规范、工程化体系和监控机制，确保微前端架构的长期稳定运行。

微前端架构作为前端技术发展的重要方向，将在未来得到更广泛的应用和更深入的发展。企业和开发者需要持续关注微前端技术的发展趋势，不断提升自身的技术能力和实践经验。