---
# Web æœåŠ¡å™¨é…ç½® Playbook
- name: "é…ç½® Nginx Web æœåŠ¡å™¨"
  hosts: web_servers
  become: yes
  vars:
    server_name: "myapp.local"
    document_root: "/var/www/myapp"
    nginx_user: "www-data"
    app_port: 80
    
  tasks:
    - name: "æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜ (Ubuntu/Debian)"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      
    - name: "å®‰è£… Nginx"
      package:
        name: nginx
        state: present
        
    - name: "å®‰è£…å¿…è¦çš„å·¥å…·"
      package:
        name:
          - curl
          - wget
          - htop
        state: present
        
    - name: "åˆ›å»ºåº”ç”¨ç›®å½•"
      file:
        path: "{{ document_root }}"
        state: directory
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0755'
        
    - name: "å¤‡ä»½é»˜è®¤é…ç½®"
      copy:
        src: /etc/nginx/sites-available/default
        dest: /etc/nginx/sites-available/default.backup
        remote_src: yes
      ignore_errors: yes
      
    - name: "åˆ›å»ºè™šæ‹Ÿä¸»æœºé…ç½®"
      copy:
        content: |
          # {{ server_name }} è™šæ‹Ÿä¸»æœºé…ç½®
          server {
              listen {{ app_port }};
              listen [::]:{{ app_port }};
              
              server_name {{ server_name }} www.{{ server_name }};
              root {{ document_root }};
              index index.html index.htm index.nginx-debian.html;
              
              # å®‰å…¨å¤´è®¾ç½®
              add_header X-Frame-Options "SAMEORIGIN";
              add_header X-XSS-Protection "1; mode=block";
              add_header X-Content-Type-Options "nosniff";
              
              # ä¸»è¦ä½ç½®å—
              location / {
                  try_files $uri $uri/ =404;
              }
              
              # é™æ€æ–‡ä»¶ç¼“å­˜
              location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              # éšè— .htaccess æ–‡ä»¶
              location ~ /\.ht {
                  deny all;
              }
              
              # æ—¥å¿—é…ç½®
              access_log /var/log/nginx/{{ server_name }}.access.log;
              error_log /var/log/nginx/{{ server_name }}.error.log;
          }
        dest: "/etc/nginx/sites-available/{{ server_name }}"
        owner: root
        group: root
        mode: '0644'
      notify: 
        - reload nginx
        
    - name: "å¯ç”¨ç«™ç‚¹"
      file:
        src: "/etc/nginx/sites-available/{{ server_name }}"
        dest: "/etc/nginx/sites-enabled/{{ server_name }}"
        state: link
      notify: reload nginx
      
    - name: "åˆ é™¤é»˜è®¤ç«™ç‚¹"
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: reload nginx
      
    - name: "æµ‹è¯• Nginx é…ç½®"
      command: nginx -t
      register: nginx_config_test
      changed_when: false
      
    - name: "æ˜¾ç¤ºé…ç½®æµ‹è¯•ç»“æœ"
      debug:
        msg: "Nginx é…ç½®æµ‹è¯•: {{ nginx_config_test.stderr }}"
        
    - name: "åˆ›å»ºç¤ºä¾‹ä¸»é¡µ"
      copy:
        content: |
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>æ¬¢è¿æ¥åˆ° {{ server_name }}</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 { color: #333; text-align: center; }
                  .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .status { display: flex; justify-content: space-between; margin: 10px 0; }
                  .label { font-weight: bold; }
                  .footer { text-align: center; margin-top: 30px; color: #666; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ‰ Web æœåŠ¡å™¨é…ç½®æˆåŠŸï¼</h1>
                  
                  <div class="info">
                      <h3>æœåŠ¡å™¨ä¿¡æ¯</h3>
                      <div class="status">
                          <span class="label">ä¸»æœºå:</span>
                          <span>{{ inventory_hostname }}</span>
                      </div>
                      <div class="status">
                          <span class="label">æœåŠ¡å™¨å:</span>
                          <span>{{ server_name }}</span>
                      </div>
                      <div class="status">
                          <span class="label">ç³»ç»Ÿ:</span>
                          <span>{{ ansible_distribution }} {{ ansible_distribution_version }}</span>
                      </div>
                      <div class="status">
                          <span class="label">Nginx ç‰ˆæœ¬:</span>
                          <span id="nginx-version">æ£€æµ‹ä¸­...</span>
                      </div>
                      <div class="status">
                          <span class="label">éƒ¨ç½²æ—¶é—´:</span>
                          <span>{{ ansible_date_time.iso8601 }}</span>
                      </div>
                  </div>
                  
                  <div class="info">
                      <h3>å¿«é€Ÿæµ‹è¯•</h3>
                      <p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•æœåŠ¡å™¨:</p>
                      <pre>curl -I http://{{ ansible_default_ipv4.address | default('localhost') }}</pre>
                  </div>
                  
                  <div class="footer">
                      <p>Powered by Ansible & Nginx</p>
                  </div>
              </div>
              
              <script>
                  // ç®€å•çš„ç‰ˆæœ¬æ£€æµ‹
                  fetch('/nginx-version')
                      .then(response => response.text())
                      .catch(() => 'nginx/unknown')
                      .then(version => {
                          document.getElementById('nginx-version').textContent = 'Nginx å·²å®‰è£…';
                      });
              </script>
          </body>
          </html>
        dest: "{{ document_root }}/index.html"
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0644'
        
    - name: "åˆ›å»ºæµ‹è¯•é¡µé¢"
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>æœåŠ¡å™¨çŠ¶æ€æµ‹è¯•</title>
              <style>
                  body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
                  .status { margin: 10px 0; }
                  .ok { color: #0f0; }
                  .error { color: #f00; }
              </style>
          </head>
          <body>
              <h1>ğŸ”§ æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥</h1>
              <div class="status ok">âœ“ Nginx è¿è¡Œæ­£å¸¸</div>
              <div class="status ok">âœ“ é…ç½®æ–‡ä»¶æœ‰æ•ˆ</div>
              <div class="status ok">âœ“ æƒé™è®¾ç½®æ­£ç¡®</div>
              <div class="status ok">âœ“ ä¸»é¡µåŠ è½½æˆåŠŸ</div>
              <p>å½“å‰æ—¶é—´: {{ ansible_date_time.iso8601 }}</p>
              <p>æœåŠ¡å™¨: {{ inventory_hostname }}</p>
          </body>
          </html>
        dest: "{{ document_root }}/test.html"
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0644'
        
    - name: "å¯åŠ¨å¹¶å¯ç”¨ Nginx æœåŠ¡"
      service:
        name: nginx
        state: started
        enabled: yes
        
    - name: "æ£€æŸ¥ Nginx æœåŠ¡çŠ¶æ€"
      command: systemctl is-active nginx
      register: nginx_status
      changed_when: false
      
    - name: "æ˜¾ç¤ºæœåŠ¡çŠ¶æ€"
      debug:
        msg: "Nginx æœåŠ¡çŠ¶æ€: {{ nginx_status.stdout }}"
        
    - name: "æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€"
      command: netstat -tlnp | grep :{{ app_port }}
      register: port_status
      changed_when: false
      ignore_errors: yes
      
    - name: "æ˜¾ç¤ºç«¯å£çŠ¶æ€"
      debug:
        msg: "ç«¯å£ {{ app_port }} ç›‘å¬çŠ¶æ€: {{ port_status.stdout_lines | default(['ç«¯å£æœªå¼€æ”¾']) }}"
        
    - name: "æµ‹è¯• Web æœåŠ¡å™¨å“åº”"
      uri:
        url: "http://localhost:{{ app_port }}"
        method: GET
        status_code: 200
      register: web_test
      ignore_errors: yes
      
    - name: "æ˜¾ç¤º Web æµ‹è¯•ç»“æœ"
      debug:
        msg: |
          Web æœåŠ¡å™¨æµ‹è¯•ç»“æœ:
          çŠ¶æ€ç : {{ web_test.status | default('è¿æ¥å¤±è´¥') }}
          å“åº”æ—¶é—´: {{ web_test.elapsed | default('N/A') }}ç§’
          å†…å®¹é•¿åº¦: {{ web_test.content_length | default('N/A') }}å­—èŠ‚
          
  handlers:
    - name: reload nginx
      service:
        name: nginx
        state: reloaded 