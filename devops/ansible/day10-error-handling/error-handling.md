# Day 10: é”™è¯¯å¤„ç†ä¸Žè°ƒè¯•

åœ¨Ansibleè‡ªåŠ¨åŒ–è¿‡ç¨‹ä¸­ï¼Œé”™è¯¯å¤„ç†å’Œè°ƒè¯•æ˜¯ç¡®ä¿ç¨³å®šæ€§å’Œå¯é æ€§çš„å…³é”®æŠ€èƒ½ã€‚ä»Šå¤©æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ å¦‚ä½•æœ‰æ•ˆåœ°å¤„ç†é”™è¯¯ã€è°ƒè¯•é—®é¢˜ä»¥åŠå»ºç«‹å¥å£®çš„é”™è¯¯æ¢å¤æœºåˆ¶ã€‚

## ðŸŽ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ—¥å­¦ä¹ åŽï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

1. ç†è§£Ansibleé”™è¯¯å¤„ç†æœºåˆ¶
2. å®žçŽ°æœ‰æ•ˆçš„é”™è¯¯æ•èŽ·å’Œå¤„ç†ç­–ç•¥
3. ä½¿ç”¨è°ƒè¯•æŠ€æœ¯å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜
4. å»ºç«‹è‡ªåŠ¨åŒ–çš„é”™è¯¯æ¢å¤æœºåˆ¶
5. å®žæ–½æ—¥å¿—è®°å½•å’Œç›‘æŽ§ç­–ç•¥

## ðŸ“š ç†è®ºçŸ¥è¯†

### é”™è¯¯å¤„ç†åŸºç¡€

Ansibleåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å¤šç§ç±»åž‹çš„é”™è¯¯ï¼š

1. **è¿žæŽ¥é”™è¯¯**: ä¸»æœºæ— æ³•è®¿é—®æˆ–è®¤è¯å¤±è´¥
2. **æ¨¡å—é”™è¯¯**: æ¨¡å—æ‰§è¡Œå¤±è´¥æˆ–å‚æ•°é”™è¯¯
3. **è¯­æ³•é”™è¯¯**: Playbookæˆ–æ¨¡æ¿è¯­æ³•ä¸æ­£ç¡®
4. **æƒé™é”™è¯¯**: ç¼ºå°‘å¿…è¦çš„æ‰§è¡Œæƒé™
5. **ä¾èµ–é”™è¯¯**: ç¼ºå°‘å¿…è¦çš„è½¯ä»¶åŒ…æˆ–æœåŠ¡

### é”™è¯¯å¤„ç†ç­–ç•¥

Ansibleæä¾›äº†å¤šç§é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

1. **ignore_errors**: å¿½ç•¥ä»»åŠ¡æ‰§è¡Œé”™è¯¯
2. **failed_when**: è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶
3. **block/rescue/always**: ç»“æž„åŒ–é”™è¯¯å¤„ç†
4. **any_errors_fatal**: ä»»ä¸€é”™è¯¯å¯¼è‡´æ•´ä¸ªPlayåœæ­¢

## ðŸ”§ å®žè·µç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€é”™è¯¯å¤„ç†

```yaml
---
- name: åŸºç¡€é”™è¯¯å¤„ç†ç¤ºä¾‹
  hosts: all
  tasks:
    - name: å°è¯•å®‰è£…å¯èƒ½ä¸å­˜åœ¨çš„è½¯ä»¶åŒ…
      apt:
        name: nonexistent-package
        state: present
      ignore_errors: yes
      
    - name: æ£€æŸ¥ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æžœ
      debug:
        msg: "å®‰è£…ä»»åŠ¡{{ 'æˆåŠŸ' if not ansible_failed_result else 'å¤±è´¥' }}"
```

### è¯­æ³•è§£æž

**ignore_errors å‚æ•°**ï¼š
- **ä½œç”¨**ï¼šå¿½ç•¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œç»§ç»­æ‰§è¡ŒåŽç»­ä»»åŠ¡
- **é”™è¯¯çŠ¶æ€**ï¼šå³ä½¿ä»»åŠ¡å¤±è´¥ï¼ŒPlaybookä¹Ÿä¸ä¼šåœæ­¢æ‰§è¡Œ
- **ç»“æžœæ£€æŸ¥**ï¼šå¯ä»¥é€šè¿‡æ³¨å†Œå˜é‡æ£€æŸ¥ä»»åŠ¡çš„å®žé™…æ‰§è¡Œç»“æžœ
- **é€‚ç”¨åœºæ™¯**ï¼šéžå…³é”®ä»»åŠ¡ã€é¢„æœŸå¯èƒ½å¤±è´¥çš„æ“ä½œ

**é”™è¯¯å¤„ç†æµç¨‹**ï¼š
1. **ä»»åŠ¡æ‰§è¡Œ**ï¼šAnsibleæ‰§è¡Œå¯èƒ½å¤±è´¥çš„ä»»åŠ¡
2. **é”™è¯¯æ£€æµ‹**ï¼šæ£€æµ‹åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥
3. **é”™è¯¯å¿½ç•¥**ï¼šç”±äºŽè®¾ç½®äº†ignore_errorsï¼Œé”™è¯¯è¢«å¿½ç•¥
4. **ç»§ç»­æ‰§è¡Œ**ï¼šPlaybookç»§ç»­æ‰§è¡ŒåŽç»­ä»»åŠ¡
5. **ç»“æžœåˆ†æž**ï¼šé€šè¿‡æ³¨å†Œå˜é‡åˆ†æžä»»åŠ¡çš„å®žé™…ç»“æžœ

**æ³¨å†Œå˜é‡æœºåˆ¶**ï¼š
- **å˜é‡æ³¨å†Œ**ï¼šä½¿ç”¨registerå…³é”®å­—å°†ä»»åŠ¡ç»“æžœä¿å­˜åˆ°å˜é‡
- **ç»“æžœåˆ†æž**ï¼šé€šè¿‡å˜é‡å±žæ€§åˆ¤æ–­ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
- **æ¡ä»¶åˆ¤æ–­**ï¼šç»“åˆwhenæ¡ä»¶è¿›è¡ŒåŽç»­å¤„ç†å†³ç­–

### åº”ç”¨åœºæ™¯

**éžå…³é”®æ“ä½œå¤„ç†**ï¼š
- è½¯ä»¶åŒ…å®‰è£…çš„å¯é€‰ä¾èµ–é¡¹
- æ–‡ä»¶æ¸…ç†å’Œä¸´æ—¶æ–‡ä»¶åˆ é™¤
- æœåŠ¡çŠ¶æ€æ£€æŸ¥å’Œä¿¡æ¯æ”¶é›†

**é¢„æœŸå¤±è´¥åœºæ™¯**ï¼š
- æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å­˜åœ¨
- éªŒè¯é…ç½®æ–‡ä»¶çš„å…¼å®¹æ€§
- æµ‹è¯•ç½‘ç»œè¿žæŽ¥å¯ç”¨æ€§

**æ¸è¿›å¼éƒ¨ç½²**ï¼š
- å°è¯•æ–°åŠŸèƒ½éƒ¨ç½²ï¼Œå¤±è´¥æ—¶å›žé€€
- æ¡ä»¶æ€§å¯ç”¨é«˜çº§ç‰¹æ€§
- å¤šç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•

### ç¤ºä¾‹2: è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶

```yaml
---
- name: è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶ç¤ºä¾‹
  hosts: all
  tasks:
    - name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
      command: systemctl is-active nginx
      register: service_status
      failed_when: false
      
    - name: æ ¹æ®è‡ªå®šä¹‰æ¡ä»¶å¤±è´¥
      debug:
        msg: "æœåŠ¡æœªè¿è¡Œ"
      failed_when: service_status.stdout != "active"
```

### è¯­æ³•è§£æž

**failed_when å‚æ•°**ï¼š
- **ä½œç”¨**ï¼šå®šä¹‰ä»»åŠ¡å¤±è´¥çš„è‡ªå®šä¹‰æ¡ä»¶ï¼Œæ›¿ä»£é»˜è®¤çš„é”™è¯¯åˆ¤æ–­
- **æ¡ä»¶è¡¨è¾¾å¼**ï¼šæ”¯æŒå¤æ‚çš„Jinja2è¡¨è¾¾å¼è¿›è¡Œæ¡ä»¶åˆ¤æ–­
- **é»˜è®¤è¡Œä¸º**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å—è¿”å›žéžé›¶é€€å‡ºç æ—¶ä»»åŠ¡å¤±è´¥
- **çµæ´»æŽ§åˆ¶**ï¼šå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶

**è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶æœºåˆ¶**ï¼š
1. **ä»»åŠ¡æ‰§è¡Œ**ï¼šæ‰§è¡ŒåŸºç¡€ä»»åŠ¡å¹¶æ”¶é›†ç»“æžœ
2. **æ¡ä»¶è¯„ä¼°**ï¼šæ ¹æ®failed_whenè¡¨è¾¾å¼è¯„ä¼°ä»»åŠ¡çŠ¶æ€
3. **çŠ¶æ€ç¡®å®š**ï¼šå¦‚æžœæ¡ä»¶ä¸ºçœŸï¼Œæ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥
4. **æµç¨‹æŽ§åˆ¶**ï¼šæ ¹æ®ä»»åŠ¡çŠ¶æ€å†³å®šåŽç»­æ‰§è¡Œæµç¨‹

**æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•**ï¼š
- **æ¯”è¾ƒæ“ä½œ**ï¼š`==`, `!=`, `>`, `<`, `>=`, `<=`
- **é€»è¾‘æ“ä½œ**ï¼š`and`, `or`, `not`
- **å­—ç¬¦ä¸²æ“ä½œ**ï¼š`in`, `not in`, `contains`
- **ç±»åž‹æ£€æŸ¥**ï¼š`is defined`, `is not defined`

### åº”ç”¨åœºæ™¯

**ä¸šåŠ¡é€»è¾‘éªŒè¯**ï¼š
- éªŒè¯æœåŠ¡çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸ
- æ£€æŸ¥é…ç½®æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®
- ç¡®è®¤èµ„æºä½¿ç”¨çŽ‡æ˜¯å¦åœ¨åˆç†èŒƒå›´

**å¤æ‚æ¡ä»¶åˆ¤æ–­**ï¼š
- å¤šæ¡ä»¶ç»„åˆçš„å¤±è´¥åˆ¤æ–­
- åŸºäºŽå¤–éƒ¨APIå“åº”çš„çŠ¶æ€åˆ¤æ–­
- ä¾èµ–å¤šä¸ªä»»åŠ¡ç»“æžœçš„ç»¼åˆåˆ¤æ–­

**é¢„æœŸçŠ¶æ€æ£€æŸ¥**ï¼š
- ç¡®ä¿éƒ¨ç½²åŽçš„æœåŠ¡æ­£å¸¸è¿è¡Œ
- éªŒè¯é…ç½®æ›´æ”¹çš„ç”Ÿæ•ˆæƒ…å†µ
- æ£€æŸ¥ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨æƒ…å†µ

### ç¤ºä¾‹3: ç»“æž„åŒ–é”™è¯¯å¤„ç†

```yaml
---
- name: ç»“æž„åŒ–é”™è¯¯å¤„ç†ç¤ºä¾‹
  hosts: all
  tasks:
    - name: ä½¿ç”¨block/rescueå¤„ç†é”™è¯¯
      block:
        - name: æ‰§è¡Œå¯èƒ½å¤±è´¥çš„ä»»åŠ¡
          command: /bin/false
          
      rescue:
        - name: é”™è¯¯å¤„ç†ä»»åŠ¡
          debug:
            msg: "æ£€æµ‹åˆ°é”™è¯¯ï¼Œæ­£åœ¨æ‰§è¡Œæ¢å¤æ“ä½œ"
            
        - name: è®°å½•é”™è¯¯ä¿¡æ¯
          copy:
            content: "é”™è¯¯å‘ç”Ÿåœ¨{{ ansible_date_time.iso8601 }}"
            dest: /tmp/error.log
            
      always:
        - name: æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œ
          debug:
            msg: "æ¸…ç†æ“ä½œå·²å®Œæˆ"
```

### è¯­æ³•è§£æž

**block/rescue/always ç»“æž„**ï¼š
- **blockå—**ï¼šåŒ…å«å¯èƒ½å¤±è´¥çš„ä¸»è¦ä»»åŠ¡é›†åˆ
- **rescueå—**ï¼šå½“blockä¸­ä»»ä½•ä»»åŠ¡å¤±è´¥æ—¶æ‰§è¡Œçš„é”™è¯¯å¤„ç†ä»»åŠ¡
- **alwayså—**ï¼šæ— è®ºblockæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„æ¸…ç†ä»»åŠ¡
- **ç»“æž„åŒ–å¤„ç†**ï¼šæä¾›ç±»ä¼¼try-catch-finallyçš„é”™è¯¯å¤„ç†æœºåˆ¶

**é”™è¯¯å¤„ç†æ‰§è¡Œæµç¨‹**ï¼š
1. **blockæ‰§è¡Œ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œblockä¸­çš„æ‰€æœ‰ä»»åŠ¡
2. **é”™è¯¯æ£€æµ‹**ï¼šå¦‚æžœblockä¸­ä»»ä½•ä»»åŠ¡å¤±è´¥ï¼Œç«‹å³åœæ­¢blockæ‰§è¡Œ
3. **rescueæ‰§è¡Œ**ï¼šè·³è½¬åˆ°rescueå—æ‰§è¡Œé”™è¯¯å¤„ç†ä»»åŠ¡
4. **alwaysæ‰§è¡Œ**ï¼šæ— è®ºblockæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä¼šæ‰§è¡Œalwayså—
5. **æµç¨‹ç»§ç»­**ï¼šé”™è¯¯å¤„ç†åŽï¼ŒPlaybookç»§ç»­æ‰§è¡ŒåŽç»­ä»»åŠ¡

**ç»“æž„åŒ–é”™è¯¯å¤„ç†ä¼˜åŠ¿**ï¼š
- **ä»£ç æ¸…æ™°**ï¼šé”™è¯¯å¤„ç†é€»è¾‘ä¸Žä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- **èµ„æºç®¡ç†**ï¼šç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾å’Œæ¸…ç†
- **é”™è¯¯éš”ç¦»**ï¼šå±€éƒ¨é”™è¯¯ä¸ä¼šå½±å“æ•´ä½“æ‰§è¡Œæµç¨‹
- **æ¢å¤æœºåˆ¶**ï¼šæä¾›æ ‡å‡†åŒ–çš„é”™è¯¯æ¢å¤è·¯å¾„

### åº”ç”¨åœºæ™¯

**å…³é”®æ“ä½œä¿æŠ¤**ï¼š
- æ•°æ®åº“äº‹åŠ¡æ“ä½œ
- é…ç½®æ–‡ä»¶æ›´æ–°å’Œå›žæ»š
- æœåŠ¡éƒ¨ç½²å’Œå‡çº§æ“ä½œ

**èµ„æºç®¡ç†åœºæ™¯**ï¼š
- æ–‡ä»¶é”å’Œä¸´æ—¶æ–‡ä»¶æ¸…ç†
- ç½‘ç»œè¿žæŽ¥å’Œä¼šè¯ç®¡ç†
- ç³»ç»Ÿèµ„æºåˆ†é…å’Œé‡Šæ”¾

**å¤æ‚ä¸šåŠ¡æµç¨‹**ï¼š
- å¤šæ­¥éª¤éƒ¨ç½²æµç¨‹
- ä¾èµ–å…³ç³»å¤æ‚çš„é…ç½®ç®¡ç†
- éœ€è¦å›žæ»šæœºåˆ¶çš„æ“ä½œ

## ðŸž è°ƒè¯•æŠ€æœ¯

### è¯¦ç»†è¾“å‡ºæ¨¡å¼

ä½¿ç”¨`-v`å‚æ•°èŽ·å–æ›´è¯¦ç»†çš„è¾“å‡ºä¿¡æ¯ï¼š

```bash
# åŸºæœ¬è¯¦ç»†è¾“å‡º
ansible-playbook playbook.yml -v

# æ›´è¯¦ç»†çš„è¾“å‡º
ansible-playbook playbook.yml -vv

# æœ€è¯¦ç»†çš„è¾“å‡º
ansible-playbook playbook.yml -vvv

# è¿žæŽ¥è°ƒè¯•ä¿¡æ¯
ansible-playbook playbook.yml -vvvv
```

### è¯­æ³•è§£æž

**è¯¦ç»†çº§åˆ«å‚æ•°**ï¼š
- **-v**ï¼šåŸºæœ¬è¯¦ç»†æ¨¡å¼ï¼Œæ˜¾ç¤ºä»»åŠ¡æ‰§è¡Œç»“æžœå’Œå˜æ›´ä¿¡æ¯
- **-vv**ï¼šä¸­ç­‰è¯¦ç»†æ¨¡å¼ï¼Œå¢žåŠ å˜é‡å€¼å’Œä»»åŠ¡å‚æ•°æ˜¾ç¤º
- **-vvv**ï¼šé«˜çº§è¯¦ç»†æ¨¡å¼ï¼Œæ˜¾ç¤ºæ¨¡å—æ‰§è¡Œç»†èŠ‚å’Œå†…éƒ¨çŠ¶æ€
- **-vvvv**ï¼šè¿žæŽ¥è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºSSHè¿žæŽ¥å’Œç½‘ç»œé€šä¿¡ç»†èŠ‚

**è°ƒè¯•ä¿¡æ¯åˆ†ç±»**ï¼š
- **ä»»åŠ¡æ‰§è¡Œä¿¡æ¯**ï¼šä»»åŠ¡å¼€å§‹/ç»“æŸæ—¶é—´ã€æ‰§è¡ŒçŠ¶æ€ã€å˜æ›´è¯¦æƒ…
- **å˜é‡å’Œå‚æ•°**ï¼šä»»åŠ¡ä½¿ç”¨çš„å˜é‡å€¼ã€æ¨¡å—å‚æ•°è®¾ç½®
- **æ¨¡å—å†…éƒ¨çŠ¶æ€**ï¼šæ¨¡å—æ‰§è¡Œè¿‡ç¨‹ã€ä¸­é—´ç»“æžœã€é”™è¯¯ä¿¡æ¯
- **è¿žæŽ¥è°ƒè¯•ä¿¡æ¯**ï¼šSSHè¿žæŽ¥å»ºç«‹ã€è®¤è¯è¿‡ç¨‹ã€ç½‘ç»œé€šä¿¡

**è°ƒè¯•è¾“å‡ºä¼˜åŒ–**ï¼š
- **é€‰æ‹©æ€§è°ƒè¯•**ï¼šæ ¹æ®é—®é¢˜ç±»åž‹é€‰æ‹©åˆé€‚çš„è¯¦ç»†çº§åˆ«
- **æ—¥å¿—è®°å½•**ï¼šå°†è¯¦ç»†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶è¿›è¡Œåˆ†æž
- **æ€§èƒ½è€ƒè™‘**ï¼šé«˜è¯¦ç»†çº§åˆ«ä¼šå¢žåŠ æ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—

### åº”ç”¨åœºæ™¯

**é—®é¢˜å®šä½å’ŒæŽ’æŸ¥**ï¼š
- ä»»åŠ¡æ‰§è¡Œå¤±è´¥çš„åŽŸå› åˆ†æž
- å˜é‡å€¼ä¸æ­£ç¡®çš„é—®é¢˜æŽ’æŸ¥
- æ¨¡å—å‚æ•°é…ç½®é”™è¯¯çš„è°ƒè¯•

**æ€§èƒ½ä¼˜åŒ–åˆ†æž**ï¼š
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´åˆ†æž
- ç½‘ç»œè¿žæŽ¥æ€§èƒ½ä¼˜åŒ–
- èµ„æºä½¿ç”¨æƒ…å†µç›‘æŽ§

**å¼€å‘å’Œæµ‹è¯•**ï¼š
- æ–°æ¨¡å—å’ŒPlaybookçš„è°ƒè¯•
- å¤æ‚é€»è¾‘çš„éªŒè¯å’Œæµ‹è¯•
- è‡ªåŠ¨åŒ–æµ‹è¯•çš„è¯¦ç»†è¾“å‡º

### ä½¿ç”¨debugæ¨¡å—

```yaml
---
- name: è°ƒè¯•ä¿¡æ¯ç¤ºä¾‹
  hosts: all
  vars:
    my_var: "Hello World"
  tasks:
    - name: æ˜¾ç¤ºå˜é‡å€¼
      debug:
        var: my_var
        
    - name: æ˜¾ç¤ºè¡¨è¾¾å¼ç»“æžœ
      debug:
        msg: "ä¸»æœºåæ˜¯ {{ ansible_hostname }}"
        
    - name: æ˜¾ç¤ºæ‰€æœ‰facts
      debug:
        var: ansible_facts
```

### è¯­æ³•è§£æž

**debugæ¨¡å—åŠŸèƒ½**ï¼š
- **å˜é‡æ˜¾ç¤º**ï¼šä½¿ç”¨`var`å‚æ•°æ˜¾ç¤ºæŒ‡å®šå˜é‡çš„å€¼
- **æ¶ˆæ¯è¾“å‡º**ï¼šä½¿ç”¨`msg`å‚æ•°è¾“å‡ºè‡ªå®šä¹‰æ¶ˆæ¯å’Œè¡¨è¾¾å¼ç»“æžœ
- **äº‹å®žæ”¶é›†**ï¼šæ˜¾ç¤ºç³»ç»Ÿfactså’Œè‡ªå®šä¹‰å˜é‡ä¿¡æ¯
- **æ¡ä»¶è¾“å‡º**ï¼šç»“åˆ`when`æ¡ä»¶è¿›è¡Œæ¡ä»¶æ€§è°ƒè¯•è¾“å‡º

**è°ƒè¯•è¾“å‡ºæ ¼å¼**ï¼š
- **å˜é‡æ˜¾ç¤ºæ ¼å¼**ï¼š`var: variable_name` æ˜¾ç¤ºå˜é‡çš„å®Œæ•´ç»“æž„
- **æ¶ˆæ¯è¾“å‡ºæ ¼å¼**ï¼š`msg: "message {{ expression }}"` æ”¯æŒJinja2è¡¨è¾¾å¼
- **å¤šè¡Œè¾“å‡º**ï¼šæ”¯æŒå¤šè¡Œæ¶ˆæ¯å’Œå¤æ‚æ•°æ®ç»“æž„çš„æ ¼å¼åŒ–æ˜¾ç¤º
- **é¢œè‰²ç¼–ç **ï¼šåœ¨æ”¯æŒé¢œè‰²çš„ç»ˆç«¯ä¸­ï¼Œé”™è¯¯å’Œè­¦å‘Šä¿¡æ¯ä¼šæœ‰é¢œè‰²æ ‡è¯†

**è°ƒè¯•æœ€ä½³å®žè·µ**ï¼š
- **ç²¾ç¡®è°ƒè¯•**ï¼šåªåœ¨éœ€è¦æ—¶æ·»åŠ debugä»»åŠ¡ï¼Œé¿å…è¿‡å¤šè¾“å‡º
- **æ¡ä»¶è°ƒè¯•**ï¼šä½¿ç”¨whenæ¡ä»¶é™åˆ¶è°ƒè¯•è¾“å‡ºçš„èŒƒå›´
- **æ•æ„Ÿä¿¡æ¯**ï¼šé¿å…åœ¨è°ƒè¯•è¾“å‡ºä¸­æ˜¾ç¤ºå¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
- **æ€§èƒ½è€ƒè™‘**ï¼šè°ƒè¯•ä»»åŠ¡ä¼šå¢žåŠ æ‰§è¡Œæ—¶é—´ï¼Œç”Ÿäº§çŽ¯å¢ƒåº”å‡å°‘ä½¿ç”¨

### åº”ç”¨åœºæ™¯

**å˜é‡å€¼éªŒè¯**ï¼š
- éªŒè¯æ¨¡æ¿å˜é‡æ˜¯å¦æ­£ç¡®ä¼ é€’
- æ£€æŸ¥æ¡ä»¶è¡¨è¾¾å¼çš„ç»“æžœ
- ç¡®è®¤å¾ªçŽ¯å˜é‡çš„å€¼

**æµç¨‹è°ƒè¯•**ï¼š
- è·Ÿè¸ªPlaybookæ‰§è¡Œæµç¨‹
- éªŒè¯ä»»åŠ¡æ‰§è¡Œé¡ºåº
- æ£€æŸ¥æ¡ä»¶åˆ†æ”¯çš„æ‰§è¡Œæƒ…å†µ

**é—®é¢˜è¯Šæ–­**ï¼š
- åˆ†æžä»»åŠ¡å¤±è´¥çš„åŽŸå› 
- æ£€æŸ¥æ¨¡å—å‚æ•°è®¾ç½®
- éªŒè¯å¤–éƒ¨å‘½ä»¤çš„æ‰§è¡Œç»“æžœ

### æ¡ä»¶è°ƒè¯•

```yaml
---
- name: æ¡ä»¶è°ƒè¯•ç¤ºä¾‹
  hosts: all
  tasks:
    - name: ä»…åœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
      debug:
        msg: "è¿™æ˜¯è°ƒè¯•ä¿¡æ¯"
      when: ansible_os_family == "Debian"
      
    - name: æ³¨å†Œä»»åŠ¡ç»“æžœ
      command: uptime
      register: uptime_result
      
    - name: æ˜¾ç¤ºä»»åŠ¡ç»“æžœ
      debug:
        var: uptime_result
      when: uptime_result is succeeded
```

## ðŸ›¡ï¸ é”™è¯¯æ¢å¤æœºåˆ¶

### è‡ªåŠ¨é‡è¯•

```yaml
---
- name: è‡ªåŠ¨é‡è¯•ç¤ºä¾‹
  hosts: all
  tasks:
    - name: å¯èƒ½å¤±è´¥çš„ä»»åŠ¡
      uri:
        url: https://api.example.com/status
        timeout: 5
      register: api_result
      until: api_result.status == 200
      retries: 3
      delay: 10
```

### å›žæ»šæœºåˆ¶

```yaml
---
- name: å›žæ»šæœºåˆ¶ç¤ºä¾‹
  hosts: all
  vars:
    backup_dir: "/tmp/backup"
  tasks:
    - name: åˆ›å»ºå¤‡ä»½ç›®å½•
      file:
        path: "{{ backup_dir }}"
        state: directory
        
    - name: å¤‡ä»½é…ç½®æ–‡ä»¶
      copy:
        src: /etc/nginx/nginx.conf
        dest: "{{ backup_dir }}/nginx.conf.backup"
        remote_src: yes
        
    - name: å°è¯•æ›´æ–°é…ç½®
      block:
        - name: æ›´æ–°é…ç½®æ–‡ä»¶
          template:
            src: nginx.conf.j2
            dest: /etc/nginx/nginx.conf
            
        - name: é‡æ–°åŠ è½½æœåŠ¡
          service:
            name: nginx
            state: reloaded
            
      rescue:
        - name: å›žæ»šé…ç½®æ–‡ä»¶
          copy:
            src: "{{ backup_dir }}/nginx.conf.backup"
            dest: /etc/nginx/nginx.conf
            remote_src: yes
            
        - name: é‡å¯æœåŠ¡
          service:
            name: nginx
            state: restarted
            
        - name: å‘é€é€šçŸ¥
          debug:
            msg: "é…ç½®æ›´æ–°å¤±è´¥ï¼Œå·²å›žæ»šåˆ°åŽŸå§‹é…ç½®"
```

## ðŸ“Š æ—¥å¿—è®°å½•

### é…ç½®æ—¥å¿—è®°å½•

åœ¨ansible.cfgä¸­é…ç½®æ—¥å¿—ï¼š

```ini
[defaults]
log_path = /var/log/ansible.log
```

### è‡ªå®šä¹‰æ—¥å¿—è®°å½•

```yaml
---
- name: è‡ªå®šä¹‰æ—¥å¿—è®°å½•ç¤ºä¾‹
  hosts: all
  tasks:
    - name: è®°å½•ä»»åŠ¡å¼€å§‹
      lineinfile:
        path: /var/log/ansible-tasks.log
        line: "{{ ansible_date_time.iso8601 }} - å¼€å§‹æ‰§è¡Œä»»åŠ¡: {{ ansible_play_name }}"
        create: yes
        
    - name: æ‰§è¡Œä»»åŠ¡
      command: echo "æ‰§è¡Œé‡è¦ä»»åŠ¡"
      
    - name: è®°å½•ä»»åŠ¡ç»“æŸ
      lineinfile:
        path: /var/log/ansible-tasks.log
        line: "{{ ansible_date_time.iso8601 }} - ä»»åŠ¡å®Œæˆ: {{ ansible_play_name }}"
```

## ðŸ§ª æµ‹è¯•å’ŒéªŒè¯

### å•å…ƒæµ‹è¯•

```yaml
---
- name: é”™è¯¯å¤„ç†æµ‹è¯•
  hosts: localhost
  tasks:
    - name: æµ‹è¯•å¿½ç•¥é”™è¯¯
      command: /bin/false
      ignore_errors: yes
      register: result
      
    - name: éªŒè¯é”™è¯¯è¢«å¿½ç•¥
      assert:
        that:
          - result is failed
        success_msg: "é”™è¯¯å¤„ç†æŒ‰é¢„æœŸå·¥ä½œ"
        fail_msg: "é”™è¯¯å¤„ç†æœªæŒ‰é¢„æœŸå·¥ä½œ"
```

## ðŸŽ¯ æœ€ä½³å®žè·µ

### 1. æ˜Žç¡®çš„é”™è¯¯å¤„ç†ç­–ç•¥

```yaml
---
- name: æ˜Žç¡®çš„é”™è¯¯å¤„ç†ç­–ç•¥
  hosts: all
  tasks:
    - name: å…³é”®ä»»åŠ¡
      block:
        - name: æ‰§è¡Œå…³é”®æ“ä½œ
          # å…³é”®æ“ä½œ
          
      rescue:
        - name: è®°å½•é”™è¯¯
          # é”™è¯¯è®°å½•
          
        - name: å‘é€å‘Šè­¦
          # å‘Šè­¦é€šçŸ¥
          
        - name: æ‰§è¡Œæ¢å¤
          # æ¢å¤æ“ä½œ
          
      always:
        - name: æ¸…ç†èµ„æº
          # èµ„æºæ¸…ç†
```

### 2. é€‚å½“çš„è¯¦ç»†çº§åˆ«

```yaml
---
- name: é€‚å½“è¯¦ç»†çº§åˆ«çš„ç¤ºä¾‹
  hosts: all
  tasks:
    - name: å®‰é™çš„ä»»åŠ¡
      command: echo "å®‰é™æ‰§è¡Œ"
      no_log: true  # æ•æ„Ÿä¿¡æ¯ä¸è®°å½•æ—¥å¿—
      
    - name: è¯¦ç»†çš„ä»»åŠ¡
      debug:
        msg: "æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
```

### 3. ç»“æž„åŒ–çš„Playbookç»„ç»‡

```yaml
---
- name: ç»“æž„åŒ–çš„é”™è¯¯å¤„ç†
  hosts: all
  handlers:
    - name: é‡å¯æœåŠ¡
      service:
        name: nginx
        state: restarted
        
  pre_tasks:
    - name: éªŒè¯å‰ææ¡ä»¶
      # å‰ææ¡ä»¶æ£€æŸ¥
      
  tasks:
    - name: ä¸»è¦ä»»åŠ¡
      # ä¸»è¦æ“ä½œ
      
  post_tasks:
    - name: éªŒè¯ç»“æžœ
      # ç»“æžœéªŒè¯
```

## ðŸ“‹ æ€»ç»“

ä»Šå¤©çš„é‡ç‚¹å†…å®¹åŒ…æ‹¬ï¼š

1. **é”™è¯¯å¤„ç†æœºåˆ¶**: å­¦ä¼šä½¿ç”¨ignore_errorsã€failed_whenã€block/rescue/alwaysç­‰æœºåˆ¶
2. **è°ƒè¯•æŠ€æœ¯**: æŽŒæ¡ä¸åŒçº§åˆ«çš„è°ƒè¯•è¾“å‡ºå’Œdebugæ¨¡å—çš„ä½¿ç”¨
3. **æ¢å¤æœºåˆ¶**: å®žçŽ°è‡ªåŠ¨é‡è¯•ã€å›žæ»šç­‰é”™è¯¯æ¢å¤ç­–ç•¥
4. **æ—¥å¿—è®°å½•**: å»ºç«‹å®Œå–„çš„æ—¥å¿—è®°å½•å’Œç›‘æŽ§ä½“ç³»
5. **æœ€ä½³å®žè·µ**: éµå¾ªé”™è¯¯å¤„ç†çš„æœ€ä½³å®žè·µåŽŸåˆ™

é€šè¿‡ä»Šå¤©çš„å­¦ä¹ ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨Ansibleè‡ªåŠ¨åŒ–ä¸­å®žçŽ°å¥å£®çš„é”™è¯¯å¤„ç†å’Œé«˜æ•ˆçš„è°ƒè¯•èƒ½åŠ›ï¼Œç¡®ä¿è‡ªåŠ¨åŒ–ä»»åŠ¡çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

## ðŸš€ ä¸‹ä¸€æ­¥

åœ¨ä¸‹ä¸€å¤©çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å°†æŽ¢è®¨æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå­¦ä¹ å¦‚ä½•æé«˜Ansibleæ‰§è¡Œæ•ˆçŽ‡å’Œèµ„æºåˆ©ç”¨çŽ‡ã€‚