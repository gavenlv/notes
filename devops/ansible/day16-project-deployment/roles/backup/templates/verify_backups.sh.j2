#!/bin/bash
# 备份验证脚本

# 设置环境变量
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LANG=en_US.UTF-8

# 备份配置
BACKUP_DIR="{{ backup_local_path }}"
LOG_FILE="{{ backup_log_dir }}/verify_backups.log"
NOTIFICATION_SCRIPT="{{ backup_script_dir }}/backup_notification.sh"

# 日志函数
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

# 发送通知函数
send_notification() {
    if [ -f "${NOTIFICATION_SCRIPT}" ]; then
        ${NOTIFICATION_SCRIPT} "$1" "$2"
    fi
}

# 开始验证
log_message "开始验证备份文件完整性"

# 验证MySQL备份
MYSQL_BACKUP_COUNT=$(find ${BACKUP_DIR}/mysql -name "mysql_*.sql*" -mtime -1 | wc -l)
if [ ${MYSQL_BACKUP_COUNT} -gt 0 ]; then
    log_message "找到 ${MYSQL_BACKUP_COUNT} 个MySQL备份文件"
    # 这里可以添加更详细的验证逻辑
else
    log_message "警告: 未找到最近的MySQL备份文件"
    send_notification "WARNING" "未找到最近的MySQL备份文件"
fi

# 验证PostgreSQL备份
POSTGRESQL_BACKUP_COUNT=$(find ${BACKUP_DIR}/postgresql -name "postgresql_*.dump*" -mtime -1 | wc -l)
if [ ${POSTGRESQL_BACKUP_COUNT} -gt 0 ]; then
    log_message "找到 ${POSTGRESQL_BACKUP_COUNT} 个PostgreSQL备份文件"
    # 这里可以添加更详细的验证逻辑
else
    log_message "警告: 未找到最近的PostgreSQL备份文件"
    send_notification "WARNING" "未找到最近的PostgreSQL备份文件"
fi

# 验证MongoDB备份
MONGODB_BACKUP_COUNT=$(find ${BACKUP_DIR}/mongodb -name "mongodb_*.tar.*" -mtime -1 | wc -l)
if [ ${MONGODB_BACKUP_COUNT} -gt 0 ]; then
    log_message "找到 ${MONGODB_BACKUP_COUNT} 个MongoDB备份文件"
    # 这里可以添加更详细的验证逻辑
else
    log_message "警告: 未找到最近的MongoDB备份文件"
    send_notification "WARNING" "未找到最近的MongoDB备份文件"
fi

# 验证文件备份
FILE_BACKUP_COUNT=$(find ${BACKUP_DIR}/files -name "files_*.tar.*" -o -name "[0-9]*" -type d -mtime -1 | wc -l)
if [ ${FILE_BACKUP_COUNT} -gt 0 ]; then
    log_message "找到 ${FILE_BACKUP_COUNT} 个文件备份"
    # 这里可以添加更详细的验证逻辑
else
    log_message "警告: 未找到最近的文件备份"
    send_notification "WARNING" "未找到最近的文件备份"
fi

log_message "备份验证任务完成"