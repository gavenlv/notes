# 第一章：Skaffold基础概念

## 1.1 Skaffold介绍

### 什么是Skaffold？

Skaffold是一个命令行工具，用于简化Kubernetes应用的开发工作流。它能够：

- **自动化构建和部署**：自动检测代码变更，重新构建镜像并部署到Kubernetes
- **本地开发优化**：提供文件同步、端口转发等开发便利功能
- **多环境支持**：支持开发、测试、生产等多环境部署
- **CI/CD集成**：无缝集成到持续集成/持续部署流水线中

### Skaffold解决的问题

在传统的Kubernetes应用开发中，开发者需要：

1. 编写Dockerfile构建镜像
2. 构建镜像并推送到镜像仓库
3. 更新Kubernetes配置中的镜像标签
4. 使用kubectl apply部署应用
5. 重复以上步骤进行每次代码变更

Skaffold将这些步骤自动化，大大提高了开发效率。

## 1.2 为什么需要Skaffold

### 传统Kubernetes开发的痛点

#### 1. 开发效率低下
每次代码变更都需要手动执行构建、推送、部署流程，浪费大量时间。

#### 2. 环境配置复杂
需要在本地、测试、生产等不同环境中配置不同的参数。

#### 3. 调试困难
Kubernetes应用的调试需要频繁的端口转发和日志查看。

#### 4. CI/CD集成复杂
需要为不同的环境编写复杂的部署脚本。

### Skaffold的优势

#### 1. 开发效率提升
```bash
# 传统方式
$ docker build -t myapp:v1 .
$ docker push myapp:v1
$ kubectl set image deployment/myapp myapp=myapp:v1

# Skaffold方式
$ skaffold dev
```

#### 2. 环境一致性
通过配置文件管理不同环境的参数，确保环境一致性。

#### 3. 便捷的调试功能
内置文件同步、端口转发、日志聚合等功能。

#### 4. 简化的CI/CD集成
单一的skaffold.yaml配置文件可复用于所有环境。

## 1.3 Skaffold核心概念

### 1.3.1 构建（Build）

Skaffold支持多种构建策略：

- **本地Docker构建**：使用本地Docker守护进程构建镜像
- **云构建**：使用Google Cloud Build、Kaniko等云服务构建
- **自定义构建器**：支持Bazel、Jib等自定义构建工具

### 1.3.2 部署（Deploy）

Skaffold支持多种部署方式：

- **kubectl**：直接使用kubectl apply部署
- **Helm**：支持Helm chart部署
- **Kustomize**：支持Kustomize配置管理

### 1.3.3 测试（Test）

Skaffold支持测试阶段：

- **单元测试**：在构建后运行单元测试
- **集成测试**：在部署后运行集成测试
- **自定义测试**：支持自定义测试脚本

### 1.3.4 标签策略（Tagging Policy）

Skaffold支持多种标签策略：

- **Git提交哈希**：使用git提交哈希作为镜像标签
- **日期时间**：使用构建时间戳作为标签
- **环境变量**：使用自定义环境变量
- **自定义策略**：支持自定义标签生成器

## 1.4 安装和配置

### 1.4.1 安装Skaffold

#### Windows安装

```powershell
# 使用Chocolatey安装
choco install skaffold

# 或者下载二进制文件
# 访问 https://github.com/GoogleContainerTools/skaffold/releases
# 下载skaffold-windows-amd64.exe并重命名为skaffold.exe
# 添加到PATH环境变量
```

#### Linux/macOS安装

```bash
# 使用Homebrew安装
brew install skaffold

# 或者使用脚本安装
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
chmod +x skaffold
sudo mv skaffold /usr/local/bin/
```

### 1.4.2 验证安装

```bash
skaffold version
```

输出示例：
```
v2.0.0
```

### 1.4.3 前置依赖检查

确保以下工具已安装：

```bash
# 检查Docker
docker --version

# 检查Kubernetes集群
kubectl version

# 检查Docker守护进程运行状态
docker ps
```

### 1.4.4 初始化Skaffold项目

```bash
# 创建新项目目录
mkdir my-skaffold-project
cd my-skaffold-project

# 初始化Skaffold配置
skaffold init
```

## 1.5 第一个Skaffold项目

### 创建简单的Web应用

#### 1. 创建项目结构

```
my-skaffold-app/
├── app.py
├── Dockerfile
├── k8s/
│   └── deployment.yaml
└── skaffold.yaml
```

#### 2. 创建应用代码（app.py）

```python
from flask import Flask
import os

app = Flask(__name__)

@app.route('/')
def hello():
    version = os.getenv('VERSION', '1.0.0')
    return f'Hello from Skaffold! Version: {version}'

@app.route('/health')
def health():
    return {'status': 'healthy'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
```

#### 3. 创建Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY app.py .

ENV FLASK_APP=app.py
ENV VERSION=1.0.0

EXPOSE 5000

CMD ["python", "app.py"]
```

创建requirements.txt：
```
Flask==2.3.3
```

#### 4. 创建Kubernetes部署文件（k8s/deployment.yaml）

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-app
        image: my-app
        ports:
        - containerPort: 5000
        env:
        - name: VERSION
          value: "1.0.0"
---
apiVersion: v1
kind: Service
metadata:
  name: my-app-service
spec:
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 5000
  type: LoadBalancer
```

#### 5. 创建skaffold.yaml

```yaml
apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: my-skaffold-app

build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile

  tagPolicy:
    gitCommit: {}

deploy:
  kubectl:
    manifests:
    - k8s/deployment.yaml

portForward:
- resourceType: deployment
  resourceName: my-app
  port: 5000
  localPort: 5000
```

### 1.5.1 运行项目

```bash
# 进入项目目录
cd my-skaffold-app

# 启动开发模式
skaffold dev
```

Skaffold将：
1. 构建Docker镜像
2. 部署到Kubernetes
3. 监听文件变更
4. 自动重新构建和部署

### 1.5.2 测试应用

```bash
# 在另一个终端中测试应用
curl http://localhost:5000
```

应该看到输出：
```
Hello from Skaffold! Version: 1.0.0
```

## 1.6 本章总结

本章介绍了Skaffold的基础概念，包括：

- **Skaffold的作用和优势**：简化Kubernetes开发工作流
- **核心概念**：构建、部署、测试、标签策略
- **安装和配置**：在不同操作系统上安装Skaffold
- **第一个项目**：创建并运行一个简单的Skaffold项目

通过本章的学习，您应该能够：

1. 理解Skaffold的基本概念和优势
2. 正确安装和配置Skaffold环境
3. 创建并运行简单的Skaffold项目
4. 理解Skaffold自动化构建和部署的流程

在下一章中，我们将深入探讨Skaffold配置文件的详细结构和配置选项。