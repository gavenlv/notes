# 第9章：附录和最佳实践

## 9.1 Skaffold命令参考

### 9.1.1 核心命令

**常用命令概览：**
```bash
# 开发模式（文件变更时自动重建和部署）
skaffold dev

# 运行一次性构建和部署
skaffold run

# 仅构建镜像
skaffold build

# 仅部署应用
skaffold deploy

# 渲染最终Kubernetes清单
skaffold render

# 运行测试
skaffold test

# 清理部署的资源
skaffold delete

# 诊断配置问题
skaffold diagnose
```

### 9.1.2 高级命令选项

**配置文件相关：**
```bash
# 指定配置文件
skaffold dev -f custom-skaffold.yaml

# 使用特定profile
skaffold run -p production

# 多个配置文件合并
skaffold dev -f skaffold.yaml -f override.yaml

# 输出构建结果到文件
skaffold build --file-output=build.json

# 使用构建结果文件
skaffold deploy --build-artifacts=build.json
```

**调试和日志选项：**
```bash
# 详细日志输出
skaffold dev -v debug

# 显示时间戳
skaffold dev --timestamps=true

# 颜色输出控制
skaffold dev --color=true

# 静默模式
skaffold dev --quiet

# 只渲染不执行
skaffold render --dry-run
```

## 9.2 配置参数详解

### 9.2.1 构建配置参数

**完整构建配置示例：**
```yaml
build:
  # 构建策略
  local:
    push: false
    useDockerCLI: true
    useBuildkit: true
    concurrency: 3
  
  # 集群内构建
  cluster:
    pullSecretName: kaniko-secret
    namespace: default
    dockerConfig:
      secretName: docker-config
    timeout: 20m
  
  # Google Cloud Build
  googleCloudBuild:
    projectId: my-project
    diskSizeGb: 100
    machineType: N1_HIGHCPU_8
    timeout: 3600s
  
  # 构建缓存配置
  cache:
    useCache: true
    cacheFrom:
      - gcr.io/k8s-skaffold/skaffold-cache:v1.0.0
    cacheTo:
      - type: registry
        params:
          mode: max
  
  # 标签策略
  tagPolicy:
    gitCommit: {}
    # 或使用自定义标签
    customTemplate:
      template: "{{.DATE}}_{{.TIME}}"
      components:
        - name: DATE
          component: DateTime
        - name: TIME
          component: DateTime
```

### 9.2.2 部署配置参数

**完整部署配置：**
```yaml
deploy:
  # kubectl部署
  kubectl:
    manifests:
      - k8s/*.yaml
      - k8s/overlays/**/*.yaml
    flags:
      global:
        - --server-side=true
        - --validate=true
      apply:
        - --prune=true
        - --prune-whitelist=core/v1/ConfigMap
      delete:
        - --wait=true
    defaultNamespace: my-app
  
  # kustomize部署
  kustomize:
    paths:
      - k8s/overlays/development
      - k8s/overlays/production
    buildArgs:
      - --load-restrictor=LoadRestrictionsNone
      - --enable-helm
    flags:
      global:
        - --reorder=legacy
  
  # Helm部署
  helm:
    releases:
      - name: my-app
        chartPath: charts/my-app
        valuesFiles:
          - charts/my-app/values.yaml
        namespace: my-app
        version: 1.0.0
        setValues:
          image.tag: "latest"
        setValueTemplates:
          image.tag: '{{.DIGEST_HEX}}'
        wait: true
        timeout: 5m
        recreatePods: true
        force: false
        skipTests: false
        useHelmSecrets: false
  
  # 多部署策略
  statusCheck:
    enabled: true
    timeout: 5m
  
  # 资源清理
  cleanup:
    enabled: true
    delay: 2s
    clientSide: true
    serverSide: true
```

### 9.2.3 测试配置参数

**完整测试配置：**
```yaml
test:
  # 镜像结构测试
  - image: backend
    structureTests:
      - tests/structure/backend.yaml
    custom:
      - command: "curl -f http://localhost:8080/health"
        timeout: 30s
  
  # 自定义测试
  - image: frontend
    custom:
      - command: "npm test"
        timeout: 5m
        dependencies:
          - backend
      - command: "cypress run"
        timeout: 10m
        env:
          - CYPRESS_BASE_URL=http://frontend:3000
  
  # 集成测试
  - image: "*"
    custom:
      - command: "k6 run tests/load.js"
        timeout: 15m
      - command: "newman run tests/api-collection.json"
        timeout: 10m
  
  # 测试配置
  timeout: 30m
  parallel: true
  maxParallel: 3
```

## 9.3 故障排除指南

### 9.3.1 常见问题及解决方案

**构建问题：**
```bash
# 镜像构建失败
问题：Build failed with status Code 1
解决方案：
- 检查Dockerfile语法
- 验证构建上下文路径
- 检查网络连接和代理设置
- 增加构建超时时间

# 推送镜像失败
问题：Failed to push image
解决方案：
- 验证镜像仓库权限
- 检查网络连接
- 确认镜像标签格式正确
- 使用--push=false本地测试
```

**部署问题：**
```bash
# kubectl部署失败
问题：kubectl error: forbidden
解决方案：
- 检查kubeconfig配置
- 验证RBAC权限
- 确认命名空间存在

# Helm部署失败
问题：Helm release failed
解决方案：
- 检查Chart语法
- 验证values.yaml格式
- 确认Helm版本兼容性
- 检查依赖Chart可用性
```

**同步问题：**
```bash
# 文件同步失败
问题：Sync failed: file not found
解决方案：
- 检查文件路径正确性
- 验证文件权限
- 确认目标路径存在
- 检查容器内文件系统权限
```

### 9.3.2 调试技巧

**详细日志分析：**
```bash
# 启用详细调试
skaffold dev -v debug

# 检查特定组件日志
skaffold dev --rpc-http-port=50051
# 然后访问 http://localhost:50051/v1/events

# 分析构建日志
docker logs <container-id>

# 检查Kubernetes事件
kubectl get events --sort-by='.lastTimestamp'
kubectl describe pod <pod-name>
```

**性能问题诊断：**
```bash
# 构建性能分析
skaffold build --profile=performance

# 部署性能分析
skaffold deploy --dry-run

# 资源使用分析
kubectl top pods
kubectl describe nodes
```

## 9.4 性能优化指南

### 9.4.1 构建性能优化

**镜像构建优化：**
```yaml
build:
  artifacts:
    - image: my-app
      docker:
        dockerfile: Dockerfile
        # 使用多阶段构建
        target: production
        # 构建缓存优化
        cacheFrom:
          - my-app:latest
          - my-app:{{.BRANCH_NAME}}
        cacheTo:
          - type: registry
            params:
              mode: max
        # 构建参数优化
        buildArgs:
          BUILDKIT_INLINE_CACHE: 1
          BUILDKIT_SANDBOX_HOSTNAME: docker-container
  
  # 并行构建
  concurrency: 0  # 0表示无限制
  
  # 本地构建优化
  local:
    useBuildkit: true
    push: false
    tryImportMissing: true
```

### 9.4.2 部署性能优化

**Kubernetes部署优化：**
```yaml
deploy:
  kubectl:
    flags:
      global:
        - --server-side=true
        - --prune=true
        - --prune-whitelist=core/v1/ConfigMap
        - --prune-whitelist=core/v1/Secret
    
    # 并行部署
    parallel:
      maxWorkers: 5
      ordered: false
    
    # 资源清理优化
    cleanup:
      enabled: true
      delay: 2s
```

### 9.4.3 开发循环优化

**开发模式优化：**
```yaml
# 文件同步优化
build:
  artifacts:
    - image: my-app
      sync:
        manual:
          - src: "src/**/*.js"
            dest: /app
            strip: "src/"
        auto: true
        infer:
          - "**/*.js"
          - "**/*.css"
          - "**/*.html"

# 端口转发优化
portForward:
  - resourceType: deployment
    resourceName: my-app
    port: 8080
    localPort: 9000
  - resourceType: service
    resourceName: my-app
    port: 80
    localPort: 9001
```

## 9.5 安全最佳实践

### 9.5.1 镜像安全

**安全镜像构建：**
```yaml
build:
  artifacts:
    - image: my-app
      docker:
        dockerfile: Dockerfile.security
        target: production
        # 安全构建参数
        buildArgs:
          SCAN_ENABLED: "true"
          VULNERABILITY_SCAN: "true"
          NON_ROOT_USER: "true"

# 镜像扫描配置
test:
  - image: "*"
    custom:
      - command: "trivy image --exit-code 1 --severity HIGH,CRITICAL {{.IMAGE}}"
      - command: "grype {{.IMAGE}} --fail-on high"
      - command: "docker scout cves {{.IMAGE}}"
```

### 9.5.2 部署安全

**安全部署配置：**
```yaml
deploy:
  kubectl:
    manifests:
      - k8s/security/

# 安全策略配置
# k8s/security/network-policies.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-egress
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress: []

# k8s/security/psp.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  runAsUser:
    rule: RunAsNonRoot
  seLinux:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
```

### 9.5.3 密钥管理

**安全密钥处理：**
```yaml
# 使用外部密钥管理
build:
  artifacts:
    - image: my-app
      kaniko:
        secret:
          name: kaniko-secret
          mountPath: /secret
        volumes:
          - name: secret-volume
            secret:
              secretName: docker-config

# 环境密钥管理
profiles:
  - name: production
    patches:
      - op: add
        path: /deploy/helm/releases/0/setValues
        value:
          database.password: {{.DB_PASSWORD}}
          api.key: {{.API_KEY}}
```

## 9.6 扩展和自定义

### 9.6.1 自定义构建器

**自定义构建脚本：**
```yaml
build:
  artifacts:
    - image: my-app
      custom:
        buildCommand: ./scripts/custom-build.sh
        dependencies:
          - Dockerfile
          - package.json
        buildArgs:
          - BUILD_ENV=production
          - VERSION={{.TAG}}
```

### 9.6.2 插件系统

**使用社区插件：**
```yaml
# 示例：使用Telemetry插件
apiVersion: skaffold/v2beta29
kind: Config
metadata:
  name: my-app

build:
  artifacts:
    - image: my-app

deploy:
  kubectl:
    manifests:
      - k8s/*.yaml

# 插件配置
plugins:
  - name: telemetry
    config:
      enabled: true
      endpoint: https://telemetry.example.com
      metrics:
        - build_duration
        - deploy_duration
```

### 9.6.3 自定义钩子

**部署前后钩子：**
```yaml
deploy:
  kubectl:
    manifests:
      - k8s/*.yaml
    
    # 部署前钩子
    hooks:
      preDeploy:
        - command: ["kubectl", "create", "configmap", "pre-deploy-config"]
        - command: ["bash", "-c", "echo 'Pre-deployment setup'"]
      
      # 部署后钩子
      postDeploy:
        - command: ["kubectl", "rollout", "status", "deployment/my-app"]
        - command: ["curl", "-f", "http://my-app/health"]
```

## 9.7 资源链接和参考

### 9.7.1 官方文档

- **Skaffold官网**: https://skaffold.dev/
- **GitHub仓库**: https://github.com/GoogleContainerTools/skaffold
- **用户指南**: https://skaffold.dev/docs/design/
- **API参考**: https://skaffold.dev/docs/references/yaml/

### 9.7.2 相关工具

**容器工具：**
- **Docker**: https://docs.docker.com/
- **BuildKit**: https://github.com/moby/buildkit
- **Kaniko**: https://github.com/GoogleContainerTools/kaniko

**Kubernetes工具：**
- **kubectl**: https://kubernetes.io/docs/reference/kubectl/
- **kustomize**: https://kustomize.io/
- **Helm**: https://helm.sh/

**监控和安全：**
- **Prometheus**: https://prometheus.io/
- **Grafana**: https://grafana.com/
- **Trivy**: https://github.com/aquasecurity/trivy
- **Falco**: https://falco.org/

### 9.7.3 社区资源

- **Stack Overflow**: https://stackoverflow.com/questions/tagged/skaffold
- **Slack频道**: https://kubernetes.slack.com/messages/skaffold
- **博客和教程**: https://skaffold.dev/docs/tutorials/

## 9.8 版本兼容性

### 9.8.1 Skaffold版本支持

| Skaffold版本 | Kubernetes版本 | 主要特性 |
|-------------|----------------|----------|
| v2.0+ | 1.19+ | 模块化配置、性能优化 |
| v1.39+ | 1.18+ | 改进的同步、自定义构建器 |
| v1.35+ | 1.16+ | 状态检查、Helm改进 |

### 9.8.2 向后兼容性

**配置迁移指南：**
```bash
# 检查配置兼容性
skaffold fix --dry-run

# 自动修复配置
skaffold fix

# 验证配置
skaffold schema
```

本章提供了完整的Skaffold参考指南，包括命令参考、配置参数、故障排除、性能优化、安全实践和扩展功能。这些内容将帮助您在实际项目中更好地使用和管理Skaffold。