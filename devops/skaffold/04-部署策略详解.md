# 第4章：Skaffold部署策略详解

## 4.1 部署系统概述

### 4.1.1 Skaffold部署流程
Skaffold的部署系统负责将构建好的镜像推送到Kubernetes集群，并提供灵活的部署策略。

```yaml
# 部署阶段的主要任务
1. 镜像推送 - 将构建的镜像推送到镜像仓库
2. 清单渲染 - 处理Kubernetes清单文件
3. 资源部署 - 将资源部署到Kubernetes集群
4. 状态监控 - 监控部署状态和健康检查
```

### 4.1.2 部署策略类型

**支持的部署工具：**
- kubectl（默认）
- kustomize
- helm
- kpt

## 4.2 kubectl部署策略

### 4.2.1 基础配置

```yaml
# skaffold.yaml
deploy:
  kubectl:
    manifests:
      - k8s/deployment.yaml
      - k8s/service.yaml
    flags:
      global:
        - --server-side
        - --force-conflicts
```

### 4.2.2 高级配置选项

```yaml
deploy:
  kubectl:
    manifests:
      - k8s/*.yaml
    defaultNamespace: my-namespace
    # 资源等待配置
    wait:
      enabled: true
      for:
        condition=available: deployment/my-app
        condition=ready: pod/my-app-pod
    # 资源清理策略
    delete:
      enabled: true
      namespaces:
        - my-namespace
```

### 4.2.3 资源排序和依赖

```yaml
deploy:
  kubectl:
    manifests:
      - k8s/namespace.yaml    # 1. 创建命名空间
      - k8s/configmap.yaml    # 2. 创建配置
      - k8s/secret.yaml       # 3. 创建密钥
      - k8s/deployment.yaml   # 4. 部署应用
      - k8s/service.yaml      # 5. 创建服务
      - k8s/ingress.yaml      # 6. 创建入口
```

## 4.3 kustomize部署策略

### 4.3.1 kustomize基础集成

```yaml
# skaffold.yaml
deploy:
  kustomize:
    paths:
      - kustomize/overlays/dev
    buildArgs:
      - --load-restrictor=LoadRestrictionsNone
      - --enable-helm
```

### 4.3.2 kustomize目录结构示例

```
app/
├── base/
│   ├── kustomization.yaml
│   ├── deployment.yaml
│   └── service.yaml
├── overlays/
│   ├── dev/
│   │   ├── kustomization.yaml
│   │   ├── patch-deployment.yaml
│   │   └── configmap.yaml
│   └── prod/
│       ├── kustomization.yaml
│       ├── patch-deployment.yaml
│       └── hpa.yaml
```

### 4.3.3 多环境配置

```yaml
# skaffold.yaml - 多环境配置
profiles:
  - name: dev
    deploy:
      kustomize:
        paths:
          - kustomize/overlays/dev
  - name: staging
    deploy:
      kustomize:
        paths:
          - kustomize/overlays/staging
  - name: prod
    deploy:
      kustomize:
        paths:
          - kustomize/overlays/prod
```

## 4.4 Helm部署策略

### 4.4.1 Helm基础配置

```yaml
# skaffold.yaml
deploy:
  helm:
    releases:
      - name: my-app
        chartPath: charts/my-app
        namespace: my-namespace
        valuesFiles:
          - values/dev.yaml
        setValues:
          image.tag: "{{.IMAGE_TAG}}"
        wait: true
        timeout: 5m
```

### 4.4.2 Helm高级功能

```yaml
deploy:
  helm:
    releases:
      - name: my-app
        chartPath: charts/my-app
        # 镜像替换策略
        imageStrategy:
          helm: {}
        # 值文件覆盖
        values:
          replicaCount: 3
          service:
            type: LoadBalancer
        # 发布前hook
        hooks:
          before:
            - command: ["sh", "-c", "echo 'Pre-deployment check...'"]
```

### 4.4.3 远程Chart部署

```yaml
deploy:
  helm:
    releases:
      - name: redis
        remoteChart: bitnami/redis
        version: 17.0.0
        namespace: redis
        setValues:
          auth.password: ${REDIS_PASSWORD}
          architecture: standalone
```

## 4.5 部署优化策略

### 4.5.1 并行部署

```yaml
deploy:
  kubectl:
    manifests:
      - k8s/deployment.yaml
      - k8s/service.yaml
      - k8s/ingress.yaml
  # 并行部署配置
  statusCheckDeadlineSeconds: 120
```

### 4.5.2 健康检查配置

```yaml
deploy:
  statusCheck: true
  statusCheckDeadlineSeconds: 300
  kubectl:
    manifests:
      - k8s/deployment.yaml
```

### 4.5.3 资源清理策略

```yaml
deploy:
  kubectl:
    manifests:
      - k8s/*.yaml
    # 自动清理
    delete:
      enabled: true
      # 清理特定标签的资源
      labelSelectors:
        - app=my-app
        - environment=dev
    # 清理超时配置
    deleteTimeout: 5m
```

## 4.6 安全部署实践

### 4.6.1 安全上下文配置

```yaml
# deployment.yaml - 安全配置示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secure-app
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: app
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true
```

### 4.6.2 网络策略

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: app-network-policy
spec:
  podSelector:
    matchLabels:
      app: my-app
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              role: frontend
      ports:
        - protocol: TCP
          port: 8080
```

## 4.7 实战：多环境部署策略

### 4.7.1 环境特定配置

```yaml
# skaffold.yaml - 完整多环境配置
apiVersion: skaffold/v4beta1
kind: Config
metadata:
  name: my-app

# 基础构建配置
build:
  artifacts:
    - image: my-registry/my-app
      context: .
      docker:
        dockerfile: Dockerfile

# 默认部署配置（开发环境）
deploy:
  kubectl:
    manifests:
      - k8s/dev/*.yaml

# 环境配置
profiles:
  - name: dev
    # 使用默认配置
    patches:
      - op: replace
        path: /deploy/kubectl/manifests
        value:
          - k8s/dev/*.yaml
  
  - name: staging
    patches:
      - op: replace
        path: /deploy/kubectl/manifests
        value:
          - k8s/staging/*.yaml
      - op: replace
        path: /build/artifacts/0/image
        value: my-registry/my-app-staging
  
  - name: prod
    patches:
      - op: replace
        path: /deploy/kubectl/manifests
        value:
          - k8s/prod/*.yaml
      - op: replace
        path: /build/artifacts/0/image
        value: my-registry/my-app-prod
      - op: add
        path: /deploy/kubectl/flags
        value:
          global:
            - --validate=true
            - --dry-run=client
```

### 4.7.2 环境特定资源文件

```yaml
# k8s/dev/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app-dev
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: app
        image: my-registry/my-app:latest
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
        env:
          - name: ENVIRONMENT
            value: "development"
```

```yaml
# k8s/prod/deployment.yaml  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app-prod
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    spec:
      containers:
      - name: app
        image: my-registry/my-app-prod:latest
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

## 4.8 部署故障排除

### 4.8.1 常见部署问题

1. **镜像拉取失败**
   ```bash
   # 检查镜像仓库认证
   skaffold dev --default-repo my-registry --verbosity debug
   ```

2. **资源配额不足**
   ```bash
   # 检查资源配额
   kubectl describe quota -n my-namespace
   ```

3. **网络策略阻止连接**
   ```bash
   # 检查网络策略
   kubectl get networkpolicies -A
   ```

### 4.8.2 调试技巧

```bash
# 详细日志输出
skaffold dev --verbosity debug

# 仅验证配置
skaffold render --output rendered.yaml

# 调试部署
skaffold deploy --tail --port-forward
```

## 4.9 本章总结

本章详细介绍了Skaffold的部署系统，包括：
- kubectl、kustomize、Helm等部署工具的使用
- 多环境部署策略的实现
- 部署优化和安全实践
- 故障排除技巧

通过本章的学习，您应该能够：
✅ 配置和管理不同部署策略
✅ 实现多环境部署配置
✅ 优化部署性能和安全性
✅ 解决常见的部署问题

下一章将深入探讨Skaffold的测试和验证系统。