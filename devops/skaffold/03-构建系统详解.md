# 第三章：Skaffold构建系统详解

## 3.1 本地构建策略

### 3.1.1 Docker构建器

Docker构建器是Skaffold最常用的构建方式，支持完整的Docker功能。

#### 基础配置

```yaml
build:
  artifacts:
  - image: my-app
    context: ./app
    docker:
      dockerfile: Dockerfile
      target: production
      buildArgs:
        NODE_ENV: production
        VERSION: "1.0.0"
      cacheFrom:
      - my-app:latest
      secrets:
      - id: npm_token
        src: ~/.npmrc
```

#### 多阶段构建示例

```dockerfile
# 构建阶段
FROM node:16-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 本地构建优化

```yaml
build:
  local:
    push: false
    useDockerCLI: true
    useBuildkit: true
    concurrency: 3
    tryImportMissing: true
```

### 3.1.2 Jib构建器（Java项目）

Jib可以直接构建容器镜像，无需Docker守护进程。

#### Maven项目配置

```yaml
build:
  artifacts:
  - image: my-java-app
    jib:
      type: maven
      project: my-project
      flags:
      - "-Pprod"
      - "-DskipTests"
      args:
      - "-Djib.httpTimeout=60000"
```

#### Gradle项目配置

```yaml
build:
  artifacts:
  - image: my-java-app
    jib:
      type: gradle
      project: my-project
      flags:
      - "-Penv=production"
```

#### Jib高级配置

```yaml
build:
  artifacts:
  - image: my-java-app
    jib:
      type: maven
      project: my-project
      image: gcr.io/distroless/java17-debian11
      jvmFlags:
      - "-Xmx512m"
      - "-Dspring.profiles.active=prod"
      environment:
        JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
```

### 3.1.3 Bazel构建器

Bazel提供快速、可重现的构建。

```yaml
build:
  artifacts:
  - image: my-bazel-app
    bazel:
      target: //app:image.tar
      buildArgs:
      - "--config=release"
      - "--platforms=@io_bazel_rules_go//go/toolchain:linux_amd64"
```

## 3.2 云构建策略

### 3.2.1 Google Cloud Build

#### 基础配置

```yaml
build:
  googleCloudBuild:
    projectId: my-project-123456
    diskSizeGb: 100
    machineType: E2_HIGHCPU_8
    timeout: "20m"
    logging: CLOUD_LOGGING_ONLY
    workerPool: projects/my-project/locations/us-central1/workerPools/my-pool
```

#### 高级配置

```yaml
build:
  googleCloudBuild:
    projectId: my-project
    # 自定义构建步骤
    steps:
    - name: 'gcr.io/cloud-builders/docker'
      args: ['build', '-t', '$_IMAGE', '.']
      env:
      - 'PROJECT_ID=$PROJECT_ID'
    # 构建触发器
    substitutions:
      _IMAGE: my-app
    # 缓存配置
    options:
      machineType: 'N1_HIGHCPU_8'
      diskSizeGb: 200
      logStreamingOption: 'STREAM_ON'
```

### 3.2.2 Kaniko构建器

Kaniko可以在Kubernetes集群中构建镜像，无需Docker守护进程。

#### 基础配置

```yaml
build:
  kaniko:
    cache: {}
    buildContext:
      gcsBucket: my-bucket
    image: gcr.io/kaniko-project/executor:v1.9.0
    pullSecret: kaniko-secret
    namespace: default
    timeout: "20m"
```

#### 高级配置

```yaml
build:
  kaniko:
    cache:
      repo: gcr.io/my-project/cache
      ttl: "720h"
    buildContext:
      localDir: {}
    flags:
    - "--compressed-caching=false"
    - "--single-snapshot"
    - "--snapshotMode=time"
    env:
    - name: DOCKER_CONFIG
      value: /kaniko/.docker
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
```

### 3.2.3 构建器选择指南

| 构建器 | 适用场景 | 优势 | 限制 |
|--------|----------|------|------|
| Docker | 本地开发，简单项目 | 功能完整，兼容性好 | 需要Docker守护进程 |
| Jib | Java项目 | 无需Docker，构建快 | 仅支持Java |
| Bazel | 大型项目，多语言 | 构建缓存，可重现 | 学习曲线陡峭 |
| Cloud Build | 云原生项目 | 可扩展，集成好 | 需要云环境 |
| Kaniko | Kubernetes环境 | 安全，无需特权 | 配置复杂 |

## 3.3 自定义构建器

### 3.3.1 自定义脚本构建器

```yaml
build:
  artifacts:
  - image: my-custom-app
    custom:
      buildCommand: ./scripts/build.sh
      dependencies:
        dockerfile: Dockerfile.custom
        paths:
        - src/**
        - package.json
      sync:
      - src: "src/**/*.js"
        dest: "/app/src"
```

#### 构建脚本示例

```bash
#!/bin/bash
# scripts/build.sh

set -e

echo "Building custom application..."

# 构建应用
npm run build

# 构建Docker镜像
docker build -t $IMAGE -f Dockerfile.custom .

# 推送镜像（如果需要）
if [ "$PUSH" = "true" ]; then
    docker push $IMAGE
fi

echo "Build completed: $IMAGE"
```

### 3.3.2 多构建器组合

```yaml
build:
  artifacts:
  - image: frontend-app
    docker:
      dockerfile: frontend/Dockerfile
    context: frontend
  - image: backend-app
    jib:
      type: maven
      project: backend
  - image: database
    custom:
      buildCommand: ./scripts/build-db.sh
```

## 3.4 构建优化技巧

### 3.4.1 缓存策略

#### Docker构建缓存

```dockerfile
# 优化Dockerfile缓存
FROM node:16-alpine

# 先复制package.json（依赖变化较少）
COPY package*.json ./
RUN npm ci --only=production

# 再复制源代码（变化频繁）
COPY . .
RUN npm run build
```

#### Skaffold缓存配置

```yaml
build:
  local:
    tryImportMissing: true
    cache:
      use: true
      import:
      - from: my-app:latest
        to: my-app:dev
      export:
      - to: my-app:latest
```

### 3.4.2 并行构建

```yaml
build:
  local:
    concurrency: 0  # 0表示无限制
  artifacts:
  - image: frontend
    docker:
      dockerfile: frontend/Dockerfile
    context: frontend
    sync:
      auto: true
  - image: backend
    docker:
      dockerfile: backend/Dockerfile
    context: backend
    sync:
      auto: true
```

### 3.4.3 增量构建

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
    sync:
      manual:
      - src: "src/**/*.js"
        dest: "/app/src"
        strip: "src/"
      - src: "package.json"
        dest: "/app"
    # 忽略不需要同步的文件
    ignore:
    - "node_modules/**"
    - ".git/**"
    - "*.log"
```

### 3.4.4 构建性能监控

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
    # 构建指标
    metrics:
      enabled: true
      port: 9090
    # 资源限制
    resources:
      limits:
        cpu: "2"
        memory: "2Gi"
      requests:
        cpu: "1"
        memory: "1Gi"
```

## 3.5 安全构建实践

### 3.5.1 安全镜像构建

```dockerfile
# 使用最小化基础镜像
FROM gcr.io/distroless/base-debian11

# 非root用户运行
RUN adduser -D -u 1000 appuser
USER appuser

# 复制最小必要文件
COPY --chown=appuser:appuser app /app

WORKDIR /app
CMD ["./app"]
```

### 3.5.2 密钥管理

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
      secrets:
      - id: npm_token
        src: ~/.npmrc
      - id: aws_credentials
        src: ~/.aws/credentials
        env: AWS_PROFILE
```

#### 密钥文件示例

```
# ~/.npmrc
//registry.npmjs.org/:_authToken=${NPM_TOKEN}
```

### 3.5.3 安全扫描集成

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
  # 安全扫描
  security:
    scanner: trivy
    config:
      severity: HIGH,CRITICAL
      ignoreUnfixed: true
    # 扫描失败时的行为
    failOn: HIGH
```

## 3.6 构建调试和故障排除

### 3.6.1 构建调试

```bash
# 详细日志
skaffold build -v debug

# 仅构建特定artifact
skaffold build -b my-app

# 构建到文件
skaffold build --file-output=build.json

# 清理构建缓存
skaffold cache clear
```

### 3.6.2 故障排除工具

```yaml
# 诊断配置
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
    # 调试模式
    debug: true
    # 构建日志
    log:
      level: debug
      format: json
```

#### 常见构建问题

1. **缓存失效**：清理Docker缓存和Skaffold缓存
2. **网络超时**：配置代理或镜像源
3. **内存不足**：调整构建资源限制
4. **权限问题**：检查文件权限和Docker权限

## 3.7 本章总结

本章详细介绍了Skaffold的构建系统：

- **本地构建策略**：Docker、Jib、Bazel构建器
- **云构建策略**：Google Cloud Build、Kaniko
- **自定义构建器**：灵活支持各种构建工具
- **构建优化**：缓存、并行、增量构建策略
- **安全实践**：安全镜像构建和密钥管理
- **调试和故障排除**：构建问题诊断工具

通过本章的学习，您应该能够：

1. 根据项目需求选择合适的构建器
2. 配置和优化构建性能
3. 实施安全的构建实践
4. 诊断和解决构建问题
5. 集成自定义构建工具

在下一章中，我们将深入探讨Skaffold的部署策略，包括Kubernetes、Helm和Kustomize部署。