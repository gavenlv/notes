# 第二章：Skaffold配置文件详解

## 2.1 skaffold.yaml文件结构

### 2.1.1 配置文件版本和结构

Skaffold配置文件使用YAML格式，基本结构如下：

```yaml
apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: my-app

# 构建配置
build:
  artifacts: []
  tagPolicy: {}
  local: {}
  googleCloudBuild: {}

# 测试配置
test:
  - image: ""
    structureTests: []
    customTests: []

# 部署配置
deploy:
  kubectl: {}
  helm: {}
  kustomize: {}

# 开发工具配置
dev:
  sync: {}
  portForward: []
  logs: {}

# 清单配置
manifests:
  rawYaml: []
  kustomize: {}
  helm: {}

# 配置文件配置
profiles: []
```

### 2.1.2 版本兼容性

不同版本的Skaffold支持不同的API版本：

| Skaffold版本 | 推荐API版本 | 支持的API版本 |
|-------------|------------|--------------|
| v1.x.x      | skaffold/v1 | skaffold/v1 |
| v2.x.x      | skaffold/v2beta29 | skaffold/v1, v2beta* |
| v2.0.0+     | skaffold/v4beta7 | skaffold/v1, v2beta*, v4beta* |

## 2.2 构建配置详解

### 2.2.1 artifacts配置

artifacts定义了需要构建的镜像：

```yaml
build:
  artifacts:
  - image: registry.example.com/myapp
    context: .
    docker:
      dockerfile: Dockerfile
      target: production
      buildArgs:
        BUILD_VERSION: "1.0.0"
      cacheFrom:
      - registry.example.com/myapp:latest
      secrets:
      - id: npm_token
        src: ~/.npmrc
```

#### 多artifacts配置

```yaml
build:
  artifacts:
  - image: registry.example.com/api
    context: ./api
    docker:
      dockerfile: Dockerfile
  - image: registry.example.com/web
    context: ./web
    docker:
      dockerfile: Dockerfile
  - image: registry.example.com/db
    context: ./db
      docker:
      dockerfile: Dockerfile
```

### 2.2.2 构建器类型

#### Docker构建器

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
      # 可选参数
      target: production
      buildArgs:
        NODE_ENV: production
      noCache: false
```

#### Jib构建器（Java项目）

```yaml
build:
  artifacts:
  - image: my-java-app
    jib:
      type: maven  # 或 gradle
      project: my-project
      flags: ["-Pprod"]
```

#### Bazel构建器

```yaml
build:
  artifacts:
  - image: my-bazel-app
    bazel:
      target: //app:image.tar
      buildArgs:
      - "--config=release"
```

### 2.2.3 标签策略（Tagging Policy）

#### Git提交哈希

```yaml
build:
  tagPolicy:
    gitCommit:
      variant: CommitSha
      # 或 variant: AbbrevCommitSha（缩写哈希）
      # 或 variant: GitCommit（带时间戳的完整哈希）
```

#### 日期时间标签

```yaml
build:
  tagPolicy:
    dateTime:
      format: "2006-01-02_15-04-05"
      timezone: "UTC"
```

#### 环境变量标签

```yaml
build:
  tagPolicy:
    envTemplate:
      template: "{{.DATE}}_{{.TIME}}_{{.GIT_COMMIT}}"
```

#### 自定义标签

```yaml
build:
  tagPolicy:
    customTemplate:
      template: "v1.0.0-{{.GIT_COMMIT}}-{{.DATE}}"
      components:
      - name: GIT_COMMIT
        prefix: ""
        suffix: ""
      - name: DATE
        prefix: ""
        suffix: ""
```

### 2.2.4 构建策略配置

#### 本地构建策略

```yaml
build:
  local:
    push: false
    useDockerCLI: true
    useBuildkit: true
    concurrency: 0  # 0表示无限制
```

#### Google Cloud Build策略

```yaml
build:
  googleCloudBuild:
    projectId: my-project
    diskSizeGb: 100
    machineType: N1_HIGHCPU_8
    timeout: "10m"
    logging: CLOUD_LOGGING_ONLY
```

#### Kaniko构建策略

```yaml
build:
  kaniko:
    cache: {}
    buildContext:
      localDir: {}
    image: gcr.io/kaniko-project/executor:v1.9.0
    pullSecret: kaniko-secret
```

## 2.3 部署配置详解

### 2.3.1 kubectl部署

```yaml
deploy:
  kubectl:
    manifests:
    - k8s/*.yaml
    - k8s/**/*.yaml
    flags:
      global:
      - "--server-side=true"
      apply:
      - "--force=true"
      delete:
      - "--wait=true"
    defaultNamespace: my-namespace
```

#### 清单文件通配符

```yaml
deploy:
  kubectl:
    manifests:
    # 匹配所有.yaml文件
    - k8s/*.yaml
    # 递归匹配所有.yaml文件
    - k8s/**/*.yaml
    # 明确指定文件
    - k8s/deployment.yaml
    - k8s/service.yaml
    # 忽略某些文件
    - k8s/*.yaml
    - "!k8s/test-*.yaml"
```

### 2.3.2 Helm部署

```yaml
deploy:
  helm:
    releases:
    - name: my-release
      chartPath: ./charts/my-app
      # 或使用远程chart
      # remoteChart: bitnami/nginx
      namespace: default
      valuesFiles:
      - values.yaml
      setValues:
        image.tag: "{{.IMAGE_TAG}}"
        replicaCount: 3
      wait: true
      timeout: 5m
      recreatePods: true
      force: false
```

#### 多Helm release配置

```yaml
deploy:
  helm:
    releases:
    - name: frontend
      chartPath: ./charts/frontend
      namespace: frontend
      setValues:
        replicaCount: 2
    - name: backend
      chartPath: ./charts/backend
      namespace: backend
      setValues:
        replicaCount: 3
    - name: database
      chartPath: ./charts/database
      namespace: database
      setValues:
        storage.size: 10Gi
```

### 2.3.3 Kustomize部署

```yaml
deploy:
  kustomize:
    paths:
    - k8s/overlays/dev
    - k8s/overlays/prod
    buildArgs:
    - "--load-restrictor=LoadRestrictionsNone"
    - "--enable-helm"
    flags:
      apply: []
      delete: []
```

## 2.4 测试配置详解

### 2.4.1 结构测试（Structure Tests）

```yaml
test:
- image: my-app
  structureTests:
  - ./tests/structure.yaml
  - ./tests/security.yaml
```

结构测试示例（tests/structure.yaml）：

```yaml
schemaVersion: "2.0.0"

commandTests:
- name: "app starts correctly"
  command: "curl"
  args: ["-f", "http://localhost:5000/health"]
  expectedOutput: ["healthy"]

fileExistenceTests:
- name: "app file exists"
  path: "/app/app.py"
  shouldExist: true

metadataTest:
  env:
  - key: "VERSION"
    value: "1.0.0"
```

### 2.4.2 自定义测试

```yaml
test:
- image: my-app
  customTests:
  - command: ./scripts/test-integration.sh
    timeoutSeconds: 300
  - command: python -m pytest tests/
    timeoutSeconds: 600
    dependencies:
    - dockerfile: tests/Dockerfile
      image: test-runner
```

## 2.5 开发工具配置

### 2.5.1 文件同步（Sync）

```yaml
dev:
  sync:
    # 全局同步配置
    manual:
    - src: "src/**/*.js"
      dest: "/app/src"
    - src: "*.json"
      dest: "/app"
    # 或使用自动同步
    auto: true
```

#### 针对特定artifact的同步

```yaml
build:
  artifacts:
  - image: my-app
    sync:
      manual:
      - src: "src/**/*.py"
        dest: "/app"
      - src: "requirements.txt"
        dest: "/app"
```

### 2.5.2 端口转发（Port Forward）

```yaml
dev:
  portForward:
  - resourceType: deployment
    resourceName: my-app
    port: 5000
    localPort: 5000
    namespace: default
  - resourceType: service
    resourceName: my-app-service
    port: 80
    localPort: 8080
```

### 2.5.3 日志配置

```yaml
dev:
  logs:
    prefix: container
    # 或 prefix: pod
    # 或 prefix: auto
```

## 2.6 配置文件进阶特性

### 2.6.1 环境变量替换

```yaml
build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile
      buildArgs:
        BUILD_NUMBER: "{{.BUILD_NUMBER}}"

deploy:
  helm:
    releases:
    - name: my-app
      setValues:
        image.tag: "{{.IMAGE_TAG}}"
```

### 2.6.2 条件配置

```yaml
# 根据环境变量决定配置
{{if eq .ENV "production"}}
deploy:
  kubectl:
    manifests:
    - k8s/production/*.yaml
{{else}}
deploy:
  kubectl:
    manifests:
    - k8s/development/*.yaml
{{end}}
```

### 2.6.3 配置文件组合

```yaml
# 基础配置 (skaffold.base.yaml)
apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: base-config

build:
  artifacts:
  - image: my-app
    docker:
      dockerfile: Dockerfile

# 开发环境配置 (skaffold.dev.yaml)
apiVersion: skaffold/v4beta7
kind: Config
metadata:
  name: dev-config

requires:
- path: skaffold.base.yaml

build:
  tagPolicy:
    gitCommit: {}

deploy:
  kubectl:
    manifests:
    - k8s/dev/*.yaml
```

## 2.7 配置文件验证和调试

### 2.7.1 配置文件验证

```bash
# 验证配置文件语法
skaffold schema --validate

# 检查配置文件的正确性
skaffold diagnose

# 渲染最终配置
skaffold render --output rendered.yaml
```

### 2.7.2 调试技巧

#### 详细日志

```bash
skaffold dev -v debug
skaffold build -v info
```

#### 配置调试

```bash
# 显示解析后的配置
skaffold config list

# 显示特定profile的配置
skaffold config list --profile production
```

## 2.8 本章总结

本章详细介绍了Skaffold配置文件的各个方面：

- **配置文件结构**：了解完整的配置文件格式
- **构建配置**：多种构建器、标签策略和构建策略
- **部署配置**：kubectl、Helm、Kustomize的详细配置
- **测试配置**：结构测试和自定义测试
- **开发工具**：文件同步、端口转发、日志配置
- **进阶特性**：环境变量替换、条件配置、配置文件组合

通过本章的学习，您应该能够：

1. 编写复杂的Skaffold配置文件
2. 根据项目需求选择合适的构建和部署策略
3. 配置测试和开发工具
4. 使用配置文件组合和条件配置
5. 验证和调试配置文件

在下一章中，我们将深入探讨Skaffold的构建系统，包括各种构建策略和优化技巧。