# 第5章：Skaffold测试和验证详解

## 5.1 测试框架概述

### 5.1.1 Skaffold测试生态系统
Skaffold提供完整的测试框架，支持从单元测试到集成测试的完整流程。

```yaml
# 测试阶段的主要任务
1. 构建前测试 - 代码质量检查
2. 构建后测试 - 镜像验证
3. 部署前测试 - 配置验证
4. 部署后测试 - 功能验证
```

### 5.1.2 测试类型支持

**支持的测试类型：**
- 单元测试
- 集成测试
- 端到端测试
- 容器镜像测试
- API测试

## 5.2 构建前测试

### 5.2.1 代码质量检查

```yaml
# skaffold.yaml - 构建前测试配置
test:
  - name: code-quality
    # 代码静态分析
    structureTests:
      - ./test/structure-tests.yaml
    # 自定义命令
    commands:
      - command: go vet ./...
        dir: ./src
      - command: golangci-lint run
        dir: ./src
      - command: npm run lint
        dir: ./frontend
```

### 5.2.2 安全扫描

```yaml
test:
  - name: security-scan
    commands:
      - command: trivy config .
        dir: .
      - command: hadolint Dockerfile
        dir: .
      - command: checkov --directory .
        dir: .
```

### 5.2.3 依赖检查

```yaml
test:
  - name: dependency-check
    commands:
      - command: go mod tidy
        dir: ./src
        # 验证依赖完整性
        env:
          - GO111MODULE=on
      - command: npm audit
        dir: ./frontend
      - command: pip-audit
        dir: ./api
```

## 5.3 构建后测试

### 5.3.1 容器镜像测试

```yaml
# skaffold.yaml - 镜像测试配置
test:
  - name: image-validation
    image: my-app
    # 镜像结构测试
    structureTests:
      - ./test/image-structure.yaml
    # 镜像功能测试
    customTests:
      - command: ./test/container-health.sh
        # 测试镜像是否健康
        env:
          - IMAGE=my-app:latest
```

### 5.3.2 镜像结构测试文件

```yaml
# test/image-structure.yaml
schemaVersion: "2.0.0"

# 基础镜像验证
commandTests:
  - name: "base-image-version"
    command: "cat"
    args: ["/etc/os-release"]
    expectedOutput: ["PRETTY_NAME=\"Debian GNU/Linux 11 (bullseye)\"\n"]

# 文件权限验证
fileExistenceTests:
  - name: "app-executable"
    path: "/app/my-app"
    shouldExist: true
    permissions: "-rwxr-xr-x"

# 用户验证
metadataTest:
  env:
    - key: "USER"
      value: "appuser"
  exposedPorts: ["8080"]
  workdir: "/app"
  user: "appuser"

# 安全扫描
commandTests:
  - name: "no-root-user"
    command: "whoami"
    expectedOutput: ["appuser\n"]
```

### 5.3.3 镜像性能测试

```yaml
test:
  - name: image-performance
    image: my-app
    customTests:
      - command: ./test/performance.sh
        # 启动时间测试
        env:
          - IMAGE=my-app:latest
          - TIMEOUT=30s
      - command: ./test/memory-usage.sh
        # 内存使用测试
```

## 5.4 部署前测试

### 5.4.1 Kubernetes清单验证

```yaml
test:
  - name: k8s-manifest-validation
    # 清单语法验证
    commands:
      - command: kubectl apply --dry-run=client -f k8s/
        dir: .
      - command: kubeval k8s/*.yaml
        dir: .
      - command: kubectl-neat diff -f k8s/
        dir: .
```

### 5.4.2 配置验证

```yaml
test:
  - name: config-validation
    commands:
      - command: ./scripts/validate-config.sh
        dir: .
        # 环境变量验证
        env:
          - ENV=dev
      - command: ./scripts/check-secrets.sh
        # 密钥配置验证
```

### 5.4.3 资源配额检查

```yaml
test:
  - name: resource-quota-check
    commands:
      - command: ./scripts/check-resources.sh
        dir: .
        # 检查资源请求是否合理
        env:
          - NAMESPACE=my-app
```

## 5.5 部署后测试

### 5.5.1 服务健康检查

```yaml
test:
  - name: service-health-check
    # 部署后健康检查
    commands:
      - command: ./test/service-health.sh
        dir: .
        # 等待服务就绪
        env:
          - SERVICE_NAME=my-app
          - NAMESPACE=default
          - TIMEOUT=300s
```

### 5.5.2 API功能测试

```yaml
test:
  - name: api-functional-test
    commands:
      - command: ./test/api-test.sh
        dir: .
        # API端点测试
        env:
          - API_URL=http://my-app:8080
          - TEST_TIMEOUT=60s
```

### 5.5.3 端到端测试

```yaml
test:
  - name: e2e-test
    commands:
      - command: npm run test:e2e
        dir: ./frontend
        # 前端E2E测试
        env:
          - BASE_URL=http://my-app:8080
      - command: go test ./e2e/...
        dir: ./src
        # 后端E2E测试
```

## 5.6 测试配置最佳实践

### 5.6.1 环境特定测试配置

```yaml
# skaffold.yaml - 多环境测试配置
profiles:
  - name: dev
    test:
      - name: dev-tests
        commands:
          - command: ./test/dev-smoke.sh
            dir: .
  
  - name: staging
    test:
      - name: staging-tests
        commands:
          - command: ./test/staging-integration.sh
            dir: .
  
  - name: prod
    test:
      - name: prod-tests
        commands:
          - command: ./test/prod-sanity.sh
            dir: .
```

### 5.6.2 测试依赖管理

```yaml
test:
  - name: integration-tests
    # 设置测试依赖
    dependencies:
      paths:
        - ./test/fixtures
        - ./test/data
      command: ./test/setup-fixtures.sh
    commands:
      - command: ./test/run-integration.sh
        dir: .
```

### 5.6.3 测试结果报告

```yaml
test:
  - name: test-with-reporting
    commands:
      - command: go test -v ./... -json > test-results.json
        dir: ./src
      - command: npm run test:coverage
        dir: ./frontend
    # 测试结果处理
    after:
      - command: ./scripts/process-test-results.sh
        dir: .
```

## 5.7 测试工具集成

### 5.7.1 常用测试工具

```yaml
# 完整的测试工具配置
test:
  - name: unit-tests
    commands:
      # Go测试
      - command: go test -race -cover -v ./...
        dir: ./src
      # Node.js测试
      - command: npm test -- --coverage --watchAll=false
        dir: ./frontend
      # Python测试
      - command: pytest --cov=app tests/
        dir: ./api

  - name: integration-tests
    commands:
      # API测试
      - command: newman run tests/api-collection.json
        dir: .
      # 数据库测试
      - command: ./test/db-integration.sh
        dir: .

  - name: security-tests
    commands:
      # 容器安全
      - command: grype my-app:latest
        dir: .
      # 应用安全
      - command: zap-baseline.py -t http://my-app:8080
        dir: .
```

### 5.7.2 性能测试工具

```yaml
test:
  - name: performance-tests
    commands:
      # 负载测试
      - command: k6 run tests/load-test.js
        dir: .
      # 压力测试
      - command: artillery run tests/stress-test.yaml
        dir: .
      # 基准测试
      - command: ./test/benchmark.sh
        dir: .
```

## 5.8 测试环境管理

### 5.8.1 测试命名空间管理

```yaml
test:
  - name: test-environment-setup
    commands:
      # 创建测试命名空间
      - command: kubectl create namespace test-my-app --dry-run=client -o yaml | kubectl apply -f -
        dir: .
      # 设置测试配置
      - command: kubectl apply -f test/configmap.yaml -n test-my-app
        dir: .
      # 清理测试环境
      - command: kubectl delete namespace test-my-app --ignore-not-found=true
        dir: .
```

### 5.8.2 测试数据管理

```yaml
test:
  - name: test-data-management
    commands:
      # 加载测试数据
      - command: ./scripts/load-test-data.sh
        dir: .
        env:
          - DATABASE_URL=postgresql://test:test@localhost:5432/test
      # 清理测试数据
      - command: ./scripts/clean-test-data.sh
        dir: .
```

## 5.9 实战：完整的测试流水线

### 5.9.1 完整的测试配置示例

```yaml
# skaffold.yaml - 完整测试流水线
apiVersion: skaffold/v4beta1
kind: Config
metadata:
  name: my-app

build:
  artifacts:
    - image: my-registry/my-app
      context: .

test:
  # 阶段1：代码质量检查
  - name: code-quality
    commands:
      - command: go vet ./...
        dir: ./src
      - command: npm run lint
        dir: ./frontend
      - command: shellcheck scripts/*.sh
        dir: .

  # 阶段2：单元测试
  - name: unit-tests
    commands:
      - command: go test -race -cover -v ./...
        dir: ./src
        env:
          - GO111MODULE=on
      - command: npm test -- --coverage
        dir: ./frontend

  # 阶段3：镜像验证
  - name: image-validation
    image: my-registry/my-app
    structureTests:
      - ./test/image-structure.yaml
    customTests:
      - command: ./test/container-health.sh

  # 阶段4：部署验证
  - name: deployment-validation
    commands:
      - command: kubectl apply --dry-run=client -f k8s/
        dir: .
      - command: ./test/deployment-health.sh
        dir: .

deploy:
  kubectl:
    manifests:
      - k8s/*.yaml

# 环境特定测试配置
profiles:
  - name: dev
    test:
      - name: dev-smoke-tests
        commands:
          - command: ./test/dev-smoke.sh
            dir: .

  - name: staging
    test:
      - name: staging-integration-tests
        commands:
          - command: ./test/staging-integration.sh
            dir: .

  - name: prod
    test:
      - name: prod-sanity-tests
        commands:
          - command: ./test/prod-sanity.sh
            dir: .
```

### 5.9.2 测试脚本示例

```bash
#!/bin/bash
# test/container-health.sh

set -e

# 启动测试容器
docker run -d --name test-container my-registry/my-app:latest

# 等待容器启动
sleep 10

# 检查容器状态
if ! docker ps | grep -q test-container; then
    echo "容器启动失败"
    docker logs test-container
    exit 1
fi

# 健康检查
if ! curl -f http://localhost:8080/health; then
    echo "健康检查失败"
    docker logs test-container
    exit 1
fi

# 清理测试容器
docker stop test-container
docker rm test-container

echo "容器健康检查通过"
```

## 5.10 测试故障排除

### 5.10.1 常见测试问题

1. **测试超时**
   ```bash
   # 增加测试超时时间
   skaffold test --timeout=10m
   ```

2. **资源不足**
   ```bash
   # 检查资源使用情况
   kubectl top pods -n test-namespace
   ```

3. **网络问题**
   ```bash
   # 检查网络连接
   kubectl run test-pod --image=busybox --rm -it -- ping google.com
   ```

### 5.10.2 调试技巧

```bash
# 详细日志输出
skaffold test --verbosity debug

# 只运行特定测试
skaffold test --module=unit-tests

# 跳过特定测试
skaffold test --skip-tests=integration-tests
```

## 5.11 本章总结

本章详细介绍了Skaffold的测试和验证系统，包括：
- 构建前、构建后、部署前、部署后测试
- 各种测试工具和框架的集成
- 测试环境管理和数据管理
- 完整的测试流水线配置

通过本章的学习，您应该能够：
✅ 配置完整的测试流水线
✅ 集成各种测试工具和框架
✅ 管理测试环境和数据
✅ 解决常见的测试问题

下一章将深入探讨Skaffold的高级特性。