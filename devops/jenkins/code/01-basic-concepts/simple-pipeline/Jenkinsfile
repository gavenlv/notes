pipeline {
    // æŒ‡å®šè¿è¡Œç¯å¢ƒ
    agent any
    
    // ç¯å¢ƒå˜é‡é…ç½®
    environment {
        APP_NAME = 'hello-world'
        VERSION = '1.0.0'
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
    }
    
    // é˜¶æ®µå®šä¹‰
    stages {
        // å‡†å¤‡é˜¶æ®µ
        stage('Preparation') {
            steps {
                echo '=== å‡†å¤‡é˜¶æ®µå¼€å§‹ ==='
                echo "åº”ç”¨åç§°: ${APP_NAME}"
                echo "ç‰ˆæœ¬å·: ${VERSION}"
                echo "æ„å»ºç¼–å·: ${BUILD_NUMBER}"
                
                // æ£€æŸ¥ç¯å¢ƒ
                sh 'java -version'
                sh 'mvn --version'
                echo '=== å‡†å¤‡é˜¶æ®µå®Œæˆ ==='
            }
        }
        
        // æ£€å‡ºä»£ç é˜¶æ®µ
        stage('Checkout') {
            steps {
                echo '=== æ£€å‡ºä»£ç é˜¶æ®µå¼€å§‹ ==='
                
                // æ£€å‡ºæºä»£ç 
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [[$class: 'LocalBranch']],
                    userRemoteConfigs: [[url: 'https://github.com/your-org/hello-world.git']]
                ])
                
                // æ˜¾ç¤ºæ£€å‡ºç»“æœ
                sh 'ls -la'
                echo '=== æ£€å‡ºä»£ç é˜¶æ®µå®Œæˆ ==='
            }
        }
        
        // æ„å»ºé˜¶æ®µ
        stage('Build') {
            steps {
                echo '=== æ„å»ºé˜¶æ®µå¼€å§‹ ==='
                
                // ä½¿ç”¨Mavenæ„å»º
                sh 'mvn clean compile'
                
                // æ£€æŸ¥æ„å»ºç»“æœ
                sh 'ls -la target/'
                echo '=== æ„å»ºé˜¶æ®µå®Œæˆ ==='
            }
        }
        
        // æµ‹è¯•é˜¶æ®µ
        stage('Test') {
            steps {
                echo '=== æµ‹è¯•é˜¶æ®µå¼€å§‹ ==='
                
                // è¿è¡Œå•å…ƒæµ‹è¯•
                sh 'mvn test'
                
                // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
                junit 'target/surefire-reports/*.xml'
                
                echo '=== æµ‹è¯•é˜¶æ®µå®Œæˆ ==='
            }
            
            // æµ‹è¯•é˜¶æ®µåå¤„ç†
            post {
                always {
                    echo 'æµ‹è¯•é˜¶æ®µæ‰§è¡Œå®Œæˆ'
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æµ‹è¯•æŠ¥å‘Šå‘å¸ƒç­‰æ“ä½œ
                }
                success {
                    echo 'æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼'
                }
                failure {
                    echo 'æœ‰æµ‹è¯•å¤±è´¥ï¼'
                }
            }
        }
        
        // æ‰“åŒ…é˜¶æ®µ
        stage('Package') {
            steps {
                echo '=== æ‰“åŒ…é˜¶æ®µå¼€å§‹ ==='
                
                // æ‰“åŒ…åº”ç”¨
                sh 'mvn package -DskipTests'
                
                // å­˜æ¡£æ„å»ºäº§ç‰©
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                
                echo '=== æ‰“åŒ…é˜¶æ®µå®Œæˆ ==='
            }
        }
    }
    
    // æ•´ä¸ªPipelineçš„åå¤„ç†
    post {
        // æ€»æ˜¯æ‰§è¡Œ
        always {
            echo '=== Pipelineæ‰§è¡Œå®Œæˆ ==='
            echo "æ„å»ºçŠ¶æ€: ${currentBuild.result ?: 'SUCCESS'}"
            echo "æ„å»ºURL: ${env.BUILD_URL}"
            
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
        }
        
        // æ„å»ºæˆåŠŸæ—¶æ‰§è¡Œ
        success {
            echo 'ğŸ‰ Pipelineæ‰§è¡ŒæˆåŠŸï¼'
            
            // å‘é€æˆåŠŸé€šçŸ¥ï¼ˆç¤ºä¾‹ï¼‰
            // mail to: 'team@company.com',
            //      subject: "æ„å»ºæˆåŠŸ: ${APP_NAME} ${VERSION}",
            //      body: "æ„å»º ${BUILD_NUMBER} æˆåŠŸå®Œæˆã€‚"
        }
        
        // æ„å»ºå¤±è´¥æ—¶æ‰§è¡Œ
        failure {
            echo 'âŒ Pipelineæ‰§è¡Œå¤±è´¥ï¼'
            
            // å‘é€å¤±è´¥é€šçŸ¥ï¼ˆç¤ºä¾‹ï¼‰
            // mail to: 'devops@company.com',
            //      subject: "æ„å»ºå¤±è´¥: ${APP_NAME} ${VERSION}",
            //      body: "æ„å»º ${BUILD_NUMBER} å¤±è´¥ã€‚è¯·æ£€æŸ¥æ—¥å¿—: ${env.BUILD_URL}"
        }
        
        // æ„å»ºä¸ç¨³å®šæ—¶æ‰§è¡Œ
        unstable {
            echo 'âš ï¸ Pipelineæ‰§è¡Œä¸ç¨³å®š'
        }
        
        // æ„å»ºè¢«ä¸­æ­¢æ—¶æ‰§è¡Œ
        aborted {
            echo 'â¹ï¸ Pipelineæ‰§è¡Œè¢«ä¸­æ­¢'
        }
    }
}