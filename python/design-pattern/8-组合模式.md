# ç¬¬8ç«  ç»„åˆæ¨¡å¼ (Composite Pattern)

## 1. ä»€ä¹ˆæ˜¯ç»„åˆæ¨¡å¼ï¼Ÿ

ç»„åˆæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸ä½ å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„æ¥è¡¨ç¤º"éƒ¨åˆ†-æ•´ä½“"çš„å±‚æ¬¡ç»“æ„ã€‚ç»„åˆæ¨¡å¼ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥ç»Ÿä¸€åœ°å¤„ç†å•ä¸ªå¯¹è±¡å’Œå¯¹è±¡ç»„åˆã€‚

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

- **ç»„ä»¶ (Component)**: å®šä¹‰ç»„åˆä¸­å¯¹è±¡çš„é€šç”¨æ¥å£
- **å¶å­èŠ‚ç‚¹ (Leaf)**: è¡¨ç¤ºç»„åˆä¸­çš„å¶å­å¯¹è±¡ï¼Œæ²¡æœ‰å­èŠ‚ç‚¹
- **å¤åˆèŠ‚ç‚¹ (Composite)**: è¡¨ç¤ºæœ‰å­ç»„ä»¶çš„å¤åˆå¯¹è±¡
- **é€’å½’ç»“æ„**: é€šè¿‡é€’å½’çš„æ–¹å¼å¤„ç†æ ‘å½¢ç»“æ„

### 1.2 ç°å®ä¸–ç•Œç±»æ¯”

æƒ³è±¡ä¸€ä¸ªå…¬å¸çš„ç»„ç»‡ç»“æ„ï¼š
- å…¬å¸ç”±å¤šä¸ªéƒ¨é—¨ç»„æˆ
- æ¯ä¸ªéƒ¨é—¨å¯èƒ½åŒ…å«å­éƒ¨é—¨æˆ–å‘˜å·¥
- æ— è®ºæ˜¯éƒ¨é—¨è¿˜æ˜¯å‘˜å·¥ï¼Œéƒ½å¯ä»¥æ‰§è¡ŒæŸäº›æ“ä½œï¼ˆå¦‚è®¡ç®—æ€»å·¥èµ„ï¼‰
- å®¢æˆ·ç«¯ä¸éœ€è¦åŒºåˆ†å¤„ç†çš„æ˜¯å•ä¸ªå‘˜å·¥è¿˜æ˜¯æ•´ä¸ªéƒ¨é—¨

## 2. ç»„åˆæ¨¡å¼çš„ç»“æ„

```python
Component
    â†³ Leaf
    â†³ Composite
        â†³ children: List[Component]
```

### 2.1 å‚ä¸è€…è§’è‰²

1. **Component (ç»„ä»¶)**: ä¸ºç»„åˆä¸­çš„å¯¹è±¡å£°æ˜æ¥å£ï¼Œåœ¨é€‚å½“æƒ…å†µä¸‹å®ç°æ‰€æœ‰ç±»å…±æœ‰æ¥å£çš„é»˜è®¤è¡Œä¸º
2. **Leaf (å¶å­)**: åœ¨ç»„åˆä¸­è¡¨ç¤ºå¶èŠ‚ç‚¹å¯¹è±¡ï¼Œå¶èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹
3. **Composite (å¤åˆ)**: å®šä¹‰æœ‰å­éƒ¨ä»¶çš„éƒ¨ä»¶è¡Œä¸ºï¼Œå­˜å‚¨å­éƒ¨ä»¶ï¼Œåœ¨Componentæ¥å£ä¸­å®ç°ä¸å­éƒ¨ä»¶æœ‰å…³çš„æ“ä½œ
4. **Client (å®¢æˆ·ç«¯)**: é€šè¿‡Componentæ¥å£æ“ä½œç»„åˆéƒ¨ä»¶çš„å¯¹è±¡

## 3. ç»„åˆæ¨¡å¼çš„å®ç°

### 3.1 åŸºç¡€å®ç°ç¤ºä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¾‹å­æ¥ç†è§£ç»„åˆæ¨¡å¼ï¼š

```python
from abc import ABC, abstractmethod
from typing import List

# ç»„ä»¶æ¥å£
class FileSystemComponent(ABC):
    @abstractmethod
    def display(self, indent=0):
        pass
    
    @abstractmethod
    def get_size(self):
        pass

# å¶å­èŠ‚ç‚¹ - æ–‡ä»¶
class File(FileSystemComponent):
    def __init__(self, name, size):
        self.name = name
        self.size = size
    
    def display(self, indent=0):
        print('  ' * indent + f"ğŸ“„ {self.name} ({self.size} bytes)")
    
    def get_size(self):
        return self.size

# å¤åˆèŠ‚ç‚¹ - æ–‡ä»¶å¤¹
class Folder(FileSystemComponent):
    def __init__(self, name):
        self.name = name
        self.children: List[FileSystemComponent] = []
    
    def add(self, component: FileSystemComponent):
        self.children.append(component)
    
    def remove(self, component: FileSystemComponent):
        self.children.remove(component)
    
    def display(self, indent=0):
        print('  ' * indent + f"ğŸ“ {self.name}")
        for child in self.children:
            child.display(indent + 1)
    
    def get_size(self):
        total_size = 0
        for child in self.children:
            total_size += child.get_size()
        return total_size
```

### 3.2 ä½¿ç”¨ç¤ºä¾‹

```python
# åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç»“æ„
root = Folder("æ ¹ç›®å½•")

# åˆ›å»ºå­æ–‡ä»¶å¤¹
documents = Folder("æ–‡æ¡£")
pictures = Folder("å›¾ç‰‡")

# åˆ›å»ºæ–‡ä»¶
file1 = File("readme.txt", 1024)
file2 = File("report.pdf", 2048)
file3 = File("photo1.jpg", 3072)
file4 = File("photo2.png", 4096)

# æ„å»ºæ–‡ä»¶ç³»ç»Ÿç»“æ„
root.add(file1)
root.add(documents)
root.add(pictures)

documents.add(file2)
pictures.add(file3)
pictures.add(file4)

# æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿç»“æ„
print("=== æ–‡ä»¶ç³»ç»Ÿç»“æ„ ===")
root.display()

# è®¡ç®—æ€»å¤§å°
print(f"\næ€»å¤§å°: {root.get_size()} bytes")
```

## 4. ç»„åˆæ¨¡å¼çš„ä¼˜åŠ¿

### 4.1 ä¼˜ç‚¹

1. **ç»Ÿä¸€å¤„ç†**: å®¢æˆ·ç«¯å¯ä»¥ä¸€è‡´åœ°å¤„ç†å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡
2. **ç®€åŒ–å®¢æˆ·ç«¯ä»£ç **: å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“å¤„ç†çš„æ˜¯å¶å­å¯¹è±¡è¿˜æ˜¯å¤åˆå¯¹è±¡
3. **æ˜“äºæ·»åŠ æ–°ç»„ä»¶**: å®¹æ˜“å¢åŠ æ–°ç±»å‹çš„ç»„ä»¶
4. **æ”¯æŒé€’å½’ç»“æ„**: å¤©ç„¶æ”¯æŒæ ‘å½¢ç»“æ„çš„é€’å½’æ“ä½œ

### 4.2 ç¼ºç‚¹

1. **è®¾è®¡è¾ƒå¤æ‚**: éœ€è¦è®¾è®¡ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œå¯èƒ½é™åˆ¶æŸäº›ç‰¹å®šæ“ä½œ
2. **ç±»å‹æ£€æŸ¥å›°éš¾**: åœ¨æŸäº›è¯­è¨€ä¸­éš¾ä»¥é™åˆ¶æŸäº›æ“ä½œåªé€‚ç”¨äºå¤åˆå¯¹è±¡
3. **æ€§èƒ½è€ƒè™‘**: é€’å½’æ“ä½œå¯èƒ½å¸¦æ¥æ€§èƒ½å¼€é”€

## 5. å®é™…åº”ç”¨åœºæ™¯

### 5.1 å›¾å½¢ç•Œé¢ç»„ä»¶

```python
from abc import ABC, abstractmethod
from typing import List

# GUIç»„ä»¶æ¥å£
class GUIComponent(ABC):
    @abstractmethod
    def render(self):
        pass
    
    @abstractmethod
    def add(self, component):
        pass
    
    @abstractmethod
    def remove(self, component):
        pass

# åŸºç¡€ç»„ä»¶ - æŒ‰é’®
class Button(GUIComponent):
    def __init__(self, text):
        self.text = text
    
    def render(self):
        print(f"[æŒ‰é’®] {self.text}")
    
    def add(self, component):
        raise NotImplementedError("æŒ‰é’®ä¸èƒ½æ·»åŠ å­ç»„ä»¶")
    
    def remove(self, component):
        raise NotImplementedError("æŒ‰é’®ä¸èƒ½ç§»é™¤å­ç»„ä»¶")

# åŸºç¡€ç»„ä»¶ - æ–‡æœ¬æ¡†
class TextBox(GUIComponent):
    def __init__(self, placeholder):
        self.placeholder = placeholder
    
    def render(self):
        print(f"[æ–‡æœ¬æ¡†] {self.placeholder}")
    
    def add(self, component):
        raise NotImplementedError("æ–‡æœ¬æ¡†ä¸èƒ½æ·»åŠ å­ç»„ä»¶")
    
    def remove(self, component):
        raise NotImplementedError("æ–‡æœ¬æ¡†ä¸èƒ½ç§»é™¤å­ç»„ä»¶")

# å¤åˆç»„ä»¶ - é¢æ¿
class Panel(GUIComponent):
    def __init__(self, title):
        self.title = title
        self.children: List[GUIComponent] = []
    
    def render(self):
        print(f"=== é¢æ¿: {self.title} ===")
        for child in self.children:
            child.render()
        print("=" * 20)
    
    def add(self, component):
        self.children.append(component)
    
    def remove(self, component):
        self.children.remove(component)

# ä½¿ç”¨ç¤ºä¾‹
login_panel = Panel("ç™»å½•é¢æ¿")

username_field = TextBox("è¯·è¾“å…¥ç”¨æˆ·å")
password_field = TextBox("è¯·è¾“å…¥å¯†ç ")
login_button = Button("ç™»å½•")

login_panel.add(username_field)
login_panel.add(password_field)
login_panel.add(login_button)

# æ¸²æŸ“æ•´ä¸ªç•Œé¢
login_panel.render()
```

### 5.2 ç»„ç»‡ç»“æ„ç®¡ç†

```python
from abc import ABC, abstractmethod
from typing import List

# ç»„ç»‡å•å…ƒæ¥å£
class OrganizationUnit(ABC):
    @abstractmethod
    def get_info(self):
        pass
    
    @abstractmethod
    def get_salary_cost(self):
        pass

# å¶å­èŠ‚ç‚¹ - å‘˜å·¥
class Employee(OrganizationUnit):
    def __init__(self, name, position, salary):
        self.name = name
        self.position = position
        self.salary = salary
    
    def get_info(self):
        return f"å‘˜å·¥: {self.name} ({self.position})"
    
    def get_salary_cost(self):
        return self.salary

# å¤åˆèŠ‚ç‚¹ - éƒ¨é—¨
class Department(OrganizationUnit):
    def __init__(self, name):
        self.name = name
        self.members: List[OrganizationUnit] = []
    
    def add_member(self, member: OrganizationUnit):
        self.members.append(member)
    
    def remove_member(self, member: OrganizationUnit):
        self.members.remove(member)
    
    def get_info(self):
        info = f"éƒ¨é—¨: {self.name}\n"
        for member in self.members:
            member_info = member.get_info()
            # æ·»åŠ ç¼©è¿›ä»¥æ˜¾ç¤ºå±‚æ¬¡ç»“æ„
            for line in member_info.split('\n'):
                info += f"  {line}\n"
        return info.strip()
    
    def get_salary_cost(self):
        total_cost = 0
        for member in self.members:
            total_cost += member.get_salary_cost()
        return total_cost

# ä½¿ç”¨ç¤ºä¾‹
# åˆ›å»ºå‘˜å·¥
alice = Employee("Alice", "è½¯ä»¶å·¥ç¨‹å¸ˆ", 8000)
bob = Employee("Bob", "å‰ç«¯å·¥ç¨‹å¸ˆ", 7000)
charlie = Employee("Charlie", "é¡¹ç›®ç»ç†", 10000)
david = Employee("David", "æµ‹è¯•å·¥ç¨‹å¸ˆ", 6000)

# åˆ›å»ºéƒ¨é—¨
technology_dept = Department("æŠ€æœ¯éƒ¨")
frontend_team = Department("å‰ç«¯å›¢é˜Ÿ")
backend_team = Department("åç«¯å›¢é˜Ÿ")

# æ„å»ºç»„ç»‡ç»“æ„
frontend_team.add_member(bob)
backend_team.add_member(alice)

technology_dept.add_member(frontend_team)
technology_dept.add_member(backend_team)
technology_dept.add_member(charlie)
technology_dept.add_member(david)

# æ˜¾ç¤ºç»„ç»‡ç»“æ„
print("=== ç»„ç»‡ç»“æ„ ===")
print(technology_dept.get_info())

# è®¡ç®—æ€»å·¥èµ„æˆæœ¬
print(f"\næ€»å·¥èµ„æˆæœ¬: ${technology_dept.get_salary_cost()}")
```

## 6. ç»„åˆæ¨¡å¼çš„å˜ä½“

### 6.1 é€æ˜å¼ç»„åˆæ¨¡å¼

åœ¨é€æ˜å¼ä¸­ï¼ŒComponentæ¥å£åŒ…å«æ‰€æœ‰ç®¡ç†å­ç»„ä»¶çš„æ–¹æ³•ï¼Œè¿™æ ·Leafå’ŒCompositeå…·æœ‰ç›¸åŒçš„æ¥å£ï¼š

```python
class TransparentComponent(ABC):
    @abstractmethod
    def operation(self):
        pass
    
    def add(self, component):
        pass  # å¶å­èŠ‚ç‚¹å¯ä»¥ç©ºå®ç°æˆ–æŠ›å‡ºå¼‚å¸¸
    
    def remove(self, component):
        pass  # å¶å­èŠ‚ç‚¹å¯ä»¥ç©ºå®ç°æˆ–æŠ›å‡ºå¼‚å¸¸
    
    def get_child(self, index):
        pass  # å¶å­èŠ‚ç‚¹å¯ä»¥ç©ºå®ç°æˆ–æŠ›å‡ºå¼‚å¸¸
```

### 6.2 å®‰å…¨å¼ç»„åˆæ¨¡å¼

åœ¨å®‰å…¨å¼ä¸­ï¼ŒComponentæ¥å£åªåŒ…å«å…¬å…±æ“ä½œï¼Œç®¡ç†å­ç»„ä»¶çš„æ–¹æ³•åªåœ¨Compositeä¸­å®šä¹‰ï¼š

```python
class SafeComponent(ABC):
    @abstractmethod
    def operation(self):
        pass

class SafeComposite(SafeComponent):
    def add(self, component):
        # åªæœ‰å¤åˆå¯¹è±¡æœ‰è¿™ä¸ªæ–¹æ³•
        pass
    
    def remove(self, component):
        # åªæœ‰å¤åˆå¯¹è±¡æœ‰è¿™ä¸ªæ–¹æ³•
        pass
```

## 7. ç»„åˆæ¨¡å¼ä¸ç›¸å…³æ¨¡å¼çš„æ¯”è¾ƒ

### 7.1 ç»„åˆæ¨¡å¼ vs è£…é¥°å™¨æ¨¡å¼

- **ç»„åˆæ¨¡å¼**: å¤„ç†éƒ¨åˆ†-æ•´ä½“å…³ç³»ï¼Œæ„å»ºæ ‘å½¢ç»“æ„
- **è£…é¥°å™¨æ¨¡å¼**: åŠ¨æ€åœ°ä¸ºå¯¹è±¡æ·»åŠ åŠŸèƒ½ï¼ŒåŒ…è£…å¯¹è±¡

### 7.2 ç»„åˆæ¨¡å¼ vs è¿­ä»£å™¨æ¨¡å¼

- **ç»„åˆæ¨¡å¼**: å®šä¹‰æ ‘å½¢ç»“æ„
- **è¿­ä»£å™¨æ¨¡å¼**: éå†é›†åˆå…ƒç´ ï¼Œå¸¸ä¸ç»„åˆæ¨¡å¼ä¸€èµ·ä½¿ç”¨

## 8. æœ€ä½³å®è·µ

### 8.1 ä½•æ—¶ä½¿ç”¨ç»„åˆæ¨¡å¼

1. **éƒ¨åˆ†-æ•´ä½“å±‚æ¬¡ç»“æ„**: éœ€è¦è¡¨ç¤ºå¯¹è±¡çš„éƒ¨åˆ†-æ•´ä½“å±‚æ¬¡ç»“æ„æ—¶
2. **ç»Ÿä¸€å¤„ç†**: å¸Œæœ›ç”¨æˆ·å¿½ç•¥ç»„åˆå¯¹è±¡ä¸å•ä¸ªå¯¹è±¡çš„ä¸åŒæ—¶
3. **æ ‘å½¢ç»“æ„**: å¤„ç†æ ‘å½¢ç»“æ„æ•°æ®æ—¶
4. **é€’å½’æ“ä½œ**: éœ€è¦å¯¹æ•´ä¸ªå±‚æ¬¡ç»“æ„æ‰§è¡Œé€’å½’æ“ä½œæ—¶

### 8.2 å®ç°å»ºè®®

1. **ä¿æŒæ¥å£ç®€å•**: Componentæ¥å£åº”è¯¥å°½å¯èƒ½ç®€å•
2. **å¤„ç†å¶å­èŠ‚ç‚¹æ“ä½œ**: ä¸ºå¶å­èŠ‚ç‚¹ä¸­ä¸é€‚ç”¨çš„æ–¹æ³•æä¾›åˆç†çš„é»˜è®¤å®ç°
3. **è€ƒè™‘ç¼“å­˜**: å¯¹äºæ˜‚è´µçš„æ“ä½œï¼ˆå¦‚è®¡ç®—æ€»å¤§å°ï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨ç¼“å­˜
4. **ä½¿ç”¨è¿­ä»£å™¨**: ç»“åˆè¿­ä»£å™¨æ¨¡å¼æ¥éå†ç»„åˆç»“æ„

## 9. æ€»ç»“

ç»„åˆæ¨¡å¼æ˜¯ä¸€ç§å¼ºå¤§çš„ç»“æ„å‹æ¨¡å¼ï¼Œå®ƒé€šè¿‡æ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºéƒ¨åˆ†-æ•´ä½“å…³ç³»ï¼Œä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥ç»Ÿä¸€å¤„ç†å•ä¸ªå¯¹è±¡å’Œå¯¹è±¡ç»„åˆã€‚è¿™ç§æ¨¡å¼ç‰¹åˆ«é€‚ç”¨äºä»¥ä¸‹æƒ…å†µï¼š

- éœ€è¦è¡¨ç¤ºå¯¹è±¡çš„å±‚æ¬¡ç»“æ„
- å¸Œæœ›å®¢æˆ·ç«¯ä»£ç èƒ½å¤Ÿä¸€è‡´åœ°å¤„ç†å¶å­å¯¹è±¡å’Œå¤åˆå¯¹è±¡
- éœ€è¦å¯¹æ•´ä¸ªç»“æ„æ‰§è¡Œé€’å½’æ“ä½œ
- éœ€è¦æ„å»ºå¤æ‚çš„åµŒå¥—ç»“æ„

é€šè¿‡ç»„åˆæ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºçµæ´»ã€å¯æ‰©å±•çš„å±‚æ¬¡ç»“æ„ï¼ŒåŒæ—¶ä¿æŒå®¢æˆ·ç«¯ä»£ç çš„ç®€æ´æ€§ã€‚