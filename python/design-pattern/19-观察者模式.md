# ç¬¬19ç« ï¼šè§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

## æ¦‚å¿µè§£æ

### ä»€ä¹ˆæ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Ÿ
è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚

### æ¨¡å¼ç»“æ„
- **Subjectï¼ˆä¸»é¢˜ï¼‰**ï¼šè¢«è§‚å¯Ÿçš„å¯¹è±¡ï¼Œç»´æŠ¤ä¸€ç»„è§‚å¯Ÿè€…ï¼Œæä¾›æ¥å£æ¥æ·»åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…
- **Observerï¼ˆè§‚å¯Ÿè€…ï¼‰**ï¼šä¸ºé‚£äº›åœ¨ç›®æ ‡å‘ç”Ÿæ”¹å˜æ—¶éœ€è·å¾—é€šçŸ¥çš„å¯¹è±¡å®šä¹‰ä¸€ä¸ªæ›´æ–°æ¥å£
- **ConcreteSubjectï¼ˆå…·ä½“ä¸»é¢˜ï¼‰**ï¼šå°†æœ‰å…³çŠ¶æ€å­˜å…¥å…·ä½“è§‚å¯Ÿè€…å¯¹è±¡ï¼Œåœ¨çŠ¶æ€æ”¹å˜æ—¶å‘è§‚å¯Ÿè€…å‘å‡ºé€šçŸ¥
- **ConcreteObserverï¼ˆå…·ä½“è§‚å¯Ÿè€…ï¼‰**ï¼šç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å…·ä½“ä¸»é¢˜å¯¹è±¡çš„å¼•ç”¨ï¼Œå­˜å‚¨æœ‰å…³çŠ¶æ€ï¼Œå®ç°æ›´æ–°æ¥å£

## åº”ç”¨åœºæ™¯
- å½“ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜éœ€è¦åŒæ—¶æ”¹å˜å…¶ä»–å¯¹è±¡ï¼Œè€Œä¸çŸ¥é“å…·ä½“æœ‰å¤šå°‘å¯¹è±¡éœ€è¦æ”¹å˜æ—¶
- å½“ä¸€ä¸ªå¯¹è±¡å¿…é¡»é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œè€Œå®ƒåˆä¸èƒ½å‡å®šå…¶ä»–å¯¹è±¡æ˜¯è°æ—¶
- éœ€è¦åœ¨ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªè§¦å‘é“¾æ—¶

## ä»£ç ç¤ºä¾‹

```python
from abc import ABC, abstractmethod
from typing import List

# è§‚å¯Ÿè€…æ¥å£
class Observer(ABC):
    @abstractmethod
    def update(self, subject: 'Subject'):
        pass

# ä¸»é¢˜æ¥å£
class Subject(ABC):
    def __init__(self):
        self._observers: List[Observer] = []
    
    def attach(self, observer: Observer):
        """æ·»åŠ è§‚å¯Ÿè€…"""
        if observer not in self._observers:
            self._observers.append(observer)
    
    def detach(self, observer: Observer):
        """ç§»é™¤è§‚å¯Ÿè€…"""
        if observer in self._observers:
            self._observers.remove(observer)
    
    def notify(self):
        """é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…"""
        for observer in self._observers:
            observer.update(self)

# å…·ä½“ä¸»é¢˜ - å¤©æ°”ç«™
class WeatherStation(Subject):
    def __init__(self):
        super().__init__()
        self._temperature = 0
        self._humidity = 0
        self._pressure = 0
    
    @property
    def temperature(self):
        return self._temperature
    
    @temperature.setter
    def temperature(self, value: float):
        self._temperature = value
        self.notify()  # æ¸©åº¦å˜åŒ–æ—¶é€šçŸ¥è§‚å¯Ÿè€…
    
    @property
    def humidity(self):
        return self._humidity
    
    @humidity.setter
    def humidity(self, value: float):
        self._humidity = value
        self.notify()  # æ¹¿åº¦å˜åŒ–æ—¶é€šçŸ¥è§‚å¯Ÿè€…
    
    @property
    def pressure(self):
        return self._pressure
    
    @pressure.setter
    def pressure(self, value: float):
        self._pressure = value
        self.notify()  # æ°”å‹å˜åŒ–æ—¶é€šçŸ¥è§‚å¯Ÿè€…

# å…·ä½“è§‚å¯Ÿè€… - æ‰‹æœºæ˜¾ç¤º
class PhoneDisplay(Observer):
    def __init__(self, name: str):
        self.name = name
    
    def update(self, subject: Subject):
        if isinstance(subject, WeatherStation):
            print(f"[{self.name}] æ¸©åº¦: {subject.temperature}Â°C, "
                  f"æ¹¿åº¦: {subject.humidity}%, æ°”å‹: {subject.pressure}hPa")

# å…·ä½“è§‚å¯Ÿè€… - ç”µè§†æ˜¾ç¤º
class TVDisplay(Observer):
    def __init__(self, name: str):
        self.name = name
    
    def update(self, subject: Subject):
        if isinstance(subject, WeatherStation):
            print(f"=== [{self.name}] å¤©æ°”æ’­æŠ¥ ===")
            print(f"å½“å‰æ¸©åº¦: {subject.temperature}Â°C")
            print(f"å½“å‰æ¹¿åº¦: {subject.humidity}%")
            print(f"å½“å‰æ°”å‹: {subject.pressure}hPa")
            print("=" * 30)

# å…·ä½“è§‚å¯Ÿè€… - è­¦æŠ¥ç³»ç»Ÿ
class AlertSystem(Observer):
    def __init__(self):
        self.temperature_threshold = 35
        self.humidity_threshold = 80
    
    def update(self, subject: Subject):
        if isinstance(subject, WeatherStation):
            alerts = []
            
            if subject.temperature > self.temperature_threshold:
                alerts.append(f"é«˜æ¸©è­¦æŠ¥! æ¸©åº¦: {subject.temperature}Â°C")
            
            if subject.humidity > self.humidity_threshold:
                alerts.append(f"é«˜æ¹¿è­¦æŠ¥! æ¹¿åº¦: {subject.humidity}%")
            
            if alerts:
                print("ğŸš¨ è­¦æŠ¥ç³»ç»Ÿ:", " | ".join(alerts))

# å®¢æˆ·ç«¯ä»£ç 
def main():
    # åˆ›å»ºå¤©æ°”ç«™
    weather_station = WeatherStation()
    
    # åˆ›å»ºè§‚å¯Ÿè€…
    phone1 = PhoneDisplay("æ‰‹æœº1")
    phone2 = PhoneDisplay("æ‰‹æœº2")
    tv = TVDisplay("æ–°é—»é¢‘é“")
    alert_system = AlertSystem()
    
    # æ³¨å†Œè§‚å¯Ÿè€…
    weather_station.attach(phone1)
    weather_station.attach(phone2)
    weather_station.attach(tv)
    weather_station.attach(alert_system)
    
    print("=== å¤©æ°”æ•°æ®å˜åŒ–æ¼”ç¤º ===\n")
    
    # æ¨¡æ‹Ÿå¤©æ°”æ•°æ®å˜åŒ–
    print("ç¬¬ä¸€æ¬¡æ›´æ–°:")
    weather_station.temperature = 25
    weather_station.humidity = 60
    weather_station.pressure = 1013
    
    print("\nç¬¬äºŒæ¬¡æ›´æ–°:")
    weather_station.temperature = 38  # è§¦å‘é«˜æ¸©è­¦æŠ¥
    weather_station.humidity = 85    # è§¦å‘é«˜æ¹¿è­¦æŠ¥
    
    print("\nç¬¬ä¸‰æ¬¡æ›´æ–°:")
    weather_station.temperature = 20
    weather_station.humidity = 50
    
    # ç§»é™¤ä¸€ä¸ªè§‚å¯Ÿè€…
    print("\nç§»é™¤æ‰‹æœº2è§‚å¯Ÿè€…åæ›´æ–°:")
    weather_station.detach(phone2)
    weather_station.temperature = 30

if __name__ == "__main__":
    main()
```

## Pythonå†…ç½®è§‚å¯Ÿè€…æ”¯æŒ

Pythonæä¾›äº†æ›´ç®€æ´çš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Pythonçš„ç‰¹æ€§ï¼š

```python
# ä½¿ç”¨Pythonå±æ€§è£…é¥°å™¨ç®€åŒ–è§‚å¯Ÿè€…æ¨¡å¼
class Observable:
    def __init__(self):
        self._observers = []
    
    def add_observer(self, observer):
        self._observers.append(observer)
    
    def remove_observer(self, observer):
        self._observers.remove(observer)
    
    def notify_observers(self, *args, **kwargs):
        for observer in self._observers:
            observer(*args, **kwargs)

# è‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿç¤ºä¾‹
class StockMarket:
    def __init__(self, symbol: str):
        self.symbol = symbol
        self._price = 0
        self.observable = Observable()
    
    @property
    def price(self):
        return self._price
    
    @price.setter
    def price(self, value: float):
        old_price = self._price
        self._price = value
        
        # é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ä»·æ ¼å˜åŒ–
        if old_price != value:
            self.observable.notify_observers(
                symbol=self.symbol,
                old_price=old_price,
                new_price=value,
                change=value - old_price,
                change_percent=((value - old_price) / old_price * 100) if old_price != 0 else 0
            )

# è§‚å¯Ÿè€…å‡½æ•°
def email_notifier(symbol, old_price, new_price, change, change_percent):
    if abs(change_percent) > 5:  # ä»·æ ¼å˜åŠ¨è¶…è¿‡5%
        direction = "ä¸Šæ¶¨" if change > 0 else "ä¸‹è·Œ"
        print(f"ğŸ“§ é‚®ä»¶é€šçŸ¥: {symbol} è‚¡ç¥¨{direction} {abs(change_percent):.1f}%")
        print(f"   ä» {old_price} å˜ä¸º {new_price}")

def sms_notifier(symbol, old_price, new_price, change, change_percent):
    if abs(change) > 10:  # ä»·æ ¼å˜åŠ¨è¶…è¿‡10å…ƒ
        direction = "â†‘" if change > 0 else "â†“"
        print(f"ğŸ“± SMSé€šçŸ¥: {symbol} {direction}{abs(change):.2f}å…ƒ")

def console_notifier(symbol, old_price, new_price, change, change_percent):
    direction = "+" if change > 0 else ""
    print(f"ğŸ“Š {symbol}: {old_price} -> {new_price} ({direction}{change_percent:.2f}%)")

# ä½¿ç”¨ç¤ºä¾‹
def stock_market_example():
    # åˆ›å»ºè‚¡ç¥¨å¸‚åœº
    apple_stock = StockMarket("AAPL")
    
    # æ³¨å†Œè§‚å¯Ÿè€…
    apple_stock.observable.add_observer(email_notifier)
    apple_stock.observable.add_observer(sms_notifier)
    apple_stock.observable.add_observer(console_notifier)
    
    print("=== è‚¡ç¥¨ä»·æ ¼å˜åŒ–æ¼”ç¤º ===\n")
    
    # æ¨¡æ‹Ÿä»·æ ¼å˜åŒ–
    apple_stock.price = 150
    apple_stock.price = 158  # ä¸Šæ¶¨è¶…è¿‡5%
    apple_stock.price = 145  # ä¸‹è·Œè¶…è¿‡10å…ƒ
    apple_stock.price = 142
    apple_stock.price = 155  # å¤§å¹…ä¸Šæ¶¨

if __name__ == "__main__":
    stock_market_example()
```

## å®é™…åº”ç”¨æ¡ˆä¾‹ï¼šäº‹ä»¶é©±åŠ¨ç³»ç»Ÿ

```python
# äº‹ä»¶é©±åŠ¨çš„è§‚å¯Ÿè€…æ¨¡å¼å®ç°
class Event:
    def __init__(self, name: str, data: dict = None):
        self.name = name
        self.data = data or {}
    
    def __str__(self):
        return f"Event({self.name}, {self.data})"

class EventBus:
    def __init__(self):
        self._subscribers = {}
    
    def subscribe(self, event_type: str, callback):
        """è®¢é˜…äº‹ä»¶"""
        if event_type not in self._subscribers:
            self._subscribers[event_type] = []
        self._subscribers[event_type].append(callback)
    
    def unsubscribe(self, event_type: str, callback):
        """å–æ¶ˆè®¢é˜…"""
        if event_type in self._subscribers:
            if callback in self._subscribers[event_type]:
                self._subscribers[event_type].remove(callback)
    
    def publish(self, event: Event):
        """å‘å¸ƒäº‹ä»¶"""
        event_type = event.name
        if event_type in self._subscribers:
            for callback in self._subscribers[event_type]:
                callback(event)

# å…·ä½“äº‹ä»¶å¤„ç†å™¨
class UserService:
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self._register_handlers()
    
    def _register_handlers(self):
        self.event_bus.subscribe("user_registered", self._on_user_registered)
        self.event_bus.subscribe("user_login", self._on_user_login)
    
    def register_user(self, username: str, email: str):
        """æ³¨å†Œç”¨æˆ·"""
        print(f"ç”¨æˆ·æœåŠ¡: æ³¨å†Œç”¨æˆ· {username}")
        
        # å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
        self.event_bus.publish(Event("user_registered", {
            "username": username,
            "email": email,
            "timestamp": "2024-01-01 10:00:00"
        }))
    
    def _on_user_registered(self, event: Event):
        print(f"ç”¨æˆ·æœåŠ¡: å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶ - {event.data['username']}")

class EmailService:
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self._register_handlers()
    
    def _register_handlers(self):
        self.event_bus.subscribe("user_registered", self._send_welcome_email)
        self.event_bus.subscribe("user_login", self._send_login_notification)
    
    def _send_welcome_email(self, event: Event):
        data = event.data
        print(f"é‚®ä»¶æœåŠ¡: å‘é€æ¬¢è¿é‚®ä»¶ç»™ {data['email']}")
    
    def _send_login_notification(self, event: Event):
        data = event.data
        print(f"é‚®ä»¶æœåŠ¡: å‘é€ç™»å½•é€šçŸ¥ç»™ {data['email']}")

class AnalyticsService:
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self._register_handlers()
    
    def _register_handlers(self):
        self.event_bus.subscribe("user_registered", self._track_registration)
        self.event_bus.subscribe("user_login", self._track_login)
    
    def _track_registration(self, event: Event):
        data = event.data
        print(f"åˆ†ææœåŠ¡: è·Ÿè¸ªç”¨æˆ·æ³¨å†Œ - {data['username']}")
    
    def _track_login(self, event: Event):
        data = event.data
        print(f"åˆ†ææœåŠ¡: è·Ÿè¸ªç”¨æˆ·ç™»å½• - {data['username']}")

# ä½¿ç”¨ç¤ºä¾‹
def event_driven_example():
    # åˆ›å»ºäº‹ä»¶æ€»çº¿
    event_bus = EventBus()
    
    # åˆ›å»ºæœåŠ¡
    user_service = UserService(event_bus)
    email_service = EmailService(event_bus)
    analytics_service = AnalyticsService(event_bus)
    
    print("=== äº‹ä»¶é©±åŠ¨ç³»ç»Ÿæ¼”ç¤º ===\n")
    
    # ç”¨æˆ·æ³¨å†Œï¼ˆè§¦å‘å¤šä¸ªäº‹ä»¶ï¼‰
    user_service.register_user("alice", "alice@example.com")
    
    # æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•äº‹ä»¶
    print("\næ¨¡æ‹Ÿç”¨æˆ·ç™»å½•:")
    event_bus.publish(Event("user_login", {
        "username": "alice",
        "email": "alice@example.com",
        "ip": "192.168.1.100"
    }))

if __name__ == "__main__":
    event_driven_example()
```

## æœ€ä½³å®è·µ

### ä¼˜ç‚¹
- æ”¯æŒå¹¿æ’­é€šä¿¡
- æŠ½è±¡äº†è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆ
- æ”¯æŒåŠ¨æ€æ·»åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…
- ç¬¦åˆå¼€é—­åŸåˆ™

### ç¼ºç‚¹
- å¦‚æœè§‚å¯Ÿè€…è¿‡å¤šï¼Œé€šçŸ¥å¯èƒ½èŠ±è´¹è¾ƒé•¿æ—¶é—´
- è§‚å¯Ÿè€…ä¹‹é—´å¯èƒ½å­˜åœ¨å¾ªç¯ä¾èµ–
- è§‚å¯Ÿè€…ä¸çŸ¥é“å½¼æ­¤çš„å­˜åœ¨ï¼Œå¯èƒ½å¯¼è‡´æ›´æ–°å†²çª

### é€‚ç”¨åœºæ™¯
- éœ€è¦å®ç°äº‹ä»¶å¤„ç†ç³»ç»Ÿ
- éœ€è¦å®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼
- å¯¹è±¡é—´çš„ä¾èµ–å…³ç³»éœ€è¦åŠ¨æ€å»ºç«‹
- ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜éœ€è¦å½±å“å…¶ä»–å¯¹è±¡

### æ³¨æ„äº‹é¡¹
- æ³¨æ„è§‚å¯Ÿè€…çš„æ‰§è¡Œé¡ºåº
- é¿å…åœ¨é€šçŸ¥è¿‡ç¨‹ä¸­ä¿®æ”¹è§‚å¯Ÿè€…åˆ—è¡¨
- è€ƒè™‘ä½¿ç”¨å¼‚æ­¥é€šçŸ¥æœºåˆ¶

## æ‰©å±•åº”ç”¨

è§‚å¯Ÿè€…æ¨¡å¼è¿˜å¯ä»¥åº”ç”¨äºï¼š
- GUIäº‹ä»¶å¤„ç†
- æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ
- å®æ—¶æ•°æ®æ¨é€
- å¾®æœåŠ¡æ¶æ„ä¸­çš„äº‹ä»¶é©±åŠ¨é€šä¿¡
- æ¸¸æˆå¼•æ“ä¸­çš„äº‹ä»¶ç³»ç»Ÿ