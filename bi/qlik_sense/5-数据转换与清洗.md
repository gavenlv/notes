# ç¬¬5ç« ï¼šæ•°æ®è½¬æ¢ä¸æ¸…æ´—

> **å­¦ä¹ æ—¶é•¿**: 10-12å°æ—¶  
> **éš¾åº¦**: â­â­â­  
> **å‰ç½®çŸ¥è¯†**: ç¬¬1-4ç« 

## æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« å,ä½ å°†èƒ½å¤Ÿ:

- âœ… æŒæ¡Qlikæ•°æ®æ¸…æ´—çš„æ ¸å¿ƒæŠ€æœ¯
- âœ… ç†Ÿç»ƒä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†å‡½æ•°
- âœ… å¤„ç†å¤æ‚çš„æ—¥æœŸæ—¶é—´æ•°æ®
- âœ… å®ç°æ•°æ®é€è§†å’Œé€†é€è§†è½¬æ¢
- âœ… æ„å»ºæ•°æ®è´¨é‡æ§åˆ¶ä½“ç³»
- âœ… å¤„ç†å±‚æ¬¡ç»“æ„æ•°æ®
- âœ… ä¼˜åŒ–æ•°æ®è½¬æ¢æ€§èƒ½

---

## 5.1 æ•°æ®æ¸…æ´—åŸºç¡€

### 5.1.1 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æ¸…æ´—?

**ç°å®ä¸­çš„æ•°æ®é—®é¢˜**:

```
åŸå§‹é”€å”®æ•°æ®:
è®¢å•ID | å®¢æˆ·å     | æ—¥æœŸ       | é‡‘é¢    | æ•°é‡
001   | å¼ ä¸‰      | 2024/1/1   | 1000   | 1
002   | æå››      | 2024-01-02 | 1,500  | 2
003   | ç‹äº”      | 2024.01.03 | 2000.0 | 3
004   |  å¼ ä¸‰  | 2024-1-4   | 800    | 1
005   | NULL     | 2024-01-05 |        | 2
```

**é—®é¢˜æ¸…å•**:
- âœ… æ—¥æœŸæ ¼å¼ä¸ä¸€è‡´
- âœ… æ•°å­—æ ¼å¼ä¸ç»Ÿä¸€  
- âœ… ç©ºå€¼å¤„ç†
- âœ… é‡å¤æ•°æ®
- âœ… å‰åç©ºæ ¼
- âœ… å¤§å°å†™ä¸ä¸€è‡´

### 5.1.2 æ•°æ®æ¸…æ´—åŸåˆ™

**æ¸…æ´—ç­–ç•¥**:

```qlik
// 1. é¢„é˜²ä¼˜äºæ²»ç–—
// åœ¨æ•°æ®æºå°±è§„èŒƒæ•°æ®æ ¼å¼

// 2. è®°å½•æ¸…æ´—è¿‡ç¨‹
// ä¿ç•™åŸå§‹æ•°æ®,åˆ›å»ºæ¸…æ´—åå­—æ®µ

// 3. å¯è¿½æº¯æ€§
// è®°å½•æ¸…æ´—è§„åˆ™å’Œå˜æ›´å†å²

// 4. è‡ªåŠ¨åŒ–
// å°†æ¸…æ´—é€»è¾‘å°è£…æˆå¯é‡ç”¨å‡½æ•°
```

**æ¸…æ´—æµç¨‹**:

```mermaid
graph LR
    A[åŸå§‹æ•°æ®] --> B[æ•°æ®æ¢æŸ¥]
    B --> C[é—®é¢˜è¯†åˆ«]
    C --> D[æ¸…æ´—è§„åˆ™å®šä¹‰]
    D --> E[æ¸…æ´—æ‰§è¡Œ]
    E --> F[è´¨é‡éªŒè¯]
    F --> G[æ¸…æ´—åæ•°æ®]
```

---

## 5.2 å­—ç¬¦ä¸²å¤„ç†

### 5.2.1 åŸºç¡€å­—ç¬¦ä¸²å‡½æ•°

**å¸¸ç”¨å­—ç¬¦ä¸²å‡½æ•°**:

```qlik
Customers:
LOAD
    OriginalName,
    // å»é™¤å‰åç©ºæ ¼
    Trim(OriginalName) as CleanName,
    
    // è½¬æ¢å¤§å°å†™
    Upper(OriginalName) as UpperName,
    Lower(OriginalName) as LowerName,
    Proper(OriginalName) as ProperName,  // é¦–å­—æ¯å¤§å†™
    
    // é•¿åº¦å¤„ç†
    Len(Trim(OriginalName)) as NameLength,
    
    // å­å­—ç¬¦ä¸²æå–
    Left(OriginalName, 3) as Left3Chars,
    Right(OriginalName, 3) as Right3Chars,
    Mid(OriginalName, 2, 5) as Middle5Chars
    
FROM customers.csv;

// ç¤ºä¾‹ç»“æœ:
// OriginalName: "  å¼ ä¸‰  "
// CleanName: "å¼ ä¸‰"
// UpperName: "  å¼ ä¸‰  " (ä¸­æ–‡æ— å¤§å°å†™)
// NameLength: 2
// Left3Chars: "  å¼ "
// Right3Chars: "ä¸‰  "
```

### 5.2.2 å­—ç¬¦ä¸²æ›¿æ¢

```qlik
// åŸºæœ¬æ›¿æ¢
Products:
LOAD
    ProductName,
    // æ›¿æ¢ç‰¹å®šå­—ç¬¦
    Replace(ProductName, 'æ—§', 'æ–°') as UpdatedName,
    
    // åˆ é™¤ä¸éœ€è¦çš„å­—ç¬¦
    Replace(ProductName, '_', '') as NoUnderscore,
    Replace(ProductName, ' ', '') as NoSpaces,
    
    // å¤šé‡æ›¿æ¢
    Replace(Replace(ProductName, '(', ''), ')', '') as NoParentheses
    
FROM products.csv;

// ä½¿ç”¨æ˜ å°„è¡¨æ›¿æ¢
// åˆ›å»ºæ›¿æ¢æ˜ å°„
MappingTable:
MAPPING LOAD * INLINE [
    æ—§å€¼, æ–°å€¼
    äº§å“A, å•†å“A
    äº§å“B, å•†å“B
    æ—§å‹å·, æ–°å‹å·
];

// åº”ç”¨æ˜ å°„
Products:
LOAD
    ProductName,
    ApplyMap('MappingTable', ProductName, ProductName) as MappedName
FROM products.csv;
```

### 5.2.3 å­—ç¬¦ä¸²åˆ†å‰²

```qlik
// åˆ†å‰²å­—ç¬¦ä¸²
Orders:
LOAD
    OrderInfo,
    // æŒ‰åˆ†éš”ç¬¦åˆ†å‰²
    SubField(OrderInfo, '|', 1) as OrderID,
    SubField(OrderInfo, '|', 2) as CustomerID,
    SubField(OrderInfo, '|', 3) as ProductID,
    SubField(OrderInfo, '|', 4) as Amount
    
FROM orders.csv;

// ç¤ºä¾‹æ•°æ®: "001|C001|P001|1000"
// ç»“æœ:
// OrderID: 001
// CustomerID: C001
// ProductID: P001
// Amount: 1000

// å¤æ‚åˆ†å‰²ç¤ºä¾‹
Addresses:
LOAD
    FullAddress,
    // åˆ†å‰²åœ°å€ç»„ä»¶
    SubField(FullAddress, ',', 1) as Province,
    SubField(FullAddress, ',', 2) as City,
    SubField(FullAddress, ',', 3) as District,
    SubField(FullAddress, ',', 4) as Street
    
FROM addresses.csv;

// å¤„ç†ä¸è§„åˆ™åˆ†å‰²
LOAD
    NameAge,
    // å¤„ç†"å¼ ä¸‰25å²"æ ¼å¼
    Left(NameAge, Len(NameAge)-3) as Name,  // å»æ‰æœ€å3ä¸ªå­—ç¬¦
    Right(NameAge, 2) as Age                // å–æœ€å2ä¸ªå­—ç¬¦
    
FROM name_age.csv;
```

### 5.2.4 å­—ç¬¦ä¸²åŒ¹é…

```qlik
// æ¨¡å¼åŒ¹é…
Sales:
LOAD
    ProductName,
    // ç²¾ç¡®åŒ¹é…
    IF(ProductName = 'ç¬”è®°æœ¬ç”µè„‘', 'ç”µè„‘ç±»', 'å…¶ä»–') as Category,
    
    // æ¨¡ç³ŠåŒ¹é…
    IF(Index(ProductName, 'ç”µè„‘') > 0, 'ç”µè„‘ç±»', 'å…¶ä»–') as FuzzyCategory,
    
    // é€šé…ç¬¦åŒ¹é…
    IF(WildMatch(ProductName, '*ç”µè„‘*', '*ç¬”è®°æœ¬*'), 'ç”µè„‘ç±»', 'å…¶ä»–') as WildCategory,
    
    // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… (Qlik Senseæ”¯æŒ)
    IF(ProductName LIKE '*[0-9]*', 'å«æ•°å­—', 'ä¸å«æ•°å­—') as NumberCheck
    
FROM sales.csv;
```

---

## 5.3 æ—¥æœŸæ—¶é—´å¤„ç†

### 5.3.1 æ—¥æœŸæ ¼å¼è½¬æ¢

**å¤„ç†å„ç§æ—¥æœŸæ ¼å¼**:

```qlik
// è®¾ç½®æ—¥æœŸæ ¼å¼
SET DateFormat='YYYY-MM-DD';
SET TimestampFormat='YYYY-MM-DD hh:mm:ss';

Orders:
LOAD
    OrderID,
    // åŸå§‹æ—¥æœŸå­—æ®µ
    RawDate,
    
    // è½¬æ¢ä¸åŒæ ¼å¼
    Date(Date#(RawDate, 'YYYY/MM/DD')) as StandardDate1,
    Date(Date#(RawDate, 'YYYY-MM-DD')) as StandardDate2,
    Date(Date#(RawDate, 'MM/DD/YYYY')) as StandardDate3,
    Date(Date#(RawDate, 'DD.MM.YYYY')) as StandardDate4,
    
    // æ—¶é—´æˆ³å¤„ç†
    Timestamp(Timestamp#(RawTimestamp, 'YYYY-MM-DD hh:mm:ss')) as StandardTimestamp
    
FROM orders_mixed_dates.csv;

// æ™ºèƒ½æ—¥æœŸè¯†åˆ«
LOAD
    RawDate,
    // è‡ªåŠ¨è¯†åˆ«æ—¥æœŸæ ¼å¼
    IF(IsNum(RawDate), 
       Date(RawDate), 
       Date(Date#(RawDate))) as AutoDate
FROM mixed_dates.csv;
```

### 5.3.2 æ—¥æœŸè®¡ç®—

```qlik
// æ—¥æœŸè®¡ç®—å’Œæå–
Orders:
LOAD
    OrderDate,
    DeliveryDate,
    
    // æ—¥æœŸç»„ä»¶æå–
    Year(OrderDate) as OrderYear,
    Month(OrderDate) as OrderMonth,
    Day(OrderDate) as OrderDay,
    Week(OrderDate) as OrderWeek,
    WeekDay(OrderDate) as OrderWeekDay,
    
    // å­£åº¦å’Œè´¢åŠ¡æœŸé—´
    Ceil(Month(OrderDate)/3) as OrderQuarter,
    IF(Month(OrderDate) >= 4, 
       Month(OrderDate) - 3, 
       Month(OrderDate) + 9) as FiscalMonth,
    
    // æ—¥æœŸè®¡ç®—
    OrderDate + 7 as OneWeekLater,
    AddMonths(OrderDate, 1) as OneMonthLater,
    AddYears(OrderDate, 1) as OneYearLater,
    
    // æ—¥æœŸå·®å¼‚
    DeliveryDate - OrderDate as DaysToDelivery,
    Interval(DeliveryDate - OrderDate, 'h') as HoursToDelivery,
    
    // ä¸šåŠ¡æ—¥è®¡ç®—
    NetworkDays(OrderDate, DeliveryDate) as BusinessDays
    
FROM orders_with_dates.csv;
```

### 5.3.3 æ—¥æœŸç»´åº¦è¡¨

```qlik
// åˆ›å»ºå®Œæ•´çš„æ—¥æœŸç»´åº¦è¡¨
SUB CreateDateDimension(vStartDate, vEndDate)
    
    LET vCurrentDate = Date(vStartDate);
    LET vEndDate = Date(vEndDate);
    
    DateDimension:
    LOAD
        Date($(vCurrentDate) + IterNo() - 1) as DateKey,
        Year(Date($(vCurrentDate) + IterNo() - 1)) as Year,
        Month(Date($(vCurrentDate) + IterNo() - 1)) as Month,
        Day(Date($(vCurrentDate) + IterNo() - 1)) as Day,
        Week(Date($(vCurrentDate) + IterNo() - 1)) as Week,
        WeekDay(Date($(vCurrentDate) + IterNo() - 1)) as WeekDay,
        // å­£åº¦
        'Q' & Ceil(Month(Date($(vCurrentDate) + IterNo() - 1))/3) as Quarter,
        // è´¢åŠ¡å­£åº¦ (å‡è®¾4æœˆå¼€å§‹)
        'FQ' & Ceil(IF(Month(Date($(vCurrentDate) + IterNo() - 1)) >= 4,
                      Month(Date($(vCurrentDate) + IterNo() - 1)) - 3,
                      Month(Date($(vCurrentDate) + IterNo() - 1)) + 9)/3) as FiscalQuarter,
        // æ˜¯å¦å·¥ä½œæ—¥
        IF(WeekDay(Date($(vCurrentDate) + IterNo() - 1)) < 5, 'æ˜¯', 'å¦') as IsWorkDay,
        // æ˜¯å¦å‘¨æœ«
        IF(WeekDay(Date($(vCurrentDate) + IterNo() - 1)) >= 5, 'æ˜¯', 'å¦') as IsWeekend
    AUTOGENERATE ($(vEndDate) - $(vCurrentDate) + 1);
    
END SUB

// åˆ›å»º10å¹´æ—¥æœŸç»´åº¦
LET vStartDate = Date(MakeDate(2020, 1, 1));
LET vEndDate = Date(MakeDate(2029, 12, 31));

CALL CreateDateDimension(vStartDate, vEndDate);
```

---

## 5.4 æ•°å€¼å¤„ç†

### 5.4.1 æ•°å€¼æ ¼å¼åŒ–

```qlik
// æ•°å€¼å¤„ç†å’Œæ ¼å¼åŒ–
Sales:
LOAD
    RawAmount,
    RawQuantity,
    
    // æ•°å€¼è½¬æ¢
    Num(RawAmount) as CleanAmount,
    Num(RawQuantity) as CleanQuantity,
    
    // æ ¼å¼åŒ–æ˜¾ç¤º
    Num(RawAmount, '#,##0.00') as FormattedAmount,
    Num(RawAmount, 'Â¥#,##0.00') as CurrencyAmount,
    Num(RawAmount, '#,##0.00%', '', '.') as PercentageAmount,
    
    // å››èˆäº”å…¥
    Round(RawAmount, 0.01) as RoundedAmount,
    Round(RawAmount, 100) as RoundedTo100,
    
    // å–æ•´
    Floor(RawAmount) as FloorAmount,
    Ceil(RawAmount) as CeilAmount,
    
    // ç»å¯¹å€¼å’Œç¬¦å·
    Abs(RawAmount) as AbsoluteAmount,
    IF(RawAmount >= 0, 'æ­£æ•°', 'è´Ÿæ•°') as SignIndicator
    
FROM sales_with_decimals.csv;
```

### 5.4.2 æ•°å€¼è®¡ç®—

```qlik
// å¤æ‚æ•°å€¼è®¡ç®—
Orders:
LOAD
    Quantity,
    UnitPrice,
    DiscountRate,
    
    // åŸºç¡€è®¡ç®—
    Quantity * UnitPrice as SubTotal,
    Quantity * UnitPrice * (1 - DiscountRate) as NetAmount,
    
    // ç´¯è®¡è®¡ç®—
    Rangesum(Above(Sum(Quantity * UnitPrice), 0, RowNo())) as RunningTotal,
    
    // æ’åè®¡ç®—
    Rank(Sum(Quantity * UnitPrice)) as SalesRank,
    
    // ç™¾åˆ†æ¯”è®¡ç®—
    (Sum(Quantity * UnitPrice) / Sum(Total Quantity * UnitPrice)) * 100 as PercentOfTotal,
    
    // å·®å¼‚è®¡ç®—
    Sum(Quantity * UnitPrice) - Above(Sum(Quantity * UnitPrice)) as PeriodChange,
    (Sum(Quantity * UnitPrice) / Above(Sum(Quantity * UnitPrice)) - 1) * 100 as GrowthRate
    
FROM order_details.csv
GROUP BY OrderID;
```

---

## 5.5 æ•°æ®é€è§†ä¸é€†é€è§†

### 5.5.1 é€†é€è§†(Generic Load)

**å°†åˆ—è½¬æ¢ä¸ºè¡Œ**:

```qlik
// åŸå§‹æ•°æ®(å®½è¡¨):
// æœˆä»½ | äº§å“A | äº§å“B | äº§å“C
// 1æœˆ  | 100   | 200   | 300
// 2æœˆ  | 150   | 250   | 350

// é€†é€è§†è½¬æ¢
SalesPivot:
GENERIC LOAD
    æœˆä»½,
    *
FROM sales_wide.csv;

// åˆå¹¶æ‰€æœ‰ç”Ÿæˆçš„è¡¨
FOR i = 0 TO NoOfTables() - 1
    LET vTableName = TableName(i);
    IF WildMatch(vTableName, 'SalesPivot.*') THEN
        IF i = 0 THEN
            SalesLong:
            LOAD * RESIDENT [$(vTableName)];
        ELSE
            CONCATENATE (SalesLong)
            LOAD * RESIDENT [$(vTableName)];
        END IF
        DROP Table [$(vTableName)];
    END IF
NEXT i

// æœ€ç»ˆç»“æœ(é•¿è¡¨):
// æœˆä»½ | äº§å“  | é”€å”®é¢
// 1æœˆ  | äº§å“A | 100
// 1æœˆ  | äº§å“B | 200
// 1æœˆ  | äº§å“C | 300
// 2æœˆ  | äº§å“A | 150
// 2æœˆ  | äº§å“B | 250
// 2æœˆ  | äº§å“C | 350
```

### 5.5.2 æ‰‹åŠ¨é€†é€è§†

```qlik
// æ‰‹åŠ¨é€†é€è§†å®ç°
SalesWide:
LOAD * FROM sales_wide.csv;

// é€åˆ—è½¬æ¢
SalesLong:
LOAD
    æœˆä»½,
    'äº§å“A' as äº§å“,
    äº§å“A as é”€å”®é¢
RESIDENT SalesWide;

CONCATENATE (SalesLong)
LOAD
    æœˆä»½,
    'äº§å“B' as äº§å“,
    äº§å“B as é”€å”®é¢
RESIDENT SalesWide;

CONCATENATE (SalesLong)
LOAD
    æœˆä»½,
    'äº§å“C' as äº§å“,
    äº§å“C as é”€å”®é¢
RESIDENT SalesWide;

DROP Table SalesWide;
```

### 5.5.3 é€è§†è½¬æ¢

**å°†è¡Œè½¬æ¢ä¸ºåˆ—**:

```qlik
// åŸå§‹æ•°æ®(é•¿è¡¨):
// æœˆä»½ | äº§å“  | é”€å”®é¢
// 1æœˆ  | äº§å“A | 100
// 1æœˆ  | äº§å“B | 200
// 2æœˆ  | äº§å“A | 150
// 2æœˆ  | äº§å“B | 250

// é€è§†è½¬æ¢
SalesPivot:
LOAD
    æœˆä»½,
    Sum(IF(äº§å“ = 'äº§å“A', é”€å”®é¢)) as äº§å“A,
    Sum(IF(äº§å“ = 'äº§å“B', é”€å”®é¢)) as äº§å“B,
    Sum(IF(äº§å“ = 'äº§å“C', é”€å”®é¢)) as äº§å“C
RESIDENT SalesLong
GROUP BY æœˆä»½;
```

---

## 5.6 æ•°æ®è´¨é‡æ§åˆ¶

### 5.6.1 æ•°æ®éªŒè¯

```qlik
// æ•°æ®è´¨é‡æ£€æŸ¥
DataQualityCheck:
LOAD
    *,
    // ç©ºå€¼æ£€æŸ¥
    IF(Len(Trim(CustomerName)) = 0 OR IsNull(CustomerName), 1, 0) as IsCustomerNameEmpty,
    IF(IsNull(Amount) OR Amount = '', 1, 0) as IsAmountEmpty,
    
    // æ ¼å¼æ£€æŸ¥
    IF(IsNum(Amount), 0, 1) as IsAmountInvalid,
    IF(Len(OrderDate) = 10 AND IsNum(Date#(OrderDate, 'YYYY-MM-DD')), 0, 1) as IsDateInvalid,
    
    // èŒƒå›´æ£€æŸ¥
    IF(Amount < 0, 1, 0) as IsAmountNegative,
    IF(Quantity <= 0, 1, 0) as IsQuantityInvalid,
    
    // é‡å¤æ£€æŸ¥
    IF(Exists(OrderID, OrderID), 1, 0) as IsOrderIDDuplicate,
    
    // ä¸€è‡´æ€§æ£€æŸ¥
    IF(CustomerType = 'VIP' AND Amount < 1000, 1, 0) as IsVIPInconsistent
    
FROM raw_sales_data.csv;

// æ±‡æ€»è´¨é‡æ£€æŸ¥ç»“æœ
QualitySummary:
LOAD
    'CustomerNameç©ºå€¼' as CheckType,
    Sum(IsCustomerNameEmpty) as ErrorCount
RESIDENT DataQualityCheck;

CONCATENATE (QualitySummary)
LOAD
    'é‡‘é¢ç©ºå€¼' as CheckType,
    Sum(IsAmountEmpty) as ErrorCount
RESIDENT DataQualityCheck;

CONCATENATE (QualitySummary)
LOAD
    'é‡‘é¢æ ¼å¼é”™è¯¯' as CheckType,
    Sum(IsAmountInvalid) as ErrorCount
RESIDENT DataQualityCheck;
```

### 5.6.2 æ•°æ®æ¸…æ´—è§„åˆ™

```qlik
// å®šä¹‰æ¸…æ´—è§„åˆ™è¡¨
CleaningRules:
LOAD * INLINE [
    RuleID, RuleName, RuleCondition, Action
    1, ç©ºå®¢æˆ·åå¤„ç†, Len(Trim(CustomerName)) = 0, è®¾ç½®ä¸º'æœªçŸ¥å®¢æˆ·'
    2, è´Ÿé‡‘é¢å¤„ç†, Amount < 0, è®¾ç½®ä¸º0
    3, ç©ºæ—¥æœŸå¤„ç†, IsNull(OrderDate), è®¾ç½®ä¸ºä»Šå¤©
    4, é‡‘é¢æ ¼å¼åŒ–, IsNum(Amount), ä¿ç•™ä¸¤ä½å°æ•°
];

// åº”ç”¨æ¸…æ´—è§„åˆ™
CleanedData:
LOAD
    OrderID,
    // åº”ç”¨å®¢æˆ·åæ¸…æ´—è§„åˆ™
    IF(Len(Trim(CustomerName)) = 0, 'æœªçŸ¥å®¢æˆ·', CustomerName) as CleanCustomerName,
    
    // åº”ç”¨é‡‘é¢æ¸…æ´—è§„åˆ™
    IF(Amount < 0, 0, Num(Amount, '#,##0.00')) as CleanAmount,
    
    // åº”ç”¨æ—¥æœŸæ¸…æ´—è§„åˆ™
    IF(IsNull(OrderDate), Today(), Date(OrderDate)) as CleanOrderDate,
    
    // å…¶ä»–å­—æ®µ
    ProductID,
    Quantity
    
FROM raw_data.csv;
```

---

## 5.7 å±‚æ¬¡ç»“æ„å¤„ç†

### 5.7.1 ç»„ç»‡æ¶æ„å¤„ç†

```qlik
// ç»„ç»‡æ¶æ„å±‚æ¬¡
Organization:
LOAD
    EmployeeID,
    EmployeeName,
    ManagerID,
    Department,
    Level,
    
    // åˆ›å»ºå±‚æ¬¡è·¯å¾„
    EmployeeID & 
    IF(ManagerID <> '', '/' & ManagerID) & 
    IF(Department <> '', '/' & Department) as OrgPath,
    
    // å±‚çº§æ ‡ç­¾
    IF(Level = 1, 'æ€»éƒ¨',
       IF(Level = 2, 'éƒ¨é—¨',
          IF(Level = 3, 'å›¢é˜Ÿ', 'å‘˜å·¥'))) as LevelLabel
          
FROM organization.csv;

// é€’å½’æŸ¥æ‰¾ä¸Šçº§
SUB FindHierarchy(vEmployeeID, vLevel)
    
    // æŸ¥æ‰¾ç›´æ¥ä¸Šçº§
    ManagerData:
    LOAD
        ManagerID,
        EmployeeName as ManagerName
    FROM organization.csv
    WHERE EmployeeID = '$(vEmployeeID)';
    
    IF NoOfRows('ManagerData') > 0 THEN
        LET vManagerID = Peek('ManagerID', 0, 'ManagerData');
        LET vManagerName = Peek('ManagerName', 0, 'ManagerData');
        
        // å­˜å‚¨å±‚çº§ä¿¡æ¯
        CONCATENATE (HierarchyResult)
        LOAD
            '$(vEmployeeID)' as EmployeeID,
            $(vLevel) as HierarchyLevel,
            '$(vManagerName)' as ManagerName
        AUTOGENERATE 1;
        
        DROP Table ManagerData;
        
        // é€’å½’æŸ¥æ‰¾æ›´ä¸Šçº§
        IF vLevel < 5 AND Len('$(vManagerID)') > 0 THEN
            CALL FindHierarchy(vManagerID, vLevel + 1);
        END IF
    END IF
    
END SUB
```

### 5.7.2 åœ°ç†å±‚æ¬¡å¤„ç†

```qlik
// åœ°ç†å±‚æ¬¡ç»“æ„
Geography:
LOAD
    CityCode,
    CityName,
    ProvinceCode,
    ProvinceName,
    CountryCode,
    CountryName,
    
    // åˆ›å»ºåœ°ç†è·¯å¾„
    CountryName & 
    IF(ProvinceName <> '', '/' & ProvinceName) & 
    IF(CityName <> '', '/' & CityName) as GeoPath,
    
    // å±‚çº§ç¼–ç 
    CountryCode as Level1Code,
    CountryCode & ProvinceCode as Level2Code,
    CountryCode & ProvinceCode & CityCode as Level3Code
    
FROM geography.csv;

// åœ°ç†èšåˆ
GeoAggregation:
LOAD
    CountryName,
    Count(DISTINCT ProvinceCode) as ProvinceCount,
    Count(DISTINCT CityCode) as CityCount,
    Sum(SalesAmount) as TotalSales,
    Avg(SalesAmount) as AvgSales
RESIDENT GeographyData
GROUP BY CountryName;
```

---

## 5.8 æ€§èƒ½ä¼˜åŒ–

### 5.8.1 è½¬æ¢æ€§èƒ½ä¼˜åŒ–

```qlik
// âŒ ä½æ•ˆå†™æ³•
FOR i = 1 TO NoOfRows('LargeTable')
    LET vFieldValue = Peek('FieldName', i-1, 'LargeTable');
    // å¤æ‚å¤„ç†...
NEXT i

// âœ… é«˜æ•ˆå†™æ³•
OptimizedTable:
LOAD
    FieldName,
    // æ‰¹é‡å¤„ç†å‡½æ•°
    Upper(FieldName) as UpperField,
    Len(FieldName) as FieldLength,
    IF(FieldName LIKE '*VIP*', 'é‡è¦', 'æ™®é€š') as Category
RESIDENT LargeTable;
```

### 5.8.2 å†…å­˜ä¼˜åŒ–

```qlik
// åŠæ—¶é‡Šæ”¾ä¸´æ—¶è¡¨
TempProcessing:
LOAD * FROM large_dataset.csv;

// å¤„ç†æ•°æ®
FinalResult:
LOAD 
    KeyField,
    CriticalField1,
    CriticalField2
RESIDENT TempProcessing;

// ç«‹å³é‡Šæ”¾ä¸´æ—¶è¡¨
DROP Table TempProcessing;

// ä½¿ç”¨å­—æ®µåˆ«åå‡å°‘å†…å­˜
SalesData:
LOAD
    OrderID as ID,           // çŸ­åˆ«å
    CustomerID as CustID,
    ProductID as ProdID,
    Num(Amount) as SalesAmt  // æ•°æ®ç±»å‹ä¼˜åŒ–
FROM sales.csv;
```

---

## 5.9 å®éªŒ:ç»¼åˆæ•°æ®æ¸…æ´—

### å®éªŒ1: å®¢æˆ·æ•°æ®æ¸…æ´—ç³»ç»Ÿ

```qlik
///$tab å®¢æˆ·æ•°æ®æ¸…æ´—

// åŸå§‹å®¢æˆ·æ•°æ®(åŒ…å«å„ç§é—®é¢˜)
RawCustomers:
LOAD
    CustomerID,
    CustomerName,
    PhoneNumber,
    Email,
    Address,
    RegistrationDate,
    Status
FROM [lib://Data/raw_customers.csv] (txt);

// æ•°æ®æ¸…æ´—è§„åˆ™
CustomerCleaning:
LOAD
    CustomerID,
    
    // å®¢æˆ·åæ¸…æ´—
    IF(Len(Trim(CustomerName)) = 0, 'æœªçŸ¥å®¢æˆ·',
       Proper(Trim(CustomerName))) as CleanCustomerName,
    
    // ç”µè¯å·ç æ¸…æ´—
    IF(Len(Trim(PhoneNumber)) = 0, 'æ— ',
       KeepChar(PhoneNumber, '0123456789')) as CleanPhoneNumber,
    
    // é‚®ç®±æ¸…æ´—
    IF(Index(Email, '@') > 0 AND Index(Email, '.') > 0,
       Lower(Trim(Email)),
       'æ— æ•ˆé‚®ç®±') as CleanEmail,
    
    // åœ°å€æ¸…æ´—
    IF(Len(Trim(Address)) = 0, 'åœ°å€æœªçŸ¥',
       Trim(Address)) as CleanAddress,
    
    // æ—¥æœŸæ¸…æ´—
    IF(Len(Trim(RegistrationDate)) = 10 AND 
       IsNum(Date#(RegistrationDate, 'YYYY-MM-DD')),
       Date(Date#(RegistrationDate, 'YYYY-MM-DD')),
       Null()) as CleanRegistrationDate,
    
    // çŠ¶æ€æ ‡å‡†åŒ–
    IF(WildMatch(Upper(Status), '*ACTIVE*', '*å¯ç”¨*'), 'æ´»è·ƒ',
       IF(WildMatch(Upper(Status), '*INACTIVE*', '*åœç”¨*'), 'åœç”¨',
          'æœªçŸ¥')) as CleanStatus,
    
    // è´¨é‡æ ‡è®°
    IF(Len(Trim(CustomerName)) = 0 OR 
       Index(Email, '@') <= 0 OR
       Len(Trim(RegistrationDate)) <> 10, 1, 0) as HasQualityIssues
    
RESIDENT RawCustomers;

// è´¨é‡æŠ¥å‘Š
QualityReport:
LOAD
    'ç©ºå®¢æˆ·å' as IssueType,
    Count(*) as IssueCount
RESIDENT CustomerCleaning
WHERE Len(CleanCustomerName) = 0;

CONCATENATE (QualityReport)
LOAD
    'æ— æ•ˆé‚®ç®±' as IssueType,
    Count(*) as IssueCount
RESIDENT CustomerCleaning
WHERE CleanEmail = 'æ— æ•ˆé‚®ç®±';

CONCATENATE (QualityReport)
LOAD
    'æ—¥æœŸæ ¼å¼é”™è¯¯' as IssueType,
    Count(*) as IssueCount
RESIDENT CustomerCleaning
WHERE IsNull(CleanRegistrationDate);

// æ¸…ç†ä¸´æ—¶è¡¨
DROP Table RawCustomers;
```

### å®éªŒ2: é”€å”®æ•°æ®æ ‡å‡†åŒ–

```qlik
///$tab é”€å”®æ•°æ®æ ‡å‡†åŒ–

// å¤šæºé”€å”®æ•°æ®æ•´åˆ
SalesMultiSource:
LOAD
    OrderID,
    CustomerInfo,
    ProductDetails,
    OrderAmount,
    OrderDate
FROM [lib://Data/sales_source1.csv] (txt);

CONCATENATE (SalesMultiSource)
LOAD
    'SRC2_' & OrderID as OrderID,
    CustomerName & '|' & CustomerCity as CustomerInfo,
    ProductName & '|' & Category as ProductDetails,
    SalesAmount as OrderAmount,
    Date(OrderDate) as OrderDate
FROM [lib://Data/sales_source2.csv] (txt);

// æ ‡å‡†åŒ–å¤„ç†
StandardizedSales:
LOAD
    OrderID,
    
    // å®¢æˆ·ä¿¡æ¯åˆ†ç¦»
    SubField(CustomerInfo, '|', 1) as CustomerName,
    SubField(CustomerInfo, '|', 2) as CustomerCity,
    
    // äº§å“ä¿¡æ¯åˆ†ç¦»
    SubField(ProductDetails, '|', 1) as ProductName,
    SubField(ProductDetails, '|', 2) as ProductCategory,
    
    // é‡‘é¢æ ‡å‡†åŒ–
    Num(OrderAmount, '#,##0.00') as StandardAmount,
    
    // æ—¥æœŸæ ‡å‡†åŒ–
    Date(Floor(OrderDate)) as StandardDate,
    
    // æ·»åŠ è®¡ç®—å­—æ®µ
    Year(OrderDate) as OrderYear,
    Month(OrderDate) as OrderMonth,
    'Q' & Ceil(Month(OrderDate)/3) as OrderQuarter
    
RESIDENT SalesMultiSource;

// æ•°æ®éªŒè¯
DataValidation:
LOAD
    *,
    // ç©ºå€¼æ£€æŸ¥
    IF(IsNull(CustomerName) OR Len(Trim(CustomerName)) = 0, 1, 0) as IsCustomerEmpty,
    IF(IsNull(OrderAmount) OR OrderAmount <= 0, 1, 0) as IsAmountInvalid,
    // é‡å¤æ£€æŸ¥
    IF(Exists(OrderID, OrderID), 1, 0) as IsDuplicate
    
RESIDENT StandardizedSales;

// ç”ŸæˆéªŒè¯æŠ¥å‘Š
ValidationReport:
LOAD
    'ç©ºå®¢æˆ·å' as ValidationType,
    Sum(IsCustomerEmpty) as ErrorCount
RESIDENT DataValidation;

CONCATENATE (ValidationReport)
LOAD
    'æ— æ•ˆé‡‘é¢' as ValidationType,
    Sum(IsAmountInvalid) as ErrorCount
RESIDENT DataValidation;

CONCATENATE (ValidationReport)
LOAD
    'é‡å¤è®¢å•' as ValidationType,
    Sum(IsDuplicate) as ErrorCount
RESIDENT DataValidation;

DROP Table SalesMultiSource;
```

---

## 5.10 è¯¾åç»ƒä¹ 

### ç»ƒä¹ 1: å­—ç¬¦ä¸²å¤„ç†

**ä»»åŠ¡**: å¤„ç†åŒ…å«å„ç§é—®é¢˜çš„äº§å“åç§°
- å»é™¤å‰åç©ºæ ¼
- ç»Ÿä¸€å¤§å°å†™æ ¼å¼
- æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
- æ ‡å‡†åŒ–äº§å“åˆ†ç±»

### ç»ƒä¹ 2: æ—¥æœŸæ—¶é—´è½¬æ¢

**ä»»åŠ¡**: å¤„ç†å¤šç§æ—¥æœŸæ ¼å¼çš„è®¢å•æ•°æ®
- è¯†åˆ«å¹¶è½¬æ¢ä¸åŒæ—¥æœŸæ ¼å¼
- è®¡ç®—è®¢å•å¤„ç†æ—¶é—´
- åˆ›å»ºæ—¥æœŸç»´åº¦è¡¨
- åˆ†æå­£èŠ‚æ€§è¶‹åŠ¿

### ç»ƒä¹ 3: æ•°æ®è´¨é‡æ§åˆ¶

**ä»»åŠ¡**: å»ºç«‹å®Œæ•´çš„æ•°æ®è´¨é‡æ£€æŸ¥ä½“ç³»
- è®¾è®¡è´¨é‡æ£€æŸ¥è§„åˆ™
- å®ç°è‡ªåŠ¨åŒ–éªŒè¯
- ç”Ÿæˆè´¨é‡æŠ¥å‘Š
- å¤„ç†å¼‚å¸¸æ•°æ®

---

## 5.11 æœ¬ç« å°ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

âœ… **å­—ç¬¦ä¸²å¤„ç†**: Trim, Upper, Replace, SubField  
âœ… **æ—¥æœŸæ—¶é—´**: Date#, Date, æ—¶é—´è®¡ç®—  
âœ… **æ•°å€¼å¤„ç†**: Num, Round, æ ¼å¼åŒ–  
âœ… **æ•°æ®é€è§†**: Generic Load, æ‰‹åŠ¨è½¬æ¢  
âœ… **è´¨é‡æ§åˆ¶**: ç©ºå€¼æ£€æŸ¥, æ ¼å¼éªŒè¯, èŒƒå›´æ£€æŸ¥  
âœ… **å±‚æ¬¡ç»“æ„**: ç»„ç»‡æ¶æ„, åœ°ç†å±‚æ¬¡  
âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡å¤„ç†, å†…å­˜ç®¡ç†  

### å…³é”®å‡½æ•°

```qlik
// å­—ç¬¦ä¸²
Trim(), Upper(), Lower(), Proper()
Replace(), SubField(), Len()
Index(), WildMatch()

// æ—¥æœŸæ—¶é—´
Date(), Time(), Timestamp()
Year(), Month(), Day()
Date#(), Time#(), Timestamp#()
AddMonths(), AddYears()

// æ•°å€¼
Num(), Round(), Floor(), Ceil()
Abs(), Sign()

// èšåˆ
Sum(), Count(), Avg()
Above(), Below()
Rangesum()
```

### æœ€ä½³å®è·µ

1. **ä¿ç•™åŸå§‹æ•°æ®**: æ¸…æ´—æ—¶åˆ›å»ºæ–°å­—æ®µ
2. **æ ‡å‡†åŒ–å¤„ç†**: å»ºç«‹ç»Ÿä¸€çš„æ•°æ®æ ‡å‡†
3. **è‡ªåŠ¨åŒ–éªŒè¯**: å®ç°æ•°æ®è´¨é‡æ£€æŸ¥
4. **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡å¤„ç†ä¼˜äºå¾ªç¯
5. **æ–‡æ¡£è®°å½•**: è®°å½•æ¸…æ´—è§„åˆ™å’Œé€»è¾‘

### ä¸‹ä¸€ç« é¢„å‘Š

**ç¬¬6ç«  - å¯è§†åŒ–è®¾è®¡**,å°†å­¦ä¹ :
- ğŸ“Š å›¾è¡¨ç±»å‹å…¨è§£æ
- ğŸ¨ è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ
- ğŸ“ å¸ƒå±€å’Œäº¤äº’è®¾è®¡
- ğŸ¯ KPIå’Œä»ªè¡¨æ¿è®¾è®¡
- ğŸ”„ å“åº”å¼è®¾è®¡

---

[â† ä¸Šä¸€ç« ](./4-è„šæœ¬ç¼–ç¨‹æ·±å…¥.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€ç« : å¯è§†åŒ–è®¾è®¡ â†’](./6-å¯è§†åŒ–è®¾è®¡.md)
