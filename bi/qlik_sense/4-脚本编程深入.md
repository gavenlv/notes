# ç¬¬4ç« ï¼šè„šæœ¬ç¼–ç¨‹æ·±å…¥

> **å­¦ä¹ æ—¶é•¿**: 12-15å°æ—¶  
> **éš¾åº¦**: â­â­â­â­  
> **å‰ç½®çŸ¥è¯†**: ç¬¬1-3ç« 

## æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« å,ä½ å°†èƒ½å¤Ÿ:

- âœ… ç†Ÿç»ƒæŒæ¡Qlikè„šæœ¬å˜é‡å’Œå‚æ•°åŒ–
- âœ… ç¼–å†™å¤æ‚çš„æ¡ä»¶è¯­å¥å’Œå¾ªç¯ç»“æ„
- âœ… åˆ›å»ºå’Œä½¿ç”¨å­ç¨‹åºä¸å‡½æ•°
- âœ… å®ç°é«˜æ•ˆçš„å¢é‡åŠ è½½æŠ€æœ¯
- âœ… æŒæ¡é”™è¯¯å¤„ç†å’Œè°ƒè¯•æŠ€å·§
- âœ… ç†è§£è„šæœ¬æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

---

## 4.1 å˜é‡ä¸å‚æ•°åŒ–

### 4.1.1 å˜é‡åŸºç¡€

**ä»€ä¹ˆæ˜¯å˜é‡**?

å˜é‡æ˜¯å­˜å‚¨å€¼çš„å®¹å™¨,åœ¨Qlikè„šæœ¬ä¸­ç”¨äº:
- å­˜å‚¨å¸¸é‡å€¼
- å‚æ•°åŒ–è„šæœ¬
- åŠ¨æ€è·¯å¾„å’Œæ–‡ä»¶å
- æ¡ä»¶é€»è¾‘æ§åˆ¶

**å˜é‡å®šä¹‰æ–¹å¼**:

```qlik
// æ–¹å¼1: SETèµ‹å€¼(åŸæ ·å­˜å‚¨)
SET vToday = Today();
SET vPath = 'lib://DataFiles';
SET vDelimiter = ',';

// æ–¹å¼2: LETèµ‹å€¼(è®¡ç®—åå­˜å‚¨)
LET vCurrentYear = Year(Today());
LET vTotalSales = Sum(SalesAmount);
LET vFileCount = NoOfRows('DataTable');

// æ–¹å¼3: ä»å­—æ®µå€¼èµ‹å€¼
LET vFirstCustomer = Peek('CustomerName', 0, 'Customers');
LET vMaxDate = Peek('MaxDate', 0, 'DateSummary');
```

### 4.1.2 å˜é‡å±•å¼€

**å˜é‡ä½¿ç”¨æ–¹å¼**:

```qlik
// æ–¹å¼1: $(å˜é‡å) - æ¨è
TRACE ä»Šå¤©çš„æ—¥æœŸæ˜¯: $(vToday);
LOAD * FROM [$(vPath)/sales_$(vCurrentYear).csv];

// æ–¹å¼2: $å˜é‡å - æ—§è¯­æ³•(ä¸æ¨è)
TRACE ä»Šå¤©çš„æ—¥æœŸæ˜¯: $vToday;

// æ–¹å¼3: åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨
LET vConnectionString = "æ•°æ®æº: $(vPath), å¹´ä»½: $(vCurrentYear)";
TRACE $(vConnectionString);
```

### 4.1.3 å˜é‡ä½œç”¨åŸŸ

```qlik
///$tab å…¨å±€å˜é‡
// å…¨å±€å˜é‡ - æ•´ä¸ªè„šæœ¬å¯è®¿é—®
SET vGlobalPath = 'lib://Data';
LET vGlobalYear = Year(Today());

///$tab å±€éƒ¨å˜é‡
SUB LoadSalesData
    // å±€éƒ¨å˜é‡ - ä»…åœ¨å­ç¨‹åºå†…æœ‰æ•ˆ
    LET vLocalTable = 'Sales_$(vGlobalYear)';
    
    [$(vLocalTable)]:
    LOAD * FROM [$(vGlobalPath)/sales.csv];
    
    // å±€éƒ¨å˜é‡åœ¨æ­¤ç»“æŸ
END SUB
```

### 4.1.4 ç³»ç»Ÿå˜é‡

**Qlikå†…ç½®ç³»ç»Ÿå˜é‡**:

```qlik
// æ—¶é—´ç›¸å…³
TRACE å½“å‰æ—¶é—´: $(QvdCreateTime);        // QVDåˆ›å»ºæ—¶é—´
TRACE è„šæœ¬å¼€å§‹æ—¶é—´: $(ScriptStartTime);   // è„šæœ¬å¼€å§‹æ—¶é—´
TRACE è„šæœ¬ç»“æŸæ—¶é—´: $(ScriptEndTime);     // è„šæœ¬ç»“æŸæ—¶é—´

// è·¯å¾„ç›¸å…³
TRACE æ–‡æ¡£è·¯å¾„: $(DocumentPath);          // æ–‡æ¡£è·¯å¾„
TRACE æ–‡æ¡£åç§°: $(DocumentName);          // æ–‡æ¡£åç§°

// ç¯å¢ƒç›¸å…³
TRACE Qlikç‰ˆæœ¬: $(ProductVersion);        // äº§å“ç‰ˆæœ¬
TRACE æ“ä½œç³»ç»Ÿ: $(OSUser);               // OSç”¨æˆ·
TRACE è®¡ç®—æœºå: $(ComputerName);          // è®¡ç®—æœºå

// è‡ªå®šä¹‰ç³»ç»Ÿå˜é‡
SET ThousandSep=',';                      // åƒä½åˆ†éš”ç¬¦
SET DecimalSep='.';                       // å°æ•°åˆ†éš”ç¬¦
SET MoneyFormat='Â¥#,##0.00';             // è´§å¸æ ¼å¼
```

---

## 4.2 æ¡ä»¶è¯­å¥

### 4.2.1 IFè¯­å¥

**åŸºæœ¬IFè¯­å¥**:

```qlik
// ç®€å•æ¡ä»¶
IF Year(Today()) = 2024 THEN
    TRACE è¿™æ˜¯2024å¹´;
END IF

// IF-ELSEç»“æ„
LET vSales = 1000000;
IF vSales > 1000000 THEN
    TRACE é”€å”®é¢è¶…è¿‡100ä¸‡;
ELSE
    TRACE é”€å”®é¢æœªè¾¾åˆ°100ä¸‡;
END IF

// å¤šé‡æ¡ä»¶
LET vMonth = Month(Today());
IF vMonth = 'Jan' OR vMonth = 'Feb' THEN
    TRACE è¿™æ˜¯å¹´åˆ;
ELSEIF vMonth = 'Mar' OR vMonth = 'Apr' THEN
    TRACE è¿™æ˜¯æ˜¥å­£;
ELSE
    TRACE å…¶ä»–æœˆä»½;
END IF
```

### 4.2.2 æ¡ä»¶åŠ è½½

```qlik
// æ ¹æ®æ¡ä»¶åŠ è½½ä¸åŒæ•°æ®
LET vEnvironment = 'Production';  // æˆ– 'Development'

IF vEnvironment = 'Production' THEN
    // ç”Ÿäº§ç¯å¢ƒåŠ è½½å®Œæ•´æ•°æ®
    Sales:
    LOAD * FROM [lib://Production/sales.qvd] (qvd);
ELSE
    // å¼€å‘ç¯å¢ƒåŠ è½½æ ·æœ¬æ•°æ®
    Sales:
    LOAD * FROM [lib://Development/sample_sales.qvd] (qvd);
END IF

// æ ¹æ®æ–‡ä»¶å­˜åœ¨æ€§åŠ è½½
IF FileTime('lib://Data/critical_data.csv') > 0 THEN
    CriticalData:
    LOAD * FROM [lib://Data/critical_data.csv] (txt);
    TRACE å…³é”®æ•°æ®åŠ è½½æˆåŠŸ;
ELSE
    TRACE è­¦å‘Š: å…³é”®æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨!;
END IF
```

### 4.2.3 æ¡ä»¶å­—æ®µåˆ›å»º

```qlik
// åœ¨LOADè¯­å¥ä¸­ä½¿ç”¨æ¡ä»¶
Sales:
LOAD
    OrderID,
    CustomerID,
    Amount,
    // æ¡ä»¶å­—æ®µ
    IF(Amount > 1000, 'å¤§é¢è®¢å•', 'æ™®é€šè®¢å•') as OrderType,
    IF(Amount > 5000, 'VIPå®¢æˆ·', 
       IF(Amount > 1000, 'é‡è¦å®¢æˆ·', 'æ™®é€šå®¢æˆ·')) as CustomerLevel,
    // ä½¿ç”¨å˜é‡çš„æ¡ä»¶
    IF(Year(OrderDate) = $(vCurrentYear), 'ä»Šå¹´', 'å¾€å¹´') as YearCategory
FROM sales.csv;

// å¤æ‚æ¡ä»¶é€»è¾‘
Products:
LOAD
    ProductID,
    ProductName,
    Category,
    Price,
    // å¤šå±‚åµŒå¥—æ¡ä»¶
    IF(Price > 1000, 'é«˜ç«¯',
       IF(Price > 500, 'ä¸­ç«¯',
          IF(Price > 100, 'å…¥é—¨', 'ä½ä»·'))) as PriceLevel,
    // ç»“åˆå‡½æ•°çš„æ¡ä»¶
    IF(WildMatch(ProductName, '*Pro*', '*Premium*'), 'ä¸“ä¸šç‰ˆ', 'æ ‡å‡†ç‰ˆ') as VersionType
FROM products.csv;
```

---

## 4.3 å¾ªç¯ç»“æ„

### 4.3.1 FORå¾ªç¯

**åŸºæœ¬FORå¾ªç¯**:

```qlik
// æ•°å­—å¾ªç¯
FOR i = 1 TO 12
    TRACE å¤„ç†ç¬¬$(i)ä¸ªæœˆçš„æ•°æ®;
    
    Sales_$(i):
    LOAD * FROM [lib://Data/sales_2024_$(i).csv] (txt);
NEXT i

// æ­¥é•¿å¾ªç¯
FOR year = 2020 TO 2024 STEP 1
    Sales_$(year):
    LOAD * FROM [lib://Data/sales_$(year).qvd] (qvd);
NEXT year

// å€’åºå¾ªç¯
FOR month = 12 TO 1 STEP -1
    TRACE å¤„ç†$(month)æœˆæ•°æ®;
NEXT month
```

### 4.3.2 FOR EACHå¾ªç¯

**éå†å€¼åˆ—è¡¨**:

```qlik
// éå†å­—ç¬¦ä¸²åˆ—è¡¨
FOR EACH vRegion IN 'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³'
    TRACE å¤„ç†$(vRegion)åœ°åŒºæ•°æ®;
    
    [Sales_$(vRegion)]:
    LOAD * FROM [lib://Data/sales_$(vRegion).csv] (txt);
NEXT vRegion

// éå†å˜é‡åˆ—è¡¨
SET vCategories = 'ç”µå­,æœè£…,é£Ÿå“,å®¶å±…';
FOR EACH vCategory IN $(vCategories)
    TRACE å¤„ç†$(vCategory)ç±»ç›®;
NEXT vCategory

// éå†å­—æ®µå€¼
TempCategories:
LOAD DISTINCT Category FROM products.csv;

FOR i = 0 TO NoOfRows('TempCategories') - 1
    LET vCurrentCategory = Peek('Category', i, 'TempCategories');
    TRACE å¤„ç†åˆ†ç±»: $(vCurrentCategory);
    
    [Category_$(vCurrentCategory)]:
    LOAD * FROM products.csv
    WHERE Category = '$(vCurrentCategory)';
NEXT i

DROP Table TempCategories;
```

### 4.3.3 æ–‡ä»¶å¾ªç¯

**å¤„ç†å¤šä¸ªæ–‡ä»¶**:

```qlik
// éå†æ–‡ä»¶åˆ—è¡¨
FOR EACH vFile IN FileList('lib://Data/sales_*.csv')
    TRACE åŠ è½½æ–‡ä»¶: $(vFile);
    
    CONCATENATE (Sales)
    LOAD 
        *,
        FileName() as SourceFile,
        FileTime() as LoadTime
    FROM [$(vFile)] (txt);
NEXT vFile

// æŒ‰æ—¥æœŸå¤„ç†æ–‡ä»¶
LET vStartDate = '2024-01-01';
LET vEndDate = Today();

FOR vDate = $(vStartDate) TO $(vEndDate)
    LET vFileName = 'sales_' & Date(vDate, 'YYYYMMDD') & '.csv';
    
    IF FileTime('lib://Data/$(vFileName)') > 0 THEN
        TRACE åŠ è½½$(vFileName);
        CONCATENATE (Sales)
        LOAD * FROM [lib://Data/$(vFileName)] (txt);
    END IF
NEXT vDate
```

---

## 4.4 å­ç¨‹åºä¸å‡½æ•°

### 4.4.1 SUBå­ç¨‹åº

**å®šä¹‰å’Œè°ƒç”¨å­ç¨‹åº**:

```qlik
// å®šä¹‰å­ç¨‹åº
SUB LoadCustomerData(vCustomerType)
    TRACE å¼€å§‹åŠ è½½$(vCustomerType)å®¢æˆ·æ•°æ®;
    
    [Customers_$(vCustomerType)]:
    LOAD 
        CustomerID,
        CustomerName,
        City,
        CustomerType
    FROM [lib://Data/customers_$(vCustomerType).csv] (txt)
    WHERE CustomerType = '$(vCustomerType)';
    
    TRACE $(vCustomerType)å®¢æˆ·æ•°æ®åŠ è½½å®Œæˆ;
END SUB

// è°ƒç”¨å­ç¨‹åº
CALL LoadCustomerData('VIP');
CALL LoadCustomerData('æ™®é€š');
CALL LoadCustomerData('æ½œåœ¨');

// å¸¦è¿”å›å€¼çš„å­ç¨‹åº
SUB CalculateKPIs(vTableName, vResultVariable)
    LET vRowCount = NoOfRows(vTableName);
    LET vAvgAmount = Avg({<TableName={$(vTableName)}>} Amount);
    
    LET $(vResultVariable) = 'è¡Œæ•°:$(vRowCount), å¹³å‡é‡‘é¢:$(vAvgAmount)';
END SUB

CALL CalculateKPIs('Sales', 'vSalesKPI');
TRACE é”€å”®KPI: $(vSalesKPI);
```

### 4.4.2 å‚æ•°ä¼ é€’

**å‚æ•°å¤„ç†**:

```qlik
// å¤šå‚æ•°å­ç¨‹åº
SUB ProcessData(vSource, vTarget, vCondition)
    TRACE ä»$(vSource)å¤„ç†æ•°æ®åˆ°$(vTarget);
    
    [$(vTarget)]:
    LOAD * FROM [$(vSource)]
    WHERE $(vCondition);
    
    TRACE æ•°æ®å¤„ç†å®Œæˆï¼Œå…±$(NoOfRows('$(vTarget)'))è¡Œ;
END SUB

// è°ƒç”¨å¤šå‚æ•°å­ç¨‹åº
CALL ProcessData('lib://Data/raw_sales.csv', 'CleanSales', 'Amount > 0');

// å¯é€‰å‚æ•°å¤„ç†
SUB LoadWithDefaults(vFile, vDelimiter)
    // è®¾ç½®é»˜è®¤å€¼
    IF Len('$(vDelimiter)') = 0 THEN
        LET vDelimiter = ',';
    END IF
    
    LOAD * FROM [$(vFile)] (txt, delimiter is '$(vDelimiter)');
END SUB

CALL LoadWithDefaults('lib://Data/data.csv');           // ä½¿ç”¨é»˜è®¤åˆ†éš”ç¬¦
CALL LoadWithDefaults('lib://Data/data.txt', '\t');    // æŒ‡å®šåˆ†éš”ç¬¦
```

### 4.4.3 ç³»ç»Ÿå­ç¨‹åº

**Qlikå†…ç½®å­ç¨‹åº**:

```qlik
// Sleep - æš‚åœæ‰§è¡Œ
SLEEP 5000;  // æš‚åœ5ç§’

// Trace - è¾“å‡ºè°ƒè¯•ä¿¡æ¯
TRACE å¼€å§‹æ•°æ®åŠ è½½è¿‡ç¨‹;

// Exit Script - é€€å‡ºè„šæœ¬
IF ScriptErrorCount > 5 THEN
    TRACE é”™è¯¯è¿‡å¤šï¼Œé€€å‡ºè„šæœ¬;
    EXIT SCRIPT;
END IF

// è‡ªå®šä¹‰ç³»ç»Ÿå­ç¨‹åº
SUB LogMessage(vLevel, vMessage)
    LET vTimestamp = Now();
    TRACE [$(vLevel)] $(vTimestamp): $(vMessage);
END SUB

CALL LogMessage('INFO', 'æ•°æ®åŠ è½½å¼€å§‹');
CALL LogMessage('WARN', 'å‘ç°é‡å¤æ•°æ®');
CALL LogMessage('ERROR', 'æ–‡ä»¶ä¸å­˜åœ¨');
```

---

## 4.5 å¢é‡åŠ è½½

### 4.5.1 åŸºäºæ—¶é—´çš„å¢é‡åŠ è½½

```qlik
///$tab å¢é‡åŠ è½½å®ç°

// æ£€æŸ¥QVDæ˜¯å¦å­˜åœ¨
IF NOT IsNull(QvdCreateTime('lib://QVD/sales_history.qvd')) THEN
    
    // è·å–ä¸Šæ¬¡åŠ è½½æ—¶é—´
    LET vLastLoadTime = QvdCreateTime('lib://QVD/sales_history.qvd');
    LET vLastLoadDate = Date(vLastLoadTime, 'YYYY-MM-DD');
    
    TRACE ä¸Šæ¬¡åŠ è½½æ—¶é—´: $(vLastLoadDate);
    
    // åŠ è½½å†å²æ•°æ®
    SalesHistory:
    LOAD * FROM [lib://QVD/sales_history.qvd] (qvd);
    
    // åŠ è½½æ–°å¢æ•°æ®
    TRACE å¼€å§‹åŠ è½½$(vLastLoadDate)ä¹‹åçš„æ–°æ•°æ®;
    
    SalesNew:
    SQL SELECT 
        OrderID,
        OrderDate,
        CustomerID,
        ProductID,
        Amount
    FROM Sales
    WHERE OrderDate > '$(vLastLoadDate)';
    
    // åˆå¹¶æ•°æ®
    CONCATENATE (SalesHistory)
    LOAD * RESIDENT SalesNew;
    
    DROP Table SalesNew;
    
    TRACE å¢é‡åŠ è½½å®Œæˆï¼Œæ€»è¡Œæ•°: $(NoOfRows('SalesHistory'));
    
ELSE
    // é¦–æ¬¡åŠ è½½å…¨éƒ¨æ•°æ®
    TRACE é¦–æ¬¡åŠ è½½ï¼ŒåŠ è½½å…¨éƒ¨å†å²æ•°æ®;
    
    SalesHistory:
    SQL SELECT * FROM Sales;
    
END IF

// ä¿å­˜æ›´æ–°çš„QVD
STORE SalesHistory INTO [lib://QVD/sales_history.qvd] (qvd);
DROP Table SalesHistory;
```

### 4.5.2 åŸºäºæ ‡è¯†çš„å¢é‡åŠ è½½

```qlik
///$tab åŸºäºIDçš„å¢é‡åŠ è½½

// æ£€æŸ¥æœ€å¤§ID
IF NOT IsNull(QvdCreateTime('lib://QVD/orders.qvd')) THEN
    
    // è·å–QVDä¸­æœ€å¤§OrderID
    TempMaxID:
    LOAD Max(OrderID) as MaxOrderID FROM [lib://QVD/orders.qvd] (qvd);
    LET vMaxOrderID = Peek('MaxOrderID', 0, 'TempMaxID');
    DROP Table TempMaxID;
    
    TRACE æœ€å¤§è®¢å•ID: $(vMaxOrderID);
    
    // åŠ è½½å†å²æ•°æ®
    Orders:
    LOAD * FROM [lib://QVD/orders.qvd] (qvd);
    
    // åŠ è½½æ–°å¢è®¢å•
    TRACE åŠ è½½IDå¤§äº$(vMaxOrderID)çš„æ–°è®¢å•;
    
    OrdersNew:
    SQL SELECT * FROM Orders
    WHERE OrderID > $(vMaxOrderID);
    
    // åˆå¹¶æ–°æ•°æ®
    CONCATENATE (Orders)
    LOAD * RESIDENT OrdersNew;
    
    DROP Table OrdersNew;
    
ELSE
    // é¦–æ¬¡åŠ è½½
    TRACE é¦–æ¬¡åŠ è½½å…¨éƒ¨è®¢å•æ•°æ®;
    Orders:
    SQL SELECT * FROM Orders;
    
END IF

// ä¿å­˜QVD
STORE Orders INTO [lib://QVD/orders.qvd] (qvd);
```

### 4.5.3 é«˜çº§å¢é‡ç­–ç•¥

```qlik
///$tab æ··åˆå¢é‡åŠ è½½

// é…ç½®å˜é‡
SET vQVDPath = 'lib://QVD';
SET vDataPath = 'lib://Data';
LET vToday = Today();

// æ£€æŸ¥ä¸åŒç±»å‹çš„å¢é‡
SUB LoadIncrementalData(vTableName, vDateField, vQVDFile)
    
    LET vQVDFilePath = '$(vQVDPath)/$(vQVDFile)';
    
    IF NOT IsNull(QvdCreateTime('$(vQVDFilePath)')) THEN
        
        // è·å–æœ€åæ›´æ–°æ—¶é—´
        LET vLastUpdate = Date(QvdCreateTime('$(vQVDFilePath)'), 'YYYY-MM-DD');
        
        // åŠ è½½å†å²æ•°æ®
        [$(vTableName)_History]:
        LOAD * FROM [$(vQVDFilePath)] (qvd);
        
        // åŠ è½½å¢é‡æ•°æ®
        [$(vTableName)_New]:
        LOAD * FROM [$(vDataPath)/$(vTableName)_$(vLastUpdate).csv] (txt);
        
        // åˆå¹¶æ•°æ®
        CONCATENATE ([$(vTableName)_History])
        LOAD * RESIDENT [$(vTableName)_New];
        
        DROP Table [$(vTableName)_New];
        
        // ä¿å­˜æ›´æ–°çš„QVD
        STORE [$(vTableName)_History] INTO [$(vQVDFilePath)] (qvd);
        
    ELSE
        // é¦–æ¬¡åŠ è½½
        [$(vTableName)_History]:
        LOAD * FROM [$(vDataPath)/$(vTableName)_initial.csv] (txt);
        
        STORE [$(vTableName)_History] INTO [$(vQVDFilePath)] (qvd);
        
    END IF
    
END SUB

// ä½¿ç”¨å¢é‡åŠ è½½
CALL LoadIncrementalData('Sales', 'OrderDate', 'sales_data.qvd');
CALL LoadIncrementalData('Customers', 'LastUpdate', 'customers_data.qvd');
```

---

## 4.6 é”™è¯¯å¤„ç†

### 4.6.1 é”™è¯¯æ£€æµ‹

**è„šæœ¬é”™è¯¯å˜é‡**:

```qlik
// é”™è¯¯ç›¸å…³å˜é‡
TRACE ScriptError: $(ScriptError);              // æœ€åé”™è¯¯ä¿¡æ¯
TRACE ScriptErrorCount: $(ScriptErrorCount);    // é”™è¯¯è®¡æ•°
TRACE ScriptErrorList: $(ScriptErrorList);      // é”™è¯¯åˆ—è¡¨

// æ£€æŸ¥ç‰¹å®šé”™è¯¯
Sales:
LOAD * FROM non_existent_file.csv;

IF ScriptError THEN
    TRACE å‘ç”Ÿé”™è¯¯: $(ScriptError);
    TRACE é”™è¯¯ä»£ç : $(ScriptErrorCount);
END IF

// æ¸…é™¤é”™è¯¯çŠ¶æ€
SET ScriptError = ;
SET ScriptErrorCount = 0;
```

### 4.6.2 TRY-CATCHæ¨¡å¼

```qlik
// æ¨¡æ‹ŸTRY-CATCH
SUB SafeLoadData(vFilePath, vTableName)
    
    // ä¿å­˜å½“å‰é”™è¯¯çŠ¶æ€
    LET vOldErrorCount = ScriptErrorCount;
    
    TRACE å°è¯•åŠ è½½: $(vFilePath);
    
    [$(vTableName)]:
    LOAD * FROM [$(vFilePath)];
    
    // æ£€æŸ¥æ˜¯å¦å‡ºé”™
    IF ScriptErrorCount > vOldErrorCount THEN
        TRACE é”™è¯¯å‘ç”Ÿï¼Œå¤„ç†å¼‚å¸¸;
        
        // é”™è¯¯å¤„ç†
        DROP Table [$(vTableName)];  // åˆ é™¤ä¸å®Œæ•´çš„è¡¨
        
        // åŠ è½½å¤‡ç”¨æ•°æ®
        [$(vTableName)]:
        LOAD 
            Null() as Field1,
            Null() as Field2
        AUTOGENERATE 1;
        
        TRACE å·²åŠ è½½å¤‡ç”¨æ•°æ®;
    ELSE
        TRACE æ•°æ®åŠ è½½æˆåŠŸ;
    END IF
    
END SUB

// ä½¿ç”¨å®‰å…¨åŠ è½½
CALL SafeLoadData('lib://Data/main_data.csv', 'MainData');
CALL SafeLoadData('lib://Data/backup_data.csv', 'BackupData');
```

### 4.6.3 é‡è¯•æœºåˆ¶

```qlik
// å¸¦é‡è¯•çš„æ•°æ®åŠ è½½
SUB LoadWithRetry(vFilePath, vMaxRetries)
    
    LET vRetryCount = 0;
    LET vSuccess = 0;
    
    DO WHILE vRetryCount <= vMaxRetries AND vSuccess = 0
        
        TRACE å°è¯•ç¬¬$(vRetryCount)æ¬¡åŠ è½½: $(vFilePath);
        
        // ä¿å­˜é”™è¯¯è®¡æ•°
        LET vErrorCountBefore = ScriptErrorCount;
        
        TempLoad:
        LOAD * FROM [$(vFilePath)];
        
        // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        IF ScriptErrorCount = vErrorCountBefore THEN
            LET vSuccess = 1;
            TRACE åŠ è½½æˆåŠŸ;
        ELSE
            LET vRetryCount = vRetryCount + 1;
            TRACE åŠ è½½å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•;
            SLEEP 2000;  // ç­‰å¾…2ç§’
        END IF
        
    LOOP
    
    IF vSuccess = 0 THEN
        TRACE é‡è¯•$(vMaxRetries)æ¬¡åä»ç„¶å¤±è´¥;
        // å¤„ç†æœ€ç»ˆå¤±è´¥
        TempLoad:
        LOAD 'åŠ è½½å¤±è´¥' as Status AUTOGENERATE 1;
    END IF
    
END SUB

// ä½¿ç”¨é‡è¯•åŠ è½½
CALL LoadWithRetry('lib://Data/unstable_data.csv', 3);
```

---

## 4.7 è„šæœ¬è°ƒè¯•

### 4.7.1 è°ƒè¯•è¾“å‡º

```qlik
// è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
SUB DebugInfo(vSectionName)
    TRACE ========== $(vSectionName) ==========
    TRACE æ—¶é—´æˆ³: $(Now())
    TRACE å†…å­˜ä½¿ç”¨: $(MemUsed)
    TRACE è¡¨æ•°é‡: $(NoOfTables)
    TRACE è„šæœ¬è¡Œæ•°: $(ScriptLine)
    TRACE é”™è¯¯è®¡æ•°: $(ScriptErrorCount)
    TRACE ======================================
END SUB

// ä½¿ç”¨è°ƒè¯•ä¿¡æ¯
CALL DebugInfo('å¼€å§‹æ•°æ®åŠ è½½');

Sales:
LOAD * FROM sales.csv;

CALL DebugInfo('é”€å”®æ•°æ®åŠ è½½å®Œæˆ');

Customers:
LOAD * FROM customers.csv;

CALL DebugInfo('å®¢æˆ·æ•°æ®åŠ è½½å®Œæˆ');
```

### 4.7.2 å˜é‡ç›‘æ§

```qlik
// å˜é‡å€¼ç›‘æ§
SUB MonitorVariables
    TRACE ===== å˜é‡ç›‘æ§ =====
    
    // ç›‘æ§å…³é”®å˜é‡
    TRACE vToday = $(vToday)
    TRACE vCurrentYear = $(vCurrentYear)
    TRACE vDataPath = $(vDataPath)
    TRACE vQVDPath = $(vQVDPath)
    
    TRACE ===================
END SUB

// åœ¨å…³é”®ç‚¹ç›‘æ§å˜é‡
LET vToday = Today();
LET vCurrentYear = Year(Today());
SET vDataPath = 'lib://Data';
SET vQVDPath = 'lib://QVD';

CALL MonitorVariables;
```

### 4.7.3 æ€§èƒ½ç›‘æ§

```qlik
// æ€§èƒ½ç›‘æ§å­ç¨‹åº
SUB PerformanceMonitor(vOperation)
    
    STATIC vStartTime AS vStart  // é™æ€å˜é‡
    
    IF '$(vOperation)' = 'START' THEN
        LET vStart = Now();
        TRACE å¼€å§‹æ“ä½œ: $(vStart);
    ELSEIF '$(vOperation)' = 'END' THEN
        LET vEndTime = Now();
        LET vDuration = Interval(vEndTime - vStart, 'h:mm:ss');
        TRACE æ“ä½œå®Œæˆ: $(vEndTime), è€—æ—¶: $(vDuration);
    END IF
    
END SUB

// ä½¿ç”¨æ€§èƒ½ç›‘æ§
CALL PerformanceMonitor('START');

LargeTable:
LOAD * FROM large_dataset.csv;

CALL PerformanceMonitor('END');
```

---

## 4.8 è„šæœ¬ä¼˜åŒ–

### 4.8.1 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

```qlik
// âŒ ä½æ•ˆå†™æ³•
FOR i = 1 TO 1000
    TempTable:
    LOAD * FROM data.csv;  // æ¯æ¬¡éƒ½è¯»å–æ•´ä¸ªæ–‡ä»¶
    // å¤„ç†...
    DROP Table TempTable;
NEXT i

// âœ… é«˜æ•ˆå†™æ³•
MasterData:
LOAD * FROM data.csv;  // ä¸€æ¬¡è¯»å–

FOR i = 1 TO 1000
    TempTable:
    LOAD * RESIDENT MasterData;  // ä»å†…å­˜è¯»å–
    // å¤„ç†...
    DROP Table TempTable;
NEXT i

DROP Table MasterData;
```

### 4.8.2 å†…å­˜ä¼˜åŒ–

```qlik
// åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„è¡¨
TempProcessing:
LOAD * FROM large_file.csv;

// å¤„ç†æ•°æ®
ProcessedData:
LOAD 
    Field1,
    Field2,
    Field3  // åªä¿ç•™éœ€è¦çš„å­—æ®µ
RESIDENT TempProcessing;

DROP Table TempProcessing;  // ç«‹å³é‡Šæ”¾

// ä½¿ç”¨å­—æ®µåˆ«åå‡å°‘å†…å­˜
Sales:
LOAD
    OrderID as ID,           // çŸ­åˆ«å
    CustomerID as CustID,
    ProductID as ProdID,
    Num(Amount) as SalesAmt  // æ•°æ®ç±»å‹ä¼˜åŒ–
FROM sales.csv;
```

### 4.8.3 QVDä¼˜åŒ–ç­–ç•¥

```qlik
// åˆ†å±‚QVDæ¶æ„
///$tab ç¬¬ä¸€å±‚: åŸå§‹æ•°æ®
RawData:
LOAD * FROM source_system.csv;
STORE RawData INTO [lib://QVD/L1_Raw/raw_data.qvd] (qvd);
DROP Table RawData;

///$tab ç¬¬äºŒå±‚: æ¸…æ´—æ•°æ®
CleanedData:
LOAD
    OrderID,
    Date(OrderDate) as OrderDate,
    Upper(CustomerName) as CustomerName,
    Num(Amount) as Amount
FROM [lib://QVD/L1_Raw/raw_data.qvd] (qvd);

STORE CleanedData INTO [lib://QVD/L2_Cleaned/cleaned_data.qvd] (qvd);
DROP Table CleanedData;

///$tab ç¬¬ä¸‰å±‚: åº”ç”¨æ•°æ®
AppData:
LOAD * FROM [lib://QVD/L2_Cleaned/cleaned_data.qvd] (qvd);
// åº”ç”¨ç‰¹å®šå¤„ç†...
```

---

## 4.9 å®éªŒ:ç»¼åˆè„šæœ¬åº”ç”¨

### å®éªŒ1: åŠ¨æ€æ•°æ®åŠ è½½ç³»ç»Ÿ

```qlik
///$tab åŠ¨æ€åŠ è½½ç³»ç»Ÿ

// é…ç½®å˜é‡
SET vConfigPath = 'lib://Config';
SET vDataPath = 'lib://Data';
SET vQVDPath = 'lib://QVD';

// é…ç½®è¡¨
Config:
LOAD
    TableName,
    SourceFile,
    TargetQVD,
    IncrementalField,
    LastLoadDate
FROM [$(vConfigPath)/data_config.csv] (txt);

// åŠ¨æ€åŠ è½½å‡½æ•°
SUB DynamicLoad(vConfigTable)
    
    FOR i = 0 TO NoOfRows(vConfigTable) - 1
        
        LET vTableName = Peek('TableName', i, vConfigTable);
        LET vSourceFile = Peek('SourceFile', i, vConfigTable);
        LET vTargetQVD = Peek('TargetQVD', i, vConfigTable);
        LET vIncrementalField = Peek('IncrementalField', i, vConfigTable);
        
        TRACE å¼€å§‹åŠ è½½è¡¨: $(vTableName);
        
        // æ£€æŸ¥QVDæ˜¯å¦å­˜åœ¨
        IF NOT IsNull(QvdCreateTime('$(vQVDPath)/$(vTargetQVD)')) THEN
            
            // å¢é‡åŠ è½½é€»è¾‘
            [$(vTableName)_History]:
            LOAD * FROM [$(vQVDPath)/$(vTargetQVD)] (qvd);
            
            [$(vTableName)_New]:
            LOAD * FROM [$(vDataPath)/$(vSourceFile)] (txt)
            WHERE $(vIncrementalField) > '$(vLastLoadDate)';
            
            CONCATENATE ([$(vTableName)_History])
            LOAD * RESIDENT [$(vTableName)_New];
            
            DROP Table [$(vTableName)_New];
            
            STORE [$(vTableName)_History] INTO [$(vQVDPath)/$(vTargetQVD)] (qvd);
            DROP Table [$(vTableName)_History];
            
        ELSE
            // å…¨é‡åŠ è½½
            [$(vTableName)]:
            LOAD * FROM [$(vDataPath)/$(vSourceFile)] (txt);
            
            STORE [$(vTableName)] INTO [$(vQVDPath)/$(vTargetQVD)] (qvd);
            DROP Table [$(vTableName)];
            
        END IF
        
        TRACE è¡¨$(vTableName)åŠ è½½å®Œæˆ;
        
    NEXT i
    
END SUB

// æ‰§è¡ŒåŠ¨æ€åŠ è½½
CALL DynamicLoad('Config');
```

### å®éªŒ2: é”™è¯¯æ¢å¤ç³»ç»Ÿ

```qlik
///$tab é”™è¯¯æ¢å¤ç³»ç»Ÿ

// é”™è¯¯æ—¥å¿—è¡¨
ErrorLog:
LOAD * INLINE [
    Timestamp, ErrorType, ErrorMessage, SourceFile
];

// å®‰å…¨åŠ è½½å‡½æ•°
SUB SafeLoadWithRecovery(vSourceFile, vTargetTable)
    
    LET vMaxRetries = 3;
    LET vRetryCount = 0;
    LET vSuccess = 0;
    
    DO WHILE vRetryCount < vMaxRetries AND vSuccess = 0
        
        TRACE å°è¯•åŠ è½½: $(vSourceFile) (ç¬¬$(vRetryCount)æ¬¡);
        
        LET vErrorCountBefore = ScriptErrorCount;
        
        [$(vTargetTable)]:
        LOAD * FROM [$(vSourceFile)];
        
        IF ScriptErrorCount = vErrorCountBefore THEN
            LET vSuccess = 1;
            TRACE åŠ è½½æˆåŠŸ: $(vSourceFile);
        ELSE
            LET vRetryCount = vRetryCount + 1;
            
            // è®°å½•é”™è¯¯
            CONCATENATE (ErrorLog)
            LOAD
                Now() as Timestamp,
                'LoadError' as ErrorType,
                '$(ScriptError)' as ErrorMessage,
                '$(vSourceFile)' as SourceFile
            AUTOGENERATE 1;
            
            TRACE åŠ è½½å¤±è´¥ï¼Œç­‰å¾…é‡è¯•;
            SLEEP 5000;
        END IF
        
    LOOP
    
    IF vSuccess = 0 THEN
        TRACE é‡è¯•å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ;
        
        // åŠ è½½ç©ºè¡¨ä½œä¸ºå¤‡ç”¨
        [$(vTargetTable)]:
        LOAD * FROM [lib://Backup/empty_template.csv] (txt);
        
        // è®°å½•æœ€ç»ˆå¤±è´¥
        CONCATENATE (ErrorLog)
        LOAD
            Now() as Timestamp,
            'FinalFailure' as ErrorType,
            'Max retries exceeded' as ErrorMessage,
            '$(vSourceFile)' as SourceFile
        AUTOGENERATE 1;
    END IF
    
END SUB

// æµ‹è¯•å®‰å…¨åŠ è½½
CALL SafeLoadWithRecovery('lib://Data/risky_data.csv', 'RiskyDataTable');
```

---

## 4.10 è¯¾åç»ƒä¹ 

### ç»ƒä¹ 1: å˜é‡å’Œæ¡ä»¶

**ä»»åŠ¡**: åˆ›å»ºä¸€ä¸ªæ ¹æ®å½“å‰æœˆä»½åŠ è½½ä¸åŒæ•°æ®çš„è„šæœ¬
- 1æœˆ-3æœˆ: åŠ è½½Q1æ•°æ®
- 4æœˆ-6æœˆ: åŠ è½½Q2æ•°æ®
- 7æœˆ-9æœˆ: åŠ è½½Q3æ•°æ®
- 10æœˆ-12æœˆ: åŠ è½½Q4æ•°æ®

### ç»ƒä¹ 2: å¾ªç¯å¤„ç†

**ä»»åŠ¡**: ç¼–å†™è„šæœ¬å¤„ç†è¿‡å»12ä¸ªæœˆçš„é”€å”®æ•°æ®æ–‡ä»¶
- æ–‡ä»¶å‘½å: sales_202401.csv, sales_202402.csv, ...
- ä½¿ç”¨å¾ªç¯è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ–‡ä»¶
- åˆå¹¶åˆ°ä¸€ä¸ªè¡¨ä¸­

### ç»ƒä¹ 3: å¢é‡åŠ è½½

**ä»»åŠ¡**: å®ç°ä¸€ä¸ªåŸºäºè®¢å•IDçš„å¢é‡åŠ è½½ç³»ç»Ÿ
- é¦–æ¬¡åŠ è½½å…¨éƒ¨è®¢å•
- åç»­åªåŠ è½½æ–°è®¢å•
- ä½¿ç”¨QVDå­˜å‚¨å†å²æ•°æ®

---

## 4.11 æœ¬ç« å°ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

âœ… **å˜é‡**: SET/LETå®šä¹‰, $(å˜é‡å)ä½¿ç”¨  
âœ… **æ¡ä»¶**: IF-ELSEç»“æ„, æ¡ä»¶å­—æ®µåˆ›å»º  
âœ… **å¾ªç¯**: FOR/NEXT, FOR EACH, æ–‡ä»¶å¾ªç¯  
âœ… **å­ç¨‹åº**: SUB/END SUB, å‚æ•°ä¼ é€’  
âœ… **å¢é‡åŠ è½½**: åŸºäºæ—¶é—´/IDçš„ç­–ç•¥  
âœ… **é”™è¯¯å¤„ç†**: ScriptErrorå˜é‡, é‡è¯•æœºåˆ¶  
âœ… **è°ƒè¯•**: TRACEè¾“å‡º, æ€§èƒ½ç›‘æ§  

### å…³é”®è¯­æ³•

```qlik
// å˜é‡
SET vName = Value;
LET vCalculated = Expression;

// æ¡ä»¶
IF condition THEN
    statements
ELSEIF condition THEN
    statements
ELSE
    statements
END IF

// å¾ªç¯
FOR i = 1 TO 10
    statements
NEXT i

// å­ç¨‹åº
SUB ProcedureName(parameters)
    statements
END SUB
CALL ProcedureName(parameters)
```

### æœ€ä½³å®è·µ

1. **å˜é‡å‘½å**: ä½¿ç”¨æœ‰æ„ä¹‰çš„å‰ç¼€(v, g, tmp)
2. **é”™è¯¯å¤„ç†**: æ¯ä¸ªå…³é”®æ“ä½œéƒ½è¦æœ‰é”™è¯¯æ£€æŸ¥
3. **æ€§èƒ½ä¼˜åŒ–**: å°½é‡ä½¿ç”¨RESIDENTè€Œä¸æ˜¯é‡æ–°è¯»å–æ–‡ä»¶
4. **ä»£ç æ³¨é‡Š**: è¯¦ç»†æ³¨é‡Šå¤æ‚é€»è¾‘
5. **æ¨¡å—åŒ–**: å°†é‡å¤é€»è¾‘å°è£…æˆå­ç¨‹åº

### ä¸‹ä¸€ç« é¢„å‘Š

**ç¬¬5ç«  - æ•°æ®è½¬æ¢ä¸æ¸…æ´—**,å°†å­¦ä¹ :
- ğŸ§¹ æ•°æ®æ¸…æ´—æŠ€æœ¯
- ğŸ”¤ å­—ç¬¦ä¸²å¤„ç†å‡½æ•°
- ğŸ“… æ—¥æœŸæ—¶é—´å¤„ç†
- ğŸ”„ æ•°æ®é€è§†ä¸é€†é€è§†
- ğŸ“Š è´¨é‡æ§åˆ¶è§„åˆ™

---

[â† ä¸Šä¸€ç« ](./3-æ•°æ®æ¨¡å‹è®¾è®¡.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€ç« : æ•°æ®è½¬æ¢ä¸æ¸…æ´— â†’](./5-æ•°æ®è½¬æ¢ä¸æ¸…æ´—.md)
