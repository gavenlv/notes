# 第7章：表达式与集合分析

> **学习时长**: 15-18小时  
> **难度**: ⭐⭐⭐⭐⭐  
> **前置知识**: 第1-6章

## 本章目标

学完本章后,你将能够:

- ✅ 深入理解Qlik聚合函数和表达式
- ✅ 熟练掌握Set Analysis语法和原理
- ✅ 编写复杂的集合表达式
- ✅ 实现时间智能分析功能
- ✅ 计算同比、环比等关键指标
- ✅ 处理复杂的选择上下文
- ✅ 优化表达式性能

---

## 7.1 聚合函数详解

### 7.1.1 基础聚合函数

**常用聚合函数**:

```qlik
// 基础聚合函数
Sum(销售额)                    // 求和
Count(订单ID)                  // 计数
Avg(单价)                      // 平均值
Min(价格)                      // 最小值
Max(价格)                      // 最大值
Median(销售额)                 // 中位数
Mode(产品类别)                 // 众数

// 带条件的聚合
Sum({<状态={'已完成'}>} 销售额)  // 条件求和
Count({<金额={'>1000'}>} 订单ID) // 条件计数

// 去重计数
Count(DISTINCT 客户ID)         // 不重复客户数
Count(DISTINCT {<年份={2024}>} 产品ID) // 2024年不重复产品数
```

### 7.1.2 高级聚合函数

```qlik
// 统计函数
Stdev(销售额)                  // 标准差
Fractile(销售额, 0.9)          // 分位数 (90%分位)
FirstSortedValue(产品名称, -销售额) // 按销售额排序的第一个产品

// 排名函数
Rank(Sum(销售额))              // 排名
Above(Sum(销售额), 1, 1)       // 上一行的值
Below(Sum(销售额), 1, 1)       // 下一行的值

// 累计函数
Rangesum(Above(Sum(销售额), 0, RowNo())) // 累计求和
Rangeavg(Above(Sum(销售额), 0, 3))       // 3期移动平均

// 条件聚合
Alt(Sum(销售额), 0)            // 如果为空则返回0
Only(产品名称)                 // 唯一值检查
```

### 7.1.3 聚合函数性能优化

```qlik
// ❌ 低效写法
If(Sum(销售额) > 1000000, '高', '低')

// ✅ 高效写法
If(Sum({1} 销售额) > 1000000, '高', '低')

// 使用TOTAL限定符优化
Sum(TOTAL <月份> 销售额)       // 按月份总计
Sum(TOTAL <年份,月份> 销售额)   // 按年月总计

// 避免重复计算
LET vTotalSales = Sum(销售额);
If($(vTotalSales) > 1000000, '高', '低')
```

---

## 7.2 Set Analysis基础

### 7.2.1 什么是Set Analysis?

**Set Analysis**是Qlik Sense最强大的功能之一，用于定义特定的数据集合进行计算。

```qlik
// 传统筛选 vs Set Analysis

// 传统方式: 依赖用户选择
Sum(销售额)  // 受当前选择影响

// Set Analysis: 明确定义数据集
Sum({<年份={2024}>} 销售额)  // 只计算2024年数据
```

**语法结构**:
```
AggregationFunction({SetExpression} [DISTINCT] [TOTAL [<fld{, fld}>]] expr)
```

### 7.2.2 基础Set语法

```qlik
// 1. 简单值筛选
Sum({<年份={2024}>} 销售额)           // 年份=2024
Sum({<地区={'北京','上海'}>} 销售额)   // 地区=北京或上海

// 2. 范围筛选
Sum({<销售额={'>1000'}>} 数量)        // 销售额>1000
Sum({<日期={'>=2024-01-01'}>} 销售额) // 日期>=2024-01-01

// 3. 排除筛选
Sum({<状态-={'已取消'}>} 销售额)      // 排除已取消状态
Sum({<客户类型-={'测试'}>} 订单数)     // 排除测试客户

// 4. 忽略筛选
Sum({1} 销售额)                      // 忽略所有选择
Sum({1<年份={2024}>} 销售额)          // 忽略所有选择，但限定年份
```

### 7.2.3 集合修饰符

```qlik
// 1. 添加元素 (+)
Sum({<年份={2023}> + <地区={'北京'}>} 销售额)
// 年份=2023 或 地区=北京

// 2. 排除元素 (-)
Sum({<年份={2023,2024}> - <地区={'上海'}>} 销售额)
// 年份=2023或2024 且 地区≠上海

// 3. 交集 (*)
Sum({<年份={2024}> * <月份={'1','2'}>} 销售额)
// 年份=2024 且 月份=1或2

// 4. 差集 (/)
Sum({<年份={2023,2024}> / <年份={2023}>} 销售额)
// 在{2023,2024}中但不在{2023}中的元素，即2024
```

---

## 7.3 高级Set Analysis

### 7.3.1 变量和表达式

```qlik
// 使用变量
LET vCurrentYear = 2024;
Sum({<年份={'$(vCurrentYear)'}>} 销售额)

// 使用搜索字符串
Sum({<产品名称={'*电脑*'}>} 销售额)     // 包含"电脑"
Sum({<产品名称={'=Len(产品名称)>5'}>} 销售额) // 名称长度>5

// 使用聚合函数结果
Sum({<销售额={">$(=Avg(销售额))"}>} 数量) // 高于平均销售额的订单
```

### 7.3.2 P()和E()函数

```qlik
// P() - 可能的值 (Possible)
Sum({<客户ID = P({<年份={2024}>} 客户ID)>} 销售额)
// 2024年有购买的所有客户在所有年份的销售额

// E() - 排除的值 (Excluded)
Sum({<产品ID = E({<状态={'缺货'}>} 产品ID)>} 销售额)
// 排除所有缺货产品的销售额

// 实际应用示例
// 计算忠诚客户(连续3年购买)的销售额
Sum({<客户ID = P({<年份={2022}>} 客户ID) * P({<年份={2023}>} 客户ID) * P({<年份={2024}>} 客户ID)>} 销售额)
```

### 7.3.3 Bookmarks和选择状态

```qlik
// 使用书签状态
Sum({BookMark01} 销售额)  // 使用BookMark01的选择状态

// 使用选择状态
Sum({$::[选择状态1]} 销售额)  // 使用特定选择状态

// 比较不同选择状态
Sum({1<年份={2024}>} 销售额) - Sum({1<年份={2023}>} 销售额)
// 2024年与2023年的差异
```

---

## 7.4 时间智能分析

### 7.4.1 基础时间计算

```qlik
// 创建时间维度
日期表:
LOAD
    日期,
    Year(日期) as 年份,
    Month(日期) as 月份,
    Week(日期) as 周,
    Day(日期) as 日,
    'Q' & Ceil(Month(日期)/3) as 季度
FROM dates.csv;

// 同比计算 (YoY)
Sum({<年份={2024}>} 销售额) / Sum({<年份={2023}>} 销售额) - 1
// 2024年相对于2023年的增长率

// 环比计算 (MoM)
Sum({<年份={2024},月份={'2'}>} 销售额) / Sum({<年份={2024},月份={'1'}>} 销售额) - 1
// 2024年2月相对于1月的增长率
```

### 7.4.2 动态时间计算

```qlik
// 使用变量的动态计算
LET vCurrentYear = Year(Today());
LET vLastYear = $(vCurrentYear) - 1;
LET vCurrentMonth = Month(Today());

// 动态同比
Sum({<年份={'$(vCurrentYear)'}>} 销售额) / Sum({<年份={'$(vLastYear)'}>} 销售额) - 1

// 滚动12个月
Sum({<日期={">=$(=AddMonths(Max(日期),-11))<=$(=Max(日期))"}>} 销售额)

// 年初至今 (YTD)
Sum({<日期={">=$(=YearStart(Max(日期)))<=$(=Max(日期))"}>} 销售额)

// 上月同期
Sum({<日期={">=$(=AddMonths(Max(日期),-1))<=$(=AddMonths(Max(日期),-1))"}>} 销售额)
```

### 7.4.3 时间维度分析

```qlik
// 季度分析
Sum({<季度={'Q1'}>} 销售额) as Q1Sales,
Sum({<季度={'Q2'}>} 销售额) as Q2Sales,
Sum({<季度={'Q3'}>} 销售额) as Q3Sales,
Sum({<季度={'Q4'}>} 销售额) as Q4Sales

// 月份趋势
Sum({<月份={'1'}>} 销售额) as JanSales,
Sum({<月份={'2'}>} 销售额) as FebSales,
// ... 继续到12月

// 工作日vs周末
Sum({<是否工作日={'是'}>} 销售额) as WeekdaySales,
Sum({<是否工作日={'否'}>} 销售额) as WeekendSales
```

---

## 7.5 复杂表达式应用

### 7.5.1 排名和TopN分析

```qlik
// 基础排名
Rank(Sum(销售额)) as 销售排名

// Top 10产品
If(Rank(Sum(销售额)) <= 10, Sum(销售额)) as Top10Sales

// 百分位排名
Fractile(TOTAL Aggr(Rank(Sum(销售额)), 产品名称), 0.9) as Top10Percentile

// 累计占比
Rangesum(Above(Sum(销售额), 0, RowNo())) / Sum(TOTAL 销售额) as 累计占比
```

### 7.5.2 增长率和趋势分析

```qlik
// 简单增长率
(Sum(本月销售额) - Sum(上月销售额)) / Sum(上月销售额) as 月增长率

// 年化增长率
Pow(Sum(本月销售额) / Sum(去年同期销售额), 1/12) - 1 as 年化月增长率

// 移动平均
RangeAvg(Above(Sum(销售额), 0, 3)) as 3月移动平均

// 趋势线斜率
Linest_M(Sum(销售额), 月份序号) as 趋势斜率
```

### 7.5.3 客户价值分析

```qlik
// 客户生命周期价值 (CLV)
Sum(订单金额) * Count(DISTINCT 订单ID) / Count(DISTINCT 客户ID) * 12 as 客户价值

// RFM分析
// R (最近购买): Max(订单日期)
// F (购买频率): Count(DISTINCT 订单ID)  
// M (购买金额): Sum(订单金额)

// 客户分层
If(
    Max(订单日期) >= Today() - 30 AND 
    Count(DISTINCT 订单ID) >= 5 AND 
    Sum(订单金额) >= 10000,
    'VIP客户',
    If(
        Max(订单日期) >= Today() - 90,
        '活跃客户',
        '流失客户'
    )
) as 客户等级
```

---

## 7.6 Set Analysis性能优化

### 7.6.1 表达式优化技巧

```qlik
// ❌ 低效表达式
If(Sum({<年份={2024}>} 销售额) > 1000000, '高', '低') +
If(Sum({<年份={2024}>} 销售额) > 500000, '中', '低')

// ✅ 优化表达式
LET v2024Sales = Sum({<年份={2024}>} 销售额);
If($(v2024Sales) > 1000000, '高', 
   If($(v2024Sales) > 500000, '中', '低'))

// 使用Aggr优化复杂计算
Sum(Aggr(If(Sum(销售额) > Avg(TOTAL 销售额), Sum(销售额)), 客户ID))
```

### 7.6.2 集合表达式优化

```qlik
// ❌ 复杂集合表达式
Sum({<年份={2024}> * <月份={'1','2','3'}> * <地区={'北京','上海','广州'}>} 销售额)

// ✅ 预定义集合
SET vQ1Beijing = <年份={2024}> * <月份={'1','2','3'}> * <地区={'北京','上海','广州'}>;
Sum({$(vQ1Beijing)} 销售额)

// 使用符号表优化
Sum({<客户ID = {"=Sum(销售额) > 10000"}>} 销售额)
// 优于
Sum({<客户ID = {"=Aggr(Sum(销售额), 客户ID) > 10000"}>} 销售额)
```

### 7.6.3 内存和计算优化

```qlik
// 减少重复计算
TempAggregation:
LOAD
    客户ID,
    Sum(销售额) as 客户销售额,
    Count(DISTINCT 订单ID) as 客户订单数
RESIDENT 原始数据
GROUP BY 客户ID;

// 在临时表基础上计算
FinalAnalysis:
LOAD
    *,
    If(客户销售额 > Avg(TOTAL 客户销售额), '高价值', '普通') as 客户价值等级,
    客户订单数 / 客户销售额 as 平均订单金额
RESIDENT TempAggregation;
```

---

## 7.7 实验:综合Set Analysis应用

### 实验1: 销售业绩分析仪表板

```qlik
///$tab 销售业绩分析

// 核心KPI表达式

// 1. 总销售额 (当前选择)
Sum(销售额) as 当前销售额

// 2. 总销售额 (全年)
Sum({1<年份={"$(=Max(年份))"}>} 销售额) as 全年销售额

// 3. 同比增长率
(
    Sum(销售额) / 
    Sum({<年份={"$(=Max(年份)-1)"}>} 销售额)
) - 1 as 同比增长率

// 4. 目标完成率
Sum(销售额) / Sum({1} 销售目标) as 目标完成率

// 5. 环比增长率
(
    Sum(销售额) / 
    Sum({1<月份={"$(=Max(月份)-1)"}>} 销售额)
) - 1 as 环比增长率

// 6. 平均订单金额
Sum(销售额) / Count(DISTINCT 订单ID) as 平均订单金额

// 7. 客户转化率
Count(DISTINCT 客户ID) / Count(DISTINCT 潜在客户ID) as 客户转化率

// Top 产品分析
TopProducts:
LOAD
    产品名称,
    Sum(销售额) as 产品销售额,
    Rank(Sum(销售额)) as 销售排名,
    Sum(销售额) / Sum(TOTAL 销售额) as 占比
RESIDENT 销售数据
GROUP BY 产品名称
ORDER BY 产品销售额 DESC
LIMIT 10;

// 地区对比分析
RegionalAnalysis:
LOAD
    地区,
    Sum(销售额) as 地区销售额,
    Sum(销售额) / Sum(TOTAL 销售额) as 地区占比,
    (
        Sum(销售额) / 
        Sum({<年份={"$(=Max(年份)-1)"}>} 销售额)
    ) - 1 as 地区同比
RESIDENT 销售数据
GROUP BY 地区;
```

### 实验2: 时间智能分析系统

```qlik
///$tab 时间智能分析

// 创建时间分析维度
TimeAnalysis:
LOAD
    日期,
    年份,
    月份,
    季度,
    Week(日期) as 周数,
    WeekDay(日期) as 星期,
    // 滚动周期标识
    If(日期 >= Today() - 7, '最近7天') as 七天周期,
    If(日期 >= Today() - 30, '最近30天') as 三十天周期,
    If(日期 >= YearStart(Today()), '今年') as 年度周期,
    If(日期 >= AddMonths(Today(), -3), '最近3个月') as 三月周期
    
FROM 日期维度表;

// 动态时间分析表达式

// 1. 滚动平均
RangeAvg(Above(
    Sum({<日期={">=$(=Today()-30)<=$(=Today())"}>} 销售额), 
    0, 7)
) as 七天移动平均

// 2. 同期对比
Sum({<日期={">=$(=AddYears(Max(日期),-1))<=$(=AddYears(Max(日期),-1))"}>} 销售额) as 去年同期

// 3. 累计计算
Rangesum(Above(
    Sum(销售额), 
    0, RowNo()
)) as 累计销售额

// 4. 季度环比
(
    Sum({<季度={"$(=Max(季度))"}>} 销售额) /
    Sum({<季度={"$(=Max(季度)-1)"}>} 销售额)
) - 1 as 季度环比

// 5. 年度累计完成率
Rangesum(Above(
    Sum({<年份={"$(=Max(年份))"}>} 销售额), 
    0, RowNo()
)) / Sum({1<年份={"$(=Max(年份))"}>} 年度目标) as 年度完成率
```

---

## 7.8 课后练习

### 练习1: 基础Set Analysis

**任务**: 编写以下表达式
- 计算特定产品类别的销售额
- 排除测试数据的订单数量
- 计算高于平均值的客户数量

### 练习2: 时间智能分析

**任务**: 实现以下时间计算
- 月度同比增长率
- 季度环比增长率
- 年初至今累计销售额
- 滚动12个月平均值

### 练习3: 复杂表达式

**任务**: 创建客户价值分析模型
- RFM客户分层
- 客户生命周期价值计算
- 客户流失预警指标

---

## 7.9 本章小结

### 核心知识点

✅ **聚合函数**: Sum, Count, Avg, Min, Max等  
✅ **Set Analysis**: {<筛选条件>} 语法结构  
✅ **集合操作**: +, -, *, / 修饰符  
✅ **时间智能**: 同比、环比、YTD、移动平均  
✅ **高级函数**: P(), E(), Rank(), Aggr()  
✅ **性能优化**: 变量缓存、表达式简化  

### 关键语法

```qlik
// 基础Set Analysis
Sum({<年份={2024}>} 销售额)

// 复合条件
Sum({<年份={2024},月份={'1','2'}>} 销售额)

// 范围条件
Sum({<销售额={'>1000'}>} 数量)

// 集合操作
Sum({<年份={2023}> + <地区={'北京'}>} 销售额)

// P()和E()函数
Sum({<客户ID = P({<年份={2024}>} 客户ID)>} 销售额)
```

### 最佳实践

1. **明确数据集**: 使用Set Analysis明确定义计算范围
2. **性能优化**: 避免重复计算，使用变量缓存
3. **可读性**: 复杂表达式使用多行格式和注释
4. **测试验证**: 验证表达式结果的正确性
5. **文档记录**: 记录复杂表达式的业务逻辑

### 下一章预告

**第8章 - 高级分析技术**,将学习:
- 🔄 AGGR函数深度解析
- 🎯 变量与书签高级应用
- 📊 替代维度与度量
- 🔧 嵌套聚合技术
- 🚀 高级图表交互

---

[← 上一章](./6-可视化设计.md) | [返回目录](./README.md) | [下一章: 高级分析技术 →](./8-高级分析技术.md)
