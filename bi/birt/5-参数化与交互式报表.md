# 第5章：参数化与交互式报表

## 5.1 参数概述

### 5.1.1 什么是报表参数？

报表参数是用户与报表交互的桥梁，它们允许用户：

- 输入查询条件
- 选择显示选项
- 自定义报表行为
- 动态过滤数据
- 控制显示内容

参数在BIRT报表中起到以下作用：
1. **数据过滤**：根据用户输入过滤报表数据
2. **动态内容**：根据参数显示不同内容
3. **行为控制**：控制报表的计算和渲染方式
4. **报表联动**：实现报表之间的参数传递

### 5.1.2 参数类型

BIRT支持多种参数类型：

1. **基础类型**：
   - String（字符串）
   - Integer（整数）
   - Float（浮点数）
   - Date/Date Time（日期/日期时间）
   - Boolean（布尔值）

2. **复杂类型**：
   - List Box（列表框）
   - Combo Box（下拉框）
   - Radio Button（单选按钮）
   - Check Box（复选框）
   - Multi-select List Box（多选列表）

3. **特殊类型**：
   - Cascading Parameter（级联参数）
   - Dynamic Parameter（动态参数）
   - Hidden Parameter（隐藏参数）

### 5.1.3 参数生命周期

参数的完整生命周期包括：

1. **定义**：在报表中定义参数
2. **初始化**：设置参数默认值
3. **绑定**：绑定到数据集或报表元素
4. **输入**：用户输入参数值
5. **验证**：验证参数有效性
6. **应用**：应用参数到报表
7. **传递**：传递到子报表或钻取报表

## 5.2 创建基础参数

### 5.2.1 报表参数创建

创建报表参数的步骤：

1. 在Data Explorer中右键"Report Parameters"
2. 选择"New Parameter"
3. 设置参数属性：
   - Name: 参数名称（如：start_date）
   - Prompt: 提示文本（如：开始日期）
   - Data Type: 数据类型（如：Date）
   - Default Value: 默认值
   - Format: 格式模式

### 5.2.2 参数属性详解

**基本属性**：
- Name: 参数名称，用于引用
- Prompt: 显示给用户的提示文本
- Help Text: 参数帮助文本
- Data Type: 参数数据类型

**值属性**：
- Default Value: 默认值
- Display Format: 显示格式
- Data Set: 动态参数的数据源
- Value Column: 值列
- Display Column: 显示列

**验证属性**：
- Required: 是否必填
- Allow Null: 是否允许空值
- Validation Rules: 验证规则

### 5.2.3 参数组

将相关参数分组提高组织性：

1. 在Data Explorer中创建参数组
2. 将相关参数拖入组内
3. 设置组属性（展开/折叠状态）

```xml
<parameter-group name="DateRange" expanded="true">
  <parameter name="start_date" />
  <parameter name="end_date" />
</parameter-group>
```

## 5.3 动态参数

### 5.3.1 动态参数概述

动态参数的值来自数据源，而不是静态列表。动态参数特点：

- 值来自数据库查询
- 支持实时更新
- 减少维护工作量
- 保证数据一致性

### 5.3.2 创建动态参数

创建动态参数步骤：

1. 创建数据集查询参数值
   ```sql
   SELECT customer_id, customer_name 
   FROM customers 
   WHERE status = 'Active'
   ORDER BY customer_name
   ```

2. 设置参数属性：
   - Data Set: 选择数据集
   - Value Column: customer_id
   - Display Column: customer_name

3. 配置显示选项：
   - Control Type: Combo Box
   - Auto Submit: 自动提交

### 5.3.3 动态参数优化

优化动态参数性能：

1. **数据集优化**：
   ```sql
   -- 使用索引字段
   SELECT customer_id, customer_name 
   FROM customers 
   WHERE status = 'Active'
   ORDER BY customer_name
   LIMIT 1000 -- 限制返回行数
   ```

2. **缓存策略**：
   ```java
   // 启用参数缓存
   parameter.setCacheEnabled(true);
   parameter.setCacheDuration(300); // 5分钟缓存
   ```

## 5.4 级联参数

### 5.4.1 级联参数概念

级联参数是一组相互关联的参数，一个参数的值依赖于另一个参数的选择。典型应用场景：

- 国家 → 省份/州 → 城市
- 产品类别 → 子类别 → 具体产品
- 部门 → 团队 → 员工

### 5.4.2 实现级联参数

创建国家-省份-城市级联参数：

1. **第一级参数：国家**
   ```sql
   SELECT country_id, country_name 
   FROM countries 
   ORDER BY country_name
   ```

2. **第二级参数：省份**（依赖国家参数）
   ```sql
   SELECT province_id, province_name 
   FROM provinces 
   WHERE country_id = ?
   ORDER BY province_name
   ```

3. **第三级参数：城市**（依赖省份参数）
   ```sql
   SELECT city_id, city_name 
   FROM cities 
   WHERE province_id = ?
   ORDER BY city_name
   ```

### 5.4.3 级联参数事件处理

使用JavaScript处理级联逻辑：

```javascript
// 国家参数变化事件
function countryChanged() {
    // 清空省份和城市选择
    params["province_id"] = null;
    params["city_id"] = null;
    
    // 刷新省份参数
    refreshParameter("province_id");
}

// 省份参数变化事件
function provinceChanged() {
    // 清空城市选择
    params["city_id"] = null;
    
    // 刷新城市参数
    refreshParameter("city_id");
}
```

## 5.5 参数验证

### 5.5.1 基础验证

BIRT提供多种内置验证规则：

1. **数据类型验证**：确保输入符合参数类型
2. **必填验证**：确保必填参数有值
3. **范围验证**：数值参数的范围限制
4. **长度验证**：字符串参数的长度限制
5. **格式验证**：日期、时间等格式验证

### 5.5.2 自定义验证

使用JavaScript实现复杂验证逻辑：

```javascript
// 验证日期范围
function validateDateRange() {
    var startDate = params["start_date"];
    var endDate = params["end_date"];
    
    if (startDate > endDate) {
        throw new Error("开始日期不能晚于结束日期");
    }
    
    // 检查日期范围不超过一年
    var oneYear = 365 * 24 * 60 * 60 * 1000;
    if (endDate - startDate > oneYear) {
        throw new Error("日期范围不能超过一年");
    }
    
    return true;
}

// 验证销售目标
function validateSalesTarget() {
    var target = params["sales_target"];
    var currentYear = new Date().getFullYear();
    var targetYear = params["target_year"];
    
    // 目标年不能是过去
    if (targetYear < currentYear) {
        throw new Error("目标年不能是过去年份");
    }
    
    // 目标值必须为正数
    if (target <= 0) {
        throw new Error("销售目标必须大于零");
    }
    
    return true;
}
```

### 5.5.3 验证消息定制

提供友好的验证错误消息：

```javascript
// 自定义验证消息
function setValidationMessages() {
    params["start_date"].setErrorMessage("请选择有效的开始日期");
    params["end_date"].setErrorMessage("请选择有效的结束日期");
    params["sales_target"].setErrorMessage("销售目标必须是正数");
}
```

## 5.6 参数应用

### 5.6.1 数据集参数绑定

将参数绑定到数据集查询：

```sql
-- 基础参数绑定
SELECT * 
FROM sales 
WHERE sale_date BETWEEN ? AND ? 
  AND customer_id = ? 
  AND product_category = ?
```

在BIRT中绑定：
- ?1 → params["start_date"]
- ?2 → params["end_date"]
- ?3 → params["customer_id"]
- ?4 → params["product_category"]

### 5.6.2 条件SQL查询

使用参数构建条件查询：

```sql
SELECT s.sale_id, s.sale_date, s.quantity, s.unit_price,
       c.customer_name, p.product_name
FROM sales s
JOIN customers c ON s.customer_id = c.customer_id
JOIN products p ON s.product_id = p.product_id
WHERE 1=1
  AND (? IS NULL OR s.sale_date >= ?)
  AND (? IS NULL OR s.sale_date <= ?)
  AND (? IS NULL OR s.customer_id = ?)
  AND (? IS NULL OR p.product_category = ?)
ORDER BY s.sale_date DESC
```

### 5.6.3 参数化存储过程

调用存储过程传递参数：

```sql
-- 存储过程调用
CALL GetSalesReport(
    ?, -- start_date
    ?, -- end_date
    ?, -- customer_id
    ?, -- product_category
    ?  -- sales_rep_id
)
```

## 5.7 交互式报表元素

### 5.7.1 超链接

创建超链接实现报表导航：

1. **超链接类型**：
   - Drill-through: 钻取到其他报表
   - Bookmark: 跳转到报表内书签
   - URI: 链接到外部资源
   - Email: 发送邮件

2. **配置超链接**：
   ```javascript
   // 钻取到产品详情报表
   Hyperlink Type: Drill-through
   Report Design: ProductDetailReport.rptdesign
   Parameters: 
     product_id = row["product_id"]
     return_report = "SalesReport"
   ```

3. **动态超链接**：
   ```javascript
   // 根据数据动态构建超链接
   var url = "https://example.com/product/" + row["product_id"];
   this.setHyperlink(url, "_blank");
   ```

### 5.7.2 书签导航

创建报表内导航：

1. **创建书签**：
   - 选择元素
   - 设置Bookmark属性：如"section_summary"

2. **创建导航链接**：
   ```javascript
   // 跳转到书签
   this.setHyperlink("javascript:void(birt.nav.bookmark('section_summary'))", null);
   ```

3. **返回顶部链接**：
   ```javascript
   this.setHyperlink("javascript:void(birt.nav.bookmark('top'))", null);
   ```

### 5.7.3 交互式图表

实现图表交互功能：

1. **图表钻取**：
   ```javascript
   // 图表点击事件
   function chartClick(series, category, value) {
       // 设置参数值
       params["selected_category"] = category;
       params["selected_series"] = series;
       
       // 刷新关联组件
       refreshComponent("detail_table");
       refreshComponent("secondary_chart");
   }
   ```

2. **图表高亮**：
   ```javascript
   // 鼠标悬停高亮
   function chartHover(series, category, value) {
       // 高亮相关数据行
       highlightRows("category", category);
   }
   ```

## 5.8 报表钻取

### 5.8.1 钻取概述

报表钻取允许用户从汇总数据导航到详细数据，提供多层次的数据探索：

1. **汇总到明细**：从聚合数据查看原始记录
2. **层次钻取**：沿着数据层次结构深入
3. **跨报表钻取**：导航到其他相关报表
4. **钻取路径**：记录用户的钻取历史

### 5.8.2 实现报表钻取

创建从销售汇总到销售明细的钻取：

1. **主报表：销售汇总**
   ```sql
   SELECT 
       category,
       SUM(quantity) as total_quantity,
       SUM(sales_amount) as total_sales
   FROM sales
   JOIN products ON sales.product_id = products.product_id
   WHERE sale_date BETWEEN ? AND ?
   GROUP BY category
   ```

2. **明细报表：销售明细**
   ```sql
   SELECT 
       s.sale_id,
       s.sale_date,
       s.quantity,
       s.unit_price,
       c.customer_name,
       p.product_name
   FROM sales s
   JOIN customers c ON s.customer_id = c.customer_id
   JOIN products p ON s.product_id = p.product_id
   WHERE p.category = ?
     AND s.sale_date BETWEEN ? AND ?
   ORDER BY s.sale_date DESC
   ```

3. **设置钻取链接**：
   ```javascript
   // 在主报表的类别列设置钻取链接
   Hyperlink Type: Drill-through
   Report Design: SalesDetailReport.rptdesign
   Parameters:
     category = row["category"]
     start_date = params["start_date"]
     end_date = params["end_date"]
   ```

### 5.8.3 多级钻取

实现多级钻取路径：

1. **第一级：区域销售**
   ```sql
   SELECT region, SUM(sales_amount) as total_sales
   FROM sales
   GROUP BY region
   ```

2. **第二级：省份销售**
   ```sql
   SELECT province, SUM(sales_amount) as total_sales
   FROM sales
   WHERE region = ?
   GROUP BY province
   ```

3. **第三级：城市销售**
   ```sql
   SELECT city, SUM(sales_amount) as total_sales
   FROM sales
   WHERE province = ?
   GROUP BY city
   ```

4. **第四级：销售明细**
   ```sql
   SELECT * FROM sales WHERE city = ?
   ```

## 5.9 动态报表行为

### 5.9.1 条件显示

基于参数控制报表元素显示：

```javascript
// 根据参数显示/隐藏表格
function onPrepare() {
    if (params["show_details"] == "true") {
        detailTable.visibility = "visible";
    } else {
        detailTable.visibility = "hidden";
    }
}

// 根据用户权限控制功能
function checkPermissions() {
    var userRole = params["user_role"];
    
    if (userRole != "admin") {
        // 隐藏管理功能
        adminPanel.visibility = "hidden";
        editButton.visibility = "hidden";
    }
    
    if (userRole == "viewer") {
        // 只读模式
        exportButton.visibility = "hidden";
        printButton.visibility = "hidden";
    }
}
```

### 5.9.2 动态计算

基于参数动态改变计算逻辑：

```javascript
// 动态税率计算
function calculateTax(amount, region) {
    var taxRate;
    
    switch(region) {
        case "USA":
            taxRate = 0.08; // 8%
            break;
        case "EU":
            taxRate = 0.20; // 20%
            break;
        case "APAC":
            taxRate = 0.10; // 10%
            break;
        default:
            taxRate = 0.05; // 5%
    }
    
    return amount * taxRate;
}

// 动态折扣计算
function calculateDiscount(amount, customerLevel) {
    var discountRate;
    
    switch(customerLevel) {
        case "Platinum":
            discountRate = 0.15; // 15%
            break;
        case "Gold":
            discountRate = 0.10; // 10%
            break;
        case "Silver":
            discountRate = 0.05; // 5%
            break;
        default:
            discountRate = 0; // 0%
    }
    
    return amount * discountRate;
}
```

### 5.9.3 动态样式

基于参数和数据动态应用样式：

```javascript
// 基于参数的主题切换
function applyTheme(theme) {
    var primaryColor, secondaryColor, backgroundColor;
    
    switch(theme) {
        case "dark":
            primaryColor = "#2196F3";
            secondaryColor = "#BBDEFB";
            backgroundColor = "#263238";
            break;
        case "light":
            primaryColor = "#1976D2";
            secondaryColor = "#E3F2FD";
            backgroundColor = "#FFFFFF";
            break;
        case "corporate":
            primaryColor = "#388E3C";
            secondaryColor = "#C8E6C9";
            backgroundColor = "#F5F5F5";
            break;
        default:
            primaryColor = "#3F51B5";
            secondaryColor = "#C5CAE9";
            backgroundColor = "#FAFAFA";
    }
    
    // 应用颜色到报表元素
    reportHeader.getStyle().backgroundColor = primaryColor;
    reportContent.getStyle().backgroundColor = backgroundColor;
    highlightElements.getStyle().backgroundColor = secondaryColor;
}
```

## 5.10 参数传递与共享

### 5.10.1 子报表参数传递

向子报表传递参数：

1. **定义子报表**：
   ```javascript
   // 在主报表中嵌入子报表
   var subReport = report.createSubReport();
   subReport.setReportDesign("child_report.rptdesign");
   
   // 传递参数
   subReport.setParameter("parent_param", params["parent_value"]);
   subReport.setParameter("child_id", row["id"]);
   ```

2. **配置参数映射**：
   - 主报表参数 → 子报表参数
   - 数据字段 → 子报表参数
   - 计算值 → 子报表参数

### 5.10.2 URL参数传递

通过URL传递参数：

```javascript
// 构建带参数的URL
function buildReportURL() {
    var baseURL = "http://server/birt/frameset";
    var reportName = "sales_report.rptdesign";
    
    // 添加参数
    var params = [];
    params.push("start_date=" + encodeURIComponent(params["start_date"]));
    params.push("end_date=" + encodeURIComponent(params["end_date"]));
    params.push("category=" + encodeURIComponent(params["category"]));
    
    // 构建完整URL
    return baseURL + "?__report=" + reportName + "&" + params.join("&");
}
```

### 5.10.3 会话参数

使用HTTP会话共享参数：

```javascript
// 设置会话参数
function setSessionParameters() {
    session.setAttribute("user_id", params["user_id"]);
    session.setAttribute("user_role", params["user_role"]);
    session.setAttribute("last_report", "sales_report");
}

// 获取会话参数
function getSessionParameters() {
    var userId = session.getAttribute("user_id");
    var userRole = session.getAttribute("user_role");
    
    // 根据用户角色过滤数据
    if (userRole != "admin") {
        params["filter_by_user"] = userId;
    }
}
```

## 5.11 实战案例

### 5.11.1 综合销售分析报表

创建一个包含多种交互功能的销售分析报表：

1. **参数面板**：
   - 日期范围选择器（联动日历）
   - 区域级联选择器（国家→省份→城市）
   - 产品类别多选下拉框
   - 销售代表单选按钮组
   - 显示选项复选框（显示明细、显示图表等）

2. **报表内容**：
   - KPI指标卡片（可点击）
   - 销售趋势图表（支持钻取）
   - 区域分布地图（支持点击）
   - 销售排名表格（支持排序）
   - 产品明细列表（支持分页）

3. **交互功能**：
   - 参数变化自动刷新报表
   - 图表与表格联动
   - 钻取到详细报表
   - 导出和分享功能

### 5.11.2 实现步骤

1. **创建参数结构**：
   ```javascript
   // 定义参数组
   var dateRangeGroup = createParameterGroup("Date Range");
   var regionGroup = createParameterGroup("Region");
   var productGroup = createParameterGroup("Product");
   var optionsGroup = createParameterGroup("Display Options");
   
   // 添加参数到组
   dateRangeGroup.addParameter("start_date");
   dateRangeGroup.addParameter("end_date");
   regionGroup.addParameter("country");
   regionGroup.addParameter("province");
   regionGroup.addParameter("city");
   // ...
   ```

2. **实现级联逻辑**：
   ```javascript
   // 级联参数刷新函数
   function refreshCascadingParameter(paramName, parentValue) {
       var dataSet = getParameterDataSet(paramName);
       dataSet.setInputParameterValue(parentValue);
       dataSet.refresh();
       
       // 清空下级参数
       clearChildParameters(paramName);
   }
   ```

3. **配置交互行为**：
   ```javascript
   // 参数变化事件处理
   function onParameterChange(paramName, paramValue) {
       // 刷新报表
       refreshReport();
       
       // 更新联动组件
       updateLinkedComponents(paramName, paramValue);
       
       // 记录用户行为
       logUserAction("Parameter Changed", paramName, paramValue);
   }
   ```

## 5.12 最佳实践

### 5.12.1 参数设计原则

1. **用户友好**：
   - 提供清晰的提示文本
   - 设置合理的默认值
   - 使用熟悉的控件类型
   - 提供帮助信息

2. **性能优化**：
   - 限制参数选项数量
   - 使用参数缓存
   - 优化参数查询
   - 避免过度复杂级联

3. **数据安全**：
   - 验证所有输入参数
   - 使用参数化查询
   - 限制数据访问权限
   - 记录参数使用日志

### 5.12.2 交互设计原则

1. **一致性**：
   - 保持交互模式一致
   - 使用统一的设计语言
   - 保持导航逻辑清晰

2. **响应性**：
   - 提供即时反馈
   - 优化加载时间
   - 显示操作进度

3. **容错性**：
   - 友好的错误提示
   - 提供恢复选项
   - 避免数据丢失

### 5.12.3 用户体验优化

1. **减少认知负担**：
   - 分组相关参数
   - 使用渐进式披露
   - 提供智能默认值

2. **提高操作效率**：
   - 支持快捷操作
   - 记住用户偏好
   - 提供批量操作

3. **增强可发现性**：
   - 清晰的视觉层次
   - 明确的操作提示
   - 合理的默认焦点

## 5.13 本章小结

本章详细介绍了BIRT的参数化和交互式报表功能。我们学习了：

- 报表参数的概念和类型
- 基础参数、动态参数和级联参数的创建
- 参数验证和错误处理
- 参数在数据集中的应用
- 交互式报表元素的使用
- 报表钻取功能的实现
- 动态报表行为设计
- 参数传递与共享机制

掌握参数化和交互式报表功能，能够显著提升报表的灵活性和用户体验，使报表从静态展示转变为动态分析工具。在下一章中，我们将学习BIRT的脚本与事件处理，进一步增强报表的定制化能力和高级功能实现。

## 5.14 实践练习

为了巩固本章知识，请完成以下练习：

1. 创建包含多种参数类型的综合报表
2. 实现三级级联参数（如：国家→省份→城市）
3. 设计带验证功能的参数输入界面
4. 创建具有钻取功能的销售分析报表
5. 实现图表与表格的联动交互
6. 设计基于用户权限的动态报表
7. 创建具有参数传递功能的子报表系统

完成这些练习后，您将掌握BIRT参数化和交互式报表的核心技能，能够创建灵活、易用的交互式报表系统。