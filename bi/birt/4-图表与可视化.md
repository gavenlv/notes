# 第4章：图表与可视化

## 4.1 图表概述

### 4.1.1 为什么使用图表？

图表是数据可视化的重要工具，具有以下优势：

1. **直观性**：图形化展示比纯数据更直观易懂
2. **模式识别**：帮助发现数据中的趋势、模式和异常
3. **快速理解**：用户可以在短时间内获取大量信息
4. **增强记忆**：视觉信息比文本更容易记忆
5. **专业展示**：提高报表的专业性和说服力

### 4.1.2 BIRT图表引擎

BIRT集成了强大的图表引擎，提供：

- 丰富的图表类型
- 高度可定制的外观
- 强大的数据绑定能力
- 交互功能支持
- 导出多种格式

### 4.1.3 图表类型分类

BIRT图表主要分为以下几类：

1. **比较类图表**：
   - 柱状图（Bar Chart）
   - 条形图（Column Chart）
   - 雷达图（Radar Chart）

2. **趋势类图表**：
   - 折线图（Line Chart）
   - 面积图（Area Chart）

3. **占比类图表**：
   - 饼图（Pie Chart）
   - 环形图（Doughnut Chart）

4. **分布类图表**：
   - 散点图（Scatter Chart）
   - 气泡图（Bubble Chart）

5. **关系类图表**：
   - 热力图（Heat Map）
   - 树状图（Tree Map）

6. **特殊图表**：
   - 仪表图（Gauge Chart）
   - 漏斗图（Funnel Chart）
   - 组合图（Combo Chart）

## 4.2 柱状图和条形图

### 4.2.1 柱状图基础

柱状图是最常用的图表类型之一，适合比较分类数据的大小。

创建柱状图：
1. 从调色板拖动Chart到报表
2. 选择图表类型：Bar Chart
3. 设置数据绑定：
   - Category Series: 产品类别
   - Value Series: 销售额
4. 配置图表样式

### 4.2.2 柱状图配置选项

**数据配置**：
- Category Series: 分类轴数据
- Value Series: 数值轴数据
- Series Definition: 系列定义

**外观配置**：
- Bar Width: 柱子宽度
- Bar Spacing: 柱子间距
- Color Palette: 颜色方案
- Outline: 轮廓样式

**轴配置**：
- X-Axis: 分类轴设置
- Y-Axis: 数值轴设置
- Grid Lines: 网格线
- Axis Labels: 轴标签

### 4.2.3 条形图

条形图是柱状图的横向版本，适合类别名称较长的情况：

1. 选择Column Chart类型
2. 配置与柱状图类似，但方向相反
3. 适合展示排名、进度等信息

### 4.2.4 堆叠和分组柱状图

**堆叠柱状图**：
```
Stacked Bar Chart Example
Electronics ┤ ███▌ ████ ███
Clothing    ┤ ██▌ ██ ███▌
Books       ┤ █  █▌ ██▌
            └─────────────────
              Q1  Q2  Q3  Q4
```

**分组柱状图**：
```
Grouped Bar Chart Example
           ┤ █ █ █ █
Electronics┤ █ █ █ █
           ┤ █ █ █ █
Clothing   ┤ █ █ █ █
           └─────────────────
            Q1 Q2 Q3 Q4
```

## 4.3 折线图和面积图

### 4.3.1 折线图基础

折线图适合展示数据随时间变化的趋势。

创建折线图：
1. 选择Line Chart类型
2. 设置数据绑定：
   - Category Series: 时间维度（月份、季度等）
   - Value Series: 数值（销售额、温度等）
3. 配置线条样式

### 4.3.2 折线图变体

**多系列折线图**：
```
Multi-Series Line Chart
      ┤      ╭─╮
Value ┤ ╭───╯   ╰─╮
      ┤ │         ╰──╮
      ┼─┼────────────┼─ Time
```

**散点折线图**：
```
Scatter Line Chart
      ┤ ○      ○     ○
Value ┤ ○  ○       ○  ○
      ┤ ○   ○   ○     ○
      └─┼───────────────── Time
```

### 4.3.3 面积图

面积图是折线图的填充版本，适合强调数量和变化率：

```
Area Chart
      ┤ ╭───────╮
Value ┤ │ ╭──╮ │
      ┤ │ │  │ │
      └─┴─┴──┴─┴─ Time
```

**堆叠面积图**：
```
Stacked Area Chart
      ┤ ╭───────╮
      ┤ │ ╭──╮ │
Value ┤ │ │ ╭│ │
      ┤ │ │ ╰│ │
      └─┴─┴──┴─┴─ Time
```

## 4.4 饼图和环形图

### 4.4.1 饼图基础

饼图适合展示部分与整体的关系，特别是类别数量不多的情况。

创建饼图：
1. 选择Pie Chart类型
2. 设置数据绑定：
   - Category Series: 类别
   - Value Series: 数值
3. 配置饼图外观

### 4.4.2 饼图高级配置

**标签配置**：
- Label Position: 标签位置
- Label Format: 标签格式
- Percentage: 显示百分比
- Value: 显示数值

**扇区配置**：
- Explosion: 扇区分离
- Starting Angle: 起始角度
- Direction: 方向设置

```
Pie Chart Example
    ┌─────┐
  ╱   ╲ ╱   ╲
 ╱ 30% ╲╱ 20% ╲
╲───────╱───────╱
  ╲ 25% ╱  25% ╲
    └─────┘
```

### 4.4.3 环形图

环形图是饼图的变体，中心为空，可以展示更多层次信息：

```
Doughnut Chart Example
    ┌─────┐
  ╱   ╲ ╱   ╲
 ╱ 30% ╲╱ 20% ╲
╲╱╲╱╲╱╲╱╲╱╲╱╲╱╲
  ╲ 25% ╱  25% ╲
    └─────┘
```

## 4.5 散点图和气泡图

### 4.5.1 散点图基础

散点图适合展示两个变量之间的关系，发现相关性。

创建散点图：
1. 选择Scatter Chart类型
2. 设置数据绑定：
   - X-Axis: 第一个变量
   - Y-Axis: 第二个变量
3. 配置散点样式

### 4.5.2 散点图应用场景

散点图常用于：
- 相关性分析
- 聚类分析
- 异常检测
- 分布分析

```
Scatter Chart Example
      ┤     ●
      ┤   ●   ●
Value ┤ ●   ●   ●
      ┤ ●
      └─┼───────────
        X-Axis
```

### 4.5.3 气泡图

气泡图是散点图的扩展，第三个变量由气泡大小表示：

1. 选择Bubble Chart类型
2. 设置数据绑定：
   - X-Axis: 第一个变量
   - Y-Axis: 第二个变量
   - Bubble Size: 第三个变量

```
Bubble Chart Example
      ┤ ○   ○
      ┤ ○ ● ○
Value ┤ ●   ●   ●
      ┤ ○
      └─┼───────────
        X-Axis
```

## 4.6 高级图表类型

### 4.6.1 雷达图

雷达图适合多维度比较，展示多个指标的平衡性。

创建雷达图：
1. 选择Radar Chart类型
2. 设置多维度数据绑定
3. 配置轴数量和样式

```
Radar Chart Example
          ┤
    Speed ┤──────●
          ┤   ╱
  Quality ┤──╱
          ┤ ╱
    Cost ┤╱
          ┤
          └─┼─┼─┼─┼─
```

### 4.6.2 热力图

热力图通过颜色深浅展示数据密度或强度。

创建热力图：
1. 选择Heat Map类型
2. 设置二维数据绑定
3. 配置颜色映射

### 4.6.3 仪表图

仪表图适合展示关键绩效指标（KPI），显示进度或达成率。

创建仪表图：
1. 选择Gauge Chart类型
2. 设置数值和阈值
3. 配置指针和刻度

```
Gauge Chart Example
      100
     ╱───╲
   ╱───╲ ╱───╲
  ──────●──────
     50
```

### 4.6.4 漏斗图

漏斗图适合展示流程中的转化率，如销售漏斗。

创建漏斗图：
1. 选择Funnel Chart类型
2. 设置阶段数据
3. 配置样式和标签

```
Funnel Chart Example
      ┌─────┐
      │ 100 │
     ╱│     │╲
    ╱ │ 80  │ ╲
   ╱  │     │  ╲
  ╱   │ 60  │   ╲
 ╱    │     │    ╲
╱─────│ 40  │─────╱
      │     │
      │ 20  │
      └─────┘
```

## 4.7 图表数据绑定

### 4.7.1 基础数据绑定

图表数据绑定指定图表展示哪些数据：

1. **分类系列（Category Series）**：通常绑定X轴，如时间、类别等
2. **数值系列（Value Series）**：通常绑定Y轴，如销售额、数量等
3. **系列定义（Series Definition）**：定义多个数据系列

示例：
```
Category Series: row["month"]
Value Series: row["sales_amount"]
```

### 4.7.2 多系列数据绑定

创建多系列图表：

```javascript
// 方法1：使用多个数据集
Series 1: 
  Category: row["month"]
  Value: row["product_a_sales"]

Series 2:
  Category: row["month"]
  Value: row["product_b_sales"]

// 方法2：使用数据透视
Category: row["month"]
Series: row["product_name"]
Value: row["sales_amount"]
```

### 4.7.3 聚合数据绑定

使用聚合函数处理数据：

```javascript
// 按月汇总销售额
Category: month(sale_date)
Value: SUM(sales_amount)

// 按类别计算平均值
Category: category_name
Value: AVERAGE(price)

// 计算同比增长率
Value: (current_year_sales - previous_year_sales) / previous_year_sales * 100
```

## 4.8 图表交互功能

### 4.8.1 图表事件

BIRT图表支持多种交互事件：

1. **鼠标事件**：
   - On Click: 点击事件
   - On Mouse Over: 鼠标悬停
   - On Mouse Out: 鼠标离开

2. **数据交互**：
   - Drill Down: 数据钻取
   - Highlight: 高亮显示
   - Filter: 数据过滤

### 4.8.2 实现数据钻取

创建多层级数据钻取：

1. **第一层图表**：
   ```javascript
   // 显示年度销售额
   Category: year
   Value: SUM(sales_amount)
   ```

2. **钻取到第二层**：
   ```javascript
   // 显示月度销售额
   Category: month
   Value: SUM(sales_amount)
   // 使用年份参数过滤
   WHERE year = ?
   ```

3. **钻取到第三层**：
   ```javascript
   // 显示产品详情
   Category: product_name
   Value: SUM(sales_amount)
   // 使用年份和月份参数过滤
   WHERE year = ? AND month = ?
   ```

### 4.8.3 图表联动

创建多个图表的联动效果：

1. **主图表**：区域销售额柱状图
2. **从图表**：区域产品分类饼图
3. **联动逻辑**：点击主图表的区域，更新从图表显示该区域的产品分类

实现方法：
```javascript
// 主图表点击事件
function chartOnClick(region) {
    // 更新从图表的数据集参数
    params["selected_region"] = region;
    // 刷新从图表
    subChart.refresh();
}
```

## 4.9 图表样式定制

### 4.9.1 颜色方案

BIRT提供多种预设颜色方案，也支持自定义：

```javascript
// 预设颜色方案
chart.setColorPalette("Default");
chart.setColorPalette("Pastel");
chart.setColorPalette("Vibrant");

// 自定义颜色
chart.setColors(["#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FFEAA7"]);
```

### 4.9.2 字体和标签

配置图表中的文本元素：

```javascript
// 轴标签
xAxisLabel.setFont("Arial", 12, "normal");
xAxisLabel.setColor("#333333");

// 数据标签
dataLabel.setVisible(true);
dataLabel.setFormat("$#,##0.00");
dataLabel.setFont("Arial", 10, "bold");

// 图例
legend.setFont("Arial", 11, "normal");
legend.setPosition("bottom");
```

### 4.9.3 动画效果

添加动画提升用户体验：

```javascript
// 启用动画
chart.setAnimationEnabled(true);

// 设置动画类型
chart.setAnimationType("fade");
chart.setAnimationType("slide");
chart.setAnimationType("scale");

// 设置动画持续时间
chart.setAnimationDuration(1000); // 毫秒
```

## 4.10 高级可视化技术

### 4.10.1 组合图表

组合图表结合多种图表类型展示复杂数据：

```
Combo Chart Example
      ┤ ╭──╮
      ┤ │  │█
Value ┤ │  │█
      ┤ │  │█
      └─┴──┴─┴───
        Time
```

实现组合图表：
1. 创建基础图表（如柱状图）
2. 添加第二Y轴
3. 在第二Y轴上添加另一种图表类型（如折线图）

### 4.10.2 子图表

在图表中嵌入子图表展示更详细信息：

```
Sub Chart Example
      ┤ ╭──╮
      ┤ │  │
Value ┤ │  │
      ┤ │  │╭──╮
      └─┴──┴─│  │
              └───
```

### 4.10.3 自定义绘制

使用JavaScript自定义图表元素：

```javascript
// 自定义绘制函数
function customDraw(chart) {
    // 获取画布上下文
    var ctx = chart.getContext();
    
    // 绘制自定义元素
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = "#FF0000";
    ctx.stroke();
    
    // 添加文本
    ctx.font = "12px Arial";
    ctx.fillStyle = "#333333";
    ctx.fillText("Threshold", x, y);
}
```

## 4.11 图表性能优化

### 4.11.1 数据优化

1. **数据采样**：对于大数据集进行采样显示
2. **聚合显示**：在缩小时使用聚合数据
3. **延迟加载**：按需加载数据
4. **缓存策略**：缓存计算结果

```javascript
// 数据采样示例
function sampleData(data, maxPoints) {
    if (data.length <= maxPoints) {
        return data;
    }
    
    var step = Math.ceil(data.length / maxPoints);
    var sampled = [];
    
    for (var i = 0; i < data.length; i += step) {
        sampled.push(data[i]);
    }
    
    return sampled;
}
```

### 4.11.2 渲染优化

1. **简化元素**：减少不必要的图形元素
2. **禁用动画**：在数据量大时禁用动画
3. **使用Canvas**：大数据量时使用Canvas渲染
4. **按需渲染**：只渲染可见区域

## 4.12 实战案例

### 4.12.1 综合销售仪表板

设计一个包含多种图表的销售仪表板：

1. **区域销售额地图**：
   - 使用地理图表展示各区域销售额
   - 颜色深浅表示销售额大小
   - 点击区域钻取到详细数据

2. **销售趋势折线图**：
   - 展示12个月销售趋势
   - 多条线对比不同产品类别
   - 支持时间范围选择

3. **产品销售柱状图**：
   - 展示Top 10产品销售额
   - 支持排序方式切换
   - 悬停显示详细信息

4. **销售占比饼图**：
   - 展示各类别销售占比
   - 支持点击显示/隐藏类别
   - 显示百分比和绝对值

### 4.12.2 实现步骤

1. **数据准备**：
   ```sql
   -- 区域销售数据
   SELECT region, SUM(sales_amount) as total_sales
   FROM sales
   GROUP BY region;
   
   -- 月度趋势数据
   SELECT 
       YEAR(sale_date) as year,
       MONTH(sale_date) as month,
       category,
       SUM(sales_amount) as sales_amount
   FROM sales
   JOIN products ON sales.product_id = products.product_id
   GROUP BY YEAR(sale_date), MONTH(sale_date), category;
   ```

2. **创建仪表板布局**：
   - 使用网格布局
   - 分配各图表位置
   - 设置响应式调整

3. **实现图表交互**：
   - 设置图表联动
   - 添加参数筛选
   - 实现数据钻取

4. **样式设计**：
   - 统一配色方案
   - 添加动画效果
   - 优化移动端显示

## 4.13 最佳实践

### 4.13.1 图表选择原则

1. **比较数据**：使用柱状图、条形图
2. **展示趋势**：使用折线图、面积图
3. **显示占比**：使用饼图、环形图
4. **分析关系**：使用散点图、气泡图
5. **多维比较**：使用雷达图
6. **KPI展示**：使用仪表图

### 4.13.2 设计原则

1. **简洁性**：避免过多装饰元素
2. **准确性**：确保数据准确反映
3. **一致性**：保持样式和交互一致
4. **可读性**：确保文字清晰可读
5. **响应性**：适应不同屏幕尺寸

### 4.13.3 用户体验

1. **加载反馈**：提供加载进度指示
2. **交互提示**：提供操作提示说明
3. **错误处理**：处理数据异常情况
4. **导出功能**：支持图表导出
5. **无障碍访问**：考虑视觉障碍用户

## 4.14 本章小结

本章详细介绍了BIRT的图表与可视化功能。我们学习了：

- 各种图表类型及其应用场景
- 图表的创建和配置方法
- 数据绑定和聚合计算
- 交互功能和联动效果
- 样式定制和动画效果
- 高级可视化技术
- 性能优化策略
- 综合仪表板设计

掌握图表与可视化是BIRT报表开发的重要技能，它们能够显著提升报表的数据表现力和用户体验。在下一章中，我们将学习参数化与交互式报表，进一步增强报表的灵活性和用户参与度。

## 4.15 实践练习

为了巩固本章知识，请完成以下练习：

1. 创建包含多种图表类型的综合报表
2. 实现图表的数据钻取功能
3. 创建多个联动图表，展示相关数据
4. 设计一个响应式图表布局，适应不同屏幕
5. 实现图表的自定义样式和动画效果
6. 创建一个包含交互功能的仪表板
7. 优化大数据量图表的性能

完成这些练习后，您将掌握BIRT图表与可视化的核心技能，能够创建专业、美观且功能强大的数据可视化报表。