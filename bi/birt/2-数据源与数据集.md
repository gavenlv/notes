# 第2章：数据源与数据集

## 2.1 数据源概述

### 2.1.1 什么是数据源？

数据源是BIRT报表的数据提供者，它定义了如何连接和访问数据。在BIRT中，数据源是获取报表数据的起点，包含了连接到特定数据存储系统所需的所有信息。

数据源的主要作用：
- 提供连接信息：服务器地址、认证凭据等
- 封装访问细节：隐藏底层数据访问复杂性
- 管理连接池：提高性能，减少连接开销
- 提供统一接口：支持不同类型的数据存储

### 2.1.2 数据源类型

BIRT支持多种类型的数据源，可以根据业务需求选择：

1. **JDBC数据源**：连接关系型数据库
2. **脚本数据源**：通过脚本生成数据
3. **XML数据源**：连接XML文件或Web服务
4. **Web服务数据源**：连接REST/SOAP服务
5. **平面文件数据源**：连接CSV、Excel等文件
6. **定制数据源**：通过扩展实现特定需求

### 2.1.3 数据源的特点

每种数据源都有其特定特点：

**JDBC数据源：**
- 支持标准SQL查询
- 支持事务管理
- 连接池管理
- 适用于结构化数据

**XML数据源：**
- 支持XPath查询
- 可处理嵌套数据结构
- 适用于层级数据

**脚本数据源：**
- 灵活性高
- 可处理复杂业务逻辑
- 适用于非标准数据源

## 2.2 JDBC数据源

### 2.2.1 JDBC数据源基础

JDBC（Java Database Connectivity）是Java连接数据库的标准API。BIRT通过JDBC数据源连接各种关系型数据库：

- MySQL
- Oracle
- SQL Server
- PostgreSQL
- DB2
- H2
- Derby
- 以及其他JDBC兼容数据库

### 2.2.2 创建JDBC数据源

让我们创建一个MySQL数据源：

1. 右键项目，选择New → Data Source
2. 选择"JDBC Data Source"，点击"Next"
3. 输入数据源名称，如"MySQL_Products"
4. 配置驱动设置：
   - Driver Class: com.mysql.cj.jdbc.Driver
   - URL: jdbc:mysql://localhost:3306/products
   - User Name: root
   - Password: ******
5. 点击"Test Connection"测试连接
6. 点击"Finish"保存数据源

### 2.2.3 JDBC连接池配置

为了提高性能，可以配置连接池：

1. 在数据源配置中，点击"Connection Pool"选项卡
2. 配置以下参数：
   - Minimum Connections: 2
   - Maximum Connections: 10
   - Login Timeout: 30秒
   - Query Timeout: 60秒
3. 点击"OK"保存配置

### 2.2.4 JDBC参数化查询

使用参数化查询可以提高安全性和性能：

```sql
SELECT product_id, product_name, price 
FROM products 
WHERE category_id = ? 
  AND price > ? 
  AND created_date >= ?
```

在BIRT中，这些参数可以映射为报表参数。

## 2.3 XML数据源

### 2.3.1 XML数据源概述

XML数据源用于访问XML格式的数据，可以处理：
- 本地XML文件
- 通过HTTP访问的XML文档
- Web服务返回的XML数据

### 2.3.2 创建XML数据源

1. 右键项目，选择New → Data Source
2. 选择"XML Data Source"，点击"Next"
3. 输入数据源名称
4. 选择XML来源：
   - File: 本地文件路径
   - URL: 网络资源URL
5. 配置XML解析选项：
   - Encoding: UTF-8
   - Namespace Aware: 是/否
   - Validation: 启用/禁用
6. 点击"Finish"保存

### 2.3.3 XPath表达式

XML数据源使用XPath表达式查询数据：

```xml
<!-- 示例XML文档 -->
<products>
  <product id="1" category="Electronics">
    <name>Smartphone</name>
    <price currency="USD">599.99</price>
    <stock>45</stock>
  </product>
  <product id="2" category="Electronics">
    <name>Laptop</name>
    <price currency="USD">999.99</price>
    <stock>12</stock>
  </product>
</products>
```

对应的XPath表达式：
- `/products/product` - 获取所有产品
- `/products/product[@category='Electronics']` - 获取电子产品
- `/products/product[price>500]` - 获取价格大于500的产品
- `/products/product/stock/text()` - 获取所有产品的库存量

## 2.4 脚本数据源

### 2.4.1 脚本数据源应用场景

脚本数据源适用于以下场景：
- 连接无标准驱动的数据源
- 处理复杂的业务逻辑
- 从多个源合并数据
- 动态生成测试数据

### 2.4.2 创建脚本数据源

1. 右键项目，选择New → Data Source
2. 选择"Scripted Data Source"，点击"Next"
3. 输入数据源名称
4. 配置脚本选项：
   - Script Type: JavaScript
   - Open方法脚本
   - Fetch方法脚本
   - Close方法脚本

### 2.4.3 脚本数据源示例

以下是一个生成随机销售数据的脚本数据源：

**Open方法：**
```javascript
// 初始化数据
count = 0;
maxRows = 100;
categories = ["Electronics", "Clothing", "Books", "Food", "Sports"];
```

**Fetch方法：**
```javascript
if (count < maxRows) {
    // 生成随机数据
    row["product_id"] = count + 1;
    row["product_name"] = "Product " + (count + 1);
    row["category"] = categories[Math.floor(Math.random() * categories.length)];
    row["price"] = Math.floor(Math.random() * 1000) + 10;
    row["quantity"] = Math.floor(Math.random() * 100) + 1;
    row["sale_date"] = new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
    
    count++;
    return true; // 继续获取下一行
}
return false; // 没有更多数据
```

**Close方法：**
```javascript
// 清理资源
count = 0;
```

## 2.5 Web服务数据源

### 2.5.1 Web服务数据源概述

Web服务数据源用于连接REST或SOAP Web服务，支持：
- GET/POST/PUT/DELETE等HTTP方法
- JSON/XML响应格式
- 请求头和认证配置
- 响应数据映射

### 2.5.2 创建REST数据源

1. 右键项目，选择New → Data Source
2. 选择"Web Services Data Source"，点击"Next"
3. 输入数据源名称
4. 配置服务端点：
   - Endpoint URL: https://api.example.com/data
   - HTTP Method: GET/POST
   - Content Type: application/json
5. 配置认证（如需要）：
   - Basic Authentication
   - OAuth 2.0
   - API Key
6. 点击"Test Connection"测试连接
7. 点击"Finish"保存

### 2.5.3 处理JSON响应

对于返回JSON的REST服务，BIRT会自动解析并创建数据结构：

```json
{
  "status": "success",
  "data": [
    {
      "id": 1,
      "name": "Product A",
      "price": 99.99,
      "category": "Electronics"
    },
    {
      "id": 2,
      "name": "Product B",
      "price": 149.99,
      "category": "Clothing"
    }
  ]
}
```

在数据集中，可以引用JSON路径：
- `$.data[*].id` - 获取所有产品ID
- `$.data[*].name` - 获取所有产品名称
- `$.data[?(@.price > 100)]` - 获取价格大于100的产品

## 2.6 数据集基础

### 2.6.1 什么是数据集？

数据集定义了从数据源中获取哪些数据以及如何组织这些数据。数据集是报表设计的核心组件，它：

- 指定查询语句或数据获取逻辑
- 定义数据列和数据类型
- 提供数据预览功能
- 支持参数化查询
- 缓存查询结果

### 2.6.2 数据集类型

BIRT支持多种类型的数据集：

1. **SQL Select Query**：标准SQL查询
2. **SQL Stored Procedure Query**：存储过程调用
3. **SQL Statement**：任意SQL语句
4. **XPath Query**：XML数据查询
5. **Script Data Set**：脚本生成数据
6. **Joint Data Set**：合并多个数据集
7. **Derived Data Set**：从其他数据集派生

## 2.7 SQL数据集

### 2.7.1 创建SQL数据集

1. 右键数据源，选择New → Data Set
2. 输入数据集名称，如"ProductSales"
3. 选择"SQL Select Query"作为查询类型
4. 在SQL编辑器中编写查询语句：
   ```sql
   SELECT p.product_id, p.product_name, c.category_name,
          s.sale_date, s.quantity, s.unit_price,
          s.quantity * s.unit_price as total_amount
   FROM products p
   JOIN categories c ON p.category_id = c.category_id
   JOIN sales s ON p.product_id = s.product_id
   WHERE s.sale_date >= ? 
     AND s.sale_date <= ?
   ORDER BY s.sale_date DESC, p.product_name
   ```
5. 点击"Finish"保存数据集
6. 在预览窗口查看数据

### 2.7.2 SQL参数化

参数化SQL查询可以增强安全性和灵活性：

```sql
SELECT p.product_id, p.product_name, p.price
FROM products p
WHERE p.category_id = ?          -- 类别ID参数
  AND p.price BETWEEN ? AND ?    -- 价格范围参数
  AND p.status = ?               -- 状态参数
ORDER BY p.product_name
```

参数自动创建并可以映射到报表参数：
- param_1 → category_id
- param_2 → min_price
- param_3 → max_price
- param_4 → status

### 2.7.3 复杂查询示例

使用子查询和窗口函数：

```sql
WITH monthly_sales AS (
  SELECT 
    product_id,
    EXTRACT(MONTH FROM sale_date) as sale_month,
    EXTRACT(YEAR FROM sale_DATE) as sale_year,
    SUM(quantity * unit_price) as monthly_total,
    COUNT(*) as transaction_count
  FROM sales
  WHERE sale_date BETWEEN ? AND ?
  GROUP BY product_id, 
           EXTRACT(MONTH FROM sale_date),
           EXTRACT(YEAR FROM sale_date)
)
SELECT 
  p.product_id,
  p.product_name,
  c.category_name,
  ms.sale_month,
  ms.sale_year,
  ms.monthly_total,
  ms.transaction_count,
  AVG(ms.monthly_total) OVER (
    PARTITION BY p.product_id 
    ORDER BY ms.sale_year, ms.sale_month
    ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
  ) as moving_avg_3months,
  RANK() OVER (
    PARTITION BY p.category_id, ms.sale_year, ms.sale_month
    ORDER BY ms.monthly_total DESC
  ) as rank_in_category
FROM products p
JOIN categories c ON p.category_id = c.category_id
JOIN monthly_sales ms ON p.product_id = ms.product_id
ORDER BY p.product_name, ms.sale_year, ms.sale_month
```

## 2.8 联合数据集

### 2.8.1 联合数据集概述

联合数据集（Joint Data Set）允许合并多个数据集的数据，支持：
- 内连接（INNER JOIN）
- 左连接（LEFT JOIN）
- 右连接（RIGHT JOIN）
- 全连接（FULL JOIN）

### 2.8.2 创建联合数据集

1. 右键项目，选择New → Data Set
2. 选择"Joint Data Set"，点击"Next"
3. 输入数据集名称，如"ProductSalesWithDetails"
4. 添加第一个数据集：
   - Data Set: ProductSales
   - Alias: sales
5. 添加第二个数据集：
   - Data Set: ProductDetails
   - Alias: details
6. 定义连接条件：
   - Left: sales.product_id
   - Operator: =
   - Right: details.product_id
7. 选择连接类型：INNER JOIN
8. 点击"Finish"保存

### 2.8.3 多表连接示例

创建一个包含产品、销售和客户信息的联合数据集：

```sql
-- 数据集1: 产品销售
SELECT product_id, sale_date, quantity, unit_price
FROM sales

-- 数据集2: 产品详情
SELECT product_id, product_name, category_id
FROM products

-- 数据集3: 类别信息
SELECT category_id, category_name
FROM categories

-- 连接条件
sales.product_id = products.product_id
products.category_id = categories.category_id
```

## 2.9 派生数据集

### 2.9.1 派生数据集概述

派生数据集（Derived Data Set）基于其他数据集创建，可以：
- 筛选现有数据
- 添加计算列
- 聚合数据
- 重新组织数据结构

### 2.9.2 创建派生数据集

1. 右键项目，选择New → Data Set
2. 选择"Derived Data Set"，点击"Next"
3. 输入数据集名称
4. 选择源数据集
5. 添加筛选条件
6. 添加计算列
7. 设置聚合选项
8. 点击"Finish"保存

### 2.9.3 计算列示例

在派生数据集中添加计算列：

```javascript
// 计算利润率
profit_margin = (sales_price - cost) / sales_price * 100;

// 计算库存状态
stock_status = (stock_quantity > reorder_level) ? "In Stock" : "Low Stock";

// 计算季度
quarter = Math.ceil(sale_month / 3);

// 格式化日期
formatted_date = new Date(sale_date).toLocaleDateString();
```

## 2.10 数据集性能优化

### 2.10.1 SQL优化技巧

1. **使用索引**：确保查询使用的列有适当的索引
2. **避免SELECT \***：只查询需要的列
3. **使用WHERE子句**：尽早过滤数据
4. **合理使用JOIN**：选择合适的连接类型
5. **避免子查询**：使用JOIN代替子查询

```sql
-- 不推荐
SELECT * FROM products WHERE product_id IN (
  SELECT product_id FROM sales WHERE sale_date > '2023-01-01'
)

-- 推荐
SELECT p.* FROM products p
JOIN sales s ON p.product_id = s.product_id
WHERE s.sale_date > '2023-01-01'
```

### 2.10.2 BIRT缓存策略

BIRT提供了多种缓存机制提高性能：

1. **报表缓存**：缓存整个报表结果
2. **数据集缓存**：缓存数据集查询结果
3. **元数据缓存**：缓存数据源元数据

配置缓存：
1. 在数据源属性中，选择"Caching"选项卡
2. 设置缓存选项：
   - Enable Caching: 启用缓存
   - Cache Duration: 缓存持续时间
   - Cache Size: 缓存大小限制

### 2.10.3 分页优化

对于大数据集，使用分页减少内存占用：

```sql
-- 使用LIMIT和OFFSET实现分页
SELECT product_id, product_name, price
FROM products
ORDER BY product_id
LIMIT ? OFFSET ?  -- ?1: 页大小, ?2: 偏移量
```

在BIRT中实现分页：
1. 创建报表参数：page_size, page_number
2. 在数据集中使用参数：
   - LIMIT: params["page_size"]
   - OFFSET: (params["page_number"] - 1) * params["page_size"]

## 2.11 数据安全

### 2.11.1 数据源安全

保护数据源连接信息：

1. **使用加密连接**：启用SSL/TLS
2. **最小权限原则**：只授予必要的数据库权限
3. **连接字符串安全**：避免明文存储密码
4. **审计日志**：记录数据访问日志

```java
// 安全的JDBC连接示例
String url = "jdbc:mysql://localhost:3306/products?useSSL=true";
Properties props = new Properties();
props.setProperty("user", "report_user");
props.setProperty("password", getEncryptedPassword());
Connection conn = DriverManager.getConnection(url, props);
```

### 2.11.2 SQL注入防护

使用参数化查询防止SQL注入：

```sql
-- 不安全 - 容易SQL注入
"SELECT * FROM users WHERE username = '" + username + "'"

-- 安全 - 使用参数化查询
"SELECT * FROM users WHERE username = ?"
```

## 2.12 最佳实践

### 2.12.1 数据源管理

1. **命名规范**：使用有意义的数据源名称
2. **集中管理**：在项目中统一管理数据源
3. **环境配置**：不同环境使用不同的数据源
4. **文档记录**：记录数据源的用途和配置

### 2.12.2 数据集设计

1. **最小化数据传输**：只查询必要的数据
2. **使用存储过程**：复杂逻辑放在数据库中
3. **合理使用缓存**：平衡性能和数据新鲜度
4. **参数化查询**：提高安全性和灵活性

### 2.12.3 性能优化

1. **定期优化**：定期审查和优化查询
2. **监控性能**：监控报表执行性能
3. **增量加载**：大数据集考虑增量加载
4. **异步处理**：长时间运行报表考虑异步处理

## 2.13 本章小结

本章详细介绍了BIRT的数据源和数据集管理。我们学习了：

- 各种类型的数据源及其应用场景
- JDBC、XML、脚本和Web服务数据源的创建和配置
- SQL数据集、联合数据集和派生数据集的使用
- 数据集性能优化技巧
- 数据安全最佳实践

掌握数据源和数据集是BIRT报表开发的基础，它们决定了报表的数据来源和数据处理能力。在下一章中，我们将学习如何设计和布局报表，将数据有效地呈现给用户。

## 2.14 实践练习

为了巩固本章知识，请完成以下练习：

1. 创建一个MySQL数据源，连接到示例数据库
2. 创建多个数据集，包括简单查询、参数化查询和复杂查询
3. 创建一个XML数据源，连接到示例XML文件
4. 创建一个脚本数据源，生成测试数据
5. 创建一个REST数据源，连接到公共API
6. 创建一个联合数据集，合并多个数据集
7. 实现数据集缓存，比较性能差异

完成这些练习后，您将掌握BIRT数据源和数据集的核心技能，为后续的报表设计打下坚实基础。