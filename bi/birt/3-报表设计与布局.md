# 第3章：报表设计与布局

## 3.1 报表设计基础

### 3.1.1 BIRT报表结构

BIRT报表采用分层结构设计，从上到下包括：

1. **报表（Report）**：最顶层容器
2. **主体（Body）**：报表的主要内容区域
3. **网格（Grid）**：行列布局容器
4. **表格（Table）**：数据展示容器
5. **列表（List）**：重复数据展示容器
6. **图表（Chart）**：数据可视化组件
7. **文本（Text）**：静态文本内容
8. **图像（Image）**：图像展示组件

### 3.1.2 报表设计器界面

BIRT报表设计器提供以下主要区域：

- **编辑器区域**：设计报表布局
- **数据资源管理器（Data Explorer）**：管理数据源和数据集
- **调色板（Palette）**：可拖放的组件
- **属性编辑器（Property Editor）**：设置组件属性
- **大纲（Outline）**：显示报表结构
- **预览（Preview）**：预览报表效果

### 3.1.3 报表元素分类

报表元素可分为以下几类：

1. **布局元素**：
   - 网格（Grid）
   - 表格（Table）
   - 列表（List）
   - 容器（Container）

2. **数据元素**：
   - 数据项（Data Item）
   - 动态文本（Dynamic Text）
   - 聚合（Aggregation）

3. **可视化元素**：
   - 图表（Chart）
   - 交叉表（Cross Tab）
   - 仪表（Gauge）
   - 地图（Map）

4. **装饰元素**：
   - 文本（Text）
   - 图像（Image）
   - 水平线（Horizontal Line）
   - 矩形（Rectangle）

## 3.2 网格布局

### 3.2.1 网格概述

网格（Grid）是BIRT中最基础的布局元素，它提供了一个行列结构，可以精确控制元素位置。网格特点：

- 固定行列结构
- 单元格可合并
- 支持嵌套
- 响应式布局
- 易于对齐元素

### 3.2.2 创建网格

1. 从调色板拖动Grid到报表设计器
2. 在创建网格对话框中设置：
   - 列数：如3列
   - 行数：如5行
3. 点击"OK"创建网格
4. 调整网格大小和位置

### 3.2.3 网格属性

网格的主要属性包括：

**布局属性：**
- Width：网格宽度
- Height：网格高度
- Columns：列数
- Column Widths：各列宽度
- Row Heights：各行高度

**外观属性：**
- Background Color：背景色
- Border：边框样式
- Padding：内边距
- Margin：外边距

### 3.2.4 单元格操作

单元格支持以下操作：

1. **合并单元格**：
   - 选中多个单元格
   - 右键选择"Merge Cells"

2. **拆分单元格**：
   - 选中合并的单元格
   - 右键选择"Split Cells"

3. **调整大小**：
   - 拖动行列边框
   - 在属性编辑器中设置精确值

### 3.2.5 网格布局示例

创建一个产品信息展示网格：

```
+---------------+----------------+-------------+
| 产品名称      | 类别           | 价格        |
+---------------+----------------+-------------+
| Smartphone    | Electronics    | $599.99     |
+---------------+----------------+-------------+
| Laptop        | Electronics    | $999.99     |
+---------------+----------------+-------------+
| T-Shirt       | Clothing       | $29.99      |
+---------------+----------------+-------------+
```

实现步骤：
1. 创建3×4的网格
2. 设置第一行为表头背景色
3. 添加文本元素作为列标题
4. 添加数据项显示产品信息
5. 设置边框和样式

## 3.3 表格布局

### 3.3.1 表格概述

表格（Table）是BIRT中最常用的数据展示组件，专门用于展示重复数据。表格特点：

- 自动扩展数据行
- 支持分组
- 内置聚合计算
- 灵活的样式控制
- 支持分页

### 3.3.2 表格结构

表格由以下部分组成：

```
Header (表头)
├── Header Row (表头行)
├── Header Group (表头分组)
Detail (明细)
├── Detail Row (明细行)
├── Detail Group (明细分组)
Footer (表尾)
├── Footer Row (表尾行)
├── Footer Group (表尾分组)
```

### 3.3.3 创建数据表格

1. 从Data Explorer拖动数据集到报表设计器
2. 选择"Table"作为展示方式
3. 在表格生成向导中：
   - 选择要显示的列
   - 设置表格样式
   - 配置分组和排序
4. 点击"Finish"创建表格

### 3.3.4 表格分组

分组是表格的重要功能，可以将数据按特定字段分组：

1. 右键表格，选择"Create Group"
2. 选择分组字段，如"category"
3. 设置分组选项：
   - Group Interval：分组间隔
   - Sort Direction：排序方向
   - Page Break：分页设置

分组后的表格结构：
```
Category: Electronics
├── Header Row: "Electronics"
├── Detail Rows: 产品数据
├── Footer Row: 分组汇总

Category: Clothing
├── Header Row: "Clothing"
├── Detail Rows: 产品数据
├── Footer Row: 分组汇总
```

### 3.3.5 表格聚合

表格内置多种聚合函数：

- SUM：求和
- COUNT：计数
- AVERAGE：平均值
- MIN：最小值
- MAX：最大值
- FIRST：第一个值
- LAST：最后一个值

添加聚合：
1. 在表格页脚行添加数据项
2. 右键数据项，选择"Edit Aggregate"
3. 选择聚合函数和字段
4. 设置计算范围

示例：
```
产品销售明细表
┌──────────────┬──────────┬─────────┐
│ 产品名称     │ 销售数量 │ 销售金额 │
├──────────────┼──────────┼─────────┤
│ Smartphone   │ 120      │ $71,999  │
│ Laptop       │ 85       │ $84,999  │
│ T-Shirt      │ 200      │ $5,998   │
├──────────────┼──────────┼─────────┤
│ 总计         │ 405      │ $162,996 │
└──────────────┴──────────┴─────────┘
```

## 3.4 列表布局

### 3.4.1 列表概述

列表（List）是另一种展示重复数据的组件，比表格更灵活。列表特点：

- 自由布局
- 嵌套能力强
- 适合复杂布局
- 支持条件显示
- 灵活的样式控制

### 3.4.2 创建列表

1. 从Data Explorer拖动数据集到报表设计器
2. 选择"List"作为展示方式
3. 在列表生成向导中配置选项
4. 点击"Finish"创建列表

### 3.4.3 列表嵌套

列表可以嵌套创建主从关系：

```
产品列表
├── 产品1
│   ├── 产品名称：Smartphone
│   ├── 价格：$599.99
│   ├── 特性列表
│   │   ├── 特性1：5.5英寸显示屏
│   │   ├── 特性2：128GB存储
│   │   └── 特性3：双摄像头
│   └── 供应商列表
│       ├── 供应商1：ABC Electronics
│       └── 供应商2：XYZ Tech
├── 产品2
│   └── ...
```

创建嵌套列表：
1. 创建主列表绑定产品数据集
2. 在主列表的Detail中添加子列表
3. 绑定子列表到特性数据集
4. 设置数据绑定关系

### 3.4.4 列表条件显示

列表支持基于数据的条件显示：

```javascript
// 显示条件示例
if (stock_quantity > 0) {
    // 显示购买按钮
    buyButton.visibility = "visible";
} else {
    // 显示缺货提示
    outOfStockLabel.visibility = "visible";
}
```

## 3.5 数据绑定

### 3.5.1 数据绑定概述

数据绑定是将报表元素与数据源连接的过程。BIRT提供多种数据绑定方式：

1. **直接绑定**：直接拖放数据项到报表
2. **表达式绑定**：使用表达式计算值
3. **脚本绑定**：使用JavaScript计算值
4. **参数绑定**：绑定报表参数

### 3.5.2 表达式绑定

使用BIRT表达式语言绑定数据：

```
// 基本字段绑定
row["product_name"]

// 表达式计算
row["quantity"] * row["unit_price"]

// 条件表达式
(row["price"] > 100) ? "Expensive" : "Affordable"

// 字符串连接
"Product: " + row["product_name"] + " ($" + row["price"] + ")"

// 日期格式化
new Date(row["sale_date"]).toLocaleDateString()

// 数学函数
Math.round(row["price"] * 1.1) // 10%税后价格
```

### 3.5.3 脚本绑定

在元素的事件脚本中设置数据：

```javascript
// onRender事件脚本
if (row["status"] === "Active") {
    this.getStyle().backgroundColor = "#E8F5E9"; // 浅绿色
    this.getStyle().color = "#1B5E20"; // 深绿色
} else {
    this.getStyle().backgroundColor = "#FFEBEE"; // 浅红色
    this.getStyle().color = "#B71C1C"; // 深红色
}
```

### 3.5.4 参数绑定

将报表参数绑定到元素：

```
// 绑定到文本元素
params["company_name"]

// 绑定到数据集
"SELECT * FROM sales WHERE sale_date >= '" + params["start_date"] + "'"
```

## 3.6 样式与格式

### 3.6.1 样式概述

BIRT提供丰富的样式控制选项：

1. **颜色样式**：
   - Background Color：背景色
   - Color：前景色（文字颜色）
   - Border Color：边框颜色

2. **字体样式**：
   - Font Family：字体系列
   - Font Size：字体大小
   - Font Weight：字体粗细
   - Font Style：字体样式（正常/斜体）
   - Text Decoration：文本装饰（下划线/删除线等）

3. **布局样式**：
   - Width/Height：宽度/高度
   - Padding：内边距
   - Margin：外边距
   - Text Align：文本对齐
   - Vertical Align：垂直对齐

### 3.6.2 共享样式

创建共享样式保持一致性：

1. 在Outline视图中右键Styles
2. 选择"New Style"
3. 设置样式属性：
   - Name: styleName
   - Selector: 元素类型或自定义选择器
   - Properties: 各种样式属性

示例样式：
```css
/* 表头样式 */
TableHeader {
    background-color: #1976D2;
    color: white;
    font-weight: bold;
    text-align: center;
    padding: 8px;
}

/* 数据行样式 */
DataRow {
    border-bottom: 1px solid #E0E0E0;
    padding: 6px;
}

/* 交替行样式 */
AlternateRow {
    background-color: #F5F5F5;
}

/* 高亮行样式 */
HighlightRow {
    background-color: #FFFDE7;
    border-left: 4px solid #FBC02D;
}
```

### 3.6.3 条件样式

基于数据应用条件样式：

```javascript
// 根据数值应用不同颜色
if (row["amount"] > 1000) {
    this.getStyle().color = "green";
    this.getStyle().fontWeight = "bold";
} else if (row["amount"] > 500) {
    this.getStyle().color = "orange";
} else {
    this.getStyle().color = "red";
}

// 根据状态应用背景色
switch(row["status"]) {
    case "Completed":
        this.getStyle().backgroundColor = "#E8F5E9";
        break;
    case "In Progress":
        this.getStyle().backgroundColor = "#FFF3E0";
        break;
    case "Pending":
        this.getStyle().backgroundColor = "#FFFDE7";
        break;
    default:
        this.getStyle().backgroundColor = "#F5F5F5";
}
```

## 3.7 响应式设计

### 3.7.1 响应式设计概述

响应式设计使报表在不同设备和屏幕尺寸下都能良好显示。BIRT提供以下响应式特性：

1. **自适应布局**：自动调整布局结构
2. **流体网格**：使用相对单位
3. **弹性图像**：图像自适应大小
4. **媒体查询**：根据屏幕尺寸应用样式

### 3.7.2 实现响应式设计

1. **使用相对单位**：
   ```
   Width: 100%
   Column Width: 33%
   Font Size: 1em
   ```

2. **弹性网格布局**：
   ```xml
   <grid width="100%">
     <column width="30%"></column>
     <column width="70%"></column>
   </grid>
   ```

3. **条件显示**：
   ```javascript
   // 根据屏幕宽度隐藏/显示元素
   if (params["screen_width"] < 768) {
       this.visibility = "hidden";
   }
   ```

## 3.8 分页控制

### 3.8.1 分页概述

分页控制将大数据集分成多页显示，提高可读性和性能。BIRT提供多种分页方式：

1. **自动分页**：根据页面大小自动分页
2. **手动分页**：在特定位置强制分页
3. **分组分页**：每个分组开始新页
4. **条件分页**：基于条件触发分页

### 3.8.2 配置分页

1. **报表级分页**：
   - 报表属性 → Page Setup
   - 设置页面大小、边距、方向

2. **表格级分页**：
   - 表格属性 → Pagination
   - 每页记录数
   - 分页位置

3. **分组分页**：
   - 分组属性 → Page Break
   - Before: 分组前分页
   - After: 分组后分页

### 3.8.3 分页导航

添加分页导航组件：

1. 在报表页脚添加导航文本
2. 使用表达式显示页码：
   ```
   Page: <value-of>pageNumber</value-of> of <value-of>totalPages</value-of>
   ```
3. 添加导航链接：
   - 首页: `__page=1`
   - 上一页: `__page=pageNumber-1`
   - 下一页: `__page=pageNumber+1`
   - 末页: `__page=totalPages`

## 3.9 交叉表

### 3.9.1 交叉表概述

交叉表（Cross Tab）是一种矩阵式报表，适合多维度数据分析。交叉表特点：

- 多维度数据展示
- 动态行列扩展
- 内置聚合计算
- 支持数据钻取
- 适合统计分析

### 3.9.2 创建交叉表

1. 从调色板拖动Cross Tab到报表
2. 设置交叉表维度：
   - Row Groups：行分组维度
   - Column Groups：列分组维度
   - Measures：度量值

示例结构：
```
           | Q1     | Q2     | Q3     | Q4     | Total
-----------+--------+--------+--------+--------+-------
Electronics| 12,500 | 15,800 | 18,200 | 20,100 | 66,600
Clothing   | 8,300  | 9,500  | 7,800  | 11,200 | 36,800
Books      | 3,200  | 3,500  | 4,100  | 5,300  | 16,100
-----------+--------+--------+--------+--------+-------
Total      | 24,000 | 28,800 | 30,100 | 36,600 | 119,500
```

### 3.9.3 交叉表高级功能

1. **计算成员**：
   ```javascript
   // 添加同比增长率
   growth_rate = (current_value - previous_value) / previous_value * 100;
   ```

2. **条件格式**：
   ```javascript
   // 基于数值应用颜色
   if (value > target) {
       this.getStyle().color = "green";
   } else {
       this.getStyle().color = "red";
   }
   ```

## 3.10 实战案例

### 3.10.1 销售报表设计

设计一个完整的销售报表，包含：

1. **报表头部**：
   - 公司名称
   - 报表标题
   - 生成时间

2. **参数区**：
   - 日期范围选择
   - 区域选择
   - 产品类别选择

3. **数据展示区**：
   - 销售汇总图表
   - 销售明细表格
   - 交叉表分析

4. **报表页脚**：
   - 汇总信息
   - 页码
   - 版权信息

### 3.10.2 实现步骤

1. **创建报表结构**：
   - 添加网格作为布局容器
   - 设计3行布局：头部、内容、页脚

2. **添加参数**：
   - 创建报表参数：start_date, end_date, region, category
   - 添加参数输入控件

3. **设计数据区域**：
   - 添加图表展示销售趋势
   - 添加表格显示销售明细
   - 添加交叉表分析区域和产品

4. **样式设计**：
   - 创建共享样式
   - 应用公司品牌色彩
   - 设置字体和布局

5. **交互功能**：
   - 图表钻取到明细表
   - 表格排序
   - 导出功能

## 3.11 最佳实践

### 3.11.1 布局设计原则

1. **一致性**：保持整个报表的风格一致
2. **简洁性**：避免过度装饰，突出重要信息
3. **可读性**：确保文字清晰可读，对比度适中
4. **平衡性**：合理分配空间，避免拥挤或空洞
5. **重点突出**：使用颜色、大小等强调重要信息

### 3.11.2 性能优化

1. **减少元素数量**：避免过多的装饰元素
2. **合理使用分组**：避免过深的嵌套结构
3. **分页大数据集**：避免一次性加载过多数据
4. **缓存计算结果**：对复杂计算使用缓存
5. **异步加载**：对于复杂报表考虑异步加载

### 3.11.3 用户体验

1. **清晰的导航**：提供明确的页面导航
2. **合理的参数**：参数要有默认值和合理的范围
3. **快速反馈**：长时间操作提供进度指示
4. **多格式导出**：支持PDF、Excel、HTML等格式
5. **打印友好**：确保打印效果良好

## 3.12 本章小结

本章详细介绍了BIRT的报表设计和布局技术。我们学习了：

- BIRT报表的结构和设计界面
- 网格、表格和列表的使用方法
- 数据绑定和表达式应用
- 样式设计和条件格式
- 响应式设计和分页控制
- 交叉表的创建和配置
- 完整报表的设计流程

掌握报表设计和布局是BIRT开发的核心技能，它们决定了报表的外观和用户体验。在下一章中，我们将学习BIRT的图表与可视化功能，进一步增强报表的数据表现力。

## 3.13 实践练习

为了巩固本章知识，请完成以下练习：

1. 创建一个包含多种布局元素的报表
2. 设计一个具有分组和聚合的销售报表
3. 实现条件样式，根据数据值应用不同格式
4. 创建一个响应式报表，适应不同屏幕尺寸
5. 设计一个包含交叉表的多维度分析报表
6. 实现报表的分页和导航功能
7. 创建一个完整的销售报表，包含头部、参数区、数据区和页脚

完成这些练习后，您将掌握BIRT报表设计的核心技能，能够创建专业、美观的报表界面。