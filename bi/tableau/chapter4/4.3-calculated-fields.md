# 4.3 计算字段与函数

## 计算字段概述

计算字段是Tableau中最强大的功能之一，它允许用户创建新的数据字段，基于现有字段执行各种计算和转换。通过计算字段，您可以扩展数据分析能力，创建自定义指标，并实现复杂的业务逻辑。

## 计算字段基础

### 创建计算字段

1. **基本创建方法**
   ```markdown
   1. 在数据窗格中，右键点击并选择"创建计算字段"
   2. 或在顶部菜单中选择"分析" > "创建计算字段"
   3. 或在工具栏中点击"创建计算字段"按钮
   4. 在对话框中输入字段名称和计算公式
   5. 点击"确定"保存计算字段
   ```

2. **计算字段命名**
   ```markdown
   1. 使用描述性名称，清楚表明字段含义
   2. 遵循命名约定：
      - 以字母开头
      - 不包含空格（可以使用下划线）
      - 不使用Tableau保留关键字
   3. 考虑添加注释说明复杂计算字段的用途
   ```

### 计算字段类型

1. **基本计算**
   - 执行行级计算
   - 适用于每行数据
   - 计算结果可以聚合

2. **聚合计算**
   - 执行聚合级别计算
   - 使用聚合函数（SUM、AVG、MIN、MAX等）
   - 结果不可进一步聚合

3. **表计算**
   - 基于视图中的数据计算
   - 依赖于数据在视图中的组织方式
   - 包括移动计算、差异计算等

4. **LOD表达式**
   - 详细级别表达式
   - 独立于视图详细级别的计算
   - 包括FIXED、INCLUDE、EXCLUDE

## 基本函数与运算符

### 数值函数

1. **基本数学函数**
   ```markdown
   1. ABS(number)：返回绝对值
      示例：ABS([折扣]) 将负折扣值转为正数
   
   2. CEILING(number)：向上取整
      示例：CEILING([价格]) 将价格向上取整为整数
   
   3. FLOOR(number)：向下取整
      示例：FLOOR([价格]) 将价格向下取整为整数
   
   4. ROUND(number, [decimals])：四舍五入
      示例：ROUND([销售额], 1) 将销售额保留一位小数
   
   5. SIGN(number)：返回数字的符号（1、0或-1）
      示例：SIGN([利润]) 判断利润是正、零还是负
   ```

2. **高级数学函数**
   ```markdown
   1. POWER(number, exponent)：幂运算
      示例：POWER([面积], 0.5) 计算面积的平方根
   
   2. SQRT(number)：平方根
      示例：SQRT([数量]) 计算数量的平方根
   
   3. LOG(number, [base])：对数
      示例：LOG([销售额], 10) 计算销售额的常用对数
   
   4. MOD(number, divisor)：模运算（余数）
      示例：MOD([订单ID], 100) 获取订单ID的末两位
   ```

### 字符串函数

1. **基本字符串操作**
   ```markdown
   1. LEFT(string, number)：从左边截取字符
      示例：LEFT([产品代码], 3) 获取产品代码前3位
   
   2. RIGHT(string, number)：从右边截取字符
      示例：RIGHT([电话号码], 4) 获取电话号码后4位
   
   3. MID(string, start, [length])：从中间截取字符
      示例：MID([产品代码], 4, 2) 获取产品代码第4-5位
   
   4. LEN(string)：字符串长度
      示例：LEN([描述]) 计算描述的字符长度
   ```

2. **字符串转换与处理**
   ```markdown
   1. LOWER(string)：转换为小写
      示例：LOWER([城市名]) 统一城市名为小写
   
   2. UPPER(string)：转换为大写
      示例：UPPER([客户代码]) 统一客户代码为大写
   
   3. TRIM(string)：移除前后空格
      示例：TRIM([产品名称]) 移除产品名称前后空格
   
   4. REPLACE(string, substring, replacement)：替换字符串
      示例：REPLACE([地址], "Street", "St.") 简化地址表述
   
   5. CONTAINS(string, substring)：检查包含
      示例：CONTAINS([描述], "Premium") 检查描述是否包含"Premium"
   
   6. SPLIT(string, delimiter, token_number)：分割字符串
      示例：SPLIT([全名], " ", 1) 获取全名中的姓氏
   ```

### 日期函数

1. **基本日期操作**
   ```markdown
   1. YEAR(date)：提取年份
      示例：YEAR([订单日期]) 获取订单年份
   
   2. MONTH(date)：提取月份
      示例：MONTH([订单日期]) 获取订单月份
   
   3. DAY(date)：提取日期
      示例：DAY([订单日期]) 获取订单日
   
   4. WEEK(date)：提取周数
      示例：WEEK([订单日期]) 获取订单是第几周
   ```

2. **日期计算与转换**
   ```markdown
   1. DATEADD(date_part, increment, date)：日期加减
      示例：DATEADD('month', 3, [订单日期]) 获取订单日期后3个月
   
   2. DATEDIFF(date_part, date1, date2)：日期差
      示例：DATEDIFF('day', [发货日期], [订单日期]) 计算发货天数
   
   3. DATETRUNC(date_part, date)：日期截断
      示例：DATETRUNC('month', [订单日期]) 获取订单日期所在月的第一天
   
   4. DATEPART(date_part, date)：提取日期部分
      示例：DATEPART('weekday', [订单日期]) 获取订单是星期几
   
   5. MAKEDATE(year, month, day)：创建日期
      示例：MAKEDATE(2023, 12, 25) 创建2023年12月25日
   ```

### 逻辑函数

1. **IF语句**
   ```markdown
   1. 基本IF语句：
      IF [条件] THEN [结果] 
      ELSE [其他结果] 
      END
   
   2. 多条件IF语句：
      IF [销售额] > 10000 THEN "高"
      ELSEIF [销售额] > 5000 THEN "中"
      ELSE "低" 
      END
   
   3. IF IIF简化语法：
      IIF([销售额] > 10000, "高", "低")
   ```

2. **条件判断函数**
   ```markdown
   1. CASE语句：
      CASE [类别]
        WHEN "家具" THEN "耐用品"
        WHEN "办公用品" THEN "消耗品"
        ELSE "其他"
      END
   
   2. ISNULL(value)：检查是否为空
      示例：IF ISNULL([折扣]) THEN 0 ELSE [折扣] END
   
   3. ZN(value)：空值转零
      示例：ZN([利润]) 将利润的空值转为0
   ```

### 聚合函数

1. **基本聚合函数**
   ```markdown
   1. SUM(expression)：总和
      示例：SUM([销售额]) 计算销售额总和
   
   2. AVG(expression)：平均值
      示例：AVG([价格]) 计算平均价格
   
   3. MIN(expression)：最小值
      示例：MIN([日期]) 计算最早日期
   
   4. MAX(expression)：最大值
      示例：MAX([日期]) 计算最晚日期
   
   5. COUNT(expression)：计数（非空值）
      示例：COUNT([客户ID]) 计算客户数量
   
   6. COUNTD(expression)：去重计数
      示例：COUNTD([产品ID]) 计算不重复产品数量
   ```

2. **条件聚合**
   ```markdown
   1. 使用IF语句进行条件聚合：
      SUM(IF [类别] = "家具" THEN [销售额] END)
   
   2. 使用IIF进行条件聚合：
      SUM(IIF([利润] > 0, [利润], 0)) 只计算正利润
   ```

## 高级计算技术

### 表计算

1. **基本表计算**
   ```markdown
   1. 快速表计算：
      - 右键点击度量字段
      - 选择"快速表计算"
      - 选择计算类型（如"移动平均"）
   
   2. 表计算编辑：
      - 右键点击表计算字段
      - 选择"编辑表计算"
      - 配置计算类型、方向和范围
   ```

2. **自定义表计算**
   ```markdown
   1. WINDOW_SUM(expression, [start], [end])：窗口求和
      示例：WINDOW_SUM(SUM([销售额]), -3, 0) 最近4个月总和
   
   2. LOOKUP(expression, [offset])：查找值
      示例：LOOKUP(SUM([销售额]), -1) 上一期的销售额
   
   3. RUNNING_SUM(expression)：累计求和
      示例：RUNNING_SUM(SUM([销售额])) 累计销售额
   
   4. PERCENTILE(expression, number)：百分位数
      示例：PERCENTILE([价格], 0.5) 价格的中位数
   ```

### LOD表达式

1. **FIXED表达式**
   ```markdown
   1. 基本语法：{FIXED [维度1], [维度2] : 聚合函数}
   
   2. 示例：
      {FIXED [客户ID] : SUM([销售额])} 每个客户的总销售额
   
   3. 应用：
      [客户年度销售额] = {FIXED [客户ID], YEAR([订单日期]) : SUM([销售额])}
   
   4. 特点：
      - 忽略视图中的详细级别
      - 指定维度进行分组计算
      - 结果可在视图任何级别使用
   ```

2. **INCLUDE表达式**
   ```markdown
   1. 基本语法：{INCLUDE [维度1], [维度2] : 聚合函数}
   
   2. 示例：
      {INCLUDE [产品ID] : AVG([折扣])} 包含产品级别的平均折扣
   
   3. 应用：
      [客户平均购买商品数] = {INCLUDE [产品ID] : COUNTD([产品ID])}
   
   4. 特点：
      - 在视图详细级别基础上添加指定维度
      - 计算结果更细致
      - 适合添加额外分析维度
   ```

3. **EXCLUDE表达式**
   ```markdown
   1. 基本语法：{EXCLUDE [维度1], [维度2] : 聚合函数}
   
   2. 示例：
      {EXCLUDE [产品ID] : SUM([销售额])} 排除产品级别的销售额总和
   
   3. 应用：
      [地区总销售额] = {EXCLUDE [城市] : SUM([销售额])} 地区级别总销售额
   
   4. 特点：
      - 从视图详细级别中排除指定维度
      - 计算结果更聚合
      - 适合计算更高级别的指标
   ```

### 参数化计算

1. **创建参数**
   ```markdown
   1. 在数据窗格中，右键点击并选择"创建参数"
   2. 设置参数属性：
      - 名称：描述性名称
      - 数据类型：整数、浮点数、字符串、日期、布尔值
      - 当前值：默认值
      - 允许的值：全部、列表、范围
   3. 配置可选值列表（如选择"列表"）
   ```

2. **使用参数**
   ```markdown
   1. 基本参数使用：
      IF [销售额] > [销售阈值参数] THEN "高" ELSE "低" END
   
   2. 动态Top N：
      IF RANK(SUM([销售额]), 'desc') <= [Top N参数] THEN "Top " + STR([Top N参数]) ELSE "其他" END
   
   3. 日期范围筛选：
      [订单日期] >= [开始日期参数] AND [订单日期] <= [结束日期参数]
   ```

## 实用计算字段示例

### 业务指标计算

1. **利润相关指标**
   ```markdown
   1. 利润率：
      [利润率] = SUM([利润]) / SUM([销售额])
   
   2. 毛利率：
      [毛利率] = SUM([利润]) / (SUM([销售额]) - SUM([折扣]))
   
   3. 目标达成率：
      [达成率] = SUM([实际销售]) / SUM([目标销售])
   ```

2. **客户相关指标**
   ```markdown
   1. 客户生命周期价值：
      [CLV] = {FIXED [客户ID] : SUM([销售额])} * {FIXED [客户ID] : COUNTD([订单ID])}
   
   2. 客户购买频率：
      [购买频率] = {FIXED [客户ID] : COUNTD([订单ID])} / DATEDIFF('month', MIN([订单日期]), MAX([订单日期]))
   
   3. 新老客户标识：
      [客户类型] = IF {FIXED [客户ID] : MIN([订单日期])} = [订单日期] THEN "新客户" ELSE "老客户" END
   ```

3. **时间相关指标**
   ```markdown
   1. 同比增长：
      [同比增长] = (SUM([销售额]) - LOOKUP(SUM([销售额]), -12)) / LOOKUP(SUM([销售额]), -12)
   
   2. 环比增长：
      [环比增长] = (SUM([销售额]) - LOOKUP(SUM([销售额]), -1)) / LOOKUP(SUM([销售额]), -1)
   
   3. 移动平均：
      [3个月移动平均] = WINDOW_AVG(SUM([销售额]), -2, 0)
   ```

### 数据处理与转换

1. **文本处理**
   ```markdown
   1. 标准化电话号码：
      [标准电话] = "(" + MID([电话], 1, 3) + ") " + MID([电话], 4, 3) + "-" + MID([电话], 7, 4)
   
   2. 提取域名：
      [域名] = MID([邮箱], FIND([邮箱], "@") + 1, LEN([邮箱]))
   
   3. 客户姓名规范化：
      [标准姓名] = UPPER(LEFT([姓名], 1)) + LOWER(MID([姓名], 2))
   ```

2. **日期处理**
   ```markdown
   1. 季度计算：
      [季度] = "Q" + STR(CEILING(MONTH([日期]) / 3))
   
   2. 工作日判断：
      [工作日] = IF DATEPART('weekday', [日期]) IN (1, 7) THEN "否" ELSE "是" END
   
   3. 财年计算：
      [财年] = IF MONTH([日期]) > 6 THEN YEAR([日期]) + 1 ELSE YEAR([日期]) END
   ```

## 计算字段性能优化

### 优化原则

1. **简化计算逻辑**
   ```markdown
   1. 使用更简单的函数替代复杂计算
   2. 减少嵌套层次
   3. 避免不必要的字符串操作
   4. 使用适当的数据类型
   ```

2. **使用LOD替代表计算**
   ```markdown
   1. 在适当场景下，LOD表达式比表计算更高效
   2. FIXED LOD通常比INCLUDE/EXCLUDE更高效
   3. 减少视图复杂度可以提高LOD性能
   ```

### 性能测试

1. **查询性能分析**
   ```markdown
   1. 使用"性能工作簿"分析计算字段性能
   2. 查看查询执行时间和查询记录数
   3. 识别高开销的计算字段
   4. 针对性优化性能瓶颈
   ```

2. **数据提取优化**
   ```markdown
   1. 复杂计算在数据提取中通常更高效
   2. 考虑在数据源层面执行复杂计算
   3. 减少实时连接上的复杂计算
   ```

## 实验练习

为了巩固本章所学知识，请完成以下练习：

1. **基础计算字段**
   - 创建计算字段转换数据格式
   - 使用各种函数进行数据处理
   - 实现基本的业务指标计算

2. **高级计算技术**
   - 创建表计算分析趋势
   - 使用LOD表达式实现跨级别分析
   - 设计参数化计算提供交互性

3. **业务场景应用**
   - 计算客户生命周期价值
   - 分析产品销售趋势和季节性
   - 创建动态KPI仪表盘

4. **性能优化**
   - 分析计算字段的查询性能
   - 优化复杂计算字段
   - 比较不同实现方式的性能差异

通过完成这些练习，您将掌握Tableau中的计算字段技术，能够创建复杂的业务逻辑和自定义分析功能。