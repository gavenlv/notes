# 2.2 数据清洗与转换

## 数据准备概述

数据准备是数据分析过程中的关键步骤，它包括数据清洗、转换和结构化。Tableau提供了强大的数据准备功能，使用户能够在分析前对数据进行必要的处理。本章将详细介绍如何使用Tableau进行数据清洗和转换，以及如何使用Tableau Prep进行更复杂的数据准备工作。

## Tableau内置数据准备功能

### 数据源页面功能

Tableau的数据源页面提供了基本的数据准备功能，包括：

1. **数据预览与筛选**
2. **字段重命名和隐藏**
3. **数据类型更改**
4. **拆分字段**
5. **数据解释器**
6. **数据透视**
7. **简单计算字段**

### 数据解释器

数据解释器是Tableau的智能数据准备工具，可以自动处理常见的数据质量问题：

1. **功能特点**
   - 自动识别并处理表头
   - 智能联接相关表
   - 转换交叉表为列式数据
   - 处理空值和重复数据

2. **使用方法**
   ```markdown
   1. 连接到Excel或文本文件数据源
   2. 在数据源页面，勾选"使用数据解释器"
   3. Tableau将自动分析并建议转换操作
   4. 查看并应用建议的转换
   ```

3. **适用场景**
   - 不规范的Excel文件
   - 交叉表格式数据
   - 多表联接的Excel工作簿
   - 需要自动清理的文本文件

### 字段操作

1. **重命名字段**
   - 右键点击字段标题
   - 选择"重命名"
   - 输入新名称

2. **更改数据类型**
   - 右键点击字段标题
   - 选择"更改数据类型"
   - 从列表中选择适当类型

3. **隐藏字段**
   - 右键点击字段标题
   - 选择"隐藏"
   - 隐藏的字段不会出现在分析视图中

4. **拆分字段**
   ```markdown
   1. 右键点击包含复合数据的字段
   2. 选择"拆分"
   3. 选择拆分方式：
      - 自动：基于分隔符自动拆分
      - 自定义：指定分隔符
   4. Tableau将创建新字段
   ```

5. **创建计算字段**
   ```markdown
   1. 在数据窗格中，右键点击并选择"创建计算字段"
   2. 输入字段名称
   3. 编写计算公式
   4. 点击"确定"
   
   示例：创建全名字段
   名称：[全名]
   公式：[名字] + " " + [姓氏]
   ```

### 数据透视

数据透视功能可以将列式数据转换为行式数据：

1. **应用场景**
   - 交叉表转换为行式数据
   - 多个相似列合并为单一列
   - 时间序列数据重塑

2. **操作步骤**
   ```markdown
   1. 选择要透视的多个列（按住Ctrl或Shift选择）
   2. 右键点击选中的列
   3. 选择"透视"
   4. Tableau将创建两个新字段：
      - "透视字段名称"：原始列名
      - "透视字段值"：原始值
   5. 重命名这些字段以更具描述性
   ```

## Tableau Prep概述

Tableau Prep是专门的数据准备工具，提供更强大的数据转换和清洗功能：

### Tableau Prep界面组件

1. **流程窗格**：显示整个数据准备流程
2. **连接窗格**：管理和配置数据连接
3. **画布**：设计数据转换流程
4. **配置窗格**：配置当前步骤的详细信息
5. **字段窗格**：查看和操作字段

### Tableau Prep核心功能

1. **数据连接**
   - 支持与Tableau Desktop相同的数据源
   - 连接到多个数据源
   - 联接和融合数据

2. **清洗步骤**
   - 清理：重命名、更改数据类型、删除字段
   - 筛选：移除不需要的数据
   - 分组：合并相似值
   - 填充：处理空值

3. **转换步骤**
   - 透视：行列转换
   - 聚合：数据汇总
   - 联接：合并多个数据源
   - 联合：堆叠相似数据

4. **脚本步骤**
   - Python脚本集成
   - R脚本集成
   - 自定义数据转换

## Tableau Prep基础操作

### 创建数据准备流程

1. **启动Tableau Prep**
   ```markdown
   1. 启动Tableau Prep Builder
   2. 点击"文件" > "新建流程"
   3. 在连接窗格中，选择要连接的数据源
   4. 配置连接设置
   5. 将数据源拖拽到画布上
   ```

2. **添加清理步骤**
   ```markdown
   1. 右键点击输入步骤
   2. 选择"添加清理步骤"
   3. 在配置窗格中：
      - 重命名字段
      - 更改数据类型
      - 删除不需要的字段
      - 分组和修改字段值
   ```

3. **添加筛选步骤**
   ```markdown
   1. 右键点击清理步骤
   2. 选择"添加筛选步骤"
   3. 配置筛选条件：
      - 选择字段
      - 选择操作符（等于、不等于、包含等）
      - 输入或选择值
      - 添加多个条件时选择逻辑运算符（AND/OR）
   ```

### 数据清洗技术

1. **处理空值**
   ```markdown
   处理空值的不同策略：
   
   1. 在清理步骤中：
      - 选中含有空值的字段
      - 在配置窗格中，选择空值处理方式
      - 选项：保留、删除或替换
   
   2. 使用计算字段：
      - 创建条件计算
      - 示例：IFNULL([字段名], 0)
   
   3. 使用填充步骤：
      - 添加填充步骤
      - 选择填充策略（如用前一个值填充）
   ```

2. **数据分组**
   ```markdown
   1. 在清理步骤中，选中要分组的字段
   2. 在配置窗格中，点击"分组"
   3. 选择分组方式：
      - 拼写：分组拼写相似的值
      - 常用字符：分组包含特定字符的值
      - 手动：手动指定分组
   4. 查看并调整分组结果
   ```

3. **数据类型转换**
   ```markdown
   1. 在清理步骤中，选中字段
   2. 在配置窗格中，更改数据类型
   3. 特殊情况：
      - 字符串转数字：STR([数字字段]) 或 FLOAT([字符串字段])
      - 字符串转日期：DATEPARSE('格式', [字符串日期])
      - 日期转字符串：STR([日期字段])
   ```

### 数据转换技术

1. **数据透视**
   ```markdown
   1. 选中要透视的多个字段
   2. 右键点击，选择"透视"
   3. 配置透视设置：
      - 透视字段名称列：包含原始列名的列
      - 透视字段值列：包含原始值的列
   4. 重命名生成的列
   ```

2. **数据聚合**
   ```markdown
   1. 添加聚合步骤
   2. 选择分组字段（不进行聚合的字段）
   3. 选择聚合字段和聚合类型：
      - 总和
      - 平均值
      - 计数
      - 最小值/最大值
      - 中位数
   ```

3. **数据联接**
   ```markdown
   1. 添加第二个数据源到画布
   2. 从第一个数据源拖拽连接线到第二个数据源
   3. 在联接配置中：
      - 选择联接类型（内部、左、右、完全外部）
      - 选择联接字段
      - 设置联接子句
   4. 预览联接结果
   ```

## Tableau Prep高级功能

### 联合多个数据源

1. **添加联合步骤**
   ```markdown
   1. 添加多个数据源到画布
   2. 从第一个数据源拖拽连接线
   3. 选择"添加联合"
   4. 在联合配置中：
      - 选择联合类型（自动或手动）
      - 配置字段映射
      - 设置通配符匹配（如适用）
   ```

2. **自动联合配置**
   ```markdown
   对于具有相似结构的多个文件：
   
   1. 添加第一个文件作为输入
   2. 在配置窗格中，选择"通配符联合"
   3. 设置文件模式匹配规则
   4. Tableau将自动查找并联合匹配的文件
   ```

### 流程控制

1. **分支和条件流**
   ```markdown
   1. 在清理步骤后，右键点击
   2. 选择"添加清理步骤"
   3. 在新步骤中配置筛选条件
   4. 创建多个分支处理不同的数据子集
   5. 可以在后续步骤中使用联合步骤合并结果
   ```

2. **输出配置**
   ```markdown
   1. 在流程末尾，添加输出步骤
   2. 配置输出设置：
      - 输出类型：文件或数据库表
      - 文件格式：.hyper、.csv或.parquet
      - 输出位置和名称
      - 创建方式：替换、追加或创建
   3. 设置输出文件选项
   ```

### 脚本集成

1. **Python脚本集成**
   ```markdown
   1. 在流程中添加脚本步骤
   2. 选择"脚本类型"为"TabPy脚本"
   3. 配置TabPy连接：
      - 服务器地址
      - 端口
      - 用户名/密码（如需要）
   4. 编写Python脚本处理数据
   5. 配置输入输出字段映射
   ```

2. **R脚本集成**
   ```markdown
   1. 在流程中添加脚本步骤
   2. 选择"脚本类型"为"RServe脚本"
   3. 配置RServe连接
   4. 编写R脚本处理数据
   5. 配置输入输出字段映射
   ```

## 数据准备最佳实践

### 数据质量评估

1. **数据质量检查清单**
   ```markdown
   在开始分析前，检查以下方面：
   
   1. 完整性：记录是否完整，是否有缺失值
   2. 准确性：数据是否准确，是否有错误值
   3. 一致性：数据格式是否一致，命名规范是否统一
   4. 唯一性：是否有重复记录
   5. 及时性：数据是否最新，更新频率是否合适
   ```

2. **数据质量评估方法**
   ```markdown
   1. 查看字段摘要统计：
      - 唯一值计数
      - 空值比例
      - 数据分布
   2. 使用Tableau创建数据质量仪表盘
   3. 使用表计算检查数据异常
   4. 比较数据源之间的数据一致性
   ```

### 数据准备流程设计

1. **设计原则**
   ```markdown
   1. 线性流程：避免复杂分支和循环
   2. 模块化设计：将复杂步骤分解为小模块
   3. 可重复性：确保流程可以重复执行
   4. 可维护性：添加描述和注释
   5. 性能考虑：尽早筛选数据以减少处理量
   ```

2. **文档记录**
   ```markdown
   1. 为每个步骤添加描述性名称
   2. 使用注释说明复杂转换
   3. 记录数据源和变更历史
   4. 创建流程文档说明业务逻辑
   ```

### 性能优化

1. **减少数据处理量**
   ```markdown
   1. 尽早应用筛选器，减少后续处理的数据量
   2. 删除不需要的字段，减少内存使用
   3. 使用聚合减少行数
   4. 只在必要时联接数据
   ```

2. **优化联接操作**
   ```markdown
   1. 使用索引字段进行联接
   2. 确保联接字段数据类型匹配
   3. 使用适当大小的数据类型（如用整数代替字符串）
   4. 考虑在数据库层面进行预联接
   ```

## 实际案例

### 案例1：销售数据清洗

**场景**：从多个Excel文件合并季度销售数据，并进行清洗和分析

**数据源**：
- Q1_Sales.xlsx
- Q2_Sales.xlsx
- Q3_Sales.xlsx
- Q4_Sales.xlsx

**问题**：
- 各季度文件结构略有不同
- 日期格式不一致
- 产品名称存在拼写变体
- 部分记录缺少销售地区

**解决方案**：
```markdown
1. 在Tableau Prep中创建新流程
2. 添加四个Excel文件作为输入
3. 使用联合步骤合并所有季度数据
4. 添加清理步骤：
   - 重命名字段为统一名称
   - 更改数据类型（日期、数字）
   - 分组处理产品名称变体
5. 添加计算步骤创建统一日期格式
6. 添加筛选步骤移除无效记录
7. 创建输出数据源用于分析
```

### 案例2：客户数据整合

**场景**：整合来自CRM系统和销售系统的客户数据，创建360度客户视图

**数据源**：
- CRM系统导出（客户基本信息）
- 销售系统导出（交易记录）
- 营销系统导出（营销活动参与记录）

**解决方案**：
```markdown
1. 添加三个数据源到Tableau Prep流程
2. 清洗每个数据源：
   - 标准化客户ID
   - 统一日期格式
   - 处理缺失值
3. 使用客户ID联接三个数据源
4. 添加聚合步骤计算客户指标：
   - 总销售额
   - 购买频率
   - 平均订单价值
   - 参与的营销活动数
5. 添加计算字段创建客户分群
6. 输出整合后的客户数据
```

## 实验练习

为了巩固本章所学知识，请完成以下练习：

1. **基础数据清洗**
   - 连接到包含质量问题的CSV文件
   - 使用Tableau数据解释器自动修复问题
   - 手动清理剩余问题

2. **数据透视转换**
   - 将交叉表格式数据转换为行式数据
   - 创建适当的分析型数据结构

3. **Tableau Prep流程创建**
   - 创建一个包含多个步骤的数据准备流程
   - 包含输入、清理、筛选、转换和输出步骤
   - 添加适当的注释和文档

4. **多数据源整合**
   - 连接多个相关数据源
   - 使用联接和联合整合数据
   - 创建统一的分析数据集

通过完成这些练习，您将掌握Tableau的数据准备功能，能够处理常见的数据质量问题，创建适合分析的数据集。