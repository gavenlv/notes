# 2.1 数据源连接

## 数据源概述

Tableau的核心功能之一是能够连接到各种数据源。了解如何有效地连接和管理数据源是成功使用Tableau的关键。本章将详细介绍如何连接不同类型的数据源，以及如何优化数据连接性能。

## Tableau支持的数据源类型

Tableau支持连接到数百种不同的数据源，可以分为以下几大类：

### 文件数据源

1. **Excel文件** (.xlsx, .xls)
2. **文本文件** (.csv, .txt, .tab)
3. **Access文件** (.mdb, .accdb)
4. **统计文件** (.sav, .sas7bdat, .rda, .rdata)
5. **JSON文件** (.json)
6. **PDF文件** (.pdf)

### 关系型数据库

1. **Microsoft SQL Server**
2. **Oracle**
3. **MySQL**
4. **PostgreSQL**
5. **IBM DB2**
6. **Amazon Redshift**
7. **Snowflake**
8. **Google BigQuery**
9. **Microsoft Azure SQL Database**
10. **SAP HANA**

### 云端数据

1. **Salesforce**
2. **Google Analytics**
3. **Google Ads**
4. **HubSpot**
5. **Marketo**
6. **ServiceNow**
7. **Workday**
8. **Anaplan**

### 多维数据集

1. **Microsoft Analysis Services**
2. **Oracle Essbase**
3. **SAP BW**

### 其他数据源

1. **Web数据连接器**
2. **Tableau数据提取(.hyper)**
3. **空间文件** (.shp, .kml, .geojson)

## 连接文件数据源

### 连接Excel文件

1. **基本连接步骤**
   - 在Tableau启动页面的"连接"窗格中，点击"Microsoft Excel"
   - 浏览并选择Excel文件
   - 在"数据源"页面中，选择要使用的工作表或范围
   - 拖拽工作表到数据预览区域

2. **Excel连接选项**
   - **使用数据解释器**：自动清理和格式化数据
   - **数据解释器设置**：
     ```markdown
     - 表头检测：自动检测并转换表头行
     - 联接表：根据关系智能联接相关表
     - 数据透视转换：将交叉表转换为列式数据
     ```
   - **数据采样**：对于大型Excel文件，可以使用数据采样来提高连接速度

3. **示例：连接销售数据Excel文件**
   ```markdown
   假设有一个销售数据Excel文件，包含以下工作表：
   - Orders（订单数据）
   - Customers（客户数据）
   - Products（产品数据）
   
   连接步骤：
   1. 点击"Microsoft Excel"连接
   2. 选择销售数据Excel文件
   3. 将"Orders"工作表拖到画布
   4. 启用"使用数据解释器"
   5. Tableau将自动识别表关系并创建联接
   ```

### 连接文本文件(CSV)

1. **基本连接步骤**
   - 在"连接"窗格中，点击"文本文件"
   - 选择CSV或文本文件
   - 配置文件格式选项：
     - 字段分隔符
     - 文本限定符
     - 字符集
     - 首行包含列名称

2. **文本文件连接最佳实践**
   - 确保CSV文件使用一致的分隔符
   - 检查日期和数字格式是否正确
   - 使用UTF-8编码以支持特殊字符

3. **示例：连接CSV日志文件**
   ```markdown
   假设有一个Web服务器日志CSV文件，包含以下字段：
   - Date（日期）
   - Time（时间）
   - IP（IP地址）
   - Method（HTTP方法）
   - URL（请求URL）
   - Status（状态码）
   - Size（响应大小）
   
   连接步骤：
   1. 选择"文本文件"连接
   2. 选择CSV日志文件
   3. 设置字段分隔符为逗号
   4. 启用"首行包含列名称"
   5. 点击"工作表1"标签开始分析
   ```

## 连接关系型数据库

### 连接Microsoft SQL Server

1. **基本连接步骤**
   - 在"连接"窗格中，点击"更多..."并选择"Microsoft SQL Server"
   - 输入服务器名称
   - 选择身份验证方式：
     - Windows身份验证
     - 用户名和密码
   - 选择数据库
   - 点击"登录"

2. **连接字符串选项**
   ```sql
   -- 基本连接字符串格式
   Server=my_server_address;Database=my_database;User ID=my_username;Password=my_password;
   
   -- 包含端口的连接字符串
   Server=my_server_address,1433;Database=my_database;User ID=my_username;Password=my_password;
   
   -- 使用Windows身份验证
   Server=my_server_address;Database=my_database;Integrated Security=SSPI;
   ```

3. **性能优化设置**
   - 启用"执行SQL查询前运行初始SQL"
   - 设置查询超时值
   - 配置SSL加密（如需要）

4. **示例：连接销售数据库**
   ```markdown
   连接到包含销售数据的SQL Server数据库：
   
   1. 选择"Microsoft SQL Server"连接器
   2. 输入服务器：sales-db.company.com
   3. 选择"Windows身份验证"
   4. 选择数据库："SalesDB"
   5. 点击"登录"
   6. 在数据源页面，拖拽"dbo.Orders"表到画布
   7. 拖拽"dbo.Customers"表并创建基于CustomerID的联接
   ```

### 连接MySQL

1. **基本连接步骤**
   - 安装MySQL驱动程序（如果尚未安装）
   - 在"连接"窗格中，点击"更多..."并选择"MySQL"
   - 输入服务器名称和端口（默认3306）
   - 输入用户名和密码
   - 选择数据库（可选）
   - 点击"登录"

2. **驱动程序安装**
   ```markdown
   Tableau可能需要额外的MySQL驱动程序：
   
   1. 访问MySQL官方网站下载驱动程序
   2. 选择适合您操作系统的版本
   3. 安装驱动程序
   4. 重启Tableau以加载新驱动
   ```

3. **连接选项**
   - 字符集设置
   - SSL配置
   - 连接超时值

## 连接云端数据源

### 连接Google Analytics

1. **基本连接步骤**
   - 在"连接"窗格中，点击"Google Analytics"
   - 使用Google账户登录并授权
   - 选择要分析的视图（网站或应用）
   - 配置数据提取选项

2. **数据维度和指标**
   - **常用维度**：
     - 页面路径
     - 来源/媒介
     - 设备类别
     - 用户类型
     - 日期
   - **常用指标**：
     - 会话数
     - 用户数
     - 网页浏览量
     - 跳出率
     - 平均会话时长

3. **示例：网站流量分析**
   ```markdown
   创建网站流量分析可视化：
   
   1. 连接到Google Analytics
   2. 选择网站视图
   3. 设置日期范围（最近30天）
   4. 将"日期"拖到列功能区
   5. 将"会话数"和"用户数"拖到行功能区
   6. 将"来源/媒介"拖到筛选器
   7. 添加趋势线分析流量趋势
   ```

### 连接Salesforce

1. **基本连接步骤**
   - 在"连接"窗格中，点击"Salesforce"
   - 使用Salesforce账户登录
   - 选择要使用的对象（表）
   - 配置连接选项

2. **常用对象**
   - **账户（Account）**：客户账户信息
   - **联系人（Contact）**：客户联系人信息
   - **机会（Opportunity）**：销售机会
   - **案例（Case）**：客户支持案例
   - **活动（Activity）**：活动和任务

3. **数据刷新选项**
   - 实时连接
   - 数据提取
   - 定时刷新设置

## 实时连接与数据提取

### 实时连接

1. **特点**
   - 查询直接发送到数据源
   - 数据始终是最新
   - 适合小型到中型数据集
   - 依赖数据源性能

2. **适用场景**
   - 需要实时数据的场景
   - 数据源性能良好
   - 数据量相对较小
   - 需要频繁更新的仪表盘

3. **配置实时连接**
   ```markdown
   1. 连接到数据源
   2. 在数据源页面，确保"实时"选项被选中
   3. 保存工作簿
   4. Tableau将每次查询数据源获取最新数据
   ```

### 数据提取

1. **特点**
   - 数据导入到Tableau的高性能引擎
   - 查询速度快
   - 支持离线访问
   - 减少对源系统的负载

2. **适用场景**
   - 大型数据集
   - 需要高性能查询
   - 离线分析需求
   - 减少对生产系统的负载

3. **创建数据提取**
   ```markdown
   1. 连接到数据源
   2. 在数据源页面，选择"数据提取"
   3. 点击"提取"按钮
   4. 选择提取选项：
      - 全部数据：提取所有数据
      - 仅一些数据：筛选特定数据
   5. 配置刷新选项：
      - 刷新方式：完整、增量
      - 刷新频率：按需、定时
   6. 点击"确定"开始提取
   ```

4. **增量提取配置**
   ```markdown
   对于大型数据集，可以配置增量提取：
   
   1. 创建基础提取
   2. 编辑提取
   3. 选择"增量刷新"
   4. 指定用于识别新增记录的列（如日期列）
   5. 设置增量逻辑
   ```

## 数据源优化

### 连接性能优化

1. **数据源端优化**
   - 创建适当的索引
   - 优化查询性能
   - 使用数据库视图预处理数据
   - 考虑数据库分区

2. **Tableau端优化**
   - 使用数据提取代替实时连接
   - 筛选数据以减少数据量
   - 优化数据源结构
   - 使用数据解释器

3. **网络优化**
   - 确保稳定的网络连接
   - 使用高速网络连接
   - 考虑地理位置因素

### 查询优化

1. **减少数据量**
   - 在数据源层面应用筛选器
   - 聚合数据
   - 删除不必要的字段

2. **查询优化技巧**
   ```markdown
   1. 使用上下文筛选器减少查询量
   2. 避免在大型数据集上使用复杂表计算
   3. 优化计算字段的效率
   4. 使用 INCLUDE/EXCLUDE LOD 表达式替代复杂筛选
   ```

## 联接与融合

### 数据联接

1. **联接类型**
   - **内部联接（Inner Join）**：仅保留两个表中匹配的行
   - **左联接（Left Join）**：保留左侧表的所有行和右侧表的匹配行
   - **右联接（Right Join）**：保留右侧表的所有行和左侧表的匹配行
   - **完全外部联接（Full Outer Join）**：保留两个表的所有行

2. **联接字段选择**
   - 使用具有唯一值的字段（如主键）
   - 确保联接字段数据类型匹配
   - 注意空值和大小写敏感问题

3. **联接性能优化**
   - 先筛选再联接
   - 确保联接字段有索引
   - 避免复杂的多表联接

### 数据融合

1. **数据融合的概念**
   - 数据融合是联接后不同数据源的方法
   - 在可视化层面而非数据源层面执行
   - 基于公共维度组合数据

2. **融合与联接的区别**
   | 特性 | 数据联接 | 数据融合 |
   |------|---------|---------|
   | 层面 | 数据源层面 | 可视化层面 |
   | 性能 | 更高 | 相对较低 |
   | 数据源 | 可以是同一数据源 | 必须是不同数据源 |
   | 聚合级别 | 详细级别 | 聚合级别 |

3. **融合最佳实践**
   - 确保融合字段具有相同的详细级别
   - 注意聚合级别差异可能导致的错误
   - 测试融合结果的准确性

## 数据源设置与元数据管理

### 数据源设置

1. **基本设置**
   - 重命名数据源
   - 添加数据源描述
   - 设置数据源颜色编码
   - 配置数据源权限

2. **性能设置**
   ```markdown
   1. 在数据源页面，点击"数据"菜单
   2. 选择"性能设置"
   3. 配置选项：
      - 查询缓存
      - 自动刷新
      - 后台更新
      - 并行查询
   ```

3. **字段设置**
   - 更改字段角色（维度/度量）
   - 设置默认聚合方式
   - 更改数据类型
   - 设置字段格式

### 元数据管理

1. **组织字段**
   - 创建文件夹组织字段
   - 重命名字段以提高可读性
   - 添加字段描述
   - 隐藏不必要的字段

2. **创建层次结构**
   ```markdown
   创建地理层次结构示例：
   
   1. 在数据窗格中，右键点击"Country"字段
   2. 选择"创建" > "层次结构"
   3. 输入层次结构名称："地理位置"
   4. 拖拽"State"和"City"字段到层次结构中
   5. 排序字段顺序：Country > State > City
   ```

3. **字段角色设置**
   - **维度**：分类数据，用于分组和筛选
   - **度量**：数值数据，用于聚合和计算

## 数据源刷新计划

### 刷新计划设置

1. **Tableau Desktop中的刷新计划**
   ```markdown
   1. 右键点击数据源，选择"提取"
   2. 点击"计划"选项卡
   3. 选择刷新频率：
      - 无（手动刷新）
      - 每小时
      - 每天
      - 每周
      - 每月
   4. 设置具体刷新时间
   5. 点击"确定"保存计划
   ```

2. **Tableau Server中的刷新计划**
   ```markdown
   1. 在服务器上导航到工作簿
   2. 点击"计划"选项卡
   3. 创建新计划或使用现有计划
   4. 配置计划详情：
      - 计划类型
      - 频率和时间
      - 优先级
      - 并发任务数
   5. 将计划分配给数据源
   ```

3. **增量刷新配置**
   ```markdown
   配置增量刷新示例：
   
   1. 选择要刷新的数据提取
   2. 编辑提取设置
   3. 选择"增量刷新"
   4. 指定标识新数据的列（如"日期"列）
   5. 设置增量逻辑
   6. 测试增量刷新
   ```

## 实验练习

为了巩固本章所学知识，请完成以下练习：

1. **连接多种数据源**
   - 连接一个Excel文件和一个SQL Server数据库
   - 尝试创建两个数据源之间的联接

2. **实时连接与数据提取比较**
   - 对同一个数据源创建实时连接和数据提取
   - 比较两者的性能差异

3. **数据融合实践**
   - 连接两个不同的数据源
   - 创建一个可视化，融合两个数据源的数据

4. **数据源优化**
   - 对一个大型数据源应用优化技术
   - 比较优化前后的查询性能

通过完成这些练习，您将深入理解Tableau数据连接的各种概念和技术，为创建高效的数据可视化打下坚实基础。