# 6.1 Grafanaä¼ä¸šçº§éƒ¨ç½²

## ğŸ¯ å­¦ä¹ ç›®æ ‡

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- Grafanaä¼ä¸šç‰ˆä¸å¼€æºç‰ˆçš„åŒºåˆ«
- é«˜å¯ç”¨æ€§éƒ¨ç½²æ¶æ„
- è´Ÿè½½å‡è¡¡å’Œæ‰©å±•ç­–ç•¥
- æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½
- ä¼ä¸šçº§å®‰å…¨å’Œæƒé™ç®¡ç†
- ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–

## ğŸ¢ Grafanaä¼ä¸šç‰ˆæ¦‚è¿°

### ä¼ä¸šç‰ˆåŠŸèƒ½ç‰¹æ€§

Grafanaä¼ä¸šç‰ˆåœ¨å¼€æºç‰ˆåŸºç¡€ä¸Šæä¾›ä»¥ä¸‹é¢å¤–åŠŸèƒ½ï¼š

1. **è®¤è¯å’Œæˆæƒ**:
   - SAMLé›†æˆ
   - OAuth 2.0
   - LDAPé›†æˆ
   - JWTè®¤è¯

2. **è§’è‰²å’Œæƒé™ç®¡ç†**:
   - ç»†ç²’åº¦æƒé™æ§åˆ¶
   - ç»„ç»‡çº§æƒé™éš”ç¦»
   - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

3. **é«˜çº§å®‰å…¨**:
   - æ•°æ®æºæƒé™æ§åˆ¶
   - å®¡è®¡æ—¥å¿—
   - IPç™½åå•

4. **ä¼ä¸šæ”¯æŒ**:
   - æŠ€æœ¯æ”¯æŒæœåŠ¡
   - SLAä¿è¯
   - å®‰å…¨æ›´æ–°

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | å¼€æºç‰ˆ | ä¼ä¸šç‰ˆ |
|------|--------|--------|
| åŸºæœ¬ä»ªè¡¨ç›˜ | âœ“ | âœ“ |
| å¤šæ•°æ®æº | âœ“ | âœ“ |
| å‘Šè­¦ | âœ“ | âœ“ |
| å›¢é˜Ÿå’Œç»„ç»‡ | âœ“ | âœ“ |
| SAMLé›†æˆ | âœ— | âœ“ |
| RBAC | åŸºç¡€ | é«˜çº§ |
| å®¡è®¡æ—¥å¿— | âœ— | âœ“ |
| æ•°æ®æºæƒé™ | âœ— | âœ“ |
| ä¼ä¸šæ”¯æŒ | ç¤¾åŒº | å•†ä¸š |

## ğŸ—ï¸ é«˜å¯ç”¨æ€§éƒ¨ç½²

### é«˜å¯ç”¨æ¶æ„

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Load Balancerâ”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ Grafana   â”‚    â”‚ Grafana   â”‚    â”‚ Grafana   â”‚
â”‚ Server 1  â”‚    â”‚ Server 2  â”‚    â”‚ Server 3  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Shared Storageâ”‚
                â”‚ (DB, Files)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²æ¨¡å¼

#### æ´»è·ƒ-æ´»è·ƒæ¨¡å¼

æ‰€æœ‰Grafanaå®ä¾‹åŒæ—¶å¤„ç†è¯·æ±‚ï¼š

- ä¼˜ç‚¹: èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œæ— å•ç‚¹æ•…éšœ
- ç¼ºç‚¹: éœ€è¦å…±äº«å­˜å‚¨ï¼Œé…ç½®å¤æ‚

#### æ´»è·ƒ-è¢«åŠ¨æ¨¡å¼

ä¸»å®ä¾‹å¤„ç†è¯·æ±‚ï¼Œå¤‡ç”¨å®ä¾‹å¾…å‘½ï¼š

- ä¼˜ç‚¹: é…ç½®ç®€å•ï¼Œæ•°æ®ä¸€è‡´æ€§å¥½
- ç¼ºç‚¹: èµ„æºåˆ©ç”¨ç‡ä½ï¼Œåˆ‡æ¢éœ€è¦æ—¶é—´

## âš–ï¸ è´Ÿè½½å‡è¡¡

### è´Ÿè½½å‡è¡¡å™¨é€‰é¡¹

1. **Nginx**: è½»é‡çº§é«˜æ€§èƒ½WebæœåŠ¡å™¨
2. **HAProxy**: ä¸“æ³¨äºè´Ÿè½½å‡è¡¡çš„å¼€æºè½¯ä»¶
3. **AWS ALB**: äº‘è´Ÿè½½å‡è¡¡æœåŠ¡
4. **Kubernetes Ingress**: å®¹å™¨ç¯å¢ƒä¸‹çš„è´Ÿè½½å‡è¡¡

### Nginxé…ç½®ç¤ºä¾‹

```nginx
upstream grafana {
    least_conn;
    server grafana1.example.com:3000;
    server grafana2.example.com:3000;
    server grafana3.example.com:3000;
}

server {
    listen 80;
    server_name grafana.example.com;

    location / {
        proxy_pass http://grafana;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### HAProxyé…ç½®ç¤ºä¾‹

```
global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend grafana_frontend
    bind *:80
    default_backend grafana_backend

backend grafana_backend
    balance roundrobin
    option httpchk GET /api/health
    server grafana1 grafana1.example.com:3000 check
    server grafana2 grafana2.example.com:3000 check
    server grafana3 grafana3.example.com:3000 check
```

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½

### æ•°æ®åº“é…ç½®

#### PostgreSQLé…ç½®

```ini
[database]
type = postgres
host = postgres.example.com:5432
name = grafana
user = grafana
password = password
ssl_mode = require
```

#### MySQLé…ç½®

```ini
[database]
type = mysql
host = mysql.example.com:3306
name = grafana
user = grafana
password = password
max_idle_conn = 2
max_open_conn = 0
```

### å­˜å‚¨é…ç½®

#### å…±äº«æ–‡ä»¶å­˜å‚¨

æ‰€æœ‰Grafanaå®ä¾‹éœ€è¦è®¿é—®å…±äº«å­˜å‚¨ï¼š

```ini
[paths]
data = /shared/grafana/data
logs = /shared/grafana/logs
plugins = /shared/grafana/plugins
```

#### Amazon S3é…ç½®

```ini
[external_image_storage]
provider = s3
s3_endpoint = s3.amazonaws.com
s3_bucket = grafana-storage
s3_region = us-east-1
s3_access_key = your_access_key
s3_secret_key = your_secret_key
```

### å¤‡ä»½ç­–ç•¥

#### æ•°æ®åº“å¤‡ä»½

```bash
# PostgreSQLå¤‡ä»½
pg_dump -h postgres.example.com -U grafana grafana > grafana_db_backup.sql

# MySQLå¤‡ä»½
mysqldump -h mysql.example.com -u grafana -p grafana > grafana_db_backup.sql
```

#### æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½

```bash
# å¤‡ä»½Grafanaæ•°æ®å’Œé…ç½®
tar -czf grafana_backup.tar.gz /etc/grafana /var/lib/grafana

# ä½¿ç”¨rsyncåŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
rsync -avz /var/lib/grafana backup.example.com:/backup/grafana/
```

#### è‡ªåŠ¨åŒ–å¤‡ä»½

```bash
#!/bin/bash
# æ¯æ—¥å¤‡ä»½è„šæœ¬

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup/grafana/$DATE"
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
pg_dump -h postgres.example.com -U grafana grafana > $BACKUP_DIR/grafana_db.sql

# å¤‡ä»½æ–‡ä»¶
tar -czf $BACKUP_DIR/grafana_files.tar.gz /var/lib/grafana

# æ¸…ç†æ—§å¤‡ä»½(ä¿ç•™30å¤©)
find /backup/grafana -type d -mtime +30 -exec rm -rf {} \;
```

## ğŸ”’ ä¼ä¸šçº§å®‰å…¨

### è®¤è¯å’Œæˆæƒ

#### SAMLé…ç½®

```ini
[auth.saml]
enabled = true
certificate_path = /path/to/certificate.pem
private_key_path = /path/to/private-key.pem
idp_metadata_url = https://sso.example.com/metadata
assertion_attribute_name = email
role_attribute_path = groups
```

#### LDAPé…ç½®

```ini
[auth.ldap]
enabled = true
config_file = /etc/grafana/ldap.toml
allow_sign_up = true
```

LDAPé…ç½®ç¤ºä¾‹ (`ldap.toml`):

```toml
[[servers]]
host = "ldap.example.com"
port = 389
use_ssl = false
start_tls = false
bind_dn = "cn=admin,dc=example,dc=com"
bind_password = "password"

[servers.attributes]
name = "givenName"
surname = "sn"
username = "cn"
member_of = "memberOf"
email =  "email"

[[servers.group_mappings]]
group_dn = "cn=grafana-admins,ou=groups,dc=example,dc=com"
org_role = "Admin"

[[servers.group_mappings]]
group_dn = "cn=grafana-editors,ou=groups,dc=example,dc=com"
org_role = "Editor"
```

#### OAuthé…ç½®

```ini
[auth.generic_oauth]
enabled = true
name = "SSO"
allow_sign_up = true
client_id = your_client_id
client_secret = your_client_secret
scopes = openid email profile
auth_url = https://sso.example.com/oauth2/auth
token_url = https://sso.example.com/oauth2/token
api_url = https://sso.example.com/oauth2/userinfo
```

### æƒé™ç®¡ç†

#### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

```ini
[auth.basic]
enabled = false

[auth.proxy]
enabled = true
header_name = X-WEBAUTH-USER
header_property = username
auto_sign_up = true
headers = Email:X-WEBAUTH-EMAIL Name:X-WEBAUTH-NAME
```

#### æ•°æ®æºæƒé™

```ini
[datasource.permissions]
enabled = true

[admin]
disable_grafana_login = false
```

### å®‰å…¨åŠ å›º

#### SSL/TLSé…ç½®

```ini
[server]
protocol = https
cert_file = /path/to/cert.pem
cert_key = /path/to/key.pem
```

#### å®‰å…¨å¤´éƒ¨

```ini
[security]
disable_gravatar = true
cookie_secure = true
cookie_samesite = lax
strict_transport_security = true
x_content_type_options = true
x_xss_protection = true
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

#### è¿æ¥æ± é…ç½®

```ini
[database]
max_idle_conn = 2
max_open_conn = 10
conn_max_lifetime = 14400
```

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_login ON user (login);
CREATE INDEX idx_dashboard_org_id ON dashboard (org_id);
CREATE INDEX idx_data_source_org_id ON data_source (org_id);
```

### ç¼“å­˜é…ç½®

#### Redisç¼“å­˜

```ini
[remote_cache]
type = redis
connstr = redis://redis.example.com:6379/0
password = redis_password
```

#### å†…å­˜ç¼“å­˜

```ini
[cache]
enabled = true
type = memory
ttl = 3600
```

### å‰ç«¯ä¼˜åŒ–

#### é™æ€èµ„æºç¼“å­˜

```ini
[server]
static_root_path = /usr/share/grafana/public
router_logging = true
```

#### èµ„æºå‹ç¼©

```ini
[server]
enable_gzip = true
```

## ğŸš€ Kuberneteséƒ¨ç½²

### éƒ¨ç½²æ¸…å•

#### Grafana Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  replicas: 3
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:enterprise
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secret
              key: admin-password
        - name: GF_DATABASE_TYPE
          value: postgres
        - name: GF_DATABASE_HOST
          value: postgres:5432
        - name: GF_DATABASE_NAME
          value: grafana
        - name: GF_DATABASE_USER
          valueFrom:
            secretKeyRef:
              name: grafana-secret
              key: db-user
        - name: GF_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secret
              key: db-password
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: grafana-pvc
```

#### Grafana Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  selector:
    app: grafana
  ports:
  - port: 80
    targetPort: 3000
  type: ClusterIP
```

#### Ingressé…ç½®

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - grafana.example.com
    secretName: grafana-tls
  rules:
  - host: grafana.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 80
```

### Helméƒ¨ç½²

```yaml
# values.yaml
replicas: 3
adminUser: admin
adminPassword: your-secure-password
persistence:
  enabled: true
  size: 10Gi
database:
  type: postgres
  host: postgres.example.com
  name: grafana
  user: grafana
  password: grafana-password
service:
  type: ClusterIP
  port: 80
ingress:
  enabled: true
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  hosts:
  - grafana.example.com
  tls:
  - secretName: grafana-tls
    hosts:
    - grafana.example.com
```

éƒ¨ç½²å‘½ä»¤ï¼š

```bash
helm repo add grafana https://grafana.github.io/helm-charts
helm install grafana grafana/grafana -f values.yaml
```

## ğŸ§ª å®éªŒï¼šæ„å»ºä¼ä¸šçº§Grafanaé›†ç¾¤

è®©æˆ‘ä»¬é€šè¿‡å®éªŒæ„å»ºä¸€ä¸ªä¼ä¸šçº§Grafanaé›†ç¾¤ï¼š

1. é…ç½®é«˜å¯ç”¨Grafanaå®ä¾‹
2. è®¾ç½®è´Ÿè½½å‡è¡¡
3. é…ç½®å¤–éƒ¨æ•°æ®åº“
4. è®¾ç½®SAMLè®¤è¯
5. é…ç½®è‡ªåŠ¨å¤‡ä»½

**å®éªŒä»£ç å’Œé…ç½®ï¼š**

è§[code/experiments/enterprise-deployment/](../code/chapter6/enterprise-deployment/)

## ğŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

- Grafanaä¼ä¸šç‰ˆçš„åŠŸèƒ½ç‰¹æ€§
- é«˜å¯ç”¨æ€§éƒ¨ç½²æ¶æ„å’Œè´Ÿè½½å‡è¡¡
- æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½ç­–ç•¥
- ä¼ä¸šçº§å®‰å…¨å’Œæƒé™ç®¡ç†
- Kubernetesç¯å¢ƒä¸‹çš„éƒ¨ç½²æ–¹æ³•
- æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

ä¼ä¸šçº§éƒ¨ç½²éœ€è¦è€ƒè™‘å¯é æ€§ã€å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§ç­‰å¤šä¸ªæ–¹é¢ã€‚é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè®¾è®¡å’Œå®æ–½ä¸€ä¸ªæ»¡è¶³ä¼ä¸šéœ€æ±‚çš„Grafanaéƒ¨ç½²æ–¹æ¡ˆã€‚

## ğŸ¤” æ€è€ƒé¢˜

1. åœ¨ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥é€‰æ‹©ä¼ä¸šç‰ˆè€Œä¸æ˜¯å¼€æºç‰ˆï¼Ÿ
2. å¦‚ä½•åœ¨é«˜å¯ç”¨éƒ¨ç½²ä¸­ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ
3. Kuberneteséƒ¨ç½²ä¸ä¼ ç»Ÿéƒ¨ç½²ç›¸æ¯”æœ‰å“ªäº›ä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Grafanaä¼ä¸šç‰ˆæ–‡æ¡£](https://grafana.com/docs/enterprise/)
- [Grafanaé«˜å¯ç”¨éƒ¨ç½²æŒ‡å—](https://grafana.com/docs/grafana/latest/setup-grafana/installation/high-availability/)
- [Kuberneteséƒ¨ç½²æœ€ä½³å®è·µ](https://grafana.com/docs/grafana/latest/setup-grafana/installation/kubernetes/)