# 2.1 Grafana数据源

## 🎯 学习目标

在本章中，我们将学习：

- 理解Grafana数据源的概念和类型
- 如何添加和配置各种数据源
- 数据源的高级配置选项
- 多数据源的使用和查询
- 数据源的故障排除和最佳实践

## 📊 什么是数据源？

数据源是Grafana从中获取数据的系统。Grafana支持多种数据源类型，包括时间序列数据库、SQL数据库、日志系统等。每个数据源都由特定的插件支持，提供查询语言和功能。

### 数据源的特点

1. **多种类型**: 支持时间序列、关系型数据库、NoSQL、日志系统等
2. **统一查询**: 通过Grafana查询编辑器统一查询界面
3. **混合使用**: 在同一仪表盘中可以同时使用多个数据源
4. **实时更新**: 支持实时数据更新和刷新

## 🔧 添加数据源

### 添加数据源的步骤

1. 登录Grafana
2. 点击左侧菜单的"齿轮"图标(配置)
3. 选择"Data Sources"
4. 点击"Add data source"
5. 选择数据源类型
6. 配置数据源参数
7. 点击"Save & Test"验证连接

### 基本配置参数

大多数数据源需要以下基本参数：

- **名称**: 数据源在Grafana中的显示名称
- **类型**: 数据源类型(如Prometheus, InfluxDB等)
- **URL**: 数据源的连接地址
- **访问方式**: 代理(默认)或直接访问
- **认证**: 用户名、密码、API密钥等
- **TLS/SSL**: 安全连接设置

## 🏷️ 数据源类型

### 时间序列数据库

#### Prometheus

Prometheus是最受欢迎的开源时间序列数据库和监控系统，特别适合Kubernetes和云原生环境。

**主要特点**:
- 多维数据模型
- 强大的PromQL查询语言
- 高效的时间序列数据存储
- 内置告警功能

**配置步骤**:

1. 添加数据源，选择"Prometheus"
2. 设置基本参数:
   ```
   Name: Prometheus
   URL: http://localhost:9090
   Access: Proxy (默认)
   ```
3. 高级选项:
   ```
   Scrape interval: 15s
   Query timeout: 60s
   HTTP method: GET
   ```
4. 点击"Save & Test"

**示例查询**:
```
# CPU使用率
cpu_usage_percent = 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 内存使用率
memory_usage_percent = (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

#### InfluxDB

InfluxDB是专为时间序列数据设计的高性能数据库，适用于IoT、应用监控等场景。

**主要特点**:
- 专为时间序列数据优化
- SQL-like查询语言(InfluxQL)和Flux
- 高效的数据压缩
- 内置数据保留策略

**配置步骤**:

1. 添加数据源，选择"InfluxDB"
2. 设置基本参数:
   ```
   Name: InfluxDB
   URL: http://localhost:8086
   Database: mydb
   User: grafana
   Password: password
   ```
3. 高级选项:
   ```
   HTTP Method: GET
   Time column: time
   ```
4. 点击"Save & Test"

**示例查询**:
```
# InfluxQL查询
SELECT mean("value") FROM "cpu" WHERE "host" = 'server1' AND time > now() - 1h GROUP BY time(5m)

# Flux查询
from(bucket: "mybucket")
  |> range(start: -1h)
  |> filter(fn: (r) => r._measurement == "cpu" and r.host == "server1")
  |> mean()
```

### SQL数据库

#### MySQL

MySQL是最流行的开源关系型数据库，也常用于存储监控数据。

**配置步骤**:

1. 添加数据源，选择"MySQL"
2. 设置基本参数:
   ```
   Name: MySQL
   Host: localhost:3306
   Database: monitoring
   User: grafana
   Password: password
   ```
3. 点击"Save & Test"

**示例查询**:
```sql
-- CPU使用率查询
SELECT
  timestamp AS time,
  cpu_usage AS value,
  hostname AS metric
FROM system_metrics
WHERE $__timeFilter(timestamp)
ORDER BY timestamp

-- 内存使用率查询
SELECT
  UNIX_TIMESTAMP(timestamp) AS time_sec,
  memory_usage AS value,
  hostname
FROM system_metrics
WHERE $__timeFilter(timestamp)
ORDER BY timestamp
```

#### PostgreSQL

PostgreSQL是功能强大的开源对象关系型数据库，支持复杂查询和JSON数据类型。

**配置步骤**:

1. 添加数据源，选择"PostgreSQL"
2. 设置基本参数:
   ```
   Name: PostgreSQL
   Host: localhost:5432
   Database: monitoring
   User: grafana
   Password: password
   SSL mode: disable
   ```
3. 点击"Save & Test"

**示例查询**:
```sql
-- 使用 $__timeFilter 宏
SELECT
  timestamp AS time,
  metric_value AS value,
  metric_name
FROM metrics
WHERE $__timeFilter(timestamp)

-- 使用时间范围参数
SELECT
  timestamp AS time,
  cpu_usage AS value
FROM cpu_metrics
WHERE timestamp >= $__timeFrom() AND timestamp <= $__timeTo()
ORDER BY timestamp
```

### 日志和搜索系统

#### Elasticsearch

Elasticsearch是分布式搜索和分析引擎，常用于日志分析、全文搜索等场景。

**配置步骤**:

1. 添加数据源，选择"Elasticsearch"
2. 设置基本参数:
   ```
   Name: Elasticsearch
   URL: http://localhost:9200
   Index name: logs-*
   Time field name: @timestamp
   ```
3. 高级选项:
   ```
   Max concurrent requests: 5
   Version: 7.0+
   ```
4. 点击"Save & Test"

**示例查询**:

**Lucene查询语法**:
```
# 基本查询
@timestamp:[now-1h TO now] AND level:"ERROR"

# 字段查询
response_code:500 AND @timestamp:[now-1h TO now]

# 通配符查询
host:web-* AND @timestamp:[now-1h TO now]
```

**Kibana查询语法**:
```
# 使用脚本字段
{
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "@timestamp": {
              "gte": "now-1h",
              "lte": "now"
            }
          }
        }
      ]
    }
  },
  "scriptFields": {
    "status_level": {
      "script": {
        "source": "doc['status_code'].value >= 400 ? 'error' : 'success'"
      }
    }
  }
}
```

### 云服务数据源

#### AWS CloudWatch

AWS CloudWatch是Amazon Web Services的监控和可观测性服务。

**配置步骤**:

1. 添加数据源，选择"CloudWatch"
2. 设置基本参数:
   ```
   Name: AWS CloudWatch
   Authentication provider: AWS SDK (默认)
   Default Region: us-east-1
   ```
3. 认证设置:
   ```
   Auth Provider: AWS SDK
   Assume Role ARN: arn:aws:iam::account-id:role/GrafanaRole
   ```
4. 点击"Save & Test"

**示例查询**:
```
# EC2实例CPU使用率
AWS/EC2 -> CPUUtilization
Statistic: Average
Period: 5 minutes
Region: us-east-1

# Lambda函数调用次数
AWS/Lambda -> Invocations
Statistic: Sum
Period: 1 minute
```

### 其他数据源

#### Graphite

Graphite是开源的时间序列数据存储和图表生成工具。

**配置步骤**:

1. 添加数据源，选择"Graphite"
2. 设置基本参数:
   ```
   Name: Graphite
   URL: http://localhost:8080
   ```
3. 点击"Save & Test"

**示例查询**:
```
# 服务器CPU使用率
servers.$hostname.cpu.usage

# 应用响应时间
apps.$app.response_time.*.mean
```

## 🔐 数据源认证

### 基本认证

用户名和密码认证：

```ini
[database]
user = grafana
password = your_password
```

### API密钥认证

某些API服务使用API密钥：

```ini
[api_key]
api_key = your_api_key
```

### TLS/SSL配置

安全连接设置：

```ini
[tls]
tls_cert_file = /path/to/cert.pem
tls_key_file = /path/to/key.pem
tls_ca_cert_file = /path/to/ca.pem
tls_skip_verify = true
```

## 🔧 高级数据源配置

### 代理设置

配置代理访问数据源：

```ini
[proxy]
http_proxy = http://proxy.example.com:8080
https_proxy = https://proxy.example.com:8443
no_proxy = localhost,127.0.0.1
```

### 连接池配置

调整数据源连接池参数：

```ini
[connection_pool]
max_idle_conns = 100
max_open_conns = 0
conn_max_lifetime = 14400
```

### 查询超时设置

设置查询超时时间：

```ini
[query]
timeout = 60
interval = 15
```

## 🔄 多数据源查询

### 在同一面板中查询多个数据源

Grafana支持在同一面板中查询多个数据源：

1. 创建面板时选择"Mixed"数据源
2. 添加多个查询，每个查询指定不同的数据源
3. Grafana会尝试合并结果

### 使用插件实现跨数据源查询

某些插件支持跨数据源查询：

- **Grafana Infinity**: 查询REST API、CSV等数据源
- **SimpleJSON**: 实现自定义JSON数据源
- **Plotly**: 高级数据可视化

## 🐛 数据源故障排除

### 常见问题

1. **连接超时**:
   - 检查网络连接
   - 确认数据源URL正确
   - 调整超时设置

2. **认证失败**:
   - 验证用户名密码
   - 检查API密钥
   - 确认权限设置

3. **查询错误**:
   - 验证查询语法
   - 检查数据源支持的功能
   - 使用数据源的查询工具测试

4. **数据不显示**:
   - 检查时间范围
   - 确认数据存在
   - 验证查询返回的数据格式

### 调试技巧

1. **查看日志**:
   ```
   Grafana日志位置:
   - Linux: /var/log/grafana/grafana.log
   - Docker: docker logs grafana
   - Windows: C:\Program Files\GrafanaLabs\grafana\logs\grafana.log
   ```

2. **使用浏览器开发者工具**:
   - 查看网络请求
   - 检查API响应
   - 分析错误信息

3. **使用数据源的查询工具**:
   - Prometheus UI
   - InfluxDB UI
   - Kibana Dev Tools

## 📊 数据源最佳实践

1. **命名规范**:
   - 使用描述性名称
   - 包含环境信息(如prod, dev)
   - 保持名称简短明了

2. **权限管理**:
   - 为数据源创建专用用户
   - 分配最小必要权限
   - 定期轮换密码/API密钥

3. **性能优化**:
   - 设置适当的查询超时
   - 使用缓存策略
   - 限制并发查询数量

4. **安全配置**:
   - 使用TLS/SSL加密连接
   - 避免暴露数据源到公网
   - 定期更新数据源插件

## 🧪 实验：配置和使用多种数据源

让我们通过一个实验来配置和使用多种数据源：

1. 配置Prometheus数据源
2. 配置InfluxDB数据源
3. 配置MySQL数据源
4. 创建一个仪表盘，包含来自不同数据源的查询
5. 添加变量实现跨数据源查询

**实验代码和配置：**

见[code/experiments/multi-datasource-setup.sh](../code/chapter2/multi-datasource-setup.sh)

## 📝 本章小结

在本章中，我们学习了：

- Grafana数据源的概念和类型
- 如何添加和配置各种常见数据源
- 数据源的认证和安全设置
- 多数据源查询的方法
- 数据源故障排除和最佳实践

掌握数据源配置是有效使用Grafana的关键，因为数据源是所有仪表盘和面板的基础。在下一章[2.2 Prometheus数据源](./2.2-prometheus.md)中，我们将深入学习Prometheus数据源的配置和高级查询技巧。

## 🤔 思考题

1. 在什么情况下应该选择"Proxy"而不是"Direct"访问模式？
2. 为什么在实际环境中使用专用用户而不是超级用户连接数据库？
3. 如何评估和优化多个数据源查询的性能？

## 📚 延伸阅读

- [Grafana数据源官方文档](https://grafana.com/docs/grafana/latest/datasources/)
- [Prometheus官方文档](https://prometheus.io/docs/)
- [InfluxDB官方文档](https://docs.influxdata.com/influxdb/)