# 生产环境Loki部署配置

apiVersion: v1
kind: Namespace
metadata:
  name: loki
---
# Loki ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: loki
data:
  loki.yaml: |
    auth_enabled: false
    
    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
    
    common:
      ring:
        kvstore:
          store: consul
          consul:
            host: consul.consul.svc.cluster.local:8500
            http_client_config:
              tls_config:
                insecure_skip_verify: true
      replication_factor: 3
    
    distributor:
      ring:
        kvstore:
          store: consul
          consul:
            host: consul.consul.svc.cluster.local:8500
            http_client_config:
              tls_config:
                insecure_skip_verify: true
      ha_tracker:
        enable_ha_tracker: true
        update_timeout: 2s
        num_workers: 50
    
    ingester:
      lifecycler:
        address: 127.0.0.1
        ring:
          kvstore:
            store: consul
            consul:
              host: consul.consul.svc.cluster.local:8500
          replication_factor: 3
        final_sleep: 0s
        num_tokens: 512
      chunk_idle_period: 1h
      max_chunk_age: 2h
      chunk_target_size: 1048576
      chunk_retain_period: 30s
      max_transfer_retries: 10
      wal:
        dir: /loki/wal
        enabled: true
        replay_memory_ceiling: 100MB
    
    querier:
      query_concurrency: 50
      engine:
        max_look_back_period: 30d
        query_timeout: 10m
        max_samples_per_query: 50000000
      query_ingester_within: 3h
    
    frontend:
      compress_responses: true
      log_queries_longer_than: 10s
      max_outstanding_per_tenant: 4096
      scheduler_address: dns+query-scheduler-discovery:9090
      scheduler_worker_address: dns+frontend:9096
      max_retries: 2
    
    compactor:
      working_directory: /loki/compactor
      shared_store: s3
      compaction_interval: 10m
      retention_enabled: true
      delete_request_cancel_period: 24h
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
    
    ruler:
      enable_alertmanager_discovery: true
      alertmanager_url: http://alertmanager:9093/api/v1/alerts
      enable_api: true
      evaluation_interval: 1m
      poll_interval: 1m
      notification_timeout: 10s
      external_url: http://grafana.example.com
    
    limits_config:
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_global_streams_per_user: 10000
      max_streams_per_user: 5000
      max_series_per_user: 100000
      max_series_per_metric: 1000
      ingestion_rate_mb: 100
      ingestion_burst_size_mb: 200
      max_concurrent_queries: 10
      query_timeout: 5m
    
    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: s3
          schema: v11
          index:
            prefix: index_
            period: 24h
    
    storage_config:
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        shared_store: s3
      
      s3:
        endpoint: s3.example.com:9000
        region: us-east-1
        bucketnames: loki-chunks
        access_key_id: loki
        secret_access_key: loki-secret
        s3forcepathstyle: true
        insecure: false
        http_config:
          insecure_skip_verify: false
    
    chunk_store_config:
      max_look_back_period: 0s
      chunk_cache_config:
        enable_fifocache: true
        fifocache:
          max_size_items: 10000
          ttl: 24h
          validity: 10s
---
# Loki Gateway ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: loki
data:
  nginx.conf: |
    upstream loki {
      least_conn;
      server loki-distributor.l:3100;
      server loki-distributor-1.l:3100;
      server loki-distributor-2.l:3100;
    }
    
    upstream loki-frontend {
      least_conn;
      server loki-query-frontend.l:3100;
      server loki-query-frontend-1.l:3100;
      server loki-query-frontend-2.l:3100;
    }
    
    server {
      listen 80;
      
      # 重写规则：查询请求到Query Frontend，其他请求到Distributor
      location /api/v1/query {
        proxy_pass http://loki-frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
      }
      
      location /api/v1/query_range {
        proxy_pass http://loki-frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
      }
      
      location / {
        proxy_pass http://loki;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
      }
    }
---
# Loki Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loki
  namespace: loki
---
# Loki Cluster Role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: loki
rules:
- apiGroups: [""]
  resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
  verbs: ["get", "list", "watch"]
---
# Loki Cluster Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: loki
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: loki
subjects:
- kind: ServiceAccount
  name: loki
  namespace: loki
---
# Loki Gateway Service
apiVersion: v1
kind: Service
metadata:
  name: loki-gateway
  namespace: loki
  labels:
    app: loki-gateway
spec:
  selector:
    app: loki-gateway
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
---
# Loki Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-gateway
  namespace: loki
  labels:
    app: loki-gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: loki-gateway
  template:
    metadata:
      labels:
        app: loki-gateway
    spec:
      serviceAccountName: loki
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 5
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
# Loki Ingester StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki-ingester
  namespace: loki
  labels:
    app: loki-ingester
spec:
  serviceName: loki-ingester
  replicas: 3
  selector:
    matchLabels:
      app: loki-ingester
  template:
    metadata:
      labels:
        app: loki-ingester
    spec:
      serviceAccountName: loki
      containers:
      - name: ingester
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=ingester
        - -ingester.lifecycler.address=$(POD_NAME).loki-ingester.l.svc.cluster.local
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: data
          mountPath: /loki
        resources:
          requests:
            memory: "4Gi"
            cpu: "2000m"
          limits:
            memory: "8Gi"
            cpu: "4000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 200Gi
---
# Loki Distributor Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-distributor
  namespace: loki
  labels:
    app: loki-distributor
spec:
  replicas: 2
  selector:
    matchLabels:
      app: loki-distributor
  template:
    metadata:
      labels:
        app: loki-distributor
    spec:
      serviceAccountName: loki
      containers:
      - name: distributor
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=distributor
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        resources:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
---
# Loki Querier Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-querier
  namespace: loki
  labels:
    app: loki-querier
spec:
  replicas: 2
  selector:
    matchLabels:
      app: loki-querier
  template:
    metadata:
      labels:
        app: loki-querier
    spec:
      serviceAccountName: loki
      containers:
      - name: querier
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=querier
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        resources:
          requests:
            memory: "2Gi"
            cpu: "2000m"
          limits:
            memory: "4Gi"
            cpu: "4000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
---
# Loki Query Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-query-frontend
  namespace: loki
  labels:
    app: loki-query-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: loki-query-frontend
  template:
    metadata:
      labels:
        app: loki-query-frontend
    spec:
      serviceAccountName: loki
      containers:
      - name: query-frontend
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=query-frontend
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        resources:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
---
# Loki Compactor StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki-compactor
  namespace: loki
  labels:
    app: loki-compactor
spec:
  serviceName: loki-compactor
  replicas: 1
  selector:
    matchLabels:
      app: loki-compactor
  template:
    metadata:
      labels:
        app: loki-compactor
    spec:
      serviceAccountName: loki
      containers:
      - name: compactor
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=compactor
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: data
          mountPath: /loki
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 200Gi
---
# Loki Ruler Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-ruler
  namespace: loki
  labels:
    app: loki-ruler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki-ruler
  template:
    metadata:
      labels:
        app: loki-ruler
    spec:
      serviceAccountName: loki
      containers:
      - name: ruler
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/local-config.yaml
        - -target=ruler
        ports:
        - containerPort: 3100
        - containerPort: 9096
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3100
          initialDelaySeconds: 10
          timeoutSeconds: 3
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: loki-config
          items:
          - key: loki.yaml
            path: local-config.yaml
---
# Consul StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: consul
  namespace: loki
  labels:
    app: consul
spec:
  serviceName: consul
  replicas: 1
  selector:
    matchLabels:
      app: consul
  template:
    metadata:
      labels:
        app: consul
    spec:
      containers:
      - name: consul
        image: consul:1.14
        args:
        - agent
        - -server
        - -bootstrap-expect=1
        - -client=0.0.0.0
        - -ui
        ports:
        - containerPort: 8500
        - containerPort: 8600
          protocol: UDP
        volumeMounts:
        - name: data
          mountPath: /consul/data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 20Gi
---
# Consul Service
apiVersion: v1
kind: Service
metadata:
  name: consul
  namespace: loki
  labels:
    app: consul
spec:
  selector:
    app: consul
  type: ClusterIP
  ports:
  - port: 8500
    targetPort: 8500
    protocol: TCP
    name: http
  - port: 8600
    targetPort: 8600
    protocol: TCP
    name: dns-tcp
  - port: 8600
    targetPort: 8600
    protocol: UDP
    name: dns-udp
---
# Headless Service for Loki Ingester
apiVersion: v1
kind: Service
metadata:
  name: loki-ingester
  namespace: loki
  labels:
    app: loki-ingester
spec:
  selector:
    app: loki-ingester
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 3100
    targetPort: 3100
    protocol: TCP
    name: http
  - port: 9096
    targetPort: 9096
    protocol: TCP
    name: grpc
---
# Headless Service for Loki Compactor
apiVersion: v1
kind: Service
metadata:
  name: loki-compactor
  namespace: loki
  labels:
    app: loki-compactor
spec:
  selector:
    app: loki-compactor
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 3100
    targetPort: 3100
    protocol: TCP
    name: http
  - port: 9096
    targetPort: 9096
    protocol: TCP
    name: grpc
---
# Headless Service for Consul
apiVersion: v1
kind: Service
metadata:
  name: consul-consul
  namespace: loki
  labels:
    app: consul
spec:
  selector:
    app: consul
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 8500
    targetPort: 8500
    protocol: TCP
    name: http
  - port: 8600
    targetPort: 8600
    protocol: TCP
    name: dns-tcp
  - port: 8600
    targetPort: 8600
    protocol: UDP
    name: dns-udp
---
# NetworkPolicy for Loki Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: loki-netpol
  namespace: loki
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - namespaceSelector:
        matchLabels:
          name: prometheus
    - namespaceSelector:
        matchLabels:
          name: grafana
  - ports:
    - protocol: TCP
      port: 3100
    - protocol: TCP
      port: 9096
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 8500
    - protocol: UDP
      port: 8600
---
# Pod Disruption Budget for Ingester
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: loki-ingester-pdb
  namespace: loki
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: loki-ingester
---
# Pod Disruption Budget for Distributor
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: loki-distributor-pdb
  namespace: loki
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: loki-distributor
---
# Pod Disruption Budget for Querier
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: loki-querier-pdb
  namespace: loki
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: loki-querier
---
# Pod Disruption Budget for Query Frontend
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: loki-query-frontend-pdb
  namespace: loki
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: loki-query-frontend
---
# Vertical Pod Autoscaler for Loki Ingester
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: loki-ingester-vpa
  namespace: loki
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: loki-ingester
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: ingester
      maxAllowed:
        cpu: "8000m"
        memory: "16Gi"
      minAllowed:
        cpu: "1000m"
        memory: "2Gi"