# 5.1 Lokié«˜çº§åŠŸèƒ½æ¦‚è¿°

## ğŸ¯ å­¦ä¹ ç›®æ ‡

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- äº†è§£Lokiçš„é«˜çº§åŠŸèƒ½å’Œç‰¹æ€§
- æŒæ¡å¤šç§Ÿæˆ·æ¶æ„å’Œé…ç½®
- å­¦ä¹ æ—¥å¿—é‡‡æ ·å’Œé™æµæœºåˆ¶
- ç†è§£æ—¥å¿—ä¿ç•™å’Œå½’æ¡£ç­–ç•¥
- æŒæ¡Lokiå®‰å…¨é…ç½®å’Œæœ€ä½³å®è·µ

## ğŸ” å¤šç§Ÿæˆ·æ¶æ„

### å¤šç§Ÿæˆ·æ¦‚å¿µ

LokiåŸç”Ÿæ”¯æŒå¤šç§Ÿæˆ·ï¼Œå…è®¸ä¸åŒç»„ç»‡å…±äº«åŒä¸€ä¸ªLokié›†ç¾¤ï¼ŒåŒæ—¶ä¿æŒæ•°æ®éš”ç¦»ã€‚

### ç§Ÿæˆ·éš”ç¦»æœºåˆ¶

#### æ•°æ®éš”ç¦»

```
ç§Ÿæˆ·A â†’ ç´¢å¼•A â†’ å­˜å‚¨ç©ºé—´A
ç§Ÿæˆ·B â†’ ç´¢å¼•B â†’ å­˜å‚¨ç©ºé—´B
ç§Ÿæˆ·C â†’ ç´¢å¼•C â†’ å­˜å‚¨ç©ºé—´C
```

#### APIéš”ç¦»

```bash
# ç§Ÿæˆ·Açš„è¯·æ±‚
curl -H "X-Scope-OrgID: tenant-a" http://loki:3100/loki/api/v1/push

# ç§Ÿæˆ·Bçš„è¯·æ±‚
curl -H "X-Scope-OrgID: tenant-b" http://loki:3100/loki/api/v1/push
```

### å¤šç§Ÿæˆ·é…ç½®

#### å¯ç”¨å¤šç§Ÿæˆ·

```yaml
# loki.yaml
auth_enabled: true  # å¯ç”¨è®¤è¯
auth:
  # è®¤è¯æ–¹å¼
  type: jwt  # æˆ– oauth, saml
  jwt_auth:
    # JWTé…ç½®
    signing_key_file: /path/to/key.pem
    claims_verification_file: /path/to/claims.yml
```

#### ç§Ÿæˆ·é™åˆ¶é…ç½®

```yaml
# limits_config.yaml
limits_config:
  # æ¯ç§Ÿæˆ·é™åˆ¶
  max_global_streams_per_user: 5000
  max_series_per_user: 100000
  max_series_per_metric: 1000
  
  # æ‘„å…¥é™åˆ¶
  ingestion_rate_mb: 10
  ingestion_burst_size_mb: 20
  
  # æŸ¥è¯¢é™åˆ¶
  max_query_length: 1000
  max_concurrent_queries: 5
  query_timeout: 1m
```

#### ç§Ÿæˆ·ç‰¹å®šé…ç½®

```yaml
# å¤šç§Ÿæˆ·ç‰¹å®šè¦†ç›–
per_tenant_override_config:
  "tenant-a":
    ingestion_rate_mb: 50
    max_series_per_user: 500000
  "tenant-b":
    ingestion_rate_mb: 5
    max_series_per_user: 50000
```

### ç§Ÿæˆ·ç®¡ç†

#### ç§Ÿæˆ·åˆ›å»ºå’Œç®¡ç†

```bash
# åˆ›å»ºç§Ÿæˆ·
curl -X POST http://loki:3100/loki/api/v1/tenants \
  -H "X-Scope-OrgID: admin" \
  -H "Content-Type: application/json" \
  -d '{"name": "new-tenant", "created_by": "admin"}'

# åˆ—å‡ºç§Ÿæˆ·
curl http://loki:3100/loki/api/v1/tenants \
  -H "X-Scope-OrgID: admin"

# åˆ é™¤ç§Ÿæˆ·
curl -X DELETE http://loki:3100/loki/api/v1/tenants/tenant-name \
  -H "X-Scope-OrgID: admin"
```

## ğŸ“Š æ—¥å¿—é‡‡æ ·

### é‡‡æ ·æ¦‚å¿µ

æ—¥å¿—é‡‡æ ·æ˜¯ä¸€ç§å‡å°‘æ—¥å¿—é‡çš„æŠ€æœ¯ï¼Œé€šè¿‡é€‰æ‹©æ€§åœ°è®°å½•éƒ¨åˆ†æ—¥å¿—æ¥å‡å°‘å­˜å‚¨å’Œå¤„ç†æˆæœ¬ã€‚

### é‡‡æ ·ç­–ç•¥

#### 1. åŸºäºæ—¥å¿—çº§åˆ«çš„é‡‡æ ·

```yaml
# promtail.yaml
pipeline_stages:
  - match:
      selector: '{level="DEBUG"}'
      pipeline_stages:
        - sampling:
            drop: true
            drop_ratio: 0.8  # ä¸¢å¼ƒ80%çš„DEBUGæ—¥å¿—
  - match:
      selector: '{level="INFO"}'
      pipeline_stages:
        - sampling:
            drop: true
            drop_ratio: 0.5  # ä¸¢å¼ƒ50%çš„INFOæ—¥å¿—
```

#### 2. åŸºäºå†…å®¹çš„é‡‡æ ·

```yaml
# promtail.yaml
pipeline_stages:
  - match:
      selector: '{job="nginx"}'
      pipeline_stages:
        - regex:
            expression: 'status=(?P<status>\d+)'
        - match:
            selector: '{status="200"}'
            pipeline_stages:
              - sampling:
                  drop: true
                  drop_ratio: 0.7  # ä¸¢å¼ƒ70%çš„200çŠ¶æ€ç æ—¥å¿—
```

#### 3. åŸºäºæ—¶é—´çš„é‡‡æ ·

```yaml
# promtail.yaml
pipeline_stages:
  - match:
      selector: '{job="health-check"}'
      pipeline_stages:
        - timestamp:
            format: RFC3339Nano
            source: time
        - sampling:
            drop: true
            drop_ratio: 0.9  # ä¸¢å¼ƒ90%çš„å¥åº·æ£€æŸ¥æ—¥å¿—
```

### é‡‡æ ·æ•ˆæœ

#### é‡‡æ ·å‰åå¯¹æ¯”

```
é‡‡æ ·å‰: 1000æ¡æ—¥å¿—/åˆ†é’Ÿ
é‡‡æ ·å: 200æ¡æ—¥å¿—/åˆ†é’Ÿ (80%å‡å°‘)
å­˜å‚¨èŠ‚çœ: 80%
æŸ¥è¯¢æ€§èƒ½æå‡: 4å€
```

#### æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®Œæ•´æ€§**: é‡‡æ ·å¯èƒ½å¯¼è‡´é‡è¦ä¿¡æ¯ä¸¢å¤±
2. **ç»Ÿè®¡å‡†ç¡®æ€§**: é‡‡æ ·ä¼šå½±å“ç»Ÿè®¡ç»“æœçš„å‡†ç¡®æ€§
3. **é‡‡æ ·æ¯”ä¾‹**: éœ€è¦æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é‡‡æ ·æ¯”ä¾‹

## ğŸš« é™æµæœºåˆ¶

### é™æµæ¦‚å¿µ

é™æµæ˜¯æ§åˆ¶æ—¥å¿—æ‘„å…¥é€Ÿç‡å’ŒæŸ¥è¯¢é¢‘ç‡çš„æœºåˆ¶ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚

### æ‘„å…¥é™æµ

#### å…¨å±€é™æµ

```yaml
# loki.yaml
limits_config:
  # å…¨å±€é™åˆ¶
  ingestion_rate_mb: 100         # å…¨å±€æ‘„å…¥é€Ÿç‡(MB/s)
  ingestion_burst_size_mb: 200   # çªå‘é™åˆ¶(MB)
  
  # ç§Ÿæˆ·é™åˆ¶
  max_global_streams_per_user: 10000
  max_series_per_user: 100000
```

#### ç§Ÿæˆ·ç‰¹å®šé™æµ

```yaml
# loki.yaml
limits_config:
  per_tenant_override_config:
    "tenant-a":
      ingestion_rate_mb: 50
      ingestion_burst_size_mb: 100
    "tenant-b":
      ingestion_rate_mb: 20
      ingestion_burst_size_mb: 40
```

### æŸ¥è¯¢é™æµ

#### æŸ¥è¯¢å¹¶å‘é™åˆ¶

```yaml
# loki.yaml
limits_config:
  max_concurrent_queries: 10      # æ¯ç§Ÿæˆ·æœ€å¤§å¹¶å‘æŸ¥è¯¢æ•°
  query_timeout: 1m              # æŸ¥è¯¢è¶…æ—¶æ—¶é—´
  max_query_length: 1000         # æŸ¥è¯¢é•¿åº¦é™åˆ¶
```

#### Frontendé™æµ

```yaml
# loki.yaml
frontend:
  max_outstanding_per_tenant: 2048  # æ¯ç§Ÿæˆ·æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
  compress_responses: true          # å¯ç”¨å“åº”å‹ç¼©
```

### é™æµç›‘æ§

#### ç›‘æ§æŒ‡æ ‡

```bash
# æŸ¥çœ‹å½“å‰é™åˆ¶
curl http://loki:3100/loki/api/v1/limits \
  -H "X-Scope-OrgID: tenant-a"

# æŸ¥çœ‹ç§Ÿæˆ·çŠ¶æ€
curl http://loki:3100/loki/api/v1/tenant/status \
  -H "X-Scope-OrgID: tenant-a"
```

#### å‘Šè­¦é…ç½®

```yaml
# å‘Šè­¦è§„åˆ™
groups:
  - name: loki-limits
    rules:
      - alert: LokiRateLimitExceeded
        expr: loki_ingester_rate_limited_total > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Loki rate limit exceeded"
```

## ğŸ“… æ—¥å¿—ä¿ç•™ç­–ç•¥

### ä¿ç•™ç­–ç•¥æ¦‚å¿µ

æ—¥å¿—ä¿ç•™ç­–ç•¥æ§åˆ¶æ—¥å¿—çš„ä¿å­˜æ—¶é—´ï¼Œå¹³è¡¡å­˜å‚¨æˆæœ¬å’Œæ•°æ®å¯ç”¨æ€§ã€‚

### æ—¶é—´ä¿ç•™ç­–ç•¥

#### å…¨å±€ä¿ç•™é…ç½®

```yaml
# loki.yaml
limits_config:
  retention_period: 30d  # å…¨å±€ä¿ç•™30å¤©
```

#### è¡¨ç‰¹å®šä¿ç•™

```yaml
# schema_config.yaml
schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: s3
      schema: v11
      index:
        prefix: index_
        period: 24h
      # è¡¨ç‰¹å®šä¿ç•™
      chunks:
        retention_period: 30d
      index:
        retention_period: 60d
```

#### ç§Ÿæˆ·ç‰¹å®šä¿ç•™

```yaml
# loki.yaml
limits_config:
  per_tenant_override_config:
    "tenant-a":
      retention_period: 15d
    "tenant-b":
      retention_period: 60d
    "tenant-c":
      retention_period: 90d
```

### å¤§å°ä¿ç•™ç­–ç•¥

#### å¤§å°é™åˆ¶

```yaml
# loki.yaml
limits_config:
  max_global_bytes_per_user: 100GB  # æ¯ç§Ÿæˆ·æœ€å¤§å­˜å‚¨
```

#### åˆ†çº§ä¿ç•™

```yaml
# é«˜é¢‘æ•°æ®çŸ­æœŸä¿ç•™ï¼Œä½é¢‘æ•°æ®é•¿æœŸä¿ç•™
schema_config:
  configs:
    - from: 2023-01-01
      store: boltdb-shipper
      object_store: s3
      schema: v11
      index:
        prefix: index_
        period: 24h
      # çƒ­æ•°æ®ï¼ˆæœ€è¿‘7å¤©ï¼‰
      chunks:
        retention_period: 7d
    - from: 2022-01-01
      store: boltdb-shipper
      object_store: s3
      schema: v11
      index:
        prefix: index_archive_
        period: 168h  # ä¸€å‘¨
      # å†·æ•°æ®ï¼ˆ30å¤©ï¼‰
      chunks:
        retention_period: 30d
```

### å½’æ¡£ç­–ç•¥

#### è‡ªåŠ¨å½’æ¡£

```yaml
# loki.yaml
compactor:
  retention_enabled: true
  delete_request_cancel_period: 24h
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
  
  # å½’æ¡£é…ç½®
  archive_enabled: true
  archive_retention: 365d  # å½’æ¡£ä¿ç•™1å¹´
```

#### æ‰‹åŠ¨å½’æ¡£

```bash
# è§¦å‘å½’æ¡£
curl -X POST http://loki:3100/loki/api/v1/admin/retention/tenant/tenant-a/delete \
  -H "X-Scope-OrgID: tenant-a" \
  -d '{"start": "2022-01-01T00:00:00Z", "end": "2022-12-31T23:59:59Z"}'
```

## ğŸ”’ å®‰å…¨é…ç½®

### è®¤è¯æœºåˆ¶

#### JWTè®¤è¯

```yaml
# loki.yaml
auth:
  type: jwt
  jwt_auth:
    signing_key_file: /path/to/key.pem
    claims_verification_file: /path/to/claims.yml
    issuer: https://auth.example.com
    audience: loki
```

#### OAuthè®¤è¯

```yaml
# loki.yaml
auth:
  type: oauth
  oauth:
    client_id: loki-client
    client_secret: loki-secret
    token_url: https://auth.example.com/oauth/token
    user_attribute: sub
```

### æˆæƒæœºåˆ¶

#### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

```yaml
# loki.yaml
auth:
  type: authz
  authz:
    type: rbac
    rbac:
      config_file: /path/to/rbac-config.yaml
```

#### RBACé…ç½®ç¤ºä¾‹

```yaml
# rbac-config.yaml
groups:
  - name: readers
    permissions:
      - action: read
        resource: logs
      - action: list
        resource: tenants
  - name: writers
    permissions:
      - action: read
        resource: logs
      - action: write
        resource: logs
      - action: list
        resource: tenants
  - name: admins
    permissions:
      - action: "*"
        resource: "*"

users:
  - username: user1
    groups: ["readers"]
  - username: user2
    groups: ["readers", "writers"]
  - username: admin
    groups: ["admins"]
```

### ä¼ è¾“å®‰å…¨

#### TLSé…ç½®

```yaml
# loki.yaml
server:
  http_listen_port: 3100
  https_listen_port: 3101
  tls_config:
    cert_file: /path/to/server.crt
    key_file: /path/to/server.key
    client_auth_type: VerifyClientCertIfGiven
    client_ca_file: /path/to/ca.crt
```

#### å®¢æˆ·ç«¯è®¤è¯

```yaml
# promtail.yaml
clients:
  - url: https://loki:3101/loki/api/v1/push
    tenant_id: my-tenant
    basic_auth:
      username: promtail
      password: secret
    tls:
      ca_file: /path/to/ca.crt
      cert_file: /path/to/client.crt
      key_file: /path/to/client.key
      insecure_skip_verify: false
```

## ğŸ§ª å®éªŒï¼šé«˜çº§åŠŸèƒ½é…ç½®

è®©æˆ‘ä»¬é€šè¿‡å®éªŒå®ç°Lokiçš„é«˜çº§åŠŸèƒ½ï¼š

1. é…ç½®å¤šç§Ÿæˆ·ç¯å¢ƒ
2. è®¾ç½®æ—¥å¿—é‡‡æ ·ç­–ç•¥
3. é…ç½®é™æµå’Œä¿ç•™ç­–ç•¥
4. è®¾ç½®å®‰å…¨è®¤è¯

**å®éªŒä»£ç å’Œé…ç½®ï¼š**

è§[code/experiments/advanced-features.yaml](../code/chapter5/advanced-features.yaml)

### å®éªŒæ­¥éª¤

1. **éƒ¨ç½²å¤šç§Ÿæˆ·Loki**:

```bash
# ä½¿ç”¨é«˜çº§åŠŸèƒ½é…ç½®
docker-compose -f advanced-features.yaml up -d
```

2. **é…ç½®ç§Ÿæˆ·**:

```bash
# åˆ›å»ºç§Ÿæˆ·
curl -X POST http://localhost:3100/loki/api/v1/tenants \
  -H "X-Scope-OrgID: admin" \
  -H "Content-Type: application/json" \
  -d '{"name": "test-tenant", "created_by": "admin"}'
```

3. **æµ‹è¯•é‡‡æ ·**:

```bash
# ç”Ÿæˆæµ‹è¯•æ—¥å¿—
for i in {1..1000}; do
  echo "2023-10-01T10:00:00.000Z [DEBUG] Debug message $i"
  echo "2023-10-01T10:00:00.000Z [INFO] Info message $i"
done | promtail -config.file=promtail.yaml
```

4. **éªŒè¯é™æµ**:

```bash
# æ£€æŸ¥é™æµçŠ¶æ€
curl http://localhost:3100/loki/api/v1/limits \
  -H "X-Scope-OrgID: test-tenant"
```

## ğŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

- Lokiå¤šç§Ÿæˆ·æ¶æ„å’Œé…ç½®æ–¹æ³•
- æ—¥å¿—é‡‡æ ·ç­–ç•¥å’Œå®ç°
- é™æµæœºåˆ¶å’Œé…ç½®
- æ—¥å¿—ä¿ç•™å’Œå½’æ¡£ç­–ç•¥
- å®‰å…¨è®¤è¯å’Œæˆæƒæœºåˆ¶

è¿™äº›é«˜çº§åŠŸèƒ½å°†å¸®åŠ©æ‚¨æ„å»ºä¸€ä¸ªå¯æ‰©å±•ã€å®‰å…¨ä¸”é«˜æ•ˆçš„æ—¥å¿—ç³»ç»Ÿï¼Œæ»¡è¶³ä¼ä¸šçº§åº”ç”¨çš„éœ€æ±‚ã€‚

## ğŸ¤” æ€è€ƒé¢˜

1. åœ¨ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥å¯ç”¨å¤šç§Ÿæˆ·æ¶æ„ï¼Ÿ
2. æ—¥å¿—é‡‡æ ·å¯¹æ•°æ®åˆ†ææœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
3. å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§ï¼Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Lokiå¤šç§Ÿæˆ·æ–‡æ¡£](https://grafana.com/docs/loki/latest/operations/multi-tenancy/)
- [Lokiæ—¥å¿—é‡‡æ ·](https://grafana.com/docs/loki/latest/clients/promtail/stages/sampling/)
- [Lokiå®‰å…¨é…ç½®](https://grafana.com/docs/loki/latest/operations/security/)