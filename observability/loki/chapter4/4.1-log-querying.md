# 4.1 æ—¥å¿—æŸ¥è¯¢åŸºç¡€

## ðŸŽ¯ å­¦ä¹ ç›®æ ‡

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- ç†è§£LokiæŸ¥è¯¢ç³»ç»Ÿçš„åŸºæœ¬åŽŸç†
- æŽŒæ¡LogQLåŸºç¡€è¯­æ³•å’Œç»“æž„
- å­¦ä¹ åŸºæœ¬çš„æ—¥å¿—æŸ¥è¯¢æ–¹æ³•
- äº†è§£æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§
- æŽŒæ¡å¸¸è§æŸ¥è¯¢åœºæ™¯çš„è§£å†³æ–¹æ¡ˆ

## ðŸ” æŸ¥è¯¢ç³»ç»Ÿæ¦‚è¿°

### æŸ¥è¯¢æµç¨‹

```
Grafana/å®¢æˆ·ç«¯ â†’ æŸ¥è¯¢å‰ç«¯ â†’ æŸ¥è¯¢å™¨ â†’ å­˜å‚¨ â†’ ç»“æžœå¤„ç† â†’ è¿”å›žç»“æžœ
```

### æŸ¥è¯¢ç±»åž‹

1. **å³æ—¶æŸ¥è¯¢**: èŽ·å–ç‰¹å®šæ—¶é—´ç‚¹çš„æ—¥å¿—
2. **èŒƒå›´æŸ¥è¯¢**: èŽ·å–æ—¶é—´èŒƒå›´å†…çš„æ—¥å¿—
3. **æµå¼æŸ¥è¯¢**: å®žæ—¶æµå¼æ—¥å¿—
4. **èšåˆæŸ¥è¯¢**: èšåˆè®¡ç®—å’Œç»Ÿè®¡

## ðŸ“Š LogQLåŸºç¡€

### LogQLæ˜¯ä»€ä¹ˆï¼Ÿ

LogQL (Log Query Language) æ˜¯Lokiçš„æŸ¥è¯¢è¯­è¨€ï¼Œè®¾è®¡çµæ„Ÿæ¥æºäºŽPrometheusçš„PromQLï¼Œä¸“é—¨ç”¨äºŽæ—¥å¿—æ•°æ®çš„æŸ¥è¯¢å’Œåˆ†æžã€‚

### LogQL vs. SQL

| ç‰¹æ€§ | LogQL | SQL |
|------|-------|-----|
| æ•°æ®æ¨¡åž‹ | æ—¶é—´åºåˆ—æ—¥å¿—æµ | å…³ç³»è¡¨ |
| æŸ¥è¯¢æ–¹å¼ | æ ‡ç­¾è¿‡æ»¤ + æ—¥å¿—è¿‡æ»¤ | æ¡ä»¶è¯­å¥ |
| èšåˆæ“ä½œ | å†…ç½®èšåˆå‡½æ•° | GROUP BY |
| æ—¶é—´å¤„ç† | åŽŸç”Ÿæ”¯æŒ | ç‰¹å®šå‡½æ•° |
| è¯­æ³•é£Žæ ¼ | ç±»ä¼¼PromQL | æ ‡å‡†SQL |

### æŸ¥è¯¢è¯­æ³•ç»“æž„

LogQLæŸ¥è¯¢ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

1. **æ—¥å¿—é€‰æ‹©å™¨(Log Selector)**: é€‰æ‹©è¦æŸ¥è¯¢çš„æ—¥å¿—æµ
2. **ç®¡é“(Pipeline)**: å¤„ç†å’Œè¿‡æ»¤æ—¥å¿—å†…å®¹

#### åŸºæœ¬è¯­æ³•

```
{æ ‡ç­¾é€‰æ‹©å™¨} [ç®¡é“è¡¨è¾¾å¼]
```

#### ç¤ºä¾‹

```
{job="nginx"} |= "error"         # æŸ¥è¯¢nginxä½œä¸šä¸­åŒ…å«errorçš„æ—¥å¿—
{level="ERROR"} |~ "database.*timeout"  # æŸ¥è¯¢åŒ…å«æ•°æ®åº“è¶…æ—¶çš„é”™è¯¯æ—¥å¿—
```

## ðŸ·ï¸ æ ‡ç­¾é€‰æ‹©å™¨

### åŸºæœ¬æ ‡ç­¾åŒ¹é…

#### ç²¾ç¡®åŒ¹é…

```
{job="nginx"}              # åŒ¹é…jobç­‰äºŽnginxçš„æ—¥å¿—æµ
{level="ERROR",job="api"}  # åŒ¹é…levelç­‰äºŽERRORä¸”jobç­‰äºŽapiçš„æ—¥å¿—æµ
```

#### æ­£åˆ™åŒ¹é…

```
{job=~"nginx|apache"}      # åŒ¹é…jobç­‰äºŽnginxæˆ–apacheçš„æ—¥å¿—æµ
{instance=~"web-.*"}       # åŒ¹é…instanceä»¥web-å¼€å¤´çš„æ—¥å¿—æµ
```

#### ä¸ç­‰äºŽåŒ¹é…

```
{job!="nginx"}             # åŒ¹é…jobä¸ç­‰äºŽnginxçš„æ—¥å¿—æµ
{job!~"nginx|apache"}      # åŒ¹é…jobä¸ç­‰äºŽnginxä¸”ä¸ç­‰äºŽapacheçš„æ—¥å¿—æµ
```

### å¤åˆæ ‡ç­¾é€‰æ‹©å™¨

#### é€»è¾‘ä¸Ž

```
{job="nginx"} {level="ERROR"}  # ç­‰åŒäºŽ {job="nginx",level="ERROR"}
```

#### é€»è¾‘æˆ–

```
{job="nginx"} or {job="apache"}  # åŒ¹é…nginxæˆ–apacheçš„æ—¥å¿—æµ
```

## ðŸ”§ ç®¡é“è¡¨è¾¾å¼

### è¿‡æ»¤æ“ä½œç¬¦

#### ç­‰äºŽåŒ¹é…

```
{job="nginx"} |= "error"        # åŒ…å«error
```

#### ä¸ç­‰äºŽåŒ¹é…

```
{job="nginx"} != "debug"        # ä¸åŒ…å«debug
```

#### æ­£åˆ™åŒ¹é…

```
{job="nginx"} |~ "error|warn"   # åŒ¹é…erroræˆ–warn
{job="nginx"} |~ "user.*login"  # åŒ¹é…ä»¥userå¼€å¤´ã€ä»¥loginç»“å°¾
```

#### æ­£åˆ™ä¸åŒ¹é…

```
{job="nginx"} !~ "debug|trace"   # ä¸åŒ…å«debugæˆ–trace
```

### è¡Œè¿‡æ»¤è¡¨è¾¾å¼

#### è§£æžè¿‡æ»¤

```
{job="api"} | json | level="ERROR"  # è§£æžJSONåŽè¿‡æ»¤levelå­—æ®µ
```

#### è¡Œæå–

```
{job="nginx"} | line_format "{{.hostname}} {{.message}}"  # é‡æ–°æ ¼å¼åŒ–æ—¥å¿—è¡Œ
```

#### æ ‡ç­¾æå–

```
{job="api"} | logfmt | label level component  # ä»Žç»“æž„åŒ–æ—¥å¿—æå–æ ‡ç­¾
```

## ðŸ“ˆ èšåˆæ“ä½œ

### åŸºæœ¬èšåˆå‡½æ•°

#### è®¡æ•°

```
count_over_time({job="nginx"} [5m])  # 5åˆ†é’Ÿå†…nginxæ—¥å¿—çš„æ€»æ•°
```

#### æ±‚å’Œ

```
sum_over_time({job="nginx"} |= "error" [5m])  # 5åˆ†é’Ÿå†…åŒ…å«errorçš„æ—¥å¿—æ€»æ•°
```

#### å¹³å‡å€¼

```
avg_over_time({job="nginx"} | unwrap response_time [5m])  # 5åˆ†é’Ÿå†…å¹³å‡å“åº”æ—¶é—´
```

#### æœ€å¤§å€¼/æœ€å°å€¼

```
max_over_time({job="nginx"} | unwrap response_time [5m])  # 5åˆ†é’Ÿå†…æœ€å¤§å“åº”æ—¶é—´
min_over_time({job="nginx"} | unwrap response_time [5m])  # 5åˆ†é’Ÿå†…æœ€å°å“åº”æ—¶é—´
```

### èšåˆä¿®é¥°ç¬¦

#### by

```
sum by (level) (count_over_time({job="api"} [5m]))  # æŒ‰çº§åˆ«åˆ†ç»„çš„æ—¥å¿—è®¡æ•°
```

#### without

```
sum without (instance) (count_over_time({job="api"} [5m]))  # ä¸æŒ‰å®žä¾‹åˆ†ç»„çš„æ—¥å¿—è®¡æ•°
```

## ðŸŽ¯ å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### åŸºç¡€æŸ¥è¯¢

#### æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—

```
{job=~".+"}  # æ‰€æœ‰ä½œä¸šçš„æ—¥å¿—
{}           # æ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬æ²¡æœ‰æ ‡ç­¾çš„ï¼‰
```

#### æŸ¥è¯¢ç‰¹å®šæ—¶é—´èŒƒå›´

```
{job="nginx"} >= "2023-10-01T10:00:00Z" <= "2023-10-01T11:00:00Z"
```

#### æŒ‰å†…å®¹è¿‡æ»¤

```
{job="nginx"} |= "404"           # åŒ…å«404
{job="nginx"} |~ "error|fail"     # åŒ…å«erroræˆ–fail
{job="nginx"} != "debug"          # ä¸åŒ…å«debug
{job="nginx"} !~ "health|ping"   # ä¸åŒ…å«healthæˆ–ping
```

### JSONæ—¥å¿—æŸ¥è¯¢

#### è§£æžJSONå­—æ®µ

```
{job="api"} | json | level="ERROR"           # è§£æžJSONå¹¶è¿‡æ»¤levelå­—æ®µ
{job="api"} | json | response_code >= 500    # è§£æžJSONå¹¶è¿‡æ»¤response_code
```

#### æå–JSONå­—æ®µä¸ºæ ‡ç­¾

```
{job="api"} | json | label level service response_code
```

### æ—¥å¿—æŒ‡æ ‡æŸ¥è¯¢

#### é”™è¯¯çŽ‡

```
sum(count_over_time({job="api"} | level="ERROR" [5m]))
/
sum(count_over_time({job="api"} [5m])) * 100
```

#### çŠ¶æ€ç åˆ†å¸ƒ

```
sum by (status) (count_over_time({job="nginx"} | json | label status [5m]))
```

#### å“åº”æ—¶é—´åˆ†å¸ƒ

```
histogram_quantile(0.95,
  sum by (le) (rate({job="api"} | json | unwrap response_time [5m]))
)
```

## âš¡ æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

### æ ‡ç­¾ä¼˜åŒ–

#### ä½¿ç”¨é«˜é€‰æ‹©æ€§æ ‡ç­¾

```
# ä¼˜åŒ–å‰
{job="api"} |= "error"

# ä¼˜åŒ–åŽ
{job="api",level="ERROR"}  # ç›´æŽ¥ä½¿ç”¨levelæ ‡ç­¾
```

#### é¿å…è¿‡å®½æ³›çš„æŸ¥è¯¢

```
# é¿å…
{} |= "error"

# æŽ¨è
{job=~"api|nginx"} |= "error"
```

### æ—¶é—´èŒƒå›´ä¼˜åŒ–

#### åˆç†è®¾ç½®æ—¶é—´çª—å£

```
# é¿å…è¿‡å¤§çš„æ—¶é—´çª—å£
count_over_time({job="nginx"} [24h])

# æŽ¨è
count_over_time({job="nginx"} [1h])
```

#### ä½¿ç”¨ç›¸å¯¹æ—¶é—´

```
# ä½¿ç”¨ç›¸å¯¹æ—¶é—´è€Œä¸æ˜¯ç»å¯¹æ—¶é—´
{job="nginx"} > now() - 1h
```

### è¿‡æ»¤ä¼˜åŒ–

#### å…ˆæ ‡ç­¾è¿‡æ»¤ï¼ŒåŽå†…å®¹è¿‡æ»¤

```
# ä¼˜åŒ–å‰
{job="api"} | json | status="500"

# ä¼˜åŒ–åŽ
{job="api",status="500"} | json
```

#### ä½¿ç”¨é«˜æ•ˆçš„æ“ä½œç¬¦

```
# ä¼˜åŒ–å‰
{job="api"} |~ ".*error.*"

# ä¼˜åŒ–åŽ
{job="api"} |= "error"
```

## ðŸ› ï¸ æŸ¥è¯¢è°ƒè¯•æŠ€å·§

### æŸ¥è¯¢è§£é‡Š

#### æŸ¥è¯¢æ€§èƒ½åˆ†æž

```
# æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
curl -G -s "http://localhost:3100/loki/api/v1/query" \
  --data-urlencode 'query={job="nginx"}' \
  --data-urlencode 'explain=true'
```

#### æŸ¥è¯¢ç»Ÿè®¡

```
# æŸ¥çœ‹æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
curl -G -s "http://localhost:3100/loki/api/v1/stats" \
  --data-urlencode 'query={job="nginx"}'
```

### é€æ­¥æž„å»ºæŸ¥è¯¢

#### ä»Žç®€å•åˆ°å¤æ‚

```
# ç¬¬1æ­¥ï¼šé€‰æ‹©æ—¥å¿—æµ
{job="nginx"}

# ç¬¬2æ­¥ï¼šæ·»åŠ æ—¶é—´è¿‡æ»¤
{job="nginx"} > now() - 1h

# ç¬¬3æ­¥ï¼šæ·»åŠ å†…å®¹è¿‡æ»¤
{job="nginx"} > now() - 1h |= "error"

# ç¬¬4æ­¥ï¼šæ·»åŠ èšåˆ
count_over_time({job="nginx"} > now() - 1h |= "error" [5m])
```

## ðŸ§ª å®žéªŒï¼šæ—¥å¿—æŸ¥è¯¢ç»ƒä¹ 

è®©æˆ‘ä»¬é€šè¿‡å®žéªŒç»ƒä¹ å„ç§æ—¥å¿—æŸ¥è¯¢æŠ€å·§ï¼š

1. åˆ›å»ºæµ‹è¯•æ•°æ®
2. æ‰§è¡Œä¸åŒç±»åž‹çš„æŸ¥è¯¢
3. æ¯”è¾ƒæŸ¥è¯¢æ€§èƒ½
4. ä¼˜åŒ–æŸ¥è¯¢è¡¨è¾¾å¼

**å®žéªŒä»£ç å’Œé…ç½®ï¼š**

è§[code/experiments/log-querying-examples.sh](../code/chapter4/log-querying-examples.sh)

### å®žéªŒæ­¥éª¤

1. **ç”Ÿæˆæµ‹è¯•æ—¥å¿—**:

```bash
# åˆ›å»ºæµ‹è¯•æ—¥å¿—
cat > test-logs.jsonl << EOF
{"timestamp": "2023-10-01T10:00:00Z", "level": "INFO", "service": "auth", "message": "User login successful"}
{"timestamp": "2023-10-01T10:01:00Z", "level": "WARN", "service": "auth", "message": "Slow query detected"}
{"timestamp": "2023-10-01T10:02:00Z", "level": "ERROR", "service": "auth", "message": "Authentication failed"}
{"timestamp": "2023-10-01T10:03:00Z", "level": "INFO", "service": "payment", "message": "Payment processed"}
{"timestamp": "2023-10-01T10:04:00Z", "level": "ERROR", "service": "payment", "message": "Payment gateway timeout"}
EOF
```

2. **æ‰§è¡ŒåŸºç¡€æŸ¥è¯¢**:

```bash
# æŸ¥è¯¢æ‰€æœ‰ERRORæ—¥å¿—
curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={job="test"} | json | level="ERROR"' \
  --data-urlencode 'start=2023-10-01T09:00:00.000Z' \
  --data-urlencode 'end=2023-10-01T11:00:00.000Z' \
  --data-urlencode 'step=30s'
```

3. **æ‰§è¡ŒèšåˆæŸ¥è¯¢**:

```bash
# è®¡ç®—é”™è¯¯çŽ‡
curl -G -s "http://localhost:3100/loki/api/v1/query" \
  --data-urlencode 'query=sum(count_over_time({job="test"} | json | level="ERROR" [5m]))'
```

## ðŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

- LogQLçš„åŸºæœ¬è¯­æ³•å’Œç»“æž„
- æ ‡ç­¾é€‰æ‹©å™¨å’Œè¿‡æ»¤æ“ä½œ
- ç®¡é“è¡¨è¾¾å¼å’Œèšåˆæ“ä½œ
- æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§å’Œè°ƒè¯•æ–¹æ³•
- å¸¸è§æŸ¥è¯¢åœºæ™¯çš„è§£å†³æ–¹æ¡ˆ

æŽŒæ¡è¿™äº›åŸºç¡€çŸ¥è¯†å°†å¸®åŠ©æ‚¨æœ‰æ•ˆåœ°æŸ¥è¯¢å’Œåˆ†æžæ—¥å¿—æ•°æ®ï¼Œä»Žæµ·é‡æ—¥å¿—ä¸­æå–æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚åœ¨ä¸‹ä¸€ç« [4.2 LogQLé«˜çº§æŸ¥è¯¢](./4.2-logql.md)ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ æ›´é«˜çº§çš„LogQLåŠŸèƒ½å’ŒæŠ€å·§ã€‚

## ðŸ¤” æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆå…ˆæ ‡ç­¾è¿‡æ»¤åŽå†…å®¹è¿‡æ»¤å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Ÿ
2. åœ¨ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨èšåˆæŸ¥è¯¢ï¼Ÿ
3. å¦‚ä½•è¯„ä¼°å’Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

## ðŸ“š å»¶ä¼¸é˜…è¯»

- [LogQLå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/loki/latest/logql/)
- [LokiæŸ¥è¯¢æœ€ä½³å®žè·µ](https://grafana.com/docs/loki/latest/query/examples/)
- [Grafanaæ—¥å¿—æŸ¥è¯¢](https://grafana.com/docs/grafana/latest/explore/logs-integration/)