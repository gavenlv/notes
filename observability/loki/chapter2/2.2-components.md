# 2.2 Lokiæ ¸å¿ƒç»„ä»¶è¯¦è§£

## ğŸ¯ å­¦ä¹ ç›®æ ‡

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- æ·±å…¥äº†è§£Lokiå„ç»„ä»¶çš„å®ç°ç»†èŠ‚
- æŒæ¡å„ç»„ä»¶çš„é…ç½®é€‰é¡¹å’Œä¼˜åŒ–æŠ€å·§
- ç†è§£ç»„ä»¶é—´çš„äº¤äº’å’Œåä½œæœºåˆ¶
- äº†è§£å¸¸è§ç»„ä»¶é—®é¢˜çš„æ•…éšœæ’é™¤æ–¹æ³•
- å­¦ä¹ å¦‚ä½•æ ¹æ®éœ€æ±‚è°ƒæ•´ç»„ä»¶é…ç½®

## ğŸ”§ Ingesterï¼ˆæ¥æ”¶å™¨ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Ingesteræ˜¯Lokiä¸­è´Ÿè´£æ¥æ”¶å’Œå¤„ç†æ—¥å¿—æ•°æ®çš„ç»„ä»¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

1. æ¥æ”¶æ¥è‡ªDistributorçš„æ—¥å¿—æµ
2. æ„å»ºå’Œç®¡ç†æ—¥å¿—å—(Chunk)
3. å‹ç¼©å’ŒæŒä¹…åŒ–æ—¥å¿—æ•°æ®
4. å¤„ç†æŸ¥è¯¢è¯·æ±‚

### å·¥ä½œåŸç†

```
æ—¥å¿—æµ â†’ æ ‡ç­¾æå– â†’ æ—¥å¿—åˆ†å— â†’ å‹ç¼© â†’ å­˜å‚¨åˆ°å¯¹è±¡å­˜å‚¨
      â†“
  æ„å»ºç´¢å¼• â†’ å­˜å‚¨åˆ°ç´¢å¼•åç«¯
```

### æ—¥å¿—å—(Chunk)ç®¡ç†

#### å—ç”Ÿå‘½å‘¨æœŸ

1. **åˆ›å»º**: æ–°çš„æ—¥å¿—æµåˆ°è¾¾æ—¶åˆ›å»º
2. **è¿½åŠ **: æ—¥å¿—æ¡ç›®è¿½åŠ åˆ°å—ä¸­
3. **åˆ·æ–°**: æ»¡è¶³æ¡ä»¶æ—¶åˆ·æ–°åˆ°å­˜å‚¨
4. **å‹ç¼©**: åˆå¹¶å’Œå‹ç¼©æ—§å—

#### åˆ·æ–°æ¡ä»¶

```yaml
ingester:
  chunk_idle_period: 1h       # å—ç©ºé—²1å°æ—¶ååˆ·æ–°
  max_chunk_age: 2h           # å—æœ€å¤§2å°æ—¶ååˆ·æ–°
  chunk_target_size: 1048576   # å—è¾¾åˆ°1MBååˆ·æ–°
  chunk_retain_period: 30s    # å—åˆ·æ–°ååœ¨å†…å­˜ä¸­ä¿ç•™30ç§’
```

### é…ç½®ä¼˜åŒ–

#### é«˜ååé‡åœºæ™¯

```yaml
ingester:
  lifecycler:
    ring:
      replication_factor: 3    # 3å‰¯æœ¬ç¡®ä¿å¯é æ€§
      heartbeat_timeout: 1m    # å¿ƒè·³è¶…æ—¶æ—¶é—´
  chunk_idle_period: 30m       # æ›´é¢‘ç¹çš„åˆ·æ–°
  max_chunk_age: 1h            # æ›´çŸ­çš„å—å¯¿å‘½
  chunk_target_size: 2097152   # æ›´å¤§çš„ç›®æ ‡å—å¤§å°
  max_transfer_retries: 0      # ç¦ç”¨ä¼ è¾“é‡è¯•ä»¥æé«˜æ€§èƒ½
  concurrent_flushes: 32        # å¢åŠ å¹¶å‘åˆ·æ–°æ•°
```

#### é«˜å¯é æ€§åœºæ™¯

```yaml
ingester:
  lifecycler:
    ring:
      replication_factor: 3    # 3å‰¯æœ¬
      heartbeat_timeout: 30s   # æ›´çŸ­çš„å¿ƒè·³è¶…æ—¶
  chunk_idle_period: 2h        # æ›´é•¿çš„ç©ºé—²æ—¶é—´
  max_chunk_age: 4h            # æ›´é•¿çš„å—å¯¿å‘½
  max_transfer_retries: 10     # å¢åŠ é‡è¯•æ¬¡æ•°
  transfer_timeout: 30s        # ä¼ è¾“è¶…æ—¶æ—¶é—´
```

### æ•…éšœè½¬ç§»ä¸æ•°æ®æ¢å¤

å½“Ingesteræ•…éšœæ—¶ï¼š

1. **æ£€æµ‹**: Ringæ£€æµ‹åˆ°èŠ‚ç‚¹ä¸å¯è¾¾
2. **è½¬ç§»**: æ—¥å¿—æµè½¬ç§»åˆ°å¥åº·èŠ‚ç‚¹
3. **é‡å»º**: æ–°èŠ‚ç‚¹é‡å»ºå†…å­˜çŠ¶æ€

```yaml
ingester:
  lifecycler:
    join_after: 0s             # ç«‹å³åŠ å…¥Ring
    final_sleep: 0s            # ä¸ç­‰å¾…ç›´æ¥é€€å‡º
    min_ready_duration: 10s     # æœ€çŸ­å°±ç»ªæ—¶é—´
```

## ğŸ“¡ Distributorï¼ˆåˆ†å‘å™¨ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Distributoræ˜¯Lokiçš„å‰ç«¯ç»„ä»¶ï¼Œè´Ÿè´£ï¼š

1. æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„æ—¥å¿—
2. éªŒè¯å’Œé¢„å¤„ç†æ—¥å¿—
3. æ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œåˆ†å‘æ—¥å¿—
4. å¤„ç†ç§Ÿæˆ·éš”ç¦»

### æ—¥å¿—åˆ†å‘æœºåˆ¶

#### ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•

```
1. è®¡ç®—æ ‡ç­¾é›†çš„å“ˆå¸Œå€¼
2. åœ¨å“ˆå¸Œç¯ä¸Šå®šä½
3. é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
4. å°†æ—¥å¿—å‘é€åˆ°è¯¥èŠ‚ç‚¹
```

#### å‰¯æœ¬åˆ†å‘

```yaml
distributor:
  ring:
    kvstore:
      store: consul
      consul:
        hostname: consul
        port: 8500
    heartbeat_timeout: 1m
    replication_factor: 3     # 3å‰¯æœ¬åˆ†å‘
```

### é…ç½®ä¼˜åŒ–

#### é«˜å¹¶å‘åœºæ™¯

```yaml
distributor:
  ring:
    kvstore:
      store: memberlist      # ä½¿ç”¨memberlistæé«˜æ€§èƒ½
  max_transfer_retries: 0
  timeout: 5s
  ha_tracker:
    enable_ha_tracker: true
    update_timeout: 2s
    num_workers: 50          # å¢åŠ å·¥ä½œçº¿ç¨‹æ•°
```

#### å¤šç§Ÿæˆ·åœºæ™¯

```yaml
distributor:
  ring:
    kvstore:
      store: consul
    replication_factor: 3
  tenant_limits:
    ingestion_rate: 10485760  # æ¯ç§Ÿæˆ·10MB/s
    ingestion_burst_size: 20971520  # æ¯ç§Ÿæˆ·20MBçªå‘
    max_series_per_user: 100000
    max_series_per_metric: 1000
```

### æ—¥å¿—éªŒè¯ä¸é¢„å¤„ç†

#### æ ‡ç­¾éªŒè¯

DistributoréªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

1. **æ ‡ç­¾æ•°é‡**: ä¸è¶…è¿‡é™åˆ¶
2. **æ ‡ç­¾åç§°**: ä¸åŒ…å«éæ³•å­—ç¬¦
3. **æ ‡ç­¾å€¼**: ä¸è¶…è¿‡é•¿åº¦é™åˆ¶
4. **æ—¶é—´æˆ³**: åœ¨æœ‰æ•ˆèŒƒå›´å†…

```yaml
limits_config:
  max_label_names_per_series: 30
  max_label_value_length: 2048
  reject_old_samples: true
  reject_old_samples_max_age: 168h
```

## ğŸ” Querierï¼ˆæŸ¥è¯¢å™¨ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Querieræ˜¯Lokiçš„æŸ¥è¯¢å¤„ç†ç»„ä»¶ï¼Œè´Ÿè´£ï¼š

1. æ¥æ”¶å’Œè§£ææŸ¥è¯¢è¯·æ±‚
2. ä»å­˜å‚¨ä¸­è·å–æ•°æ®
3. æ‰§è¡ŒLogQLæŸ¥è¯¢
4. èšåˆå’Œè¿”å›ç»“æœ

### æŸ¥è¯¢æ‰§è¡Œæµç¨‹

```
1. æ¥æ”¶æŸ¥è¯¢è¯·æ±‚
2. è§£æLogQLæŸ¥è¯¢
3. æ„å»ºæŸ¥è¯¢è®¡åˆ’
4. å¹¶è¡ŒæŸ¥è¯¢ç´¢å¼•å’Œæ•°æ®
5. æµå¼å¤„ç†å’Œèšåˆ
6. è¿”å›ç»“æœ
```

### é…ç½®ä¼˜åŒ–

#### é«˜æ€§èƒ½æŸ¥è¯¢

```yaml
querier:
  query_timeout: 5m            # æŸ¥è¯¢è¶…æ—¶æ—¶é—´
  max_concurrent: 20           # æœ€å¤§å¹¶å‘æŸ¥è¯¢æ•°
  engine:
    timeout: 5m
    max_look_back_period: 0s    # æœ€å¤§å›çœ‹æ—¶é—´
    enable_per_step_stats: false
  query_ingester_within: 12h   # æŸ¥è¯¢å†…å­˜ä¸­çš„æ—¥å¿—
```

#### é•¿æœŸå­˜å‚¨æŸ¥è¯¢

```yaml
querier:
  query_timeout: 30m           # æ›´é•¿çš„è¶…æ—¶æ—¶é—´
  max_concurrent: 10           # é™åˆ¶å¹¶å‘æ•°
  engine:
    max_look_back_period: 30d   # æŸ¥è¯¢30å¤©å†…çš„æ•°æ®
    max_samples_per_query: 50000000
  query_ingester_within: 2h    # åªæŸ¥è¯¢2å°æ—¶å†…çš„å†…å­˜æ—¥å¿—
```

### æŸ¥è¯¢ç¼“å­˜

#### ç»“æœç¼“å­˜

```yaml
frontend:
  cache:
    enable_fifocache: true
    fifocache:
      max_size_items: 1000
      ttl: 24h
      validity: 10s
```

#### æ‹†åˆ†ç¼“å­˜

```yaml
frontend:
  cache:
    enable_fifocache: true
    fifocache:
      max_size_items: 10000   # å¢åŠ ç¼“å­˜å¤§å°
      ttl: 48h               # æ›´é•¿çš„ç¼“å­˜æ—¶é—´
      validity: 30s           # æ›´é•¿çš„æœ‰æ•ˆæœŸ
```

## ğŸš€ Query Frontendï¼ˆæŸ¥è¯¢å‰ç«¯ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Query Frontendæ˜¯Lokiçš„æŸ¥è¯¢ä¼˜åŒ–ç»„ä»¶ï¼Œæä¾›ï¼š

1. æŸ¥è¯¢è¯·æ±‚ç¼“å­˜
2. æŸ¥è¯¢æ‹†åˆ†å’Œå¹¶è¡Œæ‰§è¡Œ
3. ç»“æœèšåˆ
4. è¯·æ±‚é˜Ÿåˆ—ç®¡ç†

### æŸ¥è¯¢æ‹†åˆ†æœºåˆ¶

#### æ—¶é—´èŒƒå›´æ‹†åˆ†

```
åŸå§‹æŸ¥è¯¢: {job="nginx"} [1h]
æ‹†åˆ†å: {job="nginx"} [15m] Ã— 4
```

#### å¹¶è¡Œæ‰§è¡Œ

```
Query Frontend
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ Q1   â”‚ Q2   â”‚ Q3   â”‚ Q4   â”‚  â†’ å¹¶è¡Œæ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
    â†“
  ç»“æœèšåˆ
```

### é…ç½®ä¼˜åŒ–

#### é«˜å¹¶å‘åœºæ™¯

```yaml
frontend:
  compress_responses: true    # å‹ç¼©å“åº”
  log_queries_longer_than: 10s # è®°å½•é•¿æŸ¥è¯¢
  max_outstanding_per_tenant: 2048  # æ¯ç§Ÿæˆ·æœ€å¤§å¹¶å‘æŸ¥è¯¢æ•°
  querier_forget_client_timeout: 0
  querier_forget_client_threshold: -1
  query_stats_enabled: true
```

#### å¤§è§„æ¨¡éƒ¨ç½²

```yaml
frontend:
  max_outstanding_per_tenant: 4096  # å¢åŠ å¹¶å‘æ•°
  scheduler_address: dns+scheduler:9090  # å¤–éƒ¨è°ƒåº¦å™¨
  scheduler_worker_address: dns+frontend:9096
```

## ğŸ“Š Rulerï¼ˆå‘Šè­¦è§„åˆ™ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Ruleræ˜¯Lokiçš„å‘Šè­¦è¯„ä¼°ç»„ä»¶ï¼Œè´Ÿè´£ï¼š

1. è¯„ä¼°å‘Šè­¦è§„åˆ™
2. è§¦å‘å‘Šè­¦
3. å‘é€é€šçŸ¥
4. ç®¡ç†è§„åˆ™ç”Ÿå‘½å‘¨æœŸ

### å‘Šè­¦è§„åˆ™é…ç½®

#### åŸºæœ¬è§„åˆ™

```yaml
groups:
  - name: example
    rules:
      - alert: HighErrorRate
        expr: |
          sum(rate({job="app"} |= "error" [5m]))
          /
          sum(rate({job="app"} [5m])) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: High error rate detected
```

#### é«˜çº§è§„åˆ™

```yaml
groups:
  - name: advanced
    rules:
      - alert: LogPatternDetected
        expr: |
          sum(count_over_time({job="api"} |~ "database.*error" [5m]))
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Database error pattern detected in API logs"
          description: "Multiple database errors detected in API logs"
          runbook_url: "https://runbooks.example.com/database-errors"
```

### é…ç½®ä¼˜åŒ–

```yaml
ruler:
  enable_alertmanager_discovery: true
  alertmanager_url: http://alertmanager:9093/api/v1/alerts
  enable_api: true
  evaluation_interval: 1m          # è¯„ä¼°é—´éš”
  poll_interval: 1m                # è½®è¯¢é—´éš”
  notification_timeout: 10s        # é€šçŸ¥è¶…æ—¶
  remote_write:
    enabled: true
    client:
      url: http://cortex:9009/api/v1/push
```

## ğŸ—œï¸ Compactorï¼ˆå‹ç¼©å™¨ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Compactoræ˜¯Lokiçš„å­˜å‚¨ä¼˜åŒ–ç»„ä»¶ï¼Œè´Ÿè´£ï¼š

1. åˆå¹¶å°æ—¥å¿—å—
2. å‹ç¼©å’Œä¼˜åŒ–å­˜å‚¨
3. æ¸…ç†è¿‡æœŸæ•°æ®
4. æ›´æ–°ç´¢å¼•

### å‹ç¼©ç­–ç•¥

#### å—åˆå¹¶ç­–ç•¥

```
æºå—1 (100KB, 6h) â”€â”€â”
æºå—2 (150KB, 6h) â”€â”€â”¼â”€â”€â–º åˆå¹¶å— (250KB, 12h)
æºå—3 (200KB, 6h) â”€â”€â”˜
```

#### å‹ç¼©çº§åˆ«

```yaml
compactor:
  compaction_interval: 1h        # å‹ç¼©é—´éš”
  retention_enabled: true        # å¯ç”¨ä¿ç•™ç­–ç•¥
  retention_delete_delay: 2h    # åˆ é™¤å»¶è¿Ÿ
  delete_request_cancel_period: 24h  # å–æ¶ˆåˆ é™¤å‘¨æœŸ
  retention_delete_worker_count: 150  # åˆ é™¤å·¥ä½œçº¿ç¨‹æ•°
```

### é…ç½®ä¼˜åŒ–

#### é«˜æ€§èƒ½å‹ç¼©

```yaml
compactor:
  working_directory: /var/loki/compactor
  shared_store: s3
  compaction_interval: 30m       # æ›´é¢‘ç¹çš„å‹ç¼©
  retention_enabled: true
  max_compaction_parallelism: 8   # å¹¶è¡Œå‹ç¼©æ•°
  sandbag_memory_limit: 4GB       # å†…å­˜é™åˆ¶
```

## ğŸŒ Gatewayï¼ˆç½‘å…³ï¼‰è¯¦è§£

### æ ¸å¿ƒåŠŸèƒ½

Gatewayæ˜¯Lokiçš„ç»Ÿä¸€å…¥å£ï¼Œæä¾›ï¼š

1. ç»Ÿä¸€APIæ¥å£
2. è¯·æ±‚è·¯ç”±
3. åŸºç¡€è®¤è¯
4. é™æµæ§åˆ¶

### é…ç½®ç¤ºä¾‹

```yaml
# NGINXé…ç½®ç¤ºä¾‹
upstream loki {
  least_conn;
  server distributor:3100;
  server query-frontend:3100;
}

server {
  listen 80;
  server_name loki.example.com;

  location / {
    proxy_pass http://loki;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }
}
```

## ğŸ§ª å®éªŒï¼šç»„ä»¶æ€§èƒ½ä¼˜åŒ–

è®©æˆ‘ä»¬é€šè¿‡å®éªŒæ¥ä¼˜åŒ–Lokiç»„ä»¶æ€§èƒ½ï¼š

1. éƒ¨ç½²åŸºå‡†Lokié›†ç¾¤
2. ç”Ÿæˆæµ‹è¯•è´Ÿè½½
3. è°ƒæ•´ç»„ä»¶é…ç½®
4. æ€§èƒ½æµ‹è¯•å’Œå¯¹æ¯”

**å®éªŒä»£ç å’Œé…ç½®ï¼š**

è§[code/experiments/component-optimization.sh](../code/chapter2/component-optimization.sh)

### å®éªŒæ­¥éª¤

1. **éƒ¨ç½²åŸºå‡†é›†ç¾¤**:

```bash
# éƒ¨ç½²åŸºå‡†é…ç½®
docker-compose -f loki-baseline.yml up -d
```

2. **ç”Ÿæˆæµ‹è¯•è´Ÿè½½**:

```bash
# ç”Ÿæˆæµ‹è¯•æ—¥å¿—
./scripts/generate-load.sh
```

3. **è°ƒæ•´é…ç½®**:

```bash
# åº”ç”¨ä¼˜åŒ–é…ç½®
docker-compose -f loki-optimized.yml up -d
```

4. **æ€§èƒ½æµ‹è¯•**:

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
./scripts/performance-test.sh
```

## ğŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†ï¼š

- å„æ ¸å¿ƒç»„ä»¶çš„å®ç°ç»†èŠ‚å’Œå·¥ä½œåŸç†
- ä¸åŒåœºæ™¯ä¸‹çš„é…ç½®ä¼˜åŒ–æ–¹æ³•
- ç»„ä»¶é—´çš„äº¤äº’å’Œåä½œæœºåˆ¶
- æ•…éšœæ’é™¤å’Œæ€§èƒ½è°ƒä¼˜æŠ€å·§

ç†è§£å„ç»„ä»¶çš„ç»†èŠ‚æœ‰åŠ©äºæ­£ç¡®é…ç½®å’Œä¼˜åŒ–Lokié›†ç¾¤ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§å’Œæ€§èƒ½ã€‚åœ¨ä¸‹ä¸€ç« [2.3 æ•°æ®æ¨¡å‹](./2.3-data-model.md)ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£Lokiçš„æ•°æ®æ¨¡å‹å’Œå­˜å‚¨æœºåˆ¶ã€‚

## ğŸ¤” æ€è€ƒé¢˜

1. åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚ä½•å¹³è¡¡Ingesterçš„åˆ·æ–°é¢‘ç‡å’Œæ€§èƒ½ï¼Ÿ
2. Query Frontendå¦‚ä½•é€šè¿‡æŸ¥è¯¢æ‹†åˆ†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Ÿ
3. ä¸ºä»€ä¹ˆCompactoréœ€è¦åˆå¹¶å°æ—¥å¿—å—ï¼Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Lokiç»„ä»¶é…ç½®æ–‡æ¡£](https://grafana.com/docs/loki/latest/configure/)
- [Lokiæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://grafana.com/docs/loki/latest/operations/configuration/)
- [Lokiæ•…éšœæ’é™¤](https://grafana.com/docs/loki/latest/operations/troubleshooting/)