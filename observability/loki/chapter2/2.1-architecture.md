# 2.1 Loki架构概述

## 🎯 学习目标

在本章中，我们将学习：

- 理解Loki的整体架构
- 掌握Loki的核心组件及其职责
- 了解Loki的数据流和存储模型
- 理解Loki的查询处理流程
- 认识Loki的扩展性和高可用性设计

## 🏗️ Loki整体架构

### 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Grafana    │  │   Promtail   │  │   应用程序    │         │
│  │ (查询与可视化) │  │  (日志收集)   │ │ (直接推送)    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────┬──────────────────────────────────────────┘
                      │ HTTP/gRPC
                      ▼
┌──────────────────────────────────────────────────────────────┐
│                        Loki层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Gateway    │  │  Distributor │  │  Querier     │         │
│  │   (请求路由)  │  │ (日志分发器)  │ │  (查询器)     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Query Frontend│  │   Ingester   │  │    Ruler     │         │
│  │  (查询前端)   │  │  (接收器)     │ │ (告警规则)    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐                                                │
│  │  Compactor   │                                                │
│  │ (压缩器)     │                                                │
│  └──────────────┘                                                │
└─────────────────────┬──────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│                      存储层                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Object Store │  │   DynamoDB   │  │   Consul     │         │
│  │ (日志存储)    │  │  (索引存储)   │ │  (配置存储)   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└──────────────────────────────────────────────────────────────┘
```

### 架构特点

1. **微服务架构**: Loki采用微服务架构，各组件可以独立扩展
2. **水平扩展**: 所有组件都支持水平扩展，可处理大规模数据
3. **存储分离**: 日志存储和索引存储分离，可使用不同的存储后端
4. **无状态设计**: 多数组件无状态，便于部署和扩展
5. **可插拔存储**: 支持多种存储后端，适应不同环境

## 🔧 核心组件详解

### 1. Ingester（接收器）

#### 职责
- 接收来自客户端的日志流
- 构建日志块并压缩
- 将日志写入存储后端
- 响应查询请求

#### 工作流程
```
日志流 → 标签验证 → 日志分块 → 压缩 → 存储到对象存储
```

#### 配置示例
```yaml
ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: consul
      replication_factor: 3
  chunk_idle_period: 1h       # 块空闲时间
  max_chunk_age: 2h           # 块最大年龄
  chunk_target_size: 1048576   # 目标块大小
  chunk_retain_period: 30s    # 块保留时间
```

#### 关键参数
- **replication_factor**: 日志副本数，提高可靠性
- **chunk_idle_period**: 日志块空闲时间，超过此时间块会被刷新
- **max_chunk_age**: 日志块最大年龄，无论是否空闲都会刷新
- **chunk_target_size**: 目标块大小，影响压缩效率

### 2. Distributor（分发器）

#### 职责
- 接收来自Promtail的日志
- 验证日志格式和标签
- 根据一致性哈希将日志分发给合适的Ingester
- 处理租户隔离

#### 工作流程
```
Promtail → Distributor → 标签验证 → 哈希计算 → 路由到Ingester
```

#### 配置示例
```yaml
distributor:
  ring:
    kvstore:
      store: consul
  ha_tracker:
    enable_ha_tracker: true
    update_timeout: 2s
    num_workers: 50
```

### 3. Querier（查询器）

#### 职责
- 接收来自Grafana的查询请求
- 从存储中获取日志数据
- 解析和执行LogQL查询
- 返回查询结果

#### 工作流程
```
Grafana → Querier → 查询解析 → 索引查询 → 数据获取 → 结果聚合 → 返回结果
```

#### 配置示例
```yaml
querier:
  query_timeout: 5m
  max_concurrent: 10
  engine:
    timeout: 5m
    max_look_back_period: 0s
```

### 4. Query Frontend（查询前端）

#### 职责
- 接收查询请求并缓存
- 分裂查询为多个子查询
- 分发子查询到Querier
- 聚合并缓存结果

#### 优势
- 查询并发执行，提高性能
- 结果缓存，减少重复查询
- 请求队列，防止系统过载

#### 配置示例
```yaml
frontend:
  compress_responses: true
  log_queries_longer_than: 10s
  max_outstanding_per_tenant: 2048
  querier_forget_client_timeout: 0
  querier_forget_client_threshold: -1
```

### 5. Ruler（告警规则）

#### 职责
- 评估告警规则
- 触发告警
- 发送通知到Alertmanager

#### 配置示例
```yaml
ruler:
  enable_alertmanager_discovery: true
  alertmanager_url: http://alertmanager:9093/api/v1/alerts
  enable_api: true
  evaluation_interval: 1m
  poll_interval: 1m
  notification_timeout: 10s
```

### 6. Compactor（压缩器）

#### 职责
- 压缩和合并旧日志块
- 清理过期数据
- 优化存储空间

#### 工作流程
```
旧日志块 → 读取 → 合并 → 压缩 → 新日志块 → 清理旧块
```

#### 配置示例
```yaml
compactor:
  working_directory: /var/loki/compactor
  shared_store: s3
  retention_enabled: true
  delete_request_cancel_period: 24h
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
  delete_cancel_on_shutdown: false
```

### 7. Gateway（网关）

#### 职责
- 提供统一的API入口
- 请求路由和负载均衡
- 基本身份验证和授权

#### 优势
- 简化客户端配置
- 提供统一接口
- 基础安全控制

## 📊 数据流模型

### 日志流处理流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   应用      │    │   Promtail  │    │ Distributor │
│  (生成日志)   │───▶│ (收集日志)   │───▶│  (验证分发)   │
└─────────────┘    └─────────────┘    └─────────────┘
                                                │
                                                ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   对象存储   │◀───│  Ingester   │◀───│   哈希环     │
│  (存储日志)   │    │  (接收处理)   │    │  (路由选择)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 查询处理流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Grafana   │───▶│Query Frontend│───▶│   Querier   │
│ (查询界面)   │    │ (查询缓存)    │    │ (执行查询)    │
└─────────────┘    └─────────────┘    └─────────────┘
                                    │
                                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Grafana   │◀───│Query Frontend│◀───│   对象存储   │
│ (显示结果)   │    │ (结果聚合)    │    │  (数据存储)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 🧩 存储模型

### 三层存储架构

1. **长期存储**: 对象存储（如S3、GCS、Azure Blob）
   - 存储压缩的日志块
   - 数据持久性和可靠性
   - 成本效益高

2. **索引存储**: 键值存储（如DynamoDB、Cassandra）
   - 存储标签索引
   - 快速查询定位
   - 支持复杂查询

3. **配置存储**: 键值存储（如Consul、etcd）
   - 存储系统配置和状态
   - 服务发现和配置管理
   - 高可用性保障

### 数据组织结构

```
对象存储结构:
├── fake/
│   ├── <tenant-id>/
│   │   ├── index/
│   │   │   └── <period>/tables/
│   │   │       ├── <table-name>/<hash>
│   │   └── chunks/
│   │       └── <table-name>/<period>/<hash>
```

## 🔄 一致性哈希与Ring

### Ring概念

Loki使用一致性哈希环来实现分布式数据分布：

```
哈希环: 0 --- 1 --- 2 --- 3 --- ... --- n --- 0
          │     │     │           │
       Ing1  Ing2  Ing3       Ingn
```

### 工作原理

1. **节点注册**: Ingester启动时注册到Ring
2. **计算哈希**: 基于标签集计算哈希值
3. **查找节点**: 根据哈希值在Ring上找到节点
4. **数据分发**: 将日志发送到对应的Ingester

### 优势

- **负载均衡**: 数据均匀分布到各节点
- **自动扩展**: 节点加入或离开时自动重平衡
- **容错性**: 节点故障时自动转移到其他节点

## 🏢 多租户架构

### 租户隔离

Loki原生支持多租户，每个租户的数据完全隔离：

```
租户A → 独立索引 → 独立存储空间 → 独立查询
租户B → 独立索引 → 独立存储空间 → 独立查询
```

### 租户标识

- **HTTP Header**: `X-Scope-OrgID`
- **租户ID**: 唯一标识租户的字符串
- **数据隔离**: 不同租户的数据物理隔离

### 多租户配置

```yaml
auth_enabled: true  # 启用多租户
auth:
  enabled: true
  type: jwt  # 或其他认证类型
```

## 📈 扩展性设计

### 水平扩展

所有组件都支持水平扩展：

- **Ingester**: 添加更多Ingester提高接收能力
- **Querier**: 添加更多Querier提高查询能力
- **Query Frontend**: 添加更多前端提高并发处理能力

### 弹性扩展

- **自动伸缩**: 基于负载自动调整组件数量
- **动态配置**: 支持运行时配置更改
- **资源隔离**: 不同组件可以使用不同的资源配额

## 🛡️ 高可用性设计

### 数据可靠性

- **副本机制**: 日志多副本存储
- **持久化存储**: 使用可靠的存储后端
- **故障恢复**: 自动故障检测和恢复

### 服务可用性

- **无状态设计**: 多数组件无状态，易于替换
- **负载均衡**: 请求自动分发到健康节点
- **健康检查**: 定期检查组件健康状态

### 示例配置

```yaml
# 高可用性配置示例
ingester:
  lifecycler:
    ring:
      replication_factor: 3  # 3个副本

querier:
  max_concurrent: 20  # 高并发查询

# 多副本部署
replicaCount: 3
```

## 🧪 实验：搭建完整的Loki集群

让我们通过实验搭建一个完整的Loki集群，了解各组件的交互：

1. 部署Loki集群
2. 配置各组件
3. 验证数据流
4. 测试高可用性

**实验代码和配置：**

见[code/experiments/loki-cluster.yaml](../code/chapter2/loki-cluster.yaml)

## 📝 本章小结

在本章中，我们学习了：

- Loki的整体架构和设计理念
- 各核心组件的职责和配置
- 数据流模型和存储架构
- 一致性哈希和Ring机制
- 多租户架构设计
- 扩展性和高可用性设计

理解Loki的架构有助于正确部署和维护Loki集群，以及进行性能优化和故障排除。在下一章[2.2 核心组件详解](./2.2-components.md)中，我们将深入探讨各组件的实现细节和配置优化。

## 🤔 思考题

1. 为什么Loki选择微服务架构而不是单体架构？
2. 在什么情况下需要调整Ingester的replication_factor？
3. Query Frontend如何提高查询性能？

## 📚 延伸阅读

- [Loki架构官方文档](https://grafana.com/docs/loki/latest/fundamentals/architecture/)
- [Loki组件详解](https://grafana.com/docs/loki/latest/fundamentals/components/)
- [一致性哈希算法](https://en.wikipedia.org/wiki/Consistent_hashing)