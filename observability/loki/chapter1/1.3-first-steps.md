# 1.3 ç¬¬ä¸€æ¬¡ä½¿ç”¨Loki

## ğŸ¯ å­¦ä¹ ç›®æ ‡

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- ç†è§£Lokiçš„åŸºæœ¬å·¥ä½œæµç¨‹
- é…ç½®Promtailæ”¶é›†æ—¥å¿—
- åœ¨Grafanaä¸­æŸ¥è¯¢æ—¥å¿—
- ç†è§£æ ‡ç­¾å’Œæ—¥å¿—æµçš„æ¦‚å¿µ
- è¿›è¡ŒåŸºæœ¬çš„æ—¥å¿—è¿‡æ»¤å’Œåˆ†æ

## ğŸ”„ Lokiå·¥ä½œæµç¨‹

### åŸºæœ¬æµç¨‹å›¾

```
åº”ç”¨ç¨‹åº/ç³»ç»Ÿ â†’ æ—¥å¿—æ–‡ä»¶ â†’ Promtail â†’ æ ‡ç­¾æå– â†’ Lokiå­˜å‚¨
                                                      â†“
                                              GrafanaæŸ¥è¯¢ â† LogQLæŸ¥è¯¢
```

### è¯¦ç»†æ­¥éª¤

1. **æ—¥å¿—ç”Ÿæˆ**: åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿç”Ÿæˆæ—¥å¿—
2. **æ—¥å¿—æ”¶é›†**: Promtailè¯»å–æ—¥å¿—æ–‡ä»¶
3. **æ ‡ç­¾æå–**: Promtailæå–æ ‡ç­¾å¹¶æ·»åŠ åˆ°æ—¥å¿—
4. **æ—¥å¿—å‘é€**: Promtailå°†æ—¥å¿—å‘é€åˆ°Loki
5. **æ—¥å¿—å­˜å‚¨**: Lokiæ ¹æ®æ ‡ç­¾å­˜å‚¨æ—¥å¿—
6. **æ—¥å¿—æŸ¥è¯¢**: é€šè¿‡LogQLæŸ¥è¯¢æ—¥å¿—
7. **æ—¥å¿—æ˜¾ç¤º**: åœ¨Grafanaä¸­å±•ç¤ºæŸ¥è¯¢ç»“æœ

## ğŸ“ åˆ›å»ºç¤ºä¾‹æ—¥å¿—æ–‡ä»¶

è®©æˆ‘ä»¬åˆ›å»ºä¸€äº›ç¤ºä¾‹æ—¥å¿—æ–‡ä»¶ï¼Œç”¨äºæ¼”ç¤ºLokiçš„åŠŸèƒ½ï¼š

### Linux/macOS

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /tmp/loki-example

# åˆ›å»ºåº”ç”¨ç¨‹åºæ—¥å¿—
cat > /tmp/loki-example/app.log << EOF
2023-10-01T10:00:00.000Z [INFO] Application started
2023-10-01T10:01:00.000Z [INFO] User login: user123
2023-10-01T10:02:00.000Z [WARN] Slow query detected: SELECT * FROM users
2023-10-01T10:03:00.000Z [INFO] User logout: user123
2023-10-01T10:04:00.000Z [ERROR] Database connection failed
2023-10-01T10:05:00.000Z [INFO] Application restarted
EOF

# åˆ›å»ºWebæœåŠ¡å™¨æ—¥å¿—
cat > /tmp/loki-example/web.log << EOF
192.168.1.100 - - [01/Oct/2023:10:00:00 +0000] "GET / HTTP/1.1" 200 1234
192.168.1.101 - - [01/Oct/2023:10:01:00 +0000] "GET /api/users HTTP/1.1" 200 567
192.168.1.102 - - [01/Oct/2023:10:02:00 +0000] "POST /api/login HTTP/1.1" 401 89
192.168.1.100 - - [01/Oct/2023:10:03:00 +0000] "GET /dashboard HTTP/1.1" 200 2345
192.168.1.103 - - [01/Oct/2023:10:04:00 +0000] "DELETE /api/users/123 HTTP/1.1" 200 12
EOF
```

### Windows

```powershell
# åˆ›å»ºæ—¥å¿—ç›®å½•
New-Item -ItemType Directory -Force -Path "C:\temp\loki-example"

# åˆ›å»ºåº”ç”¨ç¨‹åºæ—¥å¿—
@"
2023-10-01T10:00:00.000Z [INFO] Application started
2023-10-01T10:01:00.000Z [INFO] User login: user123
2023-10-01T10:02:00.000Z [WARN] Slow query detected: SELECT * FROM users
2023-10-01T10:03:00.000Z [INFO] User logout: user123
2023-10-01T10:04:00.000Z [ERROR] Database connection failed
2023-10-01T10:05:00.000Z [INFO] Application restarted
"@ | Out-File -FilePath "C:\temp\loki-example\app.log" -Encoding UTF8

# åˆ›å»ºWebæœåŠ¡å™¨æ—¥å¿—
@"
192.168.1.100 - - [01/Oct/2023:10:00:00 +0000] ""GET / HTTP/1.1"" 200 1234
192.168.1.101 - - [01/Oct/2023:10:01:00 +0000] ""GET /api/users HTTP/1.1"" 200 567
192.168.1.102 - - [01/Oct/2023:10:02:00 +0000] ""POST /api/login HTTP/1.1"" 401 89
192.168.1.100 - - [01/Oct/2023:10:03:00 +0000] ""GET /dashboard HTTP/1.1"" 200 2345
192.168.1.103 - - [01/Oct/2023:10:04:00 +0000] ""DELETE /api/users/123 HTTP/1.1"" 200 12
"@ | Out-File -FilePath "C:\temp\loki-example\web.log" -Encoding UTF8
```

## âš™ï¸ é…ç½®Promtailæ”¶é›†æ—¥å¿—

### åŸºæœ¬Promtailé…ç½®

åˆ›å»ºæˆ–ä¿®æ”¹Promtailé…ç½®æ–‡ä»¶`promtail-config.yaml`ï¼š

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  # æ”¶é›†åº”ç”¨ç¨‹åºæ—¥å¿—
  - job_name: application-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: application
          __path__: /tmp/loki-example/app.log

  # æ”¶é›†WebæœåŠ¡å™¨æ—¥å¿—
  - job_name: web-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: webserver
          __path__: /tmp/loki-example/web.log
```

Windowsç”¨æˆ·çš„é…ç½®ï¼š

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: C:\temp\positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  # æ”¶é›†åº”ç”¨ç¨‹åºæ—¥å¿—
  - job_name: application-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: application
          __path__: C:\temp\loki-example\app.log

  # æ”¶é›†WebæœåŠ¡å™¨æ—¥å¿—
  - job_name: web-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: webserver
          __path__: C:\temp\loki-example\web.log
```

### é«˜çº§Promtailé…ç½®ï¼ˆæ·»åŠ è§£æå™¨ï¼‰

è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›è§£æå™¨ï¼Œä»æ—¥å¿—å†…å®¹ä¸­æå–æ›´å¤šä¿¡æ¯ï¼š

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
  # æ”¶é›†åº”ç”¨ç¨‹åºæ—¥å¿—ï¼ˆå¸¦è§£æï¼‰
  - job_name: application-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: application
          __path__: /tmp/loki-example/app.log

    pipeline_stages:
      - regex:
          expression: '(?P<time>\S+) \[(?P<level>\w+)\] (?P<message>.*)'
      - timestamp:
          format: RFC3339Nano
          source: time
      - labels:
          level:
          - output:
              source: message

  # æ”¶é›†WebæœåŠ¡å™¨æ—¥å¿—ï¼ˆå¸¦è§£æï¼‰
  - job_name: web-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: webserver
          __path__: /tmp/loki-example/web.log

    pipeline_stages:
      - regex:
          expression: '(?P<client_ip>\S+) - - \[(?P<timestamp>.+)\] "(?P<method>\S+) (?P<path>\S+) (?P<protocol>\S+)" (?P<status>\d+) (?P<size>\d+)'
      - labels:
          method:
          status:
      - output:
          source: message
```

### å¯åŠ¨Promtail

```bash
# Dockeræ–¹å¼
docker restart promtail

# äºŒè¿›åˆ¶æ–¹å¼
promtail-linux-amd64 -config.file=promtail-config.yaml
```

## ğŸ” éªŒè¯æ—¥å¿—æ”¶é›†

### æ£€æŸ¥Promtailç›®æ ‡çŠ¶æ€

```bash
curl http://localhost:9080/targets
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼äºä»¥ä¸‹çš„è¾“å‡ºï¼š

```json
[
  {
    "labels": "{__path__=\"/tmp/loki-example/app.log\",job=\"application\"}",
    "discoveredLabels": "{__address__=\"localhost:9080\",__path__=\"/tmp/loki-example/app.log\",job=\"application\"}",
    "activeTargets": [
      {
        "labels": "{__path__=\"/tmp/loki-example/app.log\",job=\"application\"}",
        "discoveredLabels": "{__address__=\"localhost:9080\",__path__=\"/tmp/loki-example/app.log\",job=\"application\"}"
      }
    ]
  },
  {
    "labels": "{__path__=\"/tmp/loki-example/web.log\",job=\"webserver\"}",
    "discoveredLabels": "{__address__=\"localhost:9080\",__path__=\"/tmp/loki-example/web.log\",job=\"webserver\"}",
    "activeTargets": [
      {
        "labels": "{__path__=\"/tmp/loki-example/web.log\",job=\"webserver\"}",
        "discoveredLabels": "{__address__=\"localhost:9080\",__path__=\"/tmp/loki-example/web.log\",job=\"webserver\"}"
      }
    ]
  }
]
```

### æ£€æŸ¥Loki APIçŠ¶æ€

```bash
# æ£€æŸ¥Lokiæ˜¯å¦æ¥æ”¶åˆ°æ—¥å¿—
curl -G -s "http://localhost:3100/loki/api/v1/label" --data-urlencode 'start=' --data-urlencode 'end=' --data-urlencode 'match[]={job=~".+"}'
```

## ğŸ“Š åœ¨Grafanaä¸­æŸ¥è¯¢æ—¥å¿—

### æ·»åŠ Lokiæ•°æ®æº

å¦‚æœæ‚¨è¿˜æ²¡æœ‰æ·»åŠ Lokiæ•°æ®æºåˆ°Grafanaï¼š

1. è®¿é—®Grafanaï¼ˆhttp://localhost:3000ï¼‰
2. ç™»å½•ï¼ˆé»˜è®¤ç”¨æˆ·å/å¯†ç : admin/adminï¼‰
3. ç‚¹å‡»"Configuration" > "Data Sources"
4. ç‚¹å‡»"Add data source"
5. é€‰æ‹©"Loki"
6. è®¾ç½®URLä¸º`http://localhost:3100`
7. ç‚¹å‡»"Save & Test"

### åŸºæœ¬æŸ¥è¯¢

1. **æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—**:

```
{job=~".+"}
```

2. **æŸ¥è¯¢ç‰¹å®šä½œä¸šçš„æ—¥å¿—**:

```
{job="application"}
```

æˆ–

```
{job="webserver"}
```

3. **æŸ¥è¯¢ç‰¹å®šæ—¥å¿—çº§åˆ«çš„æ—¥å¿—**:

```
{job="application"} |= "ERROR"
```

4. **æŸ¥è¯¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ—¥å¿—**:

```
{job=~".+"} |= "user"
```

### é«˜çº§æŸ¥è¯¢

1. **æŸ¥è¯¢é”™è¯¯æ—¥å¿—ï¼ˆä½¿ç”¨è§£æåçš„æ ‡ç­¾ï¼‰**:

```
{job="application", level="ERROR"}
```

2. **æŸ¥è¯¢ç‰¹å®šHTTPçŠ¶æ€ç çš„æ—¥å¿—**:

```
{job="webserver", status="401"}
```

3. **è®¡ç®—é”™è¯¯ç‡**:

```
sum(count_over_time({job="application"} | level="ERROR" [5m])) by (job)
```

4. **æŸ¥è¯¢ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—**:

```
{job="application"} |= "database" >= 2023-10-01T10:04:00Z <= 2023-10-01T10:05:00Z
```

## ğŸ§ª å®éªŒï¼šå®Œæ•´çš„æ—¥å¿—æ”¶é›†å’ŒæŸ¥è¯¢

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å®éªŒæ¥æ¼”ç¤ºLokiçš„æ—¥å¿—æ”¶é›†å’ŒæŸ¥è¯¢åŠŸèƒ½ï¼š

1. å¯åŠ¨Lokiå’ŒPromtail
2. åˆ›å»ºç¤ºä¾‹æ—¥å¿—æ–‡ä»¶
3. é…ç½®Promtailæ”¶é›†æ—¥å¿—
4. åœ¨Grafanaä¸­æŸ¥è¯¢æ—¥å¿—
5. åˆ†ææ—¥å¿—æ¨¡å¼

**å®éªŒä»£ç å’Œé…ç½®ï¼š**

è§[code/experiments/complete-example.sh](../code/chapter1/complete-example.sh)æˆ–[code/experiments/complete-example.ps1](../code/chapter1/complete-example.ps1)

### å®éªŒæ­¥éª¤

1. **å¯åŠ¨æœåŠ¡**:

```bash
# ä½¿ç”¨Docker Composeå¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

2. **ç”Ÿæˆå®æ—¶æ—¥å¿—**:

```bash
# å¯åŠ¨æ—¥å¿—ç”Ÿæˆè„šæœ¬
./scripts/generate-logs.sh
```

3. **åœ¨Grafanaä¸­æ¢ç´¢**:

- è®¿é—®http://localhost:3000
- è¿›å…¥"Explore"æ¨¡å¼
- é€‰æ‹©Lokiæ•°æ®æº
- å°è¯•ä¸åŒçš„æŸ¥è¯¢

## ğŸ“ˆ æ—¥å¿—å¯è§†åŒ–

### åˆ›å»ºæ—¥å¿—ä»ªè¡¨ç›˜

1. åˆ›å»ºæ–°ä»ªè¡¨ç›˜
2. æ·»åŠ æ—¥å¿—ç»Ÿè®¡é¢æ¿
3. æ·»åŠ æ—¥å¿—çº§åˆ«åˆ†å¸ƒ
4. æ·»åŠ é”™è¯¯è¶‹åŠ¿å›¾

### ç¤ºä¾‹æŸ¥è¯¢

1. **æ—¥å¿—çº§åˆ«åˆ†å¸ƒ**:

```
sum by (level) (count_over_time({job="application"} [5m]))
```

2. **é”™è¯¯ç‡è¶‹åŠ¿**:

```
sum(count_over_time({job="application"} | level="ERROR" [5m]))
/ sum(count_over_time({job="application"} [5m])) * 100
```

3. **çƒ­é—¨HTTPç«¯ç‚¹**:

```
topk(10, sum by (path) (count_over_time({job="webserver"} [5m])))
```

## ğŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

- Lokiçš„åŸºæœ¬å·¥ä½œæµç¨‹
- å¦‚ä½•é…ç½®Promtailæ”¶é›†æ—¥å¿—
- å¦‚ä½•åœ¨Grafanaä¸­æŸ¥è¯¢æ—¥å¿—
- æ ‡ç­¾å’Œæ—¥å¿—æµçš„æ¦‚å¿µ
- åŸºæœ¬çš„æ—¥å¿—è¿‡æ»¤å’Œåˆ†ææ–¹æ³•
- åˆ›å»ºç®€å•çš„æ—¥å¿—å¯è§†åŒ–

ç°åœ¨æ‚¨å·²ç»æŒæ¡äº†Lokiçš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥æ”¶é›†ã€å­˜å‚¨å’ŒæŸ¥è¯¢æ—¥å¿—ã€‚åœ¨ä¸‹ä¸€ç« [2.1 Lokiæ¶æ„](../chapter2/2.1-architecture.md)ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£Lokiçš„æ¶æ„å’Œæ ¸å¿ƒç»„ä»¶ã€‚

## ğŸ¤” æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆPromtailéœ€è¦æå–æ ‡ç­¾è€Œä¸æ˜¯ç›´æ¥å‘é€åŸå§‹æ—¥å¿—ï¼Ÿ
2. Lokiåªç´¢å¼•æ ‡ç­¾è€Œä¸ç´¢å¼•å†…å®¹çš„è®¾è®¡å¯¹æŸ¥è¯¢æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
3. åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½ ä¼šé€‰æ‹©ç®€å•çš„æ—¥å¿—æ”¶é›†è€Œä¸æ˜¯å¸¦è§£æçš„æ—¥å¿—æ”¶é›†ï¼Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [LokiæŸ¥è¯¢è¯­è¨€LogQL](https://grafana.com/docs/loki/latest/logql/)
- [Promtailé…ç½®æ–‡æ¡£](https://grafana.com/docs/loki/latest/clients/promtail/configuration/)
- [Grafanaæ—¥å¿—å¯è§†åŒ–](https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/logs/)