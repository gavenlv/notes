# 1.2 Lokiå®‰è£…ä¸é…ç½®

## ğŸ“‹ å‰ç½®è¦æ±‚

åœ¨å¼€å§‹å®‰è£…Lokiä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- **æ“ä½œç³»ç»Ÿ**: Windows 10+, macOS 10.14+, æˆ–Linux (Ubuntu 18.04+, CentOS 7+, RHEL 7+)
- **å†…å­˜**: æœ€å°‘4GBï¼Œæ¨è8GB+
- **ç£ç›˜ç©ºé—´**: æœ€å°‘20GBï¼Œæ¨è50GB+
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥ï¼ˆç”¨äºä¸‹è½½å’Œè®¿é—®å­˜å‚¨ï¼‰
- **æƒé™**: ç®¡ç†å‘˜æˆ–sudoæƒé™ï¼ˆç”¨äºå®‰è£…ï¼‰
- **Docker**: æ¨èDocker 20.10+ï¼ˆæœ€ç®€å•çš„å®‰è£…æ–¹å¼ï¼‰
- **Go 1.19+**: å¦‚æœé€‰æ‹©ä»æºç ç¼–è¯‘

## ğŸ³ é€šè¿‡Dockerå®‰è£…

### æ–¹å¼1: ä½¿ç”¨Dockerè¿è¡Œå•ä¸ªå®ä¾‹ï¼ˆæ¨èåˆå­¦è€…ï¼‰

è¿™æ˜¯æœ€ç®€å•çš„å®‰è£…æ–¹å¼ï¼Œé€‚åˆå¿«é€Ÿå­¦ä¹ å’Œæµ‹è¯•ã€‚

```bash
# åˆ›å»ºLokiæ•°æ®ç›®å½•
mkdir -p $HOME/loki/data

# ä¸‹è½½Lokié…ç½®æ–‡ä»¶
curl -O https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/loki/loki-local-config.yaml

# è¿è¡ŒLokiå®¹å™¨
docker run --name loki \
  -d \
  --publish 3100:3100 \
  --volume $HOME/loki/data:/loki \
  --volume $PWD/loki-local-config.yaml:/etc/loki/local-config.yaml \
  grafana/loki:2.9.0 --config.file=/etc/loki/local-config.yaml
```

Windowsç”¨æˆ·ï¼š

```powershell
# åˆ›å»ºLokiæ•°æ®ç›®å½•
New-Item -ItemType Directory -Force -Path $HOME\loki\data

# ä¸‹è½½Lokié…ç½®æ–‡ä»¶
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/loki/loki-local-config.yaml" -OutFile "loki-local-config.yaml"

# è¿è¡ŒLokiå®¹å™¨
docker run --name loki `
  -d `
  --publish 3100:3100 `
  --volume "$($HOME.Replace('\','/'))/loki/data:/loki" `
  --volume "$(Get-Location)/loki-local-config.yaml:/etc/loki/local-config.yaml" `
  grafana/loki:2.9.0 --config.file=/etc/loki/local-config.yaml
```

### æ–¹å¼2: ä½¿ç”¨Docker Composeï¼ˆæ¨èå¤šç»„ä»¶éƒ¨ç½²ï¼‰

åˆ›å»º`docker-compose.yml`æ–‡ä»¶ï¼š

```yaml
version: "3.8"

services:
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml
      - ./data:/loki
    networks:
      - loki

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - ./promtail-config.yaml:/etc/promtail/config.yml
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - loki

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - loki

volumes:
  grafana-storage:

networks:
  loki:
    driver: bridge
```

åˆ›å»º`loki-config.yaml`æ–‡ä»¶ï¼š

```yaml
auth_enabled: false

server:
  http_listen_port: 3100

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 1h
  max_chunk_age: 1h
  chunk_target_size: 1048576
  chunk_retain_period: 30s

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s
```

åˆ›å»º`promtail-config.yaml`æ–‡ä»¶ï¼š

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
- job_name: containers
  static_configs:
  - targets:
      - localhost
    labels:
      job: containerlogs
      __path__: /var/log/containers/*log

  pipeline_stages:
  - json:
      expressions:
        output: log
        stream: stream
        attrs:
  - json:
      expressions:
        time: time
      source: attrs
  - timestamp:
      format: RFC3339Nano
      source: time
  - labels:
      stream:
      - output:
          source: output
```

å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š

```bash
docker-compose up -d
```

## ğŸ–¥ï¸ é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…

### Linux/macOS

1. ä¸‹è½½LokiäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```bash
# ä¸‹è½½Lokiï¼ˆæ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼‰
wget https://github.com/grafana/loki/releases/download/v2.9.0/loki-linux-amd64.zip
# æˆ–
curl -L https://github.com/grafana/loki/releases/download/v2.9.0/loki-linux-amd64.zip -o loki-linux-amd64.zip

# è§£å‹
unzip loki-linux-amd64.zip
chmod +x loki-linux-amd64

# åˆ›å»ºé…ç½®æ–‡ä»¶
curl -O https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/loki/loki-local-config.yaml

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data

# å¯åŠ¨Loki
./loki-linux-amd64 -config.file=loki-local-config.yaml
```

2. ä¸‹è½½PromtailäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```bash
# ä¸‹è½½Promtail
wget https://github.com/grafana/loki/releases/download/v2.9.0/promtail-linux-amd64.zip
unzip promtail-linux-amd64.zip
chmod +x promtail-linux-amd64

# åˆ›å»ºé…ç½®æ–‡ä»¶
curl -O https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/promtail/promtail-local-config.yaml

# åˆ›å»ºæ—¥å¿—ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p logs

# å¯åŠ¨Promtail
./promtail-linux-amd64 -config.file=promtail-local-config.yaml
```

### Windows

1. ä¸‹è½½LokiäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```powershell
# ä¸‹è½½Loki
Invoke-WebRequest -Uri "https://github.com/grafana/loki/releases/download/v2.9.0/loki-windows-amd64.exe.zip" -OutFile "loki-windows-amd64.zip"

# è§£å‹
Expand-Archive -Path "loki-windows-amd64.zip" -DestinationPath "."
```

2. ä¸‹è½½PromtailäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```powershell
# ä¸‹è½½Promtail
Invoke-WebRequest -Uri "https://github.com/grafana/loki/releases/download/v2.9.0/promtail-windows-amd64.exe.zip" -OutFile "promtail-windows-amd64.zip"

# è§£å‹
Expand-Archive -Path "promtail-windows-amd64.zip" -DestinationPath "."
```

3. åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶å¯åŠ¨ï¼š

```powershell
# ä¸‹è½½é…ç½®æ–‡ä»¶
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/loki/loki-local-config.yaml" -OutFile "loki-local-config.yaml"
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/grafana/loki/v2.9.0/cmd/promtail/promtail-local-config.yaml" -OutFile "promtail-local-config.yaml"

# åˆ›å»ºæ•°æ®ç›®å½•
New-Item -ItemType Directory -Force -Path "data"

# å¯åŠ¨Loki
.\loki-windows-amd64.exe -config.file=loki-local-config.yaml

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨Promtail
.\promtail-windows-amd64.exe -config.file=promtail-local-config.yaml
```

## ğŸ“¦ é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…

### ä½¿ç”¨Homebrewï¼ˆmacOSï¼‰

```bash
# å®‰è£…Loki
brew tap grafana/tap
brew install loki

# å®‰è£…Promtail
brew install promtail
```

### ä½¿ç”¨APTï¼ˆUbuntu/Debianï¼‰

```bash
# æ·»åŠ Grafana APTä»“åº“
sudo apt-get install -y apt-transport-https
sudo apt-get install -y software-properties-common wget
sudo wget -q -O - https://apt.grafana.com/gpg.key | sudo apt-key add -
echo "deb https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
sudo apt-get update
sudo apt-get install -y loki promtail

# å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡
sudo systemctl enable loki promtail
sudo systemctl start loki promtail
```

### ä½¿ç”¨YUM/DNFï¼ˆCentOS/RHEL/Fedoraï¼‰

```bash
# æ·»åŠ Grafana YUMä»“åº“
sudo cat > /etc/yum.repos.d/grafana.repo << EOF
[grafana]
name=grafana
baseurl=https://packages.grafana.com/oss/rpm
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://packages.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF

# å®‰è£…Lokiå’ŒPromtail
sudo yum install -y loki promtail

# å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡
sudo systemctl enable loki promtail
sudo systemctl start loki promtail
```

## âš™ï¸ åŸºæœ¬é…ç½®

### Lokié…ç½®æ–‡ä»¶è¯¦è§£

Lokié…ç½®ä½¿ç”¨YAMLæ ¼å¼ï¼Œä¸»è¦éƒ¨åˆ†åŒ…æ‹¬ï¼š

1. **server**: æœåŠ¡å™¨é…ç½®ï¼ˆç›‘å¬ç«¯å£ã€TLSç­‰ï¼‰
2. **ingester**: æ•°æ®æ¥æ”¶å’Œå­˜å‚¨é…ç½®
3. **schema_config**: æ•°æ®æ¨¡å¼é…ç½®
4. **storage_config**: å­˜å‚¨åç«¯é…ç½®
5. **limits_config**: ç³»ç»Ÿé™åˆ¶é…ç½®

### æœ€å°åŒ–é…ç½®æ–‡ä»¶

```yaml
# æœ€å°åŒ–Lokié…ç½®
auth_enabled: false

server:
  http_listen_port: 3100

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks
```

### Promtailé…ç½®æ–‡ä»¶è¯¦è§£

Promtailé…ç½®ä¸»è¦éƒ¨åˆ†ï¼š

1. **server**: æœåŠ¡å™¨é…ç½®
2. **positions**: ä½ç½®è·Ÿè¸ªé…ç½®
3. **clients**: Lokiå®¢æˆ·ç«¯é…ç½®
4. **scrape_configs**: æ—¥å¿—æŠ“å–é…ç½®

### æœ€å°åŒ–Promtailé…ç½®

```yaml
# æœ€å°åŒ–Promtailé…ç½®
server:
  http_listen_port: 9080

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push

scrape_configs:
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/*log
```

## ğŸ” éªŒè¯å®‰è£…

### æ£€æŸ¥LokiçŠ¶æ€

1. **æ£€æŸ¥è¿›ç¨‹**:

```bash
# Dockeræ–¹å¼
docker ps | grep loki

# äºŒè¿›åˆ¶æ–¹å¼
ps aux | grep loki
```

2. **æ£€æŸ¥ç«¯å£**:

```bash
# æ£€æŸ¥3100ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tlnp | grep 3100
# æˆ–
ss -tlnp | grep 3100
```

3. **æ£€æŸ¥APIå¥åº·çŠ¶æ€**:

```bash
# ä½¿ç”¨curlæ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:3100/ready

# é¢„æœŸå“åº”ï¼šready
```

### æ£€æŸ¥PromtailçŠ¶æ€

1. **æ£€æŸ¥è¿›ç¨‹**:

```bash
# Dockeræ–¹å¼
docker ps | grep promtail

# äºŒè¿›åˆ¶æ–¹å¼
ps aux | grep promtail
```

2. **æ£€æŸ¥ç«¯å£**:

```bash
# æ£€æŸ¥9080ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tlnp | grep 9080
```

3. **æ£€æŸ¥ç›®æ ‡çŠ¶æ€**:

```bash
# æ£€æŸ¥PromtailæŠ“å–ç›®æ ‡çŠ¶æ€
curl http://localhost:9080/targets
```

### é…ç½®Grafanaè¿æ¥Loki

1. è®¿é—®Grafanaï¼ˆhttp://localhost:3000ï¼‰
2. ç™»å½•ï¼ˆé»˜è®¤ç”¨æˆ·å/å¯†ç : admin/adminï¼‰
3. æ·»åŠ Lokiæ•°æ®æºï¼š
   - ç‚¹å‡»"Configuration" > "Data Sources"
   - ç‚¹å‡»"Add data source"
   - é€‰æ‹©"Loki"
   - è®¾ç½®URLä¸º`http://loki:3100`ï¼ˆDockerç¯å¢ƒï¼‰æˆ–`http://localhost:3100`ï¼ˆæœ¬åœ°å®‰è£…ï¼‰
   - ç‚¹å‡»"Save & Test"

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### ç«¯å£å ç”¨é—®é¢˜

å¦‚æœ3100æˆ–9080ç«¯å£å·²è¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®ï¼š

```yaml
# Lokié…ç½®ä¸­ä¿®æ”¹ç«¯å£
server:
  http_listen_port: 3101  # æ›´æ”¹ä¸ºå…¶ä»–ç«¯å£

# Promtailé…ç½®ä¸­ä¿®æ”¹å®¢æˆ·ç«¯URL
clients:
  - url: http://localhost:3101/loki/api/v1/push
```

### æƒé™é—®é¢˜

ç¡®ä¿Lokiå’ŒPromtailæœ‰æƒé™å†™å…¥æŒ‡å®šç›®å½•ï¼š

```bash
# Linux/macOS
sudo chown -R $USER:$USER /path/to/loki/data
sudo chmod -R 755 /path/to/loki/data

# Dockerç¡®ä¿å·æ˜ å°„æ­£ç¡®
docker run -v /host/path:/container/path ...
```

### å­˜å‚¨é—®é¢˜

ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼š

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ç›®å½•å¤§å°
du -sh /path/to/loki/data
```

### ç½‘ç»œè¿æ¥é—®é¢˜

ç¡®ä¿Lokiå’ŒPromtailå¯ä»¥äº’ç›¸é€šä¿¡ï¼š

```bash
# æµ‹è¯•è¿æ¥
curl http://loki:3100/ready

# æˆ–ä½¿ç”¨telnet
telnet loki 3100
```

## ğŸ§ª å®éªŒï¼šå®‰è£…å’Œé…ç½®Loki

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„å®éªŒæ¥éªŒè¯Lokiçš„å®‰è£…ï¼š

1. æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©ä¸€ç§å®‰è£…æ–¹å¼
2. å®‰è£…Lokiå’ŒPromtail
3. é…ç½®åŸºæœ¬çš„æ—¥å¿—æ”¶é›†
4. éªŒè¯å®‰è£…å’Œé…ç½®

**å®éªŒä»£ç ç¤ºä¾‹ï¼ˆå‚è€ƒï¼‰ï¼š**

è§[code/experiments/basic-setup.sh](../code/chapter1/basic-setup.sh)æˆ–[code/experiments/basic-setup.ps1](../code/chapter1/basic-setup.ps1)

## ğŸ“ æœ¬ç« å°ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

- å¦‚ä½•åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šå®‰è£…Lokiå’ŒPromtail
- ä½¿ç”¨Dockerå’ŒDocker Composeéƒ¨ç½²Loki
- Lokiå’ŒPromtailçš„åŸºæœ¬é…ç½®é€‰é¡¹
- å¸¸è§å®‰è£…é—®é¢˜çš„è§£å†³æ–¹æ³•
- å¦‚ä½•éªŒè¯å®‰è£…å’Œé…ç½®

å®Œæˆå®‰è£…åï¼Œæ‚¨ç°åœ¨æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„Lokiç³»ç»Ÿï¼Œå¯ä»¥å¼€å§‹æ”¶é›†å’ŒæŸ¥è¯¢æ—¥å¿—ã€‚åœ¨ä¸‹ä¸€ç« [1.3 ç¬¬ä¸€æ¬¡ä½¿ç”¨Loki](./1.3-first-steps.md)ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å¼€å§‹ä½¿ç”¨Lokiæ”¶é›†å’ŒæŸ¥è¯¢æ—¥å¿—ã€‚

## ğŸ¤” æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆDockeræ–¹å¼å®‰è£…Lokiæ›´é€‚åˆåˆå­¦è€…ï¼Ÿ
2. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ ä¼šé€‰æ‹©å“ªç§å®‰è£…æ–¹å¼ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
3. Lokiå’ŒPromtailçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªç»„ä»¶ï¼Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Lokiå®‰è£…å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/loki/latest/setup/install/)
- [Promtailé…ç½®æ–‡æ¡£](https://grafana.com/docs/loki/latest/clients/promtail/)
- [Lokié…ç½®å‚è€ƒ](https://grafana.com/docs/loki/latest/configure/)