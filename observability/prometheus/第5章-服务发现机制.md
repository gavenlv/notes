# ç¬¬5ç« ï¼šæœåŠ¡å‘ç°æœºåˆ¶

> **å­¦ä¹ æ—¶é•¿**: 5-6å°æ—¶  
> **éš¾åº¦**: â­â­â­â­  
> **é‡è¦æ€§**: â­â­â­â­

## æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« å,ä½ å°†èƒ½å¤Ÿ:

- âœ… ç†è§£æœåŠ¡å‘ç°çš„å¿…è¦æ€§å’Œå·¥ä½œåŸç†
- âœ… æŒæ¡é™æ€é…ç½®å’ŒåŠ¨æ€æœåŠ¡å‘ç°çš„åŒºåˆ«
- âœ… é…ç½®KubernetesæœåŠ¡å‘ç°
- âœ… ä½¿ç”¨Consulè¿›è¡ŒæœåŠ¡å‘ç°
- âœ… å®ç°åŸºäºæ–‡ä»¶çš„åŠ¨æ€æœåŠ¡å‘ç°
- âœ… ç†è§£Relabelæœºåˆ¶
- âœ… è®¾è®¡é€‚åˆç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å‘ç°æ–¹æ¡ˆ

---

## 5.1 æœåŠ¡å‘ç°æ¦‚è¿°

### 5.1.1 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡å‘ç°?

åœ¨ä¼ ç»Ÿé™æ€é…ç½®ä¸­,å½“ç›‘æ§ç›®æ ‡å‘ç”Ÿå˜åŒ–æ—¶éœ€è¦:
1. ä¿®æ”¹Prometheusé…ç½®æ–‡ä»¶
2. é‡è½½PrometheusæœåŠ¡
3. äººå·¥ç»´æŠ¤æˆæœ¬é«˜ã€æ˜“å‡ºé”™

**åŠ¨æ€æœåŠ¡å‘ç°çš„ä¼˜åŠ¿**:
- ğŸ”„ è‡ªåŠ¨å‘ç°æ–°æœåŠ¡å®ä¾‹
- âš¡ è‡ªåŠ¨ç§»é™¤ä¸‹çº¿å®ä¾‹
- ğŸ¯ å‡å°‘äººå·¥å¹²é¢„
- ğŸ“ˆ é€‚åº”äº‘åŸç”Ÿå’Œå¾®æœåŠ¡æ¶æ„

### 5.1.2 Prometheusæ”¯æŒçš„æœåŠ¡å‘ç°æœºåˆ¶

| ç±»å‹ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|------|---------|--------|
| **static_configs** | å°è§„æ¨¡ã€å›ºå®šç›®æ ‡ | â­ |
| **file_sd_configs** | ä¸­ç­‰è§„æ¨¡ã€çµæ´»é…ç½® | â­â­ |
| **kubernetes_sd_configs** | Kubernetesç¯å¢ƒ | â­â­â­â­ |
| **consul_sd_configs** | Consulæ³¨å†Œä¸­å¿ƒ | â­â­â­ |
| **dns_sd_configs** | DNS SRVè®°å½• | â­â­ |
| **ec2_sd_configs** | AWS EC2 | â­â­â­ |
| **azure_sd_configs** | Azureè™šæ‹Ÿæœº | â­â­â­ |
| **gce_sd_configs** | Google Cloud | â­â­â­ |
| **docker_sd_configs** | Docker Swarm | â­â­â­ |

---

## 5.2 é™æ€é…ç½® (Static Config)

### 5.2.1 åŸºç¡€é™æ€é…ç½®

```yaml
scrape_configs:
  - job_name: 'web-servers'
    static_configs:
      - targets:
          - 'web-01:9100'
          - 'web-02:9100'
          - 'web-03:9100'
        labels:
          env: 'production'
          team: 'backend'
```

### 5.2.2 å¤šç»„ç›®æ ‡é…ç½®

```yaml
scrape_configs:
  - job_name: 'multi-env'
    static_configs:
      # ç”Ÿäº§ç¯å¢ƒ
      - targets:
          - 'prod-web-01:9100'
          - 'prod-web-02:9100'
        labels:
          env: 'production'
          region: 'us-east-1'
      
      # æµ‹è¯•ç¯å¢ƒ
      - targets:
          - 'test-web-01:9100'
          - 'test-web-02:9100'
        labels:
          env: 'testing'
          region: 'us-west-1'
      
      # å¼€å‘ç¯å¢ƒ
      - targets:
          - 'dev-web-01:9100'
        labels:
          env: 'development'
          region: 'local'
```

### 5.2.3 é™æ€é…ç½®çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**:
- âœ… ç®€å•ç›´è§‚
- âœ… é€‚åˆå›ºå®šç›®æ ‡
- âœ… æ— é¢å¤–ä¾èµ–

**ç¼ºç‚¹**:
- âŒ æ‰©å±•æ€§å·®
- âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤
- âŒ ä¸é€‚åˆåŠ¨æ€ç¯å¢ƒ

---

## 5.3 åŸºäºæ–‡ä»¶çš„æœåŠ¡å‘ç° (File SD)

### 5.3.1 File SDç®€ä»‹

File SDé€šè¿‡ç›‘æ§æ–‡ä»¶å˜åŒ–æ¥åŠ¨æ€æ›´æ–°ç›®æ ‡,æ”¯æŒJSONå’ŒYAMLæ ¼å¼ã€‚

**ä¼˜ç‚¹**:
- ğŸ”„ è‡ªåŠ¨é‡è½½(æ— éœ€é‡å¯Prometheus)
- ğŸ“ æ˜“äºè„šæœ¬åŒ–ç”Ÿæˆ
- ğŸ”§ çµæ´»æ€§é«˜

### 5.3.2 é…ç½®File SD

**Prometheusé…ç½®**:

```yaml
scrape_configs:
  - job_name: 'file-sd-nodes'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/*.json'
          - '/etc/prometheus/targets/*.yml'
        refresh_interval: 30s  # åˆ·æ–°é—´éš”(é»˜è®¤5m)
```

**ç›®æ ‡æ–‡ä»¶ (JSONæ ¼å¼)**: `/etc/prometheus/targets/web-servers.json`

```json
[
  {
    "targets": [
      "web-01:9100",
      "web-02:9100",
      "web-03:9100"
    ],
    "labels": {
      "env": "production",
      "job": "node-exporter",
      "team": "platform",
      "datacenter": "dc1"
    }
  },
  {
    "targets": [
      "db-01:9104",
      "db-02:9104"
    ],
    "labels": {
      "env": "production",
      "job": "mysql-exporter",
      "team": "database"
    }
  }
]
```

**ç›®æ ‡æ–‡ä»¶ (YAMLæ ¼å¼)**: `/etc/prometheus/targets/web-servers.yml`

```yaml
- targets:
    - web-01:9100
    - web-02:9100
    - web-03:9100
  labels:
    env: production
    job: node-exporter
    team: platform

- targets:
    - db-01:9104
    - db-02:9104
  labels:
    env: production
    job: mysql-exporter
    team: database
```

### 5.3.3 è‡ªåŠ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶

**åœºæ™¯**: ä»CMDBè‡ªåŠ¨ç”Ÿæˆç›‘æ§ç›®æ ‡

**Pythonè„šæœ¬ç¤ºä¾‹**:

```python
#!/usr/bin/env python3
"""
ä»CMDBç”ŸæˆPrometheus File SDé…ç½®
"""

import json
import requests

def get_servers_from_cmdb():
    """ä»CMDBè·å–æœåŠ¡å™¨åˆ—è¡¨"""
    response = requests.get('http://cmdb.example.com/api/servers')
    return response.json()

def generate_targets():
    """ç”ŸæˆPrometheusç›®æ ‡é…ç½®"""
    servers = get_servers_from_cmdb()
    
    targets = []
    for server in servers:
        targets.append({
            "targets": [f"{server['ip']}:9100"],
            "labels": {
                "env": server['environment'],
                "role": server['role'],
                "datacenter": server['datacenter'],
                "team": server['team'],
                "hostname": server['hostname']
            }
        })
    
    # å†™å…¥ç›®æ ‡æ–‡ä»¶
    with open('/etc/prometheus/targets/cmdb-servers.json', 'w') as f:
        json.dump(targets, f, indent=2)
    
    print(f"ç”Ÿæˆäº†{len(targets)}ä¸ªç›‘æ§ç›®æ ‡")

if __name__ == '__main__':
    generate_targets()
```

**å®šæ—¶ä»»åŠ¡**:

```bash
# æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
*/5 * * * * /usr/local/bin/generate_prometheus_targets.py
```

---

## 5.4 KubernetesæœåŠ¡å‘ç°

### 5.4.1 Kubernetes SDç®€ä»‹

Prometheusæ”¯æŒä»Kubernetes APIè‡ªåŠ¨å‘ç°ä»¥ä¸‹èµ„æº:
- `node`: èŠ‚ç‚¹
- `pod`: Pod
- `service`: Service
- `endpoints`: Endpoints
- `endpointslice`: EndpointSlice
- `ingress`: Ingress

### 5.4.2 é…ç½®Kubernetes SD

**RBACæƒé™é…ç½®** (`prometheus-rbac.yml`):

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions", "networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: monitoring
```

**Prometheusé…ç½®**:

```yaml
scrape_configs:
  # å‘ç°KubernetesèŠ‚ç‚¹
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      # ä½¿ç”¨èŠ‚ç‚¹å†…ç½‘IP
      - source_labels: [__address__]
        regex: '(.*):10250'
        replacement: '${1}:9100'
        target_label: __address__
      # ä¿ç•™èŠ‚ç‚¹åç§°
      - source_labels: [__meta_kubernetes_node_name]
        target_label: instance

  # å‘ç°Kubernetes Pod
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # åªæŠ“å–æœ‰prometheus.io/scrape=true annotationçš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      # ä½¿ç”¨Podçš„ç«¯å£
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)
        replacement: __meta_kubernetes_pod_ip:${1}
      # ä½¿ç”¨Podçš„path
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      # æ·»åŠ namespaceæ ‡ç­¾
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      # æ·»åŠ podåç§°æ ‡ç­¾
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: kubernetes_pod_name
      # æ·»åŠ å®¹å™¨åç§°æ ‡ç­¾
      - source_labels: [__meta_kubernetes_pod_container_name]
        target_label: kubernetes_container_name

  # å‘ç°Kubernetes Service
  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
    metrics_path: /probe
    params:
      module: [http_2xx]
    relabel_configs:
      # åªæ¢æµ‹æœ‰prometheus.io/probe=true annotationçš„Service
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
        action: keep
        regex: true
      # è®¾ç½®æ¢æµ‹ç›®æ ‡
      - source_labels: [__address__]
        target_label: __param_target
      # è®¾ç½®blackbox exporteråœ°å€
      - target_label: __address__
        replacement: blackbox-exporter:9115
      # æ·»åŠ Serviceä¿¡æ¯
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        target_label: kubernetes_service_name
```

### 5.4.3 Pod Annotationsé…ç½®

åœ¨Podçš„Deploymentä¸­æ·»åŠ annotations:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"   # å¯ç”¨æŠ“å–
        prometheus.io/port: "8080"     # æŒ‡æ ‡ç«¯å£
        prometheus.io/path: "/metrics" # æŒ‡æ ‡è·¯å¾„
      labels:
        app: my-app
    spec:
      containers:
        - name: my-app
          image: my-app:latest
          ports:
            - containerPort: 8080
```

### 5.4.4 Kuberneteså…ƒæ ‡ç­¾

Prometheusä¼šè‡ªåŠ¨æ·»åŠ ä»¥ä¸‹å…ƒæ ‡ç­¾:

**Nodeè§’è‰²**:
- `__meta_kubernetes_node_name`: èŠ‚ç‚¹åç§°
- `__meta_kubernetes_node_address_<type>`: èŠ‚ç‚¹åœ°å€
- `__meta_kubernetes_node_label_<labelname>`: èŠ‚ç‚¹æ ‡ç­¾

**Podè§’è‰²**:
- `__meta_kubernetes_namespace`: Podæ‰€åœ¨namespace
- `__meta_kubernetes_pod_name`: Podåç§°
- `__meta_kubernetes_pod_ip`: Pod IP
- `__meta_kubernetes_pod_label_<labelname>`: Podæ ‡ç­¾
- `__meta_kubernetes_pod_annotation_<annotationname>`: Podæ³¨è§£
- `__meta_kubernetes_pod_container_name`: å®¹å™¨åç§°
- `__meta_kubernetes_pod_container_port_number`: å®¹å™¨ç«¯å£

**Serviceè§’è‰²**:
- `__meta_kubernetes_namespace`: Serviceæ‰€åœ¨namespace
- `__meta_kubernetes_service_name`: Serviceåç§°
- `__meta_kubernetes_service_label_<labelname>`: Serviceæ ‡ç­¾
- `__meta_kubernetes_service_annotation_<annotationname>`: Serviceæ³¨è§£

---

## 5.5 ConsulæœåŠ¡å‘ç°

### 5.5.1 Consul SDç®€ä»‹

Consulæ˜¯HashiCorpå¼€æºçš„æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆ,æä¾›:
- æœåŠ¡æ³¨å†Œä¸å‘ç°
- å¥åº·æ£€æŸ¥
- KVå­˜å‚¨
- å¤šæ•°æ®ä¸­å¿ƒæ”¯æŒ

### 5.5.2 å®‰è£…Consul

**Dockeræ–¹å¼**:

```bash
docker run -d \
  --name=consul \
  -p 8500:8500 \
  -p 8600:8600/udp \
  consul:latest agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
```

**è®¿é—®UI**: http://localhost:8500

### 5.5.3 æ³¨å†ŒæœåŠ¡åˆ°Consul

**JSONé…ç½®æ–‡ä»¶**:

```json
{
  "service": {
    "name": "web-server",
    "tags": ["production", "v1.0.0"],
    "address": "192.168.1.10",
    "port": 9100,
    "meta": {
      "env": "production",
      "team": "platform"
    },
    "check": {
      "http": "http://192.168.1.10:9100/metrics",
      "interval": "10s",
      "timeout": "5s"
    }
  }
}
```

**é€šè¿‡APIæ³¨å†Œ**:

```bash
curl -X PUT \
  -d @service.json \
  http://localhost:8500/v1/agent/service/register
```

**Pythonæ³¨å†Œç¤ºä¾‹**:

```python
import consul

# è¿æ¥Consul
c = consul.Consul(host='localhost', port=8500)

# æ³¨å†ŒæœåŠ¡
c.agent.service.register(
    name='web-server',
    service_id='web-server-01',
    address='192.168.1.10',
    port=9100,
    tags=['production', 'v1.0.0'],
    meta={'env': 'production', 'team': 'platform'},
    check=consul.Check.http(
        url='http://192.168.1.10:9100/metrics',
        interval='10s',
        timeout='5s'
    )
)
```

### 5.5.4 é…ç½®Prometheus Consul SD

```yaml
scrape_configs:
  - job_name: 'consul-services'
    consul_sd_configs:
      - server: 'localhost:8500'
        datacenter: 'dc1'
        services: []  # ç©ºè¡¨ç¤ºæ‰€æœ‰æœåŠ¡
        tags:
          - production  # åªå‘ç°å¸¦productionæ ‡ç­¾çš„æœåŠ¡
        refresh_interval: 30s
    
    relabel_configs:
      # åªä¿ç•™ç‰¹å®šæœåŠ¡
      - source_labels: [__meta_consul_service]
        regex: '(web-server|mysql-exporter|redis-exporter)'
        action: keep
      
      # ä½¿ç”¨æœåŠ¡åœ°å€å’Œç«¯å£
      - source_labels: [__meta_consul_address, __meta_consul_service_port]
        separator: ':'
        target_label: __address__
      
      # æ·»åŠ ç¯å¢ƒæ ‡ç­¾
      - source_labels: [__meta_consul_service_metadata_env]
        target_label: env
      
      # æ·»åŠ å›¢é˜Ÿæ ‡ç­¾
      - source_labels: [__meta_consul_service_metadata_team]
        target_label: team
      
      # ä½¿ç”¨service_idä½œä¸ºinstance
      - source_labels: [__meta_consul_service_id]
        target_label: instance
```

### 5.5.5 Consulå…ƒæ ‡ç­¾

- `__meta_consul_address`: æœåŠ¡åœ°å€
- `__meta_consul_service`: æœåŠ¡åç§°
- `__meta_consul_service_id`: æœåŠ¡ID
- `__meta_consul_service_port`: æœåŠ¡ç«¯å£
- `__meta_consul_tags`: æœåŠ¡æ ‡ç­¾(é€—å·åˆ†éš”)
- `__meta_consul_service_metadata_<key>`: æœåŠ¡å…ƒæ•°æ®
- `__meta_consul_dc`: æ•°æ®ä¸­å¿ƒåç§°

---

## 5.6 Relabelé…ç½®è¯¦è§£

### 5.6.1 Relabelæœºåˆ¶

Relabelæ˜¯PrometheusæœåŠ¡å‘ç°çš„æ ¸å¿ƒæœºåˆ¶,ç”¨äº:
- ğŸ¯ è¿‡æ»¤ç›®æ ‡
- ğŸ·ï¸ ä¿®æ”¹æ ‡ç­¾
- ğŸ”„ é‡å†™åœ°å€
- ğŸ“ æ·»åŠ æ–°æ ‡ç­¾

**æ‰§è¡Œæ—¶æœº**:
1. **relabel_configs**: æŠ“å–å‰æ‰§è¡Œ
2. **metric_relabel_configs**: æŠ“å–åã€å­˜å‚¨å‰æ‰§è¡Œ

### 5.6.2 RelabelåŠ¨ä½œ (Action)

| Action | è¯´æ˜ |
|--------|------|
| `replace` | æ›¿æ¢æ ‡ç­¾å€¼(é»˜è®¤) |
| `keep` | ä¿ç•™åŒ¹é…çš„ç›®æ ‡ |
| `drop` | ä¸¢å¼ƒåŒ¹é…çš„ç›®æ ‡ |
| `hashmod` | å“ˆå¸Œå–æ¨¡ |
| `labelmap` | æ‰¹é‡æ˜ å°„æ ‡ç­¾ |
| `labeldrop` | åˆ é™¤æ ‡ç­¾ |
| `labelkeep` | ä¿ç•™æ ‡ç­¾ |

### 5.6.3 Relabelç¤ºä¾‹

**ç¤ºä¾‹1: è¿‡æ»¤ç›®æ ‡**

```yaml
relabel_configs:
  # åªä¿ç•™ç”Ÿäº§ç¯å¢ƒ
  - source_labels: [__meta_consul_service_metadata_env]
    regex: 'production'
    action: keep
  
  # æ’é™¤æµ‹è¯•ç¯å¢ƒ
  - source_labels: [__meta_consul_service_metadata_env]
    regex: 'testing'
    action: drop
```

**ç¤ºä¾‹2: é‡å†™æ ‡ç­¾**

```yaml
relabel_configs:
  # å°†__meta_kubernetes_pod_nameé‡å‘½åä¸ºpod
  - source_labels: [__meta_kubernetes_pod_name]
    target_label: pod
  
  # æå–ç‰ˆæœ¬å·
  - source_labels: [__meta_kubernetes_pod_label_version]
    regex: 'v(.*)'
    replacement: '${1}'
    target_label: version
```

**ç¤ºä¾‹3: ç»„åˆå¤šä¸ªæ ‡ç­¾**

```yaml
relabel_configs:
  # ç»„åˆnamespaceå’Œpodåç§°
  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_name]
    separator: '/'
    target_label: instance
```

**ç¤ºä¾‹4: ä½¿ç”¨labelmapæ‰¹é‡æ˜ å°„**

```yaml
relabel_configs:
  # å°†æ‰€æœ‰__meta_kubernetes_pod_label_*æ˜ å°„ä¸ºk8s_label_*
  - regex: '__meta_kubernetes_pod_label_(.+)'
    action: labelmap
    replacement: 'k8s_label_${1}'
```

**ç¤ºä¾‹5: åˆ é™¤æ— ç”¨æ ‡ç­¾**

```yaml
metric_relabel_configs:
  # åˆ é™¤jobæ ‡ç­¾
  - regex: 'job'
    action: labeldrop
  
  # åªä¿ç•™æŒ‡å®šæ ‡ç­¾
  - regex: '(instance|env|team)'
    action: labelkeep
```

**ç¤ºä¾‹6: å“ˆå¸Œå–æ¨¡(ç”¨äºåˆ†ç‰‡)**

```yaml
relabel_configs:
  # å°†ç›®æ ‡åˆ†ä¸º4ç»„,åªæŠ“å–ç¬¬1ç»„
  - source_labels: [__address__]
    modulus: 4
    target_label: __tmp_hash
    action: hashmod
  - source_labels: [__tmp_hash]
    regex: '0'
    action: keep
```

---

## 5.7 DNSæœåŠ¡å‘ç°

### 5.7.1 DNS SDé…ç½®

```yaml
scrape_configs:
  - job_name: 'dns-sd'
    dns_sd_configs:
      - names:
          - 'web-servers.example.com'
          - 'db-servers.example.com'
        type: 'A'  # æˆ–SRV
        port: 9100
        refresh_interval: 30s
```

**DNS SRVè®°å½•**:

```bash
# SRVè®°å½•æ ¼å¼: _service._proto.name TTL class SRV priority weight port target
_prometheus._tcp.example.com. 300 IN SRV 0 0 9100 web-01.example.com.
_prometheus._tcp.example.com. 300 IN SRV 0 0 9100 web-02.example.com.
```

```yaml
scrape_configs:
  - job_name: 'dns-srv'
    dns_sd_configs:
      - names:
          - '_prometheus._tcp.example.com'
        type: 'SRV'
```

---

## 5.8 å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: æ··åˆç¯å¢ƒç›‘æ§

```yaml
scrape_configs:
  # Kubernetesé›†ç¾¤
  - job_name: 'k8s-pods'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['production', 'staging']
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

  # Consulæ³¨å†Œçš„VM
  - job_name: 'consul-vms'
    consul_sd_configs:
      - server: 'consul.example.com:8500'
        datacenter: 'dc1'
    relabel_configs:
      - source_labels: [__meta_consul_tags]
        regex: '.*,vm,.*'
        action: keep

  # CMDBç”Ÿæˆçš„é™æ€èµ„äº§
  - job_name: 'cmdb-legacy'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/cmdb-*.json'
        refresh_interval: 5m
```

### æ¡ˆä¾‹2: å¤šç¯å¢ƒéš”ç¦»

```yaml
scrape_configs:
  # ç”Ÿäº§ç¯å¢ƒ - é«˜é¢‘æŠ“å–
  - job_name: 'production'
    scrape_interval: 15s
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['production']
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        target_label: env
        replacement: 'production'

  # æµ‹è¯•ç¯å¢ƒ - ä½é¢‘æŠ“å–
  - job_name: 'testing'
    scrape_interval: 60s
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['testing']
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        target_label: env
        replacement: 'testing'
```

---

## 5.9 æœ¬ç« å°ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

âœ… **æœåŠ¡å‘ç°ç±»å‹**: Staticã€File SDã€Kubernetes SDã€Consul SDã€DNS SD

âœ… **Kubernetes SD**: æ”¯æŒnodeã€podã€serviceã€endpointsç­‰è§’è‰²

âœ… **Consul SD**: åŸºäºConsulæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å‘ç°

âœ… **Relabelæœºåˆ¶**: keepã€dropã€replaceã€labelmapç­‰æ“ä½œ

âœ… **å…ƒæ ‡ç­¾**: `__meta_*`å‰ç¼€çš„ä¸´æ—¶æ ‡ç­¾

### æœ€ä½³å®è·µ

1. **å°è§„æ¨¡**: ä½¿ç”¨Static Config
2. **ä¸­ç­‰è§„æ¨¡**: ä½¿ç”¨File SD + è„šæœ¬ç”Ÿæˆ
3. **Kubernetes**: ä½¿ç”¨Kubernetes SD
4. **å¾®æœåŠ¡**: ä½¿ç”¨Consul SDæˆ–Kubernetes SD
5. **æ··åˆç¯å¢ƒ**: ç»„åˆå¤šç§æœåŠ¡å‘ç°

### ä¸‹ä¸€ç« é¢„å‘Š

**ç¬¬6ç«  - å‘Šè­¦è§„åˆ™ä¸Alertmanager**,å°†å­¦ä¹ :
- ğŸ“¢ å‘Šè­¦è§„åˆ™ç¼–å†™
- ğŸ”” Alertmanageré…ç½®
- ğŸ“§ é€šçŸ¥æ¸ é“(Emailã€Slackã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡)
- ğŸ¯ å‘Šè­¦è·¯ç”±å’Œåˆ†ç»„
- ğŸ”‡ å‘Šè­¦æŠ‘åˆ¶å’Œé™é»˜

---

**ğŸ‰ æ­å–œ!** ä½ å·²ç»æŒæ¡äº†PrometheusæœåŠ¡å‘ç°æœºåˆ¶!
