---
# ç”¨æˆ·ç®¡ç† Playbook
- name: "ç”¨æˆ·å’Œæƒé™ç®¡ç†"
  hosts: all
  become: yes
  vars:
    # å®šä¹‰åº”ç”¨ç”¨æˆ·åˆ—è¡¨
    app_users:
      - name: "webdev"
        comment: "Webå¼€å‘äººå‘˜"
        groups: ["sudo", "www-data"]
        shell: "/bin/bash"
        create_home: yes
        password: "$6$salt$encrypted_password"  # éœ€è¦é¢„å…ˆåŠ å¯†
        
      - name: "deploy"
        comment: "éƒ¨ç½²ä¸“ç”¨ç”¨æˆ·"
        groups: ["www-data"]
        shell: "/bin/bash"
        create_home: yes
        system: yes
        
      - name: "monitor"
        comment: "ç›‘æ§ç”¨æˆ·"
        groups: ["monitor"]
        shell: "/bin/bash"
        create_home: yes
        system: yes
        
    # SSH å…¬é’¥ (å®é™…ä½¿ç”¨æ—¶åº”è¯¥ä»æ–‡ä»¶è¯»å–)
    ssh_keys:
      webdev: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... webdev@company.com"
      deploy: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD... deploy@automation"
      
  tasks:
    - name: "åˆ›å»ºå¿…è¦çš„ç”¨æˆ·ç»„"
      group:
        name: "{{ item }}"
        state: present
      loop:
        - developers
        - deployers
        - monitor
        
    - name: "æ˜¾ç¤ºå½“å‰ç”¨æˆ·åˆ—è¡¨"
      command: cat /etc/passwd
      register: current_users
      changed_when: false
      
    - name: "æ˜¾ç¤ºç°æœ‰ç”¨æˆ·(ä»…ç”¨æˆ·å)"
      debug:
        msg: "ç°æœ‰ç”¨æˆ·: {{ current_users.stdout_lines | map('regex_replace', '^([^:]+):.*', '\\1') | list }}"
        
    - name: "åˆ›å»ºåº”ç”¨ç”¨æˆ·"
      user:
        name: "{{ item.name }}"
        comment: "{{ item.comment | default('') }}"
        groups: "{{ (item.groups | default([])) + ['developers'] }}"
        shell: "{{ item.shell | default('/bin/bash') }}"
        create_home: "{{ item.create_home | default(true) }}"
        system: "{{ item.system | default(false) }}"
        state: present
        # password: "{{ item.password | default(omit) }}"
      loop: "{{ app_users }}"
      register: user_creation
      
    - name: "æ˜¾ç¤ºç”¨æˆ·åˆ›å»ºç»“æœ"
      debug:
        msg: |
          ç”¨æˆ· {{ item.item.name }}:
          çŠ¶æ€: {{ 'created' if item.changed else 'already exists' }}
          UID: {{ item.uid | default('N/A') }}
          ä¸»ç›®å½•: {{ item.home | default('N/A') }}
      loop: "{{ user_creation.results }}"
      
    - name: "è®¾ç½®ç”¨æˆ·å¯†ç  (äº¤äº’å¼)"
      debug:
        msg: |
          è¯·ä¸ºç”¨æˆ· {{ item.name }} æ‰‹åŠ¨è®¾ç½®å¯†ç :
          sudo passwd {{ item.name }}
      loop: "{{ app_users }}"
      when: item.password is not defined
      
    - name: "åˆ›å»º SSH ç›®å½•"
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0700'
      loop: "{{ app_users }}"
      when: not item.system | default(false)
      
    - name: "è®¾ç½® SSH å…¬é’¥"
      authorized_key:
        user: "{{ item.key }}"
        key: "{{ item.value }}"
        state: present
        comment: "Ansible managed key for {{ item.key }}"
      loop: "{{ ssh_keys | dict2items }}"
      when: item.key in (app_users | map(attribute='name') | list)
      
    - name: "é…ç½® sudo æƒé™"
      copy:
        content: |
          # å¼€å‘äººå‘˜ sudo æƒé™
          %developers ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
          %developers ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx
          %developers ALL=(ALL) NOPASSWD: /usr/bin/systemctl status nginx
          %developers ALL=(ALL) NOPASSWD: /usr/bin/tail -f /var/log/nginx/*
          %developers ALL=(ALL) NOPASSWD: /usr/bin/less /var/log/nginx/*
          
          # éƒ¨ç½²äººå‘˜æƒé™
          %deployers ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart *
          %deployers ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload *
          %deployers ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop *
          %deployers ALL=(ALL) NOPASSWD: /usr/bin/systemctl start *
          
          # ç›‘æ§æƒé™
          %monitor ALL=(ALL) NOPASSWD: /usr/bin/systemctl status *
          %monitor ALL=(ALL) NOPASSWD: /usr/bin/ps aux
          %monitor ALL=(ALL) NOPASSWD: /usr/bin/netstat -tlnp
          %monitor ALL=(ALL) NOPASSWD: /usr/bin/ss -tlnp
        dest: /etc/sudoers.d/app_users
        mode: '0440'
        validate: 'visudo -cf %s'
        
    - name: "åˆ›å»ºç”¨æˆ·ä¸“ç”¨ç›®å½•"
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group | default(item.owner) }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/opt/apps", owner: "deploy", mode: "0755" }
        - { path: "/var/log/apps", owner: "deploy", group: "www-data", mode: "0775" }
        - { path: "/home/webdev/scripts", owner: "webdev", mode: "0755" }
        - { path: "/home/monitor/tools", owner: "monitor", mode: "0755" }
        
    - name: "åˆ›å»ºç”¨æˆ·è„šæœ¬"
      copy:
        content: |
          #!/bin/bash
          # {{ item.name }} çš„ä¾¿æ·è„šæœ¬
          
          echo "æ¬¢è¿ {{ item.name }}!"
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "ç³»ç»Ÿè´Ÿè½½: $(uptime | cut -d',' -f3-)"
          echo "ç£ç›˜ä½¿ç”¨: $(df -h / | tail -1 | awk '{print $5}')"
          
          # å¸¸ç”¨åˆ«å
          alias ll='ls -la'
          alias la='ls -A'
          alias l='ls -CF'
          alias ..='cd ..'
          alias ...='cd ../..'
          alias grep='grep --color=auto'
          
          {% if item.name == 'webdev' %}
          # Web å¼€å‘ä¸“ç”¨åˆ«å
          alias nginx-reload='sudo systemctl reload nginx'
          alias nginx-status='sudo systemctl status nginx'
          alias nginx-test='sudo nginx -t'
          alias logs='sudo tail -f /var/log/nginx/error.log'
          {% endif %}
          
          {% if item.name == 'deploy' %}
          # éƒ¨ç½²ä¸“ç”¨åˆ«å
          alias deploy-status='sudo systemctl status nginx php7.4-fpm mysql'
          alias app-logs='sudo tail -f /var/log/apps/*'
          alias quick-deploy='cd /opt/apps && ./deploy.sh'
          {% endif %}
          
          {% if item.name == 'monitor' %}
          # ç›‘æ§ä¸“ç”¨åˆ«å
          alias check-services='sudo systemctl status nginx php7.4-fpm mysql'
          alias check-ports='sudo netstat -tlnp'
          alias check-processes='ps aux | head -20'
          alias check-disk='df -h'
          alias check-memory='free -h'
          {% endif %}
        dest: "/home/{{ item.name }}/.bashrc_custom"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ app_users }}"
      when: not item.system | default(false)
      
    - name: "æ·»åŠ è‡ªå®šä¹‰é…ç½®åˆ° .bashrc"
      lineinfile:
        path: "/home/{{ item.name }}/.bashrc"
        line: "source ~/.bashrc_custom"
        create: yes
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ app_users }}"
      when: not item.system | default(false)
      
    - name: "è®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡"
      copy:
        content: |
          # {{ item.name }} ä¸“ç”¨ç¯å¢ƒå˜é‡
          export USER_ROLE="{{ item.comment | default('User') }}"
          export WORKSPACE="/home/{{ item.name }}"
          
          {% if item.name == 'webdev' %}
          export NGINX_CONF_DIR="/etc/nginx"
          export WEB_ROOT="/var/www"
          export DEV_MODE="true"
          {% endif %}
          
          {% if item.name == 'deploy' %}
          export APP_DIR="/opt/apps"
          export LOG_DIR="/var/log/apps"
          export DEPLOY_ENV="production"
          {% endif %}
          
          {% if item.name == 'monitor' %}
          export MONITOR_TOOLS="/home/monitor/tools"
          export LOG_LEVEL="info"
          {% endif %}
        dest: "/home/{{ item.name }}/.profile_custom"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ app_users }}"
      when: not item.system | default(false)
      
    - name: "éªŒè¯ç”¨æˆ·åˆ›å»º"
      command: id {{ item.name }}
      register: user_verify
      loop: "{{ app_users }}"
      changed_when: false
      
    - name: "æ˜¾ç¤ºç”¨æˆ·éªŒè¯ç»“æœ"
      debug:
        msg: |
          ç”¨æˆ· {{ item.item.name }} éªŒè¯ç»“æœ:
          {{ item.stdout }}
      loop: "{{ user_verify.results }}"
      
    - name: "æ£€æŸ¥ç”¨æˆ·æƒé™"
      command: groups {{ item.name }}
      register: user_groups
      loop: "{{ app_users }}"
      changed_when: false
      
    - name: "æ˜¾ç¤ºç”¨æˆ·ç»„ä¿¡æ¯"
      debug:
        msg: "{{ item.stdout }}"
      loop: "{{ user_groups.results }}"
      
    - name: "ç”Ÿæˆç”¨æˆ·æŠ¥å‘Š"
      copy:
        content: |
          # ç”¨æˆ·ç®¡ç†æŠ¥å‘Š
          ç”Ÿæˆæ—¶é—´: {{ ansible_date_time.iso8601 }}
          ä¸»æœº: {{ inventory_hostname }}
          
          ## åˆ›å»ºçš„ç”¨æˆ·
          {% for user in app_users %}
          - ç”¨æˆ·å: {{ user.name }}
            æè¿°: {{ user.comment | default('æ— æè¿°') }}
            ç”¨æˆ·ç»„: {{ user.groups | default([]) | join(', ') }}
            Shell: {{ user.shell | default('/bin/bash') }}
            ç³»ç»Ÿç”¨æˆ·: {{ user.system | default(false) }}
            ä¸»ç›®å½•: /home/{{ user.name }}
          
          {% endfor %}
          
          ## SSH å¯†é’¥é…ç½®
          {% for key_user, key_value in ssh_keys.items() %}
          - {{ key_user }}: å·²é…ç½® SSH å…¬é’¥
          {% endfor %}
          
          ## ç›®å½•ç»“æ„
          - /opt/apps (éƒ¨ç½²ç›®å½•)
          - /var/log/apps (åº”ç”¨æ—¥å¿—)
          - /home/webdev/scripts (å¼€å‘è„šæœ¬)
          - /home/monitor/tools (ç›‘æ§å·¥å…·)
          
          ## Sudo æƒé™
          - å¼€å‘äººå‘˜: nginx æœåŠ¡ç®¡ç†, æ—¥å¿—æŸ¥çœ‹
          - éƒ¨ç½²äººå‘˜: æ‰€æœ‰æœåŠ¡ç®¡ç†
          - ç›‘æ§äººå‘˜: çŠ¶æ€æŸ¥çœ‹, è¿›ç¨‹ç›‘æ§
          
          ## æ³¨æ„äº‹é¡¹
          1. è¯·ä¸ºæ–°ç”¨æˆ·è®¾ç½®å¯†ç : sudo passwd <username>
          2. SSH å¯†é’¥å·²é…ç½®ï¼Œå¯ç›´æ¥è¿œç¨‹ç™»å½•
          3. è‡ªå®šä¹‰è„šæœ¬å·²æ·»åŠ åˆ° ~/.bashrc_custom
          4. ç¯å¢ƒå˜é‡é…ç½®åœ¨ ~/.profile_custom
        dest: "/tmp/user_management_report.md"
        mode: '0644'
        
    - name: "æ˜¾ç¤ºå®Œæˆä¿¡æ¯"
      debug:
        msg: |
          ğŸ‰ ç”¨æˆ·ç®¡ç†å®Œæˆï¼
          
          åˆ›å»ºçš„ç”¨æˆ·: {{ app_users | map(attribute='name') | join(', ') }}
          
          ä¸‹ä¸€æ­¥æ“ä½œ:
          1. ä¸ºç”¨æˆ·è®¾ç½®å¯†ç 
          2. æµ‹è¯• SSH ç™»å½•
          3. éªŒè¯ sudo æƒé™
          4. æŸ¥çœ‹æŠ¥å‘Š: cat /tmp/user_management_report.md
          
          å¿«é€Ÿæµ‹è¯•:
          sudo su - webdev
          sudo su - deploy
          sudo su - monitor 