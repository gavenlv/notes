---
# é«˜çº§æ¨¡æ¿æ¼”ç¤º Playbook
- name: "Jinja2 æ¨¡æ¿é«˜çº§åŠŸèƒ½æ¼”ç¤º"
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    # åº”ç”¨é…ç½®
    app_config:
      name: "AdvancedWebApp"
      version: "2.1.0"
      environment: "production"
      
    # ç”¨æˆ·é…ç½®
    users:
      - name: "alice"
        email: "alice@company.com"
        role: "admin"
        active: true
        department: "engineering"
        permissions:
          - "read"
          - "write"
          - "admin"
      - name: "bob"
        email: "bob@company.com"
        role: "developer"
        active: true
        department: "engineering"
        permissions:
          - "read"
          - "write"
      - name: "charlie"
        email: "charlie@company.com"
        role: "designer"
        active: false
        department: "design"
        permissions:
          - "read"
      - name: "diana"
        email: "diana@company.com"
        role: "manager"
        active: true
        department: "marketing"
        permissions:
          - "read"
          - "write"
          
    # æœåŠ¡å™¨é…ç½®
    servers:
      - hostname: "web01"
        ip: "192.168.1.10"
        role: "frontend"
        specs:
          cpu: 4
          memory: 8192
          disk: 500
        services:
          - "nginx"
          - "php-fpm"
      - hostname: "web02"
        ip: "192.168.1.11"
        role: "frontend"
        specs:
          cpu: 4
          memory: 8192
          disk: 500
        services:
          - "nginx"
          - "php-fpm"
      - hostname: "api01"
        ip: "192.168.1.20"
        role: "api"
        specs:
          cpu: 8
          memory: 16384
          disk: 1000
        services:
          - "nodejs"
          - "redis"
      - hostname: "db01"
        ip: "192.168.1.30"
        role: "database"
        specs:
          cpu: 8
          memory: 32768
          disk: 2000
        services:
          - "mysql"
          - "backup-agent"
          
    # ç½‘ç«™é…ç½®
    websites:
      - domain: "www.company.com"
        ssl: true
        locations:
          - path: "/"
            config:
              try_files: "$uri $uri/ /index.php?$query_string"
              expires: "1h"
          - path: "/api/"
            config:
              proxy_pass: "http://api-backend"
              proxy_set_header: "Host $host"
          - path: "/static/"
            config:
              expires: "1y"
              add_header: "Cache-Control public"
      - domain: "admin.company.com"
        ssl: true
        auth_required: true
        locations:
          - path: "/"
            config:
              try_files: "$uri $uri/ /admin.php?$query_string"
              
    # ç›‘æ§é…ç½®
    monitoring:
      enabled: true
      endpoints:
        - name: "health"
          path: "/health"
          check_interval: "30s"
        - name: "metrics"
          path: "/metrics"
          check_interval: "60s"
      alerts:
        - metric: "cpu_usage"
          threshold: 80
          severity: "warning"
        - metric: "memory_usage"
          threshold: 90
          severity: "critical"
        - metric: "disk_usage"
          threshold: 85
          severity: "warning"
          
  tasks:
    - name: "åˆ›å»ºé«˜çº§ Nginx é…ç½®æ–‡ä»¶"
      template:
        src: advanced-nginx.conf.j2
        dest: "/tmp/nginx_advanced_{{ ansible_date_time.epoch }}.conf"
        mode: '0644'
      vars:
        worker_processes: "{{ ansible_processor_vcpus }}"
        worker_connections: "{{ ansible_processor_vcpus * 1024 }}"
        
    - name: "ç”Ÿæˆç”¨æˆ·ç®¡ç†è„šæœ¬"
      template:
        src: user-management.sh.j2
        dest: "/tmp/user_management_{{ ansible_date_time.epoch }}.sh"
        mode: '0755'
        
    - name: "åˆ›å»ºæœåŠ¡å™¨æ¸…å•æ–‡æ¡£"
      template:
        src: server-inventory.md.j2
        dest: "/tmp/server_inventory_{{ ansible_date_time.epoch }}.md"
        mode: '0644'
        
    - name: "ç”Ÿæˆåº”ç”¨é…ç½®æ–‡ä»¶"
      template:
        src: app-config.yml.j2
        dest: "/tmp/app_config_{{ ansible_date_time.epoch }}.yml"
        mode: '0644'
        
    - name: "åˆ›å»ºç›‘æ§é…ç½®"
      template:
        src: monitoring-config.json.j2
        dest: "/tmp/monitoring_config_{{ ansible_date_time.epoch }}.json"
        mode: '0644'
        
    - name: "ç”Ÿæˆéƒ¨ç½²è„šæœ¬"
      template:
        src: deploy-script.sh.j2
        dest: "/tmp/deploy_script_{{ ansible_date_time.epoch }}.sh"
        mode: '0755'
      vars:
        deployment_user: "deploy"
        app_directory: "/opt/{{ app_config.name | lower }}"
        backup_directory: "/backup/{{ app_config.name | lower }}"
        
    - name: "åˆ›å»º Docker Compose æ–‡ä»¶"
      template:
        src: docker-compose.yml.j2
        dest: "/tmp/docker_compose_{{ ansible_date_time.epoch }}.yml"
        mode: '0644'
        
    - name: "ç”Ÿæˆç³»ç»ŸæœåŠ¡æ–‡ä»¶"
      template:
        src: systemd-service.j2
        dest: "/tmp/{{ app_config.name | lower }}.service"
        mode: '0644'
      vars:
        service_config:
          name: "{{ app_config.name | lower }}"
          description: "{{ app_config.name }} Application Service"
          user: "{{ app_config.name | lower }}"
          working_directory: "/opt/{{ app_config.name | lower }}"
          exec_start: "/opt/{{ app_config.name | lower }}/bin/start.sh"
          environment:
            NODE_ENV: "{{ app_config.environment }}"
            APP_VERSION: "{{ app_config.version }}"
            
    - name: "åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬"
      template:
        src: database-init.sql.j2
        dest: "/tmp/database_init_{{ ansible_date_time.epoch }}.sql"
        mode: '0644'
      vars:
        database_name: "{{ app_config.name | lower }}_{{ app_config.environment }}"
        admin_users: "{{ users | selectattr('role', 'equalto', 'admin') | list }}"
        
    - name: "ç”Ÿæˆ Ansible å˜é‡æ–‡ä»¶"
      template:
        src: generated-vars.yml.j2
        dest: "/tmp/generated_vars_{{ ansible_date_time.epoch }}.yml"
        mode: '0644'
        
    - name: "æ¼”ç¤º Jinja2 è¿‡æ»¤å™¨å’Œå‡½æ•°"
      debug:
        msg: |
          ========== Jinja2 è¿‡æ»¤å™¨æ¼”ç¤º ==========
          
          åŸå§‹åº”ç”¨å: {{ app_config.name }}
          å°å†™åº”ç”¨å: {{ app_config.name | lower }}
          å¤§å†™åº”ç”¨å: {{ app_config.name | upper }}
          åº”ç”¨åé•¿åº¦: {{ app_config.name | length }}
          
          æ´»è·ƒç”¨æˆ·æ•°: {{ users | selectattr('active') | list | length }}
          ç®¡ç†å‘˜ç”¨æˆ·: {{ users | selectattr('role', 'equalto', 'admin') | map(attribute='name') | join(', ') }}
          å·¥ç¨‹éƒ¨ç”¨æˆ·: {{ users | selectattr('department', 'equalto', 'engineering') | map(attribute='name') | list }}
          
          æœåŠ¡å™¨æ€»æ•°: {{ servers | length }}
          å‰ç«¯æœåŠ¡å™¨: {{ servers | selectattr('role', 'equalto', 'frontend') | map(attribute='hostname') | join(', ') }}
          æ€»å†…å­˜(GB): {{ servers | map(attribute='specs.memory') | sum / 1024 }}
          å¹³å‡CPUæ ¸æ•°: {{ servers | map(attribute='specs.cpu') | sum / servers | length }}
          
    - name: "åˆ›å»ºå¤æ‚æ¡ä»¶æ¨¡æ¿ç¤ºä¾‹"
      template:
        src: conditional-config.j2
        dest: "/tmp/conditional_config_{{ ansible_date_time.epoch }}.txt"
        mode: '0644'
      vars:
        features:
          ssl_enabled: true
          backup_enabled: true
          monitoring_enabled: true
          debug_mode: false
          
    - name: "æ˜¾ç¤ºç”Ÿæˆæ–‡ä»¶åˆ—è¡¨"
      debug:
        msg: |
          ğŸ‰ é«˜çº§æ¨¡æ¿æ¼”ç¤ºå®Œæˆï¼
          
          ç”Ÿæˆçš„æ–‡ä»¶:
          ğŸ“„ Nginx é…ç½®: /tmp/nginx_advanced_{{ ansible_date_time.epoch }}.conf
          ğŸ“œ ç”¨æˆ·ç®¡ç†è„šæœ¬: /tmp/user_management_{{ ansible_date_time.epoch }}.sh
          ğŸ“‹ æœåŠ¡å™¨æ¸…å•: /tmp/server_inventory_{{ ansible_date_time.epoch }}.md
          âš™ï¸ åº”ç”¨é…ç½®: /tmp/app_config_{{ ansible_date_time.epoch }}.yml
          ğŸ“Š ç›‘æ§é…ç½®: /tmp/monitoring_config_{{ ansible_date_time.epoch }}.json
          ğŸš€ éƒ¨ç½²è„šæœ¬: /tmp/deploy_script_{{ ansible_date_time.epoch }}.sh
          ğŸ³ Docker Compose: /tmp/docker_compose_{{ ansible_date_time.epoch }}.yml
          ğŸ”§ ç³»ç»ŸæœåŠ¡: /tmp/{{ app_config.name | lower }}.service
          ğŸ—ƒï¸ æ•°æ®åº“åˆå§‹åŒ–: /tmp/database_init_{{ ansible_date_time.epoch }}.sql
          ğŸ“ ç”Ÿæˆçš„å˜é‡: /tmp/generated_vars_{{ ansible_date_time.epoch }}.yml
          ğŸ”€ æ¡ä»¶é…ç½®ç¤ºä¾‹: /tmp/conditional_config_{{ ansible_date_time.epoch }}.txt
          
          é«˜çº§æ¨¡æ¿æŠ€æœ¯å±•ç¤º:
          âœ“ å¤æ‚å˜é‡å¤„ç†å’ŒåµŒå¥—è®¿é—®
          âœ“ æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ§åˆ¶
          âœ“ è¿‡æ»¤å™¨é“¾å¼ä½¿ç”¨
          âœ“ å®å®šä¹‰å’Œé‡ç”¨
          âœ“ æ•°æ®åˆ†ç»„å’Œç»Ÿè®¡
          âœ“ åŠ¨æ€é…ç½®ç”Ÿæˆ
          âœ“ å¤šæ ¼å¼æ–‡ä»¶ç”Ÿæˆ (YAML, JSON, Shell, SQL)
          
          å»ºè®®ä¸‹ä¸€æ­¥:
          1. æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          2. ç†è§£æ¨¡æ¿ä¸­çš„é€»è¾‘
          3. å°è¯•ä¿®æ”¹å˜é‡é‡æ–°ç”Ÿæˆ
          4. å­¦ä¹ æ›´å¤š Jinja2 è¿‡æ»¤å™¨ 