---
# 安全加固 Playbook 示例
# 使用 ansible-playbook security_hardening.yml --ask-vault-pass 运行

- name: System Security Hardening
  hosts: all
  become: yes
  vars_files:
    - ../examples/vault_example.yml
  tasks:
    # SSH 安全配置
    - name: Configure SSH security
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: Restart sshd

    # 防火墙配置
    - name: Install and configure UFW
      block:
        - name: Install UFW
          package:
            name: ufw
            state: present

        - name: Allow essential services
          ufw:
            rule: allow
            port: "{{ item.port }}"
            proto: "{{ item.proto | default('tcp') }}"
          loop:
            - { port: '22' }      # SSH
            - { port: '80' }      # HTTP
            - { port: '443' }     # HTTPS

        - name: Deny all incoming by default
          ufw:
            policy: deny
            direction: incoming

        - name: Enable UFW
          ufw:
            state: enabled

    # 用户管理
    - name: Create administrative users
      user:
        name: "{{ admin_user }}"
        password: "{{ admin_password | password_hash('sha512') }}"
        groups: sudo
        append: yes
        shell: /bin/bash
        create_home: yes
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa

    # 文件权限加固
    - name: Secure sensitive files
      file:
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/etc/passwd", mode: "0644" }
        - { path: "/etc/shadow", mode: "0640" }
        - { path: "/etc/group", mode: "0644" }
        - { path: "/etc/gshadow", mode: "0640" }

  handlers:
    - name: Restart sshd
      service:
        name: sshd
        state: restarted