#!/bin/bash
# PostgreSQL备份脚本

# 设置环境变量
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LANG=en_US.UTF-8
export PGPASSWORD="{{ postgresql_password }}"

# 备份配置
BACKUP_DIR="{{ backup_local_path }}/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
LOG_FILE="{{ backup_log_dir }}/postgresql_backup.log"

# 创建备份目录
mkdir -p ${BACKUP_DIR}
chown {{ backup_user }}:{{ backup_group }} ${BACKUP_DIR}

# 日志函数
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

# 开始备份
log_message "开始PostgreSQL备份"

# 备份所有数据库
{% if 'all' in postgresql_databases %}
{{ pg_dump_path }} -h {{ postgresql_host }} -p {{ postgresql_port }} -U {{ postgresql_user }} -w -F c -b -v -f ${BACKUP_DIR}/postgresql_all_${DATE}.dump
{% else %}
{% for db in postgresql_databases %}
{{ pg_dump_path }} -h {{ postgresql_host }} -p {{ postgresql_port }} -U {{ postgresql_user }} -w -F c -b -v -f ${BACKUP_DIR}/postgresql_{{ db }}_${DATE}.dump {{ db }}
{% endfor %}
{% endif %}

# 检查备份是否成功
if [ $? -eq 0 ]; then
    log_message "PostgreSQL备份成功完成"
    
    # 压缩备份文件
    {% if backup_compression_enabled %}
    {% if backup_compression_type == "gzip" %}
    gzip ${BACKUP_DIR}/postgresql_*.dump
    {% elif backup_compression_type == "bzip2" %}
    bzip2 ${BACKUP_DIR}/postgresql_*.dump
    {% elif backup_compression_type == "xz" %}
    xz ${BACKUP_DIR}/postgresql_*.dump
    {% endif %}
    {% endif %}
    
    # 加密备份文件
    {% if backup_encryption_enabled %}
    # TODO: 实现备份加密功能
    {% endif %}
else
    log_message "PostgreSQL备份失败"
    exit 1
fi

# 清理旧备份
find ${BACKUP_DIR} -name "postgresql_*.dump*" -mtime +{{ backup_retention_days }} -delete

log_message "PostgreSQL备份任务完成"