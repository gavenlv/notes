#!/bin/bash
# 文件备份脚本

# 设置环境变量
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LANG=en_US.UTF-8

# 备份配置
BACKUP_DIR="{{ backup_local_path }}/files"
DATE=$(date +%Y%m%d_%H%M%S)
LOG_FILE="{{ backup_log_dir }}/file_backup.log"

# 创建备份目录
mkdir -p ${BACKUP_DIR}
chown {{ backup_user }}:{{ backup_group }} ${BACKUP_DIR}

# 日志函数
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

# 开始备份
log_message "开始文件备份"

# 创建时间戳目录
TIMESTAMP_DIR=${BACKUP_DIR}/${DATE}
mkdir -p ${TIMESTAMP_DIR}
chown {{ backup_user }}:{{ backup_group }} ${TIMESTAMP_DIR}

# 备份指定路径
{% for path in file_backup_paths %}
# 备份 {{ path }}
if [ -d "{{ path }}" ] || [ -f "{{ path }}" ]; then
    rsync -av --delete {{ path }} ${TIMESTAMP_DIR}/
    if [ $? -ne 0 ]; then
        log_message "备份 {{ path }} 失败"
    else
        log_message "备份 {{ path }} 成功"
    fi
else
    log_message "路径 {{ path }} 不存在，跳过备份"
fi
{% endfor %}

# 检查备份是否成功
if [ $? -eq 0 ]; then
    log_message "文件备份成功完成"
    
    # 压缩备份文件
    {% if backup_compression_enabled %}
    cd ${BACKUP_DIR}
    {% if backup_compression_type == "gzip" %}
    tar -czf files_${DATE}.tar.gz ${DATE}
    {% elif backup_compression_type == "bzip2" %}
    tar -cjf files_${DATE}.tar.bz2 ${DATE}
    {% elif backup_compression_type == "xz" %}
    tar -cJf files_${DATE}.tar.xz ${DATE}
    {% endif %}
    
    # 删除未压缩的备份目录
    rm -rf ${DATE}
    {% endif %}
    
    # 加密备份文件
    {% if backup_encryption_enabled %}
    # TODO: 实现备份加密功能
    {% endif %}
else
    log_message "文件备份失败"
    exit 1
fi

# 清理旧备份
find ${BACKUP_DIR} -name "${DATE}" -o -name "files_*.tar.*" -mtime +{{ backup_retention_days }} -delete

log_message "文件备份任务完成"