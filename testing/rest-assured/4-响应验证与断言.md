# 第4章：响应验证与断言

## 4.1 响应验证基础

### 4.1.1 响应规范详解

响应规范(ResponseSpecification)是REST Assured中用于重用响应验证逻辑的强大工具：

```java
// 创建基础响应规范
ResponseSpecification basicResponseSpec = new ResponseSpecBuilder()
    .expectStatusCode(200)
    .expectContentType(ContentType.JSON)
    .expectHeader("Server", notNullValue())
    .expectHeader("X-API-Version", notNullValue())
    .expectTime(lessThan(3000L))  // 响应时间小于3秒
    .build();

// 创建成功响应规范
ResponseSpecification successResponseSpec = new ResponseSpecBuilder()
    .expectStatusCode(200)
    .expectContentType(ContentType.JSON)
    .expectHeader("X-Status", "success")
    .expectBody("status", equalTo("success"))
    .expectBody("data", notNullValue())
    .expectBody("message", notNullValue())
    .build();

// 创建错误响应规范
ResponseSpecification errorResponseSpec = new ResponseSpecBuilder()
    .expectStatusCode(anyOf(equalTo(400), equalTo(401), equalTo(403), equalTo(404), equalTo(500)))
    .expectContentType(ContentType.JSON)
    .expectBody("status", equalTo("error"))
    .expectBody("error", notNullValue())
    .expectBody("error.code", notNullValue())
    .expectBody("error.message", notNullValue())
    .build();
```

### 4.1.2 响应验证链

REST Assured支持链式响应验证，使代码更加清晰和可读：

```java
// 链式验证示例
given()
    .header("Authorization", "Bearer token123")
    .queryParam("userId", 123)
.when()
    .get("/api/users/123")
.then()
    .statusCode(200)
    .statusLine("HTTP/1.1 200 OK")
    .contentType(ContentType.JSON)
    .header("Server", containsString("nginx"))
    .header("X-Rate-Limit-Remaining", greaterThan(0))
    .cookie("SESSIONID", notNullValue())
    .body("id", equalTo(123))
    .body("name", notNullValue())
    .body("email", containsString("@"))
    .body("address.city", notNullValue())
    .time(lessThan(2000L));

// 嵌套验证
given()
    .pathParam("userId", 123)
.when()
    .get("/api/users/{userId}")
.then()
    .statusCode(200)
    .body("id", equalTo(123))
    .body("profile", notNullValue())
    .body("profile.firstName", notNullValue())
    .body("profile.lastName", notNullValue())
    .body("profile.contact", notNullValue())
    .body("profile.contact.email", containsString("@"))
    .body("profile.contact.phone", matchesPattern("\\+?\\d{10,15}"));
```

### 4.1.3 响应条件验证

REST Assured支持基于条件的响应验证：

```java
// 条件性状态码验证
@Test
public void testConditionalStatusCode() {
    Response response = given()
        .pathParam("userId", 123)
    .when()
        .get("/api/users/{userId}")
    .then()
    .extract().response();
    
    // 根据响应内容进行不同验证
    if (response.jsonPath().getBoolean("active")) {
        response.then()
            .body("lastLoginDate", notNullValue())
            .body("loginCount", greaterThan(0));
    } else {
        response.then()
            .body("deactivationDate", notNullValue())
            .body("reason", notNullValue());
    }
}

// 动态响应验证
@Test
public void testDynamicResponseValidation() {
    User user = getRandomUser();  // 获取随机用户
    
    Response response = given()
        .pathParam("userId", user.getId())
    .when()
        .get("/api/users/{userId}")
    .then()
    .extract().response();
    
    // 根据用户类型进行不同验证
    String userType = response.jsonPath().getString("type");
    switch (userType) {
        case "premium":
            response.then()
                .body("subscription", notNullValue())
                .body("subscription.plan", notNullValue())
                .body("subscription.expiryDate", notNullValue());
            break;
        case "basic":
            response.then()
                .body("subscription", nullValue())
                .body("adsEnabled", equalTo(true));
            break;
        case "admin":
            response.then()
                .body("permissions", notNullValue())
                .body("permissions.size()", greaterThan(0));
            break;
        default:
            response.then()
                .body("type", notNullValue());
            break;
    }
}
```

## 4.2 状态码与状态行验证

### 4.2.1 状态码验证详解

```java
// 精确状态码匹配
.then().statusCode(200);

// 状态码范围验证
.then().statusCode(lessThan(300));          // 2xx成功状态码
.then().statusCode(allOf(greaterThanOrEqualTo(200), lessThan(300)));  // 2xx状态码
.then().statusCode(anyOf(equalTo(200), equalTo(201), equalTo(202)));  // 特定状态码之一

// 状态码逻辑验证
.then().statusCode(not(equalTo(404)));      // 不是404
.then().statusCode(equalTo(200).or(equalTo(201)));  // 200或201

// 使用自定义匹配器
public static Matcher<Integer> isSuccessStatusCode() {
    return new CustomMatcher<Integer>("Is a success status code") {
        @Override
        public boolean matches(Object item) {
            Integer statusCode = (Integer) item;
            return statusCode >= 200 && statusCode < 300;
        }
    };
}

.then().statusCode(isSuccessStatusCode());

// 基于业务逻辑的状态码验证
@Test
public void testBusinessStatusCodeValidation() {
    given()
        .body(createUserRequest())
    .when()
        .post("/api/users")
    .then()
        .body("id", notNullValue(), 
            "Expected user ID to be present for successful creation")
        .statusCode(201, 
            "Expected status 201 for successful user creation");
}

// 条件性状态码验证
@Test
public void testConditionalStatusCode() {
    String operationType = "create";  // 从测试数据或参数获取
    
    given()
        .body(createOperationRequest(operationType))
    .when()
        .post("/api/operations")
    .then()
        .statusCode(operationType.equals("create") ? 201 : 200);
}
```

### 4.2.2 状态行验证

```java
// 精确状态行匹配
.then().statusLine("HTTP/1.1 200 OK");

// 状态行部分匹配
.then().statusLine(containsString("OK"));
.then().statusLine(startsWith("HTTP/1.1"));
.then().statusLine(endsWith("OK"));

// 使用正则表达式匹配状态行
.then().statusLine(matchesPattern("HTTP/1\\.1 \\d{3} .*"));

// 自定义状态行验证器
public static Matcher<String> hasValidStatusLine() {
    return new CustomMatcher<String>("Has valid HTTP status line") {
        @Override
        public boolean matches(Object item) {
            String statusLine = (String) item;
            return statusLine != null && 
                   statusLine.matches("HTTP/\\d\\.\\d \\d{3} .*");
        }
    };
}

.then().statusLine(hasValidStatusLine());

// 状态行与状态码一致性验证
@Test
public void testStatusLineConsistency() {
    Response response = given()
        .get("/api/resource")
    .then()
    .extract().response();
    
    int statusCode = response.getStatusCode();
    String statusLine = response.getStatusLine();
    
    // 验证状态行中的状态码与实际状态码一致
    assertTrue(statusLine.contains(String.valueOf(statusCode)),
        "Status line should contain the actual status code: " + statusLine);
    
    // 验证状态行格式
    assertTrue(statusLine.matches("HTTP/1\\.1 " + statusCode + " .*"),
        "Status line format should be: HTTP/1.1 " + statusCode + " <reason phrase>");
}
```

## 4.3 响应头验证

### 4.3.1 响应头基础验证

```java
// 验证单个响应头
.then().header("Content-Type", "application/json");
.then().header("Content-Length", "1024");
.then().header("Cache-Control", containsString("max-age"));
.then().header("X-API-Version", notNullValue());

// 验证多个响应头
.then()
    .header("Content-Type", "application/json")
    .header("Server", notNullValue())
    .header("X-Rate-Limit-Limit", notNullValue())
    .header("X-Rate-Limit-Remaining", notNullValue())
    .header("X-Request-ID", notNullValue());

// 验证响应头不存在
.then().header("X-Deprecated", nullValue());

// 验证响应头数值
.then().header("X-Rate-Limit-Limit", Integer::parseInt, greaterThan(100));
.then().header("Retry-After", Integer::parseInt, greaterThan(0));

// 验证响应头日期
Date now = new Date();
.then().header("Date", greaterThan(new Date(now.getTime() - 60000)));  // 不超过1分钟前
.then().header("Expires", greaterThan(now));  // 过期时间在未来
```

### 4.3.2 复杂响应头验证

```java
// 多值响应头验证
.then().header("Accept-Ranges", hasItems("bytes", "none"));
.then().header("Allow", hasItems("GET", "POST", "PUT", "DELETE"));

// 条件性响应头验证
@Test
public void testConditionalHeaderValidation() {
    Response response = given()
        .get("/api/data")
    .then()
    .extract().response();
    
    // 验证CORS头（仅在需要时）
    String origin = requestSpecification.getHeaders().getValue("Origin");
    if (origin != null) {
        response.then()
            .header("Access-Control-Allow-Origin", containsString(origin))
            .header("Access-Control-Allow-Methods", hasItem("GET"))
            .header("Access-Control-Allow-Credentials", "true");
    }
    
    // 验证缓存头（仅对可缓存资源）
    if (response.getStatusCode() == 200) {
        response.then()
            .header("Cache-Control", containsString("max-age"));
    }
}

// 响应头集合验证
@Test
public void testHeaderCollectionValidation() {
    Response response = given()
        .get("/api/secure/resource")
    .then()
    .extract().response();
    
    Headers headers = response.getHeaders();
    
    // 验证必需的安全头
    Set<String> requiredSecurityHeaders = new HashSet<>(Arrays.asList(
        "X-Content-Type-Options",
        "X-Frame-Options",
        "X-XSS-Protection",
        "Strict-Transport-Security"
    ));
    
    for (String headerName : requiredSecurityHeaders) {
        assertTrue(headers.hasHeaderWithName(headerName),
            "Missing required security header: " + headerName);
    }
    
    // 验证响应头值不包含敏感信息
    for (Header header : headers) {
        assertFalse(header.getValue().toLowerCase().contains("password"),
            "Header should not contain sensitive information: " + header.getName());
    }
}

// 自定义响应头匹配器
public static Matcher<String> hasValidApiVersion() {
    return new CustomMatcher<String>("Has valid API version") {
        @Override
        public boolean matches(Object item) {
            String version = (String) item;
            return version != null && version.matches("\\d+\\.\\d+(\\.\\d+)?");
        }
    };
}

.then().header("X-API-Version", hasValidApiVersion());

// 验证响应头完整性
@Test
public void testHeaderIntegrity() {
    // 获取请求签名
    String requestSignature = generateRequestSignature();
    
    // 发送请求
    Response response = given()
        .header("X-Request-Signature", requestSignature)
    .when()
        .get("/api/secure-data")
    .then()
    .extract().response();
    
    // 验证响应签名
    String responseBody = response.getBody().asString();
    String responseSignature = response.getHeader("X-Response-Signature");
    
    String expectedSignature = calculateSignature(responseBody);
    assertEquals(expectedSignature, responseSignature,
        "Response signature should match calculated signature");
}
```

## 4.4 Cookie验证

### 4.4.1 Cookie基础验证

```java
// 验证Cookie值
.then().cookie("sessionId", "abc123");
.then().cookie("theme", "dark");
.then().cookie("language", "en-US");

// 验证Cookie存在
.then().cookie("userToken", notNullValue());
.then().cookie("rememberMe", notNullValue());

// 验证Cookie属性
.then()
    .cookie("sessionId", hasValue("abc123"))
    .cookie("sessionId", hasKey("Path"))
    .cookie("sessionId", hasKey("Domain"))
    .cookie("sessionId", hasKey("Secure"))
    .cookie("sessionId", hasKey("HttpOnly"))
    .cookie("sessionId", hasKey("SameSite"));

// 验证Cookie安全性
@Test
public void testSecureCookieValidation() {
    given()
        .when()
        .post("/login")
    .then()
        .cookie("JSESSIONID", hasValue(notNullValue()))
        .cookie("JSESSIONID", hasKey("Secure"))
        .cookie("JSESSIONID", hasKey("HttpOnly"))
        .cookie("JSESSIONID", hasKey("Path"))
        .cookie("JSESSIONID", hasKey("SameSite"));
}
```

### 4.4.2 高级Cookie验证

```java
// 获取Cookie详细信息
DetailedCookie cookie = get("/login").then().extract().detailedCookie("sessionId");

String cookieValue = cookie.getValue();
String domain = cookie.getDomain();
String path = cookie.getPath();
Date expiryDate = cookie.getExpiryDate();
boolean isSecure = cookie.isSecure();
boolean isHttpOnly = cookie.isHttpOnly();
String sameSite = cookie.getSameSite();

// Cookie有效性验证
@Test
public void testCookieValidity() {
    DetailedCookie sessionCookie = given()
        .formParam("username", "user")
        .formParam("password", "pass")
    .when()
        .post("/login")
    .then()
        .cookie("sessionId", notNullValue())
    .extract()
    .detailedCookie("sessionId");
    
    // 验证Cookie值不为空
    assertNotNull(sessionCookie.getValue(), "Session ID should not be null");
    assertFalse(sessionCookie.getValue().isEmpty(), "Session ID should not be empty");
    
    // 验证Cookie安全性
    assertTrue(sessionCookie.isSecure(), "Session cookie should be secure");
    assertTrue(sessionCookie.isHttpOnly(), "Session cookie should be HttpOnly");
    
    // 验证Cookie路径
    assertEquals("/", sessionCookie.getPath(), "Cookie path should be root");
    
    // 验证Cookie过期时间（如果设置了）
    if (sessionCookie.getExpiryDate() != null) {
        assertTrue(sessionCookie.getExpiryDate().after(new Date()),
            "Cookie expiry date should be in the future");
    }
}

// Cookie会话管理验证
@Test
public void testCookieSessionManagement() {
    // 登录并获取会话Cookie
    Response loginResponse = given()
        .formParam("username", "user")
        .formParam("password", "pass")
    .when()
        .post("/login")
    .then()
        .statusCode(200)
        .cookie("sessionId", notNullValue())
    .extract()
    .response();
    
    String sessionId = loginResponse.getCookie("sessionId");
    
    // 使用Cookie访问受保护资源
    given()
        .cookie("sessionId", sessionId)
    .when()
        .get("/api/protected")
    .then()
        .statusCode(200);
    
    // 验证Cookie在多次请求中保持一致
    Response anotherRequest = given()
        .cookie("sessionId", sessionId)
    .when()
        .get("/api/another-protected")
    .then()
        .statusCode(200)
    .extract()
    .response();
    
    // 验证会话仍然有效
    assertEquals(sessionId, anotherRequest.getCookie("sessionId"));
    
    // 登出并验证Cookie失效
    given()
        .cookie("sessionId", sessionId)
    .when()
        .post("/logout")
    .then()
        .statusCode(200);
    
    // 验证Cookie失效
    given()
        .cookie("sessionId", sessionId)
    .when()
        .get("/api/protected")
    .then()
        .statusCode(401);
}
```

## 4.5 响应体验证

### 4.5.1 JSON响应体验证

```java
// 基本字段验证
.then()
    .body("name", equalTo("John Doe"))
    .body("age", equalTo(30))
    .body("email", containsString("@"))
    .body("active", equalTo(true))
    .body("balance", closeTo(1000.0, 0.01));

// 嵌套对象验证
.then()
    .body("address.street", equalTo("123 Main St"))
    .body("address.city", equalTo("New York"))
    .body("address.zipCode", equalTo("10001"))
    .body("address.coordinates.latitude", closeTo(40.7128, 0.0001));

// 数组验证
.then()
    .body("users", hasSize(10))
    .body("users[0].name", equalTo("Alice"))
    .body("users[1].age", greaterThan(18))
    .body("users[*].email", everyItem(containsString("@")));

// 数组元素验证
.then()
    .body("users[*].name", hasItems("Alice", "Bob", "Charlie"))
    .body("users[*].age", everyItem(greaterThan(0)))
    .body("users[?(@.age > 30)]", hasSize(2));

// JSONPath表达式验证
.then()
    .body("users[?(@.name == 'John')].age", equalTo(30))
    .body("users[?(@.age > 25)]", hasSize(greaterThan(0)))
    .body("$.users[?(@.active == true)]", hasSize(greaterThan(0)));

// 条件性JSON验证
@Test
public void testConditionalJsonValidation() {
    Response response = given()
        .pathParam("userId", 123)
    .when()
        .get("/api/users/{userId}")
    .then()
    .extract()
    .response();
    
    // 获取用户类型
    String userType = response.jsonPath().getString("type");
    
    // 根据类型进行不同验证
    if ("premium".equals(userType)) {
        response.then()
            .body("subscription", notNullValue())
            .body("subscription.plan", notNullValue())
            .body("subscription.expiryDate", notNullValue())
            .body("features", hasSize(greaterThan(0)));
    } else if ("basic".equals(userType)) {
        response.then()
            .body("subscription", nullValue())
            .body("adsEnabled", equalTo(true));
    }
}

// 复杂数据结构验证
@Test
public void testComplexDataStructureValidation() {
    given()
        .queryParam("include", "details")
    .when()
        .get("/api/products/123")
    .then()
        .statusCode(200)
        .body("id", equalTo(123))
        .body("name", notNullValue())
        .body("price", greaterThan(0.0))
        .body("categories", notNullValue())
        .body("categories.size()", greaterThan(0))
        .body("categories[*].name", everyItem(notNullValue()))
        .body("specifications", notNullValue())
        .body("specifications.dimensions", notNullValue())
        .body("specifications.dimensions.width", greaterThan(0))
        .body("specifications.dimensions.height", greaterThan(0))
        .body("specifications.dimensions.length", greaterThan(0))
        .body("images", notNullValue())
        .body("images.size()", greaterThan(0))
        .body("images[*].url", everyItem(matchesPattern("^https?://.*\\.(jpg|png|jpeg)$")))
        .body("reviews", notNullValue())
        .body("reviews.size()", greaterThanOrEqualTo(0))
        .body("reviews[*].rating", everyItem(allOf(greaterThanOrEqualTo(1), lessThanOrEqualTo(5))))
        .body("reviews[*].comment", everyItem(notNullValue()));
}
```

### 4.5.2 XML响应体验证

```java
// XML元素验证
.then()
    .body("user.name", equalTo("John Doe"))
    .body("user.age", equalTo("30"))
    .body("user.email", containsString("@"))
    .body("user.active", equalTo("true"));

// 使用XPath验证
.then()
    .body(hasXPath("/user/name", equalTo("John Doe")))
    .body(hasXPath("/user/address/city", equalTo("New York")))
    .body(hasXPath("//email[contains(text(), '@')]")));

// XML属性验证
.then()
    .body("user.@id", equalTo("123"))
    .body("user.@status", equalTo("active"))
    .body("user.address.@verified", equalTo("true"));

// 命名空间处理
.then()
    .body(hasXPath("//ns:user/ns:name", 
        namespace("ns", "http://example.com/namespace"),
        equalTo("John")))
    .body(hasXPath("//x:user/@id",
        namespace("x", "http://example.com/user"),
        equalTo("123")));

// XML数组验证
.then()
    .body(hasXPath("//users/user", hasSize(10)))
    .body(hasXPath("//users/user[position()=1]/name", equalTo("Alice")))
    .body(hasXPath("//users/user[age > 30]", hasSize(greaterThan(0))));
```

### 4.5.3 响应体类型与格式验证

```java
// 类型验证
.then()
    .body("name", instanceOf(String.class))
    .body("age", instanceOf(Integer.class))
    .body("active", instanceOf(Boolean.class))
    .body("balance", instanceOf(Number.class));

// 数值精度验证
.then()
    .body("price", closeTo(19.99, 0.01))
    .body("tax", closeTo(1.60, 0.01))
    .body("total", closeTo(21.59, 0.01));

// 字符串格式验证
.then()
    .body("email", matchesPattern("[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"))
    .body("phone", matchesPattern("\\+?\\d{10,15}"))
    .body("zipCode", matchesPattern("\\d{5}(-\\d{4})?"))
    .body("website", matchesPattern("^https?://.*"));

// 日期格式验证
.then()
    .body("createdAt", matchesPattern("\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.?\\d*Z?"))
    .body("birthday", matchesPattern("\\d{4}-\\d{2}-\\d{2}"));

// 自定义格式验证器
public static Matcher<String> isValidUuid() {
    return new CustomMatcher<String>("Is a valid UUID") {
        @Override
        public boolean matches(Object item) {
            String uuid = (String) item;
            return uuid != null && uuid.matches(
                "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            );
        }
    };
}

.then().body("id", isValidUuid());

// 响应体完整性验证
@Test
public void testResponseBodyIntegrity() {
    Response response = given()
        .get("/api/users/123")
    .then()
    .extract()
    .response();
    
    // 获取响应内容
    String responseBody = response.getBody().asString();
    String contentMd5 = response.getHeader("Content-MD5");
    
    // 验证内容完整性（如果提供了MD5头）
    if (contentMd5 != null) {
        String calculatedMd5 = calculateMd5(responseBody);
        assertEquals(contentMd5, calculatedMd5,
            "Response content MD5 should match header value");
    }
    
    // 验证JSON格式有效性
    try {
        JsonPath jsonPath = new JsonPath(responseBody);
        // 如果解析成功，JSON格式有效
    } catch (Exception e) {
        fail("Response body should be valid JSON: " + e.getMessage());
    }
}
```

## 4.6 自定义断言

### 4.6.1 Hamcrest自定义匹配器

```java
// 自定义数值范围匹配器
public static class InRangeMatcher extends TypeSafeMatcher<Double> {
    private final double min;
    private final double max;
    
    public InRangeMatcher(double min, double max) {
        this.min = min;
        this.max = max;
    }
    
    @Override
    protected boolean matchesSafely(Double value) {
        return value >= min && value <= max;
    }
    
    @Override
    public void describeTo(Description description) {
        description.appendText("a value between ")
            .appendValue(min)
            .appendText(" and ")
            .appendValue(max);
    }
    
    public static Matcher<Double> inRange(double min, double max) {
        return new InRangeMatcher(min, max);
    }
}

// 使用自定义匹配器
.then().body("price", inRange(10.0, 50.0));

// 自定义集合大小匹配器
public static class CollectionSizeMatcher extends TypeSafeMatcher<Integer> {
    private final int expectedSize;
    private final int tolerance;
    
    public CollectionSizeMatcher(int expectedSize, int tolerance) {
        this.expectedSize = expectedSize;
        this.tolerance = tolerance;
    }
    
    @Override
    protected boolean matchesSafely(Integer actualSize) {
        return Math.abs(actualSize - expectedSize) <= tolerance;
    }
    
    @Override
    public void describeTo(Description description) {
        description.appendText("a collection size approximately ")
            .appendValue(expectedSize)
            .appendText(" with tolerance ")
            .appendValue(tolerance);
    }
    
    public static Matcher<Integer> hasApproximateSize(int expectedSize, int tolerance) {
        return new CollectionSizeMatcher(expectedSize, tolerance);
    }
}

// 自定义业务规则匹配器
public static class ValidUserStatusMatcher extends TypeSafeMatcher<String> {
    private static final Set<String> VALID_STATUSES = 
        new HashSet<>(Arrays.asList("active", "inactive", "suspended", "pending"));
    
    @Override
    protected boolean matchesSafely(String status) {
        return VALID_STATUSES.contains(status);
    }
    
    @Override
    public void describeTo(Description description) {
        description.appendText("a valid user status from ")
            .appendValue(VALID_STATUSES);
    }
    
    public static Matcher<String> isValidUserStatus() {
        return new ValidUserStatusMatcher();
    }
}

// 使用自定义业务规则匹配器
.then().body("status", isValidUserStatus());
```

### 4.6.2 响应验证器

```java
// 实现ResponseAssertionCallback接口
public class ApiResponseValidator implements ResponseAssertionCallback {
    private final String expectedApiVersion;
    
    public ApiResponseValidator(String expectedApiVersion) {
        this.expectedApiVersion = expectedApiVersion;
    }
    
    @Override
    public void assertResponse(Response response, LogDetail logDetail) throws AssertionError {
        // 验证状态码
        assertTrue(response.getStatusCode() >= 200 && response.getStatusCode() < 300,
            "API response should have success status code");
        
        // 验证内容类型
        assertTrue(response.getContentType().contains("application/json"),
            "API response should be JSON");
        
        // 验证API版本
        String apiVersion = response.getHeader("X-API-Version");
        assertEquals(expectedApiVersion, apiVersion,
            "API version should match expected version");
        
        // 验证响应结构
        JsonPath jsonPath = response.jsonPath();
        assertTrue(jsonPath.getMap("$").containsKey("data"),
            "API response should contain data field");
        assertTrue(jsonPath.getMap("$").containsKey("status"),
            "API response should contain status field");
        
        // 验证响应时间
        assertTrue(response.getTime() < 5000,
            "API response time should be less than 5 seconds");
    }
}

// 使用自定义验证器
@Test
public void testWithCustomValidator() {
    given()
        .header("Authorization", "Bearer token123")
    .when()
        .get("/api/users")
    .then()
    .assertThat()
    .response(new ApiResponseValidator("1.0"));
}
```

## 4.7 响应数据提取与验证

### 4.7.1 提取数据用于后续验证

```java
// 提取响应数据用于后续请求
@Test
public void testExtractAndReuseData() {
    // 1. 获取用户列表
    String firstUserId = given()
        .queryParam("limit", 1)
    .when()
        .get("/api/users")
    .then()
        .statusCode(200)
        .body("users", hasSize(greaterThan(0)))
    .extract()
    .path("users[0].id");
    
    // 2. 使用提取的ID获取用户详情
    given()
        .pathParam("userId", firstUserId)
    .when()
        .get("/api/users/{userId}")
    .then()
        .statusCode(200)
        .body("id", equalTo(firstUserId));
    
    // 3. 提取用户邮箱用于后续操作
    String userEmail = given()
        .pathParam("userId", firstUserId)
    .when()
        .get("/api/users/{userId}")
    .then()
        .statusCode(200)
    .extract()
    .path("email");
    
    // 4. 使用提取的邮箱进行密码重置
    given()
        .contentType(ContentType.JSON)
        .body("{\"email\": \"" + userEmail + "\"}")
    .when()
        .post("/api/password-reset")
    .then()
        .statusCode(200);
}

// 提取复杂嵌套数据
@Test
public void testExtractComplexData() {
    // 提取整个用户对象
    User user = given()
        .pathParam("userId", 123)
    .when()
        .get("/api/users/{userId}")
    .then()
        .statusCode(200)
    .extract()
    .as(User.class);
    
    // 验证用户对象
    assertNotNull(user.getId());
    assertNotNull(user.getName());
    assertNotNull(user.getEmail());
    
    // 提取用户地址
    Address address = user.getAddress();
    assertNotNull(address);
    assertNotNull(address.getCity());
    
    // 提取用户的权限列表
    List<Permission> permissions = given()
        .pathParam("userId", 123)
    .when()
        .get("/api/users/{userId}/permissions")
    .then()
        .statusCode(200)
    .extract()
    .jsonPath()
    .getList(".", Permission.class);
    
    // 验证权限
    assertTrue(permissions.size() > 0);
    for (Permission permission : permissions) {
        assertNotNull(permission.getName());
        assertNotNull(permission.getResource());
    }
}
```

### 4.7.2 条件性验证

```java
// 基于响应数据的条件验证
@Test
public void testConditionalValidation() {
    Response response = given()
        .get("/api/products/123")
    .then()
        .statusCode(200)
    .extract()
    .response();
    
    // 获取产品类型
    String productType = response.jsonPath().getString("type");
    
    // 根据产品类型进行不同验证
    if ("digital".equals(productType)) {
        response.then()
            .body("downloadUrl", notNullValue())
            .body("fileSize", greaterThan(0))
            .body("fileFormat", oneOf("PDF", "EPUB", "MOBI"));
    } else if ("physical".equals(productType)) {
        response.then()
            .body("dimensions", notNullValue())
            .body("weight", greaterThan(0))
            .body("shippingInfo", notNullValue());
    }
    
    // 获取产品状态
    String status = response.jsonPath().getString("status");
    
    // 根据状态进行不同验证
    if ("available".equals(status)) {
        response.then()
            .body("stock", greaterThan(0))
            .body("price", greaterThan(0));
    } else if ("out_of_stock".equals(status)) {
        response.then()
            .body("stock", equalTo(0))
            .body("restockDate", notNullValue());
    }
}

// 基于环境变量的条件验证
@Test
public void testEnvironmentBasedValidation() {
    String environment = System.getProperty("test.environment", "development");
    
    Response response = given()
        .get("/api/config")
    .then()
        .statusCode(200)
    .extract()
    .response();
    
    // 根据环境验证不同的配置
    switch (environment) {
        case "production":
            response.then()
                .body("debug", equalTo(false))
                .body("apiBaseUrl", containsString("https://api.example.com"))
                .body("timeout", lessThan(5000));
            break;
        case "staging":
            response.then()
                .body("debug", equalTo(false))
                .body("apiBaseUrl", containsString("https://staging-api.example.com"))
                .body("timeout", lessThan(10000));
            break;
        case "development":
            response.then()
                .body("debug", equalTo(true))
                .body("apiBaseUrl", containsString("http://localhost"))
                .body("timeout", lessThan(30000));
            break;
    }
}
```

## 4.8 错误响应验证

### 4.8.1 错误响应结构验证

```java
// 标准错误响应结构
@Test
public void testStandardErrorResponse() {
    given()
        .pathParam("userId", 99999)  // 不存在的用户ID
    .when()
        .get("/api/users/{userId}")
    .then()
        .statusCode(404)
        .contentType(ContentType.JSON)
        .body("status", equalTo("error"))
        .body("error", notNullValue())
        .body("error.code", equalTo("USER_NOT_FOUND"))
        .body("error.message", notNullValue())
        .body("error.message", containsString("not found"))
        .body("error.timestamp", notNullValue())
        .body("error.path", endsWith("/api/users/99999"));
}

// 多种错误场景验证
@Test
public void testMultipleErrorScenarios() {
    // 测试认证错误
    given()
        .when()
        .get("/api/protected")
    .then()
        .statusCode(401)
        .body("error.code", equalTo("UNAUTHORIZED"))
        .body("error.message", containsString("authentication"));
    
    // 测试权限错误
    given()
        .header("Authorization", "Bearer invalid_token")
    .when()
        .delete("/api/admin/users/123")
    .then()
        .statusCode(403)
        .body("error.code", equalTo("FORBIDDEN"))
        .body("error.message", containsString("permission"));
    
    // 测试验证错误
    given()
        .contentType(ContentType.JSON)
        .body("{\"email\": \"invalid-email\", \"age\": -5}")
    .when()
        .post("/api/users")
    .then()
        .statusCode(400)
        .body("error.code", equalTo("VALIDATION_ERROR"))
        .body("error.message", containsString("validation"))
        .body("error.details", notNullValue())
        .body("error.details.size()", greaterThan(0));
}
```

### 4.8.2 错误响应数据验证

```java
// 验证错误代码枚举
@Test
public void testErrorCodeValidation() {
    Set<String> validErrorCodes = new HashSet<>(Arrays.asList(
        "VALIDATION_ERROR", "UNAUTHORIZED", "FORBIDDEN", "NOT_FOUND",
        "CONFLICT", "RATE_LIMIT_EXCEEDED", "INTERNAL_SERVER_ERROR"
    ));
    
    Response response = given()
        .get("/api/trigger-error")
    .then()
        .statusCode(anyOf(equalTo(400), equalTo(401), equalTo(403), 
                         equalTo(404), equalTo(409), equalTo(429), equalTo(500)))
    .extract()
    .response();
    
    String errorCode = response.jsonPath().getString("error.code");
    assertTrue(validErrorCodes.contains(errorCode),
        "Error code should be one of the valid error codes");
}

// 错误消息内容验证
@Test
public void testErrorMessageContent() {
    Response response = given()
        .get("/api/nonexistent-endpoint")
    .then()
        .statusCode(404)
    .extract()
    .response();
    
    String errorMessage = response.jsonPath().getString("error.message");
    
    // 验证错误消息不包含敏感信息
    assertFalse(errorMessage.toLowerCase().contains("password"),
        "Error message should not contain sensitive information");
    assertFalse(errorMessage.toLowerCase().contains("token"),
        "Error message should not contain token information");
    assertFalse(errorMessage.contains("stack trace"),
        "Error message should not contain stack trace");
    
    // 验证错误消息适合用户理解
    assertFalse(errorMessage.isEmpty(),
        "Error message should not be empty");
    assertTrue(errorMessage.length() < 500,
        "Error message should be concise");
}
```

## 4.9 实践练习

### 练习1：复杂响应验证

创建一个测试，验证API返回的复杂JSON结构，包括：
- 嵌套对象
- 数组和对象组合
- 条件性字段
- 多种数据类型

### 练习2：自定义断言实现

实现一个自定义匹配器，用于验证：
- 邮箱格式
- 电话号码格式
- URL格式
- 日期格式

### 练习3：错误处理验证

创建测试验证各种错误场景：
- 400 Bad Request
- 401 Unauthorized
- 403 Forbidden
- 404 Not Found
- 500 Internal Server Error

## 4.10 总结

本章深入探讨了REST Assured中的响应验证与断言技术，包括：

1. **响应验证基础** - 掌握响应规范和链式验证
2. **状态码与状态行验证** - 学习状态码和状态行的各种验证方法
3. **响应头验证** - 掌握响应头的高级验证技巧
4. **Cookie验证** - 了解Cookie验证和安全性检查
5. **响应体验证** - 深入学习JSON和XML响应体验证
6. **自定义断言** - 实现自定义匹配器和验证器
7. **响应数据提取与验证** - 掌握数据提取和条件性验证
8. **错误响应验证** - 学习错误响应结构和内容验证

通过本章的学习，您应该能够编写全面的响应验证逻辑，确保API返回的数据符合预期，并能够处理各种正常和异常情况。在下一章中，我们将学习JSON与XML数据处理的高级技巧。