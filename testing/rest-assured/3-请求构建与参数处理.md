# 第3章：请求构建与参数处理

## 3.1 高级请求构建技术

### 3.1.1 请求规范高级用法

请求规范(RequestSpecification)是构建可重用请求配置的核心组件，让我们深入了解其高级用法：

```java
// 创建复杂的请求规范
RequestSpecification complexRequestSpec = new RequestSpecBuilder()
    // 基础设置
    .setBaseUri("https://api.example.com")
    .setBasePath("/v1")
    .setPort(443)
    .setContentType(ContentType.JSON)
    
    // 请求头设置
    .addHeader("Accept", "application/json")
    .addHeader("User-Agent", "REST-Assured-Tests/1.0")
    .addHeader("X-API-Key", "secure-api-key-123")
    
    // 多值请求头
    .addHeader("Accept-Language", "en-US,en;q=0.9")
    .addHeader("Accept-Language", "zh-CN;q=0.8")
    
    // 认证设置
    .setAuth(OAuth2AuthorizationCodeFlow.oauth2(
        "client_id", 
        "client_secret", 
        "http://example.com/callback", 
        "http://example.com/token"
    ))
    
    // 查询参数
    .addQueryParam("api_version", "2.0")
    .addQueryParam("format", "json")
    .addQueryParam("verbose", "true")
    
    // 超时设置
    .setConfig(RestAssuredConfig.config()
        .connectionTimeout(new ConnectionConfig(10000, 30000)))
    
    // 代理设置
    .setProxy("proxy.company.com", 8080)
    
    .build();
```

### 3.1.2 动态请求构建

在实际测试中，常常需要根据测试数据动态构建请求：

```java
// 动态构建请求规范
public RequestSpecification createDynamicRequestSpec(User user, String authToken) {
    return new RequestSpecBuilder()
        .setBaseUri("https://api.example.com")
        .setBasePath("/users")
        .setContentType(ContentType.JSON)
        .addHeader("Authorization", "Bearer " + authToken)
        .addHeader("X-Client-Version", "2.1.0")
        .addQueryParam("timezone", user.getTimezone())
        .addQueryParam("language", user.getLanguage())
        .body(user)
        .build();
}

// 在测试中使用
@Test
public void testDynamicUserCreation() {
    User user = User.builder()
        .name("John Doe")
        .email("john.doe@example.com")
        .timezone("UTC")
        .language("en")
        .build();
    
    String authToken = authenticationService.getValidToken();
    
    given()
        .spec(createDynamicRequestSpec(user, authToken))
    .when()
        .post()
    .then()
        .statusCode(201)
        .body("name", equalTo(user.getName()))
        .body("email", equalTo(user.getEmail()));
}
```

### 3.1.3 条件性请求配置

```java
// 根据环境条件配置请求
public RequestSpecification environmentAwareRequestSpec() {
    RequestSpecBuilder builder = new RequestSpecBuilder()
        .setBaseUri(getBaseUriForEnvironment())
        .setContentType(ContentType.JSON);
    
    // 根据环境添加不同的认证
    if (isProduction()) {
        builder.setAuth(OAuth2Signature.oauth2(getProductionOauthCredentials()));
    } else {
        builder.setAuth(basic("testuser", "testpass"));
    }
    
    // 生产环境添加额外的请求头
    if (isProduction()) {
        builder.addHeader("X-Request-ID", UUID.randomUUID().toString());
        builder.addHeader("X-Trace-Id", generateTraceId());
    }
    
    return builder.build();
}

// 条件性添加参数
@Test
public void testWithConditionalParameters() {
    RequestSpecBuilder builder = new RequestSpecBuilder()
        .setBaseUri("https://api.example.com")
        .addQueryParam("apiKey", System.getProperty("api.key"));
    
    // 仅在调试模式下添加详细日志参数
    if (Boolean.getBoolean("debug.enabled")) {
        builder.addQueryParam("verbose", "true");
        builder.addQueryParam("log_level", "debug");
    }
    
    // 根据测试配置添加参数
    TestConfig config = getTestConfig();
    if (config.isIncludeInactive()) {
        builder.addQueryParam("include_inactive", "true");
    }
    
    given()
        .spec(builder.build())
    .when()
        .get("/users")
    .then()
        .statusCode(200);
}
```

## 3.2 请求头处理

### 3.2.1 请求头高级操作

```java
// 使用Header对象
Header contentTypeHeader = new Header("Content-Type", "application/json");
Header authHeader = new Header("Authorization", "Bearer token123");
Header userAgentHeader = new Header("User-Agent", "REST-Assured/5.3.0");

Headers multipleHeaders = new Headers(contentTypeHeader, authHeader, userAgentHeader);
given().headers(multipleHeaders);

// 条件性添加请求头
public RequestSpecification conditionalHeaders(boolean includeVersion, String authToken) {
    RequestSpecification spec = given()
        .header("Content-Type", "application/json")
        .header("Accept", "application/json");
    
    if (includeVersion) {
        spec = spec.header("X-API-Version", "2.0");
    }
    
    if (authToken != null && !authToken.isEmpty()) {
        spec = spec.header("Authorization", "Bearer " + authToken);
    }
    
    return spec;
}

// 动态请求头值
@Test
public void testWithDynamicHeaders() {
    String timestamp = String.valueOf(System.currentTimeMillis());
    String nonce = generateNonce();
    String signature = calculateSignature(timestamp, nonce);
    
    given()
        .header("X-Timestamp", timestamp)
        .header("X-Nonce", nonce)
        .header("X-Signature", signature)
        .header("X-Client-ID", getClientId())
        .header("X-Request-ID", UUID.randomUUID().toString())
    .when()
        .get("/secure/resource")
    .then()
        .statusCode(200);
}
```

### 3.2.2 认证头处理

```java
// OAuth 2.0 Bearer Token
@Test
public void testOAuth2Authentication() {
    // 方式1：直接设置Authorization头
    given()
        .header("Authorization", "Bearer " + getOAuthToken())
    .when()
        .get("/protected/resource")
    .then()
        .statusCode(200);
    
    // 方式2：使用OAuth2预设
    given()
        .auth().oauth2(getOAuthToken())
    .when()
        .get("/protected/resource")
    .then()
        .statusCode(200);
    
    // 方式3：使用完整的OAuth2流程
    given()
        .auth().preemptive().oauth2(getOAuthToken())
    .when()
        .get("/protected/resource")
    .then()
        .statusCode(200);
}

// API Key认证
@Test
public void testApiKeyAuthentication() {
    // 方式1：作为请求头
    given()
        .header("X-API-Key", "my-api-key-123")
    .when()
        .get("/api/data")
    .then()
        .statusCode(200);
    
    // 方式2：作为查询参数
    given()
        .queryParam("api_key", "my-api-key-123")
    .when()
        .get("/api/data")
    .then()
        .statusCode(200);
}

// 自定义签名认证
@Test
public void testCustomSignatureAuthentication() {
    String apiKey = "my-api-key";
    String apiSecret = "my-api-secret";
    String timestamp = String.valueOf(System.currentTimeMillis());
    String method = "GET";
    String path = "/api/users";
    String query = "?page=1&size=10";
    
    // 生成签名
    String message = method + "\n" + path + "\n" + timestamp;
    String signature = HMACSHA256(message, apiSecret);
    
    given()
        .header("X-API-Key", apiKey)
        .header("X-Timestamp", timestamp)
        .header("X-Signature", signature)
    .when()
        .get(path + query)
    .then()
        .statusCode(200);
}

// JWT认证
@Test
public void testJWTAuthentication() {
    // 获取JWT令牌
    String jwt = authenticateAndGetJWT();
    
    given()
        .header("Authorization", "Bearer " + jwt)
        .header("Content-Type", "application/json")
    .when()
        .get("/api/profile")
    .then()
        .statusCode(200);
}

// 双因素认证
@Test
public void testTwoFactorAuthentication() {
    String primaryToken = authenticateWithPassword();
    String mfaToken = authenticateWithMFA(primaryToken, "123456");
    
    given()
        .header("Authorization", "Bearer " + mfaToken)
        .header("X-MFA-Verified", "true")
    .when()
        .get("/api/sensitive-data")
    .then()
        .statusCode(200);
}
```

## 3.3 参数处理详解

### 3.3.1 查询参数高级处理

```java
// 使用QueryParams对象
QueryParams queryParams = new QueryParams()
    .add("param1", "value1")
    .add("param2", "123")
    .add("active", "true")
    .add("tags", "java,rest,api");

given()
    .queryParams(queryParams)
.when()
    .get("/api/search");

// 复杂查询参数处理
public RequestSpecification buildComplexQueryParams(SearchCriteria criteria) {
    RequestSpecification spec = given();
    
    // 基本查询参数
    spec = spec.queryParam("q", criteria.getQuery());
    spec = spec.queryParam("page", criteria.getPage());
    spec = spec.queryParam("size", criteria.getSize());
    
    // 排序参数
    if (criteria.getSortBy() != null) {
        spec = spec.queryParam("sort", criteria.getSortBy());
        spec = spec.queryParam("order", criteria.getSortOrder());
    }
    
    // 过滤参数
    if (criteria.getFilters() != null && !criteria.getFilters().isEmpty()) {
        for (Map.Entry<String, Object> entry : criteria.getFilters().entrySet()) {
            spec = spec.queryParam(entry.getKey(), entry.getValue());
        }
    }
    
    // 数组参数处理
    if (criteria.getTags() != null && !criteria.getTags().isEmpty()) {
        spec = spec.queryParam("tags", criteria.getTags().stream()
            .collect(Collectors.joining(",")));
    }
    
    // 日期范围参数
    if (criteria.getDateRange() != null) {
        spec = spec.queryParam("from", criteria.getDateRange().getFrom());
        spec = spec.queryParam("to", criteria.getDateRange().getTo());
    }
    
    return spec;
}

// 使用Map批量添加查询参数
@Test
public void testWithQueryParamMap() {
    Map<String, Object> params = new HashMap<>();
    params.put("api_version", "2.0");
    params.put("format", "json");
    params.put("verbose", true);
    params.put("timeout", 30);
    params.put("retry_count", 3);
    
    given()
        .queryParams(params)
    .when()
        .get("/api/data")
    .then()
        .statusCode(200);
}

// 多值查询参数
@Test
public void testMultiValueQueryParams() {
    // 方式1：多次调用queryParam
    given()
        .queryParam("categories", "books")
        .queryParam("categories", "electronics")
        .queryParam("categories", "clothing")
    .when()
        .get("/api/products")
    .then()
        .statusCode(200);
    
    // 方式2：使用List
    given()
        .queryParam("categories", Arrays.asList("books", "electronics", "clothing"))
    .when()
        .get("/api/products")
    .then()
        .statusCode(200);
    
    // 方式3：使用逗号分隔的字符串
    given()
        .queryParam("categories", "books,electronics,clothing")
    .when()
        .get("/api/products")
    .then()
        .statusCode(200);
}
```

### 3.3.2 路径参数处理

```java
// 单一路径参数
given()
    .pathParam("userId", 123)
    .pathParam("resourceType", "profile")
.when()
    .get("/api/users/{userId}/{resourceType}")
.then()
    .statusCode(200);

// 使用Map设置多个路径参数
Map<String, Object> pathParams = new HashMap<>();
pathParams.put("userId", 123);
pathParams.put("postId", 456);
pathParams.put("commentId", 789);

given()
    .pathParams(pathParams)
.when()
    .get("/api/users/{userId}/posts/{postId}/comments/{commentId}")
.then()
    .statusCode(200);

// 动态路径参数处理
@Test
public void testDynamicPathParameters() {
    User user = createTestUser();
    Post post = createTestPost(user.getId());
    Comment comment = createTestComment(post.getId());
    
    given()
        .pathParam("userId", user.getId())
        .pathParam("postId", post.getId())
        .pathParam("commentId", comment.getId())
    .when()
        .get("/api/users/{userId}/posts/{postId}/comments/{commentId}")
    .then()
        .statusCode(200)
        .body("user.id", equalTo(user.getId()))
        .body("post.id", equalTo(post.getId()))
        .body("comment.id", equalTo(comment.getId()));
}

// 复杂路径参数构建
public String buildResourcePath(Resource resource) {
    StringBuilder pathBuilder = new StringBuilder("/api");
    
    if (resource.getNamespace() != null) {
        pathBuilder.append("/namespaces/{namespace}");
    }
    
    pathBuilder.append("/{resourceType}");
    
    if (resource.getSubType() != null) {
        pathBuilder.append("/{subType}");
    }
    
    pathBuilder.append("/{resourceId}");
    
    if (resource.getAction() != null) {
        pathBuilder.append("/actions/{action}");
    }
    
    return pathBuilder.toString();
}
```

### 3.3.3 表单参数与多部分表单

```java
// 表单参数（application/x-www-form-urlencoded）
@Test
public void testFormParameters() {
    given()
        .contentType(ContentType.URLENC)
        .formParam("username", "john.doe")
        .formParam("password", "password123")
        .formParam("remember_me", true)
        .formParam("redirect_url", "/dashboard")
    .when()
        .post("/login")
    .then()
        .statusCode(200);
}

// 使用Map设置表单参数
@Test
public void testFormParametersWithMap() {
    Map<String, Object> formParams = new HashMap<>();
    formParams.put("username", "john.doe");
    formParams.put("password", "password123");
    formParams.put("remember_me", true);
    formParams.put("redirect_url", "/dashboard");
    
    given()
        .contentType(ContentType.URLENC)
        .formParams(formParams)
    .when()
        .post("/login")
    .then()
        .statusCode(200);
}

// 多部分表单（multipart/form-data）
@Test
public void testMultipartFormData() {
    given()
        .multiPart("profilePicture", new File("user.jpg"), "image/jpeg")
        .multiPart("resume", new File("resume.pdf"), "application/pdf")
        .multiPart("firstName", "John")
        .multiPart("lastName", "Doe")
        .multiPart("email", "john.doe@example.com")
        .multiPart("bio", "Software developer with 5 years experience")
        .multiPart("skills", "Java,Spring,REST Assured")
    .when()
        .post("/api/users/profile")
    .then()
        .statusCode(200);
}

// 高级多部分表单处理
@Test
public void testAdvancedMultipartFormData() {
    // 创建Control对象来精确控制多部分内容
    FileControl fileControl = new FileControl("document", new File("contract.pdf"), 
        "application/pdf", "contract_v2.pdf");
    
    StringControl stringControl = new StringControl("description", 
        "Updated contract for Q4 2023", "text/plain");
    
    InputStreamControl streamControl = new InputStreamControl("image", 
        getClass().getResourceAsStream("/logo.png"), "image/png", "logo.png");
    
    // 添加自定义Content-Disposition头
    Map<String, String> headers = new HashMap<>();
    headers.put("Content-ID", "<contract.pdf>");
    headers.put("X-Custom-Header", "custom-value");
    
    given()
        .multiPart(fileControl)
        .multiPart(stringControl)
        .multiPart(streamControl)
        .multiPart("metadata", "{\"version\": \"2.0\", \"author\": \"admin\"}", 
            "application/json", headers)
    .when()
        .post("/api/documents/upload")
    .then()
        .statusCode(201);
}
```

## 3.4 请求体处理

### 3.4.1 JSON请求体处理

```java
// 使用对象自动序列化
@Test
public void testWithJsonSerialization() {
    User user = User.builder()
        .name("John Doe")
        .email("john.doe@example.com")
        .age(30)
        .active(true)
        .address(Address.builder()
            .street("123 Main St")
            .city("New York")
            .zipCode("10001")
            .build())
        .build();
    
    given()
        .contentType(ContentType.JSON)
        .body(user)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201)
        .body("id", notNullValue())
        .body("name", equalTo(user.getName()))
        .body("email", equalTo(user.getEmail()));
}

// 使用自定义序列化器
@Test
public void testWithCustomJsonSerializer() {
    ObjectMapper customMapper = new ObjectMapper();
    customMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
    customMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd"));
    
    User user = new User("John", "john@example.com", null, null); // some fields are null
    
    given()
        .contentType(ContentType.JSON)
        .body(user, ObjectMapperType.JACKSON_2)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}

// 使用JSON字符串
@Test
public void testWithJsonString() {
    String jsonBody = "{\n" +
        "  \"name\": \"John Doe\",\n" +
        "  \"email\": \"john.doe@example.com\",\n" +
        "  \"age\": 30,\n" +
        "  \"active\": true,\n" +
        "  \"address\": {\n" +
        "    \"street\": \"123 Main St\",\n" +
        "    \"city\": \"New York\",\n" +
        "    \"zipCode\": \"10001\"\n" +
        "  }\n" +
        "}";
    
    given()
        .contentType(ContentType.JSON)
        .body(jsonBody)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}

// 从文件加载JSON
@Test
public void testWithJsonFile() {
    given()
        .contentType(ContentType.JSON)
        .body(new File("src/test/resources/user.json"))
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}
```

### 3.4.2 XML请求体处理

```java
// 使用对象自动序列化为XML
@Test
public void testWithXmlSerialization() {
    User user = User.builder()
        .name("John Doe")
        .email("john.doe@example.com")
        .age(30)
        .active(true)
        .build();
    
    given()
        .contentType(ContentType.XML)
        .body(user, ObjectMapperType.JAXB)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}

// 使用XML字符串
@Test
public void testWithXmlString() {
    String xmlBody = "<user>\n" +
        "    <name>John Doe</name>\n" +
        "    <email>john.doe@example.com</email>\n" +
        "    <age>30</age>\n" +
        "    <active>true</active>\n" +
        "</user>";
    
    given()
        .contentType(ContentType.XML)
        .body(xmlBody)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}
```

### 3.4.3 二进制与文件处理

```java
// 上传单个文件
@Test
public void testSingleFileUpload() {
    given()
        .multiPart("file", new File("test-document.pdf"), "application/pdf")
        .multiPart("description", "Test document for upload")
    .when()
        .post("/api/files/upload")
    .then()
        .statusCode(201)
        .body("fileId", notNullValue())
        .body("filename", equalTo("test-document.pdf"));
}

// 上传多个文件
@Test
public void testMultipleFileUpload() {
    given()
        .multiPart("files", new File("doc1.pdf"), "application/pdf")
        .multiPart("files", new File("doc2.pdf"), "application/pdf")
        .multiPart("files", new File("image.jpg"), "image/jpeg")
        .multiPart("description", "Multiple files upload test")
    .when()
        .post("/api/files/batch-upload")
    .then()
        .statusCode(201)
        .body("fileIds", hasSize(3));
}

// 使用字节数组
@Test
public void testWithByteArray() throws IOException {
    byte[] fileBytes = Files.readAllBytes(Paths.get("test-image.jpg"));
    
    given()
        .multiPart("image", fileBytes, "image.jpg", "image/jpeg")
        .multiPart("title", "Test Image")
    .when()
        .post("/api/images/upload")
    .then()
        .statusCode(201);
}

// 使用输入流
@Test
public void testWithInputStream() throws FileNotFoundException {
    InputStream inputStream = new FileInputStream("large-file.zip");
    
    given()
        .multiPart("file", inputStream, "backup.zip", "application/zip")
        .multiPart("description", "Large backup file")
    .when()
        .post("/api/files/upload")
    .then()
        .statusCode(201);
}
```

## 3.5 请求模板与动态构建

### 3.5.1 请求模板系统

```java
// 创建请求模板
public class RequestTemplate {
    private String baseUri;
    private String basePath;
    private Map<String, String> defaultHeaders;
    private Map<String, Object> defaultQueryParams;
    private AuthenticationScheme authenticationScheme;
    
    // 构建器模式
    public static class Builder {
        private String baseUri = "https://api.example.com";
        private String basePath = "/v1";
        private Map<String, String> defaultHeaders = new HashMap<>();
        private Map<String, Object> defaultQueryParams = new HashMap<>();
        private AuthenticationScheme authenticationScheme;
        
        public Builder baseUri(String baseUri) {
            this.baseUri = baseUri;
            return this;
        }
        
        public Builder basePath(String basePath) {
            this.basePath = basePath;
            return this;
        }
        
        public Builder addDefaultHeader(String name, String value) {
            this.defaultHeaders.put(name, value);
            return this;
        }
        
        public Builder addDefaultQueryParam(String name, Object value) {
            this.defaultQueryParams.put(name, value);
            return this;
        }
        
        public Builder authentication(AuthenticationScheme authScheme) {
            this.authenticationScheme = authScheme;
            return this;
        }
        
        public RequestTemplate build() {
            return new RequestTemplate(baseUri, basePath, defaultHeaders, 
                defaultQueryParams, authenticationScheme);
        }
    }
    
    // 构造函数
    private RequestTemplate(String baseUri, String basePath, 
            Map<String, String> defaultHeaders, 
            Map<String, Object> defaultQueryParams,
            AuthenticationScheme authenticationScheme) {
        this.baseUri = baseUri;
        this.basePath = basePath;
        this.defaultHeaders = defaultHeaders;
        this.defaultQueryParams = defaultQueryParams;
        this.authenticationScheme = authenticationScheme;
    }
    
    // 构建请求规范
    public RequestSpecification buildRequestSpecification() {
        RequestSpecBuilder builder = new RequestSpecBuilder()
            .setBaseUri(baseUri)
            .setBasePath(basePath)
            .addHeaders(defaultHeaders)
            .addQueryParams(defaultQueryParams);
        
        if (authenticationScheme != null) {
            builder.setAuth(authenticationScheme);
        }
        
        return builder.build();
    }
}

// 使用请求模板
@Test
public void testWithRequestTemplate() {
    // 创建公共请求模板
    RequestTemplate publicApiTemplate = new RequestTemplate.Builder()
        .baseUri("https://api.example.com")
        .basePath("/v1/public")
        .addDefaultHeader("Accept", "application/json")
        .addDefaultHeader("User-Agent", "REST-Assured-Tests/1.0")
        .addDefaultQueryParam("api_key", "public-key-123")
        .build();
    
    // 创建认证请求模板
    RequestTemplate secureApiTemplate = new RequestTemplate.Builder()
        .baseUri("https://api.example.com")
        .basePath("/v1/secure")
        .addDefaultHeader("Accept", "application/json")
        .addDefaultHeader("User-Agent", "REST-Assured-Tests/1.0")
        .addDefaultQueryParam("api_key", "secure-key-456")
        .authentication(basic("username", "password"))
        .build();
    
    // 使用公共API模板
    given()
        .spec(publicApiTemplate.buildRequestSpecification())
        .pathParam("userId", 123)
    .when()
        .get("/users/{userId}")
    .then()
        .statusCode(200);
    
    // 使用安全API模板
    given()
        .spec(secureApiTemplate.buildRequestSpecification())
        .body(createUserRequest())
    .when()
        .post("/users")
    .then()
        .statusCode(201);
}
```

### 3.5.2 动态请求构建工厂

```java
// 请求工厂接口
public interface RequestFactory {
    RequestSpecification createGetRequest(String endpoint, Map<String, Object> params);
    RequestSpecification createPostRequest(String endpoint, Object requestBody);
    RequestSpecification createPutRequest(String endpoint, String resourceId, Object requestBody);
    RequestSpecification createDeleteRequest(String endpoint, String resourceId);
}

// API请求工厂实现
public class ApiRequestFactory implements RequestFactory {
    private String baseUri;
    private String basePath;
    private Map<String, String> defaultHeaders;
    private AuthenticationScheme authenticationScheme;
    
    public ApiRequestFactory(String baseUri, String basePath, 
            Map<String, String> defaultHeaders,
            AuthenticationScheme authenticationScheme) {
        this.baseUri = baseUri;
        this.basePath = basePath;
        this.defaultHeaders = defaultHeaders;
        this.authenticationScheme = authenticationScheme;
    }
    
    @Override
    public RequestSpecification createGetRequest(String endpoint, Map<String, Object> params) {
        RequestSpecBuilder builder = new RequestSpecBuilder()
            .setBaseUri(baseUri)
            .setBasePath(basePath)
            .addHeaders(defaultHeaders)
            .setContentType(ContentType.JSON);
        
        if (authenticationScheme != null) {
            builder.setAuth(authenticationScheme);
        }
        
        if (params != null && !params.isEmpty()) {
            builder.addQueryParams(params);
        }
        
        return given()
            .spec(builder.build())
            .when()
            .get(endpoint)
            .then()
            .extract()
            .response();
    }
    
    @Override
    public RequestSpecification createPostRequest(String endpoint, Object requestBody) {
        RequestSpecBuilder builder = new RequestSpecBuilder()
            .setBaseUri(baseUri)
            .setBasePath(basePath)
            .addHeaders(defaultHeaders)
            .setContentType(ContentType.JSON)
            .setBody(requestBody);
        
        if (authenticationScheme != null) {
            builder.setAuth(authenticationScheme);
        }
        
        return given()
            .spec(builder.build())
            .when()
            .post(endpoint)
            .then()
            .extract()
            .response();
    }
    
    // 其他方法的实现...
}

// 使用请求工厂
@Test
public void testWithRequestFactory() {
    Map<String, String> defaultHeaders = new HashMap<>();
    defaultHeaders.put("Accept", "application/json");
    defaultHeaders.put("X-API-Version", "2.0");
    
    RequestFactory requestFactory = new ApiRequestFactory(
        "https://api.example.com",
        "/v1",
        defaultHeaders,
        OAuth2.oauth2(getAccessToken())
    );
    
    // 使用工厂创建GET请求
    Map<String, Object> params = new HashMap<>();
    params.put("page", 1);
    params.put("size", 20);
    params.put("active", true);
    
    Response getUsersResponse = requestFactory.createGetRequest("/users", params);
    
    // 验证响应
    assertEquals(200, getUsersResponse.getStatusCode());
    
    // 使用工厂创建POST请求
    User newUser = User.builder()
        .name("Alice")
        .email("alice@example.com")
        .build();
    
    Response createUserResponse = requestFactory.createPostRequest("/users", newUser);
    
    assertEquals(201, createUserResponse.getStatusCode());
}
```

## 3.6 高级参数处理场景

### 3.6.1 复杂对象序列化

```java
// 嵌套对象序列化
@Test
public void testNestedObjectSerialization() {
    User user = User.builder()
        .name("John Doe")
        .email("john.doe@example.com")
        .address(Address.builder()
            .street("123 Main St")
            .city("New York")
            .zipCode("10001")
            .coordinates(GeoLocation.builder()
                .latitude(40.7128)
                .longitude(-74.0060)
                .build())
            .build())
        .preferences(UserPreferences.builder()
            .theme("dark")
            .language("en")
            .notifications(Notifications.builder()
                .email(true)
                .sms(false)
                .push(true)
                .frequency("daily")
                .build())
            .build())
        .build();
    
    given()
        .contentType(ContentType.JSON)
        .body(user)
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}

// 自定义序列化器
public class CustomDateSerializer extends JsonSerializer<Date> {
    private SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ");
    
    @Override
    public void serialize(Date date, JsonGenerator gen, SerializerProvider provider) 
            throws IOException {
        gen.writeString(dateFormat.format(date));
    }
}

// 使用自定义序列化器
@Test
public void testCustomDateSerialization() {
    ObjectMapper mapper = new ObjectMapper();
    SimpleModule module = new SimpleModule();
    module.addSerializer(Date.class, new CustomDateSerializer());
    mapper.registerModule(module);
    
    User user = new User();
    user.setCreatedAt(new Date());
    user.setUpdatedAt(new Date());
    
    given()
        .contentType(ContentType.JSON)
        .body(mapper.writeValueAsString(user))
    .when()
        .post("/api/users")
    .then()
        .statusCode(201);
}
```

### 3.6.2 条件性字段处理

```java
// 条件性包含字段
public class ConditionalUserRequest {
    private String name;
    private String email;
    private String password;
    private String bio;
    private String profilePicture;
    private String phone;
    private Date birthDate;
    
    // 构建包含敏感信息的完整请求
    public static ConditionalUserRequest fullRequest() {
        return new ConditionalUserRequest()
            .withName("John Doe")
            .withEmail("john@example.com")
            .withPassword("securePassword")
            .withBio("Software developer")
            .withProfilePicture("profile.jpg")
            .withPhone("+1234567890")
            .withBirthDate(new Date());
    }
    
    // 构建公共请求（排除敏感信息）
    public static ConditionalUserRequest publicRequest() {
        return new ConditionalUserRequest()
            .withName("John Doe")
            .withBio("Software developer");
    }
    
    // 链式设置方法
    public ConditionalUserRequest withName(String name) {
        this.name = name;
        return this;
    }
    
    public ConditionalUserRequest withEmail(String email) {
        this.email = email;
        return this;
    }
    
    // 其他with方法...
}

// 使用条件性请求
@Test
public void testConditionalFieldInclusion() {
    // 创建包含敏感信息的完整用户请求
    ConditionalUserRequest fullRequest = ConditionalUserRequest.fullRequest();
    
    given()
        .contentType(ContentType.JSON)
        .body(fullRequest)
    .when()
        .post("/api/admin/users")
    .then()
        .statusCode(201);
    
    // 创建只包含公共信息的用户请求
    ConditionalUserRequest publicRequest = ConditionalUserRequest.publicRequest();
    
    given()
        .contentType(ContentType.JSON)
        .body(publicRequest)
    .when()
        .post("/api/public/users")
    .then()
        .statusCode(201);
}
```

## 3.7 实践练习

### 练习1：构建复杂请求规范

创建一个请求规范，包含以下元素：
- 基础URI：https://api.example.com
- 基础路径：/v2
- 认证：OAuth2 Bearer Token
- 请求头：Accept, User-Agent, X-Request-ID
- 查询参数：api_version, timezone, verbose
- 超时设置：连接10秒，读取30秒

### 练习2：动态请求构建

创建一个工厂类，能够根据不同的用户类型（管理员、普通用户、访客）动态构建不同权限的API请求。

### 练习3：文件上传处理

实现一个文件上传测试，能够处理：
- 单个文件上传
- 多个文件上传
- 文件和其他表单数据混合上传
- 不同文件格式的处理

## 3.8 总结

本章深入探讨了REST Assured中的请求构建与参数处理技术，包括：

1. **高级请求构建技术** - 掌握请求规范的复杂用法和动态请求构建
2. **请求头处理** - 学习各种认证方式和动态请求头处理
3. **参数处理详解** - 掌握查询参数、路径参数和表单参数的高级用法
4. **请求体处理** - 了解JSON、XML和二进制数据的处理方法
5. **请求模板与动态构建** - 学习创建可重用的请求模板和工厂
6. **高级参数处理场景** - 掌握复杂对象序列化和条件性字段处理

通过本章的学习，您应该能够构建各种复杂的API请求，处理各种参数和数据类型，并创建可维护的请求构建系统。在下一章中，我们将学习响应验证与断言的高级技巧。