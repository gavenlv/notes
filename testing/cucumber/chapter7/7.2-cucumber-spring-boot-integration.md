# 7.2 Cucumber与Spring Boot集成详解

## 引言

Spring Boot是目前Java生态中最流行的应用开发框架之一，它简化了Spring应用的创建和开发过程。将Cucumber与Spring Boot集成可以充分利用Spring Boot的依赖注入、事务管理和测试配置等功能，构建强大的BDD测试体系。本章将深入探讨Cucumber与Spring Boot的集成方式、配置方法和最佳实践。

## 集成基础

### 依赖配置

#### Maven依赖

```xml
<dependencies>
    <!-- Spring Boot Starter Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Cucumber核心依赖 -->
    <dependency>
        <groupId>io.cucumber</groupId>
        <artifactId>cucumber-java</artifactId>
        <version>7.11.0</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Cucumber JUnit集成 -->
    <dependency>
        <groupId>io.cucumber</groupId>
        <artifactId>cucumber-junit</artifactId>
        <version>7.11.0</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Cucumber Spring集成 -->
    <dependency>
        <groupId>io.cucumber</groupId>
        <artifactId>cucumber-spring</artifactId>
        <version>7.11.0</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

#### Gradle依赖

```groovy
dependencies {
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'io.cucumber:cucumber-java:7.11.0'
    testImplementation 'io.cucumber:cucumber-junit:7.11.0'
    testImplementation 'io.cucumber:cucumber-spring:7.11.0'
}
```

### 测试运行器配置

#### 基本测试运行器

```java
package com.example.gherkin;

import io.cucumber.junit.Cucumber;
import io.cucumber.junit.CucumberOptions;
import org.junit.runner.RunWith;

@RunWith(Cucumber.class)
@CucumberOptions(
    features = {"src/test/resources/features"},
    glue = {"com.example.gherkin.stepdefinitions"},
    plugin = {
        "pretty",
        "html:target/cucumber-reports",
        "json:target/cucumber-reports/cucumber.json"
    },
    monochrome = true
)
public class CucumberSpringIntegrationTest {
}
```

#### 带Spring集成的测试运行器

```java
package com.example.gherkin;

import io.cucumber.junit.Cucumber;
import io.cucumber.junit.CucumberOptions;
import io.cucumber.spring.CucumberContextConfiguration;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

@RunWith(Cucumber.class)
@CucumberOptions(
    features = {"src/test/resources/features"},
    glue = {"com.example.gherkin.stepdefinitions"},
    plugin = {
        "pretty",
        "html:target/cucumber-reports",
        "json:target/cucumber-reports/cucumber.json"
    },
    monochrome = true
)
@CucumberContextConfiguration
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
public class CucumberSpringIntegrationTest {
}
```

## Spring配置

### 基本Spring配置

#### 测试配置类

```java
package com.example.gherkin.config;

import io.cucumber.java.Before;
import io.cucumber.spring.CucumberContextConfiguration;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

@CucumberContextConfiguration
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
public class CucumberSpringConfig {
    
    @Before(order = 1)
    public void setup() {
        // 测试前的初始化逻辑
        System.out.println("Cucumber Spring配置初始化");
    }
    
    @Before(order = 2)
    public void setup2() {
        // 另一个初始化逻辑
        System.out.println("Cucumber Spring配置初始化2");
    }
}
```

#### 测试配置文件

```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: password
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
  redis:
    host: localhost
    port: 6379
    database: 1

logging:
  level:
    com.example.gherkin: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
```

### 高级Spring配置

#### 自定义测试配置

```java
package com.example.gherkin.config;

import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Primary;
import com.example.gherkin.services.EmailService;
import com.example.gherkin.services.MockEmailService;

@TestConfiguration
public class TestBeansConfig {
    
    @Bean
    @Primary
    public EmailService mockEmailService() {
        return new MockEmailService();
    }
    
    @Bean
    public TestDataInitializer testDataInitializer() {
        return new TestDataInitializer();
    }
}
```

#### 测试数据初始化器

```java
package com.example.gherkin.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;
import com.example.gherkin.repositories.UserRepository;
import com.example.gherkin.repositories.ProductRepository;
import com.example.gherkin.models.User;
import com.example.gherkin.models.Product;

@Component
public class TestDataInitializer implements CommandLineRunner {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private ProductRepository productRepository;
    
    @Override
    public void run(String... args) throws Exception {
        // 初始化测试数据
        initializeTestData();
    }
    
    private void initializeTestData() {
        // 创建测试用户
        User testUser = new User();
        testUser.setUsername("testuser");
        testUser.setEmail("test@example.com");
        testUser.setPassword("password");
        userRepository.save(testUser);
        
        // 创建测试产品
        Product testProduct = new Product();
        testProduct.setName("iPhone 14");
        testProduct.setPrice(999.00);
        testProduct.setCategory("手机");
        productRepository.save(testProduct);
    }
}
```

## 依赖注入

### 基本依赖注入

#### 在步骤定义中使用依赖注入

```java
package com.example.gherkin.stepdefinitions;

import io.cucumber.java.en.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import com.example.gherkin.services.UserService;
import com.example.gherkin.repositories.UserRepository;
import com.example.gherkin.models.User;

@SpringBootTest
public class UserSteps {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    private User currentUser;
    
    @Given("用户服务可用")
    public void userServiceIsAvailable() {
        // 验证服务是否可用
        assertNotNull("用户服务不应为空", userService);
    }
    
    @Given("用户 {string} 不存在")
    public void userDoesNotExist(String username) {
        assertFalse("用户不应该存在", userRepository.existsByUsername(username));
    }
    
    @When("创建用户 {string}")
    public void createUser(String username) {
        User user = new User();
        user.setUsername(username);
        user.setEmail(username + "@example.com");
        user.setPassword("password");
        
        currentUser = userService.save(user);
    }
    
    @Then("用户应该被保存")
    public void userShouldBeSaved() {
        assertNotNull("用户不应为空", currentUser);
        assertNotNull("用户ID不应为空", currentUser.getId());
        assertTrue("用户应该存在", userRepository.existsById(currentUser.getId()));
    }
}
```

### 高级依赖注入

#### 使用构造函数注入

```java
package com.example.gherkin.stepdefinitions;

import io.cucumber.java.en.*;
import org.springframework.beans.factory.annotation.Autowired;
import com.example.gherkin.services.UserService;
import com.example.gherkin.repositories.UserRepository;
import com.example.gherkin.models.User;

public class UserSteps {
    
    private final UserService userService;
    private final UserRepository userRepository;
    private User currentUser;
    
    @Autowired
    public UserSteps(UserService userService, UserRepository userRepository) {
        this.userService = userService;
        this.userRepository = userRepository;
    }
    
    @Given("用户服务可用")
    public void userServiceIsAvailable() {
        assertNotNull("用户服务不应为空", userService);
    }
    
    @Given("用户 {string} 不存在")
    public void userDoesNotExist(String username) {
        assertFalse("用户不应该存在", userRepository.existsByUsername(username));
    }
    
    @When("创建用户 {string}")
    public void createUser(String username) {
        User user = new User();
        user.setUsername(username);
        user.setEmail(username + "@example.com");
        user.setPassword("password");
        
        currentUser = userService.save(user);
    }
    
    @Then("用户应该被保存")
    public void userShouldBeSaved() {
        assertNotNull("用户不应为空", currentUser);
        assertNotNull("用户ID不应为空", currentUser.getId());
        assertTrue("用户应该存在", userRepository.existsById(currentUser.getId()));
    }
}
```

#### 使用测试上下文共享状态

```java
package com.example.gherkin.context;

import com.example.gherkin.models.User;
import com.example.gherkin.models.Product;
import com.example.gherkin.models.Order;
import org.springframework.stereotype.Component;

@Component
public class TestContext {
    
    private User currentUser;
    private Product currentProduct;
    private Order currentOrder;
    
    // getters and setters
    public User getCurrentUser() {
        return currentUser;
    }
    
    public void setCurrentUser(User currentUser) {
        this.currentUser = currentUser;
    }
    
    public Product getCurrentProduct() {
        return currentProduct;
    }
    
    public void setCurrentProduct(Product currentProduct) {
        this.currentProduct = currentProduct;
    }
    
    public Order getCurrentOrder() {
        return currentOrder;
    }
    
    public void setCurrentOrder(Order currentOrder) {
        this.currentOrder = currentOrder;
    }
    
    public void reset() {
        currentUser = null;
        currentProduct = null;
        currentOrder = null;
    }
}
```

#### 在步骤定义中使用测试上下文

```java
package com.example.gherkin.stepdefinitions;

import io.cucumber.java.en.*;
import org.springframework.beans.factory.annotation.Autowired;
import com.example.gherkin.context.TestContext;
import com.example.gherkin.services.UserService;
import com.example.gherkin.services.ProductService;
import com.example.gherkin.models.User;
import com.example.gherkin.models.Product;

public class SharedStateSteps {
    
    @Autowired
    private TestContext testContext;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private ProductService productService;
    
    @Given("用户 {string} 已存在")
    public void userExists(String username) {
        User user = userService.findByUsername(username);
        if (user == null) {
            user = new User();
            user.setUsername(username);
            user.setEmail(username + "@example.com");
            user.setPassword("password");
            user = userService.save(user);
        }
        
        testContext.setCurrentUser(user);
    }
    
    @Given("产品 {string} 已存在")
    public void productExists(String productName) {
        Product product = productService.findByName(productName);
        if (product == null) {
            product = new Product();
            product.setName(productName);
            product.setPrice(999.00);
            product.setCategory("手机");
            product = productService.save(product);
        }
        
        testContext.setCurrentProduct(product);
    }
    
    @When("用户购买产品")
    public void userPurchasesProduct() {
        User user = testContext.getCurrentUser();
        Product product = testContext.getCurrentProduct();
        
        assertNotNull("当前用户不应为空", user);
        assertNotNull("当前产品不应为空", product);
        
        // 创建订单逻辑
        // orderService.createOrder(user, product);
    }
    
    @Then("订单应该创建成功")
    public void orderShouldBeCreatedSuccessfully() {
        // 验证订单创建逻辑
    }
}
```

## 事务管理

### 基本事务管理

#### 使用@Transactional注解

```java
package com.example.gherkin.stepdefinitions;

import io.cucumber.java.en.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import com.example.gherkin.services.UserService;
import com.example.gherkin.repositories.UserRepository;
import com.example.gherkin.models.User;

public class TransactionalSteps {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Given("事务已启用")
    @Transactional
    public void transactionIsEnabled() {
        // 在事务中执行的初始化逻辑
    }
    
    @When("在事务中创建用户 {string}")
    @Transactional
    public void createUserInTransaction(String username) {
        User user = new User();
        user.setUsername(username);
        user.setEmail(username + "@example.com");
        user.setPassword("password");
        
        userService.save(user);
        
        // 事务会在测试结束后自动回滚
    }
    
    @Then("用户 {string} 应该在事务中存在")
    @Transactional
    public void userShouldExistInTransaction(String username) {
        assertTrue("用户应该在事务中存在", userRepository.existsByUsername(username));
    }
    
    @After
    public void cleanup() {
        // 清理逻辑，如果需要的话
    }
}
```

### 高级事务管理

#### 自定义事务配置

```java
package com.example.gherkin.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import javax.sql.DataSource;

@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

#### 使用事务模板

```java
package com.example.gherkin.stepdefinitions;

import io.cucumber.java.en.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.support.TransactionTemplate;
import com.example.gherkin.services.UserService;
import com.example.gherkin.repositories.UserRepository;
import com.example.gherkin.models.User;

public class TransactionTemplateSteps {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    @When("使用事务模板创建用户 {string}")
    public void createUserWithTransactionTemplate(String username) {
        transactionTemplate.execute(status -> {
            try {
                User user = new User();
                user.setUsername(username);
                user.setEmail(username + "@example.com");
                user.setPassword("password");
                
                userService.save(user);
                
                return user;
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }
    
    @Then("用户 {string} 应该存在")
    public void userShouldExist(String username) {
        assertTrue("用户应该存在", userRepository.existsByUsername(username));
    }
}
```

## 测试环境配置

### 测试配置文件

#### 多环境配置

```yaml
# application-test.yml
spring:
  profiles:
    active: test
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: password
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
  redis:
    host: localhost
    port: 6379
    database: 1

logging:
  level:
    com.example.gherkin: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# application-integration.yml
spring:
  profiles:
    active: integration
  datasource:
    url: jdbc:mysql://localhost:3306/integration_testdb
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: test_user
    password: test_password
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
  redis:
    host: localhost
    port: 6379
    database: 2

logging:
  level:
    com.example.gherkin: INFO
    org.springframework.web: INFO
```

#### 测试配置类

```java
package com.example.gherkin.config;

import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Profile;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.web.server.LocalServerPort;
import org.springframework.boot.test.context.SpringBootTest;

@TestConfiguration
@Profile("test")
public class TestRestTemplateConfig {
    
    @Bean
    public TestRestTemplate testRestTemplate() {
        return new TestRestTemplate();
    }
}
```

### 测试容器

#### 使用Testcontainers进行集成测试

```xml
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.17.6</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>mysql</artifactId>
    <version>1.17.6</version>
    <scope>test</scope>
</dependency>
```

```java
package com.example.gherkin.config;

import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.util.TestPropertyValues;
import org.springframework.context.ApplicationContextInitializer;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.test.context.ContextConfiguration;
import org.testcontainers.containers.MySQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
@ContextConfiguration(initializers = {TestContainerConfig.Initializer.class})
public class TestContainerConfig {
    
    @Container
    public static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("testdb")
            .withUsername("testuser")
            .withPassword("testpass");
    
    static class Initializer implements ApplicationContextInitializer<ConfigurableApplicationContext> {
        public void initialize(ConfigurableApplicationContext configurableApplicationContext) {
            TestPropertyValues.of(
                    "spring.datasource.url=" + mysql.getJdbcUrl(),
                    "spring.datasource.username=" + mysql.getUsername(),
                    "spring.datasource.password=" + mysql.getPassword(),
                    "spring.jpa.hibernate.ddl-auto=create-drop"
            ).applyTo(configurableApplicationContext.getEnvironment());
        }
    }
}
```

## 最佳实践

### 1. 使用测试配置文件

**原则**：使用专门的测试配置文件，避免影响生产环境。

**指导**：
- 创建application-test.yml配置文件
- 使用H2内存数据库进行单元测试
- 使用Testcontainers进行集成测试
- 使用不同的Redis数据库

### 2. 使用事务回滚保持数据清洁

**原则**：使用Spring的事务管理功能，在测试结束后自动回滚，保持测试数据清洁。

**指导**：
- 在步骤定义类上添加@Transactional注解
- 使用@Transactional(readOnly = true)进行只读操作
- 避免手动清理测试数据

### 3. 使用依赖注入管理共享状态

**原则**：使用Spring的依赖注入功能管理测试中的共享状态，避免使用静态变量。

**指导**：
- 使用@Autowired或构造函数注入
- 创建TestContext类管理共享状态
- 使用@Scope注解控制Bean的生命周期

### 4. 使用测试配置类

**原则**：创建专门的测试配置类，定义测试专用的Bean。

**指导**：
- 使用@TestConfiguration注解
- 使用@Primary注解覆盖生产Bean
- 使用@Profile注解限定测试环境

### 5. 使用Testcontainers进行集成测试

**原则**：使用Testcontainers进行集成测试，使用真实的数据库和服务。

**指导**：
- 配置Testcontainers依赖
- 使用@Container注解定义容器
- 使用ApplicationContextInitializer配置测试环境

## 总结

Cucumber与Spring Boot的集成为BDD测试提供了强大的支持，通过Spring的依赖注入、事务管理和测试配置功能，我们可以构建高效、可维护的测试体系。

在实际项目中，应该根据项目需求选择合适的集成方式，并遵循最佳实践。通过合理的配置和设计，Cucumber与Spring Boot的集成可以大大提高测试效率和质量，支持高质量的软件开发。