# 1.4 特性文件和步骤定义

## 特性文件详解

特性文件(Feature File)是Cucumber的核心组件，它使用Gherkin语法描述软件的功能特性。特性文件是可读性强的文本文件，通常以`.feature`为扩展名。

### 特性文件的基本结构

一个典型的特性文件包含以下元素：

1. **Feature**：描述软件的功能特性
2. **Description**：对功能的详细描述（可选）
3. **Background**：在所有场景执行前运行的步骤（可选）
4. **Scenario**：具体的测试场景
5. **Given、When、Then、And、But**：描述场景的步骤

### Feature关键字

Feature关键字用于定义一个功能特性，通常格式如下：

```gherkin
Feature: 功能名称
  功能描述，可以有多行
  
  背景、场景等...
```

示例：

```gherkin
Feature: 用户登录功能
  作为一个系统的用户
  我希望能够登录系统
  以便访问系统的功能
```

### Scenario关键字

Scenario关键字定义一个具体的测试场景，包含一系列步骤：

```gherkin
Scenario: 场景名称
  Given 给定条件
  When 执行操作
  Then 验证结果
```

示例：

```gherkin
Scenario: 成功登录
  Given 我是一个有效的用户
  And 我的用户名是 "admin"
  And 我的密码是 "admin123"
  When 我尝试登录系统
  Then 我应该能够成功登录
```

### Background关键字

Background定义在所有场景执行前运行的步骤，避免在每个场景中重复相同的Given步骤：

```gherkin
Background:
  Given 系统已启动
  And 数据库已连接
```

### Given、When、Then、And、But关键字

这些关键字用于描述场景的步骤：

- **Given**：描述初始状态或前置条件
- **When**：描述用户执行的操作
- **Then**：描述期望的结果或系统响应
- **And**：用于添加多个相同类型的步骤
- **But**：用于添加对比或否定步骤

示例：

```gherkin
Scenario: 添加商品到购物车
  Given 我是一个已登录的用户
  And 我的购物车是空的
  When 我浏览商品列表
  And 我点击 "添加到购物车" 按钮
  Then 商品应该被添加到我的购物车
  And 购物车数量应该增加
  But 总价格不应该超过我的预算
```

## 步骤定义详解

步骤定义(Step Definitions)是将Gherkin步骤映射到可执行代码的桥梁。每个步骤定义是一个方法，使用特定的注解来匹配Gherkin步骤。

### 步骤定义的基本结构

在Java中，步骤定义的基本结构如下：

```java
import io.cucumber.java.en.Given;
import io.cucumber.java.en.When;
import io.cucumber.java.en.Then;

public class MyStepDefinitions {
    
    @Given("我是一个有效的用户")
    public void 我是一个有效的用户() {
        // 实现代码
    }
    
    @When("我尝试登录系统")
    public void 我尝试登录系统() {
        // 实现代码
    }
    
    @Then("我应该能够成功登录")
    public void 我应该能够成功登录() {
        // 实现代码
    }
}
```

### 步骤定义注解

Cucumber提供了多种注解来匹配Gherkin步骤：

- `@Given`：匹配Given步骤
- `@When`：匹配When步骤
- `@Then`：匹配Then步骤
- `@And`：匹配And步骤
- `@But`：匹配But步骤

### 参数化步骤

步骤定义可以接受参数，使步骤更加灵活：

```java
@Given("我的用户名是 {string}")
public void 我的用户名是(String username) {
    this.username = username;
}

@When("我等待 {int} 秒")
public void 我等待秒(int seconds) throws InterruptedException {
    Thread.sleep(seconds * 1000);
}
```

对应的Gherkin步骤：

```gherkin
Given 我的用户名是 "admin"
When 我等待 5 秒
```

### 正则表达式步骤

可以使用正则表达式来匹配更复杂的步骤：

```java
@Given("^我的用户名是 \"([^\"]*)\"$")
public void 我的用户名是(String username) {
    this.username = username;
}

@When("^我等待 (\\d+) 秒$")
public void 我等待秒(int seconds) throws InterruptedException {
    Thread.sleep(seconds * 1000);
}
```

### 数据表步骤

可以使用数据表(DataTable)来传递多组数据：

```java
@Given("系统中存在以下用户")
public void 系统中存在以下用户(DataTable dataTable) {
    List<Map<String, String>> users = dataTable.asMaps();
    for (Map<String, String> user : users) {
        String username = user.get("username");
        String password = user.get("password");
        // 处理用户数据
    }
}
```

对应的Gherkin步骤：

```gherkin
Given 系统中存在以下用户
  | username | password |
  | admin    | admin123 |
  | user     | password |
  | test     | test123  |
```

### 文档字符串步骤

可以使用文档字符串(DocString)来传递多行文本：

```java
@Given("我提交以下内容")
public void 我提交以下内容(String content) {
    this.content = content;
}
```

对应的Gherkin步骤：

```gherkin
Given 我提交以下内容
  """
  这是一个多行文本
  可以包含多行内容
  """
```

## 步骤定义最佳实践

### 1. 保持步骤简洁

每个步骤应该只做一件事，避免在步骤中执行多个操作：

```java
// 不好的做法
@When("我登录系统并查看个人信息")
public void 我登录系统并查看个人信息() {
    loginService.login(username, password);
    profileService.viewProfile();
}

// 好的做法
@When("我登录系统")
public void 我登录系统() {
    loginService.login(username, password);
}

@When("我查看个人信息")
public void 我查看个人信息() {
    profileService.viewProfile();
}
```

### 2. 使用有意义的步骤名称

步骤名称应该清晰、易懂，反映业务意图：

```java
// 不好的做法
@When("执行操作1")
public void 执行操作1() {
    // 不清楚这个操作做什么
}

// 好的做法
@When("我点击登录按钮")
public void 我点击登录按钮() {
    // 清楚描述用户操作
}
```

### 3. 避免硬编码

避免在步骤定义中硬编码值，使用参数化步骤：

```java
// 不好的做法
@Given("用户名是admin")
public void 用户名是admin() {
    this.username = "admin";
}

// 好的做法
@Given("用户名是 {string}")
public void 用户名是(String username) {
    this.username = username;
}
```

### 4. 使用有意义的断言

在Then步骤中使用有意义的断言，提供清晰的错误信息：

```java
// 不好的做法
@Then("登录应该成功")
public void 登录应该成功() {
    assertTrue(loginResult.isSuccess());
}

// 好的做法
@Then("登录应该成功")
public void 登录应该成功() {
    assertTrue("登录应该成功，但实际失败", loginResult.isSuccess());
}
```

## 步骤定义状态管理

在Cucumber中，步骤定义类在同一个场景中的所有步骤之间共享状态。这可以通过实例变量实现：

```java
public class LoginSteps {
    private String username;
    private String password;
    private LoginResult loginResult;
    
    @Given("我的用户名是 {string}")
    public void 我的用户名是(String username) {
        this.username = username; // 存储状态
    }
    
    @And("我的密码是 {string}")
    public void 我的密码是(String password) {
        this.password = password; // 存储状态
    }
    
    @When("我尝试登录系统")
    public void 我尝试登录系统() {
        loginResult = loginService.login(username, password); // 使用状态
    }
    
    @Then("我应该能够成功登录")
    public void 我应该能够成功登录() {
        assertTrue(loginResult.isSuccess()); // 验证状态
    }
}
```

## 步骤定义组织

随着项目规模的增长，步骤定义可能会变得很多。合理组织步骤定义非常重要：

### 1. 按功能模块组织

将相关的步骤定义放在同一个类中：

```java
public class LoginSteps {
    // 登录相关的步骤定义
}

public class RegistrationSteps {
    // 注册相关的步骤定义
}

public class ProfileSteps {
    // 个人资料相关的步骤定义
}
```

### 2. 使用包结构

使用包结构进一步组织步骤定义：

```
com.example.cucumber.stepdefinitions
├── auth
│   ├── LoginSteps.java
│   └── RegistrationSteps.java
├── profile
│   └── ProfileSteps.java
└── shopping
    ├── CartSteps.java
    └── CheckoutSteps.java
```

### 3. 使用共享步骤

对于通用的步骤，可以创建共享步骤定义：

```java
public class CommonSteps {
    @Given("系统已启动")
    public void 系统已启动() {
        // 通用启动步骤
    }
    
    @Then("操作应该成功")
    public void 操作应该成功() {
        // 通用成功验证步骤
    }
}
```

## 步骤定义调试

在开发步骤定义时，可能会遇到一些问题。以下是一些调试技巧：

### 1. 使用未定义步骤插件

在测试运行器中添加`--step-notifications`选项，查看未定义的步骤：

```java
@CucumberOptions(
    plugin = {"step-notifications"}
)
```

### 2. 使用打印语句

在步骤定义中添加打印语句，查看执行流程：

```java
@When("我尝试登录系统")
public void 我尝试登录系统() {
    System.out.println("执行登录操作，用户名: " + username);
    loginResult = loginService.login(username, password);
    System.out.println("登录结果: " + loginResult.isSuccess());
}
```

### 3. 使用断点调试

在IDE中设置断点，调试步骤定义代码。

## 总结

本节详细介绍了特性文件和步骤定义的概念、结构和最佳实践。特性文件使用Gherkin语法描述软件功能，步骤定义将Gherkin步骤映射到可执行代码。通过合理组织特性文件和步骤定义，可以创建可读性强、可维护性高的BDD测试。

在下一节中，我们将学习如何运行Cucumber测试并查看测试结果。

## 思考题

1. 特性文件中的Background有什么作用？它与在每个Scenario中重复Given步骤有什么区别？
2. 为什么在步骤定义中应该避免硬编码值？
3. 如何在步骤定义之间共享状态？有什么注意事项？
4. 当项目规模增长时，如何合理组织步骤定义？