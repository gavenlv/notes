# 1.3 第一个Cucumber项目

## 项目概述

在本节中，我们将创建一个简单的登录功能测试项目，通过这个实例来学习Cucumber的基本用法。这个项目将测试一个简单的登录系统，包括成功登录、失败登录等场景。

## 创建项目

首先，让我们创建一个新的Maven项目：

```bash
mvn archetype:generate -DgroupId=com.example -DartifactId=login-cucumber-test -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false
cd login-cucumber-test
```

## 配置项目依赖

编辑`pom.xml`文件，添加必要的依赖：

```xml
<dependencies>
    <!-- Cucumber Java依赖 -->
    <dependency>
        <groupId>io.cucumber</groupId>
        <artifactId>cucumber-java</artifactId>
        <version>7.11.1</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Cucumber JUnit依赖 -->
    <dependency>
        <groupId>io.cucumber</groupId>
        <artifactId>cucumber-junit</artifactId>
        <version>7.11.1</version>
        <scope>test</scope>
    </dependency>
    
    <!-- JUnit依赖 -->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.13.2</version>
        <scope>test</scope>
    </dependency>
</dependencies>

<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.0.0-M9</version>
            <configuration>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Runner.java</include>
                </includes>
            </configuration>
        </plugin>
    </plugins>
</build>
```

## 创建项目结构

创建必要的目录结构：

```bash
mkdir -p src/main/java/com/example/login
mkdir -p src/test/java/com/example/cucumber/stepdefinitions
mkdir -p src/test/java/com/example/cucumber/runners
mkdir -p src/test/resources/features
```

## 实现被测试系统

首先，让我们创建一个简单的登录系统，这个系统将被我们的Cucumber测试所测试。

创建用户类`src/main/java/com/example/login/User.java`：

```java
package com.example.login;

public class User {
    private String username;
    private String password;
    
    public User(String username, String password) {
        this.username = username;
        this.password = password;
    }
    
    public String getUsername() {
        return username;
    }
    
    public String getPassword() {
        return password;
    }
}
```

创建认证服务类`src/main/java/com/example/login/AuthenticationService.java`：

```java
package com.example.login;

import java.util.HashMap;
import java.util.Map;

public class AuthenticationService {
    private Map<String, String> userDatabase;
    
    public AuthenticationService() {
        userDatabase = new HashMap<>();
        // 添加一些测试用户
        userDatabase.put("admin", "admin123");
        userDatabase.put("user", "password");
        userDatabase.put("test", "test123");
    }
    
    public boolean authenticate(String username, String password) {
        if (username == null || password == null) {
            return false;
        }
        
        String storedPassword = userDatabase.get(username);
        return storedPassword != null && storedPassword.equals(password);
    }
    
    public boolean userExists(String username) {
        return userDatabase.containsKey(username);
    }
    
    public void addUser(String username, String password) {
        if (username != null && password != null && !username.isEmpty() && !password.isEmpty()) {
            userDatabase.put(username, password);
        }
    }
}
```

创建登录结果类`src/main/java/com/example/login/LoginResult.java`：

```java
package com.example.login;

public class LoginResult {
    private boolean success;
    private String message;
    
    public LoginResult(boolean success, String message) {
        this.success = success;
        this.message = message;
    }
    
    public boolean isSuccess() {
        return success;
    }
    
    public String getMessage() {
        return message;
    }
}
```

创建登录服务类`src/main/java/com/example/login/LoginService.java`：

```java
package com.example.login;

public class LoginService {
    private AuthenticationService authService;
    
    public LoginService(AuthenticationService authService) {
        this.authService = authService;
    }
    
    public LoginResult login(String username, String password) {
        if (username == null || username.isEmpty()) {
            return new LoginResult(false, "用户名不能为空");
        }
        
        if (password == null || password.isEmpty()) {
            return new LoginResult(false, "密码不能为空");
        }
        
        if (!authService.userExists(username)) {
            return new LoginResult(false, "用户不存在");
        }
        
        if (authService.authenticate(username, password)) {
            return new LoginResult(true, "登录成功");
        } else {
            return new LoginResult(false, "密码错误");
        }
    }
}
```

## 编写特性文件

现在，让我们编写Cucumber特性文件来描述登录功能的各种场景。

创建`src/test/resources/features/login.feature`：

```gherkin
Feature: 用户登录功能
  作为一个系统的用户
  我希望能够登录系统
  以便访问系统的功能

  Background:
    Given 系统中存在以下用户
      | username | password |
      | admin    | admin123 |
      | user     | password |
      | test     | test123  |

  Scenario: 成功登录
    Given 我是一个有效的用户
    And 我的用户名是 "admin"
    And 我的密码是 "admin123"
    When 我尝试登录系统
    Then 我应该能够成功登录
    And 我应该看到 "登录成功" 的消息

  Scenario: 密码错误登录失败
    Given 我是一个有效的用户
    And 我的用户名是 "admin"
    And 我的密码是 "wrongpassword"
    When 我尝试登录系统
    Then 我应该无法登录
    And 我应该看到 "密码错误" 的消息

  Scenario: 用户不存在登录失败
    Given 我是一个无效的用户
    And 我的用户名是 "nonexistent"
    And 我的密码是 "anypassword"
    When 我尝试登录系统
    Then 我应该无法登录
    And 我应该看到 "用户不存在" 的消息

  Scenario: 用户名为空登录失败
    Given 我的用户名是 ""
    And 我的密码是 "password"
    When 我尝试登录系统
    Then 我应该无法登录
    And 我应该看到 "用户名不能为空" 的消息

  Scenario: 密码为空登录失败
    Given 我的用户名是 "admin"
    And 我的密码是 ""
    When 我尝试登录系统
    Then 我应该无法登录
    And 我应该看到 "密码不能为空" 的消息
```

## 实现步骤定义

现在，让我们创建步骤定义类来实现特性文件中描述的步骤。

创建`src/test/java/com/example/cucumber/stepdefinitions/LoginSteps.java`：

```java
package com.example.cucumber.stepdefinitions;

import com.example.login.AuthenticationService;
import com.example.login.LoginResult;
import com.example.login.LoginService;
import io.cucumber.java.en.And;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import io.cucumber.datatable.DataTable;
import java.util.Map;

import static org.junit.Assert.*;

public class LoginSteps {
    private LoginService loginService;
    private AuthenticationService authService;
    private LoginResult loginResult;
    private String username;
    private String password;
    private boolean isValidUser;

    @Given("系统中存在以下用户")
    public void 系统中存在以下用户(DataTable dataTable) {
        authService = new AuthenticationService();
        loginService = new LoginService(authService);
        
        // 从数据表中获取用户信息并添加到认证服务
        for (Map<String, String> row : dataTable.asMaps()) {
            String user = row.get("username");
            String pass = row.get("password");
            authService.addUser(user, pass);
        }
    }

    @Given("我是一个有效的用户")
    public void 我是一个有效的用户() {
        isValidUser = true;
    }

    @Given("我是一个无效的用户")
    public void 我是一个无效的用户() {
        isValidUser = false;
    }

    @And("我的用户名是 {string}")
    public void 我的用户名是(String username) {
        this.username = username;
    }

    @And("我的密码是 {string}")
    public void 我的密码是(String password) {
        this.password = password;
    }

    @When("我尝试登录系统")
    public void 我尝试登录系统() {
        loginResult = loginService.login(username, password);
    }

    @Then("我应该能够成功登录")
    public void 我应该能够成功登录() {
        assertTrue("登录应该成功", loginResult.isSuccess());
    }

    @Then("我应该无法登录")
    public void 我应该无法登录() {
        assertFalse("登录应该失败", loginResult.isSuccess());
    }

    @And("我应该看到 {string} 的消息")
    public void 我应该看到的消息(String expectedMessage) {
        assertEquals("消息不匹配", expectedMessage, loginResult.getMessage());
    }
}
```

## 创建测试运行器

创建`src/test/java/com/example/cucumber/runners/LoginTestRunner.java`：

```java
package com.example.cucumber.runners;

import io.cucumber.junit.Cucumber;
import io.cucumber.junit.CucumberOptions;
import org.junit.runner.RunWith;

@RunWith(Cucumber.class)
@CucumberOptions(
    features = "src/test/resources/features",
    glue = "com.example.cucumber.stepdefinitions",
    plugin = {
        "pretty",
        "html:target/cucumber-reports/login-report.html",
        "json:target/cucumber-reports/login-report.json"
    },
    monochrome = true
)
public class LoginTestRunner {
}
```

## 运行测试

现在，我们可以运行Cucumber测试了：

```bash
mvn test
```

你应该能看到测试输出，显示所有场景的执行结果。测试完成后，可以在`target/cucumber-reports`目录中找到HTML格式的测试报告。

## 测试结果分析

如果一切正常，所有测试场景都应该通过。让我们分析一下测试执行的过程：

1. **Background步骤**：在每个场景执行前，系统会创建用户数据
2. **Given步骤**：设置测试的初始条件
3. **When步骤**：执行登录操作
4. **Then步骤**：验证登录结果
5. **And步骤**：执行额外的验证

## 修改和扩展测试

让我们尝试修改和扩展测试，以更好地理解Cucumber的工作方式。

### 添加新场景

在`login.feature`文件中添加一个新场景：

```gherkin
  Scenario: 添加新用户后登录
    Given 我是一个新用户
    And 我的用户名是 "newuser"
    And 我的密码是 "newpass123"
    When 我注册到系统中
    And 我尝试登录系统
    Then 我应该能够成功登录
    And 我应该看到 "登录成功" 的消息
```

### 实现新步骤

在`LoginSteps.java`中添加新步骤的实现：

```java
    @Given("我是一个新用户")
    public void 我是一个新用户() {
        isValidUser = false;
    }

    @When("我注册到系统中")
    public void 我注册到系统中() {
        authService.addUser(username, password);
    }
```

### 重新运行测试

再次运行测试，验证新添加的场景是否通过：

```bash
mvn test
```

## 调试技巧

在开发Cucumber测试时，可能会遇到一些问题。以下是一些调试技巧：

1. **使用打印语句**：在步骤定义中添加System.out.println语句，输出中间结果
2. **使用断点**：在IDE中设置断点，调试步骤定义代码
3. **检查步骤匹配**：确保特性文件中的步骤与步骤定义中的方法匹配
4. **查看详细报告**：查看HTML报告，了解测试执行的详细信息

## 最佳实践

在编写Cucumber测试时，遵循以下最佳实践：

1. **保持步骤简洁**：每个步骤应该只做一件事
2. **使用有意义的描述**：特性文件中的描述应该清晰易懂
3. **重用步骤**：避免重复的步骤定义
4. **组织特性文件**：按功能模块组织特性文件
5. **使用数据表**：对于多组数据，使用数据表而不是多个场景

## 总结

在本节中，我们创建了一个完整的Cucumber项目，包括：

1. 实现了一个简单的登录系统
2. 编写了描述登录功能的特性文件
3. 实现了步骤定义代码
4. 创建了测试运行器
5. 运行并验证了测试结果

通过这个实例，我们学习了Cucumber的基本用法，包括特性文件编写、步骤定义实现和测试运行。在下一节中，我们将更深入地学习特性文件和步骤定义的详细内容。

## 思考题

1. 为什么在特性文件中使用Background而不是在每个场景中重复相同的Given步骤？
2. 步骤定义中的参数是如何与特性文件中的值匹配的？
3. 如果一个步骤定义方法没有找到匹配的特性文件步骤，会发生什么？
4. 数据表(DataTable)在Cucumber中有什么作用？如何使用？