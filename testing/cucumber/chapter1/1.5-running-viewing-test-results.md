# 1.5 运行和查看测试结果

## 运行Cucumber测试

在Cucumber中，有多种方式可以运行测试：

### 1. 使用Maven运行测试

最常见的方式是使用Maven运行测试：

```bash
mvn test
```

这将运行所有测试，包括Cucumber测试。

### 2. 使用IDE运行测试

大多数IDE都支持直接运行Cucumber测试：

#### IntelliJ IDEA

1. 右键点击特性文件或测试运行器类
2. 选择"Run 'FeatureName'"或"Run 'TestRunnerName'"
3. 查看运行结果

#### Eclipse

1. 右键点击特性文件或测试运行器类
2. 选择"Run As" > "Cucumber Feature"或"JUnit Test"
3. 查看运行结果

### 3. 使用命令行运行测试

也可以直接使用Java命令运行测试：

```bash
java -cp "target/classes:target/test-classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" io.cucumber.core.cli.Main --glue com.example.cucumber.stepdefinitions src/test/resources/features
```

## 测试运行器配置

测试运行器(Test Runner)是运行Cucumber测试的入口点，它使用`@CucumberOptions`注解配置测试运行选项。

### 基本配置

```java
import io.cucumber.junit.Cucumber;
import io.cucumber.junit.CucumberOptions;
import org.junit.runner.RunWith;

@RunWith(Cucumber.class)
@CucumberOptions(
    features = "src/test/resources/features",
    glue = "com.example.cucumber.stepdefinitions"
)
public class TestRunner {
}
```

### 常用配置选项

#### features选项

指定特性文件的位置：

```java
@CucumberOptions(
    features = "src/test/resources/features"
)
```

也可以指定特定的特性文件：

```java
@CucumberOptions(
    features = "src/test/resources/features/login.feature"
)
```

或使用通配符：

```java
@CucumberOptions(
    features = "src/test/resources/features/**/*.feature"
)
```

#### glue选项

指定步骤定义的位置：

```java
@CucumberOptions(
    glue = "com.example.cucumber.stepdefinitions"
)
```

可以指定多个包：

```java
@CucumberOptions(
    glue = {"com.example.cucumber.stepdefinitions", "com.example.common.steps"}
)
```

#### plugin选项

配置插件，用于生成不同格式的报告：

```java
@CucumberOptions(
    plugin = {
        "pretty",  // 控制台输出格式化结果
        "html:target/cucumber-reports/report.html",  // HTML报告
        "json:target/cucumber-reports/report.json",  // JSON报告
        "junit:target/cucumber-reports/report.xml"   // JUnit格式报告
    }
)
```

#### monochrome选项

控制控制台输出是否使用单色（不使用ANSI颜色代码）：

```java
@CucumberOptions(
    monochrome = true  // 使用单色输出，适合在CI环境中使用
)
```

#### tags选项

指定要运行的标签：

```java
@CucumberOptions(
    tags = "@smoke"  // 只运行标记为@smoke的场景
)
```

可以使用标签表达式：

```java
@CucumberOptions(
    tags = "@smoke and not @manual"  // 运行@smoke标签但不包含@manual标签的场景
)
```

#### dryRun选项

干运行模式，只验证步骤定义是否匹配，不执行实际代码：

```java
@CucumberOptions(
    dryRun = true  // 干运行模式
)
```

#### strict选项

严格模式，如果有未定义的步骤则测试失败：

```java
@CucumberOptions(
    strict = true  // 严格模式
)
```

## 测试结果解读

### 控制台输出

Cucumber在控制台输出的测试结果包含以下信息：

1. **特性文件名称**：正在运行的特性文件
2. **场景名称**：正在运行的场景
3. **步骤执行结果**：每个步骤的执行状态
4. **错误信息**：如果有步骤失败，显示错误信息
5. **统计信息**：总体测试结果统计

示例输出：

```
Feature: 用户登录功能

  Background:
    Given 系统中存在以下用户           # LoginSteps.系统中存在以下用户(DataTable)
      | username | password |
      | admin    | admin123 |
      | user     | password |
      | test     | test123  |

  Scenario: 成功登录                  # src/test/resources/features/login.feature:10
    Given 我是一个有效的用户           # LoginSteps.我是一个有效的用户()
    And 我的用户名是 "admin"          # LoginSteps.我的用户名是(String)
    And 我的密码是 "admin123"         # LoginSteps.我的密码是(String)
    When 我尝试登录系统               # LoginSteps.我尝试登录系统()
    Then 我应该能够成功登录           # LoginSteps.我应该能够成功登录()
    And 我应该看到 "登录成功" 的消息    # LoginSteps.我应该看到的消息(String)

  Scenario: 密码错误登录失败             # src/test/resources/features/login.feature:18
    Given 我是一个有效的用户           # LoginSteps.我是一个有效的用户()
    And 我的用户名是 "admin"          # LoginSteps.我的用户名是(String)
    And 我的密码是 "wrongpassword"    # LoginSteps.我的密码是(String)
    When 我尝试登录系统               # LoginSteps.我尝试登录系统()
    Then 我应该无法登录               # LoginSteps.我应该无法登录()
    And 我应该看到 "密码错误" 的消息    # LoginSteps.我应该看到的消息(String)

1 Scenarios (1 passed)
6 Steps (6 passed)
0m0.123s
```

### 步骤状态

每个步骤可能有以下状态：

1. **Passed**：步骤成功执行
2. **Failed**：步骤执行失败，有异常抛出
3. **Undefined**：没有找到匹配的步骤定义
4. **Pending**：步骤定义中有`PendingException`抛出
5. **Skipped**：由于前面的步骤失败而跳过

### HTML报告

HTML报告提供了更直观的测试结果展示，包括：

1. **特性概览**：所有特性的执行情况
2. **场景详情**：每个场景的详细执行结果
3. **步骤信息**：每个步骤的执行状态和耗时
4. **错误信息**：失败步骤的详细错误信息

HTML报告通常保存在`target/cucumber-reports`目录中，可以直接在浏览器中打开查看。

### JSON报告

JSON报告提供了机器可读的测试结果，可以用于：

1. **自定义报告**：解析JSON数据生成自定义报告
2. **CI/CD集成**：将测试结果集成到持续集成流程中
3. **数据分析**：分析测试趋势和覆盖率

### JUnit格式报告

JUnit格式报告与标准的JUnit测试报告兼容，可以：

1. **IDE集成**：在IDE中显示测试结果
2. **CI/CD集成**：与Jenkins等CI工具集成
3. **测试管理**：与测试管理工具集成

## 测试结果分析

### 成功场景分析

对于成功的场景，可以分析：

1. **执行时间**：检查是否有场景执行时间过长
2. **步骤覆盖**：确认所有业务场景都已覆盖
3. **数据依赖**：分析测试数据的使用情况

### 失败场景分析

对于失败的场景，需要分析：

1. **失败原因**：是代码缺陷还是测试问题
2. **错误信息**：查看详细的错误堆栈
3. **重现步骤**：确认是否可以稳定重现

### 未定义步骤分析

如果有未定义的步骤，需要：

1. **检查拼写**：确认特性文件中的步骤拼写正确
2. **匹配规则**：检查步骤定义的匹配规则
3. **添加定义**：为未定义的步骤添加步骤定义

## 测试报告定制

### 自定义HTML报告

可以通过实现`io.cucumber.core.plugin.Plugin`接口来创建自定义报告：

```java
public class CustomHtmlReporter implements EventListener {
    @Override
    public void setEventPublisher(EventPublisher publisher) {
        publisher.registerHandler(TestCaseStarted.class, this::handleTestCaseStarted);
        publisher.registerHandler(TestCaseFinished.class, this::handleTestCaseFinished);
        // 注册其他事件处理器
    }
    
    private void handleTestCaseStarted(TestCaseStarted event) {
        // 处理测试用例开始事件
    }
    
    private void handleTestCaseFinished(TestCaseFinished event) {
        // 处理测试用例结束事件
    }
}
```

然后在测试运行器中使用自定义报告：

```java
@CucumberOptions(
    plugin = {"com.example.CustomHtmlReporter:target/custom-report.html"}
)
```

### 集成第三方报告工具

Cucumber可以与多种第三方报告工具集成：

1. **Allure Report**：提供美观的测试报告
2. **ExtentReports**：提供丰富的报告功能
3. **ReportPortal**：提供测试结果分析和仪表板

## 测试结果与CI/CD集成

### Jenkins集成

在Jenkins中，可以使用Cucumber插件展示测试结果：

1. 安装Cucumber Reports Plugin
2. 在构建后操作中添加"Cucumber Report"步骤
3. 配置JSON报告文件路径

### GitLab CI/CD集成

在GitLab CI中，可以发布测试报告：

```yaml
test:
  stage: test
  script:
    - mvn test
  artifacts:
    reports:
      junit: target/cucumber-reports/report.xml
    paths:
      - target/cucumber-reports/
```

### GitHub Actions集成

在GitHub Actions中，可以发布测试报告：

```yaml
- name: Run tests
  run: mvn test
  
- name: Publish test results
  uses: actions/upload-artifact@v2
  with:
    name: cucumber-reports
    path: target/cucumber-reports/
```

## 测试结果优化

### 减少测试执行时间

1. **并行执行**：使用Cucumber的并行执行功能
2. **选择性执行**：使用标签只运行相关测试
3. **优化代码**：优化步骤定义代码的执行效率

### 提高测试稳定性

1. **重试机制**：为不稳定测试添加重试逻辑
2. **环境隔离**：确保测试环境的一致性
3. **数据管理**：合理管理测试数据，避免数据冲突

## 总结

本节介绍了如何运行Cucumber测试并查看测试结果，包括：

1. 多种运行测试的方式
2. 测试运行器的配置选项
3. 测试结果的解读和分析
4. 测试报告的定制和集成
5. 测试结果的优化技巧

通过合理配置和使用测试运行器，可以有效地运行和分析Cucumber测试，从而提高测试效率和质量。

## 思考题

1. 如何使用标签来选择性运行特定的测试场景？
2. 如果一个步骤定义没有找到匹配的特性文件步骤，如何调试？
3. 如何将Cucumber测试结果集成到CI/CD流程中？
4. 在并行执行Cucumber测试时，需要注意哪些问题？