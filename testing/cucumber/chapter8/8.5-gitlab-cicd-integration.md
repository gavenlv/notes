# 8.5 GitLab CI/CD集成详解

## 引言

GitLab CI/CD是GitLab提供的内置CI/CD服务，通过.gitlab-ci.yml文件定义流水线，与GitLab仓库紧密集成。将Cucumber测试集成到GitLab CI/CD中，可以实现自动化验收测试，提高软件交付的质量和效率。本章将深入探讨Cucumber与GitLab CI/CD集成的详细配置、高级功能和最佳实践。

## GitLab CI/CD基础

### 1. 工作流文件结构

GitLab CI/CD配置文件`.gitlab-ci.yml`位于项目根目录，使用YAML格式定义：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - quality
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS test
```

### 2. GitLab CI/CD关键概念

- **Stages**：定义流水线的阶段，按顺序执行
- **Jobs**：定义具体的任务，分配到不同阶段
- **Runners**：执行任务的执行器，可以是共享的、特定的或分组的
- **Variables**：定义环境变量，支持全局、组和项目级别
- **Cache**：缓存依赖和构建产物，加速构建过程
- **Artifacts**：保存构建产物，供后续阶段使用

## 基本集成配置

### 1. 简单的Cucumber测试流水线

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - report

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

unit-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS test
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

publish-report:
  stage: report
  image: alpine:latest
  dependencies:
    - cucumber-test
  script:
    - echo "Publishing Cucumber reports"
  artifacts:
    paths:
      - target/cucumber-reports/
    expire_in: 1 month
  only:
    - main
```

### 2. 多环境测试流水线

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

test-dev:
  stage: test
  image: maven:3.8.6-openjdk-11
  variables:
    SPRING_PROFILES_ACTIVE: test,dev
    BASE_URL: https://dev.example.com
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber -DbaseUrl=$BASE_URL
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  only:
    - develop

test-staging:
  stage: test
  image: maven:3.8.6-openjdk-11
  variables:
    SPRING_PROFILES_ACTIVE: test,staging
    BASE_URL: https://staging.example.com
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber -DbaseUrl=$BASE_URL
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  only:
    - main

deploy-staging:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to staging environment"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - main

deploy-production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to production environment"
  environment:
    name: production
    url: https://example.com
  when: manual
  only:
    - main
```

## 高级集成功能

### 1. 并行测试执行

使用GitLab CI/CD的并行功能执行不同类型的Cucumber测试：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - report

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  parallel: 4
  script:
    - |
      case $CI_NODE_INDEX in
        1)
          echo "Running API tests"
          mvn $MAVEN_CLI_OPTS verify -P cucumber -Dcucumber.options="--tags @api --plugin json:target/api-cucumber.json"
          ;;
        2)
          echo "Running UI tests"
          mvn $MAVEN_CLI_OPTS verify -P cucumber -Dcucumber.options="--tags @ui --plugin json:target/ui-cucumber.json"
          ;;
        3)
          echo "Running Integration tests"
          mvn $MAVEN_CLI_OPTS verify -P cucumber -Dcucumber.options="--tags @integration --plugin json:target/integration-cucumber.json"
          ;;
        4)
          echo "Running Performance tests"
          mvn $MAVEN_CLI_OPTS verify -P cucumber -Dcucumber.options="--tags @performance --plugin json:target/performance-cucumber.json"
          ;;
      esac
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/*-cucumber.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

merge-reports:
  stage: report
  image: maven:3.8.6-openjdk-11
  dependencies:
    - cucumber-test
  script:
    - |
      # 安装Node.js和报告合并工具
      apt-get update && apt-get install -y nodejs npm
      npm install -g cucumber-report-merger
      
      # 合并报告
      mkdir -p target/cucumber-reports
      cucumber-report-merger -i "target/*-cucumber.json" -o target/cucumber-reports/merged-cucumber.json
      
      # 生成HTML报告
      mvn cucumber-reporting:generate -Dcucumber.outputDir=target/cucumber-reports -Dcucumber.jsonFiles=target/cucumber-reports/merged-cucumber.json
  artifacts:
    paths:
      - target/cucumber-reports/
    expire_in: 1 month
  only:
    - main
```

### 2. 测试环境管理

使用Docker服务管理测试环境：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - cleanup

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  POSTGRES_DB: testdb
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test
  SPRING_PROFILES_ACTIVE: test

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  services:
    - postgres:15
    - rabbitmq:3.11-management
    - redis:7-alpine
  variables:
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: $POSTGRES_DB
    DB_USER: $POSTGRES_USER
    DB_PASSWORD: $POSTGRES_PASSWORD
    RABBITMQ_HOST: rabbitmq
    RABBITMQ_PORT: 5672
    RABBITMQ_USER: guest
    RABBITMQ_PASSWORD: guest
    REDIS_HOST: redis
    REDIS_PORT: 6379
  script:
    - |
      # 等待服务启动
      echo "Waiting for services to be ready..."
      
      # 等待PostgreSQL
      until pg_isready -h $DB_HOST -p $DB_PORT; do
        echo "Waiting for PostgreSQL..."
        sleep 2
      done
      
      # 等待RabbitMQ
      until rabbitmq-diagnostics -q ping; do
        echo "Waiting for RabbitMQ..."
        sleep 2
      done
      
      # 等待Redis
      until redis-cli -h $REDIS_HOST -p $REDIS_PORT ping; do
        echo "Waiting for Redis..."
        sleep 2
      done
      
      # 运行Cucumber测试
      mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

cleanup:
  stage: cleanup
  image: alpine:latest
  script:
    - echo "Cleaning up test environment"
  when: always
  dependencies: []
```

### 3. 测试数据管理

实现测试数据的自动化准备和清理：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - prepare-data
  - test
  - cleanup-data

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  POSTGRES_DB: testdb
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test
  SPRING_PROFILES_ACTIVE: test

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

prepare-test-data:
  stage: prepare-data
  image: maven:3.8.6-openjdk-11
  services:
    - postgres:15
  variables:
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: $POSTGRES_DB
    DB_USER: $POSTGRES_USER
    DB_PASSWORD: $POSTGRES_PASSWORD
  script:
    - |
      # 等待PostgreSQL启动
      until pg_isready -h $DB_HOST -p $DB_PORT; do
        echo "Waiting for PostgreSQL..."
        sleep 2
      done
      
      # 准备测试数据
      mvn $MAVEN_CLI_OPTS test-compile exec:java -Dexec.mainClass="com.example.cucumber.datapreparation.DataPreparation"
  artifacts:
    paths:
      - test-data/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  services:
    - postgres:15
  variables:
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: $POSTGRES_DB
    DB_USER: $POSTGRES_USER
    DB_PASSWORD: $POSTGRES_PASSWORD
  dependencies:
    - prepare-test-data
  script:
    - |
      # 等待PostgreSQL启动
      until pg_isready -h $DB_HOST -p $DB_PORT; do
        echo "Waiting for PostgreSQL..."
        sleep 2
      done
      
      # 运行Cucumber测试
      mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

cleanup-test-data:
  stage: cleanup-data
  image: maven:3.8.6-openjdk-11
  services:
    - postgres:15
  variables:
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: $POSTGRES_DB
    DB_USER: $POSTGRES_USER
    DB_PASSWORD: $POSTGRES_PASSWORD
  script:
    - |
      # 等待PostgreSQL启动
      until pg_isready -h $DB_HOST -p $DB_PORT; do
        echo "Waiting for PostgreSQL..."
        sleep 2
      done
      
      # 清理测试数据
      mvn $MAVEN_CLI_OPTS test-compile exec:java -Dexec.mainClass="com.example.cucumber.datapreparation.DataCleanup"
  when: always
  dependencies: []
  only:
    - merge_requests
    - main
    - develop
```

### 4. 测试报告聚合与发布

聚合多个测试套件的报告，并发布到GitLab Pages：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - report
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

test-api:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P api-tests -Dcucumber.options="--plugin json:target/api-cucumber.json"
  artifacts:
    reports:
      junit: target/cucumber-reports/api-cucumber.xml
    paths:
      - target/api-cucumber.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

test-ui:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P ui-tests -Dcucumber.options="--plugin json:target/ui-cucumber.json"
  artifacts:
    reports:
      junit: target/cucumber-reports/ui-cucumber.xml
    paths:
      - target/ui-cucumber.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

test-integration:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P integration-tests -Dcucumber.options="--plugin json:target/integration-cucumber.json"
  artifacts:
    reports:
      junit: target/cucumber-reports/integration-cucumber.xml
    paths:
      - target/integration-cucumber.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

merge-reports:
  stage: report
  image: maven:3.8.6-openjdk-11
  dependencies:
    - test-api
    - test-ui
    - test-integration
  script:
    - |
      # 安装Node.js和报告合并工具
      apt-get update && apt-get install -y nodejs npm
      npm install -g cucumber-report-merger
      
      # 合并报告
      mkdir -p target/cucumber-reports
      cucumber-report-merger -i "target/*-cucumber.json" -o target/cucumber-reports/merged-cucumber.json
      
      # 生成HTML报告
      mvn cucumber-reporting:generate -Dcucumber.outputDir=target/cucumber-reports -Dcucumber.jsonFiles=target/cucumber-reports/merged-cucumber.json
      
      # 生成测试摘要
      echo "## Cucumber Test Summary" > target/cucumber-reports/summary.md
      echo "" >> target/cucumber-reports/summary.md
      
      # 提取测试结果统计
      total_features=$(jq '. | length' target/cucumber-reports/merged-cucumber.json)
      total_scenarios=$(jq '[.[].elements | length] | add' target/cucumber-reports/merged-cucumber.json)
      passed_scenarios=$(jq '[.[].elements | map(select(.steps[].result.status == "passed")) | length] | add' target/cucumber-reports/merged-cucumber.json)
      failed_scenarios=$((total_scenarios - passed_scenarios))
      
      echo "- Total Features: $total_features" >> target/cucumber-reports/summary.md
      echo "- Total Scenarios: $total_scenarios" >> target/cucumber-reports/summary.md
      echo "- Passed Scenarios: $passed_scenarios" >> target/cucumber-reports/summary.md
      echo "- Failed Scenarios: $failed_scenarios" >> target/cucumber-reports/summary.md
  artifacts:
    paths:
      - target/cucumber-reports/
    expire_in: 1 month
  only:
    - main

pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - merge-reports
  script:
    - mkdir -p public
    - cp -r target/cucumber-reports/* public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
```

## 测试结果通知

### 1. GitLab内置通知

利用GitLab内置的通知功能发送测试结果：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - notify

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

notify-success:
  stage: notify
  image: alpine:latest
  script:
    - |
      # 提取测试结果统计
      if [ -f target/cucumber-reports/cucumber.json ]; then
        total_features=$(jq '. | length' target/cucumber-reports/cucumber.json)
        total_scenarios=$(jq '[.[].elements | length] | add' target/cucumber-reports/cucumber.json)
        passed_scenarios=$(jq '[.[].elements | map(select(.steps[].result.status == "passed")) | length] | add' target/cucumber-reports/cucumber.json)
        failed_scenarios=$((total_scenarios - passed_scenarios))
        
        message="✅ Cucumber tests passed! Features: $total_features, Scenarios: $passed_scenarios passed, $failed_scenarios failed"
      else
        message="✅ Cucumber tests passed! No test report found."
      fi
      
      # 发送通知到GitLab API
      curl -X POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data "note=$message" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
  when: on_success
  only:
    - merge_requests

notify-failure:
  stage: notify
  image: alpine:latest
  script:
    - |
      # 提取测试结果统计
      if [ -f target/cucumber-reports/cucumber.json ]; then
        total_features=$(jq '. | length' target/cucumber-reports/cucumber.json)
        total_scenarios=$(jq '[.[].elements | length] | add' target/cucumber-reports/cucumber.json)
        passed_scenarios=$(jq '[.[].elements | map(select(.steps[].result.status == "passed")) | length] | add' target/cucumber-reports/cucumber.json)
        failed_scenarios=$((total_scenarios - passed_scenarios))
        
        message="❌ Cucumber tests failed! Features: $total_features, Scenarios: $passed_scenarios passed, $failed_scenarios failed"
      else
        message="❌ Cucumber tests failed! No test report found."
      fi
      
      # 发送通知到GitLab API
      curl -X POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data "note=$message" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
  when: on_failure
  only:
    - merge_requests
```

### 2. Slack通知

集成Slack通知，及时反馈测试结果：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - notify

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

notify-slack:
  stage: notify
  image: alpine:latest
  dependencies:
    - cucumber-test
  script:
    - |
      # 安装jq
      apk add --no-cache jq
      
      # 提取测试结果统计
      if [ -f target/cucumber-reports/cucumber.json ]; then
        total_features=$(jq '. | length' target/cucumber-reports/cucumber.json)
        total_scenarios=$(jq '[.[].elements | length] | add' target/cucumber-reports/cucumber.json)
        passed_scenarios=$(jq '[.[].elements | map(select(.steps[].result.status == "passed")) | length] | add' target/cucumber-reports/cucumber.json)
        failed_scenarios=$((total_scenarios - passed_scenarios))
        
        if [ $failed_scenarios -gt 0 ]; then
          color="danger"
          status="Failed"
        else
          color="good"
          status="Passed"
        fi
        
        # 构建Slack消息
        payload=$(cat <<EOF
        {
          "attachments": [
            {
              "color": "$color",
              "title": "Cucumber Test Results: $status",
              "title_link": "$CI_PIPELINE_URL",
              "fields": [
                {
                  "title": "Project",
                  "value": "$CI_PROJECT_NAME",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "$CI_COMMIT_REF_NAME",
                  "short": true
                },
                {
                  "title": "Pipeline",
                  "value": "<$CI_PIPELINE_URL|#$CI_PIPELINE_ID>",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "<$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|$CI_COMMIT_SHORT_SHA>",
                  "short": true
                },
                {
                  "title": "Features",
                  "value": "$total_features",
                  "short": true
                },
                {
                  "title": "Scenarios",
                  "value": "$passed_scenarios passed, $failed_scenarios failed",
                  "short": true
                }
              ],
              "footer": "GitLab CI/CD",
              "ts": $(date +%s)
            }
          ]
        }
        EOF
        )
        
        # 发送Slack通知
        curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL
      fi
  when: always
  only:
    - merge_requests
    - main
    - develop
```

### 3. 邮件通知

发送详细的测试结果邮件：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - notify

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS compile

cucumber-test:
  stage: test
  image: maven:3.8.6-openjdk-11
  script:
    - mvn $MAVEN_CLI_OPTS verify -P cucumber
  artifacts:
    reports:
      junit: target/cucumber-reports/cucumber.xml
    paths:
      - target/cucumber-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
    - develop

notify-email:
  stage: notify
  image: alpine:latest
  dependencies:
    - cucumber-test
  before_script:
    - apk add --no-cache jq
  script:
    - |
      # 提取测试结果统计
      if [ -f target/cucumber-reports/cucumber.json ]; then
        total_features=$(jq '. | length' target/cucumber-reports/cucumber.json)
        total_scenarios=$(jq '[.[].elements | length] | add' target/cucumber-reports/cucumber.json)
        passed_scenarios=$(jq '[.[].elements | map(select(.steps[].result.status == "passed")) | length] | add' target/cucumber-reports/cucumber.json)
        failed_scenarios=$((total_scenarios - passed_scenarios))
        
        if [ $failed_scenarios -gt 0 ]; then
          status="Failed"
        else
          status="Passed"
        fi
        
        # 构建邮件内容
        subject="Cucumber Test Results: $status - $CI_PROJECT_NAME - $CI_PIPELINE_ID"
        
        body=$(cat <<EOF
        <html>
        <body>
          <h2>Cucumber Test Results</h2>
          <p><strong>Project:</strong> $CI_PROJECT_NAME</p>
          <p><strong>Branch:</strong> $CI_COMMIT_REF_NAME</p>
          <p><strong>Pipeline:</strong> <a href="$CI_PIPELINE_URL">#$CI_PIPELINE_ID</a></p>
          <p><strong>Commit:</strong> <a href="$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA">$CI_COMMIT_SHORT_SHA</a></p>
          <p><strong>Status:</strong> $status</p>
          <p><strong>Features:</strong> $total_features</p>
          <p><strong>Scenarios:</strong> $passed_scenarios passed, $failed_scenarios failed</p>
          <p><strong>Build URL:</strong> <a href="$CI_PIPELINE_URL">View Pipeline</a></p>
        </body>
        </html>
        EOF
        )
        
        # 发送邮件
        curl -X POST "$SMTP_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "personalizations": [
              {
                "to": [
                  {
                    "email": "$CI_COMMIT_AUTHOR_EMAIL",
                    "name": "$CI_COMMIT_AUTHOR_NAME"
                  }
                ],
                "subject": "'"$subject"'"
              }
            ],
            "from": {
              "email": "gitlab@example.com",
              "name": "GitLab CI/CD"
            },
            "content": [
              {
                "type": "text/html",
                "value": "'"$body"'"
              }
            ]
          }'
      fi
  when: always
  only:
    - merge_requests
    - main
    - develop
```

## 最佳实践

### 1. 流水线组织

- 将复杂的工作流分解为多个阶段和任务
- 使用并行执行提高测试效率
- 根据测试类型和环境选择合适的执行策略

### 2. 缓存优化

- 缓存Maven依赖和构建产物
- 使用适当的缓存键和路径
- 定期清理过期的缓存

### 3. 测试环境管理

- 使用Docker服务管理测试环境
- 确保测试环境的一致性和隔离性
- 在测试后清理测试环境

### 4. 测试数据管理

- 实现测试数据的自动化准备和清理
- 使用测试数据工厂生成测试数据
- 避免测试数据之间的相互影响

### 5. 测试报告

- 生成详细的测试报告，包括测试结果和覆盖率
- 聚合多个测试套件的报告
- 提供易于理解的测试结果可视化

### 6. 安全考虑

- 使用GitLab CI/CD变量存储敏感信息
- 限制流水线的权限范围
- 定期审查和更新依赖

## 总结

GitLab CI/CD与Cucumber的集成为自动化验收测试提供了强大而灵活的解决方案，通过合理的流水线设计和最佳实践，可以实现高效、可靠的测试流程。在实际项目中，应该根据项目需求和团队技能，选择最适合的集成方案，并持续优化测试流程，实现快速、高质量的软件交付。