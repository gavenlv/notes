# 2.1 Gherkin语言基础

## Gherkin简介

Gherkin是一种业务可读的、领域特定的语言，用于描述软件的行为。它是Cucumber框架的核心组成部分，允许开发人员、测试人员和非技术人员（如业务分析师、产品经理）使用共同的语言来描述软件功能。

Gherkin的设计目标是让非技术人员能够轻松阅读和理解，同时保持足够的结构化以便自动化测试。这种语言使用简单的关键词和自然语言（如英语、中文等）来描述软件的行为。

### Gherkin的特点

1. **业务可读性**：使用自然语言描述，非技术人员也能理解
2. **结构化**：有固定的语法结构，便于解析和自动化
3. **多语言支持**：支持多种自然语言，包括中文
4. **关注行为**：专注于描述软件的行为，而不是实现细节
5. **可执行性**：可以直接作为自动化测试的输入

## Gherkin文件结构

Gherkin文件通常以`.feature`为扩展名，包含一个或多个场景（Scenario），每个场景描述一个特定的功能或行为。

### 基本结构

```
1. Feature: 功能描述
2. Background: 背景设置（可选）
3. Scenario: 场景1
4. Scenario: 场景2
5. Scenario Outline: 场景大纲（可选）
6. Examples: 示例数据（与场景大纲配合使用）
```

### 示例

```gherkin
# language: zh-CN
功能: 用户登录
  作为一个系统用户
  我希望能够登录系统
  以便访问系统功能

  背景:
    Given 系统已启动
    And 数据库连接正常

  场景: 成功登录
    Given 用户 "admin" 存在
    And 用户 "admin" 的密码是 "admin123"
    When 我使用用户名 "admin" 和密码 "admin123" 登录
    Then 我应该能够成功登录
    And 我应该看到 "欢迎" 消息

  场景: 密码错误
    Given 用户 "admin" 存在
    And 用户 "admin" 的密码是 "admin123"
    When 我使用用户名 "admin" 和密码 "wrongpassword" 登录
    Then 我应该无法登录
    And 我应该看到 "密码错误" 消息

  场景大纲: 多种用户登录测试
    Given 用户 "<username>" 存在
    And 用户 "<username>" 的密码是 "<password>"
    When 我使用用户名 "<username>" 和密码 "<loginPassword>" 登录
    Then 我应该<result>登录
    And 我应该看到 "<message>" 消息

    例子:
      | username | password   | loginPassword | result | message     |
      | admin    | admin123   | admin123      | 成功   | 欢迎        |
      | user     | user123    | user123       | 成功   | 欢迎        |
      | admin    | admin123   | wrongpassword | 失败   | 密码错误    |
```

## Gherkin关键字

Gherkin使用一组预定义的关键字来构建测试场景。以下是Gherkin的主要关键字：

### 1. Feature（功能）

`Feature`关键字用于描述软件的一个功能或特性。它通常包含一个简短的标题和一个更详细的描述，说明这个功能的目的和价值。

```gherkin
功能: 用户注册
  作为一个新用户
  我希望能够注册一个新账户
  以便使用系统的所有功能
```

### 2. Background（背景）

`Background`关键字用于定义在所有场景之前执行的步骤。它用于设置通用的前置条件，避免在每个场景中重复相同的步骤。

```gherkin
背景:
  Given 系统已启动
  And 数据库连接正常
  And 管理员用户已创建
```

### 3. Scenario（场景）

`Scenario`关键字用于描述一个具体的测试场景，包含一系列的步骤。每个场景应该测试一个特定的行为或功能点。

```gherkin
场景: 成功注册新用户
  Given 我在注册页面
  When 我输入有效的用户名、邮箱和密码
  And 我点击注册按钮
  Then 我应该看到注册成功的消息
  And 我应该被重定向到登录页面
```

### 4. Scenario Outline（场景大纲）

`Scenario Outline`关键字用于创建参数化的场景，允许使用不同的数据集运行相同的场景。它必须与`Examples`关键字配合使用。

```gherkin
场景大纲: 密码验证
  Given 我在注册页面
  When 我输入用户名 "testuser" 和密码 "<password>"
  And 我点击注册按钮
  Then 我应该<result>注册

  例子:
    | password      | result |
    | 123456        | 成功   |
    | 123           | 失败   |
    | ""            | 失败   |
```

### 5. Examples（示例）

`Examples`关键字用于提供场景大纲中使用的数据集。它以表格形式呈现，第一行是列标题，后续行是数据值。

```gherkin
例子:
  | username | email           | password   |
  | admin    | admin@test.com  | admin123   |
  | user     | user@test.com   | user123    |
  | test     | test@test.com   | test123    |
```

### 6. Given（给定）

`Given`关键字用于设置场景的初始状态或前置条件。它描述了场景开始时系统的状态。

```gherkin
Given 用户 "admin" 存在
And 用户 "admin" 的密码是 "admin123"
And 系统处于正常运行状态
```

### 7. When（当）

`When`关键字用于描述用户执行的动作或事件。它触发了被测试的行为。

```gherkin
When 我使用用户名 "admin" 和密码 "admin123" 登录
When 我点击"提交"按钮
When 我在搜索框中输入"测试"
```

### 8. Then（那么）

`Then`关键字用于描述预期的结果或输出。它验证系统的行为是否符合预期。

```gherkin
Then 我应该能够成功登录
Then 我应该看到"登录成功"的消息
Then 页面应该显示用户信息
```

### 9. And（并且）

`And`关键字用于重复前一个关键字的类型。它使场景描述更加自然流畅。

```gherkin
Given 用户 "admin" 存在
And 用户 "admin" 的密码是 "admin123"
And 系统处于正常运行状态

When 我使用用户名 "admin" 和密码 "admin123" 登录
And 我点击"登录"按钮

Then 我应该能够成功登录
And 我应该看到"欢迎"消息
And 页面应该显示用户信息
```

### 10. But（但是）

`But`关键字也用于重复前一个关键字的类型，但通常用于表示对比或例外情况。

```gherkin
Then 我应该看到登录成功的消息
But 我不应该看到错误提示
```

## Gherkin语法规则

### 1. 缩进和格式

Gherkin对缩进没有严格要求，但良好的缩进可以提高可读性。通常每个关键字占一行，步骤内容在同一行。

```gherkin
场景: 示例场景
  Given 第一个步骤
    And 嵌套的步骤（可选）
  When 第二个步骤
  Then 第三个步骤
```

### 2. 注释

Gherkin支持以`#`开头的单行注释，注释会被解析器忽略。

```gherkin
# 这是一个注释
功能: 示例功能
  # 这是另一个注释
  场景: 示例场景
    Given 这是一个步骤 # 行内注释
```

### 3. 多行文本

使用`"""`可以定义多行文本，适用于描述长文本内容。

```gherkin
场景: 发送邮件
  Given 我在邮件编辑页面
  When 我输入以下内容:
    """
    尊敬的用户：

    感谢您注册我们的服务。
    我们很高兴为您提供服务。

    祝好，
    客服团队
    """
  And 我点击发送按钮
  Then 邮件应该被成功发送
```

### 4. 数据表

使用`|`分隔的数据表可以传递结构化数据。

```gherkin
场景: 批量创建用户
  Given 我在用户管理页面
  When 我输入以下用户信息:
    | username | email           | role    |
    | admin    | admin@test.com  | admin   |
    | user1    | user1@test.com  | user    |
    | user2    | user2@test.com  | user    |
  And 我点击创建按钮
  Then 所有用户应该被成功创建
```

## Gherkin最佳实践

### 1. 使用业务语言

使用业务术语而非技术术语，让非技术人员也能理解。

```gherkin
# 好的例子
场景: 用户购买商品
  Given 用户已登录
  And 购物车中有商品
  When 用户提交订单
  Then 订单应该被成功创建

# 不好的例子
场景: 用户购买商品
  Given 用户session有效
  And cart表中有记录
  When 调用orderService.createOrder()
  Then order表应该有新记录
```

### 2. 保持场景独立

每个场景应该是独立的，不依赖其他场景的执行结果。

```gherkin
# 好的例子
场景: 用户登录
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  Then 我应该能够成功登录

场景: 用户修改密码
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  And 我修改密码为 "newpassword"
  Then 密码应该被成功修改

# 不好的例子
场景: 用户登录
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  Then 我应该能够成功登录

场景: 用户修改密码
  When 我修改密码为 "newpassword"  # 依赖于前一个场景的登录状态
  Then 密码应该被成功修改
```

### 3. 使用场景大纲处理多种情况

对于相似的场景，使用场景大纲和示例数据表，避免重复代码。

```gherkin
# 好的例子
场景大纲: 用户登录验证
  Given 用户 "<username>" 存在且密码为 "<password>"
  When 我使用用户名 "<username>" 和密码 "<loginPassword>" 登录
  Then 我应该<result>登录

  例子:
    | username | password   | loginPassword | result |
    | admin    | admin123   | admin123      | 成功   |
    | admin    | admin123   | wrongpassword | 失败   |
    | invalid  | password   | password      | 失败   |

# 不好的例子
场景: 用户成功登录
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  Then 我应该成功登录

场景: 用户密码错误
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "wrongpassword" 登录
  Then 我应该登录失败

场景: 用户不存在
  Given 用户 "invalid" 不存在
  When 我使用用户名 "invalid" 和密码 "password" 登录
  Then 我应该登录失败
```

### 4. 保持场景简洁

每个场景应该专注于一个特定的行为，避免过于复杂。

```gherkin
# 好的例子
场景: 用户成功登录
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  Then 我应该能够成功登录

场景: 登录后显示用户信息
  Given 用户 "admin" 已成功登录
  When 我查看用户信息页面
  Then 我应该看到用户名 "admin"
  And 我应该看到用户邮箱

# 不好的例子
场景: 用户登录和查看信息
  Given 用户 "admin" 存在且密码为 "admin123"
  When 我使用用户名 "admin" 和密码 "admin123" 登录
  And 我查看用户信息页面
  Then 我应该能够成功登录
  And 我应该看到用户名 "admin"
  And 我应该看到用户邮箱
```

### 5. 使用描述性的场景名称

场景名称应该清楚地描述场景的目的和预期结果。

```gherkin
# 好的例子
场景: 使用有效凭据成功登录
场景: 使用无效密码登录失败
场景: 使用不存在的用户名登录失败

# 不好的例子
场景: 测试1
场景: 登录测试
场景: 场景A
```

## Gherkin多语言支持

Gherkin支持多种自然语言，包括中文。使用`# language:`指令可以指定Gherkin文件使用的语言。

```gherkin
# language: zh-CN
功能: 用户登录
  作为一个系统用户
  我希望能够登录系统
  以便访问系统功能

  场景: 成功登录
    Given 用户 "admin" 存在
    And 用户 "admin" 的密码是 "admin123"
    When 我使用用户名 "admin" 和密码 "admin123" 登录
    Then 我应该能够成功登录
    And 我应该看到 "欢迎" 消息
```

以下是中文Gherkin的关键字对应表：

| 英文关键字 | 中文关键字 |
|-----------|-----------|
| Feature   | 功能      |
| Background| 背景      |
| Scenario  | 场景      |
| Scenario Outline | 场景大纲 |
| Examples  | 例子      |
| Given     | 给定      |
| When      | 当        |
| Then      | 那么      |
| And       | 并且      |
| But       | 但是      |

## Gherkin与BDD的关系

Gherkin是行为驱动开发（BDD）实践的重要工具，它充当了业务需求和技术实现之间的桥梁。通过Gherkin，团队可以：

1. **共同理解需求**：使用共同的语言描述功能，确保所有人对需求有一致的理解。
2. **可执行的需求文档**：Gherkin文件既是需求文档，又是自动化测试的输入。
3. **持续验证**：通过自动化测试持续验证系统行为是否符合预期。
4. **促进沟通**：促进开发人员、测试人员和业务人员之间的沟通。

## 总结

Gherkin是一种简单而强大的语言，用于描述软件的行为。通过使用自然语言和结构化的语法，它使得非技术人员能够参与软件测试和需求定义过程。掌握Gherkin的基础知识是使用Cucumber进行BDD开发的第一步，也是最重要的一步。

在下一节中，我们将深入学习Gherkin的高级特性，包括更复杂的场景设计、数据表的使用以及如何编写更有效的Gherkin场景。