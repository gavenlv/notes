# 2.5 Gherkin实战案例与代码示例

## 实战案例1：电子商务系统

### 1. 用户注册与登录

#### 英文版本

```gherkin
# language: en
Feature: User Authentication
  As a potential customer
  I want to register and login to the e-commerce system
  So that I can purchase products and track my orders

  Background:
    Given the authentication service is running
    And the registration page is accessible

  Scenario: Successful user registration
    Given I am on the registration page
    When I enter valid registration details:
      | Field      | Value              |
      | Username   | johndoe           |
      | Email      | john@example.com  |
      | Password   | Password123!      |
      | Confirm Password | Password123! |
      | First Name | John              |
      | Last Name  | Doe               |
    And I agree to the terms and conditions
    And I click the register button
    Then I should be redirected to the verification page
    And I should receive a verification email
    And my account should be created with "unverified" status

  Scenario: Registration with existing email
    Given a user with email "existing@example.com" already exists
    And I am on the registration page
    When I enter registration details with email "existing@example.com"
    And I click the register button
    Then I should remain on the registration page
    And I should see an error message "Email already exists"

  Scenario: Successful user login
    Given a verified user "johndoe" exists with password "Password123!"
    And I am on the login page
    When I enter username "johndoe" and password "Password123!"
    And I click the login button
    Then I should be redirected to the dashboard
    And I should see a welcome message "Welcome, John Doe"

  Scenario: Login with invalid credentials
    Given a user "johndoe" exists with password "Password123!"
    And I am on the login page
    When I enter username "johndoe" and password "WrongPassword!"
    And I click the login button
    Then I should remain on the login page
    And I should see an error message "Invalid username or password"

  Scenario Outline: Password validation during registration
    Given I am on the registration page
    When I enter valid registration details except password "<password>"
    And I click the register button
    Then I should see password validation message "<validationMessage>"

    Examples:
      | password       | validationMessage                     |
      | 123            | Password must be at least 8 characters |
      | password       | Password must contain at least one uppercase letter |
      | PASSWORD       | Password must contain at least one lowercase letter |
      | Password123    | Password must contain at least one special character |
```

#### 中文版本

```gherkin
# language: zh-CN
功能: 用户认证
  作为潜在客户
  我想要注册并登录电子商务系统
  以便购买产品和跟踪我的订单

  背景:
    假如 认证服务正在运行
    而且 注册页面可以访问

  场景: 成功的用户注册
    假如 我在注册页面
    当 我输入有效的注册详情:
      | 字段        | 值              |
      | 用户名      | johndoe         |
      | 邮箱        | john@example.com|
      | 密码        | Password123!    |
      | 确认密码    | Password123!    |
      | 名字        | John            |
      | 姓氏        | Doe             |
    而且 我同意条款和条件
    而且 我点击注册按钮
    那么 我应该被重定向到验证页面
    而且 我应该收到验证邮件
    而且我的账户应该被创建，状态为"未验证"

  场景: 使用已存在的邮箱注册
    假如 邮箱为"existing@example.com"的用户已存在
    而且 我在注册页面
    当 我输入注册详情，邮箱为"existing@example.com"
    而且 我点击注册按钮
    那么 我应该停留在注册页面
    而且 我应该看到错误消息"邮箱已存在"

  场景: 成功的用户登录
    假如 已验证用户"johndoe"存在，密码为"Password123!"
    而且 我在登录页面
    当 我输入用户名"johndoe"和密码"Password123!"
    而且 我点击登录按钮
    那么 我应该被重定向到仪表板
    而且 我应该看到欢迎消息"欢迎，John Doe"

  场景: 使用无效凭据登录
    假如 用户"johndoe"存在，密码为"Password123!"
    而且 我在登录页面
    当 我输入用户名"johndoe"和密码"WrongPassword!"
    而且 我点击登录按钮
    那么 我应该停留在登录页面
    而且 我应该看到错误消息"用户名或密码无效"

  场景大纲: 注册期间的密码验证
    假如 我在注册页面
    当 我输入有效的注册详情，但密码为"<password>"
    而且 我点击注册按钮
    那么我应该看到密码验证消息"<validationMessage>"

    例子:
      | password       | validationMessage                     |
      | 123            | 密码必须至少8个字符                   |
      | password       | 密码必须包含至少一个大写字母          |
      | PASSWORD       | 密码必须包含至少一个小写字母          |
      | Password123    | 密码必须包含至少一个特殊字符          |
```

### 2. 产品浏览与搜索

```gherkin
# language: en
Feature: Product Browsing and Searching
  As a customer
  I want to browse and search for products
  So that I can find items I want to purchase

  Background:
    Given the product catalog contains various products
    And the search service is running

  Scenario: Browse products by category
    Given I am on the home page
    When I navigate to the "Electronics" category
    Then I should see products in the Electronics category
    And the products should be sorted by relevance by default
    And each product should display its name, price, and image

  Scenario: Search for products by keyword
    Given I am on the search page
    When I enter "iPhone" in the search box
    And I click the search button
    Then I should see products related to "iPhone"
    And the search results should be sorted by relevance
    And each product should match the search criteria

  Scenario: Filter search results
    Given I have searched for "laptop"
    And I see search results
    When I filter by brand "Apple"
    And I filter by price range "$1000 - $2000"
    And I filter by rating "4 stars and above"
    Then I should see only Apple laptops priced between $1000 and $2000 with 4+ stars rating
    And the filter criteria should be displayed

  Scenario Outline: Sort search results
    Given I have searched for "smartphone"
    And I see search results
    When I sort the results by "<sortOption>"
    Then the results should be sorted by "<sortOption>"

    Examples:
      | sortOption        | Description                         |
      | Price: Low to High| Products sorted from lowest to highest price |
      | Price: High to Low| Products sorted from highest to lowest price |
      | Rating            | Products sorted from highest to lowest rating |
      | Newest First      | Products sorted by newest arrival date |
      | Best Selling      | Products sorted by sales volume |
```

### 3. 购物车功能

```gherkin
# language: en
Feature: Shopping Cart
  As a customer
  I want to add products to my cart and manage my cart
  So that I can purchase multiple items at once

  Background:
    Given I am logged in as a customer
    And the shopping cart service is running

  Scenario: Add a product to cart
    Given I am viewing a product with name "iPhone 13" and price "$999"
    And the product is in stock
    When I click the "Add to Cart" button
    Then the product should be added to my cart
    And I should see a confirmation message "iPhone 13 has been added to your cart"
    And the cart icon should show "1" item

  Scenario: Add multiple quantities of a product
    Given I am viewing a product with name "iPhone 13" and price "$999"
    And the product is in stock
    When I set the quantity to "3"
    And I click the "Add to Cart" button
    Then 3 units of the product should be added to my cart
    And the cart icon should show "3" items
    And the cart subtotal should be "$2997"

  Scenario: Update cart item quantity
    Given I have "2" units of "iPhone 13" in my cart
    And I am viewing my cart
    When I change the quantity of "iPhone 13" to "5"
    Then I should have "5" units of "iPhone 13" in my cart
    And the cart subtotal should be updated accordingly

  Scenario: Remove an item from cart
    Given I have "iPhone 13" in my cart
    And I am viewing my cart
    When I click the "Remove" button for "iPhone 13"
    Then "iPhone 13" should be removed from my cart
    And I should see a confirmation message "Item removed from cart"
    And the cart subtotal should be updated

  Scenario: Apply discount code
    Given I have items in my cart with a total of "$100"
    And I am viewing my cart
    When I enter discount code "SAVE10"
    And I click the "Apply" button
    Then a 10% discount should be applied to my cart
    And the cart total should be "$90"
    And I should see a message "Discount code applied successfully"

  Scenario: Apply invalid discount code
    Given I have items in my cart
    And I am viewing my cart
    When I enter discount code "INVALID"
    And I click the "Apply" button
    Then I should see an error message "Invalid discount code"
    And no discount should be applied to my cart
```

## 实战案例2：银行系统

### 1. 账户管理

```gherkin
# language: zh-CN
功能: 账户管理
  作为银行客户
  我想要管理我的银行账户
  以便进行各种银行业务操作

  背景:
    假如 银行系统正常运行
    而且 我已登录银行系统

  场景: 查看账户余额
    假如 我有一个储蓄账户，账号为"123456789"
    当 我查看我的账户详情
    那么我应该看到账户余额为"5000.00元"
    而且我应该看到账户类型为"储蓄账户"
    而且我应该看到账户状态为"正常"

  场景: 转账操作
    假如 我有一个储蓄账户，余额为"5000.00元"
    而且 我有一个收款人账户，账号为"987654321"
    当 我转账"1000.00元"到收款人账户
    那么我的账户余额应该变为"4000.00元"
    而且收款人账户余额应该增加"1000.00元"
    而且我应该看到转账成功的消息
    而且我应该收到转账确认短信

  场景: 转账余额不足
    假如 我有一个储蓄账户，余额为"500.00元"
    而且 我有一个收款人账户
    当 我尝试转账"1000.00元"到收款人账户
    那么转账应该失败
    而且我应该看到错误消息"余额不足"
    而且我的账户余额应该保持不变

  场景大纲: 不同账户类型的转账限制
    假如 我有一个<accountType>账户，余额为"10000.00元"
    而且 我有一个收款人账户
    当 我尝试转账"<amount>"到收款人账户
    那么转账结果应该是"<result>"
    而且我应该看到消息"<message>"

    例子:
      | accountType | amount     | result   | message                           |
      | 储蓄账户    | 50000.00   | 失败     | 超出单日转账限额                  |
      | 储蓄账户    | 5000.00    | 成功     | 转账成功                          |
      | 信用卡      | 10000.00   | 失败     | 信用卡不支持转出功能              |
      | 支票账户    | 20000.00   | 成功     | 转账成功                          |
```

### 2. 信用卡管理

```gherkin
# language: en
Feature: Credit Card Management
  As a bank customer
  I want to manage my credit cards
  So that I can make purchases and pay bills

  Background:
    Given the banking system is operational
    And I am logged into the banking system

  Scenario: View credit card details
    Given I have a credit card with number "4532-1234-5678-9012"
    When I view my credit card details
    Then I should see the card number masked as "****-****-****-9012"
    And I should see the available credit limit
    And I should see the current balance
    And I should see the next payment due date
    And I should see the minimum payment amount

  Scenario: Make a credit card payment
    Given I have a credit card with a balance of "$1000"
    And I have a checking account with sufficient funds
    When I make a payment of "$500" to my credit card
    Then my credit card balance should be reduced to "$500"
    And my checking account balance should be reduced by "$500"
    And I should receive a payment confirmation

  Scenario: Exceed credit limit
    Given I have a credit card with available credit of "$200"
    And I am making a purchase of "$300"
    When I attempt to authorize the purchase
    Then the authorization should be declined
    And I should see a message "Exceeds credit limit"

  Scenario: Report lost or stolen card
    Given I have a credit card
    When I report my card as lost
    Then the card should be immediately blocked
    And I should receive a confirmation that the card is blocked
    And a new card should be issued
    And I should receive the new card within 7 business days
```

## 实战案例3：社交媒体平台

### 1. 用户互动

```gherkin
# language: en
Feature: User Interaction
  As a social media user
  I want to interact with other users' content
  So that I can engage with the community

  Background:
    Given the social media platform is operational
    And I am logged in as a user

  Scenario: Like a post
    Given another user has posted a message "Hello, world!"
    When I click the "Like" button on the post
    Then the post should show 1 like
    And my name should appear in the list of users who liked the post
    And the post author should receive a notification

  Scenario: Comment on a post
    Given another user has posted a message "Check out this photo!"
    When I write a comment "Great photo!" and submit it
    Then my comment should appear below the post
    And the post author should receive a notification
    And the comment count should increase by 1

  Scenario: Share a post
    Given another user has posted an article
    When I click the "Share" button on the post
    And I add my own message "Interesting read!"
    And I confirm the share
    Then the post should appear on my timeline
    And the original post author should be credited
    And the original post author should receive a notification

  Scenario Outline: React to a post with different reactions
    Given another user has posted a message "I got a new job!"
    When I react to the post with a "<reaction>"
    Then the post should show 1 <reaction>
    And my reaction should be visible to other users
    And the post author should receive a notification

    Examples:
      | reaction  |
      | Like      |
      | Love      |
      | Laugh     |
      | Wow       |
      | Sad       |
      | Angry     |
```

### 2. 内容发布

```gherkin
# language: zh-CN
功能: 内容发布
  作为社交媒体用户
  我想要发布各种类型的内容
  以便与朋友和关注者分享我的生活

  背景:
    假如 社交媒体平台正常运行
    而且 我已登录系统

  场景: 发布文本状态
    假如 我在我的主页上
    当 我输入文本"今天天气真好！"
    而且 我点击"发布"按钮
    那么我的状态应该被发布
    而且我的关注者应该在我的时间线上看到这个状态
    而且我应该看到发布成功的消息

  场景: 发布带图片的状态
    假如 我在我的主页上
    当 我上传一张图片
    而且 我添加描述"我的新宠物"
    而且 我点击"发布"按钮
    那么我的图片状态应该被发布
    而且图片应该正确显示
    而且我的关注者应该在我的时间线上看到这个状态

  场景: 发布视频
    假如 我在我的主页上
    当 我上传一个视频文件
    而且 我添加标题"我的旅行视频"
    而且 我点击"发布"按钮
    那么我的视频应该被上传和处理
    而且处理完成后应该在我的主页上显示
    而且我的关注者应该在我的时间线上看到这个视频

  场景: 设置隐私级别
    假如 我正在创建一个新状态
    当 我设置隐私级别为"仅朋友"
    而且我发布状态
    那么只有我的朋友应该能够看到这个状态
    而且非朋友用户不应该能够看到这个状态

  场景大纲: 内容审核
    假如 我尝试发布包含<contentType>的内容
    当 我点击"发布"按钮
    那么系统应该<action>
    而且我应该看到<message>

    例子:
      | contentType   | action           | message                           |
      | 违禁词汇      | 拒绝发布        | 内容包含不当词汇，无法发布        |
      | 暴力内容      | 拒绝发布        | 内容违反社区准则，无法发布        |
      | 正常内容      | 成功发布        | 发布成功                          |
      | 版权内容      | 标记为待审核    | 内容正在审核中                    |
```

## 代码示例：步骤定义实现

### 1. 用户认证步骤定义

```java
package com.example.cucumber.stepdefinitions;

import io.cucumber.java.en.Given;
import io.cucumber.java.en.When;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.And;
import io.cucumber.java.zh_cn.假如;
import io.cucumber.java.zh_cn.当;
import io.cucumber.java.zh_cn.那么;
import io.cucumber.java.zh_cn.而且;

import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import static org.junit.Assert.*;

public class AuthenticationSteps {
    private WebDriver driver;
    private WebDriverWait wait;

    @Given("^the authentication service is running$")
    @假如("^认证服务正在运行$")
    public void theAuthenticationServiceIsRunning() {
        // 初始化认证服务
        System.setProperty("webdriver.chrome.driver", "path/to/chromedriver");
        driver = new ChromeDriver();
        wait = new WebDriverWait(driver, 10);
    }

    @Given("^I am on the registration page$")
    @假如("^我在注册页面$")
    public void iAmOnTheRegistrationPage() {
        driver.get("https://example.com/register");
    }

    @When("^I enter valid registration details:$")
    @当("^我输入有效的注册详情:$")
    public void iEnterValidRegistrationDetails(io.cucumber.datatable.DataTable dataTable) {
        // 处理数据表
        var data = dataTable.asMaps(String.class, String.class);
        
        // 输入表单字段
        for (var row : data) {
            String field = row.get("Field");
            String value = row.get("Value");
            
            WebElement element = driver.findElement(By.name(field.toLowerCase().replace(" ", "")));
            element.sendKeys(value);
        }
    }

    @When("^I agree to the terms and conditions$")
    @当("^我同意条款和条件$")
    public void iAgreeToTheTermsAndConditions() {
        WebElement termsCheckbox = driver.findElement(By.id("terms-checkbox"));
        if (!termsCheckbox.isSelected()) {
            termsCheckbox.click();
        }
    }

    @When("^I click the register button$")
    @当("^我点击注册按钮$")
    public void iClickTheRegisterButton() {
        WebElement registerButton = driver.findElement(By.id("register-button"));
        registerButton.click();
    }

    @Then("^I should be redirected to the verification page$")
    @那么("^我应该被重定向到验证页面$")
    public void iShouldBeRedirectedToTheVerificationPage() {
        wait.until(ExpectedConditions.urlContains("/verify"));
        assertTrue(driver.getCurrentUrl().contains("/verify"));
    }

    @Then("^I should receive a verification email$")
    @那么("^我应该收到验证邮件$")
    public void iShouldReceiveAVerificationEmail() {
        // 验证邮件发送逻辑
        // 这里可以集成邮件服务API或使用测试邮箱
        assertTrue(true); // 简化示例
    }

    @Then("^my account should be created with \"([^\"]*)\" status$")
    @那么("^我的账户应该被创建，状态为\"([^\"]*)\"$")
    public void myAccountShouldBeCreatedWithStatus(String status) {
        // 验证账户创建逻辑
        // 这里可以调用数据库API或用户服务API
        assertEquals("unverified", status);
    }

    @Then("^I should see an error message \"([^\"]*)\"$")
    @那么("^我应该看到错误消息\"([^\"]*)\"$")
    public void iShouldSeeAnErrorMessage(String message) {
        WebElement errorMessage = wait.until(
            ExpectedConditions.visibilityOfElementLocated(By.className("error-message"))
        );
        assertEquals(message, errorMessage.getText());
    }

    // 清理资源
    @After
    public void tearDown() {
        if (driver != null) {
            driver.quit();
        }
    }
}
```

### 2. 产品浏览步骤定义

```java
package com.example.cucumber.stepdefinitions;

import io.cucumber.java.en.Given;
import io.cucumber.java.en.When;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.And;
import io.cucumber.java.zh_cn.假如;
import io.cucumber.java.zh_cn.当;
import io.cucumber.java.zh_cn.那么;
import io.cucumber.java.zh_cn.而且;

import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.util.List;

import static org.junit.Assert.*;

public class ProductBrowsingSteps {
    private WebDriver driver;
    private WebDriverWait wait;

    @Given("^the product catalog contains various products$")
    @假如("^产品目录包含各种产品$")
    public void theProductCatalogContainsVariousProducts() {
        // 初始化产品目录数据
        System.setProperty("webdriver.chrome.driver", "path/to/chromedriver");
        driver = new ChromeDriver();
        wait = new WebDriverWait(driver, 10);
    }

    @Given("^I am on the home page$")
    @假如("^我在主页上$")
    public void iAmOnTheHomePage() {
        driver.get("https://example.com");
    }

    @When("^I navigate to the \"([^\"]*)\" category$")
    @当("^我导航到\"([^\"]*)\"类别$")
    public void iNavigateToTheCategory(String category) {
        WebElement categoryLink = driver.findElement(By.linkText(category));
        categoryLink.click();
    }

    @Then("^I should see products in the ([^\"]*) category$")
    @那么("^我应该看到([^\"]*)类别的产品$")
    public void iShouldSeeProductsInTheCategory(String category) {
        wait.until(ExpectedConditions.urlContains("/category/" + category.toLowerCase()));
        
        // 验证产品列表存在
        List<WebElement> products = driver.findElements(By.className("product-item"));
        assertTrue(products.size() > 0);
    }

    @Then("^the products should be sorted by relevance by default$")
    @那么("^产品应该默认按相关性排序$")
    public void theProductsShouldBeSortedByRelevanceByDefault() {
        WebElement sortDropdown = driver.findElement(By.id("sort-dropdown"));
        assertEquals("Relevance", sortDropdown.getAttribute("value"));
    }

    @Then("^each product should display its name, price, and image$")
    @那么("^每个产品应该显示其名称、价格和图片$")
    public void eachProductShouldDisplayItsNamePriceAndImage() {
        List<WebElement> products = driver.findElements(By.className("product-item"));
        
        for (WebElement product : products) {
            assertTrue(product.findElement(By.className("product-name")).isDisplayed());
            assertTrue(product.findElement(By.className("product-price")).isDisplayed());
            assertTrue(product.findElement(By.className("product-image")).isDisplayed());
        }
    }

    @When("^I enter \"([^\"]*)\" in the search box$")
    @当("^我在搜索框中输入\"([^\"]*)\"$")
    public void iEnterInTheSearchBox(String searchTerm) {
        WebElement searchBox = driver.findElement(By.id("search-box"));
        searchBox.clear();
        searchBox.sendKeys(searchTerm);
    }

    @When("^I click the search button$")
    @当("^我点击搜索按钮$")
    public void iClickTheSearchButton() {
        WebElement searchButton = driver.findElement(By.id("search-button"));
        searchButton.click();
    }

    @Then("^I should see products related to \"([^\"]*)\"$")
    @那么("^我应该看到与\"([^\"]*)\"相关的产品$")
    public void iShouldSeeProductsRelatedTo(String searchTerm) {
        wait.until(ExpectedConditions.urlContains("/search?q=" + searchTerm));
        
        // 验证搜索结果
        List<WebElement> products = driver.findElements(By.className("product-item"));
        assertTrue(products.size() > 0);
    }

    @When("^I filter by brand \"([^\"]*)\"$")
    @当("^我按品牌\"([^\"]*)\"筛选$")
    public void iFilterByBrand(String brand) {
        WebElement brandFilter = driver.findElement(By.xpath("//label[text()='" + brand + "']"));
        brandFilter.click();
    }

    @When("^I filter by price range \"([^\"]*)\"$")
    @当("^我按价格范围\"([^\"]*)\"筛选$")
    public void iFilterByPriceRange(String priceRange) {
        WebElement priceFilter = driver.findElement(By.xpath("//label[text()='" + priceRange + "']"));
        priceFilter.click();
    }

    @When("^I filter by rating \"([^\"]*)\"$")
    @当("^我按评分\"([^\"]*)\"筛选$")
    public void iFilterByRating(String rating) {
        WebElement ratingFilter = driver.findElement(By.xpath("//label[text()='" + rating + "']"));
        ratingFilter.click();
    }

    @Then("^I should see only ([^\"]*) laptops priced between \\$([^\\$]*) and \\$([^\\$]*) with ([^\\$]*)\\+ stars rating$")
    @那么("^我应该只看到价格在\\$([^\\$]*)到\\$([^\\$]*)之间、评分([^\"]*)星以上的([^\\$]*)笔记本电脑$")
    public void iShouldSeeOnlyLaptopsPricedBetweenWithStarsRating(String brand, String minPrice, String maxPrice, String minRating) {
        // 验证筛选结果
        List<WebElement> products = driver.findElements(By.className("product-item"));
        
        for (WebElement product : products) {
            // 验证品牌
            WebElement productBrand = product.findElement(By.className("product-brand"));
            assertEquals(brand, productBrand.getText());
            
            // 验证价格范围
            WebElement productPrice = product.findElement(By.className("product-price"));
            String priceText = productPrice.getText().replace("$", "");
            double price = Double.parseDouble(priceText);
            assertTrue(price >= Double.parseDouble(minPrice) && price <= Double.parseDouble(maxPrice));
            
            // 验证评分
            WebElement productRating = product.findElement(By.className("product-rating"));
            String ratingText = productRating.getText().replace(" stars", "");
            double rating = Double.parseDouble(ratingText);
            assertTrue(rating >= Double.parseDouble(minRating));
        }
    }

    // 清理资源
    @After
    public void tearDown() {
        if (driver != null) {
            driver.quit();
        }
    }
}
```

### 3. 购物车步骤定义

```java
package com.example.cucumber.stepdefinitions;

import io.cucumber.java.en.Given;
import io.cucumber.java.en.When;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.And;
import io.cucumber.java.zh_cn.假如;
import io.cucumber.java.zh_cn.当;
import io.cucumber.java.zh_cn.那么;
import io.cucumber.java.zh_cn.而且;

import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import static org.junit.Assert.*;

public class ShoppingCartSteps {
    private WebDriver driver;
    private WebDriverWait wait;

    @Given("^I am logged in as a customer$")
    @假如("^我已登录为客户$")
    public void iAmLoggedInAsACustomer() {
        System.setProperty("webdriver.chrome.driver", "path/to/chromedriver");
        driver = new ChromeDriver();
        wait = new WebDriverWait(driver, 10);
        
        // 登录逻辑
        driver.get("https://example.com/login");
        driver.findElement(By.id("username")).sendKeys("testuser");
        driver.findElement(By.id("password")).sendKeys("password123");
        driver.findElement(By.id("login-button")).click();
        
        // 等待登录完成
        wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("user-profile")));
    }

    @Given("^I am viewing a product with name \"([^\"]*)\" and price \"([^\"]*)\"$")
    @假如("^我正在查看名为\"([^\"]*)\"、价格为\"([^\"]*)\"的产品$")
    public void iAmViewingAProductWithNameAndPrice(String productName, String price) {
        // 导航到产品页面
        driver.get("https://example.com/product/" + productName.toLowerCase().replace(" ", "-"));
        
        // 验证产品名称和价格
        WebElement nameElement = wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("product-name")));
        WebElement priceElement = driver.findElement(By.className("product-price"));
        
        assertEquals(productName, nameElement.getText());
        assertTrue(priceElement.getText().contains(price));
    }

    @Given("^the product is in stock$")
    @假如("^产品有库存$")
    public void theProductIsInStock() {
        WebElement stockStatus = driver.findElement(By.className("stock-status"));
        assertEquals("In Stock", stockStatus.getText());
    }

    @When("^I click the \"([^\"]*)\" button$")
    @当("^我点击\"([^\"]*)\"按钮$")
    public void iClickTheButton(String buttonText) {
        WebElement button = driver.findElement(By.xpath("//button[contains(text(),'" + buttonText + "')]"));
        button.click();
    }

    @Then("^the product should be added to my cart$")
    @那么("^产品应该被添加到我的购物车$")
    public void theProductShouldBeAddedToMyCart() {
        // 验证添加到购物车的成功消息
        WebElement successMessage = wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("cart-success-message")));
        assertTrue(successMessage.isDisplayed());
        
        // 验证购物车图标更新
        WebElement cartIcon = driver.findElement(By.className("cart-icon"));
        String itemCount = cartIcon.findElement(By.className("item-count")).getText();
        assertEquals("1", itemCount);
    }

    @Then("^I should see a confirmation message \"([^\"]*)\"$")
    @那么("^我应该看到确认消息\"([^\"]*)\"$")
    public void iShouldSeeAConfirmationMessage(String message) {
        WebElement confirmationMessage = wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("cart-success-message")));
        assertEquals(message, confirmationMessage.getText());
    }

    @Then("^the cart icon should show \"([^\"]*)\" items?$")
    @那么("^购物车图标应该显示\"([^\"]*)\"个商品$")
    public void theCartIconShouldShowItems(String itemCount) {
        WebElement cartIcon = driver.findElement(By.className("cart-icon"));
        String actualItemCount = cartIcon.findElement(By.className("item-count")).getText();
        assertEquals(itemCount, actualItemCount);
    }

    @When("^I set the quantity to \"([^\"]*)\"$")
    @当("^我将数量设置为\"([^\"]*)\"$")
    public void iSetTheQuantityTo(String quantity) {
        WebElement quantityInput = driver.findElement(By.id("quantity"));
        quantityInput.clear();
        quantityInput.sendKeys(quantity);
    }

    @Then("^([^\"]*) units of the product should be added to my cart$")
    @那么("^产品的([^\"]*)个单位应该被添加到我的购物车$")
    public void unitsOfTheProductShouldBeAddedToMyCart(String quantity) {
        // 验证购物车中的商品数量
        WebElement cartIcon = driver.findElement(By.className("cart-icon"));
        String actualItemCount = cartIcon.findElement(By.className("item-count")).getText();
        assertEquals(quantity, actualItemCount);
    }

    @Then("^the cart subtotal should be \"([^\"]*)\"$")
    @那么("^购物车小计应该是\"([^\"]*)\"$")
    public void theCartSubtotalShouldBe(String expectedSubtotal) {
        // 导航到购物车页面
        driver.findElement(By.className("cart-icon")).click();
        
        // 等待购物车页面加载
        wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("cart-subtotal")));
        
        // 验证小计金额
        WebElement subtotalElement = driver.findElement(By.className("cart-subtotal"));
        assertEquals(expectedSubtotal, subtotalElement.getText());
    }

    @Given("^I have \"([^\"]*)\" units of \"([^\"]*)\" in my cart$")
    @假如("^我的购物车中有([^\"]*)个\"([^\"]*)\"$")
    public void iHaveUnitsOfInMyCart(String quantity, String productName) {
        // 添加产品到购物车
        driver.get("https://example.com/product/" + productName.toLowerCase().replace(" ", "-"));
        WebElement quantityInput = driver.findElement(By.id("quantity"));
        quantityInput.clear();
        quantityInput.sendKeys(quantity);
        driver.findElement(By.xpath("//button[contains(text(),'Add to Cart')]")).click();
        
        // 等待添加成功
        wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("cart-success-message")));
    }

    @Given("^I am viewing my cart$")
    @假如("^我正在查看我的购物车$")
    public void iAmViewingMyCart() {
        driver.findElement(By.className("cart-icon")).click();
        wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("cart-page")));
    }

    @When("^I change the quantity of \"([^\"]*)\" to \"([^\"]*)\"$")
    @当(^我将\"([^\"]*)\"的数量更改为\"([^\"]*)\"$)
    public void iChangeTheQuantityOfTo(String productName, String newQuantity) {
        // 找到购物车中的产品并更新数量
        WebElement productRow = driver.findElement(By.xpath("//div[contains(text(),'" + productName + "')]/ancestor::div[@class='cart-item']"));
        WebElement quantityInput = productRow.findElement(By.className("quantity-input"));
        quantityInput.clear();
        quantityInput.sendKeys(newQuantity);
        
        // 点击更新按钮
        WebElement updateButton = productRow.findElement(By.className("update-button"));
        updateButton.click();
    }

    @Then("^I should have \"([^\"]*)\" units of \"([^\"]*)\" in my cart$")
    @那么(^我的购物车中应该有([^\"]*)个\"([^\"]*)\"$)
    public void iShouldHaveUnitsOfInMyCart(String expectedQuantity, String productName) {
        // 验证购物车中的产品数量
        WebElement productRow = driver.findElement(By.xpath("//div[contains(text(),'" + productName + "')]/ancestor::div[@class='cart-item']"));
        WebElement quantityInput = productRow.findElement(By.className("quantity-input"));
        assertEquals(expectedQuantity, quantityInput.getAttribute("value"));
    }

    @When("^I click the \"([^\"]*)\" button for \"([^\"]*)\"$")
    @当(^我点击\"([^\"]*)\"的\"([^\"]*)\"按钮$)
    public void iClickTheButtonFor(String buttonText, String productName) {
        // 找到购物车中的产品并点击移除按钮
        WebElement productRow = driver.findElement(By.xpath("//div[contains(text(),'" + productName + "')]/ancestor::div[@class='cart-item']"));
        WebElement removeButton = productRow.findElement(By.xpath("//button[contains(text(),'" + buttonText + "')]"));
        removeButton.click();
    }

    @Then("^\"([^\"]*)\" should be removed from my cart$")
    @那么(^\"([^\"]*)\"应该从我的购物车中移除$)
    public void shouldBeRemovedFromMyCart(String productName) {
        // 验证产品已从购物车中移除
        try {
            driver.findElement(By.xpath("//div[contains(text(),'" + productName + "')]/ancestor::div[@class='cart-item']"));
            fail("Product was not removed from cart");
        } catch (Exception e) {
            // 预期的异常，产品已移除
        }
    }

    @When("^I enter discount code \"([^\"]*)\"$")
    @当(^我输入折扣码\"([^\"]*)\"$)
    public void iEnterDiscountCode(String discountCode) {
        WebElement discountCodeInput = driver.findElement(By.id("discount-code"));
        discountCodeInput.clear();
        discountCodeInput.sendKeys(discountCode);
    }

    @When("^I click the \"([^\"]*)\" button$")
    @当(^我点击\"([^\"]*)\"按钮$)
    public void iClickTheApplyButton(String buttonText) {
        WebElement applyButton = driver.findElement(By.id("apply-discount-button"));
        applyButton.click();
    }

    @Then("^a ([^\"]*)% discount should be applied to my cart$")
    @那么(^我的购物车应该应用([^\"]*)%的折扣$)
    public void aDiscountShouldBeAppliedToMyCart(String discountPercentage) {
        // 验证折扣已应用
        WebElement discountMessage = wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("discount-message")));
        assertTrue(discountMessage.getText().contains(discountPercentage + "%"));
    }

    @Then("^the cart total should be \"([^\"]*)\"$")
    @那么(^购物车总额应该是\"([^\"]*)\"$)
    public void theCartTotalShouldBe(String expectedTotal) {
        WebElement totalElement = driver.findElement(By.className("cart-total"));
        assertEquals(expectedTotal, totalElement.getText());
    }

    @Then("^I should see an error message \"([^\"]*)\"$")
    @那么(^我应该看到错误消息\"([^\"]*)\"$)
    public void iShouldSeeAnErrorMessage(String errorMessage) {
        WebElement errorElement = wait.until(ExpectedConditions.visibilityOfElementLocated(By.className("error-message")));
        assertEquals(errorMessage, errorElement.getText());
    }

    @Then("^no discount should be applied to my cart$")
    @那么(^我的购物车不应该应用折扣$)
    public void noDiscountShouldBeAppliedToMyCart() {
        // 验证没有折扣应用
        try {
            driver.findElement(By.className("discount-message"));
            fail("Discount was applied when it shouldn't be");
        } catch (Exception e) {
            // 预期的异常，没有折扣应用
        }
    }

    // 清理资源
    @After
    public void tearDown() {
        if (driver != null) {
            driver.quit();
        }
    }
}
```

## 总结

本章通过三个实战案例（电子商务系统、银行系统和社交媒体平台）展示了Gherkin在不同领域的应用，并提供了相应的步骤定义实现代码。这些案例涵盖了用户认证、产品浏览、购物车、账户管理、用户互动和内容发布等常见功能，展示了如何使用Gherkin描述复杂业务场景。

关键要点：
1. Gherkin可以用于描述各种类型的软件系统，从电子商务到银行系统
2. 通过使用背景（Background）可以减少场景间的重复设置
3. 场景大纲（Scenario Outline）和数据表（DataTable）支持数据驱动测试
4. 多语言支持使非英语团队能够使用母语编写测试场景
5. 步骤定义实现可以使用Selenium WebDriver等工具进行Web UI自动化测试

在下一章中，我们将深入探讨步骤定义的实现细节，包括参数传递、数据表处理、状态管理等高级主题。