# 第3章：JMeter脚本编写与HTTP测试

## 3.1 JMeter脚本创建方法

### 3.1.1 手动编写脚本

手动编写JMeter脚本是最基础也是最灵活的方法，适合对JMeter有一定了解的用户。

**手动编写步骤：**
1. 创建测试计划
2. 添加线程组
3. 配置采样器
4. 添加配置元素
5. 设置监听器

**优点：**
- 完全控制脚本结构
- 适合复杂逻辑
- 便于版本控制

**缺点：**
- 需要熟悉JMeter组件
- 编写效率较低

### 3.1.2 使用HTTP代理服务器录制

HTTP代理服务器录制是JMeter最常用的脚本创建方法，特别适合Web应用测试。

**录制步骤：**
1. **创建测试计划**：添加线程组和HTTP请求默认值
2. **配置HTTP代理服务器**：
   - 端口：8080（或其他可用端口）
   - 目标控制器：测试计划 > 线程组
   - 分组：每个组放入一个新的控制器
3. **配置浏览器代理**：
   - 设置浏览器使用JMeter代理
   - 地址：localhost，端口：8080
4. **开始录制**：启动代理服务器，在浏览器中操作
5. **停止录制**：停止代理服务器，保存脚本

**代理服务器配置示例：**
```properties
端口：8080
目标控制器：测试计划 > 线程组
分组：不对样本分组
包含模式：.*
排除模式：.*\.(css|js|png|jpg|gif).*
```

### 3.1.3 使用Badboy录制

Badboy是一个专业的Web测试工具，可以录制浏览器操作并导出为JMeter脚本。

**录制流程：**
1. 下载安装Badboy
2. 录制Web操作流程
3. 导出为JMeter脚本（.jmx文件）
4. 在JMeter中打开导出的脚本

**优点：**
- 录制过程直观
- 支持复杂交互
- 适合Web应用测试

## 3.2 HTTP请求详细配置

### 3.2.1 HTTP请求基本参数

**必需参数：**
- **协议**：http或https
- **服务器名称或IP**：目标服务器地址
- **端口号**：服务器端口（http默认80，https默认443）
- **HTTP请求**：请求方法（GET、POST、PUT、DELETE等）
- **路径**：请求路径

**可选参数：**
- **内容编码**：字符编码（默认UTF-8）
- **自动重定向**：是否自动处理重定向
- **跟随重定向**：是否跟随重定向
- **使用KeepAlive**：是否使用持久连接

### 3.2.2 请求参数配置

**参数类型：**
1. **查询参数**：GET请求的URL参数
2. **表单参数**：POST请求的表单数据
3. **请求体数据**：原始请求体内容

**参数配置示例：**
```properties
# 查询参数（GET请求）
名称：page，值：1
名称：size，值：20

# 表单参数（POST请求）
名称：username，值：testuser
名称：password，值：testpass

# 请求体数据（JSON格式）
{
  "username": "${USERNAME}",
  "password": "${PASSWORD}",
  "remember": true
}
```

### 3.2.3 文件上传配置

JMeter支持文件上传测试，适用于测试文件上传接口。

**文件上传配置：**
```properties
名称：文件上传测试
HTTP请求：POST
路径：/api/v1/upload

文件上传：
├── 文件路径：/path/to/file.jpg
├── 参数名称：file
├── MIME类型：image/jpeg
└── 文件编码：UTF-8
```

## 3.3 参数化与变量使用

### 3.3.1 用户定义的变量

在测试计划级别定义全局变量，在整个测试中可用。

**配置示例：**
```properties
BASE_URL：http://api.example.com
API_VERSION：v1
TIMEOUT：5000
MAX_RETRY：3
```

**使用方式：**
```
${BASE_URL}/api/${API_VERSION}/login
```

### 3.3.2 CSV数据文件参数化

使用CSV文件实现数据驱动测试，支持大量测试数据。

**CSV数据文件设置配置：**
```properties
文件名：data/users.csv
文件编码：UTF-8
变量名称：username,password,email
分隔符：,
遇到文件结束符再次循环：是
遇到文件结束符停止线程：否
共享模式：所有线程
```

**CSV文件格式：**
```csv
username,password,email
user1,pass123,user1@example.com
user2,pass456,user2@example.com
user3,pass789,user3@example.com
```

### 3.3.3 随机变量与函数

JMeter内置多种函数，用于生成随机数据或处理变量。

**常用函数：**
- **${__Random(min,max)}**：生成随机数
- **${__UUID()}**：生成UUID
- **${__time()}**：获取当前时间戳
- **${__threadNum}**：获取线程编号
- **${__machineName()}**：获取机器名

**使用示例：**
```properties
# 生成随机用户名
username：testuser_${__Random(1000,9999)}

# 带时间戳的订单号
order_id：ORDER_${__time()}_${__threadNum}

# 唯一标识符
session_id：${__UUID()}
```

## 3.4 调试技巧与错误排查

### 3.4.1 调试监听器配置

**View Results Tree**是最常用的调试工具，可以查看详细的请求和响应信息。

**调试配置：**
```properties
显示：仅错误日志（生产环境）
保存响应数据：是（调试时）
配置：
├── 保存响应头：是
├── 保存请求头：是
├── 保存响应体：是
└── 保存请求体：是
```

### 3.4.2 常见错误与解决方案

**错误1：连接超时**
```
症状：java.net.ConnectException: Connection timed out
原因：服务器不可达或防火墙阻止
解决方案：
1. 检查服务器地址和端口
2. 验证网络连接
3. 检查防火墙设置
```

**错误2：SSL证书问题**
```
症状：javax.net.ssl.SSLHandshakeException
原因：SSL证书验证失败
解决方案：
1. 在HTTP请求中禁用SSL证书验证
2. 导入服务器证书到Java信任库
3. 使用自签名证书时配置信任所有证书
```

**错误3：响应编码问题**
```
症状：响应内容显示乱码
原因：字符编码不匹配
解决方案：
1. 设置正确的内容编码（UTF-8、GBK等）
2. 在HTTP请求默认值中设置默认编码
3. 检查服务器返回的Content-Type头部
```

### 3.4.3 调试脚本技巧

**逐步调试：**
1. 先测试单个请求
2. 添加断言验证响应
3. 逐步增加并发用户
4. 监控系统资源使用情况

**日志分析：**
```properties
# 启用详细日志
在jmeter.properties中设置：
log_level.jmeter=DEBUG
log_level.jmeter.junit=DEBUG
```

## 3.5 脚本优化最佳实践

### 3.5.1 减少资源消耗

**优化监听器配置：**
```properties
# 生产环境禁用详细监听器
仅在调试时使用View Results Tree
使用Summary Report或Aggregate Report替代

# 优化监听器设置
保存响应数据：否
保存请求数据：否
仅保存错误日志：是
```

**优化测试计划结构：**
- 将公共配置提取到HTTP请求默认值
- 使用模块控制器复用代码片段
- 合理使用事务控制器组合相关操作

### 3.5.2 提高测试效率

**参数化优化：**
- 使用CSV数据文件设置实现数据驱动
- 避免在测试计划中硬编码数据
- 合理使用随机函数生成测试数据

**请求优化：**
- 启用KeepAlive减少连接建立开销
- 合理设置超时时间
- 使用连接池管理HTTP连接

### 3.5.3 脚本可维护性

**命名规范：**
```
# 组件命名规范
线程组：用户登录流程_10并发
HTTP请求：POST_用户登录_API
监听器：SummaryReport_登录测试
断言：验证登录成功响应
```

**注释和文档：**
- 为每个重要组件添加注释
- 使用测试计划注释说明测试目的
- 维护测试脚本的变更日志

## 3.6 实战示例：完整的API测试脚本

### 3.6.1 测试场景：电商网站用户流程

**测试流程：**
1. 用户登录
2. 浏览商品列表
3. 查看商品详情
4. 添加商品到购物车
5. 提交订单
6. 用户登出

### 3.6.2 脚本结构设计

```
测试计划：电商网站用户流程测试
├── HTTP请求默认值
├── HTTP信息头管理器
├── CSV数据文件设置
├── 线程组：用户并发测试
│   ├── 事务控制器：用户登录
│   │   ├── HTTP请求：用户登录
│   │   ├── JSON提取器：提取token
│   │   └── 响应断言：验证登录成功
│   ├── 事务控制器：商品浏览
│   │   ├── HTTP请求：商品列表
│   │   ├── HTTP请求：商品详情
│   │   └── 正则表达式提取器：提取商品ID
│   ├── 事务控制器：购物流程
│   │   ├── HTTP请求：添加购物车
│   │   ├── HTTP请求：查看购物车
│   │   └── HTTP请求：提交订单
│   └── HTTP请求：用户登出
├── 监听器：View Results Tree（调试用）
├── 监听器：Summary Report
└── 监听器：Aggregate Graph
```

### 3.6.3 详细配置示例

**HTTP请求默认值：**
```properties
服务器名称：api.ecommerce.com
端口号：8080
协议：http
内容编码：UTF-8
```

**HTTP信息头管理器：**
```properties
Content-Type: application/json
Accept: application/json
User-Agent: JMeter-Performance-Test/1.0
```

**用户登录请求：**
```properties
名称：POST_用户登录
方法：POST
路径：/api/v1/auth/login
主体数据：
{
  "username": "${USERNAME}",
  "password": "${PASSWORD}"
}
```

**JSON提取器（提取token）：**
```properties
名称：提取认证Token
变量名称：AUTH_TOKEN
JSON路径表达式：$.data.token
匹配编号：0
缺省值：TOKEN_NOT_FOUND
```

## 3.7 本章小结

### 学习要点回顾
- ✅ 掌握了JMeter脚本的三种创建方法
- ✅ 深入了解了HTTP请求的详细配置
- ✅ 学会了参数化与变量使用技巧
- ✅ 掌握了调试技巧和错误排查方法
- ✅ 了解了脚本优化的最佳实践
- ✅ 通过实战示例巩固了所学知识

### 关键技能总结

**脚本创建：**
- 手动编写适合复杂逻辑
- 代理录制适合Web应用
- Badboy录制直观高效

**HTTP配置：**
- 合理设置请求参数
- 正确配置认证信息
- 优化连接和超时设置

**调试优化：**
- 使用View Results Tree调试
- 逐步增加并发用户
- 优化监听器配置减少资源消耗

### 实践练习

**练习1：脚本录制**
1. 使用HTTP代理服务器录制一个Web应用操作流程
2. 优化录制的脚本，添加断言和参数化
3. 测试脚本的正确性和性能

**练习2：参数化测试**
1. 创建CSV文件包含多组测试数据
2. 配置CSV数据文件设置实现数据驱动
3. 验证不同测试数据的执行结果

**练习3：脚本优化**
1. 分析现有脚本的资源消耗
2. 优化监听器配置减少内存使用
3. 使用事务控制器组合相关操作

### 下一章预告

在下一章中，我们将深入学习JMeter高级测试场景设计，包括：
- 复杂业务逻辑测试
- 数据库性能测试
- FTP文件传输测试
- Web服务测试
- 自定义协议测试

---

**继续学习：** [第4章 - JMeter高级测试场景设计](./4-JMeter高级测试场景设计.md)