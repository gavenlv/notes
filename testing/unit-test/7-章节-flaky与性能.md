# 第7章 — Flaky Tests 与性能测试简介

目标：
- 了解什么是 flaky test（间歇性失败的测试）及其危害。
- 学会如何避免常见的 flaky 原因：时间、随机性、并发、外部依赖。
- 简单介绍性能测试的基本思想（微基准 vs 集成压测）。

概念解析
- Flaky test：在同一代码下多次运行可能随机失败或通过的测试。它会破坏 CI 的信任并隐藏真实问题。

常见原因与解决方法
- 随机性：使用固定随机种子或在测试中注入可控随机源（建议）。
- 时间依赖：不要依赖系统时间，使用可注入的时钟或 monkeypatch 时间源。
- 并发：使用锁或测试专用隔离资源。
- 外部依赖：mock/仿真外部请求。

示例：`testing/unit-test/code/chapter7/` 展示如何把随机性注入以消除 flakiness。

性能测试简述
- 单元测试不用于性能基准。使用专门工具（`pytest-benchmark`, `locust`, `k6`）来进行性能评估。
- 在单元级别做简单的速度断言（例如“在 X ms 内完成”）通常不可靠，除非在受控环境下。

练习
- 把一个以随机数为输入的函数用可注入的 RNG 改写，然后写稳定的测试。