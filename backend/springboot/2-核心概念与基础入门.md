# 第二章：Spring Boot 核心概念与基础入门

## 2.1 Spring Boot 核心特性详解

在上一章中，我们已经了解了 Spring Boot 的基本概念和环境搭建。本章将深入探讨 Spring Boot 的核心特性，包括自动配置、起步依赖、Actuator 等重要概念。

### 2.1.1 自动配置（Auto Configuration）

Spring Boot 的自动配置是其最重要的特性之一。它能根据类路径中的 jar 包、类、属性等自动配置 Bean。

#### 工作原理

1. Spring Boot 启动时会扫描类路径下的所有 jar 包
2. 查找 `META-INF/spring.factories` 文件
3. 加载其中定义的自动配置类
4. 根据条件判断是否需要加载对应的配置

#### 条件注解

Spring Boot 提供了一系列条件注解来控制自动配置的加载：

- `@ConditionalOnClass`：当类路径下有指定的类时条件匹配
- `@ConditionalOnMissingClass`：当类路径下没有指定的类时条件匹配
- `@ConditionalOnBean`：当容器中有指定的 Bean 时条件匹配
- `@ConditionalOnMissingBean`：当容器中没有指定的 Bean 时条件匹配
- `@ConditionalOnProperty`：当指定的属性有指定的值时条件匹配
- `@ConditionalOnWebApplication`：当应用是 Web 应用时条件匹配

#### 自定义自动配置示例

```java
@Configuration
@ConditionalOnClass(MyService.class)
@EnableConfigurationProperties(MyProperties.class)
public class MyAutoConfiguration {
    
    @Autowired
    private MyProperties properties;
    
    @Bean
    @ConditionalOnMissingBean
    public MyService myService() {
        MyService service = new MyService();
        service.setUrl(properties.getUrl());
        service.setTimeout(properties.getTimeout());
        return service;
    }
}
```

### 2.1.2 起步依赖（Starters）

Starter 是一组方便的依赖描述符，可以包含相关的传递依赖关系，这些依赖是一起工作的。

#### 官方 Starter

常见的官方 Starter 包括：
- `spring-boot-starter-web`：用于构建 Web 应用程序
- `spring-boot-starter-data-jpa`：用于 JPA 数据访问
- `spring-boot-starter-security`：用于安全控制
- `spring-boot-starter-test`：用于测试

#### 自定义 Starter

创建自己的 Starter 需要以下步骤：

1. 创建配置属性类：

```java
@ConfigurationProperties(prefix = "my.service")
public class MyProperties {
    private String url = "http://localhost:8080";
    private int timeout = 5000;
    
    // getter 和 setter 方法
    public String getUrl() {
        return url;
    }
    
    public void setUrl(String url) {
        this.url = url;
    }
    
    public int getTimeout() {
        return timeout;
    }
    
    public void setTimeout(int timeout) {
        this.timeout = timeout;
    }
}
```

2. 创建自动配置类：

```java
@Configuration
@ConditionalOnClass(MyService.class)
@EnableConfigurationProperties(MyProperties.class)
public class MyAutoConfiguration {
    
    @Autowired
    private MyProperties properties;
    
    @Bean
    @ConditionalOnMissingBean
    public MyService myService() {
        MyService service = new MyService();
        service.setUrl(properties.getUrl());
        service.setTimeout(properties.getTimeout());
        return service;
    }
}
```

3. 在 `META-INF/spring.factories` 中注册自动配置类：

```properties
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.example.mystarter.MyAutoConfiguration
```

### 2.1.3 Actuator

Spring Boot Actuator 提供了生产就绪的功能，可以帮助我们监控和管理应用程序。

#### 添加依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

#### 常用端点

- `/actuator/health`：显示应用程序的健康状况
- `/actuator/info`：显示应用程序的信息
- `/actuator/metrics`：显示各种指标信息
- `/actuator/env`：显示环境属性
- `/actuator/loggers`：显示和修改日志级别

#### 配置示例

```properties
# 启用所有端点
management.endpoints.web.exposure.include=*
# 启用健康检查的详细信息
management.endpoint.health.show-details=always
```

## 2.2 Spring Boot 注解详解

Spring Boot 大量使用注解来简化配置，下面我们来详细了解常用的注解。

### 2.2.1 核心注解

#### @SpringBootApplication

这是最重要的注解，它是一个组合注解，包含了：

- `@Configuration`：标识该类是一个配置类
- `@EnableAutoConfiguration`：启用自动配置
- `@ComponentScan`：启用组件扫描

#### @RestController

这是一个组合注解，包含了：

- `@Controller`：标识该类是一个控制器
- `@ResponseBody`：将返回值直接写入 HTTP 响应体

#### @RequestMapping

用于映射 HTTP 请求到处理方法：

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        // 处理逻辑
        return user;
    }
    
    @PostMapping
    public User createUser(@RequestBody User user) {
        // 处理逻辑
        return user;
    }
}
```

### 2.2.2 数据访问注解

#### @Entity

标识一个类为 JPA 实体：

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    // getter 和 setter 方法
}
```

#### @Repository

标识一个类为数据访问层组件：

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    List<User> findByName(String name);
}
```

### 2.2.3 服务层注解

#### @Service

标识一个类为服务层组件：

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public User save(User user) {
        return userRepository.save(user);
    }
}
```

## 2.3 Spring Boot 配置详解

Spring Boot 提供了多种配置方式，我们可以灵活地使用它们。

### 2.3.1 配置文件

Spring Boot 支持两种格式的配置文件：
- `application.properties`
- `application.yml`

#### 属性绑定

```java
@Component
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private String name;
    private int port;
    private boolean debug;
    
    // getter 和 setter 方法
}
```

对应的配置文件：

```properties
app.name=MyApp
app.port=8080
app.debug=true
```

或

```yaml
app:
  name: MyApp
  port: 8080
  debug: true
```

### 2.3.2 Profile 配置

Profile 用于不同环境的配置隔离。

#### 定义 Profile 配置文件

- `application-dev.properties`：开发环境
- `application-test.properties`：测试环境
- `application-prod.properties`：生产环境

#### 激活 Profile

```properties
spring.profiles.active=dev
```

或通过命令行参数：

```bash
java -jar app.jar --spring.profiles.active=prod
```

### 2.3.3 外部化配置

Spring Boot 支持多种外部化配置方式，优先级从高到低：

1. 命令行参数
2. SPRING_APPLICATION_JSON 中的属性
3. ServletConfig 初始化参数
4. ServletContext 初始化参数
5. JNDI 属性
6. Java 系统属性
7. 操作系统环境变量
8. RandomValuePropertySource
9. jar 包外的 application-{profile}.properties
10. jar 包内的 application-{profile}.properties
11. jar 包外的 application.properties
12. jar 包内的 application.properties

## 2.4 实践案例：构建一个完整的 Web 应用

让我们通过一个完整的示例来巩固所学的知识。

### 2.4.1 项目结构

```
chapter2/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/example/demo/
│   │   │       ├── DemoApplication.java
│   │   │       ├── controller/
│   │   │       │   └── UserController.java
│   │   │       ├── service/
│   │   │       │   └── UserService.java
│   │   │       ├── repository/
│   │   │       │   └── UserRepository.java
│   │   │       └── entity/
│   │   │           └── User.java
│   │   └── resources/
│   │       ├── application.properties
│   │       └── data.sql
│   └── test/
│       └── java/
│           └── com/example/demo/
│               └── DemoApplicationTests.java
└── pom.xml
```

### 2.4.2 实体类

```java
package com.example.demo.entity;

import javax.persistence.*;

@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false, unique = true)
    private String email;
    
    // 构造函数
    public User() {}
    
    public User(String name, String email) {
        this.name = name;
        this.email = email;
    }
    
    // getter 和 setter 方法
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getEmail() {
        return email;
    }
    
    public void setEmail(String email) {
        this.email = email;
    }
}
```

### 2.4.3 数据访问层

```java
package com.example.demo.repository;

import com.example.demo.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    List<User> findByName(String name);
    User findByEmail(String email);
}
```

### 2.4.4 服务层

```java
package com.example.demo.service;

import com.example.demo.entity.User;
import com.example.demo.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public List<User> getAllUsers() {
        return userRepository.findAll();
    }
    
    public Optional<User> getUserById(Long id) {
        return userRepository.findById(id);
    }
    
    public User saveUser(User user) {
        return userRepository.save(user);
    }
    
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    public List<User> getUsersByName(String name) {
        return userRepository.findByName(name);
    }
}
```

### 2.4.5 控制层

```java
package com.example.demo.controller;

import com.example.demo.entity.User;
import com.example.demo.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<User> getUserById(@PathVariable Long id) {
        Optional<User> user = userService.getUserById(id);
        if (user.isPresent()) {
            return new ResponseEntity<>(user.get(), HttpStatus.OK);
        } else {
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
    }
    
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userService.saveUser(user);
    }
    
    @PutMapping("/{id}")
    public ResponseEntity<User> updateUser(@PathVariable Long id, @RequestBody User userDetails) {
        Optional<User> user = userService.getUserById(id);
        if (user.isPresent()) {
            User updatedUser = user.get();
            updatedUser.setName(userDetails.getName());
            updatedUser.setEmail(userDetails.getEmail());
            userService.saveUser(updatedUser);
            return new ResponseEntity<>(updatedUser, HttpStatus.OK);
        } else {
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
        return new ResponseEntity<>(HttpStatus.NO_CONTENT);
    }
}
```

### 2.4.6 配置文件

```properties
# 数据库配置
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# JPA 配置
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true

# H2 控制台
spring.h2.console.enabled=true

# 初始化数据
spring.sql.init.mode=always
```

### 2.4.7 初始化数据

```sql
INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com');
INSERT INTO users (name, email) VALUES ('李四', 'lisi@example.com');
INSERT INTO users (name, email) VALUES ('王五', 'wangwu@example.com');
```

### 2.4.8 依赖配置

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.example</groupId>
    <artifactId>chapter2</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>chapter2</name>
    <description>Demo project for Spring Boot Chapter 2</description>
    <properties>
        <java.version>11</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>runtime</scope>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

## 2.5 测试

Spring Boot 提供了强大的测试支持。

### 2.5.1 单元测试

```java
package com.example.demo;

import com.example.demo.entity.User;
import com.example.demo.repository.UserRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class UserRepositoryTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    public void testSaveAndFindUser() {
        // 创建用户
        User user = new User("测试用户", "test@example.com");
        User savedUser = userRepository.save(user);
        
        // 验证保存成功
        assertThat(savedUser.getId()).isNotNull();
        
        // 查询用户
        List<User> users = userRepository.findByName("测试用户");
        assertThat(users).hasSize(1);
        assertThat(users.get(0).getEmail()).isEqualTo("test@example.com");
    }
}
```

### 2.5.2 集成测试

```java
package com.example.demo;

import com.example.demo.entity.User;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class UserControllerIntegrationTest {
    
    @LocalServerPort
    private int port;
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    public void testGetAllUsers() {
        String url = "http://localhost:" + port + "/api/users";
        ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    }
    
    @Test
    public void testCreateUser() {
        String url = "http://localhost:" + port + "/api/users";
        User user = new User("测试用户", "test@example.com");
        
        ResponseEntity<User> response = restTemplate.postForEntity(url, user, User.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getName()).isEqualTo("测试用户");
    }
}
```

## 2.6 最佳实践

1. **合理的包结构**：按照功能划分包，如 controller、service、repository、entity
2. **异常处理**：使用 `@ControllerAdvice` 统一处理异常
3. **日志记录**：合理使用日志记录关键信息
4. **配置管理**：敏感信息使用配置文件或环境变量管理
5. **测试覆盖**：编写充分的单元测试和集成测试

## 2.7 总结

本章我们深入学习了 Spring Boot 的核心概念和特性，包括自动配置、起步依赖、Actuator 等重要内容。我们还通过一个完整的 Web 应用示例，实践了 Spring Boot 的各项技术要点，并学习了如何编写测试。

在下一章中，我们将详细探讨 Spring Boot 的配置机制，包括各种配置方式和最佳实践。

## 附录：完整可运行代码

本章的完整代码示例可以在 [code/chapter2](code/chapter2/) 目录中找到。