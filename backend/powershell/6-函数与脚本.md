# ç¬¬6ç« ï¼šå‡½æ•°ä¸è„šæœ¬

> **å­¦ä¹ æ—¶é•¿**: 6-7å°æ—¶  
> **éš¾åº¦**: â­â­â­â­  
> **å‰ç½®çŸ¥è¯†**: ç¬¬1-5ç« 

## æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« å,ä½ å°†èƒ½å¤Ÿ:

- âœ… åˆ›å»ºå’Œè°ƒç”¨å‡½æ•°
- âœ… å¤„ç†å‡½æ•°å‚æ•°(ä½ç½®å‚æ•°ã€å‘½åå‚æ•°ã€é»˜è®¤å€¼)
- âœ… ä½¿ç”¨é«˜çº§å‡½æ•°å’ŒCmdletBinding
- âœ… ç†è§£ä½œç”¨åŸŸå’Œå˜é‡ç”Ÿå‘½å‘¨æœŸ
- âœ… ç¼–å†™å¯é‡ç”¨çš„è„šæœ¬
- âœ… å®ç°å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

---

## 6.1 å‡½æ•°åŸºç¡€

### 6.1.1 åˆ›å»ºå‡½æ•°

```powershell
# ç®€å•å‡½æ•°
function Say-Hello {
    Write-Host "Hello, World!"
}

# è°ƒç”¨å‡½æ•°
Say-Hello

# å¸¦å‚æ•°çš„å‡½æ•°
function Say-Greeting {
    param($Name)
    Write-Host "Hello, $Name!"
}

Say-Greeting -Name "Alice"
Say-Greeting "Bob"  # ä½ç½®å‚æ•°

# å¸¦è¿”å›å€¼çš„å‡½æ•°
function Get-Square {
    param([int]$Number)
    return $Number * $Number
}

$result = Get-Square -Number 5
Write-Host "Square: $result"  # 25

# éšå¼è¿”å›(è¾“å‡ºå³è¿”å›)
function Get-Cube {
    param([int]$Number)
    $Number * $Number * $Number
}

$result = Get-Cube 3
Write-Host "Cube: $result"  # 27
```

### 6.1.2 å‡½æ•°å‘½åè§„èŒƒ

```powershell
# æ¨è: Verb-Nounæ ¼å¼
function Get-UserInfo { }
function Set-Configuration { }
function New-Report { }
function Remove-TempFiles { }

# æŸ¥çœ‹æ‰¹å‡†çš„åŠ¨è¯
Get-Verb

# âŒ ä¸æ¨è
function GetUser { }
function DoSomething { }
function MyFunction { }

# âœ… æ¨è
function Get-User { }
function Start-Process { }
function Update-Configuration { }
```

### 6.1.3 å‡½æ•°å‚æ•°

**å‚æ•°å—å®šä¹‰**:

```powershell
# åŸºæœ¬å‚æ•°
function Get-Sum {
    param(
        $Number1,
        $Number2
    )
    return $Number1 + $Number2
}

# ç±»å‹åŒ–å‚æ•°
function Get-Product {
    param(
        [int]$Number1,
        [int]$Number2
    )
    return $Number1 * $Number2
}

# å¤šä¸ªå‚æ•°
function Get-PersonInfo {
    param(
        [string]$Name,
        [int]$Age,
        [string]$City
    )
    
    Write-Host "Name: $Name"
    Write-Host "Age: $Age"
    Write-Host "City: $City"
}

Get-PersonInfo -Name "Alice" -Age 30 -City "Beijing"
```

---

## 6.2 é«˜çº§å‚æ•°

### 6.2.1 é»˜è®¤å‚æ•°å€¼

```powershell
# é»˜è®¤å€¼
function Send-Greeting {
    param(
        [string]$Name = "Guest",
        [string]$Message = "Welcome"
    )
    
    Write-Host "$Message, $Name!"
}

Send-Greeting                           # Welcome, Guest!
Send-Greeting -Name "Alice"             # Welcome, Alice!
Send-Greeting -Message "Hello"          # Hello, Guest!
Send-Greeting -Name "Bob" -Message "Hi" # Hi, Bob!
```

### 6.2.2 å¿…éœ€å‚æ•°

```powershell
# Mandatoryå‚æ•°
function New-User {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username,
        
        [Parameter(Mandatory=$true)]
        [string]$Email,
        
        [string]$Department = "IT"
    )
    
    Write-Host "Creating user: $Username"
    Write-Host "Email: $Email"
    Write-Host "Department: $Department"
}

# è°ƒç”¨æ—¶å¿…é¡»æä¾›Usernameå’ŒEmail
New-User -Username "alice" -Email "alice@example.com"
```

### 6.2.3 å‚æ•°åˆ«å

```powershell
# å‚æ•°åˆ«å
function Get-FileInfo {
    param(
        [Parameter(Mandatory=$true)]
        [Alias("Path","FullName")]
        [string]$FilePath
    )
    
    Get-Item $FilePath
}

# å¤šç§è°ƒç”¨æ–¹å¼
Get-FileInfo -FilePath "C:\test.txt"
Get-FileInfo -Path "C:\test.txt"
Get-FileInfo -FullName "C:\test.txt"
```

### 6.2.4 å‚æ•°éªŒè¯

```powershell
# èŒƒå›´éªŒè¯
function Set-Volume {
    param(
        [ValidateRange(0, 100)]
        [int]$Level
    )
    Write-Host "Volume set to $Level"
}

Set-Volume -Level 50    # âœ… OK
Set-Volume -Level 150   # âŒ é”™è¯¯

# é•¿åº¦éªŒè¯
function Set-Password {
    param(
        [ValidateLength(8, 20)]
        [string]$Password
    )
    Write-Host "Password set successfully"
}

# æ¨¡å¼éªŒè¯
function Set-Email {
    param(
        [ValidatePattern('^\w+@\w+\.\w+$')]
        [string]$Email
    )
    Write-Host "Email: $Email"
}

# é›†åˆéªŒè¯
function Set-Environment {
    param(
        [ValidateSet("Dev", "Test", "Prod")]
        [string]$Environment
    )
    Write-Host "Environment: $Environment"
}

Set-Environment -Environment "Dev"   # âœ… OK
Set-Environment -Environment "Local" # âŒ é”™è¯¯

# è„šæœ¬éªŒè¯
function Set-Age {
    param(
        [ValidateScript({$_ -gt 0 -and $_ -lt 120})]
        [int]$Age
    )
    Write-Host "Age: $Age"
}

# éç©ºéªŒè¯
function Set-Name {
    param(
        [ValidateNotNullOrEmpty()]
        [string]$Name
    )
    Write-Host "Name: $Name"
}
```

---

## 6.3 é«˜çº§å‡½æ•°

### 6.3.1 CmdletBinding

```powershell
# é«˜çº§å‡½æ•°(ç±»ä¼¼Cmdlet)
function Get-ServiceStatus {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ServiceName
    )
    
    Write-Verbose "Checking service: $ServiceName"
    
    $service = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
    
    if ($service) {
        Write-Host "Service: $ServiceName"
        Write-Host "Status: $($service.Status)"
    } else {
        Write-Warning "Service $ServiceName not found"
    }
}

# ä½¿ç”¨-Verboseå‚æ•°
Get-ServiceStatus -ServiceName "Spooler" -Verbose
```

### 6.3.2 ç®¡é“å‚æ•°

```powershell
# æ¥å—ç®¡é“è¾“å…¥
function Get-DoubleValue {
    [CmdletBinding()]
    param(
        [Parameter(
            Mandatory=$true,
            ValueFromPipeline=$true
        )]
        [int]$Number
    )
    
    process {
        $Number * 2
    }
}

# ä½¿ç”¨ç®¡é“
1..5 | Get-DoubleValue
# è¾“å‡º: 2, 4, 6, 8, 10

# ç®¡é“è¾“å…¥å±æ€§
function Get-FileSize {
    [CmdletBinding()]
    param(
        [Parameter(
            Mandatory=$true,
            ValueFromPipelineByPropertyName=$true
        )]
        [string]$FullName
    )
    
    process {
        $file = Get-Item $FullName
        [PSCustomObject]@{
            Name = $file.Name
            SizeMB = [Math]::Round($file.Length / 1MB, 2)
        }
    }
}

# ä½¿ç”¨
Get-ChildItem C:\Windows\*.log | Get-FileSize
```

### 6.3.3 Begin/Process/Endå—

```powershell
# å¤„ç†ç®¡é“æ•°æ®
function Get-Statistics {
    [CmdletBinding()]
    param(
        [Parameter(ValueFromPipeline=$true)]
        [int]$Number
    )
    
    begin {
        Write-Host "Starting calculation..." -ForegroundColor Cyan
        $sum = 0
        $count = 0
    }
    
    process {
        $sum += $Number
        $count++
        Write-Verbose "Processing: $Number"
    }
    
    end {
        $average = $sum / $count
        Write-Host "`nResults:" -ForegroundColor Green
        Write-Host "Count: $count"
        Write-Host "Sum: $sum"
        Write-Host "Average: $average"
    }
}

# ä½¿ç”¨
1..10 | Get-Statistics -Verbose
```

---

## 6.4 å‡½æ•°ä½œç”¨åŸŸ

### 6.4.1 ä½œç”¨åŸŸç±»å‹

```powershell
# Globalä½œç”¨åŸŸ
$global:AppName = "MyApp"

function Test-Scope {
    # Localä½œç”¨åŸŸ(é»˜è®¤)
    $localVar = "Local"
    
    # Scriptä½œç”¨åŸŸ
    $script:scriptVar = "Script"
    
    # è®¿é—®å…¨å±€å˜é‡
    Write-Host "Global: $global:AppName"
    Write-Host "Local: $localVar"
}

Test-Scope
Write-Host $scriptVar   # å¯è®¿é—®
Write-Host $localVar    # æ— æ³•è®¿é—®(ä¸å­˜åœ¨)

# Privateä½œç”¨åŸŸ
function Test-Private {
    $private:secret = "Secret"
    Write-Host $secret
}

Test-Private
# Write-Host $secret  # æ— æ³•è®¿é—®
```

### 6.4.2 å‚æ•°ä½œç”¨åŸŸ

```powershell
# å‚æ•°é»˜è®¤ä¸ºlocalä½œç”¨åŸŸ
function Modify-Variable {
    param([string]$Text)
    
    $Text = "Modified: $Text"
    Write-Host "Inside function: $Text"
}

$myText = "Original"
Modify-Variable -Text $myText
Write-Host "Outside function: $myText"  # ä»ç„¶æ˜¯"Original"

# ä½¿ç”¨å¼•ç”¨(ref)ä¿®æ”¹å¤–éƒ¨å˜é‡
function Modify-ByReference {
    param([ref]$Value)
    
    $Value.Value = "Modified"
}

$myValue = "Original"
Modify-ByReference -Value ([ref]$myValue)
Write-Host $myValue  # "Modified"
```

---

## 6.5 è„šæœ¬ç¼–å†™

### 6.5.1 è„šæœ¬åŸºç¡€

```powershell
# my-script.ps1
<#
.SYNOPSIS
    è„šæœ¬ç®€è¦æè¿°
.DESCRIPTION
    è„šæœ¬è¯¦ç»†æè¿°
.PARAMETER Name
    å‚æ•°è¯´æ˜
.EXAMPLE
    .\my-script.ps1 -Name "Alice"
.NOTES
    ä½œè€…: Your Name
    æ—¥æœŸ: 2024-01-15
#>

param(
    [Parameter(Mandatory=$true)]
    [string]$Name,
    
    [int]$Age = 0
)

Write-Host "Hello, $Name!"
if ($Age -gt 0) {
    Write-Host "Age: $Age"
}
```

### 6.5.2 Paramå—

```powershell
# è„šæœ¬å‚æ•°
param(
    [Parameter(Mandatory=$true, HelpMessage="Enter user name")]
    [string]$UserName,
    
    [Parameter(Mandatory=$false)]
    [ValidateSet("Dev", "Test", "Prod")]
    [string]$Environment = "Dev",
    
    [switch]$Verbose
)

Write-Host "User: $UserName"
Write-Host "Environment: $Environment"

if ($Verbose) {
    Write-Host "Verbose mode enabled" -ForegroundColor Yellow
}
```

### 6.5.3 è„šæœ¬æ–‡æ¡£

```powershell
<#
.SYNOPSIS
    ç”¨æˆ·ç®¡ç†å·¥å…·
    
.DESCRIPTION
    åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤ç”¨æˆ·è´¦æˆ·
    
.PARAMETER Action
    æ“ä½œç±»å‹: Create, Update, Delete
    
.PARAMETER UserName
    ç”¨æˆ·å
    
.PARAMETER Email
    ç”µå­é‚®ä»¶åœ°å€
    
.EXAMPLE
    .\User-Management.ps1 -Action Create -UserName "alice" -Email "alice@example.com"
    åˆ›å»ºæ–°ç”¨æˆ·
    
.EXAMPLE
    .\User-Management.ps1 -Action Delete -UserName "bob"
    åˆ é™¤ç”¨æˆ·
    
.NOTES
    æ–‡ä»¶å: User-Management.ps1
    ä½œè€…: Admin
    ç‰ˆæœ¬: 1.0
    åˆ›å»ºæ—¥æœŸ: 2024-01-15
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$true)]
    [ValidateSet("Create", "Update", "Delete")]
    [string]$Action,
    
    [Parameter(Mandatory=$true)]
    [string]$UserName,
    
    [string]$Email
)

# è„šæœ¬é€»è¾‘
switch ($Action) {
    "Create" {
        Write-Host "Creating user: $UserName"
        if ($Email) {
            Write-Host "Email: $Email"
        }
    }
    "Update" {
        Write-Host "Updating user: $UserName"
    }
    "Delete" {
        Write-Host "Deleting user: $UserName"
    }
}
```

---

## 6.6 å®éªŒ:å‡½æ•°ä¸è„šæœ¬åº”ç”¨

### å®éªŒ1: ç”¨æˆ·ç®¡ç†æ¨¡å—

```powershell
<#
.SYNOPSIS
    ç”¨æˆ·ç®¡ç†æ¨¡å—
.DESCRIPTION
    åŒ…å«ç”¨æˆ·CRUDæ“ä½œçš„å‡½æ•°é›†åˆ
#>

# å…¨å±€ç”¨æˆ·æ•°æ®
$script:Users = @()

function New-User {
    <#
    .SYNOPSIS
        åˆ›å»ºæ–°ç”¨æˆ·
    .PARAMETER UserName
        ç”¨æˆ·å
    .PARAMETER Email
        ç”µå­é‚®ä»¶
    .PARAMETER Department
        éƒ¨é—¨
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [ValidatePattern('^\w+$')]
        [string]$UserName,
        
        [Parameter(Mandatory=$true)]
        [ValidatePattern('^\w+@\w+\.\w+$')]
        [string]$Email,
        
        [string]$Department = "General"
    )
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    if ($script:Users | Where-Object {$_.UserName -eq $UserName}) {
        Write-Warning "User $UserName already exists"
        return
    }
    
    $user = [PSCustomObject]@{
        UserName = $UserName
        Email = $Email
        Department = $Department
        CreatedDate = Get-Date
    }
    
    $script:Users += $user
    Write-Host "âœ“ User $UserName created successfully" -ForegroundColor Green
    return $user
}

function Get-User {
    <#
    .SYNOPSIS
        è·å–ç”¨æˆ·ä¿¡æ¯
    .PARAMETER UserName
        ç”¨æˆ·å(å¯é€‰)
    #>
    [CmdletBinding()]
    param(
        [string]$UserName
    )
    
    if ($UserName) {
        $script:Users | Where-Object {$_.UserName -eq $UserName}
    } else {
        $script:Users
    }
}

function Update-User {
    <#
    .SYNOPSIS
        æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$UserName,
        
        [string]$Email,
        [string]$Department
    )
    
    $user = $script:Users | Where-Object {$_.UserName -eq $UserName}
    
    if (-not $user) {
        Write-Warning "User $UserName not found"
        return
    }
    
    if ($Email) { $user.Email = $Email }
    if ($Department) { $user.Department = $Department }
    
    Write-Host "âœ“ User $UserName updated successfully" -ForegroundColor Green
}

function Remove-User {
    <#
    .SYNOPSIS
        åˆ é™¤ç”¨æˆ·
    #>
    [CmdletBinding(SupportsShouldProcess=$true)]
    param(
        [Parameter(Mandatory=$true)]
        [string]$UserName
    )
    
    $user = $script:Users | Where-Object {$_.UserName -eq $UserName}
    
    if (-not $user) {
        Write-Warning "User $UserName not found"
        return
    }
    
    if ($PSCmdlet.ShouldProcess($UserName, "Delete user")) {
        $script:Users = $script:Users | Where-Object {$_.UserName -ne $UserName}
        Write-Host "âœ“ User $UserName deleted successfully" -ForegroundColor Green
    }
}

# æµ‹è¯•å‡½æ•°
New-User -UserName "alice" -Email "alice@example.com" -Department "IT"
New-User -UserName "bob" -Email "bob@example.com"
New-User -UserName "charlie" -Email "charlie@example.com" -Department "HR"

Write-Host "`n=== All Users ===" -ForegroundColor Cyan
Get-User | Format-Table

Write-Host "`n=== Update User ===" -ForegroundColor Cyan
Update-User -UserName "bob" -Department "Sales"

Write-Host "`n=== Updated User List ===" -ForegroundColor Cyan
Get-User | Format-Table

Write-Host "`n=== Delete User ===" -ForegroundColor Cyan
Remove-User -UserName "charlie" -Confirm:$false

Write-Host "`n=== Final User List ===" -ForegroundColor Cyan
Get-User | Format-Table
```

### å®éªŒ2: æ—¥å¿—è®°å½•ç³»ç»Ÿ

```powershell
<#
.SYNOPSIS
    æ—¥å¿—è®°å½•ç³»ç»Ÿ
.DESCRIPTION
    æä¾›ç»Ÿä¸€çš„æ—¥å¿—è®°å½•åŠŸèƒ½
#>

# æ—¥å¿—çº§åˆ«æšä¸¾
enum LogLevel {
    Debug
    Info
    Warning
    Error
    Critical
}

# å…¨å±€æ—¥å¿—é…ç½®
$script:LogConfig = @{
    LogFile = ".\app.log"
    LogLevel = [LogLevel]::Info
    EnableConsole = $true
    EnableFile = $true
}

function Write-Log {
    <#
    .SYNOPSIS
        å†™å…¥æ—¥å¿—
    .PARAMETER Message
        æ—¥å¿—æ¶ˆæ¯
    .PARAMETER Level
        æ—¥å¿—çº§åˆ«
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Message,
        
        [LogLevel]$Level = [LogLevel]::Info
    )
    
    # æ£€æŸ¥æ—¥å¿—çº§åˆ«
    if ($Level -lt $script:LogConfig.LogLevel) {
        return
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    
    # æ§åˆ¶å°è¾“å‡º
    if ($script:LogConfig.EnableConsole) {
        $color = switch ($Level) {
            Debug { "Gray" }
            Info { "White" }
            Warning { "Yellow" }
            Error { "Red" }
            Critical { "Magenta" }
        }
        Write-Host $logEntry -ForegroundColor $color
    }
    
    # æ–‡ä»¶è¾“å‡º
    if ($script:LogConfig.EnableFile) {
        Add-Content -Path $script:LogConfig.LogFile -Value $logEntry
    }
}

function Set-LogLevel {
    <#
    .SYNOPSIS
        è®¾ç½®æ—¥å¿—çº§åˆ«
    #>
    param(
        [LogLevel]$Level
    )
    
    $script:LogConfig.LogLevel = $Level
    Write-Log "Log level set to $Level" -Level Info
}

# ä¾¿æ·å‡½æ•°
function Write-DebugLog {
    param([string]$Message)
    Write-Log -Message $Message -Level Debug
}

function Write-InfoLog {
    param([string]$Message)
    Write-Log -Message $Message -Level Info
}

function Write-WarningLog {
    param([string]$Message)
    Write-Log -Message $Message -Level Warning
}

function Write-ErrorLog {
    param([string]$Message)
    Write-Log -Message $Message -Level Error
}

# æµ‹è¯•æ—¥å¿—ç³»ç»Ÿ
Write-InfoLog "Application started"
Write-DebugLog "This is a debug message"
Write-WarningLog "This is a warning"
Write-ErrorLog "This is an error"
Write-Log "Critical issue!" -Level Critical
```

---

## 6.7 è¯¾åç»ƒä¹ 

### ç»ƒä¹ 1: å‡½æ•°ç»ƒä¹ 

åˆ›å»ºä»¥ä¸‹å‡½æ•°:
1. è®¡ç®—å™¨å‡½æ•°(æ”¯æŒ+ã€-ã€*ã€/)
2. æ¸©åº¦è½¬æ¢å‡½æ•°(æ‘„æ°åº¦â†”åæ°åº¦)
3. å­—ç¬¦ä¸²åè½¬å‡½æ•°

### ç»ƒä¹ 2: å‚æ•°éªŒè¯

å®ç°å¸¦éªŒè¯çš„å‡½æ•°:
1. ç”¨æˆ·æ³¨å†Œ(éªŒè¯ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç )
2. æ—¥æœŸèŒƒå›´æ£€æŸ¥
3. æ–‡ä»¶è·¯å¾„éªŒè¯

### ç»ƒä¹ 3: è„šæœ¬å¼€å‘

å¼€å‘å®Œæ•´è„šæœ¬:
1. æ–‡ä»¶å¤‡ä»½å·¥å…·
2. ç³»ç»Ÿä¿¡æ¯æ”¶é›†å™¨
3. æ‰¹é‡æ–‡ä»¶é‡å‘½åå·¥å…·

---

## 6.8 æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µ

âœ… **å‡½æ•°**: Functionå®šä¹‰ã€å‚æ•°ã€è¿”å›å€¼

âœ… **é«˜çº§å‡½æ•°**: CmdletBindingã€ç®¡é“æ”¯æŒ

âœ… **å‚æ•°éªŒè¯**: Mandatoryã€ValidateSetã€ValidateRange

âœ… **ä½œç”¨åŸŸ**: Globalã€Scriptã€Localã€Private

âœ… **è„šæœ¬**: Paramå—ã€æ–‡æ¡£æ³¨é‡Š

### å…³é”®è¯­æ³•

```powershell
# åŸºæœ¬å‡½æ•°
function Verb-Noun {
    param($Parameter)
    # ä»£ç 
}

# é«˜çº§å‡½æ•°
function Get-Data {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [ValidateSet("A","B","C")]
        [string]$Type
    )
    
    begin { }
    process { }
    end { }
}

# è„šæœ¬å‚æ•°
param(
    [Parameter(Mandatory=$true)]
    [string]$Name
)
```

### ä¸‹ä¸€ç« é¢„å‘Š

**ç¬¬7ç«  - å¯¹è±¡ä¸ç®¡é“**,å°†å­¦ä¹ :
- ğŸ¯ å¯¹è±¡å±æ€§å’Œæ–¹æ³•
- ğŸ”— ç®¡é“æ·±å…¥ç†è§£
- ğŸ“¦ è‡ªå®šä¹‰å¯¹è±¡
- ğŸ”„ å¯¹è±¡æ“ä½œ

---

[â† ä¸Šä¸€ç« ](./5-æ§åˆ¶æµç¨‹.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€ç« : å¯¹è±¡ä¸ç®¡é“ â†’](./7-å¯¹è±¡ä¸ç®¡é“.md)
