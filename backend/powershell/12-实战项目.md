# ç¬¬12ç« ï¼šå®æˆ˜é¡¹ç›®

> **å­¦ä¹ æ—¶é•¿**: 10-15å°æ—¶  
> **éš¾åº¦**: â­â­â­â­â­  
> **å‰ç½®çŸ¥è¯†**: ç¬¬1-11ç«   
> **é¡¹ç›®ç±»å‹**: ä¼ä¸šçº§å®æˆ˜

## æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« å,ä½ å°†èƒ½å¤Ÿ:

- âœ… è®¾è®¡å’Œå®ç°å®Œæ•´çš„PowerShellè§£å†³æ–¹æ¡ˆ
- âœ… åº”ç”¨æ‰€æœ‰å­¦è¿‡çš„çŸ¥è¯†åˆ°å®é™…é¡¹ç›®
- âœ… æŒæ¡ä¼ä¸šçº§PowerShellå¼€å‘æœ€ä½³å®è·µ
- âœ… ç‹¬ç«‹å¼€å‘è‡ªåŠ¨åŒ–å·¥å…·å’Œç³»ç»Ÿ
- âœ… è¿›è¡Œæ€§èƒ½ä¼˜åŒ–å’Œæ•…éšœæ’æŸ¥

---

## 12.1 é¡¹ç›®1: ç³»ç»Ÿç›‘æ§ä¸æŠ¥å‘Šå·¥å…·

### 12.1.1 é¡¹ç›®éœ€æ±‚

**åŠŸèƒ½éœ€æ±‚**:
- ç›‘æ§å¤šå°æœåŠ¡å™¨çš„CPUã€å†…å­˜ã€ç£ç›˜
- æ£€æŸ¥å…³é”®æœåŠ¡çŠ¶æ€
- ç”ŸæˆHTML/PDFæŠ¥å‘Š
- é‚®ä»¶å‘Šè­¦
- æ•°æ®æŒä¹…åŒ–
- å†å²è¶‹åŠ¿åˆ†æ

### 12.1.2 é¡¹ç›®å®ç°

```powershell
<#
.SYNOPSIS
    ä¼ä¸šçº§ç³»ç»Ÿç›‘æ§å·¥å…·
.DESCRIPTION
    ç›‘æ§æœåŠ¡å™¨å¥åº·çŠ¶æ€å¹¶ç”ŸæˆæŠ¥å‘Š
.AUTHOR
    Your Name
.VERSION
    1.0.0
#>

#region é…ç½®ç±»
class MonitorConfig {
    [string[]]$Servers
    [int]$CPUThreshold = 80
    [int]$MemoryThreshold = 85
    [int]$DiskThreshold = 90
    [string[]]$CriticalServices
    [string]$ReportPath = ".\Reports"
    [string]$DataPath = ".\Data"
    [bool]$EmailEnabled = $true
    [string]$SMTPServer
    [string]$FromAddress
    [string[]]$ToAddress
    
    MonitorConfig([string]$configFile) {
        if (Test-Path $configFile) {
            $config = Get-Content $configFile | ConvertFrom-Json
            $this.Servers = $config.Servers
            $this.CPUThreshold = $config.CPUThreshold
            $this.MemoryThreshold = $config.MemoryThreshold
            $this.DiskThreshold = $config.DiskThreshold
            $this.CriticalServices = $config.CriticalServices
            $this.SMTPServer = $config.SMTPServer
            $this.FromAddress = $config.FromAddress
            $this.ToAddress = $config.ToAddress
        }
    }
}
#endregion

#region æ•°æ®æ”¶é›†
function Get-ServerMetrics {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string[]]$ComputerName,
        
        [Parameter(Mandatory=$true)]
        [MonitorConfig]$Config
    )
    
    Write-Verbose "Collecting metrics from $($ComputerName.Count) servers..."
    
    $results = Invoke-Command -ComputerName $ComputerName -ScriptBlock {
        param($Services)
        
        # CPUä½¿ç”¨ç‡
        $cpuUsage = (Get-Counter '\Processor(_Total)\% Processor Time' -SampleInterval 1 -MaxSamples 3 |
            Select-Object -ExpandProperty CounterSamples |
            Measure-Object -Property CookedValue -Average).Average
        
        # å†…å­˜ä¿¡æ¯
        $os = Get-CimInstance Win32_OperatingSystem
        $totalMemory = $os.TotalVisibleMemorySize
        $freeMemory = $os.FreePhysicalMemory
        $usedMemory = $totalMemory - $freeMemory
        $memoryUsage = ($usedMemory / $totalMemory) * 100
        
        # ç£ç›˜ä¿¡æ¯
        $disks = Get-CimInstance Win32_LogicalDisk -Filter "DriveType=3" | ForEach-Object {
            [PSCustomObject]@{
                Drive = $_.DeviceID
                TotalGB = [Math]::Round($_.Size / 1GB, 2)
                FreeGB = [Math]::Round($_.FreeSpace / 1GB, 2)
                UsedGB = [Math]::Round(($_.Size - $_.FreeSpace) / 1GB, 2)
                UsedPercent = [Math]::Round((($_.Size - $_.FreeSpace) / $_.Size) * 100, 2)
            }
        }
        
        # æœåŠ¡çŠ¶æ€
        $serviceStatus = foreach ($svc in $Services) {
            $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
            [PSCustomObject]@{
                Name = $svc
                Status = if ($service) {$service.Status} else {"NotFound"}
                StartType = if ($service) {$service.StartType} else {"N/A"}
            }
        }
        
        # ç½‘ç»œè¿æ¥
        $networkAdapters = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object Name, LinkSpeed, Status
        
        # ç³»ç»Ÿè¿è¡Œæ—¶é—´
        $uptime = (Get-Date) - $os.LastBootUpTime
        
        [PSCustomObject]@{
            ComputerName = $env:COMPUTERNAME
            Timestamp = Get-Date
            CPU = @{
                Usage = [Math]::Round($cpuUsage, 2)
                ProcessorCount = (Get-CimInstance Win32_Processor).Count
                ProcessorName = (Get-CimInstance Win32_Processor | Select-Object -First 1).Name
            }
            Memory = @{
                TotalGB = [Math]::Round($totalMemory / 1MB, 2)
                UsedGB = [Math]::Round($usedMemory / 1MB, 2)
                FreeGB = [Math]::Round($freeMemory / 1MB, 2)
                UsagePercent = [Math]::Round($memoryUsage, 2)
            }
            Disks = $disks
            Services = $serviceStatus
            Network = $networkAdapters
            Uptime = [PSCustomObject]@{
                Days = $uptime.Days
                Hours = $uptime.Hours
                Minutes = $uptime.Minutes
                TotalHours = [Math]::Round($uptime.TotalHours, 2)
            }
            OS = @{
                Caption = $os.Caption
                Version = $os.Version
                BuildNumber = $os.BuildNumber
                Architecture = $os.OSArchitecture
            }
        }
    } -ArgumentList (,$Config.CriticalServices)
    
    return $results
}
#endregion

#region æ•°æ®åˆ†æ
function Test-ServerHealth {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        $Metrics,
        
        [Parameter(Mandatory=$true)]
        [MonitorConfig]$Config
    )
    
    $issues = @()
    
    foreach ($server in $Metrics) {
        # CPUæ£€æŸ¥
        if ($server.CPU.Usage -gt $Config.CPUThreshold) {
            $issues += [PSCustomObject]@{
                Server = $server.ComputerName
                Type = "CPU"
                Severity = "High"
                Message = "CPU usage is $($server.CPU.Usage)% (Threshold: $($Config.CPUThreshold)%)"
                Value = $server.CPU.Usage
            }
        }
        
        # å†…å­˜æ£€æŸ¥
        if ($server.Memory.UsagePercent -gt $Config.MemoryThreshold) {
            $issues += [PSCustomObject]@{
                Server = $server.ComputerName
                Type = "Memory"
                Severity = "High"
                Message = "Memory usage is $($server.Memory.UsagePercent)% (Threshold: $($Config.MemoryThreshold)%)"
                Value = $server.Memory.UsagePercent
            }
        }
        
        # ç£ç›˜æ£€æŸ¥
        foreach ($disk in $server.Disks) {
            if ($disk.UsedPercent -gt $Config.DiskThreshold) {
                $issues += [PSCustomObject]@{
                    Server = $server.ComputerName
                    Type = "Disk"
                    Severity = "Critical"
                    Message = "Disk $($disk.Drive) usage is $($disk.UsedPercent)% (Threshold: $($Config.DiskThreshold)%)"
                    Value = $disk.UsedPercent
                }
            }
        }
        
        # æœåŠ¡æ£€æŸ¥
        foreach ($svc in $server.Services) {
            if ($svc.Status -ne "Running") {
                $issues += [PSCustomObject]@{
                    Server = $server.ComputerName
                    Type = "Service"
                    Severity = "Critical"
                    Message = "Service '$($svc.Name)' is $($svc.Status)"
                    Value = $svc.Status
                }
            }
        }
    }
    
    return $issues
}
#endregion

#region æŠ¥å‘Šç”Ÿæˆ
function New-HTMLReport {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        $Metrics,
        
        [Parameter(Mandatory=$true)]
        $Issues,
        
        [string]$OutputPath
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <title>Server Monitoring Report</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .header { background-color: #2c3e50; color: white; padding: 20px; border-radius: 5px; }
        .summary { display: flex; justify-content: space-around; margin: 20px 0; }
        .summary-box { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 150px; }
        .summary-box h3 { margin: 0; color: #7f8c8d; font-size: 14px; }
        .summary-box .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .ok { color: #27ae60; }
        .warning { color: #f39c12; }
        .critical { color: #e74c3c; }
        table { width: 100%; border-collapse: collapse; background: white; margin: 20px 0; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th { background-color: #34495e; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ecf0f1; }
        tr:hover { background-color: #ecf0f1; }
        .status-ok { background-color: #d5f4e6; color: #27ae60; padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .status-warning { background-color: #fdebd0; color: #f39c12; padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .status-critical { background-color: #fadbd8; color: #e74c3c; padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .server-section { background: white; margin: 20px 0; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .server-name { font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ–¥ï¸ Server Monitoring Report</h1>
        <p>Generated: $timestamp</p>
    </div>
    
    <div class="summary">
        <div class="summary-box">
            <h3>Total Servers</h3>
            <div class="number">$($Metrics.Count)</div>
        </div>
        <div class="summary-box">
            <h3>Healthy</h3>
            <div class="number ok">$(($Metrics.Count - ($Issues | Select-Object -ExpandProperty Server -Unique).Count))</div>
        </div>
        <div class="summary-box">
            <h3>Issues Found</h3>
            <div class="number critical">$($Issues.Count)</div>
        </div>
        <div class="summary-box">
            <h3>Critical</h3>
            <div class="number critical">$(($Issues | Where-Object {$_.Severity -eq 'Critical'}).Count)</div>
        </div>
    </div>
"@
    
    if ($Issues.Count -gt 0) {
        $html += @"
    <div class="server-section">
        <div class="server-name">âš ï¸ Issues Detected</div>
        <table>
            <tr>
                <th>Server</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Message</th>
            </tr>
"@
        foreach ($issue in $Issues | Sort-Object Severity, Server) {
            $statusClass = switch ($issue.Severity) {
                "Critical" { "status-critical" }
                "High" { "status-warning" }
                default { "status-ok" }
            }
            $html += @"
            <tr>
                <td>$($issue.Server)</td>
                <td>$($issue.Type)</td>
                <td><span class="$statusClass">$($issue.Severity)</span></td>
                <td>$($issue.Message)</td>
            </tr>
"@
        }
        $html += @"
        </table>
    </div>
"@
    }
    
    # æœåŠ¡å™¨è¯¦æƒ…
    foreach ($server in $Metrics | Sort-Object ComputerName) {
        $html += @"
    <div class="server-section">
        <div class="server-name">ğŸ–¥ï¸ $($server.ComputerName)</div>
        <table>
            <tr><th colspan="2">System Information</th></tr>
            <tr><td>OS</td><td>$($server.OS.Caption) ($($server.OS.Architecture))</td></tr>
            <tr><td>Uptime</td><td>$($server.Uptime.Days) days, $($server.Uptime.Hours) hours</td></tr>
            <tr><td>CPU</td><td>$($server.CPU.ProcessorName)</td></tr>
        </table>
        
        <table>
            <tr><th colspan="2">Resource Usage</th></tr>
            <tr><td>CPU Usage</td><td>$($server.CPU.Usage)%</td></tr>
            <tr><td>Memory Usage</td><td>$($server.Memory.UsedGB) GB / $($server.Memory.TotalGB) GB ($($server.Memory.UsagePercent)%)</td></tr>
        </table>
        
        <table>
            <tr>
                <th>Drive</th>
                <th>Total</th>
                <th>Used</th>
                <th>Free</th>
                <th>Usage</th>
            </tr>
"@
        foreach ($disk in $server.Disks) {
            $html += @"
            <tr>
                <td>$($disk.Drive)</td>
                <td>$($disk.TotalGB) GB</td>
                <td>$($disk.UsedGB) GB</td>
                <td>$($disk.FreeGB) GB</td>
                <td>$($disk.UsedPercent)%</td>
            </tr>
"@
        }
        $html += @"
        </table>
    </div>
"@
    }
    
    $html += @"
</body>
</html>
"@
    
    $html | Out-File -FilePath $OutputPath -Encoding UTF8
    Write-Host "âœ“ Report generated: $OutputPath" -ForegroundColor Green
}
#endregion

#region é‚®ä»¶é€šçŸ¥
function Send-AlertEmail {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        $Issues,
        
        [Parameter(Mandatory=$true)]
        [MonitorConfig]$Config,
        
        [string]$ReportPath
    )
    
    if (-not $Config.EmailEnabled -or $Issues.Count -eq 0) {
        return
    }
    
    $body = @"
<html>
<body>
<h2>Server Monitoring Alert</h2>
<p>$($Issues.Count) issues detected:</p>
<ul>
"@
    
    foreach ($issue in $Issues | Sort-Object Severity) {
        $body += "<li><strong>$($issue.Server)</strong>: $($issue.Message)</li>"
    }
    
    $body += @"
</ul>
<p>Please check the attached report for details.</p>
</body>
</html>
"@
    
    Send-MailMessage -From $Config.FromAddress `
        -To $Config.ToAddress `
        -Subject "Server Monitoring Alert - $($Issues.Count) Issues" `
        -Body $body `
        -BodyAsHtml `
        -SmtpServer $Config.SMTPServer `
        -Attachments $ReportPath
    
    Write-Host "âœ“ Alert email sent" -ForegroundColor Yellow
}
#endregion

#region ä¸»ç¨‹åº
function Start-ServerMonitoring {
    [CmdletBinding()]
    param(
        [string]$ConfigFile = ".\config.json"
    )
    
    Write-Host "`n=== Server Monitoring System ===" -ForegroundColor Cyan
    Write-Host "Starting at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n"
    
    # åŠ è½½é…ç½®
    $config = [MonitorConfig]::new($ConfigFile)
    
    # åˆ›å»ºç›®å½•
    @($config.ReportPath, $config.DataPath) | ForEach-Object {
        if (-not (Test-Path $_)) {
            New-Item -ItemType Directory -Path $_ | Out-Null
        }
    }
    
    try {
        # æ”¶é›†æ•°æ®
        Write-Host "Collecting metrics from $($config.Servers.Count) servers..." -ForegroundColor Cyan
        $metrics = Get-ServerMetrics -ComputerName $config.Servers -Config $config -Verbose
        
        # åˆ†æå¥åº·çŠ¶æ€
        Write-Host "Analyzing server health..." -ForegroundColor Cyan
        $issues = Test-ServerHealth -Metrics $metrics -Config $config
        
        # ä¿å­˜æ•°æ®
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $dataFile = Join-Path $config.DataPath "metrics_$timestamp.json"
        $metrics | ConvertTo-Json -Depth 10 | Set-Content $dataFile
        
        # ç”ŸæˆæŠ¥å‘Š
        Write-Host "Generating HTML report..." -ForegroundColor Cyan
        $reportFile = Join-Path $config.ReportPath "report_$timestamp.html"
        New-HTMLReport -Metrics $metrics -Issues $issues -OutputPath $reportFile
        
        # å‘é€å‘Šè­¦
        if ($issues.Count -gt 0) {
            Write-Host "`nâš ï¸  Found $($issues.Count) issues!" -ForegroundColor Yellow
            Send-AlertEmail -Issues $issues -Config $config -ReportPath $reportFile
        } else {
            Write-Host "`nâœ“ All servers are healthy!" -ForegroundColor Green
        }
        
        Write-Host "`nMonitoring completed successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "`nâœ— Error: $_" -ForegroundColor Red
        throw
    }
}
#endregion

# ç¤ºä¾‹é…ç½®æ–‡ä»¶ (config.json)
<#
{
    "Servers": ["Server01", "Server02", "Server03"],
    "CPUThreshold": 80,
    "MemoryThreshold": 85,
    "DiskThreshold": 90,
    "CriticalServices": ["Spooler", "W32Time", "WinRM"],
    "SMTPServer": "smtp.company.com",
    "FromAddress": "monitoring@company.com",
    "ToAddress": ["admin@company.com", "ops@company.com"]
}
#>

# è¿è¡Œç›‘æ§
# Start-ServerMonitoring -ConfigFile ".\config.json"
```

---

## 12.2 é¡¹ç›®2: è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿ

### 12.2.1 é¡¹ç›®æ¦‚è¿°

**åŠŸèƒ½**:
- ä»Gitæ‹‰å–ä»£ç 
- æ„å»ºåº”ç”¨ç¨‹åº
- è¿è¡Œæµ‹è¯•
- éƒ¨ç½²åˆ°å¤šç¯å¢ƒ(Dev/Test/Prod)
- å›æ»šåŠŸèƒ½
- éƒ¨ç½²æ—¥å¿—

### 12.2.2 æ ¸å¿ƒä»£ç 

```powershell
<#
.SYNOPSIS
    è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿ
.DESCRIPTION
    CI/CDç®¡é“å®ç°
#>

class DeploymentPipeline {
    [string]$ProjectName
    [string]$GitRepo
    [string]$WorkingDirectory
    [string]$BuildDirectory
    [hashtable]$Environments
    [bool]$RunTests = $true
    
    DeploymentPipeline([string]$project, [string]$repo) {
        $this.ProjectName = $project
        $this.GitRepo = $repo
        $this.WorkingDirectory = "C:\Deploy\$project"
        $this.BuildDirectory = Join-Path $this.WorkingDirectory "Build"
        $this.Environments = @{
            Dev = @{
                Servers = @("DevServer01")
                Path = "C:\inetpub\wwwroot\$project"
                PreDeploy = {}
                PostDeploy = {}
            }
            Test = @{
                Servers = @("TestServer01", "TestServer02")
                Path = "C:\inetpub\wwwroot\$project"
                PreDeploy = {}
                PostDeploy = {}
            }
            Prod = @{
                Servers = @("ProdServer01", "ProdServer02", "ProdServer03")
                Path = "C:\inetpub\wwwroot\$project"
                PreDeploy = {
                    # å¥åº·æ£€æŸ¥
                }
                PostDeploy = {
                    # éªŒè¯éƒ¨ç½²
                }
            }
        }
    }
    
    [void]CloneOrPull() {
        Write-Host "Fetching latest code..." -ForegroundColor Cyan
        
        if (Test-Path $this.WorkingDirectory) {
            Push-Location $this.WorkingDirectory
            git pull origin master
            Pop-Location
        } else {
            git clone $this.GitRepo $this.WorkingDirectory
        }
    }
    
    [void]Build() {
        Write-Host "Building project..." -ForegroundColor Cyan
        
        Push-Location $this.WorkingDirectory
        
        # ç¤ºä¾‹: .NETé¡¹ç›®æ„å»º
        dotnet build --configuration Release --output $this.BuildDirectory
        
        Pop-Location
    }
    
    [void]RunTests() {
        if (-not $this.RunTests) {
            return
        }
        
        Write-Host "Running tests..." -ForegroundColor Cyan
        
        Push-Location $this.WorkingDirectory
        
        $testResult = dotnet test --logger "trx"
        
        if ($LASTEXITCODE -ne 0) {
            throw "Tests failed!"
        }
        
        Pop-Location
    }
    
    [void]Deploy([string]$environment) {
        Write-Host "Deploying to $environment..." -ForegroundColor Cyan
        
        $env = $this.Environments[$environment]
        
        if (-not $env) {
            throw "Unknown environment: $environment"
        }
        
        # Pre-deployment
        & $env.PreDeploy
        
        # åˆ›å»ºå¤‡ä»½
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        
        foreach ($server in $env.Servers) {
            Write-Host "  Deploying to $server..." -ForegroundColor Yellow
            
            Invoke-Command -ComputerName $server -ScriptBlock {
                param($TargetPath, $BackupPath, $BuildDir)
                
                # å¤‡ä»½å½“å‰ç‰ˆæœ¬
                if (Test-Path $TargetPath) {
                    Copy-Item -Path $TargetPath -Destination $BackupPath -Recurse
                }
                
                # åœæ­¢åº”ç”¨
                Stop-Website -Name "MyApp"
                
                # éƒ¨ç½²æ–°ç‰ˆæœ¬
                Copy-Item -Path $BuildDir\* -Destination $TargetPath -Recurse -Force
                
                # å¯åŠ¨åº”ç”¨
                Start-Website -Name "MyApp"
                
            } -ArgumentList $env.Path, "C:\Backups\$($this.ProjectName)_$timestamp", $this.BuildDirectory
        }
        
        # Post-deployment
        & $env.PostDeploy
        
        Write-Host "âœ“ Deployment to $environment completed" -ForegroundColor Green
    }
    
    [void]Rollback([string]$environment, [string]$backupPath) {
        Write-Host "Rolling back $environment..." -ForegroundColor Yellow
        
        $env = $this.Environments[$environment]
        
        foreach ($server in $env.Servers) {
            Invoke-Command -ComputerName $server -ScriptBlock {
                param($TargetPath, $BackupPath)
                
                Stop-Website -Name "MyApp"
                Remove-Item -Path $TargetPath -Recurse -Force
                Copy-Item -Path $BackupPath\* -Destination $TargetPath -Recurse
                Start-Website -Name "MyApp"
                
            } -ArgumentList $env.Path, $backupPath
        }
        
        Write-Host "âœ“ Rollback completed" -ForegroundColor Green
    }
}

# ä½¿ç”¨ç¤ºä¾‹
$pipeline = [DeploymentPipeline]::new("MyWebApp", "https://github.com/company/myapp.git")

# å®Œæ•´æµç¨‹
$pipeline.CloneOrPull()
$pipeline.Build()
$pipeline.RunTests()
$pipeline.Deploy("Dev")
# $pipeline.Deploy("Test")
# $pipeline.Deploy("Prod")
```

---

## 12.3 é¡¹ç›®3: æ—¥å¿—åˆ†æå·¥å…·

### 12.3.1 éœ€æ±‚åˆ†æ

**åŠŸèƒ½**:
- è§£æå¤šç§æ—¥å¿—æ ¼å¼(IIS, Apache, Custom)
- ç»Ÿè®¡åˆ†æ(é”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€è®¿é—®é‡)
- å¼‚å¸¸æ£€æµ‹
- å¯è§†åŒ–æŠ¥å‘Š
- å®æ—¶ç›‘æ§

### 12.3.2 å®ç°ä»£ç 

```powershell
<#
.SYNOPSIS
    æ—¥å¿—åˆ†æå·¥å…·
#>

class LogAnalyzer {
    [string]$LogPath
    [string]$LogType
    [datetime]$StartTime
    [datetime]$EndTime
    [hashtable]$Statistics
    
    LogAnalyzer([string]$path, [string]$type) {
        $this.LogPath = $path
        $this.LogType = $type
        $this.Statistics = @{
            TotalRequests = 0
            ErrorCount = 0
            StatusCodes = @{}
            ResponseTimes = @()
            TopIPs = @{}
            TopURLs = @{}
            HourlyDistribution = @{}
        }
    }
    
    [object[]]ParseLog() {
        $entries = @()
        
        switch ($this.LogType) {
            "IIS" {
                $entries = $this.ParseIISLog()
            }
            "Apache" {
                $entries = $this.ParseApacheLog()
            }
            "Custom" {
                $entries = $this.ParseCustomLog()
            }
        }
        
        return $entries
    }
    
    hidden [object[]]ParseIISLog() {
        Get-Content $this.LogPath | Where-Object {
            $_ -notmatch "^#" -and $_.Trim() -ne ""
        } | ForEach-Object {
            $fields = $_ -split "\s+"
            
            [PSCustomObject]@{
                DateTime = [datetime]::Parse("$($fields[0]) $($fields[1])")
                ClientIP = $fields[2]
                Method = $fields[3]
                URI = $fields[4]
                StatusCode = [int]$fields[11]
                TimeTaken = [int]$fields[14]
            }
        }
    }
    
    [void]Analyze([object[]]$entries) {
        Write-Host "Analyzing $($entries.Count) log entries..." -ForegroundColor Cyan
        
        $this.Statistics.TotalRequests = $entries.Count
        
        foreach ($entry in $entries) {
            # çŠ¶æ€ç ç»Ÿè®¡
            if ($this.Statistics.StatusCodes.ContainsKey($entry.StatusCode)) {
                $this.Statistics.StatusCodes[$entry.StatusCode]++
            } else {
                $this.Statistics.StatusCodes[$entry.StatusCode] = 1
            }
            
            # é”™è¯¯è®¡æ•°
            if ($entry.StatusCode -ge 400) {
                $this.Statistics.ErrorCount++
            }
            
            # å“åº”æ—¶é—´
            $this.Statistics.ResponseTimes += $entry.TimeTaken
            
            # IPç»Ÿè®¡
            if ($this.Statistics.TopIPs.ContainsKey($entry.ClientIP)) {
                $this.Statistics.TopIPs[$entry.ClientIP]++
            } else {
                $this.Statistics.TopIPs[$entry.ClientIP] = 1
            }
            
            # URLç»Ÿè®¡
            if ($this.Statistics.TopURLs.ContainsKey($entry.URI)) {
                $this.Statistics.TopURLs[$entry.URI]++
            } else {
                $this.Statistics.TopURLs[$entry.URI] = 1
            }
            
            # å°æ—¶åˆ†å¸ƒ
            $hour = $entry.DateTime.Hour
            if ($this.Statistics.HourlyDistribution.ContainsKey($hour)) {
                $this.Statistics.HourlyDistribution[$hour]++
            } else {
                $this.Statistics.HourlyDistribution[$hour] = 1
            }
        }
    }
    
    [void]GenerateReport() {
        Write-Host "`n=== Log Analysis Report ===" -ForegroundColor Cyan
        Write-Host "Total Requests: $($this.Statistics.TotalRequests)"
        Write-Host "Error Count: $($this.Statistics.ErrorCount)"
        Write-Host "Error Rate: $([Math]::Round($this.Statistics.ErrorCount / $this.Statistics.TotalRequests * 100, 2))%"
        
        # å“åº”æ—¶é—´ç»Ÿè®¡
        $avgResponse = ($this.Statistics.ResponseTimes | Measure-Object -Average).Average
        $maxResponse = ($this.Statistics.ResponseTimes | Measure-Object -Maximum).Maximum
        Write-Host "`nResponse Times:"
        Write-Host "  Average: $([Math]::Round($avgResponse, 2))ms"
        Write-Host "  Maximum: $maxResponse ms"
        
        # Top IP
        Write-Host "`nTop 10 IP Addresses:"
        $this.Statistics.TopIPs.GetEnumerator() |
            Sort-Object Value -Descending |
            Select-Object -First 10 |
            ForEach-Object {
                Write-Host "  $($_.Key): $($_.Value) requests"
            }
        
        # Top URL
        Write-Host "`nTop 10 URLs:"
        $this.Statistics.TopURLs.GetEnumerator() |
            Sort-Object Value -Descending |
            Select-Object -First 10 |
            ForEach-Object {
                Write-Host "  $($_.Key): $($_.Value) requests"
            }
        
        # çŠ¶æ€ç åˆ†å¸ƒ
        Write-Host "`nStatus Code Distribution:"
        $this.Statistics.StatusCodes.GetEnumerator() |
            Sort-Object Key |
            ForEach-Object {
                $percent = [Math]::Round($_.Value / $this.Statistics.TotalRequests * 100, 2)
                Write-Host "  $($_.Key): $($_.Value) ($percent%)"
            }
    }
}

# ä½¿ç”¨ç¤ºä¾‹
$analyzer = [LogAnalyzer]::new("C:\inetpub\logs\LogFiles\W3SVC1\u_ex231215.log", "IIS")
$entries = $analyzer.ParseLog()
$analyzer.Analyze($entries)
$analyzer.GenerateReport()
```

---

## 12.4 æœ€ä½³å®è·µæ€»ç»“

### 12.4.1 ä»£ç ç»„ç»‡

```powershell
# âœ… å¥½çš„ç»„ç»‡ç»“æ„
MyProject/
â”œâ”€â”€ Modules/
â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”œâ”€â”€ Core.psm1
â”‚   â”‚   â””â”€â”€ Core.psd1
â”‚   â””â”€â”€ Utilities/
â”‚       â”œâ”€â”€ Utilities.psm1
â”‚       â””â”€â”€ Utilities.psd1
â”œâ”€â”€ Scripts/
â”‚   â”œâ”€â”€ Deploy.ps1
â”‚   â”œâ”€â”€ Backup.ps1
â”‚   â””â”€â”€ Monitor.ps1
â”œâ”€â”€ Tests/
â”‚   â”œâ”€â”€ Core.Tests.ps1
â”‚   â””â”€â”€ Utilities.Tests.ps1
â”œâ”€â”€ Config/
â”‚   â”œâ”€â”€ dev.json
â”‚   â”œâ”€â”€ test.json
â”‚   â””â”€â”€ prod.json
â”œâ”€â”€ Logs/
â””â”€â”€ README.md
```

### 12.4.2 æ€§èƒ½ä¼˜åŒ–

```powershell
# âŒ æ…¢é€Ÿ
foreach ($file in Get-ChildItem) {
    Get-Content $file | Where-Object {$_ -match "ERROR"}
}

# âœ… å¿«é€Ÿ
Get-ChildItem | ForEach-Object -Parallel {
    Get-Content $_ | Where-Object {$_ -match "ERROR"}
} -ThrottleLimit 10

# ä½¿ç”¨StringBuilder
$sb = [System.Text.StringBuilder]::new()
1..10000 | ForEach-Object {
    [void]$sb.AppendLine("Line $_")
}
$result = $sb.ToString()

# é¿å…é‡å¤è°ƒç”¨
# âŒ
for ($i=0; $i -lt (Get-ChildItem).Count; $i++) {}

# âœ…
$items = Get-ChildItem
for ($i=0; $i -lt $items.Count; $i++) {}
```

### 12.4.3 å®‰å…¨å®è·µ

```powershell
# ä½¿ç”¨SecureString
$securePassword = Read-Host "Password" -AsSecureString
$credential = New-Object System.Management.Automation.PSCredential("username", $securePassword)

# é¿å…æ˜æ–‡å¯†ç 
# âŒ ä¸è¦è¿™æ ·
$password = "MyPassword123"

# âœ… ä½¿ç”¨åŠ å¯†
$encrypted = ConvertFrom-SecureString $securePassword
$encrypted | Set-Content "password.txt"

# âœ… ä½¿ç”¨å‡­æ®ç®¡ç†å™¨
$credential = Get-Credential
```

---

## 12.5 å­¦ä¹ èµ„æº

### 12.5.1 å®˜æ–¹èµ„æº

- **PowerShellæ–‡æ¡£**: https://docs.microsoft.com/powershell
- **PowerShell Gallery**: https://www.powershellgallery.com
- **GitHub**: https://github.com/PowerShell/PowerShell

### 12.5.2 æ¨èä¹¦ç±

- PowerShell in Action (3rd Edition)
- Learn PowerShell in a Month of Lunches
- PowerShell Cookbook

### 12.5.3 ç¤¾åŒº

- PowerShell.org
- Reddit: r/PowerShell
- Stack Overflow: powershell tag

---

## 12.6 è¿›é˜¶è·¯çº¿

### Level 1: åŸºç¡€æŒæ¡ âœ…
- å®Œæˆç¬¬1-6ç« 
- èƒ½ç¼–å†™åŸºæœ¬è„šæœ¬
- ç†è§£ç®¡é“å’Œå¯¹è±¡

### Level 2: å®è·µåº”ç”¨ âœ…
- å®Œæˆç¬¬7-9ç« 
- å¼€å‘å®ç”¨å·¥å…·
- æŒæ¡é”™è¯¯å¤„ç†

### Level 3: ç³»ç»Ÿé›†æˆ âœ…
- å®Œæˆç¬¬10-11ç« 
- æ¨¡å—å¼€å‘
- è¿œç¨‹ç®¡ç†

### Level 4: ä¸“å®¶çº§åˆ« ğŸ¯
- å®Œæˆç¬¬12ç« é¡¹ç›®
- ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ
- æ€§èƒ½ä¼˜åŒ–

### Level 5: è¿›é˜¶æ–¹å‘ ğŸš€
- PowerShell DSC (Desired State Configuration)
- Azure PowerShell
- PowerShell Coreè·¨å¹³å°
- è‡ªå®šä¹‰Cmdletå¼€å‘(C#)

---

## 12.7 è¯¾åä½œä¸š

### æœ€ç»ˆé¡¹ç›®

é€‰æ‹©ä»¥ä¸‹é¡¹ç›®ä¹‹ä¸€å®Œæˆ:

1. **DevOpså·¥å…·é“¾**
   - Gité›†æˆ
   - è‡ªåŠ¨åŒ–æ„å»º
   - æµ‹è¯•å’Œéƒ¨ç½²
   - ç›‘æ§å’Œå‘Šè­¦

2. **ITè¿ç»´å¹³å°**
   - èµ„äº§ç®¡ç†
   - æœåŠ¡ç›‘æ§
   - è‡ªåŠ¨åŒ–è¿ç»´
   - æŠ¥è¡¨ç³»ç»Ÿ

3. **å®‰å…¨å®¡è®¡ç³»ç»Ÿ**
   - æ—¥å¿—æ”¶é›†
   - å®‰å…¨æ‰«æ
   - åˆè§„æ£€æŸ¥
   - æŠ¥å‘Šç”Ÿæˆ

---

## 12.8 ç»“è¯­

### æ­å–œä½ ! ğŸ‰

å®Œæˆäº†PowerShellä»å…¥é—¨åˆ°ä¸“å®¶çš„å®Œæ•´å­¦ä¹ æ—…ç¨‹!

**ä½ ç°åœ¨æŒæ¡äº†**:
- âœ… PowerShellæ ¸å¿ƒæ¦‚å¿µå’Œè¯­æ³•
- âœ… å¯¹è±¡å’Œç®¡é“çš„æ·±å…¥ç†è§£
- âœ… è„šæœ¬å’Œæ¨¡å—å¼€å‘
- âœ… è¿œç¨‹ç®¡ç†å’Œè‡ªåŠ¨åŒ–
- âœ… ä¼ä¸šçº§é¡¹ç›®å®æˆ˜ç»éªŒ

**ä¸‹ä¸€æ­¥å»ºè®®**:
1. å°†æ‰€å­¦åº”ç”¨åˆ°å®é™…å·¥ä½œä¸­
2. å‚ä¸å¼€æºé¡¹ç›®
3. æŒç»­å­¦ä¹ æ–°ç‰¹æ€§
4. åˆ†äº«çŸ¥è¯†,å¸®åŠ©ä»–äºº

### ä¿æŒå­¦ä¹ ,æŒç»­è¿›æ­¥! ğŸ’ª

---

[â† ä¸Šä¸€ç« ](./11-è¿œç¨‹ç®¡ç†ä¸è‡ªåŠ¨åŒ–.md) | [è¿”å›ç›®å½•](./README.md)

---

**æ•™ç¨‹å®Œæˆæ—¶é—´**: $(Get-Date -Format "yyyy-MM-dd")  
**æ€»å­¦ä¹ æ—¶é—´**: 80-100å°æ—¶  
**æŒæ¡ç¨‹åº¦**: ä¸“å®¶çº§ â­â­â­â­â­

æ„Ÿè°¢ä½ çš„å­¦ä¹ !ç¥PowerShellç¼–ç¨‹æ„‰å¿«! ğŸš€
