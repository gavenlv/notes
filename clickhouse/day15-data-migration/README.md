# Day 15: ClickHouse 数据迁移实战

## 📋 章节概述

本章节专门讲解ClickHouse集群数据迁移的实际场景，特别是从**3分片2副本集群**迁移到**1分片2副本集群**的完整流程。这是一个高级运维场景，适合有一定ClickHouse基础的用户学习。

## 🎯 学习目标

通过本章学习，您将掌握：

1. **迁移策略设计**: 理解不同迁移策略的优缺点
2. **实际迁移操作**: 掌握数据迁移的具体执行步骤
3. **数据校验方法**: 学会全面的数据完整性检查
4. **故障处理技能**: 了解迁移过程中的常见问题和解决方案
5. **性能优化经验**: 单分片集群的性能调优技巧

## 📁 文件结构

```
day15-data-migration/
├── README.md                           # 本文件
├── data-migration.md                   # 详细学习笔记
├── configs/                            # 配置文件
│   ├── source-cluster-config.xml       # 源集群配置(3分片2副本)
│   ├── target-cluster-config.xml       # 目标集群配置(1分片2副本)
│   └── copier-config.xml              # 数据迁移工具配置
├── scripts/                            # 脚本工具
│   ├── migration-manager.ps1           # 迁移管理主脚本
│   └── data-validation.ps1            # 数据校验脚本
└── examples/                           # 示例文件
    └── migration-demo.sql              # 完整迁移演示SQL
```

## 🚀 快速开始

### 环境要求

- ClickHouse 服务器集群（源：3分片2副本，目标：1分片2副本）
- ZooKeeper 集群（用于分布式协调）
- clickhouse-backup 工具（用于备份恢复）
- clickhouse-copier 工具（用于数据迁移）
- PowerShell 5.1+ （Windows环境）

### 迁移场景说明

**源集群架构**:
```
┌─────────────────────────────────────────┐
│          源集群 (cluster_3s_2r)          │
├─────────────────────────────────────────┤
│ Shard 1: 10.0.1.1, 10.0.1.2           │
│ Shard 2: 10.0.1.3, 10.0.1.4           │
│ Shard 3: 10.0.1.5, 10.0.1.6           │
└─────────────────────────────────────────┘
```

**目标集群架构**:
```
┌─────────────────────────────────────────┐
│          目标集群 (cluster_1s_2r)        │
├─────────────────────────────────────────┤
│ Shard 1: 10.0.1.1, 10.0.1.2           │
│         (复用原有IP地址)                 │
└─────────────────────────────────────────┘
```

### 第一步：环境检查

```powershell
# 检查源集群健康状态
.\scripts\migration-manager.ps1 -Action check-source

# 检查目标集群准备情况
.\scripts\migration-manager.ps1 -Action check-target
```

### 第二步：数据备份

```powershell
# 创建完整备份
.\scripts\migration-manager.ps1 -Action backup
```

### 第三步：执行迁移（预演模式）

```powershell
# 预演完整迁移流程
.\scripts\migration-manager.ps1 -Action full-migration -DryRun
```

### 第四步：执行实际迁移

```powershell
# 执行完整迁移流程
.\scripts\migration-manager.ps1 -Action full-migration
```

### 第五步：数据校验

```powershell
# 执行全面数据校验
.\scripts\data-validation.ps1 -SourceCluster "cluster_3s_2r" -TargetCluster "cluster_1s_2r"
```

## 📖 详细文档

- [完整迁移指南](data-migration.md) - 详细的理论知识和操作步骤
- [配置文件说明](configs/) - 各种配置文件的详细解释
- [脚本使用说明](scripts/) - 自动化脚本的使用方法
- [SQL演示](examples/migration-demo.sql) - 完整的SQL迁移演示

## ⚠️ 重要注意事项

1. **生产环境谨慎操作**: 本迁移会涉及服务停机，请在维护窗口执行
2. **充分测试**: 务必在测试环境完整验证迁移流程
3. **备份确认**: 确保数据备份完整且可恢复
4. **性能评估**: 单分片集群可能面临性能瓶颈，需要硬件升级
5. **监控准备**: 迁移过程需要密切监控系统资源和服务状态

## 🔧 常见问题

### Q1: 为什么要从3分片减少到1分片？
A: 常见原因包括：
- 数据量减少，不需要多分片
- 简化架构，降低运维复杂度
- 节约硬件资源
- 统一数据分布，避免数据倾斜

### Q2: 迁移过程中如何保证数据不丢失？
A: 通过以下措施保证：
- 完整的数据备份
- 停机迁移避免数据变更
- 多层次数据校验
- 完善的回滚方案

### Q3: 单分片性能会不会成为瓶颈？
A: 需要考虑：
- 评估当前数据量和查询负载
- 升级单分片的硬件配置
- 优化查询和表结构
- 必要时考虑垂直扩展

### Q4: 迁移失败如何回滚？
A: 回滚策略：
- 恢复原始集群配置
- 从备份中恢复数据
- 重启相关服务
- 验证系统正常运行

## 📊 预期成果

完成本章学习后，您将：

1. ✅ 掌握ClickHouse集群架构调整的完整流程
2. ✅ 具备生产环境数据迁移的实际操作能力
3. ✅ 学会全面的数据完整性校验方法
4. ✅ 了解集群迁移过程中的各种风险和应对策略
5. ✅ 拥有一套完整的迁移工具和脚本

## 🔗 相关章节

- [Day 8: 集群管理](../day8-cluster-management/) - 集群基础知识
- [Day 12: 备份恢复](../day12-backup-recovery/) - 备份恢复策略
- [Day 13: 最佳实践](../day13-best-practices/) - 生产环境运维

---

**准备好开始数据迁移的挑战了吗？** 让我们从[详细迁移指南](data-migration.md)开始吧！ 🚀 