# Apache Airflow自定义指标监控配置示例
# 包含Prometheus、Grafana和自定义指标导出器配置

# Prometheus配置
prometheus:
  # 全局配置
  global:
    scrape_interval: 15s
    evaluation_interval: 15s
  
  # 规则文件
  rule_files:
    - "airflow-rules.yml"
    - "custom-rules.yml"
  
  # 告警管理器配置
  alerting:
    alertmanagers:
      - static_configs:
          - targets:
              - alertmanager:9093
  
  # 抓取配置
  scrape_configs:
    # Airflow指标抓取
    - job_name: 'airflow'
      static_configs:
        - targets: ['airflow-webserver:8080']
      metrics_path: '/admin/metrics'
      scrape_interval: 30s
    
    # PostgreSQL指标抓取
    - job_name: 'postgresql'
      static_configs:
        - targets: ['airflow-postgresql:5432']
      metrics_path: '/metrics'
      scrape_interval: 30s
    
    # Redis指标抓取
    - job_name: 'redis'
      static_configs:
        - targets: ['airflow-redis-master:6379']
      metrics_path: '/metrics'
      scrape_interval: 30s
    
    # 自定义指标导出器
    - job_name: 'airflow-custom-exporter'
      static_configs:
        - targets: ['airflow-custom-metrics-exporter:8000']
      scrape_interval: 60s

# Prometheus告警规则
alerting_rules:
  # Airflow调度器健康检查
  - alert: AirflowSchedulerDown
    expr: airflow_scheduler_heartbeat <= 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Airflow scheduler is down"
      description: "Airflow scheduler has not heartbeated for more than 5 minutes"
  
  # Airflow Webserver状态检查
  - alert: AirflowWebserverDown
    expr: airflow_webserver_heartbeat <= 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Airflow webserver is down"
      description: "Airflow webserver has not heartbeated for more than 5 minutes"
  
  # 任务失败率过高
  - alert: HighTaskFailureRate
    expr: rate(airflow_task_failures[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High task failure rate"
      description: "Task failure rate is above 10% in the last 5 minutes"
  
  # DAG运行时间过长
  - alert: LongRunningDAG
    expr: airflow_dag_run_duration > 3600
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Long running DAG"
      description: "DAG run duration is over 1 hour"
  
  # Worker节点不足
  - alert: InsufficientWorkers
    expr: airflow_worker_count < 3
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Insufficient workers"
      description: "Worker count is below 3"
  
  # 数据库连接数过高
  - alert: HighDatabaseConnections
    expr: airflow_database_connections > 50
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High database connections"
      description: "Database connection count is above 50"
  
  # Redis内存使用率过高
  - alert: HighRedisMemoryUsage
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Redis memory usage"
      description: "Redis memory usage is above 80%"

# Grafana仪表板配置
grafana_dashboards:
  # Airflow任务执行时间仪表板
  - name: "Airflow Task Duration"
    uid: "airflow-task-duration"
    folder: "Airflow"
    panels:
      - title: "Average Task Duration"
        type: "graph"
        targets:
          - expr: "avg(airflow_task_duration)"
            legendFormat: "Average Duration"
        datasource: "Prometheus"
      
      - title: "Task Duration by DAG"
        type: "graph"
        targets:
          - expr: "avg(airflow_task_duration) by (dag_id)"
            legendFormat: "{{dag_id}}"
        datasource: "Prometheus"
  
  # Airflow活跃任务统计仪表板
  - name: "Airflow Active Tasks"
    uid: "airflow-active-tasks"
    folder: "Airflow"
    panels:
      - title: "Active Task Count"
        type: "stat"
        targets:
          - expr: "airflow_active_task_count"
            legendFormat: "Active Tasks"
        datasource: "Prometheus"
      
      - title: "Active Tasks by State"
        type: "graph"
        targets:
          - expr: "airflow_active_task_count by (state)"
            legendFormat: "{{state}}"
        datasource: "Prometheus"
  
  # Airflow失败任务统计仪表板
  - name: "Airflow Failed Tasks"
    uid: "airflow-failed-tasks"
    folder: "Airflow"
    panels:
      - title: "Failed Task Count"
        type: "stat"
        targets:
          - expr: "airflow_failed_task_count"
            legendFormat: "Failed Tasks"
        datasource: "Prometheus"
      
      - title: "Failed Tasks by DAG"
        type: "graph"
        targets:
          - expr: "airflow_failed_task_count by (dag_id)"
            legendFormat: "{{dag_id}}"
        datasource: "Prometheus"
      
      - title: "Task Failure Rate"
        type: "graph"
        targets:
          - expr: "rate(airflow_task_failures[5m])"
            legendFormat: "Failure Rate"
        datasource: "Prometheus"
  
  # Airflow调度器状态仪表板
  - name: "Airflow Scheduler Status"
    uid: "airflow-scheduler-status"
    folder: "Airflow"
    panels:
      - title: "Scheduler Heartbeat"
        type: "stat"
        targets:
          - expr: "airflow_scheduler_heartbeat"
            legendFormat: "Heartbeat"
        datasource: "Prometheus"
      
      - title: "Scheduler DAG Processing Time"
        type: "graph"
        targets:
          - expr: "airflow_scheduler_dag_processing_time"
            legendFormat: "Processing Time"
        datasource: "Prometheus"
  
  # Airflow Worker状态仪表板
  - name: "Airflow Worker Status"
    uid: "airflow-worker-status"
    folder: "Airflow"
    panels:
      - title: "Worker Count"
        type: "stat"
        targets:
          - expr: "airflow_worker_count"
            legendFormat: "Workers"
        datasource: "Prometheus"
      
      - title: "Worker CPU Usage"
        type: "graph"
        targets:
          - expr: "rate(container_cpu_usage_seconds_total{container=\"worker\"}[5m])"
            legendFormat: "CPU Usage"
        datasource: "Prometheus"
      
      - title: "Worker Memory Usage"
        type: "graph"
        targets:
          - expr: "container_memory_usage_bytes{container=\"worker\"}"
            legendFormat: "Memory Usage"
        datasource: "Prometheus"

# 自定义指标导出器配置
custom_metrics_exporter:
  # 应用配置
  app:
    port: 8000
    metrics_path: "/metrics"
    log_level: "INFO"
  
  # 数据库配置
  database:
    host: "airflow-postgresql"
    port: 5432
    user: "airflow"
    password: "airflow123"
    database: "airflow"
  
  # Redis配置
  redis:
    host: "airflow-redis-master"
    port: 6379
    password: ""
    database: 1
  
  # 自定义指标配置
  custom_metrics:
    # DAG执行统计
    - name: "dag_execution_stats"
      type: "gauge"
      description: "DAG execution statistics"
      query: |
        SELECT 
          dag_id,
          state,
          COUNT(*) as count
        FROM dag_run
        GROUP BY dag_id, state
      
      labels:
        - "dag_id"
        - "state"
      
      value_column: "count"
    
    # 任务执行统计
    - name: "task_execution_stats"
      type: "gauge"
      description: "Task execution statistics"
      query: |
        SELECT 
          task_id,
          state,
          COUNT(*) as count
        FROM task_instance
        GROUP BY task_id, state
      
      labels:
        - "task_id"
        - "state"
      
      value_column: "count"
    
    # 用户活动统计
    - name: "user_activity_stats"
      type: "gauge"
      description: "User activity statistics"
      query: |
        SELECT 
          user_id,
          COUNT(*) as login_count
        FROM log
        WHERE event = 'login'
        GROUP BY user_id
      
      labels:
        - "user_id"
      
      value_column: "login_count"
    
    # 资源使用统计
    - name: "resource_usage_stats"
      type: "gauge"
      description: "Resource usage statistics"
      query: |
        SELECT 
          component,
          AVG(cpu_usage) as avg_cpu,
          AVG(memory_usage) as avg_memory
        FROM resource_usage
        GROUP BY component
      
      labels:
        - "component"
      
      value_columns:
        - "avg_cpu"
        - "avg_memory"

# Kubernetes ServiceMonitor配置
kubernetes_servicemonitor:
  apiVersion: monitoring.coreos.com/v1
  kind: ServiceMonitor
  metadata:
    name: airflow-monitor
    namespace: airflow
    labels:
      app: airflow
  spec:
    selector:
      matchLabels:
        app: airflow
    endpoints:
      - port: metrics
        interval: 30s
        path: /admin/metrics
      - port: http
        interval: 60s
        path: /health
    namespaceSelector:
      matchNames:
        - airflow

# Docker Compose监控配置
docker_compose_monitoring:
  version: '3.8'
  
  services:
    # Prometheus服务
    prometheus:
      image: prom/prometheus:v2.40.0
      container_name: airflow-prometheus
      ports:
        - "9090:9090"
      volumes:
        - ./prometheus.yml:/etc/prometheus/prometheus.yml
        - ./rules:/etc/prometheus/rules
        - prometheus_data:/prometheus
      command:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--storage.tsdb.retention.time=200h'
        - '--web.enable-lifecycle'
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:9090/-/healthy"]
        interval: 30s
        timeout: 10s
        retries: 3
    
    # Grafana服务
    grafana:
      image: grafana/grafana-enterprise:9.3.0
      container_name: airflow-grafana
      ports:
        - "3000:3000"
      volumes:
        - grafana_data:/var/lib/grafana
        - ./grafana/provisioning:/etc/grafana/provisioning
      environment:
        - GF_SECURITY_ADMIN_USER=admin
        - GF_SECURITY_ADMIN_PASSWORD=admin123
        - GF_USERS_ALLOW_SIGN_UP=false
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:3000/api/health"]
        interval: 30s
        timeout: 10s
        retries: 3
    
    # Alertmanager服务
    alertmanager:
      image: prom/alertmanager:v0.24.0
      container_name: airflow-alertmanager
      ports:
        - "9093:9093"
      volumes:
        - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
        - alertmanager_data:/alertmanager
      command:
        - '--config.file=/etc/alertmanager/alertmanager.yml'
        - '--storage.path=/alertmanager'
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:9093"]
        interval: 30s
        timeout: 10s
        retries: 3
    
    # 自定义指标导出器
    custom-metrics-exporter:
      image: airflow/custom-metrics-exporter:latest
      container_name: airflow-custom-metrics-exporter
      ports:
        - "8000:8000"
      environment:
        - DATABASE_HOST=airflow-postgresql
        - DATABASE_PORT=5432
        - DATABASE_USER=airflow
        - DATABASE_PASSWORD=airflow123
        - DATABASE_NAME=airflow
        - REDIS_HOST=airflow-redis-master
        - REDIS_PORT=6379
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:8000/health"]
        interval: 30s
        timeout: 10s
        retries: 3
    
    # PostgreSQL Exporter
    postgresql-exporter:
      image: wrouesnel/postgres_exporter:v0.11.1
      container_name: airflow-postgresql-exporter
      ports:
        - "9187:9187"
      environment:
        - DATA_SOURCE_NAME=postgresql://airflow:airflow123@airflow-postgresql:5432/airflow?sslmode=disable
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:9187"]
        interval: 30s
        timeout: 10s
        retries: 3
    
    # Redis Exporter
    redis-exporter:
      image: oliver006/redis_exporter:v1.45.0
      container_name: airflow-redis-exporter
      ports:
        - "9121:9121"
      environment:
        - REDIS_ADDR=redis://airflow-redis-master:6379
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "wget", "--spider", "localhost:9121"]
        interval: 30s
        timeout: 10s
        retries: 3
  
  volumes:
    prometheus_data:
    grafana_data:
    alertmanager_data: