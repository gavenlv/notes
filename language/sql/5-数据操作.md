# 第5章：SQL数据操作

## 5.1 INSERT语句：插入数据

### 什么是INSERT语句？

INSERT语句用于向数据库表中插入新的数据行。这是SQL中最基本的数据操作之一，允许我们向表中添加新记录。

### 基本语法

```sql
-- 插入完整行数据
INSERT INTO table_name (column1, column2, column3, ...)
VALUES (value1, value2, value3, ...);

-- 插入部分列数据（未指定的列将使用默认值或NULL）
INSERT INTO table_name (column1, column2)
VALUES (value1, value2);

-- 省略列名（需要为所有列提供值，且顺序与表结构一致）
INSERT INTO table_name
VALUES (value1, value2, value3, ...);
```

### 插入单行数据

#### 插入完整行数据

```sql
-- 向employees表插入一条完整记录
INSERT INTO employees (id, name, age, gender, department_id, position, salary, hire_date, email, phone)
VALUES (16, '马十七', 27, '男', 1, '测试工程师', 11000.00, '2021-09-15', 'mashiqi@example.com', '13800138016');
```

#### 插入部分列数据

```sql
-- 只插入必要的列，其他列将使用默认值或NULL
INSERT INTO employees (name, age, gender, department_id, position, salary)
VALUES ('杨十八', 26, '女', 2, '市场助理', 7500.00);
```

### 插入多行数据

#### 多个VALUES子句

```sql
-- 一次插入多行数据
INSERT INTO employees (name, age, gender, department_id, position, salary, hire_date)
VALUES 
    ('朱十九', 32, '男', 1, '架构师', 22000.00, '2019-07-10'),
    ('秦二十', 29, '女', 3, '培训专员', 8000.00, '2020-11-20'),
    ('尤二十一', 35, '男', 4, '财务总监', 30000.00, '2018-03-05');
```

#### 从其他表插入数据

```sql
-- 从其他表选择数据插入
INSERT INTO employees_archive (id, name, position, salary, hire_date)
SELECT id, name, position, salary, hire_date
FROM employees
WHERE hire_date < '2020-01-01';
```

### 插入特定值

#### 插入NULL值

```sql
-- 插入NULL值（如果列允许NULL）
INSERT INTO employees (name, age, gender, department_id, position, salary, phone)
VALUES ('许二十二', 28, '男', 1, '前端工程师', 14000.00, NULL);
```

#### 插入默认值

```sql
-- 使用DEFAULT关键字插入默认值
INSERT INTO employees (name, age, gender, department_id, position, salary, is_active)
VALUES ('何二十三', 30, '女', 2, '市场分析师', 12000.00, DEFAULT);
```

#### 插入自动递增值

```sql
-- 不指定自增列，数据库会自动分配值
INSERT INTO employees (name, age, gender, department_id, position, salary)
VALUES ('吕二十四', 33, '男', 5, '算法工程师', 20000.00);
```

### 实验验证

让我们使用INSERT语句插入一些数据：

```sql
-- 创建示例数据库
CREATE DATABASE IF NOT EXISTS company_demo CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE company_demo;

-- 创建员工表
CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    age INT,
    gender VARCHAR(10),
    department_id INT,
    position VARCHAR(50),
    salary DECIMAL(10, 2),
    hire_date DATE,
    email VARCHAR(100),
    phone VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建部门表
CREATE TABLE departments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    location VARCHAR(100),
    budget DECIMAL(12, 2)
);

-- 插入部门数据
INSERT INTO departments (name, location, budget) VALUES
('技术部', '北京', 1000000.00),
('市场部', '上海', 800000.00),
('人事部', '广州', 500000.00),
('财务部', '深圳', 600000.00);

-- 插入完整行数据
INSERT INTO employees (name, age, gender, department_id, position, salary, hire_date, email, phone)
VALUES ('张三', 30, '男', 1, '高级工程师', 15000.00, '2020-01-15', 'zhangsan@example.com', '13800138001');

-- 插入部分列数据
INSERT INTO employees (name, age, gender, department_id, position, salary)
VALUES ('李四', 28, '女', 1, '工程师', 12000.00);

-- 插入多行数据
INSERT INTO employees (name, age, gender, department_id, position, salary, hire_date)
VALUES 
    ('王五', 35, '男', 1, '工程师', 13000.00, '2019-06-10'),
    ('赵六', 25, '女', 1, '初级工程师', 8000.00, '2021-02-28'),
    ('钱七', 32, '男', 2, '市场经理', 18000.00, '2019-11-05');

-- 插入NULL值
INSERT INTO employees (name, age, gender, department_id, position, salary, phone)
VALUES ('孙八', 27, '女', 2, '市场专员', 9000.00, NULL);

-- 插入默认值
INSERT INTO employees (name, age, gender, department_id, position, salary, is_active)
VALUES ('周九', 40, '男', 2, '市场专员', 8500.00, DEFAULT);

-- 验证插入的数据
SELECT * FROM employees;
```

## 5.2 UPDATE语句：更新数据

### 什么是UPDATE语句？

UPDATE语句用于修改数据库表中现有的数据行。通过UPDATE，我们可以更改表中一个或多个记录的一个或多个列的值。

### 基本语法

```sql
-- 更新单个列
UPDATE table_name
SET column1 = value1
WHERE condition;

-- 更新多个列
UPDATE table_name
SET column1 = value1, column2 = value2, ...
WHERE condition;
```

### 更新单个列

```sql
-- 更新单个员工的薪资
UPDATE employees
SET salary = 16000.00
WHERE name = '李四';

-- 更新所有员工的活跃状态
UPDATE employees
SET is_active = TRUE;
```

### 更新多个列

```sql
-- 同时更新多个列
UPDATE employees
SET salary = 14000.00, position = '高级工程师'
WHERE name = '赵六';
```

### 使用条件更新

#### 使用WHERE子句

```sql
-- 更新特定部门的员工薪资
UPDATE employees
SET salary = salary * 1.1
WHERE department_id = 1;

-- 更新特定年龄段的员工
UPDATE employees
SET position = '高级工程师'
WHERE age >= 30 AND position = '工程师';
```

#### 使用子查询

```sql
-- 使用子查询更新数据
UPDATE employees
SET salary = (
    SELECT AVG(salary) * 1.2
    FROM employees
    WHERE department_id = 1
)
WHERE name = '张三';
```

### 使用表达式更新

#### 算术表达式

```sql
-- 给所有员工加薪10%
UPDATE employees
SET salary = salary * 1.1;

-- 给特定部门的员工加薪15%
UPDATE employees
SET salary = salary * 1.15
WHERE department_id = 2;
```

#### 字符串表达式

```sql
-- 更新邮箱格式
UPDATE employees
SET email = CONCAT(LOWER(name), '@company.com')
WHERE email IS NULL;

-- 更新职位名称
UPDATE employees
SET position = CONCAT('高级', position)
WHERE age >= 30 AND position NOT LIKE '%高级%';
```

### 使用CASE语句更新

```sql
-- 根据条件使用不同的更新逻辑
UPDATE employees
SET salary = CASE
    WHEN position LIKE '%经理%' THEN salary * 1.15
    WHEN position LIKE '%工程师%' THEN salary * 1.1
    ELSE salary * 1.05
END;
```

### 实验验证

让我们使用UPDATE语句更新一些数据：

```sql
-- 更新单个员工的薪资
UPDATE employees
SET salary = 16000.00
WHERE name = '李四';

-- 同时更新多个列
UPDATE employees
SET salary = 14000.00, position = '高级工程师'
WHERE name = '赵六';

-- 给技术部（部门ID=1）的员工加薪10%
UPDATE employees
SET salary = salary * 1.1
WHERE department_id = 1;

-- 更新30岁以上的工程师为高级工程师
UPDATE employees
SET position = '高级工程师'
WHERE age >= 30 AND position = '工程师';

-- 根据职位给员工加薪
UPDATE employees
SET salary = CASE
    WHEN position LIKE '%经理%' THEN salary * 1.15
    WHEN position LIKE '%工程师%' THEN salary * 1.1
    ELSE salary * 1.05
END;

-- 验证更新结果
SELECT name, position, salary, department_id FROM employees;
```

## 5.3 DELETE语句：删除数据

### 什么是DELETE语句？

DELETE语句用于从数据库表中删除现有的数据行。通过DELETE，我们可以删除表中的一个或多个记录。

### 基本语法

```sql
-- 删除特定行
DELETE FROM table_name
WHERE condition;

-- 删除所有行（保留表结构）
DELETE FROM table_name;

-- 清空表（更高效，重置自增列）
TRUNCATE TABLE table_name;
```

### 删除特定行

```sql
-- 删除单个员工
DELETE FROM employees
WHERE name = '孙八';

-- 删除特定部门的员工
DELETE FROM employees
WHERE department_id = 3;

-- 删除特定条件的员工
DELETE FROM employees
WHERE age < 25 OR is_active = FALSE;
```

### 删除所有行

```sql
-- 删除所有员工记录（保留表结构）
DELETE FROM employees;

-- 清空员工表（更高效，重置自增列）
TRUNCATE TABLE employees;
```

### 使用子查询删除

```sql
-- 删除薪资低于平均薪资的员工
DELETE FROM employees
WHERE salary < (SELECT AVG(salary) FROM employees);

-- 删除没有部门的员工
DELETE FROM employees
WHERE department_id NOT IN (SELECT id FROM departments);
```

### DELETE vs TRUNCATE

| 特性 | DELETE | TRUNCATE |
|------|--------|----------|
| 速度 | 较慢，逐行删除 | 快速，一次性删除 |
| 事务 | 可以回滚 | 不能回滚 |
| 触发器 | 触发 | 不触发 |
| 自增列 | 不重置 | 重置 |
| WHERE子句 | 支持 | 不支持 |

### 实验验证

让我们使用DELETE语句删除一些数据：

```sql
-- 创建一个临时表用于演示
CREATE TABLE temp_employees AS SELECT * FROM employees;

-- 删除单个员工
DELETE FROM temp_employees
WHERE name = '孙八';

-- 删除特定部门的员工
DELETE FROM temp_employees
WHERE department_id = 3;

-- 删除薪资低于平均薪资的员工
DELETE FROM temp_employees
WHERE salary < (SELECT AVG(salary) FROM temp_employees);

-- 验证删除结果
SELECT * FROM temp_employees;

-- 清空临时表
TRUNCATE TABLE temp_employees;
```

## 5.4 事务处理

### 什么是事务？

事务是一组SQL操作的集合，这些操作要么全部执行成功，要么全部不执行。事务是数据库管理系统执行过程中的基本单位，用于保证数据的一致性和完整性。

### 事务的ACID特性

| 特性 | 描述 |
|------|------|
| 原子性（Atomicity） | 事务中的所有操作要么全部完成，要么全部不完成 |
| 一致性（Consistency） | 事务开始前和结束后，数据库的完整性约束没有被破坏 |
| 隔离性（Isolation） | 多个并发事务之间互不干扰 |
| 持久性（Durability） | 事务一旦提交，其结果就是永久性的 |

### 事务控制语句

| 语句 | 描述 |
|------|------|
| START TRANSACTION 或 BEGIN | 开始一个新事务 |
| COMMIT | 提交事务，使更改永久生效 |
| ROLLBACK | 回滚事务，撤销所有更改 |
| SAVEPOINT | 在事务中设置保存点 |
| ROLLBACK TO SAVEPOINT | 回滚到指定的保存点 |

### 基本事务处理

```sql
-- 开始事务
START TRANSACTION;

-- 执行一系列SQL操作
UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;
UPDATE departments SET budget = budget * 1.1 WHERE id = 1;

-- 提交事务
COMMIT;
```

### 事务回滚

```sql
-- 开始事务
START TRANSACTION;

-- 执行一系列SQL操作
UPDATE employees SET salary = salary * 1.2 WHERE department_id = 1;
UPDATE departments SET budget = budget * 1.2 WHERE id = 1;

-- 如果出现问题，回滚事务
ROLLBACK;
```

### 使用保存点

```sql
-- 开始事务
START TRANSACTION;

-- 第一个操作
UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;

-- 设置保存点
SAVEPOINT point1;

-- 第二个操作
UPDATE employees SET salary = salary * 0.9 WHERE department_id = 2;

-- 如果第二个操作有问题，回滚到保存点
ROLLBACK TO SAVEPOINT point1;

-- 提交事务
COMMIT;
```

### 自动提交模式

在MySQL中，默认情况下处于自动提交模式，每条SQL语句都是一个独立的事务。可以通过以下命令禁用自动提交：

```sql
-- 禁用自动提交
SET autocommit = 0;

-- 启用自动提交
SET autocommit = 1;
```

### 实验验证

让我们使用事务处理一些数据：

```sql
-- 创建一个测试表
CREATE TABLE account (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    balance DECIMAL(10, 2) NOT NULL DEFAULT 0.00
);

-- 插入测试数据
INSERT INTO account (name, balance) VALUES
('张三', 1000.00),
('李四', 2000.00),
('王五', 1500.00);

-- 查看初始状态
SELECT * FROM account;

-- 开始事务
START TRANSACTION;

-- 张三向李四转账500
UPDATE account SET balance = balance - 500 WHERE name = '张三';
UPDATE account SET balance = balance + 500 WHERE name = '李四';

-- 查看事务中的状态
SELECT * FROM account;

-- 提交事务
COMMIT;

-- 查看最终状态
SELECT * FROM account;

-- 开始另一个事务
START TRANSACTION;

-- 王五向张三转账200，但中间出错
UPDATE account SET balance = balance - 200 WHERE name = '王五';
-- 假设这里出现错误
UPDATE account SET balance = balance + 200 WHERE name = '张三';

-- 回滚事务
ROLLBACK;

-- 查看回滚后的状态
SELECT * FROM account;

-- 使用保存点
START TRANSACTION;

-- 张三向李四转账300
UPDATE account SET balance = balance - 300 WHERE name = '张三';
UPDATE account SET balance = balance + 300 WHERE name = '李四';

-- 设置保存点
SAVEPOINT point1;

-- 王五向张三转账100
UPDATE account SET balance = balance - 100 WHERE name = '王五';
UPDATE account SET balance = balance + 100 WHERE name = '张三';

-- 查看当前状态
SELECT * FROM account;

-- 回滚到保存点
ROLLBACK TO SAVEPOINT point1;

-- 查看回滚后的状态
SELECT * FROM account;

-- 提交事务
COMMIT;

-- 查看最终状态
SELECT * FROM account;
```

## 5.5 数据完整性

### 什么是数据完整性？

数据完整性是指数据的准确性、一致性和可靠性。在SQL中，可以通过约束、触发器和事务来保证数据完整性。

### 约束类型

| 约束类型 | 描述 |
|----------|------|
| NOT NULL | 确保列不能有NULL值 |
| UNIQUE | 确保列中的所有值都是唯一的 |
| PRIMARY KEY | 唯一标识表中的每一行 |
| FOREIGN KEY | 维护表之间的引用完整性 |
| CHECK | 确保列中的值满足特定条件 |
| DEFAULT | 为列提供默认值 |

### 使用约束保证数据完整性

```sql
-- 创建带约束的表
CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,  -- NOT NULL约束
    email VARCHAR(100) UNIQUE,  -- UNIQUE约束
    age INT CHECK (age >= 18),  -- CHECK约束
    department_id INT,
    position VARCHAR(50) DEFAULT '员工',  -- DEFAULT约束
    salary DECIMAL(10, 2),
    hire_date DATE,
    FOREIGN KEY (department_id) REFERENCES departments(id)  -- FOREIGN KEY约束
);
```

### 使用事务保证数据完整性

```sql
-- 使用事务确保转账操作的完整性
START TRANSACTION;

-- 扣除转账方金额
UPDATE account SET balance = balance - 500 WHERE name = '张三';

-- 确保转账方余额足够
IF (SELECT balance FROM account WHERE name = '张三') >= 0 THEN
    -- 增加收款方金额
    UPDATE account SET balance = balance + 500 WHERE name = '李四';
    COMMIT;
ELSE
    -- 余额不足，回滚
    ROLLBACK;
END IF;
```

### 实验验证

让我们验证数据完整性：

```sql
-- 创建带约束的表
CREATE TABLE products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10, 2) CHECK (price > 0),
    stock INT CHECK (stock >= 0),
    category_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- 创建分类表
CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE
);

-- 插入分类数据
INSERT INTO categories (name) VALUES
('电子产品'),
('服装'),
('食品');

-- 尝试插入违反NOT NULL约束的数据（会失败）
INSERT INTO products (price, stock, category_id) VALUES (100.00, 10, 1);

-- 尝试插入违反CHECK约束的数据（会失败）
INSERT INTO products (name, price, stock, category_id) VALUES ('测试产品', -10.00, 10, 1);

-- 插入有效数据
INSERT INTO products (name, price, stock, category_id) VALUES ('手机', 2999.00, 50, 1);
INSERT INTO products (name, price, stock, category_id) VALUES ('T恤', 99.00, 100, 2);

-- 验证数据
SELECT * FROM products;
```

## 5.6 本章小结

本章介绍了SQL的数据操作，包括：

1. **INSERT语句**：向表中插入新数据
2. **UPDATE语句**：更新表中现有数据
3. **DELETE语句**：删除表中数据
4. **事务处理**：确保数据操作的原子性和一致性
5. **数据完整性**：通过约束和事务保证数据的准确性和一致性

通过本章的学习，您应该能够：

- 使用INSERT语句向表中插入数据
- 使用UPDATE语句更新表中的数据
- 使用DELETE语句删除表中的数据
- 使用事务处理确保数据操作的完整性
- 使用约束保证数据的完整性和一致性

## 5.7 思考题

1. INSERT语句中，如果省略列名，需要注意什么？
2. UPDATE语句中，如果不使用WHERE子句，会发生什么？
3. DELETE和TRUNCATE有什么区别？在什么情况下使用TRUNCATE？
4. 什么是事务的ACID特性？每个特性有什么意义？
5. 在什么情况下应该使用事务？如何正确使用事务？

## 5.8 下章预告

在第6章中，我们将学习SQL的连接与子查询，包括：

- 内连接（INNER JOIN）
- 外连接（LEFT/RIGHT/FULL JOIN）
- 自连接（SELF JOIN）
- 子查询的类型和使用场景
- 相关子查询和非相关子查询

---

*继续学习，掌握SQL连接与子查询的技巧！*