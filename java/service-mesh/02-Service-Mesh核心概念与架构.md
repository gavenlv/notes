# 02-Service-Meshæ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„

## ğŸ“š æœ¬ç« æ¦‚è¿°

æœ¬ç« æ·±å…¥è§£æ Service Mesh çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ç»„æˆä»¥åŠä¸»æµäº§å“çš„è®¾è®¡ç†å¿µï¼Œä¸ºåç»­çš„å®è·µåº”ç”¨æ‰“ä¸‹ç†è®ºåŸºç¡€ã€‚

## ğŸ” Service Mesh å®šä¹‰ä¸æ ¸å¿ƒæ¦‚å¿µ

### 2.1 Service Mesh çš„å®šä¹‰

#### 2.1.1 å®˜æ–¹å®šä¹‰
```
Service Mesh æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚å®ƒè´Ÿè´£åœ¨ç°ä»£äº‘åŸç”Ÿåº”ç”¨ä¸­ï¼Œå¯é åœ°ä¼ é€’è¯·æ±‚ã€‚å®é™…ä¸Šï¼ŒService Mesh é€šå¸¸é€šè¿‡ä¸€ç»„è½»é‡çº§ç½‘ç»œä»£ç†æ¥å®ç°ï¼Œè¿™äº›ä»£ç†ä¸åº”ç”¨ç¨‹åºä»£ç ä¸€èµ·éƒ¨ç½²ï¼Œè€Œä¸éœ€è¦æ„ŸçŸ¥åº”ç”¨ç¨‹åºæœ¬èº«ã€‚
```

#### 2.1.2 æ ¸å¿ƒç‰¹å¾
- **é€æ˜ä»£ç†**: åº”ç”¨æ— éœ€ä¿®æ”¹ä»£ç å³å¯è·å¾—æœåŠ¡æ²»ç†èƒ½åŠ›
- **åŸºç¡€è®¾æ–½å±‚**: ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘çš„æœåŠ¡é€šä¿¡åŸºç¡€è®¾æ–½
- **å¯è§‚æµ‹æ€§**: æä¾›å…¨é¢çš„ç›‘æ§ã€è¿½è¸ªå’Œæ—¥å¿—èƒ½åŠ›
- **ç­–ç•¥é©±åŠ¨**: é€šè¿‡å£°æ˜å¼é…ç½®å®ç°æœåŠ¡æ²»ç†ç­–ç•¥

### 2.2 æ ¸å¿ƒæ¶æ„æ¨¡å¼

#### 2.2.1 Sidecar æ¨¡å¼
```yaml
# Kubernetes Sidecar éƒ¨ç½²ç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: user-service
spec:
  containers:
  - name: user-service    # ä¸šåŠ¡å®¹å™¨
    image: user-service:1.0
    ports:
    - containerPort: 8080
    
  - name: istio-proxy     # Sidecar ä»£ç†å®¹å™¨
    image: envoyproxy/envoy:v1.20
    # Envoy é…ç½®...
```

**Sidecar æ¨¡å¼ä¼˜åŠ¿ï¼š**
- **è¯­è¨€æ— å…³**: æ”¯æŒä»»æ„ç¼–ç¨‹è¯­è¨€çš„æœåŠ¡
- **é€æ˜å‡çº§**: ä»£ç†å¯ä»¥ç‹¬ç«‹äºåº”ç”¨è¿›è¡Œå‡çº§
- **èµ„æºéš”ç¦»**: ä»£ç†æ•…éšœä¸ä¼šå½±å“ä¸šåŠ¡å®¹å™¨
- **æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„é€šä¿¡åè®®å’Œæ²»ç†ç­–ç•¥

#### 2.2.2 æ•°æ®å¹³é¢ä¸æ§åˆ¶å¹³é¢åˆ†ç¦»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ§åˆ¶å¹³é¢       â”‚    â”‚    æ•°æ®å¹³é¢     â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ æœåŠ¡å‘ç°      â”‚â—„â”€â”€â–ºâ”‚ â€¢ Sidecar ä»£ç†  â”‚
â”‚ â€¢ é…ç½®ç®¡ç†      â”‚    â”‚ â€¢ æµé‡è·¯ç”±      â”‚
â”‚ â€¢ ç­–ç•¥æ‰§è¡Œ      â”‚    â”‚ â€¢ å®‰å…¨é€šä¿¡      â”‚
â”‚ â€¢ é¥æµ‹æ”¶é›†      â”‚    â”‚ â€¢ å¯è§‚æµ‹æ€§      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†ç¦»æ¶æ„ä¼˜åŠ¿ï¼š**
- **å…³æ³¨ç‚¹åˆ†ç¦»**: æ§åˆ¶é€»è¾‘ä¸æ•°æ®è½¬å‘è§£è€¦
- **å¯æ‰©å±•æ€§**: å¯ä»¥ç‹¬ç«‹æ‰©å±•æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢
- **é«˜å¯ç”¨æ€§**: æ§åˆ¶å¹³é¢æ•…éšœä¸å½±å“ç°æœ‰æµé‡
- **çµæ´»æ€§**: å¯ä»¥æ··åˆä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢

## ğŸ—ï¸ Service Mesh æ¶æ„è¯¦è§£

### 3.1 æ•°æ®å¹³é¢ (Data Plane)

#### 3.1.1 ä»£ç†æ ¸å¿ƒåŠŸèƒ½
```yaml
# Envoy é…ç½®ç¤ºä¾‹ - ç›‘å¬å™¨å’Œé›†ç¾¤
static_resources:
  listeners:
  - name: listener_0
    address:
      socket_address: { address: 0.0.0.0, port_value: 10000 }
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route: { cluster: some_service }
  
  clusters:
  - name: some_service
    connect_timeout: 0.25s
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: some_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: { address: 127.0.0.1, port_value: 8080 }
```

**æ•°æ®å¹³é¢æ ¸å¿ƒç»„ä»¶ï¼š**
- **ä»£ç† (Proxy)**: å¤„ç†æ‰€æœ‰è¿›å‡ºçš„ç½‘ç»œæµé‡
- **ç›‘å¬å™¨ (Listener)**: ç›‘å¬ç‰¹å®šç«¯å£çš„ç½‘ç»œè¿æ¥
- **è¿‡æ»¤å™¨ (Filter)**: å¤„ç†è¯·æ±‚å’Œå“åº”çš„ä¸­é—´ä»¶é“¾
- **é›†ç¾¤ (Cluster)**: åç«¯æœåŠ¡çš„é€»è¾‘åˆ†ç»„
- **ç«¯ç‚¹ (Endpoint)**: å…·ä½“çš„æœåŠ¡å®ä¾‹åœ°å€

#### 3.1.2 æµé‡ç®¡ç†åŠŸèƒ½
```yaml
# æµé‡è·¯ç”±é…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
```

**æµé‡ç®¡ç†èƒ½åŠ›ï¼š**
- **æœåŠ¡å‘ç°**: è‡ªåŠ¨å‘ç°å’Œæ³¨å†ŒæœåŠ¡å®ä¾‹
- **è´Ÿè½½å‡è¡¡**: å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•æ”¯æŒ
- **æ•…éšœæ¢å¤**: è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­æœºåˆ¶
- **æµé‡æ‹†åˆ†**: é‡‘ä¸é›€å‘å¸ƒã€A/Bæµ‹è¯•æ”¯æŒ

### 3.2 æ§åˆ¶å¹³é¢ (Control Plane)

#### 3.2.1 é…ç½®ç®¡ç†
```yaml
# Istio Pilot é…ç½®ç¤ºä¾‹
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    loadBalancer:
      simple: RANDOM
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
```

**æ§åˆ¶å¹³é¢æ ¸å¿ƒç»„ä»¶ï¼š**
- **Pilot**: æœåŠ¡å‘ç°å’Œæµé‡ç®¡ç†
- **Galley**: é…ç½®éªŒè¯å’Œåˆ†å‘
- **Citadel**: å®‰å…¨è¯ä¹¦ç®¡ç†
- **Mixer**: ç­–ç•¥æ£€æŸ¥å’Œé¥æµ‹æ•°æ®æ”¶é›†

#### 3.2.2 æœåŠ¡å‘ç°æœºåˆ¶
```go
// æœåŠ¡å‘ç°æ¥å£ç¤ºä¾‹
type ServiceDiscovery interface {
    // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
    GetInstances(serviceName string) ([]*ServiceInstance, error)
    
    // è®¢é˜…æœåŠ¡å˜åŒ–
    Subscribe(serviceName string, listener ServiceListener)
    
    // è·å–æ‰€æœ‰æœåŠ¡
    GetServices() ([]*Service, error)
}

type ServiceInstance struct {
    ID       string            // å®ä¾‹ID
    Address  string            // å®ä¾‹åœ°å€
    Port     int               // å®ä¾‹ç«¯å£
    Metadata map[string]string // å…ƒæ•°æ®
    Weight   int               // æƒé‡
}
```

**æœåŠ¡å‘ç°æµç¨‹ï¼š**
1. **æœåŠ¡æ³¨å†Œ**: æœåŠ¡å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ
2. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æœåŠ¡å®ä¾‹å¥åº·çŠ¶æ€
3. **é…ç½®åˆ†å‘**: å°†æœåŠ¡ä¿¡æ¯æ¨é€ç»™æ‰€æœ‰ä»£ç†
4. **è´Ÿè½½å‡è¡¡**: ä»£ç†æ ¹æ®æœåŠ¡å®ä¾‹ä¿¡æ¯è¿›è¡Œè´Ÿè½½å‡è¡¡

## ğŸ”„ ä¸»æµ Service Mesh äº§å“å¯¹æ¯”

### 4.1 Istio æ¶æ„è§£æ

#### 4.1.1 Istio ç»„ä»¶æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ§åˆ¶å¹³é¢ (Control Plane)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Pilot  â”‚  Galley  â”‚  Citadel  â”‚  Mixer  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ•°æ®å¹³é¢ (Data Plane)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Envoy Proxy                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Istio æ ¸å¿ƒç»„ä»¶ï¼š**
- **Pilot**: æœåŠ¡å‘ç°ã€æµé‡ç®¡ç†ã€æ™ºèƒ½è·¯ç”±
- **Galley**: é…ç½®éªŒè¯ã€è½¬æ¢å’Œåˆ†å‘
- **Citadel**: æœåŠ¡é—´è®¤è¯å’Œè¯ä¹¦ç®¡ç†
- **Mixer**: ç­–ç•¥æ‰§è¡Œå’Œé¥æµ‹æ•°æ®æ”¶é›†

#### 4.1.2 Istio ç‰¹æ€§ä¼˜åŠ¿
```yaml
# Istio æµé‡ç®¡ç†ç‰¹æ€§ç¤ºä¾‹
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        prefix: /reviews
    route:
    - destination:
        host: reviews
        subset: v2
      weight: 25
    - destination:
        host: reviews
        subset: v3
      weight: 75
```

**Istio ä¼˜åŠ¿ï¼š**
- **åŠŸèƒ½ä¸°å¯Œ**: æµé‡ç®¡ç†ã€å®‰å…¨ã€å¯è§‚æµ‹æ€§å…¨æ–¹ä½è¦†ç›–
- **ç”Ÿæ€å®Œå–„**: ä¸ Kubernetes æ·±åº¦é›†æˆ
- **ç¤¾åŒºæ´»è·ƒ**: å¤§å‹å¼€æºç¤¾åŒºæ”¯æŒ
- **ä¼ä¸šçº§ç‰¹æ€§**: å¤šé›†ç¾¤ã€å¤šç§Ÿæˆ·æ”¯æŒ

### 4.2 Linkerd æ¶æ„è§£æ

#### 4.2.1 Linkerd è½»é‡çº§è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ§åˆ¶å¹³é¢ (Control Plane)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Destination  â”‚   Identity  â”‚   Tap     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ•°æ®å¹³é¢ (Data Plane)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Linkerd2-proxy                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Linkerd æ ¸å¿ƒç»„ä»¶ï¼š**
- **Destination**: æœåŠ¡å‘ç°å’Œæµé‡ç­–ç•¥
- **Identity**: åŸºäº TLS çš„ç›¸äº’è®¤è¯
- **Tap**: å®æ—¶æµé‡è§‚å¯Ÿå’Œè°ƒè¯•
- **Linkerd2-proxy**: åŸºäº Rust çš„é«˜æ€§èƒ½ä»£ç†

#### 4.2.2 Linkerd æ€§èƒ½ä¼˜åŠ¿
```bash
# Linkerd æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”
# å†…å­˜å ç”¨æ¯”è¾ƒ
Istio (Envoy): ~40MB per proxy
Linkerd2: ~10MB per proxy

# å»¶è¿Ÿå¢åŠ æ¯”è¾ƒ
Istio: ~2-5ms additional latency
Linkerd2: ~1-2ms additional latency

# CPU ä½¿ç”¨æ¯”è¾ƒ
Istio: ä¸­ç­‰CPUä½¿ç”¨
Linkerd2: ä½CPUä½¿ç”¨
```

**Linkerd ä¼˜åŠ¿ï¼š**
- **æ€§èƒ½ä¼˜å¼‚**: èµ„æºæ¶ˆè€—ä½ï¼Œå»¶è¿Ÿå¢åŠ å°
- **ç®€å•æ˜“ç”¨**: å®‰è£…é…ç½®ç®€å•ï¼Œå­¦ä¹ æ›²çº¿å¹³ç¼“
- **å®‰å…¨æ€§å¼º**: é»˜è®¤å¯ç”¨ mTLSï¼Œé›¶ä¿¡ä»»å®‰å…¨
- **å¯è§‚æµ‹æ€§å¥½**: å†…ç½®ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡

### 4.3 Consul Service Mesh

#### 4.3.1 Consul é›†æˆæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Consul æ§åˆ¶å¹³é¢                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœåŠ¡å‘ç°  â”‚  é…ç½®ç®¡ç†  â”‚  ç½‘ç»œç®¡ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ•°æ®å¹³é¢                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Consul Connect + Envoy           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Consul Service Mesh ç‰¹æ€§ï¼š**
- **æœåŠ¡ç½‘æ ¼é›†æˆ**: ä¸ Consul æœåŠ¡å‘ç°æ·±åº¦é›†æˆ
- **å¤šæ•°æ®ä¸­å¿ƒ**: åŸç”Ÿæ”¯æŒå¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²
- **ç½‘ç»œæ‹“æ‰‘**: å¯è§†åŒ–æœåŠ¡é—´ä¾èµ–å…³ç³»
- **ç­–ç•¥ç®¡ç†**: åŸºäº intentions çš„è®¿é—®æ§åˆ¶

#### 4.3.2 Consul é€‚ç”¨åœºæ™¯
```hcl
# Consul æœåŠ¡æ³¨å†Œé…ç½®
service {
  name = "web"
  port = 8080
  
  connect {
    sidecar_service {}
  }
  
  check {
    id       = "web-check"
    http     = "http://localhost:8080/health"
    interval = "10s"
    timeout  = "1s"
  }
}
```

**Consul ä¼˜åŠ¿ï¼š**
- **ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ**: æœåŠ¡å‘ç° + æœåŠ¡ç½‘æ ¼
- **å¤šäº‘æ”¯æŒ**: æ”¯æŒæ··åˆäº‘å’Œå¤šäº‘ç¯å¢ƒ
- **æˆç†Ÿç¨³å®š**: ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒéªŒè¯
- **çµæ´»éƒ¨ç½²**: æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼

## ğŸ”§ Service Mesh æ ¸å¿ƒåŠŸèƒ½

### 5.1 æµé‡ç®¡ç†åŠŸèƒ½

#### 5.1.1 æ™ºèƒ½è·¯ç”±
```yaml
# åŸºäºæƒé‡çš„æµé‡æ‹†åˆ†
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v2
      weight: 25
    - destination:
        host: reviews
        subset: v3
      weight: 25
```

**è·¯ç”±ç­–ç•¥ç±»å‹ï¼š**
- **åŸºäºæƒé‡**: æŒ‰æ¯”ä¾‹åˆ†é…æµé‡
- **åŸºäºå†…å®¹**: æ ¹æ®è¯·æ±‚å¤´ã€å‚æ•°ç­‰è·¯ç”±
- **åŸºäºæ•…éšœ**: æ ¹æ®æœåŠ¡å¥åº·çŠ¶æ€è·¯ç”±
- **åŸºäºåœ°ç†ä½ç½®**: æ ¹æ®ç”¨æˆ·ä½ç½®è·¯ç”±

#### 5.1.2 æ•…éšœæ¢å¤
```yaml
# è¶…æ—¶å’Œé‡è¯•é…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - route:
    - destination:
        host: ratings
        subset: v1
    retries:
      attempts: 3
      perTryTimeout: 2s
    timeout: 10s
```

**æ•…éšœæ¢å¤æœºåˆ¶ï¼š**
- **è¶…æ—¶æ§åˆ¶**: é˜²æ­¢è¯·æ±‚æ— é™ç­‰å¾…
- **é‡è¯•ç­–ç•¥**: è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
- **ç†”æ–­å™¨**: é˜²æ­¢æ•…éšœä¼ æ’­
- **æ•…éšœæ³¨å…¥**: æµ‹è¯•ç³»ç»Ÿå®¹é”™èƒ½åŠ›

### 5.2 å®‰å…¨åŠŸèƒ½

#### 5.2.1 æœåŠ¡é—´è®¤è¯
```yaml
# mTLS é…ç½®ç¤ºä¾‹
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
```

**å®‰å…¨ç‰¹æ€§ï¼š**
- **åŒå‘ TLS**: æœåŠ¡é—´é€šä¿¡åŠ å¯†å’Œè®¤è¯
- **èº«ä»½è®¤è¯**: åŸºäº SPIFFE æ ‡å‡†çš„èº«ä»½ç®¡ç†
- **è®¿é—®æ§åˆ¶**: ç»†ç²’åº¦çš„æœåŠ¡è®¿é—®æƒé™
- **è¯ä¹¦ç®¡ç†**: è‡ªåŠ¨åŒ–çš„è¯ä¹¦é¢å‘å’Œè½®æ¢

#### 5.2.2 ç­–ç•¥æ‰§è¡Œ
```yaml
# è®¿é—®æ§åˆ¶ç­–ç•¥
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: httpbin
  namespace: default
spec:
  selector:
    matchLabels:
      app: httpbin
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/sleep"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/info*"]
```

**ç­–ç•¥ç±»å‹ï¼š**
- **ç™½åå•ç­–ç•¥**: åªå…è®¸ç‰¹å®šæœåŠ¡è®¿é—®
- **é»‘åå•ç­–ç•¥**: ç¦æ­¢ç‰¹å®šæœåŠ¡è®¿é—®
- **åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**: æŒ‰è§’è‰²åˆ†é…æƒé™
- **åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶**: æŒ‰å±æ€§åŠ¨æ€æˆæƒ

### 5.3 å¯è§‚æµ‹æ€§åŠŸèƒ½

#### 5.3.1 æŒ‡æ ‡æ”¶é›†
```yaml
# è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®
apiVersion: config.istio.io/v1alpha2
kind: metric
metadata:
  name: requestcount
  namespace: istio-system
spec:
  value: "1"
  dimensions:
    source: source.workload.name | "unknown"
    destination: destination.workload.name | "unknown"
    response_code: response.code | 200
  monitored_resource_type: "UNSPECIFIED"
```

**å¯è§‚æµ‹æ€§ç»´åº¦ï¼š**
- **æµé‡æŒ‡æ ‡**: è¯·æ±‚æ•°ã€æˆåŠŸç‡ã€å»¶è¿Ÿç­‰
- **èµ„æºæŒ‡æ ‡**: CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ
- **ä¸šåŠ¡æŒ‡æ ‡**: è‡ªå®šä¹‰çš„ä¸šåŠ¡ç›¸å…³æŒ‡æ ‡
- **é»„é‡‘ä¿¡å·**: å»¶è¿Ÿã€æµé‡ã€é”™è¯¯ã€é¥±å’Œåº¦

#### 5.3.2 åˆ†å¸ƒå¼è¿½è¸ª
```java
// Java åº”ç”¨è¿½è¸ªé›†æˆ
@RestController
public class OrderController {
    
    private final Tracer tracer;
    
    @GetMapping("/orders/{id}")
    public Order getOrder(@PathVariable String id) {
        // åˆ›å»ºè¿½è¸ª span
        Span span = tracer.buildSpan("getOrder")
            .withTag("order.id", id)
            .start();
        
        try (Scope scope = tracer.activateSpan(span)) {
            // ä¸šåŠ¡é€»è¾‘
            Order order = orderService.findById(id);
            span.log("Order retrieved successfully");
            return order;
        } finally {
            span.finish();
        }
    }
}
```

**è¿½è¸ªèƒ½åŠ›ï¼š**
- **ç«¯åˆ°ç«¯è¿½è¸ª**: è·¨æœåŠ¡è°ƒç”¨é“¾è¿½è¸ª
- **æ€§èƒ½åˆ†æ**: è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
- **é”™è¯¯è¯Šæ–­**: å¿«é€Ÿå®šä½æ•…éšœåŸå› 
- **ä¾èµ–åˆ†æ**: å¯è§†åŒ–æœåŠ¡ä¾èµ–å…³ç³»

## ğŸš€ Service Mesh éƒ¨ç½²æ¨¡å¼

### 6.1 å•é›†ç¾¤éƒ¨ç½²

#### 6.1.1 å‘½åç©ºé—´éš”ç¦»
```yaml
# å‘½åç©ºé—´çº§åˆ«çš„ Sidecar æ³¨å…¥
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    istio-injection: enabled
```

**å•é›†ç¾¤éƒ¨ç½²ç­–ç•¥ï¼š**
- **å…¨é›†ç¾¤éƒ¨ç½²**: æ‰€æœ‰å‘½åç©ºé—´å¯ç”¨ Service Mesh
- **é€‰æ‹©æ€§éƒ¨ç½²**: åªåœ¨ç‰¹å®šå‘½åç©ºé—´å¯ç”¨
- **æ¸è¿›å¼éƒ¨ç½²**: é€æ­¥è¿ç§»æœåŠ¡åˆ° Service Mesh

#### 6.1.2 èµ„æºè§„åˆ’
```yaml
# Istio èµ„æºè¯·æ±‚é…ç½®
apiVersion: v1
kind: Deployment
metadata:
  name: istiod
spec:
  template:
    spec:
      containers:
      - name: discovery
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
```

**èµ„æºè€ƒè™‘å› ç´ ï¼š**
- **æ§åˆ¶å¹³é¢èµ„æº**: Pilotã€Citadel ç­‰ç»„ä»¶çš„èµ„æºéœ€æ±‚
- **æ•°æ®å¹³é¢èµ„æº**: Sidecar ä»£ç†çš„å†…å­˜å’Œ CPU æ¶ˆè€—
- **ç½‘ç»œå¼€é”€**: åŠ å¯†å’Œä»£ç†å¸¦æ¥çš„é¢å¤–ç½‘ç»œå»¶è¿Ÿ
- **å­˜å‚¨éœ€æ±‚**: é…ç½®å’Œè¯ä¹¦çš„å­˜å‚¨éœ€æ±‚

### 6.2 å¤šé›†ç¾¤éƒ¨ç½²

#### 6.2.1 å¤šé›†ç¾¤æ¶æ„
```yaml
# å¤šé›†ç¾¤æœåŠ¡å‘ç°é…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc
spec:
  hosts:
  - external-service.example.com
  location: MESH_EXTERNAL
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS
```

**å¤šé›†ç¾¤éƒ¨ç½²æ¨¡å¼ï¼š**
- **æ‰å¹³ç½‘ç»œ**: æ‰€æœ‰é›†ç¾¤åœ¨åŒä¸€ç½‘ç»œå¹³é¢
- **ç½‘å…³è¿æ¥**: é€šè¿‡ç½‘å…³è¿æ¥ä¸åŒé›†ç¾¤
- **è”é‚¦æ¨¡å¼**: æ§åˆ¶å¹³é¢è”é‚¦ï¼Œç»Ÿä¸€ç®¡ç†

#### 6.2.2 è·¨é›†ç¾¤é€šä¿¡
```yaml
# è·¨é›†ç¾¤æµé‡é…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: cross-cluster-dr
spec:
  host: my-service.global
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    loadBalancer:
      simple: ROUND_ROBIN
```

**è·¨é›†ç¾¤æŒ‘æˆ˜ï¼š**
- **ç½‘ç»œè¿é€šæ€§**: ç¡®ä¿é›†ç¾¤é—´ç½‘ç»œå¯è¾¾
- **æœåŠ¡å‘ç°**: è·¨é›†ç¾¤çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°
- **å®‰å…¨é€šä¿¡**: è·¨é›†ç¾¤çš„ mTLS è®¤è¯
- **é…ç½®åŒæ­¥**: å¤šé›†ç¾¤çš„é…ç½®ä¸€è‡´æ€§

## ğŸ“Š æ€»ç»“ä¸å±•æœ›

### 7.1 æœ¬ç« è¦ç‚¹å›é¡¾

1. **æ ¸å¿ƒæ¦‚å¿µ**: Service Mesh çš„å®šä¹‰ã€Sidecar æ¨¡å¼ã€æ§åˆ¶å¹³é¢ä¸æ•°æ®å¹³é¢åˆ†ç¦»
2. **æ¶æ„è¯¦è§£**: æ•°æ®å¹³é¢ä»£ç†åŠŸèƒ½ã€æ§åˆ¶å¹³é¢é…ç½®ç®¡ç†
3. **äº§å“å¯¹æ¯”**: Istioã€Linkerdã€Consul çš„æ¶æ„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯
4. **æ ¸å¿ƒåŠŸèƒ½**: æµé‡ç®¡ç†ã€å®‰å…¨ã€å¯è§‚æµ‹æ€§çš„è¯¦ç»†å®ç°
5. **éƒ¨ç½²æ¨¡å¼**: å•é›†ç¾¤å’Œå¤šé›†ç¾¤çš„éƒ¨ç½²ç­–ç•¥

### 7.2 æŠ€æœ¯é€‰å‹å»ºè®®

#### 7.2.1 é€‰å‹è€ƒè™‘å› ç´ 
```
æŠ€æœ¯é€‰å‹ checklistï¼š
âœ… å›¢é˜ŸæŠ€æœ¯æ ˆå’Œç†Ÿæ‚‰åº¦
âœ… æ€§èƒ½å’Œèµ„æºè¦æ±‚
âœ… åŠŸèƒ½éœ€æ±‚å®Œæ•´æ€§
âœ… ç¤¾åŒºæ”¯æŒå’Œç”Ÿæ€
âœ… ç”Ÿäº§ç¯å¢ƒæˆç†Ÿåº¦
âœ… è¿ç»´å¤æ‚åº¦å’Œæˆæœ¬
```

#### 7.2.2 æ¨èåœºæ™¯
- **Istio**: åŠŸèƒ½éœ€æ±‚å…¨é¢ï¼Œä¼ä¸šçº§åœºæ™¯
- **Linkerd**: æ€§èƒ½è¦æ±‚é«˜ï¼Œèµ„æºå—é™ç¯å¢ƒ
- **Consul**: å·²æœ‰ Consul åŸºç¡€è®¾æ–½ï¼Œå¤šäº‘ç¯å¢ƒ

### 7.3 ä¸‹ä¸€ç« é¢„å‘Š

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å®è·µ Istio çš„å®‰è£…ä¸éƒ¨ç½²ï¼š
- Istio ç¯å¢ƒå‡†å¤‡å’Œç³»ç»Ÿè¦æ±‚
- å¤šç§å®‰è£…æ–¹å¼è¯¦è§£ï¼ˆistioctlã€Helmã€Operatorï¼‰
- éªŒè¯å®‰è£…å’ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
- å¸¸è§é—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–

---

**ç»§ç»­å­¦ä¹ **: [03-ä¸»æµService-Meshäº§å“å¯¹æ¯”](03-ä¸»æµService-Meshäº§å“å¯¹æ¯”.md)

---

*æœ¬ç« å†…å®¹å¸®åŠ©æ‚¨æ·±å…¥ç†è§£ Service Mesh çš„æ ¸å¿ƒæ¶æ„å’ŒåŠŸèƒ½ç‰¹æ€§ã€‚å»ºè®®ç»“åˆå®˜æ–¹æ–‡æ¡£å’Œå®è·µé¡¹ç›®è¿›è¡Œæ·±å…¥å­¦ä¹ ã€‚*