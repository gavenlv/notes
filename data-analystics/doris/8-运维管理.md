# 第8章 Doris运维管理

## 学习目标

- 掌握Doris集群的日常运维管理方法
- 学会Doris集群的监控和故障诊断
- 了解Doris集群的扩容和缩容操作
- 掌握Doris数据备份和恢复方法
- 学会Doris集群的升级和维护

## 1. 集群管理概述

### 1.1 集群架构

Doris集群主要由以下组件组成：

1. **Frontend (FE)**：负责元数据管理、查询解析和调度
2. **Backend (BE)**：负责数据存储和计算
3. **Broker**：负责读写外部数据源（如HDFS、S3等）

### 1.2 集群角色

Doris集群中的角色划分：

1. **Follower FE**：参与元数据选举和同步，通常为奇数个（3/5/7）
2. **Observer FE**：只同步元数据，不参与选举，用于扩展读能力
3. **BE节点**：数据存储和计算节点

### 1.3 集群状态

Doris集群的常见状态：

1. **ALIVE**：节点正常运行
2. **DECOMMISSION**：节点正在下线
3. **OFFLINE**：节点离线
4. **UNAVAILABLE**：节点不可用

## 2. 集群监控

### 2.1 集群状态监控

监控集群整体状态：

```sql
-- 查看FE节点状态
SHOW FRONTENDS;

-- 查看BE节点状态
SHOW BACKENDS;

-- 查看集群状态
SHOW PROC '/cluster_health';

-- 查看集群信息
SHOW PROC '/clusters';
```

### 2.2 节点状态监控

监控FE和BE节点状态：

```sql
-- 查看FE节点详细信息
SELECT 
    name,
    host,
    port,
    query_port,
    http_port,
    rpc_port,
    role,
    is_master,
    join,
    alive,
    repl_num,
    last_heartbeat,
    err_msg
FROM information_schema.frontends;

-- 查看BE节点详细信息
SELECT 
    backend_id,
    host,
    heartbeat_port,
    be_port,
    http_port,
    brpc_port,
    alive,
    disk_used,
    disk_total,
    mem_used,
    mem_total,
    cpu_used,
    num_running_queries,
    num_fragments,
    max_compaction_score,
    tablet_num,
    data_size,
    trash_used,
    last_heartbeat,
    last_update_time,
    err_msg
FROM information_schema.backends;
```

### 2.3 资源使用监控

监控集群资源使用情况：

```sql
-- 查看磁盘使用情况
SELECT 
    backend_id,
    host,
    path,
    disk_total,
    disk_used,
    disk_available,
    disk_used_percent,
    is_used
FROM information_schema.disk;

-- 查看内存使用情况
SELECT 
    backend_id,
    host,
    mem_total,
    mem_used,
    mem_available,
    mem_used_percent
FROM information_schema.memory;

-- 查看CPU使用情况
SELECT 
    backend_id,
    host,
    cpu_used_percent
FROM information_schema.cpu;
```

### 2.4 查询状态监控

监控查询执行情况：

```sql
-- 查看当前运行查询
SHOW PROCESSLIST;

-- 查看查询统计信息
SHOW QUERY_STATS;

-- 查看慢查询
SHOW SLOW_QUERIES;

-- 查看查询历史
SELECT 
    query_id,
    user,
    db,
    query_time,
    scan_bytes,
    scan_rows,
    cpu_time_ms,
    mem_usage_bytes,
    return_rows,
    stmt
FROM information_schema.query_log 
WHERE query_time > 1000  -- 查询时间大于1秒
ORDER BY query_time DESC
LIMIT 10;
```

## 3. 故障诊断与处理

### 3.1 FE节点故障

**常见FE节点故障及处理方法：**

1. **FE节点离线**
   ```sql
   -- 检查FE节点状态
   SHOW FRONTENDS;
   
   -- 查看FE日志
   -- 在FE节点上执行
   tail -f /opt/doris/fe/log/fe.log
   
   -- 重启FE节点
   -- 在FE节点上执行
   /opt/doris/fe/bin/stop_fe.sh
   /opt/doris/fe/bin/start_fe.sh --daemon
   ```

2. **FE元数据损坏**
   ```bash
   # 备份当前元数据
   cp -r /opt/doris/fe/doris-meta /opt/doris/fe/doris-meta.backup
   
   # 恢复元数据
   cp -r /opt/doris/fe/doris-meta.backup /opt/doris/fe/doris-meta
   
   # 重启FE节点
   /opt/doris/fe/bin/stop_fe.sh
   /opt/doris/fe/bin/start_fe.sh --daemon
   ```

3. **FE节点选举失败**
   ```bash
   # 检查网络连通性
   ping <other_fe_host>
   
   # 检查端口占用
   netstat -an | grep <fe_port>
   
   # 检查FE配置
   cat /opt/doris/fe/conf/fe.conf | grep priority_networks
   ```

### 3.2 BE节点故障

**常见BE节点故障及处理方法：**

1. **BE节点离线**
   ```sql
   -- 检查BE节点状态
   SHOW BACKENDS;
   
   -- 查看BE日志
   -- 在BE节点上执行
   tail -f /opt/doris/be/log/be.INFO
   
   -- 重启BE节点
   -- 在BE节点上执行
   /opt/doris/be/bin/stop_be.sh
   /opt/doris/be/bin/start_be.sh --daemon
   ```

2. **BE磁盘故障**
   ```sql
   -- 查看磁盘状态
   SHOW PROC '/backends';
   
   -- 标记磁盘损坏
   ALTER SYSTEM DROP DISK 'be_host:disk_path';
   
   -- 添加新磁盘
   ALTER SYSTEM ADD DISK 'be_host:new_disk_path';
   ```

3. **BE数据损坏**
   ```sql
   -- 查看tablet状态
   SHOW TABLETS FROM table_name;
   
   -- 修复tablet
   ADMIN REPAIR TABLE table_name PARTITION (partition_name);
   
   -- 强制恢复tablet
   ADMIN RECOVER TABLE table_name PARTITION (partition_name);
   ```

### 3.3 数据一致性问题

**数据一致性问题的处理方法：**

1. **副本不一致**
   ```sql
   -- 查看tablet副本状态
   SHOW TABLET table_name;
   
   -- 修复不一致的副本
   ADMIN REPAIR TABLE table_name PARTITION (partition_name);
   
   -- 重建副本
   ADMIN REPAIR TABLE table_name PARTITION (partition_name) REPLICA_NUM = 3;
   ```

2. **数据丢失**
   ```sql
   -- 查看tablet状态
   SHOW TABLETS FROM table_name;
   
   -- 恢复数据
   ADMIN RECOVER TABLE table_name PARTITION (partition_name);
   
   -- 从备份恢复
   RESTORE TABLE table_name FROM backup_path;
   ```

## 4. 集群扩容与缩容

### 4.1 集群扩容

#### 4.1.1 FE节点扩容

```bash
# 1. 在新FE节点上安装Doris FE
# 2. 修改FE配置文件
vi /opt/doris/fe/conf/fe.conf

# 添加以下配置
priority_networks = 10.0.0.0/8
meta_dir = /opt/doris/fe/doris-meta
log_dir = /opt/doris/fe/log

# 3. 启动FE节点
/opt/doris/fe/bin/start_fe.sh --helper fe_master_host:edit_log_port --daemon

# 4. 将FE节点加入集群
# 在Master FE节点上执行
mysql -h fe_master_host -P query_port -uroot
ALTER SYSTEM ADD FOLLOWER "new_fe_host:edit_log_port";
```

#### 4.1.2 BE节点扩容

```bash
# 1. 在新BE节点上安装Doris BE
# 2. 修改BE配置文件
vi /opt/doris/be/conf/be.conf

# 添加以下配置
priority_networks = 10.0.0.0/8
storage_root_path = /opt/doris/be/storage
heartbeat_service_thread_count = 1
create_tablet_worker_count = 3

# 3. 启动BE节点
/opt/doris/be/bin/start_be.sh --daemon

# 4. 将BE节点加入集群
# 在Master FE节点上执行
mysql -h fe_master_host -P query_port -uroot
ALTER SYSTEM ADD BACKEND "new_be_host:heartbeat_port";
```

### 4.2 集群缩容

#### 4.2.1 FE节点缩容

```sql
-- 1. 确认FE节点状态
SHOW FRONTENDS;

-- 2. 下线FE节点
ALTER SYSTEM DECOMMISSION FRONTEND "fe_host:edit_log_port";

-- 3. 监控下线进度
SHOW PROC '/frontends';

-- 4. 确认下线完成后，停止FE节点
-- 在目标FE节点上执行
/opt/doris/fe/bin/stop_fe.sh
```

#### 4.2.2 BE节点缩容

```sql
-- 1. 确认BE节点状态
SHOW BACKENDS;

-- 2. 下线BE节点
ALTER SYSTEM DECOMMISSION BACKEND "be_host:heartbeat_port";

-- 3. 监控下线进度
SHOW PROC '/backends';

-- 4. 确认下线完成后，停止BE节点
-- 在目标BE节点上执行
/opt/doris/be/bin/stop_be.sh
```

## 5. 数据备份与恢复

### 5.1 数据备份

#### 5.1.1 创建备份仓库

```sql
-- 创建HDFS备份仓库
CREATE REPOSITORY hdfs_backup_repo
WITH BROKER hdfs_broker
ON LOCATION "hdfs://namenode:port/doris_backup"
PROPERTIES (
    "username" = "hdfs_user",
    "password" = "hdfs_password"
);

-- 创建S3备份仓库
CREATE REPOSITORY s3_backup_repo
WITH S3
ON LOCATION "s3://bucket_name/doris_backup"
PROPERTIES (
    "AWS_ENDPOINT" = "s3.amazonaws.com",
    "AWS_ACCESS_KEY" = "access_key",
    "AWS_SECRET_KEY" = "secret_key",
    "AWS_REGION" = "region"
);
```

#### 5.1.2 备份数据

```sql
-- 备份整个数据库
BACKUP DATABASE demo TO hdfs_backup_repo
PROPERTIES (
    "timeout" = "3600"
);

-- 备份指定表
BACKUP TABLE demo.user_info, demo.user_behavior TO hdfs_backup_repo
PROPERTIES (
    "timeout" = "3600"
);

-- 异步备份
BACKUP DATABASE demo TO hdfs_backup_repo
PROPERTIES (
    "timeout" = "3600",
    "async" = "true"
);
```

#### 5.1.3 查看备份状态

```sql
-- 查看备份任务
SHOW BACKUP;

-- 查看备份仓库
SHOW REPOSITORIES;

-- 查看备份详情
SHOW SNAPSHOT ON hdfs_backup_repo;
```

### 5.2 数据恢复

#### 5.2.1 恢复数据库

```sql
-- 恢复整个数据库
RESTORE DATABASE demo FROM hdfs_backup_repo
PROPERTIES (
    "backup_timestamp" = "2023-11-20-10-30-00",
    "timeout" = "3600"
);

-- 恢复到指定数据库
RESTORE DATABASE demo FROM hdfs_backup_repo
PROPERTIES (
    "backup_timestamp" = "2023-11-20-10-30-00",
    "timeout" = "3600",
    "replication_num" = "3"
);

-- 异步恢复
RESTORE DATABASE demo FROM hdfs_backup_repo
PROPERTIES (
    "backup_timestamp" = "2023-11-20-10-30-00",
    "timeout" = "3600",
    "async" = "true"
);
```

#### 5.2.2 恢复表

```sql
-- 恢复指定表
RESTORE TABLE demo.user_info, demo.user_behavior FROM hdfs_backup_repo
PROPERTIES (
    "backup_timestamp" = "2023-11-20-10-30-00",
    "timeout" = "3600"
);

-- 恢复表到新表名
RESTORE TABLE demo.user_info FROM hdfs_backup_repo
AS demo.user_info_backup
PROPERTIES (
    "backup_timestamp" = "2023-11-20-10-30-00",
    "timeout" = "3600"
);
```

#### 5.2.3 查看恢复状态

```sql
-- 查看恢复任务
SHOW RESTORE;

-- 查看恢复进度
SHOW RESTORE FROM hdfs_backup_repo;
```

## 6. 集群升级

### 6.1 升级准备

1. **备份数据**
   ```sql
   -- 创建备份
   BACKUP DATABASE demo TO hdfs_backup_repo
   PROPERTIES (
       "timeout" = "3600"
   );
   ```

2. **检查集群状态**
   ```sql
   -- 检查FE节点状态
   SHOW FRONTENDS;
   
   -- 检查BE节点状态
   SHOW BACKENDS;
   
   -- 检查集群健康状态
   SHOW PROC '/cluster_health';
   ```

3. **停止写入操作**
   ```sql
   -- 禁用写入
   ADMIN SET FRONTEND CONFIG ('edit_log_port' = '9010');
   ```

### 6.2 FE节点升级

```bash
# 1. 备份FE元数据
cp -r /opt/doris/fe/doris-meta /opt/doris/fe/doris-meta.backup

# 2. 下载新版本Doris
wget https://doris.apache.org/downloads/apache-doris-x.x.x-bin.tar.gz
tar -zxvf apache-doris-x.x.x-bin.tar.gz

# 3. 停止FE节点
/opt/doris/fe/bin/stop_fe.sh

# 4. 替换FE程序
cp -r apache-doris-x.x.x/fe/* /opt/doris/fe/

# 5. 启动FE节点
/opt/doris/fe/bin/start_fe.sh --daemon

# 6. 检查FE节点状态
mysql -h fe_host -P query_port -uroot
SHOW FRONTENDS;
```

### 6.3 BE节点升级

```bash
# 1. 备份BE数据
cp -r /opt/doris/be/storage /opt/doris/be/storage.backup

# 2. 停止BE节点
/opt/doris/be/bin/stop_be.sh

# 3. 替换BE程序
cp -r apache-doris-x.x.x/be/* /opt/doris/be/

# 4. 启动BE节点
/opt/doris/be/bin/start_be.sh --daemon

# 5. 检查BE节点状态
mysql -h fe_host -P query_port -uroot
SHOW BACKENDS;
```

### 6.4 升级后检查

```sql
-- 检查FE节点状态
SHOW FRONTENDS;

-- 检查BE节点状态
SHOW BACKENDS;

-- 检查集群健康状态
SHOW PROC '/cluster_health';

-- 检查表状态
SHOW TABLE STATUS FROM demo;

-- 检查数据完整性
SELECT COUNT(*) FROM demo.user_info;
SELECT COUNT(*) FROM demo.user_behavior;
```

## 7. 日常维护

### 7.1 定期维护任务

#### 7.1.1 数据清理

```sql
-- 清理过期分区
ALTER TABLE demo.user_behavior DROP PARTITION p20231001;

-- 自动清理过期分区
ALTER TABLE demo.user_behavior SET (
    "dynamic_partition.enable" = "true",
    "dynamic_partition.time_unit" = "DAY",
    "dynamic_partition.start" = "-30",
    "dynamic_partition.end" = "7",
    "dynamic_partition.prefix" = "p"
);

-- 清理回收站
ADMIN SET FRONTEND CONFIG ('trash_file_expire_time_sec' = '259200');
```

#### 7.1.2 数据压缩

```sql
-- 手动触发压缩
ADMIN COMPACT TABLE demo.user_behavior;

-- 查看压缩状态
SHOW COMPACTION FROM demo.user_behavior;

-- 设置压缩策略
ALTER TABLE demo.user_behavior SET (
    "compression" = "LZ4"
);
```

#### 7.1.3 统计信息更新

```sql
-- 更新表统计信息
ANALYZE TABLE demo.user_info UPDATE HISTOGRAM ON user_id, age, city;
ANALYZE TABLE demo.user_behavior UPDATE HISTOGRAM ON user_id, event_time, event_type;

-- 更新数据库统计信息
ANALYZE DATABASE demo UPDATE HISTOGRAM ON ALL COLUMNS;

-- 查看统计信息
SHOW HISTOGRAMS FROM demo.user_info;
SHOW HISTOGRAMS FROM demo.user_behavior;
```

### 7.2 监控告警

#### 7.2.1 Prometheus监控

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'doris_fe'
    static_configs:
      - targets: ['fe_host1:8030', 'fe_host2:8030', 'fe_host3:8030']
    metrics_path: '/metrics'
    
  - job_name: 'doris_be'
    static_configs:
      - targets: ['be_host1:8040', 'be_host2:8040', 'be_host3:8040']
    metrics_path: '/metrics'
```

#### 7.2.2 Grafana仪表盘

创建Grafana仪表盘监控Doris集群：

1. **FE节点监控**
   - JVM内存使用率
   - 查询QPS
   - 查询延迟
   - 元数据大小

2. **BE节点监控**
   - CPU使用率
   - 内存使用率
   - 磁盘使用率
   - 网络IO

3. **集群监控**
   - 查询QPS
   - 查询延迟
   - 错误率
   - 数据大小

### 7.3 日志管理

#### 7.3.1 日志配置

```bash
# FE日志配置
vi /opt/doris/fe/conf/fe.conf

# 添加以下配置
sys_log_level = INFO
sys_log_roll_num = 10
sys_log_roll_mode = SIZE-MB-1024
sys_log_dir = /opt/doris/fe/log

# BE日志配置
vi /opt/doris/be/conf/be.conf

# 添加以下配置
sys_log_level = INFO
sys_log_roll_num = 10
sys_log_roll_mode = SIZE-MB-1024
sys_log_dir = /opt/doris/be/log
```

#### 7.3.2 日志收集

```bash
# 使用Logstash收集Doris日志
# logstash.conf
input {
  file {
    path => "/opt/doris/fe/log/fe.log"
    start_position => "beginning"
    type => "doris_fe"
  }
  file {
    path => "/opt/doris/be/log/be.INFO"
    start_position => "beginning"
    type => "doris_be"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "doris-logs-%{+YYYY.MM.dd}"
  }
}
```

## 8. 实战案例

### 8.1 集群扩容实战

#### 8.1.1 场景描述

某公司Doris集群当前有3个FE节点和5个BE节点，由于数据量增长，需要扩容到3个FE节点和8个BE节点。

#### 8.1.2 扩容步骤

1. **准备新节点**
   ```bash
   # 在3个新BE节点上安装Doris BE
   # 配置网络和存储
   ```

2. **添加BE节点**
   ```sql
   -- 在Master FE节点上执行
   ALTER SYSTEM ADD BACKEND "be_host1:heartbeat_port";
   ALTER SYSTEM ADD BACKEND "be_host2:heartbeat_port";
   ALTER SYSTEM ADD BACKEND "be_host3:heartbeat_port";
   ```

3. **数据均衡**
   ```sql
   -- 触发数据均衡
   ADMIN SET FRONTEND CONFIG ('disable_balance' = 'false');
   
   -- 查看均衡状态
   SHOW PROC '/cluster_health';
   ```

4. **验证扩容结果**
   ```sql
   -- 查看BE节点状态
   SHOW BACKENDS;
   
   -- 查看数据分布
   SHOW DATA;
   ```

### 8.2 故障恢复实战

#### 8.2.1 场景描述

某公司Doris集群中一个BE节点磁盘故障，导致该节点上的数据不可用。

#### 8.2.2 恢复步骤

1. **故障诊断**
   ```sql
   -- 查看BE节点状态
   SHOW BACKENDS;
   
   -- 查看tablet状态
   SHOW TABLETS FROM demo.user_behavior;
   ```

2. **下线故障节点**
   ```sql
   -- 下线故障BE节点
   ALTER SYSTEM DECOMMISSION BACKEND "be_host:heartbeat_port";
   ```

3. **数据恢复**
   ```sql
   -- 修复tablet
   ADMIN REPAIR TABLE demo.user_behavior PARTITION (p20231120);
   
   -- 监控恢复进度
   SHOW PROC '/backends';
   ```

4. **替换故障节点**
   ```bash
   # 在新节点上安装Doris BE
   # 启动BE节点
   /opt/doris/be/bin/start_be.sh --daemon
   ```

5. **添加新节点**
   ```sql
   -- 添加新BE节点
   ALTER SYSTEM ADD BACKEND "new_be_host:heartbeat_port";
   ```

### 8.3 数据迁移实战

#### 8.3.1 场景描述

某公司需要将Doris集群从一个数据中心迁移到另一个数据中心。

#### 8.3.2 迁移步骤

1. **创建备份仓库**
   ```sql
   -- 在新数据中心创建备份仓库
   CREATE REPOSITORY new_dc_backup_repo
   WITH S3
   ON LOCATION "s3://new_dc_bucket/doris_backup"
   PROPERTIES (
       "AWS_ENDPOINT" = "s3.new-region.amazonaws.com",
       "AWS_ACCESS_KEY" = "access_key",
       "AWS_SECRET_KEY" = "secret_key",
       "AWS_REGION" = "new-region"
   );
   ```

2. **备份数据**
   ```sql
   -- 备份所有数据库
   BACKUP DATABASE demo TO new_dc_backup_repo
   PROPERTIES (
       "timeout" = "3600"
   );
   ```

3. **在新集群恢复数据**
   ```sql
   -- 在新集群恢复数据
   RESTORE DATABASE demo FROM new_dc_backup_repo
   PROPERTIES (
       "backup_timestamp" = "2023-11-20-10-30-00",
       "timeout" = "3600"
   );
   ```

4. **验证迁移结果**
   ```sql
   -- 检查数据完整性
   SELECT COUNT(*) FROM demo.user_info;
   SELECT COUNT(*) FROM demo.user_behavior;
   
   -- 检查数据一致性
   SELECT user_id, COUNT(*) FROM demo.user_behavior GROUP BY user_id HAVING COUNT(*) > 1;
   ```

## 9. 常见问题与解决方案

### 9.1 集群问题

**问题**：集群节点频繁离线

**解决方案**：
1. 检查网络连通性
2. 检查节点资源使用情况
3. 调整心跳超时时间
4. 增加节点资源

**问题**：集群负载不均衡

**解决方案**：
1. 检查数据分布情况
2. 调整分桶策略
3. 触发数据均衡
4. 增加BE节点

### 9.2 数据问题

**问题**：数据丢失或损坏

**解决方案**：
1. 检查副本数量
2. 修复损坏的tablet
3. 从备份恢复数据
4. 增加副本数量

**问题**：查询结果不一致

**解决方案**：
1. 检查数据一致性
2. 修复不一致的副本
3. 重建物化视图
4. 更新统计信息

### 9.3 性能问题

**问题**：查询性能下降

**解决方案**：
1. 分析执行计划
2. 优化查询语句
3. 创建合适的索引
4. 调整集群参数

**问题**：导入性能下降

**解决方案**：
1. 检查导入方式
2. 调整导入参数
3. 优化表设计
4. 增加BE节点

## 10. 本章小结

本章详细介绍了Doris运维管理的各个方面，包括集群监控、故障诊断与处理、集群扩容与缩容、数据备份与恢复、集群升级、日常维护等内容，以及实战案例和常见问题解决方案。

### 10.1 关键要点

1. **集群监控**：使用SQL命令和监控工具监控集群状态
2. **故障诊断**：快速定位和解决集群故障
3. **扩容缩容**：根据业务需求调整集群规模
4. **备份恢复**：定期备份数据，确保数据安全
5. **集群升级**：安全升级集群到新版本
6. **日常维护**：定期执行维护任务，保持集群健康

### 10.2 最佳实践

1. 建立完善的监控告警体系
2. 定期备份关键数据
3. 制定详细的故障恢复预案
4. 规划合理的扩容策略
5. 建立完善的运维文档
6. 定期进行故障演练

## 11. 延伸阅读

- [Doris官方文档-运维管理](https://doris.apache.org/docs/admin-manual/)
- [Doris官方文档-备份恢复](https://doris.apache.org/docs/admin-manual/backup-restore/)
- [Doris官方文档-集群扩缩容](https://doris.apache.org/docs/admin-manual/cluster-management/)
- [Doris官方文档-监控与告警](https://doris.apache.org/docs/admin-manual/monitor-alert/)

## 12. 实践练习

1. 搭建一个3节点FE和5节点BE的Doris集群
2. 配置Prometheus和Grafana监控Doris集群
3. 实现Doris集群的扩容和缩容操作
4. 配置数据备份和恢复策略
5. 模拟常见故障并练习故障恢复
6. 制定一份Doris集群运维手册
7. 实现Doris集群的滚动升级