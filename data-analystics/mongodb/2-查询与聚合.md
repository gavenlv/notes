# 第2章：查询与聚合

## 目录
1. [查询操作符](#1-查询操作符)
2. [聚合框架](#2-聚合框架)
3. [复杂查询](#3-复杂查询)
4. [数据管道](#4-数据管道)
5. [MapReduce](#5-mapreduce)
6. [查询优化](#6-查询优化)

## 1. 查询操作符

### 1.1 比较操作符

#### 1.1.1 相等条件
```javascript
// 精确匹配
db.users.find({name: "John Doe"})

// 多字段匹配
db.users.find({
  age: 30,
  "address.city": "New York"
})
```

#### 1.1.2 比较操作符
```javascript
// 大于 $gt
db.users.find({age: {$gt: 25}})

// 大于等于 $gte
db.users.find({age: {$gte: 30}})

// 小于 $lt
db.users.find({age: {$lt: 40}})

// 小于等于 $lte
db.users.find({age: {$lte: 35}})

// 不等于 $ne
db.users.find({status: {$ne: "inactive"}})

// 在范围内 $in
db.users.find({age: {$in: [25, 30, 35]}})

// 不在范围内 $nin
db.users.find({tags: {$nin: ["spam", "test"]}})
```

#### 1.1.3 复合条件
```javascript
// AND条件
db.users.find({
  age: {$gte: 18, $lte: 65},
  status: "active"
})

// OR条件
db.users.find({
  $or: [
    {age: {$gte: 65}},
    {status: "retired"}
  ]
})

// 复杂逻辑
db.users.find({
  $and: [
    {age: {$gte: 18}},
    {
      $or: [
        {status: "active"},
        {status: "retired"}
      ]
    }
  ]
})
```

### 1.2 数组查询

#### 1.2.1 数组元素匹配
```javascript
// 包含特定元素
db.users.find({tags: "developer"})

// 包含多个元素（至少包含）
db.users.find({
  tags: {$all: ["mongodb", "javascript"]}
})

// 数组长度匹配
db.users.find({
  skills: {$size: 3}
})

// 数组索引查询
db.users.find({
  "skills.0": "JavaScript"  // 查询第一个技能是JavaScript
})
```

#### 1.2.2 数组嵌套查询
```javascript
// 查询包含指定条件的嵌套数组
db.posts.find({
  "comments.author": "john_doe"
})

// 查询数组中至少一个元素匹配条件
db.posts.find({
  comments: {
    $elemMatch: {
      author: "john_doe",
      rating: {$gte: 4}
    }
  }
})
```

### 1.3 字符串查询

#### 1.3.1 正则表达式
```javascript
// 模糊匹配
db.users.find({name: /john/i})

// 开头匹配
db.users.find({email: /^john/})

// 结尾匹配
db.users.find({email: /@gmail\.com$/})

// 多条件正则
db.users.find({
  name: {
    $regex: "^(john|jane)",
    $options: "i"
  }
})
```

#### 1.3.2 字符串操作
```javascript
// 前缀匹配
db.users.find({name: {$regex: "^John"}})

// 后缀匹配
db.users.find({name: {$regex: "Doe$"}})

// 不区分大小写
db.users.find({name: {$regex: "john", $options: "i"}})
```

### 1.4 地理空间查询

```javascript
// 创建地理空间索引
db.locations.createIndex({coordinates: "2dsphere"})

// 附近查询
db.locations.find({
  coordinates: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [-74.0059, 40.7128]  // 纽约坐标
      },
      $maxDistance: 5000  // 5公里内
    }
  }
})

// 区域内查询
db.locations.find({
  coordinates: {
    $geoWithin: {
      $box: [
        [-74.1, 40.7],
        [-73.9, 40.8]
      ]
    }
  }
})
```

### 1.5 元数据查询

```javascript
// 查询存在字段
db.users.find({email: {$exists: true}})

// 查询字段类型
db.users.find({age: {$type: "number"}})

// 查询字段大小
db.users.find({name: {$regex: /^.{5,50}$/}})
```

## 2. 聚合框架

### 2.1 聚合管道基础

聚合管道是MongoDB中强大的数据处理工具：

```javascript
// 基本聚合查询
db.orders.aggregate([
  {
    $match: {                    // 筛选阶段
      order_date: {$gte: new Date("2024-01-01")}
    }
  },
  {
    $group: {                    // 分组阶段
      _id: "$customer_id",
      total_orders: {$sum: 1},
      total_amount: {$sum: "$total_amount"},
      avg_amount: {$avg: "$total_amount"}
    }
  },
  {
    $sort: {                     // 排序阶段
      total_amount: -1
    }
  }
])
```

### 2.2 聚合阶段详解

#### 2.2.1 $match阶段
```javascript
// 单一条件匹配
{
  $match: {status: "completed"}
}

// 多条件匹配
{
  $match: {
    status: "completed",
    order_date: {$gte: new Date("2024-01-01")},
    total_amount: {$gt: 100}
  }
}

// 使用聚合操作符
{
  $match: {
    $and: [
      {status: "completed"},
      {
        $or: [
          {priority: "high"},
          {priority: "urgent"}
        ]
      }
    ]
  }
}
```

#### 2.2.2 $group阶段
```javascript
// 基本分组
{
  $group: {
    _id: "$status",
    count: {$sum: 1},
    total_amount: {$sum: "$total_amount"}
  }
}

// 多字段分组
{
  $group: {
    _id: {
      status: "$status",
      category: "$category"
    },
    count: {$sum: 1},
    avg_price: {$avg: "$price"}
  }
}

// 分组统计
{
  $group: {
    _id: null,
    total_orders: {$sum: 1},
    total_revenue: {$sum: "$total_amount"},
    max_order: {$max: "$total_amount"},
    min_order: {$min: "$total_amount"}
  }
}
```

#### 2.2.3 $project阶段
```javascript
// 重命名字段
{
  $project: {
    customer_id: 1,
    order_date: 1,
    total_amount: 1,
    status: 1,
    total_revenue: "$total_amount"  // 别名
  }
}

// 计算新字段
{
  $project: {
    customer_id: 1,
    order_date: 1,
    subtotal: 1,
    tax: {$multiply: ["$subtotal", 0.1]},
    total: {
      $add: ["$subtotal", {$multiply: ["$subtotal", 0.1]}]
    }
  }
}

// 条件字段
{
  $project: {
    customer_id: 1,
    order_amount: 1,
    price_category: {
      $cond: {
        if: {$gte: ["$order_amount", 1000]},
        then: "premium",
        else: "regular"
      }
    }
  }
}
```

#### 2.2.4 $sort和$limit阶段
```javascript
// 排序
{
  $sort: {
    order_date: -1,
    total_amount: -1
  }
}

// 限制结果数量
{
  $limit: 10
}

// 跳过前N条记录
{
  $skip: 100
}
```

#### 2.2.5 $unwind阶段
```javascript
// 基本数组拆分
{
  $unwind: "$tags"
}

// 保留非空数组
{
  $unwind: {
    path: "$tags",
    preserveNullAndEmptyArrays: true
  }
}

// 拆分嵌套数组
{
  $unwind: {
    path: "$comments",
    includeArrayIndex: "comment_index"
  }
}
```

### 2.3 聚合操作符

#### 2.3.1 算术操作符
```javascript
// 加法
{
  $project: {
    total: {$add: ["$price", "$tax", "$shipping"]}
  }
}

// 减法
{
  $project: {
    profit: {$subtract: ["$revenue", "$cost"]}
  }
}

// 乘法
{
  $project: {
    subtotal: {$multiply: ["$quantity", "$price"]}
  }
}

// 除法
{
  $project: {
    margin: {$divide: [{$subtract: ["$revenue", "$cost"]}, "$revenue"]}
  }
}
```

#### 2.3.2 字符串操作符
```javascript
// 连接字符串
{
  $project: {
    full_name: {$concat: ["$first_name", " ", "$last_name"]}
  }
}

// 提取子字符串
{
  $project: {
    first_5_chars: {$substr: ["$name", 0, 5]}
  }
}

// 转换为大写
{
  $project: {
    name_upper: {$toUpper: "$name"}
  }
}
```

#### 2.3.3 数组操作符
```javascript
// 数组长度
{
  $project: {
    tag_count: {$size: "$tags"}
  }
}

// 数组切片
{
  $project: {
    first_3_tags: {$slice: ["$tags", 3]}
  }
}

// 数组包含
{
  $match: {
    tags: {$in: ["mongodb", "database"]}
  }
}
```

#### 2.3.4 条件操作符
```javascript
// 简单条件
{
  $project: {
    category: {
      $cond: {
        if: {$gte: ["$score", 80]},
        then: "excellent",
        else: "good"
      }
    }
  }
}

// 复杂条件
{
  $project: {
    customer_tier: {
      $cond: {
        if: {$gte: ["$total_spent", 10000]},
        then: "platinum",
        else: {
          $cond: {
            if: {$gte: ["$total_spent", 5000]},
            then: "gold",
            else: "silver"
          }
        }
      }
    }
  }
}
```

### 2.4 复杂聚合示例

#### 2.4.1 销售分析
```javascript
db.orders.aggregate([
  // 筛选已完成订单
  {
    $match: {
      status: "completed",
      order_date: {
        $gte: new Date("2024-01-01"),
        $lt: new Date("2024-12-31")
      }
    }
  },
  
  // 按月分组统计
  {
    $group: {
      _id: {
        year: {$year: "$order_date"},
        month: {$month: "$order_date"}
      },
      total_orders: {$sum: 1},
      total_revenue: {$sum: "$total_amount"},
      avg_order_value: {$avg: "$total_amount"}
    }
  },
  
  // 按月排序
  {
    $sort: {"_id.year": 1, "_id.month": 1}
  },
  
  // 格式化输出
  {
    $project: {
      month: {
        $concat: [
          {$toString: "$_id.year"},
          "-",
          {
            $cond: {
              if: {$lt: ["$_id.month", 10]},
              then: {$concat: ["0", {$toString: "$_id.month"}]},
              else: {$toString: "$_id.month"}
            }
          }
        ]
      },
      total_orders: 1,
      total_revenue: {$round: ["$total_revenue", 2]},
      avg_order_value: {$round: ["$avg_order_value", 2]}
    }
  }
])
```

#### 2.4.2 用户行为分析
```javascript
db.user_activities.aggregate([
  // 筛选活动记录
  {
    $match: {
      timestamp: {$gte: new Date("2024-01-01")}
    }
  },
  
  // 按用户分组
  {
    $group: {
      _id: "$user_id",
      total_activities: {$sum: 1},
      page_views: {
        $sum: {
          $cond: [{$eq: ["$activity_type", "page_view"]}, 1, 0]
        }
      },
      purchases: {
        $sum: {
          $cond: [{$eq: ["$activity_type", "purchase"]}, 1, 0]
        }
      },
      last_activity: {$max: "$timestamp"}
    }
  },
  
  // 计算活跃度
  {
    $project: {
      user_id: "$_id",
      total_activities: 1,
      page_views: 1,
      purchases: 1,
      engagement_score: {
        $divide: [
          {$add: ["$page_views", {$multiply: ["$purchases", 5]}]},
          "$total_activities"
        ]
      },
      days_since_last: {
        $divide: [
          {$subtract: [new Date(), "$last_activity"]},
          86400000
        ]
      }
    }
  },
  
  // 排序和筛选
  {
    $sort: {engagement_score: -1}
  },
  {
    $limit: 100
  }
])
```

#### 2.4.3 产品分析
```javascript
db.products.aggregate([
  // 筛选有效产品
  {
    $match: {
      status: "active"
    }
  },
  
  // 展开评论数组
  {
    $unwind: {
      path: "$reviews",
      preserveNullAndEmptyArrays: true
    }
  },
  
  // 按产品分组计算平均评分
  {
    $group: {
      _id: "$_id",
      name: {$first: "$name"},
      category: {$first: "$category"},
      base_price: {$first: "$price"},
      total_reviews: {$sum: 1},
      avg_rating: {$avg: "$reviews.rating"},
      max_rating: {$max: "$reviews.rating"},
      min_rating: {$min: "$reviews.rating"}
    }
  },
  
  // 计算评分分布
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "product_id",
      as: "rating_distribution"
    }
  },
  
  // 筛选高评分产品
  {
    $match: {
      avg_rating: {$gte: 4.0},
      total_reviews: {$gte: 10}
    }
  },
  
  // 排序
  {
    $sort: {avg_rating: -1, total_reviews: -1}
  }
])
```

## 3. 复杂查询

### 3.1 分页查询

```javascript
// 基于skip的分页
const page = 3;
const pageSize = 10;
const skip = (page - 1) * pageSize;

db.users.find()
  .sort({created_at: -1})
  .skip(skip)
  .limit(pageSize)

// 基于范围的分页（更高效）
const lastDocument = db.users.findOne(
  {created_at: {$lt: lastTimestamp}},
  {sort: {created_at: -1}}
);

db.users.find({
  created_at: {$lt: lastTimestamp || new Date()},
  ...otherFilters
})
.sort({created_at: -1})
.limit(pageSize)
```

### 3.2 游标操作

```javascript
// 基本游标操作
const cursor = db.users.find({age: {$gte: 18}});

// 获取下一个文档
while (cursor.hasNext()) {
  const user = cursor.next();
  console.log(user.name);
}

// 批量处理
cursor.forEach(user => {
  // 处理每个用户
  db.user_logs.insertOne({
    user_id: user._id,
    processed_at: new Date(),
    action: "batch_processed"
  });
});
```

### 3.3 结果去重

```javascript
// 查询去重
db.users.distinct("category")

// 聚合管道去重
db.users.aggregate([
  {
    $group: {
      _id: "$category",
      users: {$push: "$$ROOT"}
    }
  },
  {
    $project: {
      category: "$_id",
      user_count: {$size: "$users"},
      users: {
        $map: {
          input: "$users",
          as: "user",
          in: {
            _id: "$$user._id",
            name: "$$user.name"
          }
        }
      }
    }
  }
])
```

### 3.4 查询计划分析

```javascript
// 使用explain分析查询
db.users.find({age: 30, city: "New York"})
  .explain("executionStats")

// 分析聚合管道
db.orders.aggregate([
  {$match: {status: "completed"}},
  {$group: {_id: "$customer_id", total: {$sum: "$total_amount"}}}
]).explain("executionStats")
```

## 4. 数据管道

### 4.1 管道优化

```javascript
// ❌ 不推荐 - $match放在最后
db.orders.aggregate([
  {$unwind: "$items"},
  {$group: {_id: "$customer_id", total: {$sum: "$items.price"}}},
  {$match: {total: {$gte: 1000}}}
])

// ✅ 推荐 - $match放在前面
db.orders.aggregate([
  {$match: {status: "completed"}},
  {$unwind: "$items"},
  {$match: {"items.price": {$gte: 100}}},
  {$group: {_id: "$customer_id", total: {$sum: "$items.price"}}}
])
```

### 4.2 管道调试

```javascript
// 添加$documentCount统计
db.orders.aggregate([
  {$documentCount: {}},
  {$match: {status: "completed"}},
  {$documentCount: {}},
  {$group: {_id: "$customer_id", count: {$sum: 1}}}
])

// 使用$sample采样
db.users.aggregate([
  {$sample: {size: 100}},
  {$group: {_id: "$age", count: {$sum: 1}}}
])
```

### 4.3 管道变量

```javascript
// 使用let传递变量
db.orders.aggregate([
  {
    $match: {
      customer_id: ObjectId("64a7b1234567890abcdef1234")
    }
  },
  {
    $lookup: {
      from: "customers",
      let: {customer_id: "$customer_id"},
      pipeline: [
        {$match: {$expr: {$eq: ["$_id", "$$customer_id"]}}},
        {$project: {name: 1, email: 1}}
      ],
      as: "customer"
    }
  },
  {$unwind: "$customer"}
])
```

## 5. MapReduce

### 5.1 基本MapReduce

```javascript
// Map函数
const mapFunction = function() {
  emit(this.category, this.price);
};

// Reduce函数
const reduceFunction = function(key, values) {
  return Array.sum(values);
};

// 执行MapReduce
db.products.mapReduce(
  mapFunction,
  reduceFunction,
  {out: "category_totals"}
);
```

### 5.2 复杂MapReduce

```javascript
// 分析用户行为
const mapBehavior = function() {
  const behavior = {
    views: this.action === 'view' ? 1 : 0,
    clicks: this.action === 'click' ? 1 : 0,
    purchases: this.action === 'purchase' ? 1 : 0
  };
  emit(this.user_id, behavior);
};

const reduceBehavior = function(key, values) {
  const behavior = {
    views: 0,
    clicks: 0,
    purchases: 0
  };
  
  values.forEach(behavior_data => {
    behavior.views += behavior_data.views;
    behavior.clicks += behavior_data.clicks;
    behavior.purchases += behavior_data.purchases;
  });
  
  return behavior;
};

db.user_activities.mapReduce(
  mapBehavior,
  reduceBehavior,
  {
    out: "user_behavior_summary",
    query: {timestamp: {$gte: new Date("2024-01-01")}}
  }
);
```

## 6. 查询优化

### 6.1 查询模式分析

```javascript
// 分析查询性能
const analyzeQuery = function(collection, pipeline) {
  const explanation = db[collection].aggregate(pipeline).explain("executionStats");
  
  console.log("执行阶段:", explanation.stages);
  console.log("总执行时间:", explanation.executionStats.executionTimeMillis, "ms");
  console.log("检查文档数:", explanation.executionStats.totalDocsExamined);
  console.log("返回文档数:", explanation.executionStats.totalDocsReturned);
};

// 使用示例
analyzeQuery("orders", [
  {$match: {status: "completed"}},
  {$group: {_id: "$customer_id", total: {$sum: "$total_amount"}}}
]);
```

### 6.2 索引使用分析

```javascript
// 检查查询是否使用了索引
db.users.find({age: 30, city: "New York"}).explain("executionStats");

// 查看索引使用情况
db.users.aggregate([
  {
    $indexStats: {}
  }
]);

// 强制使用特定索引
db.users.find({age: 30}).hint({age: 1, city: 1});
```

### 6.3 查询建议

```javascript
// 自动查询建议
const getQuerySuggestions = function(collection, pipeline) {
  const stats = db[collection].aggregate([
    ...pipeline,
    {$documentCount: {}}
  ]);
  
  return {
    recommended_indexes: [
      {fields: {age: 1}, reason: "经常用于筛选"},
      {fields: {city: 1}, reason: "经常用于筛选"}
    ],
    pipeline_optimization: pipeline.filter(stage => 
      ["$match", "$sort"].includes(Object.keys(stage)[0])
    )
  };
};
```

---

*第2章深入介绍了MongoDB的查询操作符和聚合框架。通过掌握这些强大的查询功能，您可以进行复杂的数据分析、统计和报告生成。*