## Mongodb Operation Log
### 1.0 Make some change on db
```bash
use sample_supplies
db.sales.updateMany({}, {$inc, {"customer.satisfaction":1}})
```
### 1.1 switch to local db
```bash
use local
show collections
db.oplog.rs.find({"ns": "sample_supplies.sales"}).sort({$natural:-1}).limit(5)
```
### 1.2 retrieve oplog
```bash
rs.printReplicationInfo()
```
### 1.3 retrieve secondaries's oplog
```bash
rs.printSecondaryReplicationInfo()
```

## Mongodb writeConcern, readConcern and readPreference
### 2.1 writeConcern
```bash
db.cats.insertOne({name: "my cat1", color: "black", age: 3}, {writeConcern: {w: "majority", timeout: 3000}})
```
### 2.2 set default read / write concern by adminCommand
```bash
db.adminCommand({
    setDefaultRWConcern : 1,
    defaultReadConcern: { level : "majority" },
    defaultWriteConcern: { w: "majority" }
  })
```

### 2.3 set readPreference in connection string
```bash
mongodb://db0.example.com,db1.example.com,db2.example.com/?replicaSet=myRepl&readPreference=secondary&maxStalenessSeconds=120
```

## 2. Deploy a replica set
### 2.1 Steps
- Update the mongod configuration files
- Create security files
- Initiate an election
- Create an admin user

### 2.2 Update mongod.conf in /etc/mongod.conf
#### Node0
```yml
#mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1,<mongodb.repl.member.one.domain>


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

security:
  keyFile: /etc/mongodb/pki/mongod-keyfile
  authorization: enabled

#operationProfiling:

replication:
  replSetName: mongodb-repl-example


#sharding:

## Enterprise-Only Options:

#auditLog:

#snmp:
```
#### Node1
```yml
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1,<mongodb.repl.member.two.domain>


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

security:
  keyFile: /etc/mongodb/pki/mongod-keyfile
  authorization: enabled

#operationProfiling:

replication:
  replSetName: mongodb-repl-example


#sharding:

## Enterprise-Only Options:

#auditLog:
```
#### Node2
```yml
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1,<mongodb.repl.member.three.domain>


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

security:
  keyFile: /etc/mongodb/pki/mongod-keyfile
  authorization: enabled

#operationProfiling:

replication:
  replSetName: mongodb-repl-example


#sharding:

## Enterprise-Only Options:

#auditLog:

#snmp:
```

### 2.3 Create security files
```bash
sudo mkdir -p /etc/mongodb/pki
#generate the security key using openssl only on one server
openssl rand -base64 756 > /tmp/keyFile
chmod 0400 /tmp/keyFile
sudo mv /tmp/keyFile  /etc/mongodb/pki/
sudo chown -R mongod. /etc/mongodb/pki
sudo systemctl restart mongod
```
### 2.4 Copy key files to other 2 nodes
```bash
scp /tmp/keyFile mongod1.replset.com:/tmp
scp /tmp/keyFile mongod2.replset.com:/tmp
```

### 2.5 Add security key in second and three server node
```bash
sudo mkdir -p /etc/mongodb/pki/
sudo chown -R mongodb. /etc/mongodb/pki
chmod 0400 /etc/mongodb/pki/
sudo systemctl restart mongod
```
### 2.6 Initiate the replicat set
```bash
use admin
rs.initiate(
{
    _id: "mongodb-repl-example",
    version:1,
    members: [
        {_id: 0, host: "mongod0.replset.com"},
        {_id: 1, host: "mongod1.replset.com"},
        {_id: 2, host: "mongod2.replset.com"}
    ]
}
)
#create admin user
db.createUser({
    user: "dba-admin",
    pwd: "dba-pass",
    roles: [
        {role: "root", db: "admin"}
    ]
})
exit
```

### 2.7 Connect and initiate an election
```bash
# mongosh to login replicaSet
mongosh "mongodb://dba-admin:dba-pass@server-one-ip:port, server-two-ip:port, server-three-ip:port/?authSource=admin&replicaSet=mongodb-repl-example"

rs.stepDown()
```
## 3. Configguring Replica Set
### 3.1 Retrieve the status
```bash
db.hello()
```
### 3.2 Reconfigure a running replica set
```bash
config = rs.conf()
# set priority
config.members[2].priority = 10
```
### 3.3 Add new member
```bash
# add a memeber 
member = {"_id": 3, "host": "mongodb3.replset.com:27017"}
config.members.push(member)

# or use rs.add() to add a new member
rs.add("mongod3.replset.com:27017")
```
### 3.4 Remove a member
```bash
config = rs.conf()
# first 1 is index of starting number, second 1 is number of nodes to remove
config.remembers.splice(1, 1)
# or use rs.remove()
rs.remove("mongod1.replset.com:27017")
# apply the change
rs.reconfig(config)s
```
### 3.5 Retrieve status
```bash
db.status()
```


