# Download logs form Atlas

## 1. Atlas command
```dotnetcli
atlas project users list -o json

//GROUP_DATA_ACCESS_READ_ONLY for log downlaod

atlas logs <hostname> <file>

atlas logs download uml3-shard-00-00.xwgj1.mongodb.net mongodb.gz

gunzip mongodb.log.gz
```

## 2. Logs in self-managed instances
```bash
/var/log/mongodb/mongo.log

sudo cat /etc/mongod.conf

show logs

db.adminCommand( { getLog:'global'} )
```


## 3. Logs message
```bash
db.adminCommand( { getLog: "*" } );
db.adminCommand( { getLog: "global" } );

show log startupWarnings
```

## 4. Logs customization
```bash
//disable profile: level:0
db.setProfilingLevel(0, { slowms: 30 })

//run query
db.listingsAndReviews.findOne({ "host.host_id": '1282196'})
// slow query
db.listingsAndReviews.find({}).sort( {"host.host_total_listings_count":-1})

sudo grep "Slow query" /var/log/mongodb/mongod.log | jq
// set verbosity level
vim /etc/mongod.conf
systemLog:
  verbosity: 1
//restart service
sudo systemctl mongod restart

"mongodb://localhost:27017/sample_airbnb" --quiet --eval "db.listingsAndReviews.createIndex({ host: 1 })"

sudo grep INDEX /var/log/mongodb/mongod.log | jq

//lab
db.setLogLevel(1, "index");
db.getLogComponents().index;
db.setProfilingLevel(0, { slowms: 20 });
db.getProfilingStatus();
```

## 5. Log rotation
```bash
db.adminCommand({logRotate: 1})
#or us SIGUSR1
sudo kill -SIGUSR1 $(pidof mongod)

# manual change:
mongod -v --logpath /var/log/mongodb/server1.log --logRotate reopen --logappend

# automating log rotation with logrotate service
sudo vim /etc/mongod.conf

# file 
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log
  logRotate: reopen

# add rogrotate service in linux
sudo vim /etc/logrotate.d/mongod.conf

# file
/var/log/mongodb/mongod.log {
   daily 
   size 
   rotate 10 
   missingok
   compress 
   compresscmd /usr/bin/bzip2 
   uncompresscmd /usr/bin/bunzip2 # command to uncompress the file
   compressoptions -9 # options for the compression utility
   compressext .bz2 # file format of the compressed archive
   delaycompress # wait to compress files until it's an opportune time
   notifempty # don't bother compressing if the log file is empty
   create 640 mongodb mongodb # creates the log  file with specific permissions
   sharedscripts # don't run multiple rotations at once
   postrotate # tell mongod to rotate, remove empty files
       /bin/kill -SIGUSR1 `cat /var/run/mongodb/mongod.pid 2>/dev/null` >/dev/null 2>&1
       find /var/log/mongodb -type f -size 0 -regextype posix-awk -regex "^\/var\/log\/mongodb\/mongod\.log\.[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}-[0-9]{2}-[0-9]{2}$" -execdir rm {} \; >/dev/null 2>&1
   endscript # end of the script
}

sudo systemctl restart mongod

#test 
sudo tail -f /var/log/mongodb/mongod.log
sudo kill -SIGUSR1 $(pidof mongod)

# tail command should have below message
# tail: /var/log/mongodb/mongod.log: file truncated;
```
