## 1 Enable Access Control
### 1.1. Change mongod.conf
```bash
sudo vi /etc/mongod.conf
# enter edit mode
i
# /etc/mongod.conf
security:
 authorization: enabled
```
### 1.2 Restart mongodb instance
```bash
sudo systemctl restart mongod
```
## 2. Create admin user
```bash
mongosh localhost:27017
#enter mongosh
use admin
db.createUser({
    user: "globalUserAdmin",
    pwd: passwordPrompt(),
    roles: [
    {role: "userAdminAnyDatabase", db: "admin"}    
    ]
})
quit()
```
### 2.1 Verify
```bash
mongosh "mongodb://username:password@localhost:27017/?replicaSet=xxx&authSource=admin"
# or mongosh --username globalUserAdmin admin
mongosh --username globalUserAdmin admin
# input password
use admin
db.getUsers()

```

## 3. Change user role
### 3.1 Create user with pre-defined role
```bash
mongosh --username globalUserAdmin
use amdin
db.createUser({
    user: "analystUser",
    pwd: "passwordPrompt()",
    roles: [
        {role: "read", db: "sample_analystics"}
    ]
})

quit()
```
### 3.2 Authenticate
```bash
mongosh "mongodb://analystUser@localhost:27017/sample_analystics?authSource=admin"
# mongosh
show collections
db.accounts.findOne()
quit()
```

### 3.3 Remove a build in role from db user
```bash
mongosh --username globalUserAdmin
# mongosh shell env
use admin
db.getUser("financeUser")
db.revokeRolesFromUser({
    "financeUser",
    [
    {role: "read", db: "sample_training"}
    ]
})
db.getUser("financeUser")
```
## 4 Autid log
```bash
vim /etc/mongod.conf

auditLog:
    destination: file
    format: JSON
    path: /var/log/mongodb/auditLog.json

sudo tail /var/log/mongodb/auditLog.json | jq
```
## 4 Enable TLS
### 4.1 Update config file
- /etc/mongod.conf   
- Set the path of the file that contains both the TLS certificate and the private key in the net.tls.certitificateKeyFile setting:
```yml
net:
  tls:
    mode: requireTLS
    certificateKeyFile: /etc/tls/mongodb.pem
replication:
  replSetName: TLSEnabledReplSet
```
restart
```bash
sudo systemctl restart mongod
```


### 4.2 initiate the replicate set
```bash
mongosh "mongodb://mongod0.replset.com/?tls=true&tlsCAFile=/etc/tls/root-ca.pem"
# mongosh
use admin
rs.initiate(
  {
     _id: "TLSEnabledReplSet",
     version: 1
     members: [
        { _id: 0, host : "mongod0.replset.com" },
        { _id: 1, host : "mongod1.replset.com" },
        { _id: 2, host : "mongod2.replset.com" }
     ]
  }
)
```

### 4.3 Test
```bash
mongosh "mongodb://mongod0.replset.com,mongod1.replset.com,mongod2.replset.com/?replicaSet=TLSEnabledReplSet&tls=true&tlsCAFile=/etc/tls/root-ca.pem"

# below will fail
mongosh "mongodb://mongod0.replset.com,mongod1.replset.com,mongod2.replset.com/?replicaSet=TLSEnabledReplSet" 

```





