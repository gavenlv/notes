# ç¬¬7ç« ï¼šå®‰å…¨ä¸è®¤è¯ - ä»£ç ç¤ºä¾‹æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«ç¬¬7ç« "å®‰å…¨ä¸è®¤è¯"çš„å®Œæ•´ä»£ç ç¤ºä¾‹ï¼Œæ¼”ç¤ºRabbitMQç³»ç»Ÿä¸­å„ç§å®‰å…¨æœºåˆ¶ã€è®¤è¯æ–¹å¼ã€æƒé™æ§åˆ¶å’Œå®‰å…¨ç›‘æ§åŠŸèƒ½ã€‚æ¶µç›–äº†ä»åŸºç¡€è®¤è¯åˆ°é«˜çº§å®‰å…¨æ¶ˆæ¯å¤„ç†çš„å…¨å¥—è§£å†³æ–¹æ¡ˆã€‚

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

### è®¤è¯ç›¸å…³
- **`authentication_demo.py`** - å¤šç§è®¤è¯æ–¹å¼æ¼”ç¤º
  - åŸºç¡€ç”¨æˆ·åå¯†ç è®¤è¯
  - JWT Tokenè®¤è¯
  - è¯ä¹¦è®¤è¯
  - å¯†ç å®‰å…¨ç­–ç•¥

### æƒé™ç®¡ç†
- **`permission_management.py`** - æƒé™æ§åˆ¶ç³»ç»Ÿ
  - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
  - é˜Ÿåˆ—æƒé™ç®¡ç†
  - åŠ¨æ€æƒé™æ§åˆ¶
  - æƒé™ç»§æ‰¿æœºåˆ¶

### å®‰å…¨ç›‘æ§
- **`security_monitoring.py`** - å®‰å…¨ç›‘æ§ä¸å®¡è®¡ç³»ç»Ÿ
  - å®‰å…¨äº‹ä»¶ç›‘æ§
  - å®¡è®¡æ—¥å¿—ç®¡ç†
  - å®æ—¶å¨èƒæ£€æµ‹
  - è‡ªåŠ¨å®‰å…¨å“åº”

### å®‰å…¨æ¶ˆæ¯
- **`secure_messaging_demo.py`** - ç«¯åˆ°ç«¯å®‰å…¨æ¶ˆæ¯ç³»ç»Ÿ
  - æ¶ˆæ¯åŠ å¯†è§£å¯†
  - æ•°å­—ç­¾åéªŒè¯
  - è®¿é—®æ§åˆ¶é›†æˆ
  - æ¶ˆæ¯å®Œæ•´æ€§æ£€æŸ¥

## ğŸ” åŠŸèƒ½ç‰¹æ€§

### 1. å¤šå±‚è®¤è¯ä½“ç³»
- **åŸºç¡€è®¤è¯**ï¼šç”¨æˆ·åå¯†ç éªŒè¯
- **Tokenè®¤è¯**ï¼šJWTæ— çŠ¶æ€è®¤è¯
- **è¯ä¹¦è®¤è¯**ï¼šåŸºäºè¯ä¹¦çš„åŒå‘è®¤è¯
- **å¯†ç ç­–ç•¥**ï¼šå¼ºåº¦éªŒè¯ã€è¿‡æœŸç®¡ç†

### 2. ç²¾ç»†æƒé™æ§åˆ¶
- **è§’è‰²ç®¡ç†**ï¼šçµæ´»çš„RBACæ¨¡å‹
- **èµ„æºæƒé™**ï¼šé˜Ÿåˆ—çº§åˆ«çš„è®¿é—®æ§åˆ¶
- **æ“ä½œæƒé™**ï¼šè¯»å†™ç®¡ç†é…ç½®åˆ†ç¦»
- **åŠ¨æ€æˆæƒ**ï¼šè¿è¡Œæ—¶æƒé™è°ƒæ•´

### 3. å…¨æ–¹ä½å®‰å…¨ç›‘æ§
- **äº‹ä»¶è¿½è¸ª**ï¼šæ‰€æœ‰å®‰å…¨äº‹ä»¶çš„è¯¦ç»†è®°å½•
- **å¨èƒæ£€æµ‹**ï¼šå¼‚å¸¸è¡Œä¸ºæ¨¡å¼è¯†åˆ«
- **å®¡è®¡æ—¥å¿—**ï¼šåˆè§„æ€§è¦æ±‚çš„æ•°æ®è®°å½•
- **è‡ªåŠ¨å“åº”**ï¼šåŸºäºè§„åˆ™çš„å®‰å…¨æªæ–½

### 4. ç«¯åˆ°ç«¯å®‰å…¨æ¶ˆæ¯
- **å†…å®¹åŠ å¯†**ï¼šæ¶ˆæ¯ä¼ è¾“å’Œå­˜å‚¨åŠ å¯†
- **æ•°å­—ç­¾å**ï¼šæ¶ˆæ¯å®Œæ•´æ€§å’Œä¸å¯å¦è®¤æ€§
- **è®¿é—®éªŒè¯**ï¼šæ”¶ä»¶äººèº«ä»½ç¡®è®¤
- **å®Œæ•´æ€§æ£€æŸ¥**ï¼šæ¶ˆæ¯ç¯¡æ”¹æ£€æµ‹

## ğŸ¯ æ¼”ç¤ºåœºæ™¯

### è®¤è¯æµç¨‹æ¼”ç¤º
```python
# åŸºç¡€è®¤è¯
python authentication_demo.py

# åŒ…å«åœºæ™¯ï¼š
# - ç”¨æˆ·ç™»å½•è®¤è¯
# - JWT Tokenç”ŸæˆéªŒè¯
# - SSLè¯ä¹¦è®¤è¯
# - å¯†ç ç­–ç•¥éªŒè¯
```

### æƒé™ç®¡ç†æ¼”ç¤º
```python
# æƒé™æ§åˆ¶ç³»ç»Ÿ
python permission_management.py

# åŒ…å«åœºæ™¯ï¼š
# - ç”¨æˆ·è§’è‰²åˆ†é…
# - é˜Ÿåˆ—æƒé™è®¾ç½®
# - åŠ¨æ€æƒé™å˜æ›´
# - æƒé™ç»§æ‰¿æµ‹è¯•
```

### å®‰å…¨ç›‘æ§æ¼”ç¤º
```python
# å®‰å…¨ç›‘æ§ç³»ç»Ÿ
python security_monitoring.py

# åŒ…å«åœºæ™¯ï¼š
# - å®‰å…¨äº‹ä»¶ç›‘æ§
# - å¨èƒæ£€æµ‹ç®—æ³•
# - å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
# - è‡ªåŠ¨åŒ–å“åº”æœºåˆ¶
```

### å®‰å…¨æ¶ˆæ¯æ¼”ç¤º
```python
# ç«¯åˆ°ç«¯å®‰å…¨æ¶ˆæ¯
python secure_messaging_demo.py

# åŒ…å«åœºæ™¯ï¼š
# - æ¶ˆæ¯åŠ å¯†ä¼ è¾“
# - å¤šå®‰å…¨çº§åˆ«å¤„ç†
# - å¹¿æ’­æ¶ˆæ¯å®‰å…¨
# - å®Œæ•´æ€§éªŒè¯
```

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### åŸºç¡€ç¯å¢ƒ
```bash
# Pythonç‰ˆæœ¬
Python 3.7+

# å¿…éœ€åº“å®‰è£…
pip install pyjwt
pip install cryptography
pip install bcrypt
```

### å¯é€‰ç»„ä»¶
```bash
# é«˜çº§å®‰å…¨ç‰¹æ€§
pip install pyOpenSSL  # SSL/TLSæ”¯æŒ
pip install certifi    # è¯ä¹¦ç®¡ç†
pip install pycryptodome  # åŠ å¯†ç®—æ³•
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### 1. å¿«é€Ÿå¼€å§‹

```bash
# è¿›å…¥ä»£ç ç›®å½•
cd rabbitmq/code/chapter7

# è¿è¡Œè®¤è¯æ¼”ç¤º
python authentication_demo.py

# è¿è¡Œæƒé™ç®¡ç†æ¼”ç¤º
python permission_management.py

# è¿è¡Œå®‰å…¨ç›‘æ§æ¼”ç¤º
python security_monitoring.py

# è¿è¡Œå®‰å…¨æ¶ˆæ¯æ¼”ç¤º
python secure_messaging_demo.py
```

### 2. è‡ªå®šä¹‰é…ç½®

```python
# ä¿®æ”¹è®¤è¯é…ç½®
auth_config = {
    'jwt_secret': 'your-secret-key',
    'token_expiry': 3600,
    'password_policy': {
        'min_length': 8,
        'require_uppercase': True,
        'require_numbers': True
    }
}

# ä¿®æ”¹æƒé™é…ç½®
permission_config = {
    'admin_role': {
        'queues': ['*'],
        'operations': ['read', 'write', 'configure']
    }
}

# ä¿®æ”¹å®‰å…¨é…ç½®
security_config = {
    'encryption_algorithm': 'AES-256',
    'signature_algorithm': 'RSA-2048',
    'audit_retention_days': 90
}
```

### 3. é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

```python
# å¯¼å…¥å®‰å…¨ç»„ä»¶
from authentication_demo import BasicAuthDemo
from permission_management import RBACManager
from security_monitoring import SecurityAuditor

# åˆå§‹åŒ–å®‰å…¨ç³»ç»Ÿ
auth_system = BasicAuthDemo()
permission_system = RBACManager()
audit_system = SecurityAuditor()

# åœ¨åº”ç”¨ä¸­ä½¿ç”¨
def secure_message_handler(user_id, message):
    # 1. éªŒè¯ç”¨æˆ·èº«ä»½
    if not auth_system.validate_user(user_id, message.password):
        raise UnauthorizedError("è®¤è¯å¤±è´¥")
    
    # 2. æ£€æŸ¥ç”¨æˆ·æƒé™
    if not permission_system.check_permission(user_id, 'write', message.queue):
        raise PermissionError("æƒé™ä¸è¶³")
    
    # 3. è®°å½•å®¡è®¡æ—¥å¿—
    audit_system.log_access(user_id, message.queue, 'write')
    
    # 4. å¤„ç†æ¶ˆæ¯
    return process_message(message)
```

## âš™ï¸ æ€§èƒ½è°ƒä¼˜

### è®¤è¯æ€§èƒ½ä¼˜åŒ–

```python
# JWTç¼“å­˜é…ç½®
jwt_cache_config = {
    'cache_size': 10000,
    'ttl': 300,  # 5åˆ†é’Ÿç¼“å­˜
    'cleanup_interval': 60  # 1åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
}

# å¯†ç éªŒè¯ä¼˜åŒ–
password_config = {
    'bcrypt_rounds': 12,  # æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´
    'max_attempts': 5,
    'lockout_duration': 300  # 5åˆ†é’Ÿ
}
```

### æƒé™æ£€æŸ¥ä¼˜åŒ–

```python
# æƒé™ç¼“å­˜é…ç½®
permission_cache = {
    'enabled': True,
    'cache_size': 5000,
    'ttl': 600,  # 10åˆ†é’Ÿ
    'invalidation_strategy': 'event_based'
}
```

### å®‰å…¨ç›‘æ§ä¼˜åŒ–

```python
# ç›‘æ§æ€§èƒ½é…ç½®
monitoring_config = {
    'batch_size': 100,      # æ‰¹é‡å¤„ç†å¤§å°
    'flush_interval': 10,   # 10ç§’åˆ·æ–°ä¸€æ¬¡
    'worker_threads': 4,    # å·¥ä½œçº¿ç¨‹æ•°
    'queue_size': 1000      # äº‹ä»¶é˜Ÿåˆ—å¤§å°
}
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### è®¤è¯æŒ‡æ ‡
- **è®¤è¯æˆåŠŸç‡**: æˆåŠŸè®¤è¯æ¬¡æ•° / æ€»è®¤è¯å°è¯•æ¬¡æ•°
- **å¹³å‡è®¤è¯æ—¶é—´**: è®¤è¯è¿‡ç¨‹çš„å¹³å‡è€—æ—¶
- **å¤±è´¥åŸå› åˆ†å¸ƒ**: å„ç§å¤±è´¥åŸå› çš„æ¯”ä¾‹
- **TokenéªŒè¯ç»Ÿè®¡**: JWTéªŒè¯çš„æˆåŠŸç‡å’Œå»¶è¿Ÿ

### æƒé™æŒ‡æ ‡
- **æƒé™æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡**: ç¼“å­˜å‡å°‘çš„æƒé™æ£€æŸ¥æ¬¡æ•°
- **æƒé™å˜æ›´é¢‘ç‡**: æƒé™ä¿®æ”¹çš„é¢‘æ¬¡
- **æ‹’ç»è®¿é—®ç»Ÿè®¡**: æƒé™æ‹’ç»äº‹ä»¶çš„åˆ†å¸ƒ
- **è§’è‰²ä½¿ç”¨æƒ…å†µ**: å„è§’è‰²çš„æ´»è·ƒåº¦

### å®‰å…¨æŒ‡æ ‡
- **å®‰å…¨äº‹ä»¶é¢‘ç‡**: æ¯å•ä½æ—¶é—´çš„å®‰å…¨äº‹ä»¶æ•°
- **å¨èƒæ£€æµ‹å‡†ç¡®æ€§**: è¯¯æŠ¥å’Œæ¼æŠ¥ç‡
- **å“åº”æ—¶é—´**: å®‰å…¨äº‹ä»¶çš„æ£€æµ‹å’Œå“åº”æ—¶é—´
- **å®¡è®¡æ—¥å¿—å¢é•¿**: æ—¥å¿—æ•°æ®çš„å¢é•¿ç‡

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. è®¤è¯å¤±è´¥
```python
# é—®é¢˜ï¼šJWT TokenéªŒè¯å¤±è´¥
# è§£å†³æ–¹æ¡ˆï¼š
# 1. æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®
# 2. éªŒè¯Tokenæ˜¯å¦è¿‡æœŸ
# 3. æ£€æŸ¥ç®—æ³•é…ç½®

jwt_config = {
    'secret': 'correct-secret-key',
    'algorithm': 'HS256',
    'verify_exp': True,
    'verify_nbf': True
}
```

#### 2. æƒé™é”™è¯¯
```python
# é—®é¢˜ï¼šç”¨æˆ·æƒé™ä¸è¶³
# è§£å†³æ–¹æ¡ˆï¼š
# 1. æ£€æŸ¥ç”¨æˆ·è§’è‰²åˆ†é…
# 2. éªŒè¯æƒé™ç¼“å­˜
# 3. ç¡®è®¤èµ„æºè®¿é—®æƒé™

# å¼ºåˆ¶åˆ·æ–°æƒé™ç¼“å­˜
permission_system.clear_cache(user_id)
permission_system.refresh_user_permissions(user_id)
```

#### 3. å®‰å…¨ç›‘æ§å¼‚å¸¸
```python
# é—®é¢˜ï¼šç›‘æ§äº‹ä»¶ä¸¢å¤±
# è§£å†³æ–¹æ¡ˆï¼š
# 1. æ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—çŠ¶æ€
# 2. éªŒè¯å­˜å‚¨ç³»ç»Ÿå¯ç”¨æ€§
# 3. è°ƒæ•´æ‰¹é‡å¤„ç†å‚æ•°

# ç›‘æ§é˜Ÿåˆ—çŠ¶æ€
monitor_status = monitoring_system.get_queue_status()
if monitor_status['pending_events'] > threshold:
    monitoring_system.flush_events()
```

### æ—¥å¿—åˆ†æ

#### è®¤è¯æ—¥å¿—
```bash
# æŸ¥æ‰¾è®¤è¯å¤±è´¥
grep "authentication_failed" security_audit.log | tail -20

# åˆ†æå¤±è´¥åŸå› 
grep -A5 -B5 "invalid_credentials" security_audit.log
```

#### æƒé™æ—¥å¿—
```bash
# æŸ¥çœ‹æƒé™æ‹’ç»äº‹ä»¶
grep "permission_denied" security_audit.log | awk '{print $NF}'

# åˆ†æé«˜é£é™©æ“ä½œ
grep "high_risk_operation" security_audit.log
```

#### å®‰å…¨äº‹ä»¶
```bash
# ç›‘æ§å®‰å…¨å¨èƒ
grep -E "(attack|breach|intrusion)" security_audit.log

# åˆ†æå¼‚å¸¸è¡Œä¸º
grep "suspicious_activity" security_audit.log | tail -10
```

## ğŸ›¡ï¸ æœ€ä½³å®è·µ

### 1. è®¤è¯å®‰å…¨
- **å¼ºå¯†ç ç­–ç•¥**ï¼šè¦æ±‚å¤æ‚å¯†ç å’Œå®šæœŸæ›´æ¢
- **å¤šå› ç´ è®¤è¯**ï¼šç»“åˆå¤šç§è®¤è¯æ–¹å¼
- **Tokenå®‰å…¨**ï¼šçŸ­æœŸTokenå’Œå®‰å…¨å­˜å‚¨
- **ä¼šè¯ç®¡ç†**ï¼šå®‰å…¨çš„ä¼šè¯åˆ›å»ºå’Œé”€æ¯

### 2. æƒé™ç®¡ç†
- **æœ€å°æƒé™åŸåˆ™**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- **å®šæœŸå®¡æŸ¥**ï¼šå‘¨æœŸæ€§æ£€æŸ¥æƒé™åˆ†é…
- **ä¸´æ—¶æƒé™**ï¼šæ—¶æ•ˆæ€§æƒé™æ§åˆ¶
- **éš”ç¦»åŸåˆ™**ï¼šä¸åŒç¯å¢ƒçš„æƒé™åˆ†ç¦»

### 3. ç›‘æ§å‘Šè­¦
- **å¤šå±‚ç›‘æ§**ï¼šä¸åŒå±‚çº§çš„ç›‘æ§è¦†ç›–
- **åŠæ—¶å“åº”**ï¼šå¿«é€Ÿçš„å®‰å…¨äº‹ä»¶å“åº”
- **è¯¯æŠ¥æ§åˆ¶**ï¼šé¿å…è¿‡åº¦å‘Šè­¦
- **å®¡è®¡åˆè§„**ï¼šæ»¡è¶³æ³•è§„è¦æ±‚çš„æ—¥å¿—è®°å½•

### 4. æ•°æ®ä¿æŠ¤
- **ä¼ è¾“åŠ å¯†**ï¼šæ‰€æœ‰é€šä¿¡ä½¿ç”¨TLS/SSL
- **å­˜å‚¨åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **å¯†é’¥ç®¡ç†**ï¼šå®‰å…¨çš„å¯†é’¥ç”Ÿæˆå’Œè½®æ¢
- **è®¿é—®æ§åˆ¶**ï¼šä¸¥æ ¼çš„æ•°æ®è®¿é—®æ§åˆ¶

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [RabbitMQ Authentication](https://www.rabbitmq.com/authentication.html)
- [RabbitMQ Access Control](https://www.rabbitmq.com/access-control.html)
- [RabbitMQ Security](https://www.rabbitmq.com/security.html)

### å®‰å…¨æ ‡å‡†
- [OAuth 2.0](https://oauth.net/2/)
- [JWTæ ‡å‡†](https://tools.ietf.org/html/rfc7519)
- [RBACæ¨¡å‹](https://en.wikipedia.org/wiki/Role-based_access_control)

### æ¨èåº“
- [PyJWT](https://pyjwt.readthedocs.io/) - JWT Tokenå¤„ç†
- [cryptography](https://cryptography.io/) - åŠ å¯†åŠŸèƒ½
- [bcrypt](https://pypi.org/project/bcrypt/) - å¯†ç å“ˆå¸Œ

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-01)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- åŸºç¡€è®¤è¯åŠŸèƒ½
- RBACæƒé™ç®¡ç†
- å®‰å…¨ç›‘æ§æ¡†æ¶
- ç«¯åˆ°ç«¯åŠ å¯†æ¶ˆæ¯

### è®¡åˆ’åŠŸèƒ½
- [ ] é›†æˆç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)
- [ ] æ”¯æŒOAuth 2.0/OIDC
- [ ] æœºå™¨å­¦ä¹ å¨èƒæ£€æµ‹
- [ ] é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„
- [ ] è‡ªåŠ¨åŒ–å®‰å…¨åˆè§„æ£€æŸ¥

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- ğŸ“§ é‚®ç®±ï¼šsecurity@rabbitmq-examples.com
- ğŸ’¬ è®¨è®ºåŒºï¼š[GitHub Issues](https://github.com/rabbitmq-examples/security/issues)
- ğŸ“– æ–‡æ¡£ï¼š[åœ¨çº¿æ–‡æ¡£](https://docs.rabbitmq-examples.com/security)

---

**âš ï¸ é‡è¦æé†’**ï¼šæœ¬ç¤ºä¾‹ä»£ç ä»…ç”¨äºå­¦ä¹ å’Œæ¼”ç¤ºç›®çš„ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ—¶ï¼Œè¯·åŠ¡å¿…ï¼š
1. ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†ç®—æ³•å’Œå¯†é’¥é•¿åº¦
2. éƒ¨ç½²åœ¨å®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸­
3. å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•
4. éµå¾ªç›¸å…³çš„å®‰å…¨åˆè§„è¦æ±‚