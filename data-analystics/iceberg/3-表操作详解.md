# 第三章：Iceberg 表操作详解

在前两章中，我们已经了解了 Apache Iceberg 的基本概念和环境搭建方法。本章我们将深入探讨 Iceberg 表的各种操作，包括创建、查询、更新、删除等，帮助您全面掌握 Iceberg 的核心功能。

## 3.1 Iceberg 表的基本概念

在深入学习表操作之前，我们需要先理解 Iceberg 表的核心概念：

### 3.1.1 表格式（Table Format）

Iceberg 是一种开放的表格式，它定义了如何组织和管理构成表的所有文件。与传统的 Hive 表格式不同，Iceberg 将元数据和数据分离，提供了更好的性能和更强的一致性保证。

### 3.1.2 快照（Snapshot）

Iceberg 中的每次表操作都会产生一个新的快照。快照代表了表在某个时间点的状态，使得 Iceberg 具备了时间旅行（Time Travel）的能力。

### 3.1.3 元数据管理

Iceberg 使用分层的元数据管理结构：
- **表元数据文件**：存储表的 Schema、分区信息、属性等
- **清单文件（Manifest Files）**：记录数据文件的信息
- **数据文件**：实际存储数据的文件（Parquet、ORC 等格式）

## 3.2 创建 Iceberg 表

创建 Iceberg 表是最基础的操作，我们可以通过多种方式来创建表。

### 3.2.1 使用 Spark SQL 创建表

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS iceberg_db;

-- 使用数据库
USE iceberg_db;

-- 创建基础表
CREATE TABLE users (
  id BIGINT COMMENT '用户ID',
  name STRING COMMENT '用户名',
  age INT COMMENT '年龄',
  email STRING COMMENT '邮箱'
) USING iceberg
TBLPROPERTIES ('format-version'='2');
```

### 3.2.2 创建分区表

```sql
-- 创建分区表
CREATE TABLE partitioned_users (
  id BIGINT,
  name STRING,
  age INT,
  email STRING,
  registration_date DATE
) USING iceberg
PARTITIONED BY (registration_date)
TBLPROPERTIES (
  'format-version'='2',
  'write.distribution-mode'='hash'
);
```

### 3.2.3 创建带有复杂数据类型的表

```sql
-- 创建包含复杂数据类型的表
CREATE TABLE user_profiles (
  user_id BIGINT,
  name STRING,
  preferences MAP<STRING, STRING>,
  tags ARRAY<STRING>,
  address STRUCT<street: STRING, city: STRING, zipcode: STRING>
) USING iceberg
TBLPROPERTIES ('format-version'='2');
```

## 3.3 查询 Iceberg 表

Iceberg 提供了丰富的查询能力，支持各种复杂的查询操作。

### 3.3.1 基础查询

```sql
-- 查询所有数据
SELECT * FROM iceberg_db.users;

-- 条件查询
SELECT name, age FROM iceberg_db.users WHERE age > 25;

-- 排序查询
SELECT * FROM iceberg_db.users ORDER BY age DESC;
```

### 3.3.2 聚合查询

```sql
-- 统计查询
SELECT COUNT(*) as total_users FROM iceberg_db.users;

-- 分组统计
SELECT age, COUNT(*) as count FROM iceberg_db.users GROUP BY age;

-- 复杂聚合
SELECT 
  MIN(age) as min_age,
  MAX(age) as max_age,
  AVG(age) as avg_age
FROM iceberg_db.users;
```

### 3.3.3 分区裁剪查询

```sql
-- 利用分区裁剪提高查询性能
SELECT * FROM iceberg_db.partitioned_users 
WHERE registration_date >= '2024-01-01';
```

## 3.4 更新 Iceberg 表

Iceberg 支持 ACID 事务，可以安全地更新表中的数据。

### 3.4.1 更新数据

```sql
-- 更新单条记录
UPDATE iceberg_db.users 
SET email = 'new_email@example.com' 
WHERE id = 1;

-- 批量更新
UPDATE iceberg_db.users 
SET age = age + 1 
WHERE age < 30;
```

### 3.4.2 合并更新（Merge Into）

```sql
-- 使用 Merge Into 进行复杂的更新操作
MERGE INTO iceberg_db.users AS target
USING (
  SELECT 1 as id, 'Updated Name' as name, 26 as age, 'updated@example.com' as email
) AS source
ON target.id = source.id
WHEN MATCHED THEN 
  UPDATE SET name = source.name, age = source.age, email = source.email
WHEN NOT MATCHED THEN 
  INSERT (id, name, age, email) VALUES (source.id, source.name, source.age, source.email);
```

## 3.5 删除 Iceberg 表数据

Iceberg 提供了多种删除数据的方式。

### 3.5.1 条件删除

```sql
-- 删除满足条件的记录
DELETE FROM iceberg_db.users WHERE age < 18;

-- 删除特定记录
DELETE FROM iceberg_db.users WHERE id = 1;
```

### 3.5.2 截断表

```sql
-- 清空表中所有数据
TRUNCATE TABLE iceberg_db.users;
```

## 3.6 时间旅行（Time Travel）

Iceberg 最强大的特性之一就是时间旅行，允许我们查询表在历史任意时间点的状态。

### 3.6.1 基于快照的时间旅行

```sql
-- 查看表的快照历史
SELECT * FROM iceberg_db.users.history;

-- 查询特定快照的数据
SELECT * FROM iceberg_db.users FOR VERSION AS OF 123456789;

-- 查询特定时间点的数据
SELECT * FROM iceberg_db.users FOR TIMESTAMP AS OF '2024-01-01 00:00:00';
```

### 3.6.2 实际应用场景

时间旅行在以下场景中非常有用：
1. **数据恢复**：当误删除数据时，可以回到之前的快照恢复数据
2. **审计查询**：查询历史某个时间点的数据状态
3. **增量处理**：只处理自上次快照以来新增的数据

## 3.7 表结构变更（Schema Evolution）

Iceberg 支持灵活的表结构变更，可以在不影响现有数据的情况下修改表结构。

### 3.7.1 添加列

```sql
-- 添加新的列
ALTER TABLE iceberg_db.users ADD COLUMN phone STRING COMMENT '电话号码';
```

### 3.7.2 修改列

```sql
-- 重命名列
ALTER TABLE iceberg_db.users RENAME COLUMN email TO email_address;

-- 修改列注释
ALTER TABLE iceberg_db.users ALTER COLUMN name COMMENT '用户的全名';
```

### 3.7.3 删除列

```sql
-- 删除列
ALTER TABLE iceberg_db.users DROP COLUMN phone;
```

## 3.8 分区管理

Iceberg 提供了灵活的分区管理功能。

### 3.8.1 创建分区表

```sql
-- 基于日期分区
CREATE TABLE sales_data (
  id BIGINT,
  product STRING,
  amount DECIMAL(10,2),
  sale_time TIMESTAMP
) USING iceberg
PARTITIONED BY (days(sale_time));
```

### 3.8.2 分区转换

```sql
-- 使用分区转换函数
CREATE TABLE logs (
  id BIGINT,
  message STRING,
  log_time TIMESTAMP
) USING iceberg
PARTITIONED BY (hours(log_time), identity(message));
```

## 3.9 表属性管理

Iceberg 表支持丰富的属性配置，可以优化表的性能和行为。

### 3.9.1 设置表属性

```sql
-- 设置表属性
ALTER TABLE iceberg_db.users SET TBLPROPERTIES (
  'write.format.default'='parquet',
  'write.parquet.compression-codec'='zstd',
  'write.distribution-mode'='hash'
);
```

### 3.9.2 查看表属性

```sql
-- 查看表属性
SHOW TBLPROPERTIES iceberg_db.users;
```

## 3.10 最佳实践

### 3.10.1 性能优化建议

1. **合理使用分区**：避免过多的小分区，也避免过少的大分区
2. **定期合并小文件**：使用系统维护命令合并小文件
3. **启用元数据缓存**：在 Spark 中启用 Iceberg 元数据缓存

```sql
-- 合并小文件
CALL iceberg.system.rewrite_data_files(table => 'iceberg_db.users');

-- 重写清单文件
CALL iceberg.system.rewrite_manifests(table => 'iceberg_db.users');
```

### 3.10.2 数据一致性保证

1. **使用事务操作**：确保批量操作的原子性
2. **合理设置隔离级别**：根据业务需求选择合适的隔离级别
3. **监控快照增长**：定期清理不需要的历史快照

## 3.11 本章小结

本章我们详细介绍了 Iceberg 表的各种操作，包括：
- 表的创建、查询、更新、删除
- 时间旅行功能的使用
- 表结构变更和分区管理
- 表属性配置和最佳实践

通过这些内容的学习，您应该能够熟练地使用 Iceberg 进行日常的数据操作。在下一章中，我们将探讨 Iceberg 的高级特性和性能优化技巧。