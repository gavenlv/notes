# ç¬¬2ç« ï¼šDockeråŸºç¡€æ¦‚å¿µæ·±å…¥ç†è§£

## ğŸ“š æœ¬ç« ç›®æ ‡

- æ·±å…¥ç†è§£é•œåƒçš„åˆ†å±‚ç»“æ„å’Œå·¥ä½œåŸç†
- æŒæ¡å®¹å™¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- ç†è§£é•œåƒå’Œå®¹å™¨çš„å…³ç³»
- æŒæ¡å®¹å™¨çš„å„ç§è¿è¡Œæ¨¡å¼
- å­¦ä¹ å®¹å™¨ä¸ä¸»æœºçš„äº¤äº’æ–¹å¼

## 2.1 é•œåƒæ·±å…¥ç†è§£

### 2.1.1 é•œåƒæ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼šé•œåƒæ˜¯ä¸€ä¸ª**åªè¯»**çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡æ¿ï¼ŒåŒ…å«äº†è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ã€‚

**å½¢è±¡æ¯”å–»**ï¼š
```
é•œåƒ = ç±»ï¼ˆClassï¼‰
å®¹å™¨ = å¯¹è±¡ï¼ˆObjectï¼‰

class DockerImage {
    æ“ä½œç³»ç»ŸåŸºç¡€
    + è¿è¡Œæ—¶ç¯å¢ƒ
    + åº”ç”¨ç¨‹åº
    + é…ç½®æ–‡ä»¶
}

Container container1 = new DockerImage();  // åˆ›å»ºå®¹å™¨1
Container container2 = new DockerImage();  // åˆ›å»ºå®¹å™¨2
```

### 2.1.2 é•œåƒçš„åˆ†å±‚ç»“æ„

Dockeré•œåƒä½¿ç”¨**è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion File Systemï¼‰**ï¼Œé‡‡ç”¨åˆ†å±‚ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container Layer (å¯å†™å±‚)           â”‚  â† å®¹å™¨è¿è¡Œæ—¶äº§ç”Ÿçš„æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layer 5: åº”ç”¨ä»£ç             â”‚  â† åªè¯»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layer 4: åº”ç”¨ä¾èµ–            â”‚  â† åªè¯»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layer 3: Python/Node.js      â”‚  â† åªè¯»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layer 2: ç³»ç»Ÿå·¥å…·            â”‚  â† åªè¯»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layer 1: Ubuntu Base         â”‚  â† åªè¯»(åŸºç¡€å±‚)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…ç¤ºä¾‹**ï¼š

```bash
# æŸ¥çœ‹é•œåƒçš„å±‚ä¿¡æ¯
docker history nginx:latest
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
IMAGE          CREATED       CREATED BY                                      SIZE
abc123456789   2 weeks ago   /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemonâ€¦   0B
def987654321   2 weeks ago   /bin/sh -c #(nop)  EXPOSE 80                    0B
ghi456789123   2 weeks ago   /bin/sh -c ln -sf /dev/stdout /var/log/nginxâ€¦   22B
...
```

### 2.1.3 åˆ†å±‚çš„ä¼˜åŠ¿

#### ä¼˜åŠ¿1ï¼šèŠ‚çœå­˜å‚¨ç©ºé—´

```
åœºæ™¯ï¼šè¿è¡Œ3ä¸ªPythonåº”ç”¨

ä¼ ç»Ÿæ–¹å¼ï¼š
â”œâ”€â”€ App1 (Ubuntu + Python + App1) = 500MB
â”œâ”€â”€ App2 (Ubuntu + Python + App2) = 500MB
â””â”€â”€ App3 (Ubuntu + Python + App3) = 500MB
æ€»è®¡ï¼š1500MB

Dockeræ–¹å¼ï¼š
â”œâ”€â”€ Ubuntuå±‚ (100MB)          â† å…±äº«
â”œâ”€â”€ Pythonå±‚ (200MB)          â† å…±äº«
â”œâ”€â”€ App1å±‚ (50MB)
â”œâ”€â”€ App2å±‚ (60MB)
â””â”€â”€ App3å±‚ (40MB)
æ€»è®¡ï¼š450MB  âœ… èŠ‚çœ70%ç©ºé—´ï¼
```

#### ä¼˜åŠ¿2ï¼šåŠ é€Ÿé•œåƒæ„å»º

```bash
# ç¬¬ä¸€æ¬¡æ„å»º
FROM ubuntu:20.04           # éœ€è¦ä¸‹è½½
RUN apt-get update          # éœ€è¦æ‰§è¡Œ
RUN apt-get install python  # éœ€è¦æ‰§è¡Œ
COPY app.py /app/           # éœ€è¦å¤åˆ¶

# ä¿®æ”¹app.pyåé‡æ–°æ„å»º
FROM ubuntu:20.04           # âœ… ä½¿ç”¨ç¼“å­˜
RUN apt-get update          # âœ… ä½¿ç”¨ç¼“å­˜
RUN apt-get install python  # âœ… ä½¿ç”¨ç¼“å­˜
COPY app.py /app/           # âŒ éœ€è¦é‡æ–°æ‰§è¡Œ

åªéœ€é‡æ–°æ‰§è¡Œå˜åŒ–çš„å±‚ï¼
```

#### ä¼˜åŠ¿3ï¼šå¿«é€Ÿåˆ†å‘

```
Docker Hub â†’ ä½ çš„ç”µè„‘

å·²æœ‰é•œåƒï¼š
âœ… Ubuntuå±‚ (å·²å­˜åœ¨ï¼Œä¸ä¸‹è½½)
âœ… Pythonå±‚ (å·²å­˜åœ¨ï¼Œä¸ä¸‹è½½)
âŒ æ–°åº”ç”¨å±‚ (éœ€è¦ä¸‹è½½ 50MB)

åªä¸‹è½½å·®å¼‚éƒ¨åˆ†ï¼
```

### 2.1.4 é•œåƒçš„å‘½åè§„åˆ™

**å®Œæ•´æ ¼å¼**ï¼š
```
[registry]/[namespace]/[repository]:[tag]

ç¤ºä¾‹ï¼š
docker.io/library/nginx:1.21.6
â”‚        â”‚      â”‚      â”‚    â””â”€â”€ æ ‡ç­¾(ç‰ˆæœ¬)
â”‚        â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€ ä»“åº“å
â”‚        â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘½åç©ºé—´
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é•œåƒä»“åº“åœ°å€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é»˜è®¤ä¸ºdocker.io
```

**å¸¸è§æ ¼å¼**ï¼š

| æ ¼å¼ | å®Œæ•´å½¢å¼ | è¯´æ˜ |
|------|----------|------|
| `nginx` | `docker.io/library/nginx:latest` | å®˜æ–¹é•œåƒï¼Œæœ€æ–°ç‰ˆ |
| `nginx:1.21` | `docker.io/library/nginx:1.21` | å®˜æ–¹é•œåƒï¼ŒæŒ‡å®šç‰ˆæœ¬ |
| `mysql:8.0` | `docker.io/library/mysql:8.0` | MySQL 8.0ç‰ˆæœ¬ |
| `username/myapp` | `docker.io/username/myapp:latest` | ç”¨æˆ·è‡ªå®šä¹‰é•œåƒ |
| `gcr.io/project/image` | `gcr.io/project/image:latest` | Googleå®¹å™¨é•œåƒ |

**å®éªŒ**ï¼š

```bash
# è¿™äº›å‘½ä»¤æ˜¯ç­‰ä»·çš„
docker pull nginx
docker pull nginx:latest
docker pull docker.io/library/nginx:latest

# æŸ¥çœ‹æœ¬åœ°é•œåƒ
docker images nginx

# è¾“å‡º
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
nginx        latest    abc123456789   2 weeks ago   142MB
```

### 2.1.5 é•œåƒçš„å®é™…æ“ä½œ

#### æœç´¢é•œåƒ

```bash
# æœç´¢é•œåƒ
docker search python

# é™åˆ¶ç»“æœæ•°é‡
docker search --limit 5 python

# åªæ˜¾ç¤ºå®˜æ–¹é•œåƒ
docker search --filter is-official=true python
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
NAME                 DESCRIPTION                     STARS     OFFICIAL
python               Python is an interpreted...      8000      [OK]
pypy                 PyPy is a fast...               500       [OK]
```

#### æ‹‰å–é•œåƒ

```bash
# æ‹‰å–æœ€æ–°ç‰ˆæœ¬
docker pull python

# æ‹‰å–æŒ‡å®šç‰ˆæœ¬
docker pull python:3.9

# æ‹‰å–ç‰¹å®šå¹³å°
docker pull --platform linux/amd64 python:3.9

# æŸ¥çœ‹æ‹‰å–è¿›åº¦
docker pull ubuntu
```

**æ‹‰å–è¿‡ç¨‹è§£æ**ï¼š
```
Using default tag: latest
latest: Pulling from library/ubuntu

sha256:abc123... Pull complete  â† Layer 1ä¸‹è½½å®Œæˆ
sha256:def456... Pull complete  â† Layer 2ä¸‹è½½å®Œæˆ
sha256:ghi789... Pull complete  â† Layer 3ä¸‹è½½å®Œæˆ

Digest: sha256:...
Status: Downloaded newer image for ubuntu:latest
```

#### æŸ¥çœ‹é•œåƒ

```bash
# åˆ—å‡ºæ‰€æœ‰é•œåƒ
docker images

# åˆ—å‡ºæŒ‡å®šé•œåƒ
docker images python

# æŸ¥çœ‹é•œåƒè¯¦ç»†ä¿¡æ¯
docker inspect python:3.9

# æŸ¥çœ‹é•œåƒåˆ†å±‚å†å²
docker history python:3.9

# æ˜¾ç¤ºé•œåƒæ‘˜è¦
docker images --digests
```

#### åˆ é™¤é•œåƒ

```bash
# åˆ é™¤å•ä¸ªé•œåƒ
docker rmi nginx

# åˆ é™¤å¤šä¸ªé•œåƒ
docker rmi nginx mysql redis

# é€šè¿‡IDåˆ é™¤
docker rmi abc123456789

# å¼ºåˆ¶åˆ é™¤ï¼ˆå³ä½¿æœ‰å®¹å™¨åœ¨ä½¿ç”¨ï¼‰
docker rmi -f nginx

# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ
docker image prune

# åˆ é™¤æ‰€æœ‰é•œåƒ
docker image prune -a
```

**æ³¨æ„äº‹é¡¹**ï¼š
```bash
# å¦‚æœæœ‰å®¹å™¨åœ¨ä½¿ç”¨é•œåƒï¼Œæ— æ³•åˆ é™¤
docker rmi nginx
# Error: conflict: unable to remove repository reference "nginx" (must force) - container abc123 is using its referenced image def456

# è§£å†³æ–¹æ¡ˆ1ï¼šå…ˆåˆ é™¤å®¹å™¨
docker rm -f <container_id>
docker rmi nginx

# è§£å†³æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶åˆ é™¤
docker rmi -f nginx
```

## 2.2 å®¹å™¨æ·±å…¥ç†è§£

### 2.2.1 å®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼šå®¹å™¨æ˜¯é•œåƒè¿è¡Œæ—¶çš„å®ä½“ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§ã€ç‹¬ç«‹çš„å¯æ‰§è¡Œè½¯ä»¶åŒ…ã€‚

**å®¹å™¨ vs é•œåƒ**ï¼š

| ç‰¹æ€§ | é•œåƒ | å®¹å™¨ |
|------|------|------|
| **æœ¬è´¨** | åªè¯»æ¨¡æ¿ | è¿è¡Œå®ä¾‹ |
| **çŠ¶æ€** | é™æ€ | åŠ¨æ€ |
| **å¯ä¿®æ”¹æ€§** | ä¸å¯ä¿®æ”¹ | å¯è¯»å†™ |
| **ç±»æ¯”** | ç¨‹åºå®‰è£…åŒ… | æ­£åœ¨è¿è¡Œçš„ç¨‹åº |
| **æ•°é‡å…³ç³»** | ä¸€ä¸ªé•œåƒ | å¯åˆ›å»ºå¤šä¸ªå®¹å™¨ |

**å½¢è±¡ç†è§£**ï¼š
```
é•œåƒ = å»ºç­‘è®¾è®¡å›¾çº¸ï¼ˆä¸èƒ½ä½äººï¼‰
å®¹å™¨ = æ ¹æ®å›¾çº¸å»ºé€ çš„æˆ¿å­ï¼ˆå¯ä»¥ä½äººï¼‰

ä¸€å¼ å›¾çº¸ â†’ å¯ä»¥å»ºé€ å¤šæ ‹ç›¸åŒçš„æˆ¿å­
```

### 2.2.2 å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ

```
   åˆ›å»º â†’ å¯åŠ¨ â†’ è¿è¡Œ â†’ æš‚åœ â†’ æ¢å¤ â†’ åœæ­¢ â†’ åˆ é™¤
   
   docker    docker   running   docker    docker    docker   docker
   create    start             pause     unpause   stop     rm
     â”‚         â”‚        â”‚         â”‚         â”‚         â”‚        â”‚
     â†“         â†“        â†“         â†“         â†“         â†“        â†“
  Created    Up      Running   Paused    Running   Exited   Removed
```

**è¯¦ç»†çŠ¶æ€è½¬æ¢**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é•œåƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ docker create / docker run
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Created    â”‚ â† å®¹å™¨å·²åˆ›å»ºï¼Œä½†æœªå¯åŠ¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ docker start
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Running   â”‚ â† å®¹å™¨æ­£åœ¨è¿è¡Œ
â””â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚    â”‚ docker pause
   â”‚    â†“
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  â”‚   Paused    â”‚ â† å®¹å™¨æš‚åœ
   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚         â”‚ docker unpause
   â”‚         â†“
   â”‚ docker stop
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Exited    â”‚ â† å®¹å™¨å·²åœæ­¢
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ docker rm
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Removed   â”‚ â† å®¹å™¨å·²åˆ é™¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2.3 å®¹å™¨çš„è¿è¡Œæ¨¡å¼

#### æ¨¡å¼1ï¼šå‰å°è¿è¡Œæ¨¡å¼

```bash
# å‰å°è¿è¡Œï¼ˆä¼šå ç”¨ç»ˆç«¯ï¼‰
docker run ubuntu echo "Hello Docker"

# æ‰§è¡Œæµç¨‹ï¼š
# 1. åˆ›å»ºå®¹å™¨
# 2. æ‰§è¡Œå‘½ä»¤
# 3. è¾“å‡ºç»“æœ
# 4. å®¹å™¨è‡ªåŠ¨åœæ­¢
# 5. è¿”å›ç»ˆç«¯
```

#### æ¨¡å¼2ï¼šåå°è¿è¡Œæ¨¡å¼

```bash
# åå°è¿è¡Œï¼ˆ-då‚æ•°ï¼‰
docker run -d nginx

# è¾“å‡ºå®¹å™¨ID
abc1234567890...

# ç‰¹ç‚¹ï¼š
# âœ… ä¸å ç”¨ç»ˆç«¯
# âœ… åœ¨åå°æŒç»­è¿è¡Œ
# âœ… å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–å‘½ä»¤
```

#### æ¨¡å¼3ï¼šäº¤äº’æ¨¡å¼

```bash
# äº¤äº’æ¨¡å¼ï¼ˆ-itå‚æ•°ï¼‰
docker run -it ubuntu bash

# -i: interactiveï¼Œä¿æŒSTDINæ‰“å¼€
# -t: ttyï¼Œåˆ†é…ä¼ªç»ˆç«¯

# è¿›å…¥å®¹å™¨shell
root@abc123456789:/# ls
root@abc123456789:/# pwd
root@abc123456789:/# exit  # é€€å‡ºå®¹å™¨
```

#### æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å‘½ä»¤ | ä½¿ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|------|------|----------|------|
| **å‰å°** | `docker run ubuntu echo "hi"` | æ‰§è¡Œå•ä¸ªå‘½ä»¤ | æ‰§è¡Œå®Œå³åœæ­¢ |
| **åå°** | `docker run -d nginx` | é•¿æœŸè¿è¡Œçš„æœåŠ¡ | æŒç»­åœ¨åå°è¿è¡Œ |
| **äº¤äº’** | `docker run -it ubuntu bash` | è°ƒè¯•ã€ä¸´æ—¶æ“ä½œ | å¯ä»¥äº¤äº’æ“ä½œ |
| **åå°+äº¤äº’** | `docker run -dit ubuntu bash` | éœ€è¦æ—¶è¿›å…¥çš„æœåŠ¡ | å¯ä»¥åç»­attach |

### 2.2.4 å®¹å™¨çš„åŸºæœ¬æ“ä½œ

#### åˆ›å»ºå®¹å™¨

```bash
# docker create: åˆ›å»ºä½†ä¸å¯åŠ¨
docker create --name my-nginx nginx

# æŸ¥çœ‹çŠ¶æ€
docker ps -a
# STATUS: Created  â† å·²åˆ›å»ºä½†æœªå¯åŠ¨
```

#### å¯åŠ¨å®¹å™¨

```bash
# å¯åŠ¨å·²åˆ›å»ºçš„å®¹å™¨
docker start my-nginx

# å¯åŠ¨å¹¶é™„åŠ åˆ°å®¹å™¨ï¼ˆæŸ¥çœ‹è¾“å‡ºï¼‰
docker start -a my-nginx

# å¯åŠ¨å¹¶è¿›å…¥äº¤äº’æ¨¡å¼
docker start -i my-nginx
```

#### è¿è¡Œå®¹å™¨

```bash
# docker run = docker create + docker start

# åŸºæœ¬è¿è¡Œ
docker run nginx

# åå°è¿è¡Œ
docker run -d nginx

# äº¤äº’è¿è¡Œ
docker run -it ubuntu bash

# è‡ªåŠ¨åˆ é™¤
docker run --rm ubuntu echo "hi"
```

#### æŸ¥çœ‹å®¹å™¨

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a

# åªæ˜¾ç¤ºå®¹å™¨ID
docker ps -q

# è‡ªå®šä¹‰æ ¼å¼æ˜¾ç¤º
docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}"

# è¿‡æ»¤æ˜¾ç¤º
docker ps --filter "status=running"
docker ps --filter "name=nginx"
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES
abc123456789   nginx     "/docker-entrypoint.â€¦"   5 minutes ago   Up 5 minutes   80/tcp    my-nginx
```

#### åœæ­¢å®¹å™¨

```bash
# ä¼˜é›…åœæ­¢ï¼ˆå‘é€SIGTERMä¿¡å·ï¼Œç­‰å¾…10ç§’ï¼‰
docker stop my-nginx

# ç«‹å³åœæ­¢ï¼ˆå‘é€SIGKILLä¿¡å·ï¼‰
docker kill my-nginx

# åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
docker stop $(docker ps -q)

# é‡å¯å®¹å™¨
docker restart my-nginx
```

**åœæ­¢è¿‡ç¨‹**ï¼š
```
docker stop:
1. å‘é€ SIGTERM ä¿¡å·
2. ç­‰å¾…å®¹å™¨ä¼˜é›…å…³é—­ï¼ˆé»˜è®¤10ç§’ï¼‰
3. å¦‚æœè¶…æ—¶ï¼Œå‘é€ SIGKILL å¼ºåˆ¶å…³é—­

docker kill:
1. ç›´æ¥å‘é€ SIGKILL ä¿¡å·
2. ç«‹å³å¼ºåˆ¶å…³é—­
```

#### æš‚åœå’Œæ¢å¤

```bash
# æš‚åœå®¹å™¨ï¼ˆå†»ç»“è¿›ç¨‹ï¼‰
docker pause my-nginx

# æ¢å¤å®¹å™¨
docker unpause my-nginx

# åº”ç”¨åœºæ™¯ï¼š
# - ä¸´æ—¶é‡Šæ”¾CPUèµ„æº
# - è°ƒè¯•æ—¶æš‚åœåº”ç”¨
# - å¿«ç…§å¤‡ä»½å‰æš‚åœ
```

#### åˆ é™¤å®¹å™¨

```bash
# åˆ é™¤åœæ­¢çš„å®¹å™¨
docker rm my-nginx

# å¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨
docker rm -f my-nginx

# åˆ é™¤å¤šä¸ªå®¹å™¨
docker rm container1 container2 container3

# åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨
docker container prune

# åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬è¿è¡Œä¸­çš„ï¼‰
docker rm -f $(docker ps -aq)
```

### 2.2.5 è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨

#### æ–¹æ³•1ï¼šdocker execï¼ˆæ¨èï¼‰

```bash
# åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
docker exec my-nginx ls /etc/nginx

# è¿›å…¥å®¹å™¨bash
docker exec -it my-nginx bash

# æ‰§è¡Œåå°ä»»åŠ¡
docker exec -d my-nginx touch /tmp/test.txt

# ç‰¹ç‚¹ï¼š
# âœ… ä¸ä¼šå½±å“å®¹å™¨ä¸»è¿›ç¨‹
# âœ… é€€å‡ºæ—¶å®¹å™¨ç»§ç»­è¿è¡Œ
# âœ… å¯ä»¥å¯åŠ¨å¤šä¸ªexecä¼šè¯
```

#### æ–¹æ³•2ï¼šdocker attach

```bash
# é™„åŠ åˆ°å®¹å™¨çš„ä¸»è¿›ç¨‹
docker attach my-nginx

# ç‰¹ç‚¹ï¼š
# âš ï¸  é™„åŠ åˆ°å®¹å™¨çš„ä¸»è¿›ç¨‹
# âš ï¸  é€€å‡ºæ—¶å¯èƒ½å¯¼è‡´å®¹å™¨åœæ­¢
# âš ï¸  å¤šä¸ªattachä¼šè¯çœ‹åˆ°ç›¸åŒè¾“å‡º
```

#### exec vs attach å¯¹æ¯”

| ç‰¹æ€§ | docker exec | docker attach |
|------|-------------|---------------|
| **è¿æ¥å¯¹è±¡** | å¯åŠ¨æ–°è¿›ç¨‹ | è¿æ¥åˆ°ä¸»è¿›ç¨‹ |
| **é€€å‡ºå½±å“** | å®¹å™¨ç»§ç»­è¿è¡Œ | å¯èƒ½å¯¼è‡´å®¹å™¨åœæ­¢ |
| **ä½¿ç”¨åœºæ™¯** | è°ƒè¯•ã€æ‰§è¡Œå‘½ä»¤ | æŸ¥çœ‹åº”ç”¨è¾“å‡º |
| **æ¨èåº¦** | â­â­â­â­â­ | â­â­ |

**å®é™…ç¤ºä¾‹**ï¼š

```bash
# å¯åŠ¨ä¸€ä¸ªnginxå®¹å™¨
docker run -d --name web nginx

# ä½¿ç”¨execè¿›å…¥ï¼ˆæ¨èï¼‰
docker exec -it web bash
root@container# ls /etc/nginx
root@container# exit  # å®¹å™¨ç»§ç»­è¿è¡Œ âœ…

# ä½¿ç”¨attachæŸ¥çœ‹è¾“å‡º
docker attach web
# çœ‹åˆ°nginxçš„è®¿é—®æ—¥å¿—
# Ctrl+C é€€å‡º â†’ å®¹å™¨åœæ­¢ âš ï¸
```

### 2.2.6 å®¹å™¨æ—¥å¿—ç®¡ç†

#### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å…¨éƒ¨æ—¥å¿—
docker logs my-nginx

# å®æ—¶è·Ÿè¸ªæ—¥å¿—ï¼ˆç±»ä¼¼tail -fï¼‰
docker logs -f my-nginx

# æ˜¾ç¤ºæœ€å100è¡Œ
docker logs --tail 100 my-nginx

# æ˜¾ç¤ºæ—¶é—´æˆ³
docker logs -t my-nginx

# æŸ¥çœ‹æœ€è¿‘10åˆ†é’Ÿçš„æ—¥å¿—
docker logs --since 10m my-nginx

# æŸ¥çœ‹æŒ‡å®šæ—¶é—´èŒƒå›´
docker logs --since "2024-01-01T10:00:00" --until "2024-01-01T11:00:00" my-nginx
```

**å®é™…åº”ç”¨**ï¼š

```bash
# è°ƒè¯•Webåº”ç”¨
docker logs -f --tail 50 web-app

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs web-app 2>&1 | grep ERROR

# å¯¼å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
docker logs web-app > /tmp/app.log 2>&1
```

### 2.2.7 å®¹å™¨èµ„æºä½¿ç”¨

#### æŸ¥çœ‹èµ„æºç»Ÿè®¡

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹æŒ‡å®šå®¹å™¨
docker stats my-nginx

# åªæ˜¾ç¤ºä¸€æ¬¡ï¼ˆä¸æŒç»­åˆ·æ–°ï¼‰
docker stats --no-stream

# è‡ªå®šä¹‰æ ¼å¼
docker stats --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
CONTAINER ID   NAME       CPU %     MEM USAGE / LIMIT     MEM %     NET I/O
abc123456789   my-nginx   0.00%     2.5MiB / 7.775GiB     0.03%     1kB / 0B
```

#### é™åˆ¶å®¹å™¨èµ„æº

```bash
# é™åˆ¶å†…å­˜
docker run -d -m 512m --name limited-nginx nginx

# é™åˆ¶CPU
docker run -d --cpus="1.5" --name cpu-limited nginx

# é™åˆ¶å†…å­˜å’Œswap
docker run -d -m 512m --memory-swap 1g --name mem-nginx nginx

# è®¾ç½®CPUä¼˜å…ˆçº§
docker run -d --cpu-shares 512 --name low-priority nginx
```

### 2.2.8 å®¹å™¨çš„ç½‘ç»œè®¿é—®

#### ç«¯å£æ˜ å°„

```bash
# æ˜ å°„å•ä¸ªç«¯å£
docker run -d -p 8080:80 nginx
# ä¸»æœº8080ç«¯å£ â†’ å®¹å™¨80ç«¯å£

# æ˜ å°„å¤šä¸ªç«¯å£
docker run -d -p 8080:80 -p 8443:443 nginx

# æ˜ å°„åˆ°éšæœºç«¯å£
docker run -d -p 80 nginx

# æŸ¥çœ‹ç«¯å£æ˜ å°„
docker port my-nginx
```

**ç«¯å£æ˜ å°„åŸç†**ï¼š

```
å¤–éƒ¨è¯·æ±‚                     Dockerä¸»æœº                    å®¹å™¨
   â”‚                            â”‚                          â”‚
   â”‚  http://localhost:8080     â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
   â”‚                            â”‚ iptablesè½¬å‘             â”‚
   â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                            â”‚                          â”‚
   â”‚                            â”‚      å®¹å™¨IP:80           â”‚
   â”‚                            â”‚                          â”‚
```

## 2.3 å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ

### 2.3.1 å®¹å™¨çš„åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ

```
å®¹å™¨è¿è¡Œæ—¶çš„æ–‡ä»¶ç³»ç»Ÿï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container Layer (è¯»å†™å±‚)           â”‚
â”‚  - /app/data/logs/                  â”‚  â† å®¹å™¨è¿è¡Œæ—¶äº§ç”Ÿ
â”‚  - /tmp/cache/                      â”‚  â† å¯ä»¥è¯»å†™
â”‚  - ä¿®æ”¹çš„é…ç½®æ–‡ä»¶                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Image Layers (åªè¯»å±‚)              â”‚
â”‚  - åº”ç”¨ç¨‹åº                         â”‚  â† æ¥è‡ªé•œåƒ
â”‚  - ç³»ç»Ÿæ–‡ä»¶                         â”‚  â† åªè¯»
â”‚  - é…ç½®æ–‡ä»¶                         â”‚  â† ä¸å¯ä¿®æ”¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3.2 Copy-on-Write ç­–ç•¥

**å†™æ—¶å¤åˆ¶æœºåˆ¶**ï¼š

```
åœºæ™¯ï¼šå®¹å™¨è¦ä¿®æ”¹é•œåƒä¸­çš„æ–‡ä»¶

æ­¥éª¤ï¼š
1. æ–‡ä»¶åœ¨åªè¯»å±‚ â†’ å¤åˆ¶åˆ°å¯å†™å±‚
2. åœ¨å¯å†™å±‚ä¿®æ”¹æ–‡ä»¶
3. å®¹å™¨çœ‹åˆ°ä¿®æ”¹åçš„æ–‡ä»¶
4. é•œåƒå±‚ä¿æŒä¸å˜

ç¤ºä¾‹ï¼š
# é•œåƒä¸­çš„/etc/nginx/nginx.conf
â”œâ”€â”€ Image Layer (åªè¯»)
â”‚   â””â”€â”€ nginx.conf (åŸå§‹æ–‡ä»¶)
â”‚
# å®¹å™¨ä¸­ä¿®æ”¹é…ç½®
â”œâ”€â”€ Container Layer (å¯å†™)
â”‚   â””â”€â”€ nginx.conf (ä¿®æ”¹åçš„æ–‡ä»¶)  â† å®¹å™¨ä½¿ç”¨è¿™ä¸ª
â”‚
â”œâ”€â”€ Image Layer (åªè¯»)
â”‚   â””â”€â”€ nginx.conf (åŸå§‹æ–‡ä»¶ä¿æŒä¸å˜)
```

### 2.3.3 å®¹å™¨ä¸ä¸»æœºçš„æ–‡ä»¶äº¤äº’

#### æ–¹æ³•1ï¼šdocker cp å¤åˆ¶æ–‡ä»¶

```bash
# ä»ä¸»æœºå¤åˆ¶åˆ°å®¹å™¨
docker cp /path/on/host/file.txt my-container:/path/in/container/

# ä»å®¹å™¨å¤åˆ¶åˆ°ä¸»æœº
docker cp my-container:/path/in/container/file.txt /path/on/host/

# å¤åˆ¶ç›®å½•
docker cp /local/dir my-container:/container/dir

# å®é™…ç¤ºä¾‹
docker cp index.html my-nginx:/usr/share/nginx/html/
```

#### æ–¹æ³•2ï¼šVolume æ•°æ®å·ï¼ˆä¸‹ä¸€ç« è¯¦è§£ï¼‰

```bash
# æŒ‚è½½ä¸»æœºç›®å½•åˆ°å®¹å™¨
docker run -v /host/path:/container/path nginx
```

## 2.4 å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šé•œåƒåˆ†å±‚æ¢ç´¢

```bash
# 1. æ‹‰å–ä¸€ä¸ªé•œåƒ
docker pull nginx:latest

# 2. æŸ¥çœ‹é•œåƒå†å²
docker history nginx:latest

# 3. æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
docker inspect nginx:latest

# 4. ç†è§£æ¯ä¸€å±‚çš„ä½œç”¨
```

### ç»ƒä¹ 2ï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸå®éªŒ

```bash
# 1. åˆ›å»ºå®¹å™¨ï¼ˆä¸å¯åŠ¨ï¼‰
docker create --name lifecycle-test nginx

# 2. æŸ¥çœ‹çŠ¶æ€
docker ps -a | grep lifecycle-test

# 3. å¯åŠ¨å®¹å™¨
docker start lifecycle-test

# 4. æš‚åœå®¹å™¨
docker pause lifecycle-test

# 5. æ¢å¤å®¹å™¨
docker unpause lifecycle-test

# 6. åœæ­¢å®¹å™¨
docker stop lifecycle-test

# 7. åˆ é™¤å®¹å™¨
docker rm lifecycle-test
```

### ç»ƒä¹ 3ï¼šå¤šå®¹å™¨ç®¡ç†

```bash
# å¯åŠ¨3ä¸ªnginxå®¹å™¨ï¼Œæ˜ å°„ä¸åŒç«¯å£
docker run -d -p 8081:80 --name web1 nginx
docker run -d -p 8082:80 --name web2 nginx
docker run -d -p 8083:80 --name web3 nginx

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# æ‰¹é‡åœæ­¢
docker stop web1 web2 web3

# æ‰¹é‡åˆ é™¤
docker rm web1 web2 web3
```

## 2.5 æœ¬ç« æ€»ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

âœ… **é•œåƒæ·±å…¥ç†è§£**
- åˆ†å±‚ç»“æ„
- Union File System
- é•œåƒå‘½åè§„åˆ™
- é•œåƒåŸºæœ¬æ“ä½œ

âœ… **å®¹å™¨æ·±å…¥ç†è§£**
- å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
- è¿è¡Œæ¨¡å¼ï¼ˆå‰å°/åå°/äº¤äº’ï¼‰
- å®¹å™¨åŸºæœ¬æ“ä½œ
- è¿›å…¥å®¹å™¨çš„æ–¹æ³•

âœ… **å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ**
- åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ
- Copy-on-Writeæœºåˆ¶
- æ–‡ä»¶äº¤äº’æ–¹å¼

âœ… **èµ„æºç®¡ç†**
- æ—¥å¿—æŸ¥çœ‹
- èµ„æºç›‘æ§
- èµ„æºé™åˆ¶

### ä¸‹ä¸€ç« é¢„å‘Š

åœ¨[ç¬¬3ç« ï¼šDockeré•œåƒç®¡ç†](../chapter03-image-management/README.md)ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š
- å¦‚ä½•æ„å»ºè‡ªå®šä¹‰é•œåƒ
- Dockerfileçš„ç¼–å†™
- é•œåƒä¼˜åŒ–æŠ€å·§
- é•œåƒçš„å¯¼å…¥å¯¼å‡º

---

**ç»§ç»­æ·±å…¥å­¦ä¹ Dockerï¼ğŸš€**
