# ç¬¬4ç« ï¼šç½‘ç»œä¸å®‰å…¨æœåŠ¡

## ğŸ“š æœ¬ç« å¯¼å­¦

ç½‘ç»œå’Œå®‰å…¨æ˜¯äº‘åŸºç¡€è®¾æ–½çš„åŸºç¡€ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºçš„é«˜å¯ç”¨æ€§ã€é«˜æ€§èƒ½å’Œæ•°æ®ä¿æŠ¤ã€‚Google Cloud Platformæä¾›äº†å¼ºå¤§çš„ç½‘ç»œå’Œå®‰å…¨æœåŠ¡ï¼Œå¸®åŠ©æ‚¨æ„å»ºå®‰å…¨å¯é çš„åº”ç”¨æ¶æ„ã€‚æœ¬ç« å°†è¯¦ç»†ä»‹ç»GCPçš„ç½‘ç»œæ¶æ„ã€å®‰å…¨æœåŠ¡å’Œæœ€ä½³å®è·µã€‚

### ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- ç†è§£GCPç½‘ç»œæ¶æ„å’ŒVPCç½‘ç»œçš„æ ¸å¿ƒæ¦‚å¿µ
- æŒæ¡VPCç½‘ç»œçš„åˆ›å»ºã€é…ç½®å’Œç®¡ç†
- å­¦ä¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ä¼˜åŒ–åº”ç”¨æ€§èƒ½å’Œå¯ç”¨æ€§
- äº†è§£GCPå®‰å…¨æœåŠ¡çš„åŠŸèƒ½å’Œé…ç½®æ–¹æ³•
- æŒæ¡èº«ä»½å’Œè®¿é—®ç®¡ç†(IAM)çš„æœ€ä½³å®è·µ
- èƒ½å¤Ÿè®¾è®¡å’Œå®ç°å®‰å…¨çš„äº‘åº”ç”¨æ¶æ„

### ğŸ“– æœ¬ç« å†…å®¹æ¦‚è§ˆ

1. [GCPç½‘ç»œæ¶æ„åŸºç¡€](#1-gcpç½‘ç»œæ¶æ„åŸºç¡€)
2. [VPCç½‘ç»œè¯¦è§£](#2-vpcç½‘ç»œè¯¦è§£)
3. [è´Ÿè½½å‡è¡¡ä¸CDN](#3-è´Ÿè½½å‡è¡¡ä¸cdn)
4. [èº«ä»½å’Œè®¿é—®ç®¡ç†(IAM)](##4-èº«ä»½å’Œè®¿é—®ç®¡ç†iam)
5. [å®‰å…¨æœåŠ¡ä¸åˆè§„æ€§](#5-å®‰å…¨æœåŠ¡ä¸åˆè§„æ€§)
6. [å®éªŒï¼šæ„å»ºå®‰å…¨é«˜å¯ç”¨æ¶æ„](#6-å®éªŒæ„å»ºå®‰å…¨é«˜å¯ç”¨æ¶æ„)

---

## 1. GCPç½‘ç»œæ¶æ„åŸºç¡€

### 1.1 GCPç½‘ç»œæ¨¡å‹

GCPé‡‡ç”¨äº†è½¯ä»¶å®šä¹‰ç½‘ç»œ(SDN)æ¶æ„ï¼Œæä¾›äº†çµæ´»ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- **å…¨å±€VPCç½‘ç»œ**ï¼šå•ä¸ªç½‘ç»œå¯è·¨è¶Šå¤šä¸ªåŒºåŸŸ
- **è½¯ä»¶å®šä¹‰**ï¼šé€šè¿‡è½¯ä»¶æ§åˆ¶ç½‘ç»œè¡Œä¸ºï¼Œæ— éœ€ç‰©ç†é…ç½®
- **é«˜æ€§èƒ½**ï¼šä½¿ç”¨Googleå…¨çƒå…‰çº¤ç½‘ç»œï¼Œä½å»¶è¿Ÿé«˜å¸¦å®½
- **è‡ªåŠ¨æ‰©å±•**ï¼šç½‘ç»œéšåŸºç¡€è®¾æ–½è‡ªåŠ¨æ‰©å±•
- **å®‰å…¨æ€§**ï¼šå†…ç½®é˜²ç«å¢™å’Œéš”ç¦»æœºåˆ¶

#### ç½‘ç»œå±‚æ¬¡ç»“æ„

```mermaid
graph TB
    A[å…¨çƒç½‘ç»œåŸºç¡€è®¾æ–½] --> B[å…¨çƒè´Ÿè½½å‡è¡¡å™¨]
    A --> C[åŒºåŸŸç½‘ç»œ]
    C --> D[å¯ç”¨åŒºç½‘ç»œ]
    C --> E[å­ç½‘]
    
    D --> F[å®ä¾‹]
    E --> G[å®ä¾‹]
    
    B --> H[è¾¹ç¼˜èŠ‚ç‚¹]
    H --> I[ç”¨æˆ·]
```

### 1.2 IPåœ°å€ç®¡ç†

GCPæä¾›äº†å¤šç§IPåœ°å€ç±»å‹ï¼š

| IPç±»å‹ | èŒƒå›´ | ä½¿ç”¨æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|----------|
| **å†…éƒ¨IPåœ°å€** | RFC 1918ç§æœ‰åœ°å€ | è‡ªåŠ¨åˆ†é…æˆ–é™æ€æŒ‡å®š | å®ä¾‹é—´é€šä¿¡ |
| **å¤–éƒ¨ä¸´æ—¶IP** | å…¬å…±IPæ±  | è‡ªåŠ¨åˆ†é… | ä¸´æ—¶éœ€è¦å¤–ç½‘è®¿é—® |
| **å¤–éƒ¨é™æ€IP** | å…¬å…±IPæ±  | é¢„ç•™å¹¶ç»‘å®š | éœ€è¦ç¨³å®šå…¬ç½‘IPçš„æœåŠ¡ |
| **å…¨å±€é™æ€IP** | å…¬å…±IPæ±  | å…¨çƒè´Ÿè½½å‡è¡¡ | å…¨çƒè®¿é—®çš„å…¥å£ç‚¹ |

### 1.3 ç½‘ç»œæ€§èƒ½ä¸è¿æ¥æ€§

#### ç½‘ç»œæ€§èƒ½ç‰¹ç‚¹

- **ä½å»¶è¿Ÿ**ï¼šGoogleå…¨çƒç½‘ç»œæä¾›è·¨æ´²ä½å»¶è¿Ÿè¿æ¥
- **é«˜å¸¦å®½**ï¼šå®ä¾‹é—´å¯è¾¾10Gbpsæˆ–æ›´é«˜å¸¦å®½
- **å¤šè·¯å¾„**ï¼šå¤šæ¡å†—ä½™ç½‘ç»œè·¯å¾„ç¡®ä¿å¯é æ€§
- **å…¨çƒè¦†ç›–**ï¼š200+è¾¹ç¼˜èŠ‚ç‚¹å’ŒPOPç‚¹

#### è¿æ¥ç±»å‹

```mermaid
graph LR
    A[æœ¬åœ°ç½‘ç»œ] --> B[Cloud Interconnect]
    A --> C[Cloud VPN]
    A --> D[Cloud Router]
    
    B --> E[GCPç½‘ç»œ]
    C --> E
    D --> E
    
    F[äº’è”ç½‘] --> G[Cloud CDN]
    G --> H[GCPæœåŠ¡]
```

| è¿æ¥ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| **Cloud Interconnect** | ä¸“ç”¨ç‰©ç†è¿æ¥ï¼Œé«˜å¸¦å®½ | å¤§è§„æ¨¡æ•°æ®ä¼ è¾“ï¼Œä½å»¶è¿Ÿè¦æ±‚ |
| **Cloud VPN** | é€šè¿‡å…¬å…±äº’è”ç½‘å»ºç«‹éš§é“ | ä¸­å°è§„æ¨¡è¿æ¥ï¼Œçµæ´»éƒ¨ç½² |
| **Cloud Router** | åŠ¨æ€è·¯ç”±ï¼ŒBGPåè®® | å¤æ‚ç½‘ç»œæ‹“æ‰‘ï¼Œå¤šè¿æ¥ç®¡ç† |
| **Cloud CDN** | å†…å®¹åˆ†å‘ç½‘ç»œï¼Œå…¨çƒè¾¹ç¼˜ç¼“å­˜ | é™æ€å†…å®¹åˆ†å‘ï¼Œé™ä½å»¶è¿Ÿ |

---

## 2. VPCç½‘ç»œè¯¦è§£

### 2.1 VPCç½‘ç»œåŸºç¡€

Virtual Private Cloud(VPC)æ˜¯GCPçš„ç½‘ç»œåŸºç¡€ï¼Œæä¾›äº†é€»è¾‘éš”ç¦»çš„ç½‘ç»œç¯å¢ƒã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

- **ç½‘ç»œ**ï¼šå…¨å±€èµ„æºï¼Œå¯è·¨è¶Šå¤šä¸ªåŒºåŸŸ
- **å­ç½‘**ï¼šåŒºåŸŸæ€§èµ„æºï¼Œåˆ’åˆ†IPåœ°å€èŒƒå›´
- **é˜²ç«å¢™è§„åˆ™**ï¼šæ§åˆ¶å®ä¾‹é—´å’Œå¤–éƒ¨æµé‡
- **è·¯ç”±**ï¼šå®šä¹‰æµé‡è·¯å¾„å’Œç›®çš„åœ°

#### ç½‘ç»œæ¨¡å¼

GCPæä¾›ä¸¤ç§ç½‘ç»œæ¨¡å¼ï¼š

| æ¨¡å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **è‡ªåŠ¨æ¨¡å¼VPC** | æ¯ä¸ªåŒºåŸŸè‡ªåŠ¨åˆ›å»ºå­ç½‘ | å¿«é€Ÿå¼€å§‹ï¼Œç®€å•é…ç½® |
| **è‡ªå®šä¹‰æ¨¡å¼VPC** | æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†å­ç½‘ | ç²¾ç¡®æ§åˆ¶ï¼Œä¼ä¸šç¯å¢ƒ |

```bash
# åˆ›å»ºè‡ªåŠ¨æ¨¡å¼VPCç½‘ç»œ
gcloud compute networks create auto-vpc-network --subnet-mode=auto

# åˆ›å»ºè‡ªå®šä¹‰æ¨¡å¼VPCç½‘ç»œ
gcloud compute networks create custom-vpc-network --subnet-mode=custom
```

### 2.2 å­ç½‘ç®¡ç†

å­ç½‘æ˜¯VPCç½‘ç»œçš„åŒºåŸŸæ€§ç»„æˆéƒ¨åˆ†ï¼Œå®šä¹‰äº†IPåœ°å€èŒƒå›´ã€‚

#### å­ç½‘é…ç½®

```bash
# åˆ›å»ºè‡ªå®šä¹‰å­ç½‘
gcloud compute networks subnets create custom-subnet-us-central1 \
  --network=custom-vpc-network \
  --region=us-central1 \
  --range=10.0.0.0/24 \
  --secondary-range pod-range=10.1.0.0/24,services-range=10.2.0.0/24

# åˆ—å‡ºå­ç½‘
gcloud compute networks subnets list --network=custom-vpc-network

# ä¿®æ”¹å­ç½‘
gcloud compute networks subnets expand-ip-range custom-subnet-us-central1 \
  --network=custom-vpc-network \
  --region=us-central1 \
  --prefix-length=20
```

#### å­ç½‘æœ€ä½³å®è·µ

1. **è§„åˆ’IPåœ°å€ç©ºé—´**ï¼šé¢„ç•™è¶³å¤Ÿçš„åœ°å€ç©ºé—´ç”¨äºæ‰©å±•
2. **åˆ†ç¦»ç”Ÿäº§ä¸éç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ä¸åŒç½‘ç»œæˆ–å­ç½‘éš”ç¦»
3. **ä½¿ç”¨åˆ†å±‚å­ç½‘è®¾è®¡**ï¼šæ ¹æ®åŠŸèƒ½å’Œå®‰å…¨çº§åˆ«åˆ’åˆ†
4. **è€ƒè™‘æœªæ¥å¢é•¿**ï¼šé¢„ç•™IPåœ°å€èŒƒå›´ç”¨äºæœªæ¥æ‰©å±•

```mermaid
graph TB
    A[VPCç½‘ç»œ] --> B[ç”Ÿäº§ç¯å¢ƒ]
    A --> C[æµ‹è¯•ç¯å¢ƒ]
    
    B --> B1[Webå±‚å­ç½‘]
    B --> B2[åº”ç”¨å±‚å­ç½‘]
    B --> B3[æ•°æ®å±‚å­ç½‘]
    
    C --> C1[æµ‹è¯•å­ç½‘]
    C --> C2[å¼€å‘å­ç½‘]
```

### 2.3 é˜²ç«å¢™è§„åˆ™

é˜²ç«å¢™è§„åˆ™æ§åˆ¶æµå…¥å’Œæµå‡ºVPCç½‘ç»œçš„æµé‡ã€‚

#### é˜²ç«å¢™è§„åˆ™ç»„æˆ

æ¯ä¸ªé˜²ç«å¢™è§„åˆ™åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š

- **æ–¹å‘**ï¼šå…¥ç«™(INGRESS)æˆ–å‡ºç«™(EGRESS)
- **ä¼˜å…ˆçº§**ï¼šæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜
- **åŠ¨ä½œ**ï¼šå…è®¸(allow)æˆ–æ‹’ç»(deny)
- **åŒ¹é…æ¡ä»¶**ï¼šæº/ç›®æ ‡IPã€åè®®ã€ç«¯å£
- **ç›®æ ‡**ï¼šåº”ç”¨åˆ°æ‰€æœ‰å®ä¾‹æˆ–ç‰¹å®šå®ä¾‹

#### å¸¸è§é˜²ç«å¢™è§„åˆ™é…ç½®

```bash
# å…è®¸HTTPæµé‡
gcloud compute firewall-rules create allow-http \
  --network custom-vpc-network \
  --allow tcp:80 \
  --source-ranges 0.0.0.0/0 \
  --description "Allow HTTP traffic"

# å…è®¸ç‰¹å®šIPçš„SSHè®¿é—®
gcloud compute firewall-rules create allow-ssh \
  --network custom-vpc-network \
  --allow tcp:22 \
  --source-ranges 203.0.113.0/24 \
  --description "Allow SSH from specific IP"

# å…è®¸å†…éƒ¨å®ä¾‹é—´é€šä¿¡
gcloud compute firewall-rules create allow-internal \
  --network custom-vpc-network \
  --allow tcp,udp,icmp \
  --source-ranges 10.0.0.0/8 \
  --description "Allow internal communication"

# æ‹’ç»ç‰¹å®šç«¯å£çš„æµé‡
gcloud compute firewall-rules create deny-database \
  --network custom-vpc-network \
  --priority 1000 \
  --deny tcp:3306 \
  --source-ranges 0.0.0.0/0 \
  --description "Deny direct database access"
```

#### é˜²ç«å¢™è§„åˆ™æœ€ä½³å®è·µ

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªå…è®¸å¿…è¦çš„æµé‡
2. **åˆ†å±‚é˜²å¾¡**ï¼šç½‘ç»œå±‚ã€å­ç½‘å±‚å’Œå®ä¾‹å±‚é˜²ç«å¢™
3. **ä½¿ç”¨ç½‘ç»œæ ‡ç­¾**ï¼šç²¾ç¡®æ§åˆ¶å®ä¾‹çš„è®¿é—®æƒé™
4. **å®šæœŸå®¡æŸ¥è§„åˆ™**ï¼šç§»é™¤ä¸å†éœ€è¦çš„è§„åˆ™

### 2.4 é«˜çº§ç½‘ç»œåŠŸèƒ½

#### è·¯ç”±ç®¡ç†

GCPè·¯ç”±å®šä¹‰äº†æµé‡çš„è·¯å¾„å’Œç›®çš„åœ°ã€‚

```bash
# åˆ›å»ºè‡ªå®šä¹‰è·¯ç”±
gcloud compute routes create custom-route \
  --network custom-vpc-network \
  --destination-range=192.168.0.0/16 \
  --next-hop-gateway=default-internet-gateway \
  --description "Route to on-premises network"

# åˆ›å»ºVPNéš§é“è·¯ç”±
gcloud compute routes create vpn-route \
  --network custom-vpc-network \
  --destination-range=192.168.1.0/24 \
  --next-hop-vpn-tunnel=my-vpn-tunnel \
  --description "Route to on-premises via VPN"
```

#### å…±äº«VPC

å…±äº«VPCå…è®¸ä¸€ä¸ªé¡¹ç›®ï¼ˆä¸»æœºé¡¹ç›®ï¼‰ä¸­çš„VPCç½‘ç»œä¸å…¶ä»–é¡¹ç›®ï¼ˆæœåŠ¡é¡¹ç›®ï¼‰å…±äº«ã€‚

```mermaid
graph TB
    subgraph "ä¸»æœºé¡¹ç›®"
        A[å…±äº«VPCç½‘ç»œ]
    end
    
    subgraph "æœåŠ¡é¡¹ç›®1"
        B[å®ä¾‹1]
        C[å®ä¾‹2]
    end
    
    subgraph "æœåŠ¡é¡¹ç›®2"
        D[å®ä¾‹3]
        E[å®ä¾‹4]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
```

```bash
# å¯ç”¨å…±äº«VPC
gcloud services enable compute.googleapis.com --project host-project
gcloud services enable compute.googleapis.com --project service-project

# è®¾ç½®å…±äº«VPCä¸»æœºé¡¹ç›®
gcloud compute shared-vpc enable host-project

# å°†æœåŠ¡é¡¹ç›®å…³è”åˆ°ä¸»æœºé¡¹ç›®
gcloud compute shared-vpc associated-projects add service-project \
  --host-project host-project

# åœ¨å…±äº«VPCä¸­åˆ›å»ºå­ç½‘
gcloud compute networks subnets create shared-subnet \
  --network shared-vpc-network \
  --region us-central1 \
  --range 10.0.0.0/24 \
  --project host-project
```

---

## 3. è´Ÿè½½å‡è¡¡ä¸CDN

### 3.1 è´Ÿè½½å‡è¡¡å™¨ç±»å‹

GCPæä¾›å¤šç§è´Ÿè½½å‡è¡¡å™¨ï¼Œæ»¡è¶³ä¸åŒåº”ç”¨åœºæ™¯çš„éœ€æ±‚ï¼š

| è´Ÿè½½å‡è¡¡å™¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------------|----------|------|
| **å…¨å±€å¤–éƒ¨HTTP(S)è´Ÿè½½å‡è¡¡** | å…¨çƒWebåº”ç”¨ | å…¨çƒCDNï¼Œé«˜çº§è·¯ç”±ï¼ŒSSLç»ˆæ­¢ |
| **åŒºåŸŸå¤–éƒ¨HTTP(S)è´Ÿè½½å‡è¡¡** | åŒºåŸŸWebåº”ç”¨ | ä½æˆæœ¬ï¼Œç®€å•é…ç½® |
| **å¤–éƒ¨TCP/UDPè´Ÿè½½å‡è¡¡** | éHTTPæµé‡ | æ¸¸æˆæœåŠ¡å™¨ï¼ŒIoTï¼Œæ•°æ®åº“ |
| **å†…éƒ¨TCP/UDPè´Ÿè½½å‡è¡¡** | å†…éƒ¨æœåŠ¡ | å¾®æœåŠ¡æ¶æ„ï¼Œå†…éƒ¨API |
| **å†…éƒ¨HTTP(S)è´Ÿè½½å‡è¡¡** | å†…éƒ¨WebæœåŠ¡ | å†…éƒ¨Webåº”ç”¨ï¼Œå¾®æœåŠ¡ |

### 3.2 å…¨å±€å¤–éƒ¨HTTP(S)è´Ÿè½½å‡è¡¡

å…¨å±€å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨æä¾›å…¨çƒæµé‡åˆ†å‘å’Œé«˜çº§è·¯ç”±åŠŸèƒ½ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- **å…¨çƒCDN**ï¼šå†…ç½®å…¨çƒå†…å®¹åˆ†å‘ç½‘ç»œ
- **é«˜çº§è·¯ç”±**ï¼šåŸºäºURLã€ä¸»æœºã€å¤´ä¿¡æ¯ç­‰è·¯ç”±
- **SSLç»ˆæ­¢**ï¼šè‡ªåŠ¨SSLè¯ä¹¦ç®¡ç†å’Œç»ˆæ­¢
- **å¥åº·æ£€æŸ¥**ï¼šåç«¯å®ä¾‹å¥åº·ç›‘æ§
- **ä¼šè¯ä¿æŒ**ï¼šåŸºäºCookieçš„ä¼šè¯äº²å’Œæ€§

#### åˆ›å»ºå…¨å±€è´Ÿè½½å‡è¡¡å™¨

```bash
# åˆ›å»ºå¥åº·æ£€æŸ¥
gcloud compute health-checks create http webapp-health-check \
  --port 80 \
  --check-interval 5s \
  --timeout 5s \
  --healthy-threshold 2 \
  --unhealthy-threshold 2

# åˆ›å»ºåç«¯æœåŠ¡
gcloud compute backend-services create webapp-backend \
  --protocol HTTP \
  --port-name http \
  --health-checks webapp-health-check \
  --global

# å°†å®ä¾‹ç»„æ·»åŠ åˆ°åç«¯æœåŠ¡
gcloud compute backend-services add-backend webapp-backend \
  --instance-group webapp-instance-group \
  --instance-zone us-central1-a \
  --global

# åˆ›å»ºURLæ˜ å°„
gcloud compute url-maps create webapp-map \
  --default-service webapp-backend

# åˆ›å»ºç›®æ ‡HTTPä»£ç†
gcloud compute target-http-proxies create webapp-http-proxy \
  --url-map webapp-map

# åˆ›å»ºè½¬å‘è§„åˆ™
gcloud compute forwarding-rules create webapp-http-rule \
  --address 192.0.2.1 \
  --global \
  --target-http-proxy webapp-http-proxy \
  --ports 80
```

### 3.3 å†…éƒ¨è´Ÿè½½å‡è¡¡

å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨ç”¨äºåœ¨VPCç½‘ç»œå†…éƒ¨åˆ†é…æµé‡ã€‚

#### åˆ›å»ºå†…éƒ¨è´Ÿè½½å‡è¡¡å™¨

```bash
# åˆ›å»ºå†…éƒ¨å¥åº·æ£€æŸ¥
gcloud compute health-checks create http internal-health-check \
  --port 80 \
  --check-interval 5s \
  --timeout 5s \
  --healthy-threshold 2 \
  --unhealthy-threshold 2

# åˆ›å»ºå†…éƒ¨åç«¯æœåŠ¡
gcloud compute backend-services create internal-backend \
  --protocol HTTP \
  --port-name http \
  --health-checks internal-health-check \
  --region us-central1

# å°†å®ä¾‹ç»„æ·»åŠ åˆ°å†…éƒ¨åç«¯
gcloud compute backend-services add-backend internal-backend \
  --instance-group webapp-instance-group \
  --instance-zone us-central1-a \
  --region us-central1

# åˆ›å»ºå†…éƒ¨è½¬å‘è§„åˆ™
gcloud compute forwarding-rules create internal-http-rule \
  --load-balancing-scheme INTERNAL \
  --address 10.0.0.10 \
  --subnet custom-subnet-us-central1 \
  --backend-service internal-backend \
  --ports 80 \
  --region us-central1
```

### 3.4 Cloud CDN

Cloud CDNæ˜¯GCPçš„å†…å®¹åˆ†å‘ç½‘ç»œï¼Œé€šè¿‡å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜å†…å®¹ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚

#### å¯ç”¨Cloud CDN

```bash
# åˆ›å»ºå¯ç”¨äº†CDNçš„åç«¯æœåŠ¡
gcloud compute backend-services create webapp-backend \
  --protocol HTTP \
  --port-name http \
  --health-checks webapp-health-check \
  --enable-cdn \
  --cache-mode=CACHE_ALL_STATIC \
  --global

# é…ç½®ç¼“å­˜å¯†é’¥
gcloud compute backend-services edit webapp-backend \
  --global

# é…ç½®ç¼“å­˜é”®ç­–ç•¥
# åœ¨æ‰“å¼€çš„ç¼–è¾‘å™¨ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
# cdnPolicy:
#   cacheKeyPolicy:
#     includeHost: true
#     includeProtocol: false
#     includeQueryString: true

# åˆ›å»ºè´Ÿç¼“å­˜è§„åˆ™ï¼ˆä¸ç¼“å­˜ç‰¹å®šå†…å®¹ï¼‰
gcloud compute backend-services add-negative-caching-policy webapp-backend \
  --code=404 \
  --ttl=60s \
  --global
```

---

## 4. èº«ä»½å’Œè®¿é—®ç®¡ç†(IAM)

### 4.1 IAMåŸºç¡€

Identity and Access Management (IAM)æ˜¯GCPçš„æ ¸å¿ƒå®‰å…¨æœåŠ¡ï¼Œæ§åˆ¶ç”¨æˆ·å’ŒæœåŠ¡å¯¹èµ„æºçš„è®¿é—®æƒé™ã€‚

#### IAMæ ¸å¿ƒæ¦‚å¿µ

- **èº«ä»½**ï¼šç”¨æˆ·ã€æœåŠ¡è´¦æˆ·ã€Googleç¾¤ç»„ã€G Suite/Cloud IdentityåŸŸ
- **æƒé™**ï¼šæ‰§è¡Œç‰¹å®šæ“ä½œçš„èƒ½åŠ›
- **è§’è‰²**ï¼šæƒé™çš„é›†åˆ
- **èµ„æºå±‚æ¬¡ç»“æ„**ï¼šç»„ç»‡ã€æ–‡ä»¶å¤¹ã€é¡¹ç›®ã€èµ„æº

```mermaid
graph TB
    A[ç»„ç»‡] --> B[æ–‡ä»¶å¤¹]
    A --> C[æ–‡ä»¶å¤¹]
    
    B --> D[é¡¹ç›®1]
    B --> E[é¡¹ç›®2]
    
    C --> F[é¡¹ç›®3]
    C --> G[é¡¹ç›®4]
    
    D --> H[èµ„æº1]
    E --> I[èµ„æº2]
    F --> J[èµ„æº3]
    G --> K[èµ„æº4]
```

### 4.2 IAMè§’è‰²ç±»å‹

GCPæä¾›äº†ä¸‰ç§è§’è‰²ç±»å‹ï¼š

#### åŸºç¡€è§’è‰²

| è§’è‰² | æƒé™ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **roles/owner** | æ‰€æœ‰æƒé™ | å®Œå…¨æ§åˆ¶ |
| **roles/editor** | å¤§éƒ¨åˆ†æƒé™ | æ—¥å¸¸è¿ç»´ |
| **roles/viewer** | åªè¯»æƒé™ | å®¡æŸ¥å’Œç›‘æ§ |

#### é¢„å®šä¹‰è§’è‰²

é¢„å®šä¹‰è§’è‰²é’ˆå¯¹ç‰¹å®šæœåŠ¡æˆ–åŠŸèƒ½æä¾›äº†é€‚å½“çš„æƒé™é›†ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„é¢„å®šä¹‰è§’è‰²
gcloud iam roles list

# æŸ¥çœ‹ç‰¹å®šè§’è‰²çš„æƒé™
gcloud iam roles describe roles/compute.instanceAdmin

# å¸¸ç”¨é¢„å®šä¹‰è§’è‰²
gcloud projects add-iam-policy-binding my-project \
  --member="user:alice@example.com" \
  --role="roles/compute.instanceAdmin"

gcloud projects add-iam-policy-binding my-project \
  --member="user:bob@example.com" \
  --role="roles/storage.objectAdmin"

gcloud projects add-iam-policy-binding my-project \
  --member="user:charlie@example.com" \
  --role="roles/cloudsql.editor"
```

#### è‡ªå®šä¹‰è§’è‰²

å½“é¢„å®šä¹‰è§’è‰²ä¸èƒ½æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼š

```bash
# åˆ›å»ºè‡ªå®šä¹‰è§’è‰²
gcloud iam roles create customInstanceManager \
  --project=my-project \
  --title="Custom Instance Manager" \
  --description="Custom role for managing specific instances" \
  --permissions="compute.instances.get,compute.instances.start,compute.instances.stop,compute.instances.restart,compute.instances.setTags"

# å°†è‡ªå®šä¹‰è§’è‰²åˆ†é…ç»™ç”¨æˆ·
gcloud projects add-iam-policy-binding my-project \
  --member="user:david@example.com" \
  --role="projects/my-project/roles/customInstanceManager"
```

### 4.3 æœåŠ¡è´¦æˆ·

æœåŠ¡è´¦æˆ·æ˜¯åº”ç”¨ç¨‹åºçš„ä¸“ç”¨è´¦æˆ·ï¼Œç”¨äºç¨‹åºåŒ–è®¿é—®GCPèµ„æºã€‚

#### åˆ›å»ºå’Œç®¡ç†æœåŠ¡è´¦æˆ·

```bash
# åˆ›å»ºæœåŠ¡è´¦æˆ·
gcloud iam service-accounts create my-app-service-account \
  --display-name="My Application Service Account" \
  --description="Service account for my application"

# åˆ—å‡ºæœåŠ¡è´¦æˆ·
gcloud iam service-accounts list

# ä¸ºæœåŠ¡è´¦æˆ·åˆ†é…è§’è‰²
gcloud projects add-iam-policy-binding my-project \
  --member="serviceAccount:my-app-service-account@my-project.iam.gserviceaccount.com" \
  --role="roles/storage.objectViewer"

# åˆ›å»ºæœåŠ¡è´¦æˆ·å¯†é’¥ï¼ˆä¸æ¨èï¼Œæ›´æ¨èä½¿ç”¨é™„åŠ æœåŠ¡è´¦æˆ·ï¼‰
gcloud iam service-accounts keys create ~/my-key.json \
  --iam-account=my-app-service-account@my-project.iam.gserviceaccount.com

# é™„åŠ æœåŠ¡è´¦æˆ·åˆ°å®ä¾‹ï¼ˆæ¨èæ–¹å¼ï¼‰
gcloud compute instances create my-instance \
  --service-account=my-app-service-account@my-project.iam.gserviceaccount.com \
  --scopes=storage-ro
```

#### æœåŠ¡è´¦æˆ·æœ€ä½³å®è·µ

1. **æœ€å°æƒé™åŸåˆ™**ï¼šä»…æˆäºˆæœåŠ¡è´¦æˆ·æ‰§è¡Œå…¶åŠŸèƒ½æ‰€éœ€çš„æœ€å°æƒé™
2. **ç¯å¢ƒéš”ç¦»**ï¼šä¸ºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä½¿ç”¨ä¸åŒçš„æœåŠ¡è´¦æˆ·
3. **å®šæœŸè½®æ¢å¯†é’¥**ï¼šå¦‚æœä½¿ç”¨å¯†é’¥ï¼Œå®šæœŸè½®æ¢ä»¥æé«˜å®‰å…¨æ€§
4. **ç›‘æ§ä½¿ç”¨æƒ…å†µ**ï¼šå®šæœŸå®¡æŸ¥æœåŠ¡è´¦æˆ·çš„ä½¿ç”¨æƒ…å†µï¼Œç§»é™¤ä¸å†éœ€è¦çš„æƒé™

---

## 5. å®‰å…¨æœåŠ¡ä¸åˆè§„æ€§

### 5.1 å®‰å…¨æœåŠ¡æ¦‚è§ˆ

GCPæä¾›äº†å¤šç§å®‰å…¨æœåŠ¡ï¼Œå¸®åŠ©ä¿æŠ¤äº‘èµ„æºå’Œåº”ç”¨ï¼š

| æœåŠ¡ | åŠŸèƒ½ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **Cloud Armor** | WAFå’ŒDDoSä¿æŠ¤ | Webåº”ç”¨å®‰å…¨ |
| **Security Command Center** | å®‰å…¨å¨èƒæ£€æµ‹å’Œå“åº” | å…¨é¢å®‰å…¨ç®¡ç† |
| **Key Management Service (KMS)** | å¯†é’¥ç®¡ç† | åŠ å¯†å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| **Secret Manager** | å¯†é’¥å­˜å‚¨ | æ•æ„Ÿä¿¡æ¯å­˜å‚¨ |
| **Cloud Identity-Aware Proxy** | åº”ç”¨çº§è®¿é—®æ§åˆ¶ | é›¶ä¿¡ä»»æ¶æ„ |

### 5.2 Cloud Armor WAF

Cloud Armoræä¾›Webåº”ç”¨é˜²ç«å¢™(WAF)å’ŒDDoSä¿æŠ¤åŠŸèƒ½ã€‚

#### åˆ›å»ºå®‰å…¨ç­–ç•¥

```bash
# åˆ›å»ºå®‰å…¨ç­–ç•¥
gcloud compute security-policies create my-app-security-policy \
  --description="Security policy for my web application"

# æ·»åŠ é¢„é…ç½®WAFè§„åˆ™ï¼ˆä¾‹å¦‚ï¼Œé˜»æ­¢SQLæ³¨å…¥ï¼‰
gcloud compute security-policies rules create 1000 \
  --security-policy=my-app-security-policy \
  --description="Block SQL injection attempts" \
  --expression="evaluatePreconfiguredExpr('sqli-stable')" \
  --action="deny-403"

# æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼ˆä¾‹å¦‚ï¼Œé˜»æ­¢å¯ç–‘IPï¼‰
gcloud compute security-policies rules create 2000 \
  --security-policy=my-app-security-policy \
  --description="Block suspicious IP addresses" \
  --expression="request.headers['x-forwarded-for'].contains('192.0.2.')" \
  --action="deny-403"

# é€Ÿç‡é™åˆ¶è§„åˆ™
gcloud compute security-policies rules create 3000 \
  --security-policy=my-app-security-policy \
  --description="Rate limiting for API" \
  --expression="request.path.startsWith('/api/')" \
  --action="rate-ban-429" \
  --rate-limit-threshold-count=20 \
  --rate-limit-threshold-interval-sec=60 \
  --conform-action="allow"

# å°†å®‰å…¨ç­–ç•¥é™„åŠ åˆ°åç«¯æœåŠ¡
gcloud compute backend-services update webapp-backend \
  --security-policy=my-app-security-policy \
  --global
```

### 5.3 Key Management Service (KMS)

KMSæä¾›äº‘åŸç”Ÿçš„å¯†é’¥ç®¡ç†æœåŠ¡ï¼Œç”¨äºåŠ å¯†æ•°æ®çš„å¯†é’¥ç”Ÿæˆã€å­˜å‚¨å’Œç®¡ç†ã€‚

#### åˆ›å»ºå’Œç®¡ç†å¯†é’¥

```bash
# åˆ›å»ºå¯†é’¥ç¯
gcloud kms keyrings create my-key-ring \
  --location=us-central1

# åˆ›å»ºå¯¹ç§°åŠ å¯†å¯†é’¥
gcloud kms keys create my-encryption-key \
  --keyring=my-key-ring \
  --location=us-central1 \
  --purpose=encryption

# åˆ›å»ºéå¯¹ç§°å¯†é’¥ï¼ˆç”¨äºç­¾åï¼‰
gcloud kms keys create my-signing-key \
  --keyring=my-key-ring \
  --location=us-central1 \
  --purpose=asymmetric-signing \
  --algorithm=rsa-sign-pkcs1-sha256

# ä½¿ç”¨å¯†é’¥åŠ å¯†æ•°æ®
echo "Sensitive data" | gcloud kms encrypt \
  --plaintext-file=- \
  --ciphertext-file=- \
  --location=us-central1 \
  --keyring=my-key-ring \
  --key=my-encryption-key > encrypted.data

# ä½¿ç”¨å¯†é’¥è§£å¯†æ•°æ®
gcloud kms decrypt \
  --ciphertext-file=encrypted.data \
  --plaintext-file=- \
  --location=us-central1 \
  --keyring=my-key-ring \
  --key=my-encryption-key
```

#### å¯†é’¥ç‰ˆæœ¬å’Œè½®æ¢

```bash
# æŸ¥çœ‹å¯†é’¥ç‰ˆæœ¬
gcloud kms keys versions list \
  --keyring=my-key-ring \
  --location=us-central1 \
  --key=my-encryption-key

# åˆ›å»ºæ–°å¯†é’¥ç‰ˆæœ¬ï¼ˆæ‰‹åŠ¨è½®æ¢ï¼‰
gcloud kms keys versions create \
  --keyring=my-key-ring \
  --location=us-central1 \
  --key=my-encryption-key

# è®¾ç½®è‡ªåŠ¨è½®æ¢ç­–ç•¥
gcloud kms keys update my-encryption-key \
  --keyring=my-key-ring \
  --location=us-central1 \
  --rotation-period=90d \
  --next-rotation-time=2023-12-01T00:00:00Z
```

### 5.4 Secret Manager

Secret Manageræ˜¯GCPçš„å¯†é’¥å­˜å‚¨æœåŠ¡ï¼Œå®‰å…¨åœ°å­˜å‚¨APIå¯†é’¥ã€å¯†ç ã€è¯ä¹¦ç­‰æ•æ„Ÿä¿¡æ¯ã€‚

#### åˆ›å»ºå’Œç®¡ç†å¯†é’¥

```bash
# å¯ç”¨Secret Manager API
gcloud services enable secretmanager.googleapis.com

# åˆ›å»ºå¯†é’¥
echo -n "my-database-password" | gcloud secrets create database-password \
  --replication-policy="automatic" \
  --data-file=-

# åˆ›å»ºå¸¦æœ‰ç‰ˆæœ¬çš„å¯†é’¥
gcloud secrets versions add database-password \
  --data-file=/path/to/password.txt

# åˆ—å‡ºæ‰€æœ‰å¯†é’¥
gcloud secrets list

# è®¿é—®å¯†é’¥å€¼
gcloud secrets versions access latest --secret="database-password"

# æˆäºˆæœåŠ¡è´¦æˆ·è®¿é—®å¯†é’¥çš„æƒé™
gcloud secrets add-iam-policy-binding database-password \
  --member="serviceAccount:my-app@my-project.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### 5.5 åˆè§„æ€§ä¸è®¤è¯

#### GCPåˆè§„æ€§è®¤è¯

GCPé€šè¿‡äº†å¤šç§å›½é™…å’Œè¡Œä¸šçš„åˆè§„æ€§è®¤è¯ï¼š

| è®¤è¯ | èŒƒå›´ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **ISO 27001** | ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³» | ä¼ä¸šå®‰å…¨æ ‡å‡† |
| **ISO 27017** | äº‘å®‰å…¨ | äº‘ç¯å¢ƒå®‰å…¨ |
| **ISO 27018** | äº‘ä¸­ä¸ªäººèº«ä»½ä¿¡æ¯ | éšç§ä¿æŠ¤ |
| **SOC 1/2/3** | è´¢åŠ¡æŠ¥å‘Šå’Œè¿è¥æ§åˆ¶ | è´¢åŠ¡å’Œè¿è¥å®¡è®¡ |
| **HIPAA** | åŒ»ç–—ä¿¡æ¯ | åŒ»ç–—ä¿å¥è¡Œä¸š |
| **PCI DSS** | æ”¯ä»˜å¡è¡Œä¸š | é‡‘èæœåŠ¡ |
| **FedRAMP** | è”é‚¦æ”¿åºœ | æ”¿åºœæœºæ„ |

#### èµ„æºä½ç½®å’Œç»„ç»‡ç­–ç•¥

```bash
# è®¾ç½®èµ„æºä½ç½®çº¦æŸï¼ˆé™åˆ¶èµ„æºåˆ›å»ºä½ç½®ï¼‰
gcloud resource-manager org-policies deny --organization=ORGANIZATION_ID \
  --constraint=constraints/gcp.resourceLocations \
  --allowed-values=US,EU

# è®¾ç½®å¤–éƒ¨IPè®¿é—®é™åˆ¶
gcloud resource-manager org-policies deny --organization=ORGANIZATION_ID \
  --constraint=constraints/compute.vmExternalIpAccess \
  --allowed-values=192.0.2.0/24,198.51.100.0/24

# è®¾ç½®è¦æ±‚çš„ä¿¡ä»»é•œåƒ
gcloud resource-manager org-policies deny --organization=ORGANIZATION_ID \
  --constraint=constraints/compute.trustedImageProjects \
  --allowed-values=projects/trusted-images-project
```

---

## 6. å®éªŒï¼šæ„å»ºå®‰å…¨é«˜å¯ç”¨æ¶æ„

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»¼åˆå®éªŒï¼Œå®è·µæœ¬ç« å­¦ä¹ çš„ç½‘ç»œå’Œå®‰å…¨æœåŠ¡ã€‚

### å®éªŒç›®æ ‡

é€šè¿‡æœ¬å®éªŒï¼Œæ‚¨å°†ï¼š

1. è®¾è®¡å¹¶å®æ–½å¤šå±‚VPCç½‘ç»œæ¶æ„
2. é…ç½®è´Ÿè½½å‡è¡¡å™¨å®ç°é«˜å¯ç”¨æ€§
3. å®æ–½å®‰å…¨ç»„å’Œé˜²ç«å¢™è§„åˆ™
4. é…ç½®IAMæƒé™å’ŒæœåŠ¡è´¦æˆ·
5. éƒ¨ç½²å®‰å…¨æœåŠ¡ä¿æŠ¤åº”ç”¨

### å®éªŒæ¶æ„

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¤šå±‚åº”ç”¨çš„å®‰å…¨é«˜å¯ç”¨æ¶æ„ï¼š

```mermaid
graph TB
    subgraph "å¤–éƒ¨ç”¨æˆ·"
        A[ç”¨æˆ·] --> B[Cloud Armor]
        B --> C[å…¨çƒè´Ÿè½½å‡è¡¡å™¨]
    end
    
    subgraph "DMZç½‘ç»œ"
        C --> D[Webå±‚å®ä¾‹ç»„]
    end
    
    subgraph "åº”ç”¨ç½‘ç»œ"
        D --> E[å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨]
        E --> F[åº”ç”¨å±‚å®ä¾‹ç»„]
    end
    
    subgraph "æ•°æ®ç½‘ç»œ"
        F --> G[å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨]
        G --> H[æ•°æ®åº“å®ä¾‹]
    end
    
    subgraph "å®‰å…¨æœåŠ¡"
        I[KMS]
        J[Secret Manager]
        K[Cloud IAM]
        
        D --> I
        F --> I
        H --> I
        
        D --> J
        F --> J
        H --> J
        
        A --> K
    end
```

### å‰ææ¡ä»¶

- å·²åˆ›å»ºGCPé¡¹ç›®å’Œè®¡è´¹è´¦æˆ·
- å·²å¯ç”¨å¿…è¦çš„GCP API
- å·²å®‰è£…gcloud CLI

### å®éªŒæ­¥éª¤

#### æ­¥éª¤1ï¼šåˆ›å»ºVPCç½‘ç»œæ¶æ„

```bash
# è®¾ç½®å˜é‡
export PROJECT_ID=$(gcloud config get-value project)
export ORG_ID=$(gcloud organizations list --format="value(ID)")

# åˆ›å»ºè‡ªå®šä¹‰æ¨¡å¼VPCç½‘ç»œ
gcloud compute networks create secure-app-network \
  --subnet-mode=custom \
  --description="Secure application network"

# åˆ›å»ºWebå±‚å­ç½‘ï¼ˆDMZï¼‰
gcloud compute networks subnets create web-subnet \
  --network=secure-app-network \
  --range=10.1.0.0/24 \
  --region=us-central1 \
  --description="Web tier subnet (DMZ)"

# åˆ›å»ºåº”ç”¨å±‚å­ç½‘
gcloud compute networks subnets create app-subnet \
  --network=secure-app-network \
  --range=10.2.0.0/24 \
  --region=us-central1 \
  --description="Application tier subnet"

# åˆ›å»ºæ•°æ®åº“å­ç½‘
gcloud compute networks subnets create db-subnet \
  --network=secure-app-network \
  --range=10.3.0.0/24 \
  --region=us-central1 \
  --description="Database tier subnet"
```

#### æ­¥éª¤2ï¼šé…ç½®é˜²ç«å¢™è§„åˆ™

```bash
# å…è®¸SSHä»ç‰¹å®šIPè®¿é—®æ‰€æœ‰å­ç½‘
gcloud compute firewall-rules create allow-ssh \
  --network=secure-app-network \
  --allow tcp:22 \
  --source-ranges 203.0.113.0/24 \
  --description="Allow SSH from specific IP"

# å…è®¸å†…éƒ¨æµé‡ï¼ˆåº”ç”¨å±‚åˆ°æ•°æ®åº“å±‚ï¼‰
gcloud compute firewall-rules create allow-app-to-db \
  --network=secure-app-network \
  --allow tcp:3306 \
  --source-tags app-server \
  --target-tags db-server \
  --description="Allow application servers to access database"

# å…è®¸Webå±‚åˆ°åº”ç”¨å±‚çš„æµé‡
gcloud compute firewall-rules create allow-web-to-app \
  --network=secure-app-network \
  --allow tcp:8080 \
  --source-tags web-server \
  --target-tags app-server \
  --description="Allow web servers to access application servers"

# å…è®¸å¤–éƒ¨åˆ°Webå±‚çš„HTTP/HTTPSæµé‡
gcloud compute firewall-rules create allow-external-to-web \
  --network=secure-app-network \
  --allow tcp:80,tcp:443 \
  --source-ranges 0.0.0.0/0 \
  --target-tags web-server \
  --description="Allow external HTTP/HTTPS to web servers"

# æ‹’ç»ç›´æ¥è®¿é—®æ•°æ®åº“å±‚
gcloud compute firewall-rules create deny-direct-db-access \
  --network=secure-app-network \
  --priority 1000 \
  --deny tcp:3306 \
  --source-ranges 0.0.0.0/0 \
  --target-tags db-server \
  --description="Deny direct database access from external"
```

#### æ­¥éª¤3ï¼šåˆ›å»ºæœåŠ¡è´¦æˆ·å’Œæƒé™

```bash
# åˆ›å»ºWebæœåŠ¡å™¨æœåŠ¡è´¦æˆ·
gcloud iam service-accounts create web-server-sa \
  --display-name="Web Server Service Account"

# åˆ›å»ºåº”ç”¨æœåŠ¡å™¨æœåŠ¡è´¦æˆ·
gcloud iam service-accounts create app-server-sa \
  --display-name="Application Server Service Account"

# åˆ›å»ºæ•°æ®åº“æœåŠ¡è´¦æˆ·
gcloud iam service-accounts create db-server-sa \
  --display-name="Database Server Service Account"

# æˆäºˆWebæœåŠ¡å™¨æœåŠ¡è´¦æˆ·è®¿é—®KMSå¯†é’¥çš„æƒé™
gcloud kms keyrings create app-keyring --location=global
gcloud kms keys create app-encryption-key \
  --keyring=app-keyring \
  --location=global \
  --purpose=encryption

gcloud kms keys add-iam-policy-binding app-encryption-key \
  --keyring=app-keyring \
  --location=global \
  --member="serviceAccount:web-server-sa@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="roles/cloudkms.cryptoKeyEncrypterDecrypter"

# æˆäºˆåº”ç”¨æœåŠ¡å™¨æœåŠ¡è´¦æˆ·è®¿é—®Secret Managerçš„æƒé™
gcloud services enable secretmanager.googleapis.com

echo "app-database-password" | gcloud secrets create app-db-password \
  --replication-policy="automatic" \
  --data-file=-

gcloud secrets add-iam-policy-binding app-db-password \
  --member="serviceAccount:app-server-sa@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

#### æ­¥éª¤4ï¼šåˆ›å»ºå®ä¾‹ç»„

```bash
# åˆ›å»ºWebæœåŠ¡å™¨æ¨¡æ¿
gcloud compute instance-templates create web-server-template \
  --machine-type=e2-medium \
  --network=secure-app-network \
  --subnet=web-subnet \
  --tags=web-server \
  --service-account=web-server-sa@${PROJECT_ID}.iam.gserviceaccount.com \
  --image-family=debian-11 \
  --image-project=debian-cloud \
  --metadata=startup-script='#! /bin/bash
    apt-get update
    apt-get install -y apache2
    systemctl enable apache2
    systemctl start apache2
    echo "<h1>Web Server $(hostname)</h1>" > /var/www/html/index.html
  '

# åˆ›å»ºWebæœåŠ¡å™¨å®ä¾‹ç»„
gcloud compute instance-groups managed create web-server-group \
  --base-instance-name web-server \
  --size 2 \
  --template web-server-template \
  --zone us-central1-a

# åˆ›å»ºåº”ç”¨æœåŠ¡å™¨æ¨¡æ¿
gcloud compute instance-templates create app-server-template \
  --machine-type=e2-medium \
  --network=secure-app-network \
  --subnet=app-subnet \
  --tags=app-server \
  --service-account=app-server-sa@${PROJECT_ID}.iam.gserviceaccount.com \
  --image-family=debian-11 \
  --image-project=debian-cloud \
  --metadata=startup-script='#! /bin/bash
    apt-get update
    apt-get install -y python3 python3-pip
    pip3 install flask
    cat > /app/app.py <<EOF
from flask import Flask, jsonify
import os
app = Flask(__name__)

@app.route('/api/health')
def health():
    return jsonify({"status": "healthy", "server": os.uname()[1]})

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=8080)
EOF
    mkdir -p /app
    cd /app
    python3 app.py &
  '

# åˆ›å»ºåº”ç”¨æœåŠ¡å™¨å®ä¾‹ç»„
gcloud compute instance-groups managed create app-server-group \
  --base-instance-name app-server \
  --size 2 \
  --template app-server-template \
  --zone us-central1-a

# åˆ›å»ºæ•°æ®åº“å®ä¾‹
gcloud compute instances create database-server \
  --machine-type=e2-medium \
  --network=secure-app-network \
  --subnet=db-subnet \
  --tags=db-server \
  --service-account=db-server-sa@${PROJECT_ID}.iam.gserviceaccount.com \
  --image-family=debian-11 \
  --image-project=debian-cloud \
  --metadata=startup-script='#! /bin/bash
    apt-get update
    apt-get install -y mariadb-server
    systemctl enable mariadb
    systemctl start mariadb
    mysql -e "CREATE USER app_user IDENTIFIED BY \"secure_password\";"
    mysql -e "CREATE DATABASE app_db;"
    mysql -e "GRANT ALL PRIVILEGES ON app_db.* TO app_user;"
    mysql -e "FLUSH PRIVILEGES;"
  '
```

#### æ­¥éª¤5ï¼šé…ç½®è´Ÿè½½å‡è¡¡å™¨

```bash
# åˆ›å»ºå¥åº·æ£€æŸ¥
gcloud compute health-checks create http web-health-check \
  --port 80 \
  --check-interval 5s \
  --timeout 5s \
  --healthy-threshold 2 \
  --unhealthy-threshold 2

gcloud compute health-checks create http app-health-check \
  --port 8080 \
  --request-path=/api/health \
  --check-interval 5s \
  --timeout 5s \
  --healthy-threshold 2 \
  --unhealthy-threshold 2

# åˆ›å»ºWebå±‚å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨
gcloud compute backend-services create web-backend \
  --protocol HTTP \
  --port-name http \
  --health-checks web-health-check \
  --region us-central1

gcloud compute backend-services add-backend web-backend \
  --instance-group web-server-group \
  --instance-zone us-central1-a \
  --region us-central1

# åˆ›å»ºWebå±‚å†…éƒ¨è½¬å‘è§„åˆ™
gcloud compute forwarding-rules create web-internal-lb \
  --load-balancing-scheme INTERNAL \
  --network=secure-app-network \
  --subnet=web-subnet \
  --address=10.1.0.10 \
  --backend-service web-backend \
  --ports 80 \
  --region us-central1

# åˆ›å»ºåº”ç”¨å±‚å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨
gcloud compute backend-services create app-backend \
  --protocol HTTP \
  --port-name http \
  --health-checks app-health-check \
  --region us-central1

gcloud compute backend-services add-backend app-backend \
  --instance-group app-server-group \
  --instance-zone us-central1-a \
  --region us-central1

# åˆ›å»ºåº”ç”¨å±‚å†…éƒ¨è½¬å‘è§„åˆ™
gcloud compute forwarding-rules create app-internal-lb \
  --load-balancing-scheme INTERNAL \
  --network=secure-app-network \
  --subnet=app-subnet \
  --address=10.2.0.10 \
  --backend-service app-backend \
  --ports 8080 \
  --region us-central1

# åˆ›å»ºå…¨å±€å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨
gcloud compute backend-services create web-backend-global \
  --protocol HTTP \
  --port-name http \
  --health-checks web-health-check \
  --global

gcloud compute backend-services add-backend web-backend-global \
  --instance-group web-server-group \
  --instance-zone us-central1-a \
  --global

# åˆ›å»ºURLæ˜ å°„
gcloud compute url-maps create web-url-map \
  --default-service web-backend-global

# åˆ›å»ºç›®æ ‡HTTPä»£ç†
gcloud compute target-http-proxies create web-http-proxy \
  --url-map web-url-map

# åˆ›å»ºå…¨å±€è½¬å‘è§„åˆ™
gcloud compute forwarding-rules create web-forwarding-rule \
  --address 0.0.0.0 \
  --target-http-proxy web-http-proxy \
  --ports 80 \
  --global
```

#### æ­¥éª¤6ï¼šé…ç½®Cloud Armorå®‰å…¨ç­–ç•¥

```bash
# åˆ›å»ºå®‰å…¨ç­–ç•¥
gcloud compute security-policies create web-security-policy \
  --description="Web application security policy"

# å¯ç”¨é¢„é…ç½®WAFè§„åˆ™
gcloud compute security-policies rules create 1000 \
  --security-policy=web-security-policy \
  --expression="evaluatePreconfiguredExpr('xss-stable')" \
  --action="deny-403" \
  --description="Block XSS attacks"

# æ·»åŠ é€Ÿç‡é™åˆ¶
gcloud compute security-policies rules create 2000 \
  --security-policy=web-security-policy \
  --expression="request.path.startsWith('/')" \
  --action="rate-ban-429" \
  --rate-limit-threshold-count=100 \
  --rate-limit-threshold-interval-sec=60 \
  --conform-action="allow" \
  --description="Rate limiting for all requests"

# å°†å®‰å…¨ç­–ç•¥é™„åŠ åˆ°åç«¯æœåŠ¡
gcloud compute backend-services update web-backend-global \
  --security-policy=web-security-policy \
  --global
```

#### æ­¥éª¤7ï¼šæµ‹è¯•æ¶æ„

```bash
# è·å–å…¨å±€å¤–éƒ¨IPåœ°å€
EXTERNAL_IP=$(gcloud compute forwarding-rules describe web-forwarding-rule \
  --global --format="get(IPAddress)")

echo "External IP: $EXTERNAL_IP"

# æµ‹è¯•å¤–éƒ¨è®¿é—®
curl http://$EXTERNAL_IP

# æµ‹è¯•å¥åº·æ£€æŸ¥
gcloud compute backend-services get-health web-backend-global \
  --global

# æµ‹è¯•å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨
# SSHåˆ°WebæœåŠ¡å™¨
gcloud compute ssh web-server-000001 --zone us-central1-a --command="curl http://10.2.0.10/api/health"

# æµ‹è¯•å®‰å…¨ç­–ç•¥ï¼ˆæ¨¡æ‹ŸXSSæ”»å‡»ï¼‰
curl "http://$EXTERNAL_IP/?search=<script>alert('xss')</script>" -i
```

#### æ­¥éª¤8ï¼šæ¸…ç†èµ„æº

```bash
# åˆ é™¤è´Ÿè½½å‡è¡¡å™¨
gcloud compute forwarding-rules delete web-forwarding-rule --global
gcloud compute target-http-proxies delete web-http-proxy
gcloud compute url-maps delete web-url-map
gcloud compute backend-services delete web-backend-global --global

# åˆ é™¤å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨
gcloud compute forwarding-rules delete app-internal-lb --region us-central1
gcloud compute backend-services delete app-backend --region us-central1

gcloud compute forwarding-rules delete web-internal-lb --region us-central1
gcloud compute backend-services delete web-backend --region us-central1

# åˆ é™¤å¥åº·æ£€æŸ¥
gcloud compute health-checks delete web-health-check
gcloud compute health-checks delete app-health-check

# åˆ é™¤å®ä¾‹ç»„
gcloud compute instance-groups managed delete web-server-group --zone us-central1-a
gcloud compute instance-groups managed delete app-server-group --zone us-central1-a

# åˆ é™¤å®ä¾‹æ¨¡æ¿
gcloud compute instance-templates delete web-server-template
gcloud compute instance-templates delete app-server-template

# åˆ é™¤å®ä¾‹
gcloud compute instances delete database-server --zone us-central1-a

# åˆ é™¤é˜²ç«å¢™è§„åˆ™
gcloud compute firewall-rules delete allow-ssh
gcloud compute firewall-rules delete allow-app-to-db
gcloud compute firewall-rules delete allow-web-to-app
gcloud compute firewall-rules delete allow-external-to-web
gcloud compute firewall-rules delete deny-direct-db-access

# åˆ é™¤å®‰å…¨ç­–ç•¥
gcloud compute security-policies delete web-security-policy

# åˆ é™¤å­ç½‘
gcloud compute networks subnets delete web-subnet --region us-central1
gcloud compute networks subnets delete app-subnet --region us-central1
gcloud compute networks subnets delete db-subnet --region us-central1

# åˆ é™¤VPCç½‘ç»œ
gcloud compute networks delete secure-app-network

# åˆ é™¤æœåŠ¡è´¦æˆ·
gcloud iam service-accounts delete web-server-sa@${PROJECT_ID}.iam.gserviceaccount.com
gcloud iam service-accounts delete app-server-sa@${PROJECT_ID}.iam.gserviceaccount.com
gcloud iam service-accounts delete db-server-sa@${PROJECT_ID}.iam.gserviceaccount.com

# åˆ é™¤å¯†é’¥å’Œå¯†é’¥
gcloud secrets delete app-db-password
gcloud kms keys delete app-encryption-key --keyring=app-keyring --location=global
gcloud kms keyrings delete app-keyring --location=global
```

### å®éªŒæ€»ç»“

é€šè¿‡è¿™ä¸ªå®éªŒï¼Œæ‚¨å·²ç»ï¼š

1. **è®¾è®¡å¹¶å®æ–½äº†å¤šå±‚VPCç½‘ç»œæ¶æ„**ï¼Œå®ç°äº†ç½‘ç»œéš”ç¦»å’Œå®‰å…¨åˆ†å±‚
2. **é…ç½®äº†è´Ÿè½½å‡è¡¡å™¨**ï¼Œæé«˜äº†åº”ç”¨çš„å¯ç”¨æ€§å’Œæ€§èƒ½
3. **å®æ–½äº†å®‰å…¨ç»„å’Œé˜²ç«å¢™è§„åˆ™**ï¼Œé™åˆ¶äº†ä¸å¿…è¦çš„è®¿é—®
4. **é…ç½®äº†IAMæƒé™å’ŒæœåŠ¡è´¦æˆ·**ï¼Œå®ç°äº†æœ€å°æƒé™åŸåˆ™
5. **éƒ¨ç½²äº†å®‰å…¨æœåŠ¡**ï¼ŒåŒ…æ‹¬Cloud Armorã€KMSå’ŒSecret Manager

è¿™ä¸ªå®éªŒå±•ç¤ºäº†å¦‚ä½•ç»“åˆGCPçš„ç½‘ç»œå’Œå®‰å…¨æœåŠ¡ï¼Œæ„å»ºä¼ä¸šçº§çš„å®‰å…¨é«˜å¯ç”¨æ¶æ„ã€‚

---

## ğŸ“š æœ¬ç« å°ç»“

æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†ï¼š

1. **GCPç½‘ç»œæ¶æ„åŸºç¡€**ï¼šç½‘ç»œæ¨¡å‹ã€IPåœ°å€ç®¡ç†å’Œè¿æ¥æ€§
2. **VPCç½‘ç»œè¯¦è§£**ï¼šVPCç½‘ç»œã€å­ç½‘ã€é˜²ç«å¢™è§„åˆ™å’Œé«˜çº§åŠŸèƒ½
3. **è´Ÿè½½å‡è¡¡ä¸CDN**ï¼šä¸åŒç±»å‹è´Ÿè½½å‡è¡¡å™¨å’ŒCloud CDN
4. **èº«ä»½å’Œè®¿é—®ç®¡ç†(IAM)**ï¼šIAMè§’è‰²ã€æœåŠ¡è´¦æˆ·å’Œæœ€ä½³å®è·µ
5. **å®‰å…¨æœåŠ¡ä¸åˆè§„æ€§**ï¼šCloud Armorã€KMSã€Secret Managerå’Œåˆè§„æ€§
6. **ç»¼åˆå®éªŒ**ï¼šæ„å»ºå®‰å…¨é«˜å¯ç”¨æ¶æ„

### ğŸ¯ å…³é”®çŸ¥è¯†ç‚¹å›é¡¾

- **VPCç½‘ç»œ**æ˜¯GCPç½‘ç»œåŸºç¡€ï¼Œæ”¯æŒå…¨å±€ç½‘ç»œå’Œå­ç½‘åˆ’åˆ†
- **é˜²ç«å¢™è§„åˆ™**æ§åˆ¶ç½‘ç»œæµé‡ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
- **è´Ÿè½½å‡è¡¡å™¨**æé«˜åº”ç”¨å¯ç”¨æ€§å’Œæ€§èƒ½ï¼Œæœ‰ä¸åŒç±»å‹é€‚åº”ä¸åŒåœºæ™¯
- **IAM**æ˜¯GCPçš„å®‰å…¨åŸºç¡€ï¼Œé€šè¿‡è§’è‰²å’Œæƒé™ç®¡ç†èµ„æºè®¿é—®
- **æœåŠ¡è´¦æˆ·**ç”¨äºåº”ç”¨ç¨‹åºè®¿é—®GCPèµ„æºï¼Œæ¨èä½¿ç”¨è€Œéå¯†é’¥
- **å®‰å…¨æœåŠ¡**å¦‚Cloud Armorã€KMSå’ŒSecret Manageræä¾›äº†é¢å¤–çš„å®‰å…¨å±‚

### ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å¯ä»¥ï¼š

1. æ·±å…¥å®è·µç½‘ç»œå’Œå®‰å…¨æœåŠ¡çš„é«˜çº§åŠŸèƒ½
2. æ¢ç´¢ç½‘ç»œä¼˜åŒ–å’Œå®‰å…¨ç›‘æ§å·¥å…·
3. ç»§ç»­å­¦ä¹ ä¸‹ä¸€ç« "æ•°æ®ä¸æœºå™¨å­¦ä¹ æœåŠ¡"
4. å°è¯•å®Œæˆ[VPCç½‘ç»œç¤ºä¾‹](./code/vpc-network/)ä¸­çš„æ›´å¤šå®éªŒ

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

- [VPC ç½‘ç»œæ–‡æ¡£](https://cloud.google.com/vpc/docs)
- [è´Ÿè½½å‡è¡¡æ–‡æ¡£](https://cloud.google.com/load-balancing/docs)
- [Cloud Armor æ–‡æ¡£](https://cloud.google.com/armor/docs)
- [IAM æ–‡æ¡£](https://cloud.google.com/iam/docs)
- [KMS æ–‡æ¡£](https://cloud.google.com/kms/docs)

---

**ğŸ’¡ æç¤ºï¼šå®‰å…¨æ˜¯äº‘æ¶æ„çš„æ ¸å¿ƒè¦ç´ ã€‚è®¾è®¡ç½‘ç»œå’Œå®‰å…¨æ¶æ„æ—¶ï¼Œåº”éµå¾ªæ·±åº¦é˜²å¾¡åŸåˆ™ï¼Œä»ç½‘ç»œå±‚ã€åº”ç”¨å±‚åˆ°æ•°æ®å±‚å®æ–½å¤šå±‚æ¬¡ä¿æŠ¤ã€‚å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨ç­–ç•¥æ˜¯ä¿æŒç³»ç»Ÿå®‰å…¨çš„å…³é”®ã€‚**