# ç¬¬3ç« ï¼šé«˜çº§ç‰¹æ€§ä¸æ¨¡æ¿å¼•æ“

## ğŸ¯ æœ¬ç« ç›®æ ‡

- æŒæ¡Helmæ¨¡æ¿å¼•æ“çš„é«˜çº§åŠŸèƒ½
- ç†è§£å‘½åæ¨¡æ¿å’Œæ¨¡æ¿ç»§æ‰¿
- å­¦ä¼šä½¿ç”¨Sprigå‡½æ•°åº“
- æŒæ¡æ¨¡æ¿è°ƒè¯•å’Œä¼˜åŒ–æŠ€å·§

## ğŸ”§ å‘½åæ¨¡æ¿ä¸æ¨¡æ¿ç»§æ‰¿

### 3.1 å‘½åæ¨¡æ¿åŸºç¡€

å‘½åæ¨¡æ¿å…è®¸ä½ åœ¨å¤šä¸ªåœ°æ–¹é‡ç”¨æ¨¡æ¿ä»£ç ï¼š

```tpl
{{/* åœ¨ _helpers.tpl ä¸­å®šä¹‰å‘½åæ¨¡æ¿ */}}
{{- define "myapp.container" -}}
- name: {{ .Chart.Name }}
  image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
  ports:
  - containerPort: {{ .Values.service.port }}
  env:
  - name: APP_NAME
    value: {{ .Chart.Name }}
{{- end }}

{{/* ä½¿ç”¨å‘½åæ¨¡æ¿ */}}
spec:
  template:
    spec:
      containers:
      {{- include "myapp.container" . | nindent 8 }}
```

### 3.2 æ¨¡æ¿ä½œç”¨åŸŸå’Œå‚æ•°ä¼ é€’

å‘½åæ¨¡æ¿å¯ä»¥æ¥æ”¶å‚æ•°ï¼š

```tpl
{{/* å¸¦å‚æ•°çš„å‘½åæ¨¡æ¿ */}}
{{- define "myapp.envVar" -}}
{{- $name := .name -}}
{{- $value := .value -}}
- name: {{ $name }}
  value: {{ $value | quote }}
{{- end }}

{{/* ä½¿ç”¨å¸¦å‚æ•°çš„æ¨¡æ¿ */}}
env:
{{- range $key, $value := .Values.envVars }}
  {{- include "myapp.envVar" (dict "name" $key "value" $value) | nindent 2 }}
{{- end }}
```

### 3.3 æ¨¡æ¿ç»§æ‰¿å’Œç»„åˆ

é€šè¿‡æ¨¡æ¿ç»„åˆå®ç°å¤æ‚é€»è¾‘ï¼š

```tpl
{{/* åŸºç¡€æ¨¡æ¿ */}}
{{- define "myapp.base" -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "myapp.fullname" . }}
  labels:
    {{- include "myapp.labels" . | nindent 4 }}
{{- end }}

{{/* æ‰©å±•æ¨¡æ¿ */}}
{{- define "myapp.deployment" -}}
{{ include "myapp.base" . }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "myapp.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "myapp.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
{{- end }}
```

## ğŸ› ï¸ Sprigå‡½æ•°åº“è¯¦è§£

### 3.4 å­—ç¬¦ä¸²å‡½æ•°

Sprigæä¾›äº†ä¸°å¯Œçš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼š

```yaml
# å­—ç¬¦ä¸²æ“ä½œ
fullName: {{ .Values.firstName | upper | trunc 10 }}
slug: {{ .Values.appName | lower | replace " " "-" }}

# æ­£åˆ™è¡¨è¾¾å¼
email: {{ .Values.email | regexMatch "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$" }}

# å­—ç¬¦ä¸²åˆ†å‰²å’Œè¿æ¥
hosts: {{ .Values.hosts | split "," | join ";" }}

# ç¼©è¿›å’Œæ ¼å¼åŒ–
config: |
  {{- .Values.config | indent 2 }}
```

### 3.5 åˆ—è¡¨å’Œå­—å…¸å‡½æ•°

å¤„ç†å¤æ‚æ•°æ®ç»“æ„ï¼š

```yaml
# åˆ—è¡¨æ“ä½œ
{{- $ports := list 80 443 8080 -}}
ports: {{ $ports | join "," }}
firstPort: {{ first $ports }}
lastPort: {{ last $ports }}

# å­—å…¸æ“ä½œ
{{- $config := dict "host" "localhost" "port" 8080 -}}
host: {{ get $config "host" }}

# åˆå¹¶å­—å…¸
{{- $baseConfig := dict "timeout" 30 }}
{{- $overrideConfig := dict "timeout" 60 "retries" 3 }}
{{- $finalConfig := merge $baseConfig $overrideConfig }}
config: {{ $finalConfig | toJson }}
```

### 3.6 åŠ å¯†å’Œç¼–ç å‡½æ•°

å®‰å…¨ç›¸å…³çš„å‡½æ•°ï¼š

```yaml
# Base64ç¼–ç 
data: {{ .Values.secret | b64enc | quote }}

# SHA256å“ˆå¸Œ
checksum: {{ .Values.content | sha256sum }}

# UUIDç”Ÿæˆ
instanceId: {{ uuidv4 }}

# éšæœºå€¼ç”Ÿæˆ
password: {{ randAlphaNum 16 }}
```

## ğŸ” æµç¨‹æ§åˆ¶é«˜çº§æŠ€å·§

### 3.7 å¤æ‚æ¡ä»¶åˆ¤æ–­

```yaml
{{- if and .Values.autoscaling.enabled (gt .Values.autoscaling.maxReplicas 1) }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
{{- end }}

{{- if or .Values.ingress.enabled (eq .Values.service.type "LoadBalancer") }}
# éœ€è¦å¤–éƒ¨è®¿é—®çš„é…ç½®
{{- end }}

{{- if not .Values.debug }}
# ç”Ÿäº§ç¯å¢ƒé…ç½®
{{- end }}
```

### 3.8 å¾ªç¯å’ŒèŒƒå›´æ§åˆ¶

```yaml
{{- range $index, $service := .Values.services }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $service.name }}
  {{- if $index eq 0 }}
  annotations:
    primary: "true"
  {{- end }}
spec:
  ports:
  - port: {{ $service.port }}
    targetPort: {{ $service.targetPort }}
{{- end }}
```

### 3.9 æ¨¡æ¿åŒ…å«å’Œå—æ§åˆ¶

```yaml
{{/* å®šä¹‰å¯è¦†ç›–çš„å— */}}
{{- define "myapp.extraAnnotations" -}}
{{- /* é»˜è®¤å®ç°ä¸ºç©ºï¼Œå¯ä»¥è¢«è¦†ç›– */ -}}
{{- end }}

metadata:
  annotations:
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    {{- include "myapp.extraAnnotations" . | nindent 4 }}
```

## ğŸ¨ æ¨¡æ¿è°ƒè¯•å’Œä¼˜åŒ–

### 3.10 è°ƒè¯•æŠ€å·§

ä½¿ç”¨å†…ç½®å‡½æ•°è¿›è¡Œè°ƒè¯•ï¼š

```yaml
# æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆåªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼‰
{{- if .Values.debug }}
  {{- printf "Debug: Values=%v" .Values | trunc 0 | fail }}
{{- end }}

# éªŒè¯å¿…éœ€å‚æ•°
{{- if not .Values.image.repository }}
  {{- fail "image.repository is required" }}
{{- end }}

# ç±»å‹æ£€æŸ¥
{{- if not (kindIs "string" .Values.appName) }}
  {{- fail "appName must be a string" }}
{{- end }}
```

### 3.11 æ¨¡æ¿ä¼˜åŒ–æŠ€å·§

æé«˜æ¨¡æ¿æ€§èƒ½å’Œå¯è¯»æ€§ï¼š

```yaml
# é¿å…é‡å¤è®¡ç®—
{{- $fullname := include "myapp.fullname" . -}}
name: {{ $fullname }}
serviceName: {{ $fullname }}-service

# ä½¿ç”¨withç®€åŒ–ä½œç”¨åŸŸ
{{- with .Values.resources }}
resources:
  requests:
    cpu: {{ .requests.cpu }}
    memory: {{ .requests.memory }}
  limits:
    cpu: {{ .limits.cpu }}
    memory: {{ .limits.memory }}
{{- end }}

# åˆç†çš„ç¼©è¿›æ§åˆ¶
spec:
  template:
    spec:
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

## ğŸš€ é«˜çº§æ¨¡æ¿æ¨¡å¼

### 3.12 é…ç½®é©±åŠ¨æ¨¡æ¿

æ ¹æ®é…ç½®åŠ¨æ€ç”Ÿæˆèµ„æºï¼š

```yaml
{{- range $type, $config := .Values.storage }}
{{- if $config.enabled }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $type }}-pvc
spec:
  accessModes:
    - {{ $config.accessMode | default "ReadWriteOnce" }}
  resources:
    requests:
      storage: {{ $config.size }}
  {{- if $config.storageClass }}
  storageClassName: {{ $config.storageClass }}
  {{- end }}
{{- end }}
{{- end }}
```

### 3.13 æ¡ä»¶èµ„æºç”Ÿæˆ

```yaml
{{- if .Values.monitoring.enabled }}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "myapp.fullname" . }}
spec:
  selector:
    matchLabels:
      {{- include "myapp.selectorLabels" . | nindent 6 }}
  endpoints:
  - port: metrics
    interval: 30s
{{- end }}
```

### 3.14 æ¨¡æ¿ç»§æ‰¿ä½“ç³»

æ„å»ºå¤æ‚çš„æ¨¡æ¿å±‚æ¬¡ç»“æ„ï¼š

```tpl
{{/* _helpers.tpl */}}

{{/* åŸºç¡€èµ„æºæ¨¡æ¿ */}}
{{- define "myapp.resource" -}}
apiVersion: {{ .apiVersion }}
kind: {{ .kind }}
metadata:
  name: {{ .name }}
  {{- if .labels }}
  labels:
    {{- toYaml .labels | nindent 4 }}
  {{- end }}
{{- end }}

{{/* éƒ¨ç½²æ¨¡æ¿ */}}
{{- define "myapp.deployment" -}}
{{- $resource := dict "apiVersion" "apps/v1" "kind" "Deployment" "name" (include "myapp.fullname" .) "labels" (include "myapp.labels" . | fromYaml) }}
{{ include "myapp.resource" $resource }}
spec:
  # éƒ¨ç½²å…·ä½“é…ç½®
{{- end }}
```

## ğŸ§ª å®éªŒï¼šé«˜çº§æ¨¡æ¿å¼€å‘

### å®éªŒ1ï¼šæ„å»ºå¤æ‚çš„å¤šæœåŠ¡Chart

åˆ›å»ºæ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼çš„Chartï¼š

```bash
# åˆ›å»ºé«˜çº§Chartç»“æ„
helm create advanced-app
cd advanced-app

# ä¿®æ”¹æ¨¡æ¿æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼
```

**values.yaml**
```yaml
deployment:
  mode: "standard"  # standard, canary, blue-green
  replicas: 3

canary:
  enabled: false
  weight: 10

monitoring:
  enabled: true
  metrics:
    enabled: true
  tracing:
    enabled: false
```

### å®éªŒ2ï¼šæ¨¡æ¿è°ƒè¯•å’ŒéªŒè¯

```bash
# å¯ç”¨è°ƒè¯•æ¨¡å¼
helm install my-app . --set debug=true --dry-run --debug

# éªŒè¯æ¨¡æ¿è¯­æ³•
helm lint

# æµ‹è¯•è¾¹ç•Œæ¡ä»¶
helm template my-app . --set replicaCount=0
helm template my-app . --set replicaCount=100

# æ€§èƒ½æµ‹è¯•
helm template my-app . --output-dir ./large-output
```

### å®éªŒ3ï¼šSprigå‡½æ•°å®æˆ˜

åˆ›å»ºä½¿ç”¨å¤æ‚Sprigå‡½æ•°çš„æ¨¡æ¿ï¼š

```yaml
# åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨é«˜çº§å‡½æ•°
annotations:
  checksum/config: {{ .Values.config | sha256sum }}
  deploy-id: {{ now | date "20060102150405" }}
  instance: {{ randAlphaNum 8 | lower }}
```

## ğŸ“ æœ¬ç« æ€»ç»“

### å…³é”®çŸ¥è¯†ç‚¹

1. **å‘½åæ¨¡æ¿**ï¼šæ¨¡æ¿é‡ç”¨å’Œå‚æ•°ä¼ é€’
2. **æ¨¡æ¿ç»§æ‰¿**ï¼šæ„å»ºæ¨¡æ¿å±‚æ¬¡ç»“æ„
3. **Sprigå‡½æ•°åº“**ï¼šä¸°å¯Œçš„å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€åŠ å¯†å‡½æ•°
4. **æµç¨‹æ§åˆ¶**ï¼šå¤æ‚æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯
5. **è°ƒè¯•ä¼˜åŒ–**ï¼šæ¨¡æ¿è°ƒè¯•æŠ€å·§å’Œæ€§èƒ½ä¼˜åŒ–

### å®è·µæŠ€èƒ½

- âœ… èƒ½å¤Ÿåˆ›å»ºå¤æ‚çš„å‘½åæ¨¡æ¿ä½“ç³»
- âœ… æŒæ¡Sprigå‡½æ•°åº“çš„é«˜çº§ç”¨æ³•
- âœ… èƒ½å¤Ÿè¿›è¡Œæ¨¡æ¿è°ƒè¯•å’Œé”™è¯¯å¤„ç†
- âœ… èƒ½å¤Ÿä¼˜åŒ–æ¨¡æ¿æ€§èƒ½å’Œå¯è¯»æ€§
- âœ… èƒ½å¤Ÿæ„å»ºé…ç½®é©±åŠ¨çš„åŠ¨æ€æ¨¡æ¿

### æœ€ä½³å®è·µ

1. **æ¨¡æ¿æ¨¡å—åŒ–**ï¼šå°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºå¯é‡ç”¨çš„å‘½åæ¨¡æ¿
2. **å‡½æ•°é€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨å†…ç½®å‡½æ•°ï¼Œé¿å…å¤æ‚é€»è¾‘
3. **è°ƒè¯•å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’ŒéªŒè¯
4. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®—å’ŒåµŒå¥—
5. **æ–‡æ¡£å®Œæ•´**ï¼šä¸ºå¤æ‚æ¨¡æ¿æä¾›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜

### ä¸‹ä¸€æ­¥å­¦ä¹ 

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ Helmçš„éƒ¨ç½²ç­–ç•¥ï¼ŒåŒ…æ‹¬å‡çº§ç­–ç•¥ã€å›æ»šæœºåˆ¶ã€ç”Ÿå‘½å‘¨æœŸé’©å­ç­‰é«˜çº§éƒ¨ç½²ç‰¹æ€§ã€‚

---

**ğŸ’¡ æç¤ºï¼šå®Œæˆæœ¬ç« å­¦ä¹ åï¼Œå»ºè®®è¿›å…¥ `code/advanced-features/` ç›®å½•è¿›è¡Œå®è·µç»ƒä¹ ï¼Œå·©å›ºæ‰€å­¦çŸ¥è¯†ã€‚**