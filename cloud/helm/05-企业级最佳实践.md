# ç¬¬5ç« ï¼šä¼ä¸šçº§æœ€ä½³å®žè·µ

## ðŸŽ¯ æœ¬ç« ç›®æ ‡

- æŽŒæ¡ä¼ä¸šçº§Chartä»“åº“ç®¡ç†
- ç†è§£CI/CDä¸ŽHelmé›†æˆ
- å­¦ä¼šç›‘æŽ§å’Œå‘Šè­¦é…ç½®
- æŽŒæ¡å®‰å…¨å®¡è®¡å’Œåˆè§„æ€§

## ðŸ¢ Chartä»“åº“ç®¡ç†

### 5.1 ç§æœ‰Chartä»“åº“æ­å»º

#### ä½¿ç”¨ChartMuseum
```bash
# å®‰è£…ChartMuseum
helm repo add chartmuseum https://chartmuseum.github.io/charts
helm install chartmuseum chartmuseum/chartmuseum \
  --set env.open.DISABLE_API=false \
  --set persistence.enabled=true

# æ·»åŠ ç§æœ‰ä»“åº“
helm repo add my-private-repo http://chartmuseum.example.com

# æŽ¨é€Chartåˆ°ç§æœ‰ä»“åº“
helm package ./my-chart
curl --data-binary "@my-chart-0.1.0.tgz" http://chartmuseum.example.com/api/charts
```

#### ä½¿ç”¨Harbor
```bash
# Harboré›†æˆHelm
helm repo add harbor https://helm.goharbor.io
helm install harbor harbor/harbor \
  --set expose.type=ingress \
  --set expose.ingress.hosts.core=harbor.example.com

# é…ç½®Harborè®¤è¯
helm repo add harbor-repo https://harbor.example.com/chartrepo/my-project \
  --username admin --password Harbor12345
```

### 5.2 Chartç‰ˆæœ¬ç®¡ç†ç­–ç•¥

#### è¯­ä¹‰åŒ–ç‰ˆæœ¬æŽ§åˆ¶
```yaml
# Chart.yaml
apiVersion: v2
name: my-app
version: 1.2.3  # ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
appVersion: 2.0.0

dependencies:
  - name: postgresql
    version: "~11.0"  # å…¼å®¹11.xç‰ˆæœ¬
  - name: redis
    version: "^6.0"   # å…¼å®¹6.xåŠä»¥ä¸Šç‰ˆæœ¬
```

#### ç‰ˆæœ¬é”å®šæ–‡ä»¶
```yaml
# Chart.lock
dependencies:
- name: postgresql
  repository: https://charts.bitnami.com/bitnami
  version: 11.1.2
- name: redis
  repository: https://charts.bitnami.com/bitnami
  version: 16.5.0
digest: sha256:...
generated: "2023-01-01T00:00:00Z"
```

### 5.3 Chartç­¾åå’ŒéªŒè¯

```bash
# ç”ŸæˆGPGå¯†é’¥
gpg --gen-key

# æ‰“åŒ…å¹¶ç­¾åChart
helm package ./my-chart --sign --key "Your Name" --keyring ~/.gnupg/secring.gpg

# éªŒè¯Chartç­¾å
helm verify my-chart-0.1.0.tgz

# é…ç½®ä»“åº“éªŒè¯
helm repo add stable https://charts.helm.sh/stable --verify
```

## ðŸ”„ CI/CDé›†æˆ

### 5.4 GitOpså·¥ä½œæµ

#### ä½¿ç”¨Argo CD
```yaml
# application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/my-org/helm-charts
    targetRevision: HEAD
    path: charts/my-app
    helm:
      valueFiles:
      - values-prod.yaml
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

#### ä½¿ç”¨Flux CD
```yaml
# helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: my-app
  namespace: production
spec:
  interval: 5m
  chart:
    spec:
      chart: my-app
      version: "1.x"
      sourceRef:
        kind: HelmRepository
        name: my-repo
        namespace: flux-system
  values:
    replicaCount: 3
    image:
      tag: latest
```

### 5.5 è‡ªåŠ¨åŒ–æµæ°´çº¿

#### GitHub Actionsç¤ºä¾‹
```yaml
# .github/workflows/deploy.yml
name: Deploy to Kubernetes
on:
  push:
    branches: [ main ]
    paths:
    - 'charts/my-app/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Helm
      uses: azure/setup-helm@v3
    - name: Run helm lint
      run: helm lint charts/my-app
    - name: Run helm template
      run: helm template my-app charts/my-app --dry-run

  deploy-dev:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v3
    - name: Deploy to Dev
      run: |
        helm upgrade --install my-app charts/my-app \
          --namespace dev \
          --values charts/my-app/values-dev.yaml \
          --atomic --timeout 10m
```

#### GitLab CIç¤ºä¾‹
```yaml
# .gitlab-ci.yml
stages:
  - test
  - deploy

helm-lint:
  stage: test
  image: alpine/helm:3.12.0
  script:
    - helm lint charts/my-app

helm-template:
  stage: test
  image: alpine/helm:3.12.0
  script:
    - helm template my-app charts/my-app --dry-run

deploy-dev:
  stage: deploy
  image: alpine/helm:3.12.0
  environment:
    name: dev
  script:
    - helm upgrade --install my-app charts/my-app \
        --namespace dev \
        --values charts/my-app/values-dev.yaml \
        --atomic --timeout 10m
  only:
    - main
```

## ðŸ“Š ç›‘æŽ§å’Œå‘Šè­¦

### 5.6 åº”ç”¨ç›‘æŽ§é…ç½®

#### Prometheusç›‘æŽ§
```yaml
# values.yaml
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  metricRelabelings: []
  relabelings: []

prometheusRule:
  enabled: true
  rules:
    - alert: HighMemoryUsage
      expr: container_memory_usage_bytes{container="my-app"} / 1024 / 1024 > 512
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage"
        description: "Container memory usage is above 512MB"
```

#### Grafanaä»ªè¡¨æ¿
```yaml
# templates/grafana-dashboard.yaml
{{- if .Values.grafanaDashboard.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "myapp.fullname" . }}-dashboard
  labels:
    grafana_dashboard: "1"
data:
  my-app-dashboard.json: |
    {
      "title": "My App Dashboard",
      "panels": [
        {
          "title": "CPU Usage",
          "targets": [
            {
              "expr": "rate(container_cpu_usage_seconds_total{container=\"my-app\"}[5m])",
              "legendFormat": "{{pod}}"
            }
          ]
        }
      ]
    }
{{- end }}
```

### 5.7 æ—¥å¿—æ”¶é›†

#### Fluent Bité…ç½®
```yaml
# values.yaml
fluentbit:
  enabled: true
  config:
    service: |
      [SERVICE]
        Flush 1
        Daemon Off
        Log_Level info
    inputs: |
      [INPUT]
        Name tail
        Path /var/log/containers/*my-app*.log
        Tag kube.*
        Parser docker
```

## ðŸ”’ å®‰å…¨å®¡è®¡å’Œåˆè§„æ€§

### 5.8 å®‰å…¨æ‰«æ

#### ä½¿ç”¨Trivyæ‰«æé•œåƒ
```bash
# æ‰«æChartä¾èµ–
helm dependency build
find charts/ -name "*.tgz" -exec trivy config {} \;

# æ‰«æé•œåƒæ¼æ´ž
trivy image my-app:latest

# é›†æˆåˆ°CI/CD
- name: Scan image for vulnerabilities
  run: |
    trivy image --exit-code 1 --severity HIGH,CRITICAL my-app:latest
```

#### ä½¿ç”¨Checkovæ‰«æé…ç½®
```bash
# æ‰«æKubernetesé…ç½®
helm template my-app . --output-dir ./rendered
checkov -d ./rendered

# ä½¿ç”¨ç­–ç•¥å³ä»£ç 
checkov -d ./rendered --external-checks-dir ./policy
```

### 5.9 åˆè§„æ€§æ£€æŸ¥

#### Podå®‰å…¨æ ‡å‡†
```yaml
# values.yaml
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
```

#### ç½‘ç»œç­–ç•¥
```yaml
# templates/network-policy.yaml
{{- if .Values.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "myapp.fullname" . }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ include "myapp.name" . }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
{{- end }}
```

## ðŸš€ æ€§èƒ½ä¼˜åŒ–

### 5.10 Chartä¼˜åŒ–æŠ€å·§

#### æ¨¡æ¿ä¼˜åŒ–
```yaml
# é¿å…é‡å¤è®¡ç®—
{{- $fullname := include "myapp.fullname" . -}}
name: {{ $fullname }}

# ä½¿ç”¨withå‡å°‘ä½œç”¨åŸŸåµŒå¥—
{{- with .Values.resources }}
resources:
  requests:
    cpu: {{ .requests.cpu }}
    memory: {{ .requests.memory }}
{{- end }}

# åˆç†ä½¿ç”¨æ¡ä»¶åˆ¤æ–­
{{- if .Values.feature.enabled }}
# ç‰¹æ€§ç›¸å…³é…ç½®
{{- end }}
```

#### ä¾èµ–ä¼˜åŒ–
```yaml
# Chart.yaml
dependencies:
  - name: common-library
    version: "1.0.0"
    repository: "file://../common"
    condition: common-library.enabled
    tags:
      - shared
```

### 5.11 èµ„æºä¼˜åŒ–

#### HPAé…ç½®
```yaml
# values.yaml
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
```

#### èµ„æºè¯·æ±‚å’Œé™åˆ¶
```yaml
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi
```

## ðŸ§ª å®žéªŒï¼šä¼ä¸šçº§å®žè·µ

### å®žéªŒ1ï¼šæ­å»ºç§æœ‰Chartä»“åº“

```bash
# ä½¿ç”¨ChartMuseumæ­å»ºç§æœ‰ä»“åº“
helm repo add chartmuseum https://chartmuseum.github.io/charts
helm install chartmuseum chartmuseum/chartmuseum \
  --set env.open.DISABLE_API=false \
  --set persistence.enabled=true

# æ‰“åŒ…å’ŒæŽ¨é€Chart
helm package ./my-chart
curl --data-binary "@my-chart-0.1.0.tgz" \
  http://chartmuseum.example.com/api/charts

# ä»Žç§æœ‰ä»“åº“å®‰è£…
helm repo add my-repo http://chartmuseum.example.com
helm install my-app my-repo/my-chart
```

### å®žéªŒ2ï¼šé…ç½®CI/CDæµæ°´çº¿

```bash
# åˆ›å»ºGitHub Actionså·¥ä½œæµ
mkdir -p .github/workflows
cat > .github/workflows/deploy.yml << EOF
name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Deploy
      run: |
        helm upgrade --install my-app ./charts/my-app \
          --atomic --timeout 10m
EOF
```

### å®žéªŒ3ï¼šé…ç½®ç›‘æŽ§å‘Šè­¦

```bash
# éƒ¨ç½²Prometheusç›‘æŽ§
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack \
  --set grafana.adminPassword=admin

# é…ç½®åº”ç”¨ç›‘æŽ§
helm upgrade my-app ./charts/my-app \
  --set serviceMonitor.enabled=true \
  --set prometheusRule.enabled=true
```

## ðŸ“ æœ¬ç« æ€»ç»“

### å…³é”®çŸ¥è¯†ç‚¹

1. **Chartä»“åº“ç®¡ç†**ï¼šç§æœ‰ä»“åº“æ­å»ºã€ç‰ˆæœ¬æŽ§åˆ¶ã€ç­¾åéªŒè¯
2. **CI/CDé›†æˆ**ï¼šGitOpså·¥ä½œæµã€è‡ªåŠ¨åŒ–æµæ°´çº¿ã€çŽ¯å¢ƒç®¡ç†
3. **ç›‘æŽ§å‘Šè­¦**ï¼šåº”ç”¨ç›‘æŽ§ã€æ—¥å¿—æ”¶é›†ã€ä»ªè¡¨æ¿é…ç½®
4. **å®‰å…¨å®¡è®¡**ï¼šæ¼æ´žæ‰«æã€åˆè§„æ€§æ£€æŸ¥ã€å®‰å…¨ç­–ç•¥
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šChartä¼˜åŒ–ã€èµ„æºç®¡ç†ã€è‡ªåŠ¨æ‰©ç¼©å®¹

### å®žè·µæŠ€èƒ½

- âœ… èƒ½å¤Ÿæ­å»ºå’Œç®¡ç†ç§æœ‰Chartä»“åº“
- âœ… èƒ½å¤Ÿé…ç½®CI/CDæµæ°´çº¿å®žçŽ°è‡ªåŠ¨åŒ–éƒ¨ç½²
- âœ… èƒ½å¤Ÿé…ç½®å®Œæ•´çš„ç›‘æŽ§å’Œå‘Šè­¦ä½“ç³»
- âœ… èƒ½å¤Ÿå®žæ–½å®‰å…¨æ‰«æå’Œåˆè§„æ€§æ£€æŸ¥
- âœ… èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½ä¼˜åŒ–å’Œèµ„æºç®¡ç†

### ä¼ä¸šçº§æœ€ä½³å®žè·µ

1. **åŸºç¡€è®¾æ–½å³ä»£ç **ï¼šä½¿ç”¨GitOpsç®¡ç†æ‰€æœ‰é…ç½®
2. **å®‰å…¨ç¬¬ä¸€**ï¼šå®žæ–½å¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤
3. **è‡ªåŠ¨åŒ–ä¸€åˆ‡**ï¼šå‡å°‘æ‰‹åŠ¨æ“ä½œï¼Œæé«˜æ•ˆçŽ‡
4. **ç›‘æŽ§é©±åŠ¨**ï¼šåŸºäºŽæ•°æ®çš„å†³ç­–å’Œä¼˜åŒ–
5. **æŒç»­æ”¹è¿›**ï¼šå®šæœŸå›žé¡¾å’Œä¼˜åŒ–æµç¨‹

### ä¸“å®¶çº§å»ºè®®

- **æž¶æž„è®¾è®¡**ï¼šè€ƒè™‘å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§
- **å›¢é˜Ÿåä½œ**ï¼šå»ºç«‹æ¸…æ™°çš„èŒè´£å’Œæµç¨‹
- **æˆæœ¬æŽ§åˆ¶**ï¼šä¼˜åŒ–èµ„æºä½¿ç”¨ï¼ŒæŽ§åˆ¶äº‘æˆæœ¬
- **ç¾éš¾æ¢å¤**ï¼šåˆ¶å®šå®Œå–„çš„å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
- **çŸ¥è¯†ç®¡ç†**ï¼šå»ºç«‹å®Œå–„çš„æ–‡æ¡£å’ŒåŸ¹è®­ä½“ç³»

---

**ðŸŽ‰ æ­å–œï¼ä½ å·²ç»å®Œæˆäº†Helmä»Žå…¥é—¨åˆ°ä¸“å®¶çš„å­¦ä¹ æ—…ç¨‹ï¼**

é€šè¿‡è¿™5ä¸ªç« èŠ‚çš„ç³»ç»Ÿå­¦ä¹ ï¼Œä½ å·²ç»æŽŒæ¡äº†Helmçš„æ ¸å¿ƒæ¦‚å¿µã€Chartå¼€å‘ã€é«˜çº§ç‰¹æ€§ã€éƒ¨ç½²ç­–ç•¥å’Œä¼ä¸šçº§æœ€ä½³å®žè·µã€‚çŽ°åœ¨ä½ å·²ç»å…·å¤‡äº†åœ¨ä¼ä¸šçŽ¯å¢ƒä¸­ä½¿ç”¨Helmçš„ä¸“ä¸šèƒ½åŠ›ã€‚

**ä¸‹ä¸€æ­¥å»ºè®®ï¼š**
1. è¿›å…¥ `code/enterprise/` ç›®å½•è¿›è¡Œç»¼åˆå®žè·µ
2. åœ¨å®žé™…é¡¹ç›®ä¸­åº”ç”¨æ‰€å­¦çŸ¥è¯†
3. æŒç»­å…³æ³¨Helmç¤¾åŒºçš„æœ€æ–°å‘å±•
4. è€ƒè™‘èŽ·å–Helmç›¸å…³è®¤è¯

**è®°ä½ï¼šçœŸæ­£çš„ä¸“å®¶æ˜¯åœ¨å®žè·µä¸­ä¸æ–­å­¦ä¹ å’Œæˆé•¿çš„ï¼**