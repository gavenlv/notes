# 第2章：DevContainer配置文件详解

## 2.1 devcontainer.json 文件结构

`devcontainer.json` 是DevContainer的核心配置文件，它定义了开发容器的所有特性。让我们深入了解其完整结构。

### 基本结构

```json
{
    "name": "项目名称",
    "image": "基础镜像",
    "build": {
        "dockerfile": "Dockerfile路径",
        "context": "构建上下文"
    },
    "settings": {},
    "extensions": [],
    "forwardPorts": [],
    "postCreateCommand": "",
    "remoteUser": "vscode",
    "features": {},
    "customizations": {}
}
```

## 2.2 核心配置属性详解

### 2.2.1 名称和描述

```json
{
    "name": "Python数据分析环境",
    "description": "包含Python 3.9、Jupyter、常用数据科学库的开发环境"
}
```

### 2.2.2 镜像配置

**方式1：直接使用现有镜像**
```json
{
    "image": "mcr.microsoft.com/devcontainers/python:3.9"
}
```

**方式2：使用自定义Dockerfile**
```json
{
    "build": {
        "dockerfile": "Dockerfile",
        "context": ".",
        "args": {
            "VARIANT": "3.9"
        }
    }
}
```

### 2.2.3 端口转发

```json
{
    "forwardPorts": [
        3000,        // 前端开发服务器
        8000,        // 后端API服务器
        5432,        // PostgreSQL数据库
        8080         // 其他服务
    ],
    "portsAttributes": {
        "3000": {
            "label": "前端应用",
            "onAutoForward": "notify"
        },
        "8000": {
            "label": "后端API",
            "onAutoForward": "silent"
        }
    }
}
```

## 2.3 开发工具配置

### 2.3.1 VSCode扩展

```json
{
    "customizations": {
        "vscode": {
            "settings": {
                "editor.fontSize": 14,
                "python.defaultInterpreterPath": "/usr/local/bin/python"
            },
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance",
                "ms-vscode.vscode-json",
                "eamodio.gitlens"
            ]
        }
    }
}
```

### 2.3.2 功能特性（Features）

Features是预配置的软件包，可以快速添加到容器中：

```json
{
    "features": {
        "ghcr.io/devcontainers/features/node:1": {
            "nodeGypDependencies": true,
            "version": "18"
        },
        "ghcr.io/devcontainers/features/python:1": {
            "version": "3.9",
            "installJupyter": true
        },
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/docker-in-docker:2": {}
    }
}
```

## 2.4 生命周期钩子

### 2.4.1 创建后命令

```json
{
    "postCreateCommand": "pip install -r requirements.txt && npm install",
    "postStartCommand": "echo '容器已启动！'"
}
```

### 2.4.2 自定义脚本

```json
{
    "postCreateCommand": "bash .devcontainer/setup.sh"
}
```

## 2.5 高级配置

### 2.5.1 挂载卷配置

```json
{
    "mounts": [
        "source=${localWorkspaceFolder}/.cache,target=/home/vscode/.cache,type=bind",
        "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
    ]
}
```

### 2.5.2 环境变量

```json
{
    "remoteEnv": {
        "PATH": "/usr/local/bin:${PATH}",
        "PYTHONPATH": "/workspace",
        "DEBUG": "true"
    }
}
```

### 2.5.3 用户和权限

```json
{
    "remoteUser": "vscode",
    "updateRemoteUserUID": true
}
```

## 2.6 完整配置示例

### 示例1：Python数据科学环境

```json
{
    "name": "Python数据科学",
    "image": "mcr.microsoft.com/devcontainers/python:3.9",
    "features": {
        "ghcr.io/devcontainers/features/git:1": {}
    },
    "customizations": {
        "vscode": {
            "settings": {
                "python.defaultInterpreterPath": "/usr/local/bin/python",
                "python.linting.enabled": true,
                "python.formatting.autopep8Path": "/usr/local/py-utils/bin/autopep8"
            },
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance",
                "ms-toolsai.jupyter",
                "ms-toolsai.jupyter-keymap",
                "ms-toolsai.jupyter-renderers"
            ]
        }
    },
    "forwardPorts": [8888],
    "postCreateCommand": "pip install numpy pandas matplotlib seaborn scikit-learn jupyter",
    "remoteUser": "vscode"
}
```

### 示例2：Node.js全栈开发环境

```json
{
    "name": "Node.js全栈开发",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "features": {
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/docker-in-docker:2": {}
    },
    "customizations": {
        "vscode": {
            "settings": {
                "editor.formatOnSave": true,
                "eslint.validate": ["javascript", "typescript"]
            },
            "extensions": [
                "ms-vscode.vscode-typescript-next",
                "bradlc.vscode-tailwindcss",
                "esbenp.prettier-vscode",
                "dbaeumer.vscode-eslint"
            ]
        }
    },
    "forwardPorts": [3000, 3001, 5432],
    "postCreateCommand": "npm install -g @nestjs/cli && npm install",
    "portsAttributes": {
        "3000": {
            "label": "前端应用",
            "onAutoForward": "notify"
        }
    }
}
```

## 2.7 配置文件最佳实践

### 2.7.1 保持简洁

- 优先使用官方镜像和features
- 避免不必要的软件包安装
- 使用分层构建优化构建时间

### 2.7.2 版本控制

```json
{
    "image": "mcr.microsoft.com/devcontainers/python:3.9@sha256:abc123...",
    "features": {
        "ghcr.io/devcontainers/features/node:1": {
            "version": "18.17.0"
        }
    }
}
```

### 2.7.3 环境特定配置

```json
{
    "customizations": {
        "vscode": {
            "settings": {
                // 开发环境特定设置
                "python.terminal.activateEnvironment": false
            }
        }
    }
}
```

## 2.8 调试和故障排除

### 2.8.1 日志查看

```bash
# 查看DevContainer构建日志
docker logs <container_id>

# 查看VSCode DevContainer扩展日志
# 在VSCode中按 Ctrl+Shift+P，输入 "Developer: Show Logs"
```

### 2.8.2 常见问题

**问题1：端口被占用**
```json
{
    "forwardPorts": [3000],
    "appPort": [3000]  // 旧版本使用appPort
}
```

**问题2：权限错误**
```json
{
    "remoteUser": "vscode",
    "updateRemoteUserUID": true
}
```

**问题3：构建缓慢**
- 使用较小的基础镜像
- 利用Docker构建缓存
- 分阶段构建

## 2.9 本章总结

本章我们深入学习了：

- `devcontainer.json` 的完整结构
- 核心配置属性的详细用法
- 开发工具和扩展的配置
- 生命周期钩子的使用
- 高级配置选项
- 完整配置示例
- 最佳实践和故障排除

在下一章中，我们将学习如何为不同编程语言配置开发环境。

---

**实践任务**：
1. 为你当前的项目创建一个 `devcontainer.json` 文件
2. 尝试配置不同的features和扩展
3. 测试端口转发功能
4. 验证生命周期钩子的执行

**下一章**：[第3章：多语言开发环境配置](./03-多语言开发环境配置.md)