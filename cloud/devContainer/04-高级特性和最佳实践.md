# ç¬¬4ç« ï¼šé«˜çº§ç‰¹æ€§å’Œæœ€ä½³å®è·µ

## 4.1 é«˜çº§é…ç½®ç‰¹æ€§

### 4.1.1 å¤šå®¹å™¨å¼€å‘ç¯å¢ƒ

ä½¿ç”¨Docker Composeç®¡ç†å¤šä¸ªæœåŠ¡å®¹å™¨ï¼š

```json
{
    "name": "å¾®æœåŠ¡å¼€å‘ç¯å¢ƒ",
    "dockerComposeFile": [
        "docker-compose.yml",
        "docker-compose.override.yml"
    ],
    "service": "app",
    "workspaceFolder": "/workspace",
    "shutdownAction": "stopCompose",
    "remoteUser": "vscode"
}
```

å¯¹åº”çš„ `docker-compose.yml`:

```yaml
version: '3.8'
services:
  app:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    command: sleep infinity
    depends_on:
      - postgres
      - redis
      - elasticsearch

  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

volumes:
  postgres_data:
  es_data:
```

### 4.1.2 æ¡ä»¶é…ç½®

æ ¹æ®ç¯å¢ƒå˜é‡æˆ–æ–‡ä»¶å­˜åœ¨æ€§è¿›è¡Œæ¡ä»¶é…ç½®ï¼š

```json
{
    "name": "æ¡ä»¶é…ç½®ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
        "ghcr.io/devcontainers/features/node:1": {
            "version": "18"
        }
    },
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-typescript-next",
                "esbenp.prettier-vscode"
            ]
        }
    },
    "postCreateCommand": "if [ -f package.json ]; then npm install; fi",
    "postStartCommand": "if [ \"$NODE_ENV\" = \"development\" ]; then npm run dev; fi"
}
```

### 4.1.3 è‡ªå®šä¹‰æ„å»ºå‚æ•°

```json
{
    "name": "è‡ªå®šä¹‰æ„å»º",
    "build": {
        "dockerfile": "Dockerfile",
        "context": ".",
        "args": {
            "NODE_VERSION": "18",
            "PYTHON_VERSION": "3.11",
            "BUILD_TYPE": "development"
        }
    },
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-vscode.vscode-typescript-next",
                "ms-python.python"
            ]
        }
    }
}
```

å¯¹åº”çš„ `Dockerfile`:

```dockerfile
ARG NODE_VERSION=18
ARG PYTHON_VERSION=3.11
ARG BUILD_TYPE=development

FROM mcr.microsoft.com/devcontainers/base:ubuntu

# å®‰è£…Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && \
    apt-get install -y nodejs

# å®‰è£…Python
RUN apt-get update && apt-get install -y python${PYTHON_VERSION} python3-pip

# æ ¹æ®æ„å»ºç±»å‹å®‰è£…ä¸åŒå·¥å…·
RUN if [ "$BUILD_TYPE" = "development" ]; then \
        npm install -g nodemon; \
    fi

WORKDIR /workspace
```

## 4.2 æ€§èƒ½ä¼˜åŒ–

### 4.2.1 æ„å»ºç¼“å­˜ä¼˜åŒ–

```dockerfile
# ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒå¤§å°
FROM mcr.microsoft.com/devcontainers/base:ubuntu as base

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential

# å¼€å‘é˜¶æ®µ
FROM base as development

# å®‰è£…å¼€å‘å·¥å…·
RUN apt-get install -y \
    nodejs \
    npm \
    python3 \
    python3-pip

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json ./
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

WORKDIR /workspace
```

### 4.2.2 å·æ˜ å°„ä¼˜åŒ–

```json
{
    "name": "æ€§èƒ½ä¼˜åŒ–ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "mounts": [
        "type=bind,source=${localWorkspaceFolder},target=/workspace",
        "type=volume,source=node_modules,target=/workspace/node_modules",
        "type=volume,source=vscode-extensions,target=/home/vscode/.vscode-server/extensions"
    ],
    "runArgs": [
        "--memory=2g",
        "--cpus=2"
    ]
}
```

### 4.2.3 èµ„æºé™åˆ¶é…ç½®

```json
{
    "name": "èµ„æºé™åˆ¶ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "runArgs": [
        "--memory=4g",
        "--memory-swap=4g",
        "--cpus=2.0",
        "--pids-limit=512"
    ],
    "containerEnv": {
        "NODE_OPTIONS": "--max-old-space-size=2048"
    }
}
```

## 4.3 å®‰å…¨æœ€ä½³å®è·µ

### 4.3.1 æœ€å°æƒé™åŸåˆ™

```json
{
    "name": "å®‰å…¨é…ç½®ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "remoteUser": "vscode",
    "updateRemoteUserUID": true,
    "runArgs": [
        "--user=vscode",
        "--security-opt=no-new-privileges"
    ],
    "containerEnv": {
        "HOME": "/home/vscode"
    }
}
```

### 4.3.2 å®‰å…¨æ‰«æ

```json
{
    "name": "å®‰å…¨æ‰«æç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
        "ghcr.io/devcontainers/features/node:1": {
            "version": "18"
        }
    },
    "postCreateCommand": "npm audit --audit-level=moderate"
}
```

### 4.3.3 æ•æ„Ÿä¿¡æ¯ç®¡ç†

```json
{
    "name": "å®‰å…¨ç¯å¢ƒé…ç½®",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "containerEnv": {
        "DATABASE_URL": "${localEnv:DATABASE_URL}",
        "API_KEY": "${localEnv:API_KEY}"
    },
    "mounts": [
        "type=bind,source=${localWorkspaceFolder}/.env,target=/workspace/.env,readonly"
    ]
}
```

## 4.4 å›¢é˜Ÿåä½œæœ€ä½³å®è·µ

### 4.4.1 ç»Ÿä¸€å¼€å‘ç¯å¢ƒ

```json
{
    "name": "å›¢é˜Ÿç»Ÿä¸€ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "features": {
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/docker-in-docker:2": {}
    },
    "customizations": {
        "vscode": {
            "settings": {
                "editor.formatOnSave": true,
                "editor.codeActionsOnSave": {
                    "source.fixAll.eslint": true
                },
                "eslint.validate": ["javascript", "typescript"]
            },
            "extensions": [
                "ms-vscode.vscode-typescript-next",
                "esbenp.prettier-vscode",
                "dbaeumer.vscode-eslint",
                "eamodio.gitlens"
            ]
        }
    },
    "postCreateCommand": "npm install && git config --global user.name '${localEnv:GIT_USER_NAME}' && git config --global user.email '${localEnv:GIT_USER_EMAIL}'"
}
```

### 4.4.2 é¢„é…ç½®è„šæœ¬

åˆ›å»º `.devcontainer/setup.sh` è„šæœ¬ï¼š

```bash
#!/bin/bash

# è®¾ç½®å¼€å‘ç¯å¢ƒ
set -e

echo "ğŸš€ å¼€å§‹è®¾ç½®å¼€å‘ç¯å¢ƒ..."

# å®‰è£…é¡¹ç›®ä¾èµ–
if [ -f "package.json" ]; then
    echo "ğŸ“¦ å®‰è£…Node.jsä¾èµ–..."
    npm install
fi

if [ -f "requirements.txt" ]; then
    echo "ğŸ å®‰è£…Pythonä¾èµ–..."
    pip install -r requirements.txt
fi

# è®¾ç½®Gité…ç½®
if [ ! -z "$GIT_USER_NAME" ] && [ ! -z "$GIT_USER_EMAIL" ]; then
    echo "ğŸ”§ é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
    git config --global user.name "$GIT_USER_NAME"
    git config --global user.email "$GIT_USER_EMAIL"
fi

# è®¾ç½®å¼€å‘å·¥å…·
if [ -f ".devcontainer/post-setup.sh" ]; then
    echo "âš™ï¸ è¿è¡Œé¡¹ç›®ç‰¹å®šè®¾ç½®..."
    bash .devcontainer/post-setup.sh
fi

echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆï¼"
```

åœ¨ `devcontainer.json` ä¸­å¼•ç”¨ï¼š

```json
{
    "postCreateCommand": "bash .devcontainer/setup.sh"
}
```

## 4.5 è°ƒè¯•å’Œæ•…éšœæ’é™¤

### 4.5.1 è°ƒè¯•é…ç½®

```json
{
    "name": "è°ƒè¯•ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "customizations": {
        "vscode": {
            "settings": {
                "debug.internalConsoleOptions": "openOnSessionStart",
                "debug.onTaskErrors": "showErrors"
            },
            "extensions": [
                "ms-vscode.vscode-js-debug"
            ]
        }
    },
    "portsAttributes": {
        "9229": {
            "label": "Node.js Debugger",
            "onAutoForward": "notify"
        }
    }
}
```

### 4.5.2 æ—¥å¿—å’Œç›‘æ§

```json
{
    "name": "ç›‘æ§ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
        "ghcr.io/devcontainers/features/node:1": {
            "version": "18"
        }
    },
    "postCreateCommand": "npm install -g pm2",
    "postStartCommand": "pm2 start ecosystem.config.js --env development && pm2 logs"
}
```

## 4.6 CI/CDé›†æˆ

### 4.6.1 GitHub Actionsé›†æˆ

åˆ›å»º `.github/workflows/devcontainer.yml`:

```yaml
name: DevContainer CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up DevContainer
      uses: devcontainers/ci@v0.3
      with:
        imageName: myapp-devcontainer
        runCmd: |
          npm install
          npm test
          
    - name: Build and test
      run: |
        docker build -t myapp-test .
        docker run myapp-test npm test
```

### 4.6.2 è‡ªåŠ¨åŒ–æµ‹è¯•

```json
{
    "name": "CI/CDæµ‹è¯•ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "features": {
        "ghcr.io/devcontainers/features/git:1": {}
    },
    "postCreateCommand": "npm install",
    "postStartCommand": "npm test"
}
```

## 4.7 ç¯å¢ƒå˜é‡ç®¡ç†

### 4.7.1 åˆ†å±‚ç¯å¢ƒé…ç½®

åˆ›å»ºå¤šä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š

- `.devcontainer/.env.development`
- `.devcontainer/.env.test`
- `.devcontainer/.env.production`

åœ¨ `devcontainer.json` ä¸­åŠ¨æ€åŠ è½½ï¼š

```json
{
    "name": "ç¯å¢ƒé…ç½®",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "containerEnv": {
        "NODE_ENV": "${localEnv:NODE_ENV:-development}"
    },
    "postCreateCommand": "if [ -f .devcontainer/.env.${NODE_ENV} ]; then set -a && source .devcontainer/.env.${NODE_ENV} && set +a; fi"
}
```

### 4.7.2 å¯†é’¥ç®¡ç†

```json
{
    "name": "å¯†é’¥ç®¡ç†ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "mounts": [
        "type=bind,source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh,readonly"
    ],
    "containerEnv": {
        "GITHUB_TOKEN": "${localEnv:GITHUB_TOKEN}",
        "AWS_ACCESS_KEY_ID": "${localEnv:AWS_ACCESS_KEY_ID}",
        "AWS_SECRET_ACCESS_KEY": "${localEnv:AWS_SECRET_ACCESS_KEY}"
    }
}
```

## 4.8 æ‰©å±•å¼€å‘

### 4.8.1 è‡ªå®šä¹‰Features

åˆ›å»ºè‡ªå®šä¹‰Featureï¼š

```json
// .devcontainer/features/custom-tools/devcontainer-feature.json
{
    "id": "custom-tools",
    "version": "1.0.0",
    "name": "Custom Development Tools",
    "description": "å®‰è£…è‡ªå®šä¹‰å¼€å‘å·¥å…·",
    "options": {
        "version": {
            "type": "string",
            "description": "å·¥å…·ç‰ˆæœ¬",
            "default": "latest"
        }
    },
    "installsAfter": ["ghcr.io/devcontainers/features/common-utils"]
}
```

å¯¹åº”çš„å®‰è£…è„šæœ¬ï¼š

```bash
#!/bin/bash

set -e

# å®‰è£…è‡ªå®šä¹‰å·¥å…·
apt-get update && apt-get install -y \
    jq \
    yq \
    httpie \
    bat \
    fd-find \
    ripgrep

# æ¸…ç†ç¼“å­˜
apt-get clean && rm -rf /var/lib/apt/lists/*

echo "âœ… è‡ªå®šä¹‰å·¥å…·å®‰è£…å®Œæˆ"
```

### 4.8.2 æ’ä»¶å¼€å‘

åˆ›å»ºVSCodeæ‰©å±•é…ç½®ï¼š

```json
{
    "name": "æ‰©å±•å¼€å‘ç¯å¢ƒ",
    "image": "mcr.microsoft.com/devcontainers/javascript-node:18",
    "customizations": {
        "vscode": {
            "settings": {
                "extensions.autoCheckUpdates": false,
                "extensions.autoUpdate": false
            },
            "extensions": [
                "ms-vscode.vscode-typescript-next",
                "ms-vscode.extension-test-runner"
            ]
        }
    },
    "postCreateCommand": "npm install -g @vscode/vsce && npm install"
}
```

## 4.9 æœ¬ç« æ€»ç»“

æœ¬ç« æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†DevContainerçš„é«˜çº§ç‰¹æ€§å’Œæœ€ä½³å®è·µï¼š

- **å¤šå®¹å™¨ç¯å¢ƒé…ç½®**ï¼šä½¿ç”¨Docker Composeç®¡ç†å¤æ‚æœåŠ¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ„å»ºç¼“å­˜ã€èµ„æºé™åˆ¶ã€å·æ˜ å°„ä¼˜åŒ–
- **å®‰å…¨æœ€ä½³å®è·µ**ï¼šæœ€å°æƒé™ã€å®‰å…¨æ‰«æã€æ•æ„Ÿä¿¡æ¯ç®¡ç†
- **å›¢é˜Ÿåä½œ**ï¼šç»Ÿä¸€ç¯å¢ƒé…ç½®ã€é¢„é…ç½®è„šæœ¬
- **è°ƒè¯•å’Œç›‘æ§**ï¼šè°ƒè¯•é…ç½®ã€æ—¥å¿—ç®¡ç†
- **CI/CDé›†æˆ**ï¼šGitHub Actionsã€è‡ªåŠ¨åŒ–æµ‹è¯•
- **ç¯å¢ƒå˜é‡ç®¡ç†**ï¼šåˆ†å±‚é…ç½®ã€å¯†é’¥ç®¡ç†
- **æ‰©å±•å¼€å‘**ï¼šè‡ªå®šä¹‰Featuresã€æ’ä»¶å¼€å‘

è¿™äº›é«˜çº§ç‰¹æ€§å¯ä»¥å¸®åŠ©ä½ æ„å»ºæ›´åŠ å¼ºå¤§ã€å®‰å…¨ã€é«˜æ•ˆçš„å¼€å‘ç¯å¢ƒã€‚

---

**å®è·µä»»åŠ¡**ï¼š
1. ä¸ºä½ çš„é¡¹ç›®é…ç½®å¤šå®¹å™¨å¼€å‘ç¯å¢ƒ
2. å®æ–½å®‰å…¨æœ€ä½³å®è·µ
3. é…ç½®CI/CDæµæ°´çº¿
4. åˆ›å»ºè‡ªå®šä¹‰Features

**ä¸‹ä¸€ç« **ï¼š[ç¬¬5ç« ï¼šå®æˆ˜é¡¹ç›®æ¡ˆä¾‹](./05-å®æˆ˜é¡¹ç›®æ¡ˆä¾‹.md)