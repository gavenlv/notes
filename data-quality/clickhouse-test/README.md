# ClickHouse 数据质量测试环境

这个目录包含了一个完整的ClickHouse测试环境，用于测试数据质量框架。它包括表结构定义、测试数据和数据质量检查规则，以及改进版的数据质量检查器。

## 文件结构

- `schema.sql`: 包含测试表的DDL定义
- `insert_data.sql`: 包含测试数据的插入语句，包括一些有问题的数据用于测试
- `quality_rules.yml`: 包含数据质量检查规则
- `run_test.py`: 运行整个测试流程的Python脚本
- `improved_quality_checker.py`: 改进版数据质量检查器
- `run_improved_test.py`: 运行改进版测试的Python脚本
- `config.yml`: 改进版配置文件
- `README.md`: 本文档

## 测试表结构

测试环境包含以下表：

1. `users`: 用户表，包含用户基本信息
2. `customers`: 客户表，包含客户信息
3. `orders`: 订单表，包含订单信息，引用客户表
4. `products`: 产品表，包含产品信息
5. `order_items`: 订单明细表，包含订单项信息，引用订单表和产品表

## 数据质量检查规则

测试环境包含以下类型的数据质量检查规则：

1. **完整性检查**: 检查用户表中的空值和缺失值
2. **准确性检查**: 检查产品表中的数据范围
3. **一致性检查**: 检查订单表和客户表之间的引用完整性
4. **大小写敏感性检查**: 检查用户表中邮箱的大小写一致性

## 使用方法

### 前提条件

1. 安装ClickHouse服务器
2. 安装Python依赖：
   ```bash
   pip install clickhouse-driver PyYAML
   ```

### 运行测试

#### 原始版本
```bash
# 运行原始版本测试流程
python clickhouse-test/run_test.py
```

#### 改进版本
```bash
# 运行改进版测试流程
python clickhouse-test/run_improved_test.py
```

这将执行以下步骤：
1. 连接到ClickHouse服务器
2. 执行DDL创建测试表
3. 插入测试数据
4. 运行数据质量检查
5. 打印检查结果
6. 生成增强版报告

### 命令行参数（改进版）

```bash
python run_improved_test.py --help
```

可用参数：
- `--host` - ClickHouse 服务器主机（默认：localhost）
- `--port` - ClickHouse 服务器端口（默认：9000）
- `--user` - ClickHouse 用户名（默认：default）
- `--password` - ClickHouse 密码（默认：空）
- `--database` - ClickHouse 数据库名（默认：data_quality_test）
- `--schema` - Schema SQL 文件路径（默认：clickhouse-test/schema.sql）
- `--data` - 数据插入 SQL 文件路径（默认：clickhouse-test/insert_data.sql）
- `--config` - 配置文件路径（默认：configs/data-quality-config.yml）
- `--rules` - 规则文件路径（默认：clickhouse-test/quality_rules.yml）
- `--skip-setup` - 跳过环境设置（不创建表和插入数据）

### 查看报告

报告将保存在`reports`目录下，包括：
- JSON格式的详细报告（quality_report_YYYYMMDD_HHMMSS.json）
- 文本格式的摘要报告（quality_report_YYYYMMDD_HHMMSS.txt）
- HTML格式的可视化报告（quality_report_YYYYMMDD_HHMMSS.html）（仅改进版）

## 数据质量问题和改进建议

在测试数据中，我们故意插入了一些有问题的数据，以测试数据质量框架的有效性。这些问题包括：

### 发现的问题

1. **完整性问题**:
   - 用户表中存在空邮箱和空名称
   - 用户表中存在重复的用户ID

2. **准确性问题**:
   - 产品表中存在超出范围的价格和重量
   - 产品表中存在负库存

3. **一致性问题**:
   - 订单表中存在无效的客户ID引用
   - 订单表中存在空客户ID

4. **大小写敏感性问题**:
   - 用户表中存在大写邮箱

### 已实现的改进

1. **数据质量框架改进**:
   - ✅ 添加更详细的错误报告，包括具体的违规记录样本
   - ✅ 添加并行执行功能，提高检查效率
   - ✅ 增强错误处理和日志记录，提供更详细的错误信息
   - ✅ 添加配置验证，确保格式正确
   - ✅ 根据检查结果设置适当的退出码，便于集成到CI/CD流程

2. **数据验证改进**:
   - ✅ 收集并展示违规记录的样本，帮助理解和修复数据问题
   - ✅ 为规则添加优先级（高、中、低），便于关注最重要的问题
   - ✅ 按类别和优先级统计检查结果，提供更全面的视图
   - ✅ 增强数据范围验证功能，支持最小值和最大值检查

3. **报告改进**:
   - ✅ 支持JSON、文本和HTML格式的报告
   - ✅ 提供更详细的摘要信息，包括通过率、失败率等
   - ✅ 按类别和优先级展示检查结果
   - ✅ 在报告中包含违规记录的样本
   - ✅ HTML报告中添加简单的样式和格式化，提高可读性

4. **架构改进**:
   - ✅ 将功能拆分为独立的模块，提高代码可维护性
   - ✅ 将配置与代码分离，便于调整参数
   - ✅ 提供灵活的命令行接口，支持各种参数
   - ✅ 设计易于扩展的架构，便于添加新的检查类型和报告格式

### 未来改进建议

1. **数据质量框架进一步改进**:
   - 支持自动修复简单的数据问题
   - 添加数据质量趋势分析，跟踪问题随时间的变化
   - 添加更多类型的数据质量检查，如格式验证、业务规则验证等

2. **数据验证进一步改进**:
   - 在数据插入前添加验证逻辑
   - 使用ClickHouse的约束功能（如CHECK约束）
   - 实现实时数据质量监控

3. **报告进一步改进**:
   - 添加更丰富的可视化报告，如图表和仪表板
   - 添加问题分类和根本原因分析
   - 支持报告比较，对比不同时间点的数据质量状况

4. **架构进一步改进**:
   - 使用物化视图自动计算数据质量指标
   - 实现增量数据质量检查，只检查新数据
   - 添加数据血缘跟踪，了解问题的来源和影响
   - 实现分布式数据质量检查，支持大规模数据集

## 结论

这个测试环境展示了如何使用ClickHouse和数据质量框架来检测和报告数据问题。通过故意插入有问题的数据，我们可以验证框架的有效性，并找出需要改进的地方。

改进版数据质量检查器实现了许多之前建议的改进，包括更详细的错误报告、违规样本收集、多格式报告和更灵活的配置。这些改进大大增强了数据质量框架的功能和可用性。

通过实施未来的改进建议，可以进一步增强数据质量框架的功能和可用性，使其更好地满足实际业务需求，特别是在大规模数据环境和实时数据处理场景中。