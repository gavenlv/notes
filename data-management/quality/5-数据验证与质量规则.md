# 第5章：数据验证与质量规则

## 5.1 数据验证概述

数据验证是确保数据符合预定义规则和标准的过程，是数据质量管理的重要组成部分。通过建立系统化的数据验证机制，我们可以及时发现和纠正数据质量问题，确保数据的准确性、一致性和可靠性。

### 5.1.1 什么是数据验证

数据验证是指检查数据是否符合特定规则、约束和业务逻辑的过程。它包括对数据的格式、范围、类型、唯一性、一致性等方面进行检查，以确保数据满足预期的质量标准。

### 5.1.2 数据验证的重要性

1. **预防数据错误**：在数据进入系统之前就识别和阻止错误数据
2. **保证数据一致性**：确保不同系统和数据源之间的数据保持一致
3. **提高数据可信度**：通过验证机制增强用户对数据的信任
4. **降低业务风险**：避免因数据质量问题导致的错误决策

### 5.1.3 数据验证的基本原则

1. **及时性**：在数据录入或传输的第一时间进行验证
2. **全面性**：覆盖数据的所有关键属性和业务规则
3. **可追溯性**：记录验证过程和结果，便于问题追踪
4. **自动化**：尽可能使用自动化工具和规则引擎执行验证

## 5.2 数据验证的类型

### 5.2.1 格式验证

格式验证确保数据符合预定义的格式要求。

#### 常见格式验证规则

1. **邮箱格式验证**
```regex
^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$
```

2. **电话号码格式验证**
```regex
^1[3-9]\d{9}$
```

3. **日期格式验证**
```regex
^\d{4}-\d{2}-\d{2}$
```

4. **身份证号码格式验证**
```regex
^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$
```

#### 格式验证实现示例

```python
import re

def validate_email(email):
    """验证邮箱格式"""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return bool(re.match(pattern, str(email)))

def validate_phone(phone):
    """验证手机号码格式"""
    pattern = r'^1[3-9]\d{9}$'
    return bool(re.match(pattern, str(phone)))

def validate_date(date_str):
    """验证日期格式"""
    pattern = r'^\d{4}-\d{2}-\d{2}$'
    if not re.match(pattern, date_str):
        return False
    # 进一步验证日期的有效性
    try:
        datetime.strptime(date_str, '%Y-%m-%d')
        return True
    except ValueError:
        return False
```

### 5.2.2 范围验证

范围验证确保数据值在允许的范围内。

#### 数值范围验证

```python
def validate_age(age):
    """验证年龄范围"""
    try:
        age = int(age)
        return 0 <= age <= 150
    except (ValueError, TypeError):
        return False

def validate_salary(salary):
    """验证薪资范围"""
    try:
        salary = float(salary)
        return 0 <= salary <= 1000000
    except (ValueError, TypeError):
        return False
```

#### 日期范围验证

```python
from datetime import datetime

def validate_birth_date(birth_date):
    """验证出生日期范围"""
    try:
        birth_dt = datetime.strptime(birth_date, '%Y-%m-%d')
        current_dt = datetime.now()
        # 出生日期不能是未来日期，也不能超过150年前
        min_date = current_dt.replace(year=current_dt.year - 150)
        return min_date <= birth_dt <= current_dt
    except ValueError:
        return False
```

### 5.2.3 类型验证

类型验证确保数据符合预期的数据类型。

```python
def validate_data_type(value, expected_type):
    """验证数据类型"""
    try:
        if expected_type == 'int':
            int(value)
        elif expected_type == 'float':
            float(value)
        elif expected_type == 'str':
            str(value)
        elif expected_type == 'bool':
            if str(value).lower() not in ['true', 'false', '1', '0']:
                return False
        return True
    except (ValueError, TypeError):
        return False
```

### 5.2.4 唯一性验证

唯一性验证确保特定字段或字段组合的值是唯一的。

```python
def validate_uniqueness(df, columns):
    """验证指定列的唯一性"""
    if isinstance(columns, str):
        columns = [columns]
    
    duplicate_count = df.duplicated(subset=columns, keep=False).sum()
    return duplicate_count == 0, duplicate_count

def validate_primary_key(df, primary_key_column):
    """验证主键唯一性"""
    null_count = df[primary_key_column].isnull().sum()
    duplicate_count = df.duplicated(subset=[primary_key_column], keep=False).sum()
    
    is_valid = (null_count == 0) and (duplicate_count == 0)
    return is_valid, {
        'null_count': null_count,
        'duplicate_count': duplicate_count
    }
```

### 5.2.5 一致性验证

一致性验证确保相关数据之间保持逻辑一致性。

```python
def validate_age_consistency(birth_date, current_age):
    """验证年龄与出生日期的一致性"""
    try:
        birth_dt = datetime.strptime(birth_date, '%Y-%m-%d')
        current_dt = datetime.now()
        calculated_age = current_dt.year - birth_dt.year - (
            (current_dt.month, current_dt.day) < (birth_dt.month, birth_dt.day)
        )
        return abs(calculated_age - int(current_age)) <= 1
    except (ValueError, TypeError):
        return False

def validate_order_amount(order_items, total_amount):
    """验证订单金额与明细的一致性"""
    try:
        calculated_total = sum(item['quantity'] * item['unit_price'] for item in order_items)
        return abs(calculated_total - float(total_amount)) < 0.01  # 允许小数精度误差
    except (KeyError, ValueError, TypeError):
        return False
```

### 5.2.6 业务规则验证

业务规则验证确保数据符合特定的业务逻辑和约束。

```python
def validate_business_rule(data, rule_name):
    """验证业务规则"""
    rules = {
        'employee_retirement_age': lambda data: data['age'] <= 65 if data['employment_status'] == 'employed' else True,
        'minor_credit_card': lambda data: data['age'] >= 18 if data['payment_method'] == 'credit_card' else True,
        'premium_customer_min_purchase': lambda data: data['annual_purchase'] >= 10000 if data['customer_level'] == 'premium' else True
    }
    
    if rule_name in rules:
        return rules[rule_name](data)
    else:
        raise ValueError(f"未知的业务规则: {rule_name}")
```

## 5.3 数据质量规则体系

### 5.3.1 规则分类

#### 1. 基础规则

基础规则是数据质量的最基本要求：

- **非空规则**：关键字段不能为空
- **格式规则**：数据必须符合预定义格式
- **类型规则**：数据必须是正确的数据类型
- **范围规则**：数值必须在合理范围内

#### 2. 业务规则

业务规则反映具体的业务逻辑：

- **逻辑关系规则**：相关字段之间必须满足特定逻辑关系
- **约束规则**：数据必须满足业务约束条件
- **计算规则**：派生字段必须能通过计算验证

#### 3. 一致性规则

一致性规则确保数据在不同系统和时间点保持一致：

- **跨系统一致性**：同一数据在不同系统中应该一致
- **时间一致性**：历史数据不应该被修改
- **引用一致性**：外键引用必须有效

### 5.3.2 规则定义方法

#### 1. 基于配置的规则定义

```yaml
# data_quality_rules.yaml
rules:
  - name: "customer_email_format"
    description: "客户邮箱格式验证"
    type: "format"
    field: "email"
    pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    severity: "error"
  
  - name: "customer_age_range"
    description: "客户年龄范围验证"
    type: "range"
    field: "age"
    min_value: 0
    max_value: 150
    severity: "warning"
  
  - name: "order_amount_consistency"
    description: "订单金额一致性验证"
    type: "consistency"
    fields: ["quantity", "unit_price", "total_amount"]
    formula: "quantity * unit_price = total_amount"
    tolerance: 0.01
    severity: "error"
```

#### 2. 基于代码的规则定义

```python
class DataQualityRule:
    """数据质量规则基类"""
    
    def __init__(self, name, description, severity='error'):
        self.name = name
        self.description = description
        self.severity = severity
    
    def validate(self, data):
        """验证数据，子类需要实现"""
        raise NotImplementedError

class FormatRule(DataQualityRule):
    """格式规则"""
    
    def __init__(self, name, description, field, pattern, severity='error'):
        super().__init__(name, description, severity)
        self.field = field
        self.pattern = re.compile(pattern)
    
    def validate(self, data):
        if self.field not in data:
            return False, f"字段 {self.field} 不存在"
        
        value = str(data[self.field])
        if self.pattern.match(value):
            return True, "验证通过"
        else:
            return False, f"字段 {self.field} 格式不正确: {value}"

class RangeRule(DataQualityRule):
    """范围规则"""
    
    def __init__(self, name, description, field, min_value, max_value, severity='error'):
        super().__init__(name, description, severity)
        self.field = field
        self.min_value = min_value
        self.max_value = max_value
    
    def validate(self, data):
        if self.field not in data:
            return False, f"字段 {self.field} 不存在"
        
        try:
            value = float(data[self.field])
            if self.min_value <= value <= self.max_value:
                return True, "验证通过"
            else:
                return False, f"字段 {self.field} 值 {value} 超出范围 [{self.min_value}, {self.max_value}]"
        except (ValueError, TypeError):
            return False, f"字段 {self.field} 值 {data[self.field]} 无法转换为数值"
```

### 5.3.3 规则管理

#### 1. 规则版本控制

```python
class RuleVersionManager:
    """规则版本管理器"""
    
    def __init__(self):
        self.rules = {}
        self.versions = {}
    
    def add_rule(self, rule, version="1.0"):
        """添加规则"""
        rule_key = f"{rule.name}_{version}"
        self.rules[rule_key] = rule
        if rule.name not in self.versions:
            self.versions[rule.name] = []
        self.versions[rule.name].append(version)
    
    def get_rule(self, rule_name, version=None):
        """获取规则"""
        if version is None:
            # 获取最新版本
            if rule_name in self.versions:
                latest_version = sorted(self.versions[rule_name], reverse=True)[0]
                rule_key = f"{rule_name}_{latest_version}"
                return self.rules.get(rule_key)
        else:
            rule_key = f"{rule_name}_{version}"
            return self.rules.get(rule_key)
        
        return None
```

#### 2. 规则执行引擎

```python
class RuleEngine:
    """规则引擎"""
    
    def __init__(self):
        self.rules = []
        self.results = []
    
    def add_rule(self, rule):
        """添加规则"""
        self.rules.append(rule)
    
    def validate_record(self, record):
        """验证单条记录"""
        record_results = []
        for rule in self.rules:
            is_valid, message = rule.validate(record)
            record_results.append({
                'rule_name': rule.name,
                'is_valid': is_valid,
                'message': message,
                'severity': rule.severity
            })
        return record_results
    
    def validate_dataset(self, dataset):
        """验证数据集"""
        all_results = []
        for idx, record in dataset.iterrows():
            record_dict = record.to_dict()
            record_results = self.validate_record(record_dict)
            all_results.extend([{
                'record_id': idx,
                'record_data': record_dict,
                **result
            } for result in record_results])
        return all_results
```

## 5.4 数据验证框架设计

### 5.4.1 验证框架架构

一个完整的数据验证框架应该包含以下组件：

1. **规则定义层**：定义和管理各种验证规则
2. **规则执行层**：执行验证规则并生成结果
3. **结果管理层**：存储和管理验证结果
4. **报告展示层**：生成验证报告和可视化展示

### 5.4.2 框架实现示例

```python
import pandas as pd
import json
from datetime import datetime
from typing import List, Dict, Any

class DataQualityValidator:
    """数据质量验证器"""
    
    def __init__(self):
        self.rules = []
        self.validation_results = []
        self.validation_history = []
    
    def add_rule(self, rule):
        """添加验证规则"""
        self.rules.append(rule)
    
    def load_rules_from_config(self, config_file):
        """从配置文件加载规则"""
        with open(config_file, 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        for rule_config in config['rules']:
            rule_type = rule_config['type']
            if rule_type == 'format':
                rule = FormatRule(
                    name=rule_config['name'],
                    description=rule_config['description'],
                    field=rule_config['field'],
                    pattern=rule_config['pattern'],
                    severity=rule_config.get('severity', 'error')
                )
            elif rule_type == 'range':
                rule = RangeRule(
                    name=rule_config['name'],
                    description=rule_config['description'],
                    field=rule_config['field'],
                    min_value=rule_config['min_value'],
                    max_value=rule_config['max_value'],
                    severity=rule_config.get('severity', 'error')
                )
            # 可以继续添加其他类型的规则
            self.add_rule(rule)
    
    def validate_dataframe(self, df, dataset_name="unknown"):
        """验证DataFrame"""
        print(f"开始验证数据集: {dataset_name}")
        print(f"数据集大小: {df.shape}")
        
        validation_run_id = f"run_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        run_results = {
            'run_id': validation_run_id,
            'dataset_name': dataset_name,
            'timestamp': datetime.now().isoformat(),
            'total_records': len(df),
            'validation_results': []
        }
        
        # 统计信息
        total_violations = 0
        error_violations = 0
        warning_violations = 0
        
        # 逐条记录验证
        for idx, record in df.iterrows():
            record_dict = record.to_dict()
            record_violations = []
            
            for rule in self.rules:
                is_valid, message = rule.validate(record_dict)
                if not is_valid:
                    violation = {
                        'record_id': idx,
                        'rule_name': rule.name,
                        'field': getattr(rule, 'field', 'unknown'),
                        'severity': rule.severity,
                        'message': message,
                        'record_data': {k: str(v) for k, v in record_dict.items()}
                    }
                    record_violations.append(violation)
                    total_violations += 1
                    if rule.severity == 'error':
                        error_violations += 1
                    elif rule.severity == 'warning':
                        warning_violations += 1
            
            if record_violations:
                run_results['validation_results'].extend(record_violations)
        
        # 添加统计信息
        run_results['summary'] = {
            'total_violations': total_violations,
            'error_violations': error_violations,
            'warning_violations': warning_violations,
            'error_rate': error_violations / len(df) if len(df) > 0 else 0,
            'warning_rate': warning_violations / len(df) if len(df) > 0 else 0
        }
        
        self.validation_results = run_results
        self.validation_history.append(run_results)
        
        print(f"验证完成:")
        print(f"  总违规数: {total_violations}")
        print(f"  错误级违规: {error_violations}")
        print(f"  警告级违规: {warning_violations}")
        
        return run_results
    
    def generate_report(self, output_file=None):
        """生成验证报告"""
        if not self.validation_results:
            print("没有验证结果可报告")
            return
        
        report = {
            'validation_run': self.validation_results,
            'detailed_violations': self.validation_results['validation_results']
        }
        
        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(report, f, ensure_ascii=False, indent=2)
            print(f"验证报告已保存到: {output_file}")
        
        return report
    
    def get_violations_by_severity(self, severity='error'):
        """按严重程度获取违规记录"""
        if not self.validation_results:
            return []
        
        violations = [
            v for v in self.validation_results['validation_results']
            if v['severity'] == severity
        ]
        return violations
    
    def get_violations_by_rule(self, rule_name):
        """按规则名称获取违规记录"""
        if not self.validation_results:
            return []
        
        violations = [
            v for v in self.validation_results['validation_results']
            if v['rule_name'] == rule_name
        ]
        return violations
```

## 5.5 实践案例：客户数据质量验证

让我们通过一个实际的客户数据验证案例来演示如何应用数据验证规则。

### 5.5.1 数据准备

```python
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

def create_customer_data():
    """创建客户数据示例"""
    np.random.seed(42)
    
    # 创建基础数据
    n_customers = 1000
    customer_data = {
        'customer_id': range(10001, 10001 + n_customers),
        'name': [f'Customer_{i}' for i in range(1, n_customers + 1)],
        'email': [f'customer{i}@example.com' for i in range(1, n_customers + 1)],
        'phone': [f'138{np.random.randint(10000000, 99999999)}' for _ in range(n_customers)],
        'age': np.random.randint(18, 80, n_customers),
        'registration_date': pd.date_range('2020-01-01', periods=n_customers, freq='D'),
        'annual_income': np.random.normal(50000, 15000, n_customers),
        'credit_score': np.random.randint(300, 850, n_customers)
    }
    
    df = pd.DataFrame(customer_data)
    
    # 添加一些数据质量问题
    # 1. 无效邮箱
    invalid_email_indices = np.random.choice(n_customers, 20, replace=False)
    df.loc[invalid_email_indices[:10], 'email'] = 'invalid-email'
    df.loc[invalid_email_indices[10:], 'email'] = '@invalid.com'
    
    # 2. 无效电话号码
    invalid_phone_indices = np.random.choice(n_customers, 15, replace=False)
    df.loc[invalid_phone_indices[:5], 'phone'] = '12345'
    df.loc[invalid_phone_indices[5:], 'phone'] = '138123456789'
    
    # 3. 年龄异常
    age_outlier_indices = np.random.choice(n_customers, 10, replace=False)
    df.loc[age_outlier_indices[:5], 'age'] = np.random.randint(100, 150, 5)
    df.loc[age_outlier_indices[5:], 'age'] = np.random.randint(-10, 0, 5)
    
    # 4. 收入异常
    income_outlier_indices = np.random.choice(n_customers, 8, replace=False)
    df.loc[income_outlier_indices[:4], 'annual_income'] = np.random.uniform(1000000, 2000000, 4)
    df.loc[income_outlier_indices[4:], 'annual_income'] = np.random.uniform(-50000, 0, 4)
    
    # 5. 信用分数异常
    credit_outlier_indices = np.random.choice(n_customers, 12, replace=False)
    df.loc[credit_outlier_indices[:6], 'credit_score'] = np.random.randint(900, 1000, 6)
    df.loc[credit_outlier_indices[6:], 'credit_score'] = np.random.randint(-100, 0, 6)
    
    # 6. 缺失值
    missing_indices = np.random.choice(n_customers, 25, replace=False)
    df.loc[missing_indices[:10], 'email'] = None
    df.loc[missing_indices[10:20], 'phone'] = None
    df.loc[missing_indices[20:], 'age'] = None
    
    return df

# 创建客户数据
customer_df = create_customer_data()
print("客户数据示例:")
print(customer_df.head(10))
print(f"\n数据形状: {customer_df.shape}")
```

### 5.5.2 定义验证规则

```python
# 创建规则配置文件
rules_config = {
    "rules": [
        {
            "name": "customer_email_format",
            "description": "客户邮箱格式验证",
            "type": "format",
            "field": "email",
            "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
            "severity": "error"
        },
        {
            "name": "customer_phone_format",
            "description": "客户电话号码格式验证",
            "type": "format",
            "field": "phone",
            "pattern": "^1[3-9]\\d{9}$",
            "severity": "error"
        },
        {
            "name": "customer_age_range",
            "description": "客户年龄范围验证",
            "type": "range",
            "field": "age",
            "min_value": 0,
            "max_value": 150,
            "severity": "error"
        },
        {
            "name": "customer_income_range",
            "description": "客户年收入范围验证",
            "type": "range",
            "field": "annual_income",
            "min_value": 0,
            "max_value": 1000000,
            "severity": "warning"
        },
        {
            "name": "customer_credit_score_range",
            "description": "客户信用分数范围验证",
            "type": "range",
            "field": "credit_score",
            "min_value": 300,
            "max_value": 850,
            "severity": "error"
        },
        {
            "name": "customer_email_required",
            "description": "客户邮箱必填验证",
            "type": "required",
            "field": "email",
            "severity": "error"
        },
        {
            "name": "customer_phone_required",
            "description": "客户电话必填验证",
            "type": "required",
            "field": "phone",
            "severity": "warning"
        }
    ]
}

# 保存规则配置
import json
with open('customer_data_quality_rules.json', 'w', encoding='utf-8') as f:
    json.dump(rules_config, f, ensure_ascii=False, indent=2)
```

### 5.5.3 扩展规则类型

```python
class RequiredRule(DataQualityRule):
    """必填规则"""
    
    def __init__(self, name, description, field, severity='error'):
        super().__init__(name, description, severity)
        self.field = field
    
    def validate(self, data):
        if self.field not in data:
            return False, f"字段 {self.field} 不存在"
        
        value = data[self.field]
        if pd.isna(value) or value == '' or value is None:
            return False, f"字段 {self.field} 不能为空"
        else:
            return True, "验证通过"

# 更新规则引擎以支持必填规则
def create_extended_rule_engine():
    """创建扩展的规则引擎"""
    validator = DataQualityValidator()
    validator.load_rules_from_config('customer_data_quality_rules.json')
    
    # 手动添加必填规则（如果配置文件加载不支持）
    required_rules = [
        RequiredRule("customer_email_required", "客户邮箱必填验证", "email", "error"),
        RequiredRule("customer_phone_required", "客户电话必填验证", "phone", "warning")
    ]
    
    for rule in required_rules:
        validator.add_rule(rule)
    
    return validator
```

### 5.5.4 执行数据验证

```python
def run_customer_data_validation():
    """执行客户数据验证"""
    print("=== 客户数据质量验证 ===\n")
    
    # 创建验证器
    validator = create_extended_rule_engine()
    
    # 执行验证
    results = validator.validate_dataframe(customer_df, "customer_data")
    
    # 生成报告
    report = validator.generate_report("customer_data_quality_report.json")
    
    # 分析结果
    print("\n=== 验证结果分析 ===")
    
    # 按严重程度统计
    error_violations = validator.get_violations_by_severity('error')
    warning_violations = validator.get_violations_by_severity('warning')
    
    print(f"错误级违规: {len(error_violations)} 条")
    print(f"警告级违规: {len(warning_violations)} 条")
    
    # 按规则统计
    print("\n按规则统计违规情况:")
    rule_stats = {}
    for violation in results['validation_results']:
        rule_name = violation['rule_name']
        if rule_name not in rule_stats:
            rule_stats[rule_name] = {'error': 0, 'warning': 0}
        rule_stats[rule_name][violation['severity']] += 1
    
    for rule_name, stats in rule_stats.items():
        print(f"  {rule_name}: 错误 {stats['error']}, 警告 {stats['warning']}")
    
    # 显示部分违规示例
    print("\n部分违规示例:")
    for i, violation in enumerate(error_violations[:5]):
        print(f"  {i+1}. 规则: {violation['rule_name']}")
        print(f"     消息: {violation['message']}")
        print(f"     记录ID: {violation['record_id']}")
        print(f"     数据: {violation['record_data']}")
        print()
    
    return validator, results

# 执行验证
validator, results = run_customer_data_validation()
```

### 5.5.5 验证结果可视化

```python
import matplotlib.pyplot as plt
import seaborn as sns

def visualize_validation_results(validator):
    """可视化验证结果"""
    
    if not validator.validation_results:
        print("没有验证结果可可视化")
        return
    
    results = validator.validation_results
    violations = results['validation_results']
    
    # 创建图表
    fig, axes = plt.subplots(2, 2, figsize=(15, 12))
    fig.suptitle('数据质量验证结果分析', fontsize=16)
    
    # 1. 严重程度分布
    severity_counts = {'error': results['summary']['error_violations'],
                      'warning': results['summary']['warning_violations']}
    axes[0, 0].pie(severity_counts.values(), labels=severity_counts.keys(), autopct='%1.1f%%')
    axes[0, 0].set_title('违规严重程度分布')
    
    # 2. 规则违规数量
    rule_violations = {}
    for violation in violations:
        rule_name = violation['rule_name']
        rule_violations[rule_name] = rule_violations.get(rule_name, 0) + 1
    
    rule_names = list(rule_violations.keys())
    violation_counts = list(rule_violations.values())
    
    axes[0, 1].bar(range(len(rule_names)), violation_counts)
    axes[0, 1].set_xlabel('规则名称')
    axes[0, 1].set_ylabel('违规数量')
    axes[0, 1].set_title('各规则违规数量')
    axes[0, 1].set_xticks(range(len(rule_names)))
    axes[0, 1].set_xticklabels(rule_names, rotation=45, ha='right')
    
    # 3. 违规趋势（按记录ID）
    if violations:
        record_ids = [v['record_id'] for v in violations]
        axes[1, 0].hist(record_ids, bins=50, alpha=0.7)
        axes[1, 0].set_xlabel('记录ID')
        axes[1, 0].set_ylabel('违规数量')
        axes[1, 0].set_title('违规记录分布')
    
    # 4. 数据质量评分
    total_records = results['total_records']
    error_rate = results['summary']['error_rate']
    quality_score = (1 - error_rate) * 100
    
    axes[1, 1].bar(['数据质量评分'], [quality_score], color='green')
    axes[1, 1].set_ylabel('分数 (%)')
    axes[1, 1].set_ylim(0, 100)
    axes[1, 1].text(0, quality_score + 2, f'{quality_score:.1f}%', ha='center')
    axes[1, 1].set_title('整体数据质量评分')
    
    plt.tight_layout()
    plt.show()

# 可视化结果
visualize_validation_results(validator)
```

## 5.6 数据验证最佳实践

### 5.6.1 规则设计原则

1. **业务导向**：规则应该反映真实的业务需求和约束
2. **可维护性**：规则应该易于理解和修改
3. **性能考虑**：避免过于复杂的规则影响验证性能
4. **版本控制**：对规则进行版本管理，便于追踪变更

### 5.6.2 验证策略

#### 1. 分层验证

```python
class LayeredValidator:
    """分层验证器"""
    
    def __init__(self):
        self.validators = {
            'format': [],      # 格式验证
            'business': [],    # 业务验证
            'consistency': []  # 一致性验证
        }
    
    def add_validator(self, layer, validator):
        """添加验证器到指定层"""
        if layer in self.validators:
            self.validators[layer].append(validator)
    
    def validate(self, data):
        """分层验证"""
        results = {}
        
        # 1. 格式验证（快速失败）
        format_results = []
        for validator in self.validators['format']:
            result = validator.validate(data)
            format_results.append(result)
            if not result[0]:  # 如果格式验证失败，停止后续验证
                results['format'] = format_results
                results['business'] = []
                results['consistency'] = []
                return results
        
        results['format'] = format_results
        
        # 2. 业务验证
        business_results = []
        for validator in self.validators['business']:
            result = validator.validate(data)
            business_results.append(result)
        results['business'] = business_results
        
        # 3. 一致性验证
        consistency_results = []
        for validator in self.validators['consistency']:
            result = validator.validate(data)
            consistency_results.append(result)
        results['consistency'] = consistency_results
        
        return results
```

#### 2. 增量验证

```python
class IncrementalValidator:
    """增量验证器"""
    
    def __init__(self, full_validator):
        self.full_validator = full_validator
        self.last_validation_time = None
        self.validated_records = set()
    
    def validate_new_records(self, df, timestamp_column='updated_at'):
        """验证新增或修改的记录"""
        if self.last_validation_time is None:
            # 首次验证，验证所有记录
            return self.full_validator.validate(df)
        
        # 只验证新增或修改的记录
        new_records = df[df[timestamp_column] > self.last_validation_time]
        if len(new_records) > 0:
            results = self.full_validator.validate(new_records)
            # 更新已验证记录集合
            self.validated_records.update(new_records.index)
            return results
        else:
            return {'validation_results': [], 'summary': {'total_violations': 0}}
    
    def update_validation_time(self):
        """更新验证时间"""
        self.last_validation_time = datetime.now()
```

### 5.6.3 验证结果管理

```python
class ValidationResultManager:
    """验证结果管理器"""
    
    def __init__(self):
        self.results_storage = []
    
    def store_results(self, results):
        """存储验证结果"""
        results['stored_at'] = datetime.now().isoformat()
        self.results_storage.append(results)
    
    def get_recent_results(self, hours=24):
        """获取最近的验证结果"""
        cutoff_time = datetime.now() - timedelta(hours=hours)
        recent_results = [
            result for result in self.results_storage
            if datetime.fromisoformat(result['stored_at']) > cutoff_time
        ]
        return recent_results
    
    def generate_trend_report(self):
        """生成趋势报告"""
        if not self.results_storage:
            return None
        
        trend_data = []
        for result in self.results_storage:
            trend_data.append({
                'timestamp': result['stored_at'],
                'total_records': result['total_records'],
                'error_violations': result['summary']['error_violations'],
                'warning_violations': result['summary']['warning_violations'],
                'error_rate': result['summary']['error_rate']
            })
        
        return pd.DataFrame(trend_data)
```

## 5.7 小结

本章深入探讨了数据验证与质量规则的相关内容，包括各种类型的验证方法、规则体系设计、验证框架实现等。我们通过客户数据的实际案例演示了如何应用这些技术和方法来确保数据质量。

下一章我们将学习数据质量监控与告警机制，了解如何建立持续的数据质量监控体系。

---

**思考题：**
1. 在您的业务场景中，哪些数据验证规则最为关键？如何确保这些规则的有效性？
2. 如何平衡数据验证的严格性和用户体验？

**实践练习：**
选择您工作中的一个数据表，设计一套完整的数据验证规则，并实现一个验证框架来执行这些规则。

**延伸阅读：**
- "Data Quality: The Accuracy Dimension" by Jack Olson
- "Data Quality Rules Management" by IBM
- Great Expectations documentation
- Deequ documentation