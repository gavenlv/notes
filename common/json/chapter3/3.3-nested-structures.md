# 3.3 嵌套结构与复杂数据表示

## 嵌套结构概述

JSON的强大之处在于其能够表示复杂的嵌套数据结构。通过对象和数组的组合，可以创建层次丰富、关系复杂的数据模型，准确反映现实世界中的各种实体和关系。

## 嵌套结构的基本模式

### 1. 对象嵌套对象

对象可以嵌套在其他对象中，形成层次结构，适用于表示实体的组成部分或详细属性。

```json
{
  "user": {
    "id": "user_123",
    "name": "张三",
    "contact": {
      "email": "zhangsan@example.com",
      "phone": {
        "mobile": "138-0000-0000",
        "home": "010-12345678",
        "work": "010-87654321"
      },
      "address": {
        "street": "人民路123号",
        "city": "北京",
        "state": "北京",
        "zipCode": "100000",
        "country": "中国"
      }
    },
    "profile": {
      "personal": {
        "birthDate": "1990-01-15",
        "gender": "男",
        "maritalStatus": "已婚"
      },
      "professional": {
        "jobTitle": "软件工程师",
        "company": "科技公司",
        "experience": "5年",
        "skills": ["JavaScript", "Python", "React"]
      },
      "preferences": {
        "ui": {
          "theme": "dark",
          "language": "zh-CN",
          "fontSize": 16
        },
        "notifications": {
          "email": true,
          "sms": false,
          "push": true,
          "frequency": "daily"
        }
      }
    }
  }
}
```

### 2. 数组嵌套数组

数组可以嵌套在其他数组中，形成多维数据结构，适用于表示矩阵、张量或多维数据。

```json
{
  "matrix": {
    "name": "变换矩阵",
    "size": [3, 3],
    "data": [
      [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1]
    ]
  },
  "image": {
    "width": 3,
    "height": 3,
    "pixels": [
      [
        [255, 0, 0],    // 红色
        [255, 255, 0],  // 黄色
        [255, 0, 0]     // 红色
      ],
      [
        [255, 255, 0],  // 黄色
        [255, 255, 255],// 白色
        [255, 255, 0]   // 黄色
      ],
      [
        [255, 0, 0],    // 红色
        [255, 255, 0],  // 黄色
        [255, 0, 0]     // 红色
      ]
    ]
  },
  "tensor": {
    "dimensions": [2, 2, 2],
    "data": [
      [
        [1, 2],
        [3, 4]
      ],
      [
        [5, 6],
        [7, 8]
      ]
    ]
  }
}
```

### 3. 对象包含数组

对象可以包含数组作为值，适用于表示实体的列表属性或多值属性。

```json
{
  "blog": {
    "id": "blog_001",
    "title": "JSON入门指南",
    "author": {
      "id": "author_001",
      "name": "张三",
      "email": "zhangsan@example.com"
    },
    "categories": [
      {
        "id": "cat_001",
        "name": "技术",
        "slug": "tech"
      },
      {
        "id": "cat_002",
        "name": "教程",
        "slug": "tutorial"
      }
    ],
    "tags": ["JSON", "JavaScript", "Web开发", "教程"],
    "chapters": [
      {
        "id": "ch_001",
        "title": "JSON简介",
        "sections": [
          {
            "id": "sec_001",
            "title": "什么是JSON",
            "content": "JSON是JavaScript对象表示法..."
          },
          {
            "id": "sec_002",
            "title": "JSON的历史",
            "content": "JSON起源于JavaScript..."
          }
        ]
      },
      {
        "id": "ch_002",
        "title": "JSON语法",
        "sections": [
          {
            "id": "sec_003",
            "title": "基本语法",
            "content": "JSON的基本语法规则..."
          }
        ]
      }
    ],
    "comments": [
      {
        "id": "comment_001",
        "author": "李四",
        "email": "lisi@example.com",
        "content": "很好的文章！学到了很多。",
        "timestamp": "2023-07-15T08:30:00Z",
        "replies": [
          {
            "id": "reply_001",
            "author": "张三",
            "content": "谢谢你的反馈！",
            "timestamp": "2023-07-15T09:15:00Z"
          }
        ]
      }
    ]
  }
}
```

### 4. 数组包含对象

数组可以包含对象作为元素，适用于表示对象列表或记录集。

```json
{
  "products": [
    {
      "id": "prod_001",
      "name": "智能手机",
      "price": 5999,
      "currency": "CNY",
      "inStock": true,
      "quantity": 50,
      "specifications": {
        "screen": {
          "size": "6.1英寸",
          "resolution": "2532×1170",
          "type": "OLED"
        },
        "processor": {
          "model": "A15仿生",
          "cores": 6,
          "speed": "3.2GHz"
        },
        "memory": {
          "ram": "6GB",
          "storage": "128GB"
        },
        "camera": {
          "main": {
            "resolution": "12MP",
            "aperture": "f/1.6",
            "features": ["光学防抖", "夜景模式"]
          },
          "front": {
            "resolution": "12MP",
            "aperture": "f/2.2"
          }
        },
        "connectivity": {
          "network": ["5G", "4G", "Wi-Fi", "蓝牙"],
          "ports": ["USB-C", "Lightning"],
          "sensors": ["Face ID", "加速度计", "陀螺仪"]
        }
      },
      "reviews": [
        {
          "id": "review_001",
          "rating": 5,
          "title": "非常满意",
          "content": "手机运行流畅，拍照效果出色。",
          "author": "王五",
          "date": "2023-07-10T14:30:00Z"
        },
        {
          "id": "review_002",
          "rating": 4,
          "title": "不错，但有改进空间",
          "content": "整体很好，但电池续航可以更强。",
          "author": "赵六",
          "date": "2023-07-12T09:15:00Z"
        }
      ]
    },
    {
      "id": "prod_002",
      "name": "笔记本电脑",
      "price": 8999,
      "currency": "CNY",
      "inStock": true,
      "quantity": 20,
      "specifications": {
        "screen": {
          "size": "14英寸",
          "resolution": "2560×1600",
          "type": "IPS"
        },
        "processor": {
          "model": "M2 Pro",
          "cores": 10,
          "speed": "3.5GHz"
        },
        "memory": {
          "ram": "16GB",
          "storage": "512GB SSD"
        },
        "graphics": {
          "model": "集成GPU",
          "memory": "共享系统内存"
        },
        "connectivity": {
          "ports": ["Thunderbolt 4", "USB-C", "HDMI", "耳机插孔"],
          "network": ["Wi-Fi 6", "蓝牙5.0"],
          "sensors": ["指纹识别器", "环境光传感器"]
        }
      },
      "reviews": [
        {
          "id": "review_003",
          "rating": 5,
          "title": "性能强大",
          "content": "M2 Pro处理器性能出色，适合开发工作。",
          "author": "钱七",
          "date": "2023-07-14T16:45:00Z"
        }
      ]
    }
  ]
}
```

### 5. 混合嵌套结构

对象和数组可以混合嵌套，形成非常复杂的数据结构，适用于表示具有复杂关系的系统。

```json
{
  "company": {
    "id": "company_001",
    "name": "科技公司",
    "founded": "2010-05-15",
    "headquarters": {
      "address": {
        "street": "科技园路88号",
        "city": "北京",
        "state": "北京",
        "zipCode": "100000",
        "country": "中国"
      },
      "contact": {
        "phone": "+86-10-12345678",
        "email": "info@techcorp.com",
        "website": "https://www.techcorp.com"
      }
    },
    "departments": [
      {
        "id": "dept_001",
        "name": "研发部",
        "head": {
          "id": "emp_001",
          "name": "张三",
          "title": "研发总监",
          "contact": {
            "email": "zhangsan@techcorp.com",
            "phone": "138-0000-0000"
          },
          "employment": {
            "startDate": "2012-03-01",
            "type": "全职",
            "salary": {
              "base": 50000,
              "bonus": 10000,
              "currency": "CNY",
              "period": "monthly"
            }
          }
        },
        "teams": [
          {
            "id": "team_001",
            "name": "前端团队",
            "lead": {
              "id": "emp_002",
              "name": "李四",
              "title": "前端团队负责人"
            },
            "members": [
              {
                "id": "emp_003",
                "name": "王五",
                "title": "高级前端工程师",
                "skills": [
                  {
                    "name": "JavaScript",
                    "level": "高级",
                    "yearsOfExperience": 5,
                    "certifications": ["JavaScript高级认证"]
                  },
                  {
                    "name": "React",
                    "level": "高级",
                    "yearsOfExperience": 4
                  },
                  {
                    "name": "TypeScript",
                    "level": "中级",
                    "yearsOfExperience": 3
                  }
                ],
                "projects": [
                  {
                    "id": "proj_001",
                    "name": "电商平台前端重构",
                    "role": "技术负责人",
                    "duration": {
                      "start": "2023-01-01",
                      "end": "2023-06-30"
                    },
                    "technologies": [
                      {
                        "name": "React",
                        "version": "18.2.0",
                        "purpose": "前端框架"
                      },
                      {
                        "name": "TypeScript",
                        "version": "4.9.5",
                        "purpose": "类型系统"
                      },
                      {
                        "name": "Redux",
                        "version": "4.2.1",
                        "purpose": "状态管理"
                      }
                    ],
                    "achievements": [
                      "性能提升30%",
                      "减少代码重复率40%",
                      "提高用户体验评分25%"
                    ]
                  }
                ]
              }
            ]
          },
          {
            "id": "team_002",
            "name": "后端团队",
            "lead": {
              "id": "emp_004",
              "name": "赵六",
              "title": "后端团队负责人"
            },
            "members": [
              {
                "id": "emp_005",
                "name": "钱七",
                "title": "高级后端工程师",
                "skills": [
                  {
                    "name": "Java",
                    "level": "高级",
                    "yearsOfExperience": 6
                  },
                  {
                    "name": "Spring Boot",
                    "level": "高级",
                    "yearsOfExperience": 4
                  },
                  {
                    "name": "PostgreSQL",
                    "level": "中级",
                    "yearsOfExperience": 3
                  }
                ]
              }
            ]
          }
        ],
        "budget": {
          "yearly": 5000000,
          "currency": "CNY",
          "allocations": [
            {
              "category": "人员成本",
              "amount": 3000000,
              "percentage": 60
            },
            {
              "category": "设备采购",
              "amount": 1000000,
              "percentage": 20
            },
            {
              "category": "培训与发展",
              "amount": 500000,
              "percentage": 10
            },
            {
              "category": "其他",
              "amount": 500000,
              "percentage": 10
            }
          ]
        }
      }
    ]
  }
}
```

## 图形数据结构

JSON也可以用来表示图形数据结构，如社交网络、依赖关系等。

### 树形结构

树形结构是一种常见的嵌套结构，用于表示层次关系。

```json
{
  "tree": {
    "id": "root",
    "name": "根节点",
    "type": "folder",
    "children": [
      {
        "id": "node_001",
        "name": "文档",
        "type": "folder",
        "children": [
          {
            "id": "node_001_001",
            "name": "工作报告.docx",
            "type": "file",
            "size": 2048,
            "modified": "2023-07-15T08:30:00Z"
          },
          {
            "id": "node_001_002",
            "name": "会议记录.docx",
            "type": "file",
            "size": 1536,
            "modified": "2023-07-14T14:20:00Z"
          }
        ]
      },
      {
        "id": "node_002",
        "name": "图片",
        "type": "folder",
        "children": [
          {
            "id": "node_002_001",
            "name": "产品截图.png",
            "type": "file",
            "size": 1024,
            "modified": "2023-07-13T10:15:00Z"
          }
        ]
      },
      {
        "id": "node_003",
        "name": "代码",
        "type": "folder",
        "children": [
          {
            "id": "node_003_001",
            "name": "项目A",
            "type": "folder",
            "children": [
              {
                "id": "node_003_001_001",
                "name": "index.js",
                "type": "file",
                "size": 512,
                "modified": "2023-07-12T16:45:00Z"
              },
              {
                "id": "node_003_001_002",
                "name": "style.css",
                "type": "file",
                "size": 256,
                "modified": "2023-07-12T16:45:00Z"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### 网络结构

网络结构用于表示多对多关系，如社交网络、引用网络等。

```json
{
  "socialNetwork": {
    "nodes": [
      {
        "id": "user_001",
        "name": "张三",
        "profile": {
          "age": 28,
          "city": "北京",
          "interests": ["编程", "阅读", "旅行"]
        }
      },
      {
        "id": "user_002",
        "name": "李四",
        "profile": {
          "age": 32,
          "city": "上海",
          "interests": ["设计", "摄影", "音乐"]
        }
      },
      {
        "id": "user_003",
        "name": "王五",
        "profile": {
          "age": 25,
          "city": "广州",
          "interests": ["编程", "游戏", "电影"]
        }
      }
    ],
    "edges": [
      {
        "source": "user_001",
        "target": "user_002",
        "type": "friend",
        "since": "2020-05-10",
        "strength": 0.8
      },
      {
        "source": "user_001",
        "target": "user_003",
        "type": "friend",
        "since": "2021-03-15",
        "strength": 0.9
      },
      {
        "source": "user_002",
        "target": "user_003",
        "type": "friend",
        "since": "2019-11-20",
        "strength": 0.6
      }
    ]
  }
}
```

## 嵌套结构的最佳实践

### 1. 层次深度控制

虽然JSON支持任意深度的嵌套，但实际应用中应控制嵌套深度，通常不超过3-4层。

```json
// 推荐的深度控制
{
  "user": {
    "id": "user_123",
    "profile": {
      "personal": {
        "firstName": "张",
        "lastName": "三"
      },
      "contact": {
        "email": "zhangsan@example.com"
      }
    }
  }
}

// 避免过深的嵌套
{
  "user": {
    "level1": {
      "level2": {
        "level3": {
          "level4": {
            "level5": {
              "level6": {
                "level7": "过深的嵌套"
              }
            }
          }
        }
      }
    }
  }
}
```

### 2. 一致性原则

在整个JSON文档中保持相似数据结构的一致性。

```json
// 一致的结构
{
  "users": [
    {
      "id": "user_001",
      "name": "张三",
      "contact": {
        "email": "zhangsan@example.com",
        "phone": "138-0000-0000"
      }
    },
    {
      "id": "user_002",
      "name": "李四",
      "contact": {
        "email": "lisi@example.com",
        "phone": "139-0000-0000"
      }
    }
  ]
}

// 不一致的结构
{
  "users": [
    {
      "id": "user_001",
      "name": "张三",
      "contact": {
        "email": "zhangsan@example.com",
        "phone": "138-0000-0000"
      }
    },
    {
      "id": "user_002",
      "name": "李四",
      "email": "lisi@example.com",  // 结构不一致
      "mobile": "139-0000-0000"      // 键名不一致
    }
  ]
}
```

### 3. 语义化命名

使用有意义的键名，提高可读性和可维护性。

```json
// 语义化命名
{
  "order": {
    "orderId": "order_001",
    "customer": {
      "customerId": "customer_001",
      "fullName": "张三",
      "emailAddress": "zhangsan@example.com"
    },
    "items": [
      {
        "productId": "prod_001",
        "productName": "智能手机",
        "unitPrice": 5999,
        "quantity": 1,
        "totalPrice": 5999
      }
    ],
    "orderDate": "2023-07-15T08:30:00Z",
    "totalAmount": 5999
  }
}

// 非语义化命名
{
  "o": {
    "oid": "order_001",
    "c": {
      "cid": "customer_001",
      "fn": "张三",
      "ea": "zhangsan@example.com"
    },
    "i": [
      {
        "pid": "prod_001",
        "pn": "智能手机",
        "up": 5999,
        "q": 1,
        "tp": 5999
      }
    ],
    "od": "2023-07-15T08:30:00Z",
    "ta": 5999
  }
}
```

## 实验环节：嵌套结构设计与应用

### 实验1：设计大学课程体系JSON结构

设计一个表示大学课程体系的JSON结构，包含：

1. 大学基本信息
2. 学院列表
3. 每个学院的专业列表
4. 每个专业的课程列表
5. 每门课程的详细信息（包括先修课程）
6. 学生信息及选课情况

**要求**：
- 使用适当的嵌套结构
- 保持结构的一致性
- 考虑数据查询的便利性
- 包含必要的元数据

### 实验2：嵌套结构数据提取与处理

编写程序处理以下复杂JSON数据：

1. 提取所有学生的基本信息
2. 计算每个专业的平均GPA
3. 找出没有先修要求的课程
4. 构建课程依赖关系图
5. 查找选修特定课程的所有学生

**示例数据**：
```json
{
  "university": {
    "name": "示例大学",
    "departments": [
      {
        "name": "计算机科学学院",
        "majors": [
          {
            "name": "计算机科学",
            "courses": [
              {
                "code": "CS101",
                "name": "计算机科学导论",
                "credits": 3,
                "prerequisites": []
              },
              {
                "code": "CS201",
                "name": "数据结构",
                "credits": 4,
                "prerequisites": ["CS101"]
              }
            ]
          }
        ]
      }
    ],
    "students": [
      {
        "id": "student_001",
        "name": "张三",
        "major": "计算机科学",
        "enrollments": [
          {
            "courseCode": "CS101",
            "semester": "2023-秋季",
            "grade": "A"
          }
        ]
      }
    ]
  }
}
```

### 实验3：嵌套结构扁平化与重构

实现将深层嵌套的JSON结构扁平化的函数，并能够将扁平化的数据重构为原始结构。

**原始结构示例**：
```json
{
  "user": {
    "name": "张三",
    "address": {
      "street": "人民路123号",
      "city": "北京"
    }
  }
}
```

**扁平化结构示例**：
```json
{
  "user.name": "张三",
  "user.address.street": "人民路123号",
  "user.address.city": "北京"
}
```

## 小结

本节我们深入探讨了JSON中的嵌套结构与复杂数据表示：

1. **嵌套结构的基本模式**：
   - 对象嵌套对象：表示实体的组成部分
   - 数组嵌套数组：表示多维数据
   - 对象包含数组：表示实体的列表属性
   - 数组包含对象：表示对象列表
   - 混合嵌套结构：表示复杂系统

2. **图形数据结构**：
   - 树形结构：表示层次关系
   - 网络结构：表示多对多关系

3. **嵌套结构的最佳实践**：
   - 层次深度控制：通常不超过3-4层
   - 一致性原则：保持相似数据结构的一致性
   - 语义化命名：使用有意义的键名

通过合理使用嵌套结构，可以创建出既灵活又易于理解的JSON数据模型，准确反映现实世界中的各种复杂关系。在下一节中，我们将探讨JSON与各种编程语言的集成，了解如何在不同的编程环境中使用JSON。

## 代码示例

请查看`code/chapter3/nested-structures`目录，其中包含了：

1. `object_nesting.json` - 对象嵌套示例
2. `array_nesting.json` - 数组嵌套示例
3. `mixed_nesting.json` - 混合嵌套结构示例
4. `tree_structure.json` - 树形结构示例
5. `network_structure.json` - 网络结构示例
6. `university_system.json` - 大学课程系统完整示例
7. `flatten_structure.js` - 扁平化嵌套结构的示例代码
8. `process_nested_data.js` - 处理嵌套数据的示例代码