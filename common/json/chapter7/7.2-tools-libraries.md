# 7.2 JSON工具与库

## JSON工具与库概述

随着JSON的广泛应用，出现了大量用于处理、验证、转换和操作JSON的工具和库。本节将介绍各种编程语言中的主要JSON工具和库，以及它们的使用场景。

## JavaScript中的JSON工具与库

### 1. 基础JSON处理库

#### `fast-json-stringify`

高性能的JSON字符串化库：

```javascript
const fastJson = require('fast-json-stringify');

// 定义JSON结构模板
const stringify = fastJson({
  name: '',
  age: 0,
  active: true,
  address: {
    street: '',
    city: ''
  },
  hobbies: ['']
});

// 使用模板快速序列化
const user = {
  name: "张三",
  age: 30,
  active: true,
  address: {
    street: "人民路123号",
    city: "北京"
  },
  hobbies: ["阅读", "运动"]
};

// 快速序列化
const jsonString = stringify(user);
console.log(jsonString);
```

#### `json5`

支持JSON5语法的解析和字符串化：

```javascript
const JSON5 = require('json5');

// 解析JSON5文本
const json5Text = `{
  // 用户配置
  name: '张三',  // 姓名
  age: 30,       // 年龄
  
  // 地址信息
  address: {
    street: '人民路123号',
    city: '北京'
  },
  
  // 兴趣爱好
  hobbies: [
    '阅读',
    '运动',  // 尾随逗号
  ],
}`;

const config = JSON5.parse(json5Text);
console.log(config);

// 生成JSON5
const userConfig = {
  name: "李四",
  age: 28,
  active: true
};

const json5String = JSON5.stringify(userConfig, { space: 2 });
console.log(json5String);
```

#### `jsonpath-plus`

JSONPath查询和操作库：

```javascript
const {JSONPath} = require('jsonpath-plus');

// 示例数据
const data = {
  store: {
    book: [
      {
        category: "reference",
        author: "Nigel Rees",
        title: "Sayings of the Century",
        price: 8.95
      },
      {
        category: "fiction",
        author: "Evelyn Waugh",
        title: "Sword of Honour",
        price: 12.99
      }
    ],
    bicycle: {
      color: "red",
      price: 19.95
    }
  }
};

// 查询所有书籍作者
const authors = JSONPath({path: '$.store.book[*].author', json: data});
console.log("所有书籍作者:", authors);

// 查询价格大于10的书籍
const expensiveBooks = JSONPath({path: '$.store.book[?(@.price > 10)]', json: data});
console.log("价格大于10的书籍:", expensiveBooks);

// 查询所有价格
const prices = JSONPath({path: '$..price', json: data});
console.log("所有价格:", prices);
```

### 2. JSON验证与Schema库

#### `ajv` (Another JSON Schema Validator)

高性能的JSON Schema验证器：

```javascript
const Ajv = require("ajv");
const addFormats = require("ajv-formats");

// 创建AJV实例
const ajv = new Ajv({ allErrors: true });
addFormats(ajv);

// 定义JSON Schema
const userSchema = {
  type: "object",
  properties: {
    id: {
      type: "string",
      pattern: "^user_[0-9]+$"
    },
    name: {
      type: "string",
      minLength: 1,
      maxLength: 50
    },
    email: {
      type: "string",
      format: "email"
    },
    age: {
      type: "integer",
      minimum: 0,
      maximum: 150
    },
    isActive: {
      type: "boolean"
    },
    roles: {
      type: "array",
      items: {
        type: "string"
      },
      uniqueItems: true
    }
  },
  required: ["id", "name", "email"],
  additionalProperties: false
};

// 编译Schema
const validate = ajv.compile(userSchema);

// 验证数据
function validateUser(userData) {
  const valid = validate(userData);
  
  if (valid) {
    console.log("数据验证通过");
    return true;
  } else {
    console.log("数据验证失败:");
    validate.errors.forEach(error => {
      console.log(`- ${error.instancePath || 'root'}: ${error.message}`);
    });
    return false;
  }
}

// 测试数据
const validUser = {
  id: "user_123",
  name: "张三",
  email: "zhangsan@example.com",
  age: 30,
  isActive: true,
  roles: ["user", "editor"]
};

const invalidUser = {
  id: "123",  // 不匹配模式
  name: "",    // 太短
  email: "invalid-email",  // 无效邮箱
  age: -5,    // 小于最小值
  roles: ["user", "user"]  // 重复项
};

validateUser(validUser);    // 验证通过
validateUser(invalidUser);  // 验证失败
```

### 3. JSON转换与处理库

#### `lodash`

提供丰富的JSON处理函数：

```javascript
const _ = require('lodash');

// 示例数据
const users = [
  {
    id: "user_001",
    name: "张三",
    age: 30,
    department: "研发部",
    isActive: true
  },
  {
    id: "user_002",
    name: "李四",
    age: 28,
    department: "设计部",
    isActive: false
  },
  {
    id: "user_003",
    name: "王五",
    age: 32,
    department: "研发部",
    isActive: true
  }
];

// 过滤：获取激活用户
const activeUsers = _.filter(users, 'isActive');
console.log("激活用户:", activeUsers);

// 映射：获取用户姓名
const userNames = _.map(users, 'name');
console.log("用户姓名:", userNames);

// 分组：按部门分组
const usersByDepartment = _.groupBy(users, 'department');
console.log("按部门分组的用户:", usersByDepartment);

// 排序：按年龄排序
const sortedByAge = _.orderBy(users, ['age'], ['asc']);
console.log("按年龄排序的用户:", sortedByAge);

// 查找：查找特定用户
const user001 = _.find(users, { id: "user_001" });
console.log("查找用户:", user001);

// 深拷贝
const clonedUsers = _.cloneDeep(users);
clonedUsers[0].name = "修改";
console.log("原始数据:", users[0].name);  // 不变
console.log("克隆数据:", clonedUsers[0].name);  // 修改

// 合并对象
const mergedUser = _.merge(
  { id: "user_001", name: "张三" },
  { age: 30, department: "研发部" },
  { isActive: true }
);
console.log("合并的用户:", mergedUser);
```

#### `jmespath`

用于JSON数据的查询和转换：

```javascript
const jmespath = require('jmespath');

// 示例数据
const data = {
  people: [
    {
      name: "张三",
      age: 30,
      city: "北京",
      skills: ["JavaScript", "Python", "React"],
      projects: [
        {
          name: "项目A",
          role: "前端开发",
          duration: 6
        },
        {
          name: "项目B",
          role: "技术负责人",
          duration: 12
        }
      ]
    },
    {
      name: "李四",
      age: 28,
      city: "上海",
      skills: ["Python", "Django", "PostgreSQL"],
      projects: [
        {
          name: "项目C",
          role: "后端开发",
          duration: 8
        }
      ]
    }
  ]
};

// 提取所有人名和城市
const namesAndCities = jmespath.search(data, 'people[*].[name, city]');
console.log("姓名和城市:", namesAndCities);

// 提取掌握JavaScript技能的人
const jsDevs = jmespath.search(data, 'people[?contains(skills, `JavaScript`)]');
console.log("JavaScript开发者:", jsDevs);

// 计算每个人的项目总时长
const devsWithProjectDuration = jmespath.search(
  data, 
  'people[*].{name: name, totalProjectDuration: sum(projects[*].duration)}'
);
console.log("开发者和项目总时长:", devsWithProjectDuration);

// 获取所有技能并去重
const allSkills = jmespath.search(data, 'people[*].skills[] | unique(@) | sort(@)');
console.log("所有技能:", allSkills);

// 按城市分组
const peopleByCity = jmespath.search(data, 'group_by(people, &city)');
console.log("按城市分组:", peopleByCity);
```

## Python中的JSON工具与库

### 1. 基础JSON处理库

#### `jsonschema`

JSON Schema验证库：

```python
import json
from jsonschema import validate, ValidationError, Draft7Validator
from jsonschema.exceptions import SchemaError

# 定义JSON Schema
user_schema = {
    "type": "object",
    "properties": {
        "id": {"type": "string", "pattern": "^user_[0-9]+$"},
        "name": {"type": "string", "minLength": 1, "maxLength": 50},
        "email": {"type": "string", "format": "email"},
        "age": {"type": "integer", "minimum": 0, "maximum": 150},
        "isActive": {"type": "boolean"},
        "roles": {
            "type": "array",
            "items": {"type": "string"},
            "uniqueItems": True
        }
    },
    "required": ["id", "name", "email"],
    "additionalProperties": False
}

# 验证函数
def validate_user(user_data):
    try:
        validate(instance=user_data, schema=user_schema)
        print("数据验证通过")
        return True
    except ValidationError as e:
        print(f"数据验证失败: {e.message}")
        print(f"错误路径: {' -> '.join(map(str, e.path)) if e.path else 'root'}")
        return False
    except SchemaError as e:
        print(f"Schema错误: {e.message}")
        return False

# 获取所有验证错误的函数
def get_validation_errors(user_data):
    validator = Draft7Validator(user_schema)
    errors = sorted(validator.iter_errors(user_data), key=lambda e: e.path)
    
    if not errors:
        return None
    
    error_list = []
    for error in errors:
        path = " -> ".join(map(str, error.path)) if error.path else "root"
        error_list.append({
            "path": path,
            "message": error.message,
            "failed_value": error.instance
        })
    
    return error_list

# 测试数据
valid_user = {
    "id": "user_123",
    "name": "张三",
    "email": "zhangsan@example.com",
    "age": 30,
    "isActive": True,
    "roles": ["user", "editor"]
}

invalid_user = {
    "id": "123",  # 不匹配模式
    "name": "",   # 太短
    "email": "invalid-email",  # 无效邮箱格式
    "age": -5,    # 小于最小值
    "roles": ["user", "user"]  # 重复项
}

# 测试验证
validate_user(valid_user)  # 验证通过
validate_user(invalid_user)  # 验证失败

# 获取所有错误
errors = get_validation_errors(invalid_user)
if errors:
    print("\n所有验证错误:")
    for error in errors:
        print(f"- {error['path']}: {error['message']} (值: {error['failed_value']})")
```

#### `json5`

支持JSON5语法的解析：

```python
import json5

# JSON5文本
json5_text = """{
  // 用户配置
  name: '张三',  # 姓名
  age: 30,       # 年龄
  
  # 地址信息
  address: {
    street: '人民路123号',
    city: '北京'
  },
  
  # 兴趣爱好
  hobbies: [
    '阅读',
    '运动',  # 尾随逗号
  ],
}"""

# 解析JSON5
config = json5.loads(json5_text)
print("JSON5配置:", config)

# 生成JSON5
user_config = {
    "name": "李四",
    "age": 28,
    "active": True
}

json5_string = json5.dumps(user_config, indent=2)
print("JSON5字符串:", json5_string)
```

### 2. JSON转换与处理库

#### `pandas`

使用pandas处理JSON数据：

```python
import pandas as pd
import json

# 示例JSON数据
json_data = """
{
  "users": [
    {
      "id": "user_001",
      "name": "张三",
      "age": 30,
      "department": "研发部",
      "salary": 15000,
      "join_date": "2020-01-15"
    },
    {
      "id": "user_002",
      "name": "李四",
      "age": 28,
      "department": "设计部",
      "salary": 12000,
      "join_date": "2021-03-22"
    },
    {
      "id": "user_003",
      "name": "王五",
      "age": 32,
      "department": "研发部",
      "salary": 18000,
      "join_date": "2019-07-10"
    }
  ]
}
"""

# 将JSON加载到DataFrame
data = json.loads(json_data)
df = pd.DataFrame(data['users'])

# 查看基本统计信息
print("基本信息:")
print(df.info())
print("\n统计描述:")
print(df.describe())

# 按部门分组计算平均薪资
dept_salary = df.groupby('department')['salary'].mean()
print("\n按部门的平均薪资:")
print(dept_salary)

# 按年龄分组
age_bins = [20, 25, 30, 35, 40]
age_labels = ['20-25', '26-30', '31-35', '36-40']
df['age_group'] = pd.cut(df['age'], bins=age_bins, labels=age_labels)
age_distribution = df['age_group'].value_counts().sort_index()
print("\n年龄分布:")
print(age_distribution)

# 转换回JSON
result = {
  "stats": {
    "total_users": len(df),
    "avg_salary": df['salary'].mean(),
    "departments": df['department'].unique().tolist(),
    "salary_by_department": dept_salary.to_dict(),
    "age_distribution": age_distribution.to_dict()
  }
}

print("\n结果JSON:")
print(json.dumps(result, indent=2, ensure_ascii=False))
```

#### `jsonpath-ng`

JSONPath查询库：

```python
from jsonpath_ng import jsonpath, parse

# 示例数据
data = {
    "store": {
        "book": [
            {
                "category": "reference",
                "author": "Nigel Rees",
                "title": "Sayings of the Century",
                "price": 8.95
            },
            {
                "category": "fiction",
                "author": "Evelyn Waugh",
                "title": "Sword of Honour",
                "price": 12.99
            },
            {
                "category": "fiction",
                "author": "Herman Melville",
                "title": "Moby Dick",
                "isbn": "0-553-21311-3",
                "price": 8.99
            }
        ],
        "bicycle": {
            "color": "red",
            "price": 19.95
        }
    }
}

# 查询所有书籍作者
authors_path = parse('$.store.book[*].author')
authors = [match.value for match in authors_path.find(data)]
print(f"所有书籍作者: {authors}")

# 查询价格大于10的书籍
expensive_books_path = parse('$.store.book[?(@.price > 10)]')
expensive_books = [match.value for match in expensive_books_path.find(data)]
print(f"价格大于10的书籍: {expensive_books}")

# 查询有isbn属性的书籍
books_with_isbn_path = parse('$.store.book[?(@.isbn)]')
books_with_isbn = [match.value for match in books_with_isbn_path.find(data)]
print(f"有ISBN的书籍: {books_with_isbn}")

# 查询所有价格
prices_path = parse('$..price')
prices = [match.value for match in prices_path.find(data)]
print(f"所有价格: {prices}")

# 创建查询函数
def query_json_path(data, path_expression):
    jsonpath_expr = parse(path_expression)
    return [match.value for match in jsonpath_expr.find(data)]

# 使用示例
all_titles = query_json_path(data, '$.store.book[*].title')
print(f"所有书名: {all_titles}")

# 获取匹配的路径和值
def query_with_paths(data, path_expression):
    jsonpath_expr = parse(path_expression)
    return [(str(match.full_path), match.value) for match in jsonpath_expr.find(data)]

# 查询所有价格及其路径
prices_with_paths = query_with_paths(data, '$..price')
print("价格及其路径:")
for path, price in prices_with_paths:
    print(f"  {path}: {price}")
```

## 命令行JSON工具

### 1. `jq`

强大的命令行JSON处理器：

```bash
# 示例JSON文件
cat > users.json << EOF
{
  "users": [
    {
      "id": "user_001",
      "name": "张三",
      "age": 30,
      "department": "研发部",
      "isActive": true
    },
    {
      "id": "user_002",
      "name": "李四",
      "age": 28,
      "department": "设计部",
      "isActive": false
    },
    {
      "id": "user_003",
      "name": "王五",
      "age": 32,
      "department": "研发部",
      "isActive": true
    }
  ]
}
EOF

# 美化JSON
jq '.' users.json

# 提取特定字段
jq '.users[] | {id, name, age}' users.json

# 过滤数据：获取激活用户
jq '.users[] | select(.isActive == true)' users.json

# 按条件过滤并格式化
jq '.users[] | select(.age > 30) | {name, age}' users.json

# 按部门分组
jq 'group_by(.users[]; .department)' users.json

# 计算平均年龄
jq '.users | map(.age) | add / length' users.json

# 排序
jq '.users | sort_by(.age)' users.json

# 创建新结构
jq '{total_users: (.users | length), active_users: [.users[] | select(.isActive == true)] | length}' users.json
```

### 2. `gron`

将JSON扁平化为易于grep的格式：

```bash
# 将JSON扁平化
gron users.json

# 过滤特定字段
gron users.json | grep 'age'
gron users.json | grep 'isActive'

# 重建JSON
gron users.json | grep 'age' | ungron
```

### 3. `fx`

交互式JSON查看器：

```bash
# 交互式查看JSON
fx users.json

# 使用管道
cat users.json | fx

# 查询特定字段
cat users.json | fx .users[0]
```

## JSON开发工具

### 1. VS Code扩展

#### JSON Tools

- **JSON Viewer**：可视化JSON结构
- **JSON Validator**：实时验证JSON语法
- **JSON Schema Validator**：验证JSON Schema
- **Path Intellisense**：JSON路径自动完成

#### 示例配置

```json
{
  "json.schemas": [
    {
      "fileMatch": ["*.json"],
      "schema": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "项目名称"
          },
          "version": {
            "type": "string",
            "description": "项目版本"
          },
          "dependencies": {
            "type": "array",
            "description": "项目依赖"
          }
        },
        "required": ["name", "version"]
      }
    }
  ]
}
```

### 2. 在线JSON工具

#### JSON验证与格式化

- **JSONLint**：https://jsonlint.com/
- **JSON Formatter & Validator**：https://jsonformatter.curiousconcept.com/
- **JSON Schema Validator**：https://www.jsonschemavalidator.net/

#### JSON转换

- **JSON to CSV**：https://json-csv.com/
- **JSON to YAML**：https://www.json2yaml.com/
- **JSON to XML**：https://www.utilities-online.info/xmltojson/

#### JSONPath测试

- **JSONPath Tester**：https://jsonpath.com/
- **JSONPath Evaluator**：https://jsonpath.herokuapp.com/

## 实验环节：JSON工具与库实践

### 实验1：构建多格式数据处理系统

使用多种JSON工具构建一个数据处理系统，包含：

1. JSON数据的读取和解析
2. 数据验证和清洗
3. 数据转换和分析
4. 结果输出和可视化

### 实验2：JSON工具性能对比

对比不同JSON处理工具的性能：

1. JSON解析性能对比
2. JSON查询性能对比
3. 内存使用对比
4. 大数据处理能力对比

### 实验3：自定义JSON工具开发

开发自定义JSON工具，实现：

1. JSON数据验证器
2. JSON格式转换器
3. JSON数据分析器
4. 命令行界面

## 小结

本节我们深入探讨了JSON工具与库：

1. **JavaScript中的JSON工具与库**：
   - 基础JSON处理库（fast-json-stringify、json5、jsonpath-plus等）
   - JSON验证与Schema库（ajv等）
   - JSON转换与处理库（lodash、jmespath等）

2. **Python中的JSON工具与库**：
   - 基础JSON处理库（jsonschema、json5等）
   - JSON转换与处理库（pandas、jsonpath-ng等）

3. **命令行JSON工具**：
   - jq：强大的命令行JSON处理器
   - gron：JSON扁平化工具
   - fx：交互式JSON查看器

4. **JSON开发工具**：
   - VS Code扩展
   - 在线JSON工具

通过使用这些工具和库，您可以更高效地处理JSON数据，提高开发效率和代码质量。

## 代码示例

请查看`code/chapter7/tools-libraries`目录，其中包含了：

1. `fast_json_stringify.js` - fast-json-stringify使用示例
2. `json5_example.js` - JSON5处理示例
3. `jsonpath_example.js` - JSONPath查询示例
4. `ajv_validation.js` - AJV验证示例
5. `lodash_processing.js` - Lodash数据处理示例
6. `jmespath_transform.js` - JMESPath转换示例
7. `jsonschema_validation.py` - Python JSONSchema验证
8. `pandas_analysis.py` - Pandas JSON数据分析
9. `jsonpath_ng.py` - Python JSONPath查询
10. `jq_examples.sh` - jq命令行示例
11. `gron_examples.sh` - gron使用示例
12. `multi_format_processor.js` - 多格式数据处理系统
13. `performance_comparison.js` - 工具性能对比
14. `custom_json_tool.js` - 自定义JSON工具