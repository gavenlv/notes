# 5.2 JSON查询与路径

## JSON查询概述

随着JSON在数据交换和存储中的广泛应用，高效地从JSON文档中提取和操作数据变得至关重要。JSON查询提供了一种声明式的方式来定位、筛选和转换JSON数据。

## JSON路径表达式基础

JSONPath是一种类似XPath的查询语言，用于从JSON文档中提取数据。它使用路径表达式来导航JSON结构。

### JSONPath语法

| 语法 | 描述 | 示例 |
|------|------|------|
| `$` | 根元素 | `$` |
| `.` | 子元素 | `$.user.name` |
| `[]` | 数组索引/通配符 | `$.users[0]` |
| `*` | 通配符 | `$.users.*` |
| `..` | 递归下降 | `$..name` |
| `()` | 脚本表达式 | `$..book[(@.length-1)]` |
| `?()` | 过滤表达式 | `$..book[?(@.price<10)]` |

### 基本路径表达式

假设我们有以下JSON数据：

```json
{
  "store": {
    "book": [
      {
        "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      {
        "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      },
      {
        "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      },
      {
        "category": "fiction",
        "author": "J. R. R. Tolkien",
        "title": "The Lord of the Rings",
        "isbn": "0-395-19395-8",
        "price": 22.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  },
  "expensive": 10
}
```

#### 访问对象属性

```json
{
  "expression": "$.store.book",
  "description": "获取store对象下的book属性",
  "result": [
    {
      "category": "reference",
      "author": "Nigel Rees",
      "title": "Sayings of the Century",
      "price": 8.95
    },
    {
      "category": "fiction",
      "author": "Evelyn Waugh",
      "title": "Sword of Honour",
      "price": 12.99
    },
    {
      "category": "fiction",
      "author": "Herman Melville",
      "title": "Moby Dick",
      "isbn": "0-553-21311-3",
      "price": 8.99
    },
    {
      "category": "fiction",
      "author": "J. R. R. Tolkien",
      "title": "The Lord of the Rings",
      "isbn": "0-395-19395-8",
      "price": 22.99
    }
  ]
}
```

#### 访问数组元素

```json
{
  "expression": "$.store.book[0]",
  "description": "获取book数组的第一个元素",
  "result": {
    "category": "reference",
    "author": "Nigel Rees",
    "title": "Sayings of the Century",
    "price": 8.95
  }
}
```

```json
{
  "expression": "$.store.book[-1]",
  "description": "获取book数组的最后一个元素",
  "result": {
    "category": "fiction",
    "author": "J. R. R. Tolkien",
    "title": "The Lord of the Rings",
    "isbn": "0-395-19395-8",
    "price": 22.99
  }
}
```

#### 使用通配符

```json
{
  "expression": "$.store.book[*].author",
  "description": "获取所有书籍的作者",
  "result": [
    "Nigel Rees",
    "Evelyn Waugh",
    "Herman Melville",
    "J. R. R. Tolkien"
  ]
}
```

```json
{
  "expression": "$.store.*",
  "description": "获取store对象下的所有属性值",
  "result": [
    [
      {
        "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      {
        "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      },
      {
        "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      },
      {
        "category": "fiction",
        "author": "J. R. R. Tolkien",
        "title": "The Lord of the Rings",
        "isbn": "0-395-19395-8",
        "price": 22.99
      }
    ],
    {
      "color": "red",
      "price": 19.95
    }
  ]
}
```

#### 递归下降

```json
{
  "expression": "$..author",
  "description": "获取文档中所有的author属性",
  "result": [
    "Nigel Rees",
    "Evelyn Waugh",
    "Herman Melville",
    "J. R. R. Tolkien"
  ]
}
```

#### 过滤表达式

```json
{
  "expression": "$.store.book[?(@.price > 10)]",
  "description": "获取价格大于10的书籍",
  "result": [
    {
      "category": "fiction",
      "author": "Evelyn Waugh",
      "title": "Sword of Honour",
      "price": 12.99
    },
    {
      "category": "fiction",
      "author": "J. R. R. Tolkien",
      "title": "The Lord of the Rings",
      "isbn": "0-395-19395-8",
      "price": 22.99
    }
  ]
}
```

```json
{
  "expression": "$.store.book[?(@.isbn)]",
  "description": "获取有isbn属性的书籍",
  "result": [
    {
      "category": "fiction",
      "author": "Herman Melville",
      "title": "Moby Dick",
      "isbn": "0-553-21311-3",
      "price": 8.99
    },
    {
      "category": "fiction",
      "author": "J. R. R. Tolkien",
      "title": "The Lord of the Rings",
      "isbn": "0-395-19395-8",
      "price": 22.99
    }
  ]
}
```

## 高级JSON查询技术

### 复合过滤器

```json
{
  "expression": "$.store.book[?(@.price < 10 && @.category == 'fiction')]",
  "description": "获取价格小于10且类别为fiction的书籍",
  "result": [
    {
      "category": "fiction",
      "author": "Herman Melville",
      "title": "Moby Dick",
      "isbn": "0-553-21311-3",
      "price": 8.99
    }
  ]
}
```

### 脚本表达式

```json
{
  "expression": "$.store.book[(@.length-1)]",
  "description": "获取书籍数组的最后一个元素",
  "result": {
    "category": "fiction",
    "author": "J. R. R. Tolkien",
    "title": "The Lord of the Rings",
    "isbn": "0-395-19395-8",
    "price": 22.99
  }
}
```

### 范围选择

```json
{
  "expression": "$.store.book[0:2]",
  "description": "获取书籍数组的前两个元素",
  "result": [
    {
      "category": "reference",
      "author": "Nigel Rees",
      "title": "Sayings of the Century",
      "price": 8.95
    },
    {
      "category": "fiction",
      "author": "Evelyn Waugh",
      "title": "Sword of Honour",
      "price": 12.99
    }
  ]
}
```

### 条件提取

```json
{
  "expression": "$.store.book[(@.price > $.expensive)]",
  "description": "获取价格高于expensive值(10)的书籍",
  "result": [
    {
      "category": "fiction",
      "author": "Evelyn Waugh",
      "title": "Sword of Honour",
      "price": 12.99
    },
    {
      "category": "fiction",
      "author": "J. R. R. Tolkien",
      "title": "The Lord of the Rings",
      "isbn": "0-395-19395-8",
      "price": 22.99
    }
  ]
}
```

## JSON查询库与工具

### JavaScript中的JSONPath查询

使用`jsonpath-plus`库进行JSONPath查询：

```javascript
const {JSONPath} = require('jsonpath-plus');

// 示例数据
const data = {
  "store": {
    "book": [
      {
        "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      {
        "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      },
      {
        "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  },
  "expensive": 10
};

// 查询所有书籍作者
const authors = JSONPath({path: '$.store.book[*].author', json: data});
console.log(authors); 
// 输出: ["Nigel Rees", "Evelyn Waugh", "Herman Melville"]

// 查询价格大于10的书籍
const expensiveBooks = JSONPath({path: '$.store.book[?(@.price > 10)]', json: data});
console.log(expensiveBooks);

// 查询有isbn属性的书籍
const booksWithIsbn = JSONPath({path: '$.store.book[?(@.isbn)]', json: data});
console.log(booksWithIsbn);

// 查询所有价格
const prices = JSONPath({path: '$..price', json: data});
console.log(prices);
// 输出: [8.95, 12.99, 8.99, 19.95]

// 创建查询函数
function queryJsonPath(data, path) {
  return JSONPath({path, json});
}

// 使用示例
const allTitles = queryJsonPath(data, '$.store.book[*].title');
console.log(allTitles);
// 输出: ["Sayings of the Century", "Sword of Honour", "Moby Dick"]
```

### Python中的JSONPath查询

使用`jsonpath-ng`库进行JSONPath查询：

```python
from jsonpath_ng import jsonpath, parse

# 示例数据
data = {
    "store": {
        "book": [
            {
                "category": "reference",
                "author": "Nigel Rees",
                "title": "Sayings of the Century",
                "price": 8.95
            },
            {
                "category": "fiction",
                "author": "Evelyn Waugh",
                "title": "Sword of Honour",
                "price": 12.99
            },
            {
                "category": "fiction",
                "author": "Herman Melville",
                "title": "Moby Dick",
                "isbn": "0-553-21311-3",
                "price": 8.99
            }
        ],
        "bicycle": {
            "color": "red",
            "price": 19.95
        }
    },
    "expensive": 10
}

# 查询所有书籍作者
authors_path = parse('$.store.book[*].author')
authors = [match.value for match in authors_path.find(data)]
print(f"所有作者: {authors}")

# 查询价格大于10的书籍
expensive_books_path = parse('$.store.book[?(@.price > 10)]')
expensive_books = [match.value for match in expensive_books_path.find(data)]
print(f"价格大于10的书籍: {expensive_books}")

# 查询有isbn属性的书籍
books_with_isbn_path = parse('$.store.book[?(@.isbn)]')
books_with_isbn = [match.value for match in books_with_isbn_path.find(data)]
print(f"有ISBN的书籍: {books_with_isbn}")

# 查询所有价格
prices_path = parse('$..price')
prices = [match.value for match in prices_path.find(data)]
print(f"所有价格: {prices}")

# 创建查询函数
def query_json_path(data, path_expression):
    jsonpath_expr = parse(path_expression)
    return [match.value for match in jsonpath_expr.find(data)]

# 使用示例
all_titles = query_json_path(data, '$.store.book[*].title')
print(f"所有书名: {all_titles}")

# 获取匹配的路径和值
def query_with_paths(data, path_expression):
    jsonpath_expr = parse(path_expression)
    return [(str(match.full_path), match.value) for match in jsonpath_expr.find(data)]

# 查询所有价格及其路径
prices_with_paths = query_with_paths(data, '$..price')
print("价格及其路径:")
for path, price in prices_with_paths:
    print(f"  {path}: {price}")
```

### 高级查询场景

```javascript
// 复杂查询示例
const complexData = {
  "company": {
    "departments": [
      {
        "name": "研发部",
        "employees": [
          {
            "id": "emp_001",
            "name": "张三",
            "skills": ["JavaScript", "Python", "React"],
            "projects": [
              {
                "name": "项目A",
                "role": "前端开发",
                "technologies": ["React", "Redux"],
                "duration": 6
              },
              {
                "name": "项目B",
                "role": "技术负责人",
                "technologies": ["React", "Node.js"],
                "duration": 12
              }
            ],
            "performance": {
              "rating": 4.5,
              "completedTasks": 25,
              "pendingTasks": 3
            }
          },
          {
            "id": "emp_002",
            "name": "李四",
            "skills": ["Python", "Django", "PostgreSQL"],
            "projects": [
              {
                "name": "项目C",
                "role": "后端开发",
                "technologies": ["Django", "PostgreSQL"],
                "duration": 8
              }
            ],
            "performance": {
              "rating": 4.2,
              "completedTasks": 20,
              "pendingTasks": 5
            }
          }
        ]
      },
      {
        "name": "设计部",
        "employees": [
          {
            "id": "emp_003",
            "name": "王五",
            "skills": ["Photoshop", "Illustrator", "UI设计"],
            "projects": [
              {
                "name": "项目A",
                "role": "UI设计师",
                "technologies": ["Photoshop", "Illustrator"],
                "duration": 6
              }
            ],
            "performance": {
              "rating": 4.8,
              "completedTasks": 30,
              "pendingTasks": 2
            }
          }
        ]
      }
    ]
  }
};

// 查询1：获取所有员工的姓名
const allEmployees = JSONPath({
  path: '$.company.departments[*].employees[*].name',
  json: complexData
});
console.log("所有员工姓名:", allEmployees);

// 查询2：获取掌握JavaScript技能的员工
const jsEmployees = JSONPath({
  path: '$.company.departments[*].employees[?(@.skills && @.skills.includes("JavaScript"))]',
  json: complexData
});
console.log("掌握JavaScript的员工:", jsEmployees.map(emp => emp.name));

// 查询3：获取绩效评分大于4.5的员工
const highPerformers = JSONPath({
  path: '$.company.departments[*].employees[?(@.performance.rating > 4.5)]',
  json: complexData
});
console.log("高绩效员工:", highPerformers.map(emp => ({ name: emp.name, rating: emp.performance.rating })));

// 查询4：获取所有使用React技术的项目
const reactProjects = JSONPath({
  path: '$.company.departments[*].employees[*].projects[?(@.technologies.includes("React"))].name',
  json: complexData
});
console.log("使用React的项目:", reactProjects);

// 查询5：获取完成任务数大于20的员工
const productiveEmployees = JSONPath({
  path: '$.company.departments[*].employees[?(@.performance.completedTasks > 20)]',
  json: complexData
});
console.log("高生产力员工:", productiveEmployees.map(emp => ({ 
  name: emp.name, 
  completed: emp.performance.completedTasks 
})));
```

## JSON查询性能优化

### 查询优化策略

1. **避免过度使用递归下降**：`$..` 操作符很强大但性能较低
2. **使用具体路径代替通配符**：`$.store.book` 优于 `$.store.*`
3. **尽早过滤数据**：在路径早期使用过滤条件
4. **缓存查询结果**：对重复查询进行缓存

```javascript
// 性能优化示例
const {JSONPath} = require('jsonpath-plus');

// 低效查询：使用递归下降
const inefficientQuery = '$..name';

// 高效查询：使用具体路径
const efficientQuery = '$.company.departments[*].employees[*].name';

// 低效查询：先获取所有数据再过滤
const inefficientFilter = '$.company.departments[*].employees[*]';

// 高效查询：在路径中尽早过滤
const efficientFilter = '$.company.departments[*].employees[?(@.performance.rating > 4.5)]';

// 查询缓存
const queryCache = new Map();

function cachedQuery(data, path) {
  const cacheKey = JSON.stringify(data) + '|' + path;
  
  if (queryCache.has(cacheKey)) {
    return queryCache.get(cacheKey);
  }
  
  const result = JSONPath({path, json: data});
  queryCache.set(cacheKey, result);
  return result;
}
```

### 大数据集处理

```javascript
// 处理大型JSON数据集的策略
const fs = require('fs');
const {JSONPath} = require('jsonpath-plus');

// 流式处理大型JSON文件
function processLargeJson(filePath, query, batchSize = 1000) {
  const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
  
  // 如果数据是数组，分批处理
  if (Array.isArray(data)) {
    const results = [];
    
    for (let i = 0; i < data.length; i += batchSize) {
      const batch = data.slice(i, i + batchSize);
      const batchResults = JSONPath({path: query, json: batch});
      results.push(...batchResults);
    }
    
    return results;
  } else {
    return JSONPath({path: query, json: data});
  }
}

// 使用示例
const results = processLargeJson('large_dataset.json', '$.users[?(@.age > 25)]');
console.log(`找到 ${results.length} 个年龄大于25的用户`);
```

## 实验环节：JSON查询实践

### 实验1：构建电商数据查询系统

使用JSONPath构建一个电商数据查询系统，包含以下功能：

1. 产品查询（按分类、价格区间等）
2. 用户订单查询（按用户ID、日期范围等）
3. 库存查询（按产品、仓库等）
4. 销售数据分析（按时间、地区等）

### 实验2：JSON查询性能对比

比较不同查询方式的性能：

1. 直接对象访问 vs JSONPath查询
2. 不同JSONPath表达式的性能差异
3. 不同JSONPath库的性能对比
4. 查询缓存的性能提升

### 实验3：查询结果可视化

创建一个工具，可视化JSONPath查询结果：

1. 显示查询路径和结果
2. 高亮匹配的节点
3. 提供查询编辑器
4. 支持查询历史记录

## 小结

本节我们深入探讨了JSON查询与路径：

1. **JSON路径表达式基础**：
   - JSONPath语法（$、.、[]、*、..等）
   - 基本路径表达式（访问对象属性、数组元素、通配符等）
   - 递归下降、过滤表达式、脚本表达式

2. **高级JSON查询技术**：
   - 复合过滤器
   - 脚本表达式
   - 范围选择
   - 条件提取

3. **JSON查询库与工具**：
   - JavaScript中的JSONPath查询（jsonpath-plus）
   - Python中的JSONPath查询（jsonpath-ng）
   - 高级查询场景

4. **JSON查询性能优化**：
   - 查询优化策略
   - 大数据集处理
   - 查询缓存

JSON查询技术为我们提供了一种强大而灵活的方式来从复杂的JSON结构中提取和操作数据，是现代数据驱动应用的重要工具。在下一节中，我们将探讨JSON转换与处理，了解如何在不同的数据格式之间进行转换和操作。

## 代码示例

请查看`code/chapter5/querying-paths`目录，其中包含了：

1. `store_data.json` - 示例商店数据
2. `company_data.json` - 示例公司数据
3. `jsonpath_examples.js` - JavaScript JSONPath示例
4. `jsonpath_examples.py` - Python JSONPath示例
5. `complex_queries.js` - 复杂查询示例
6. `query_performance.js` - 查询性能测试
7. `query_cache.js` - 查询缓存实现
8. `streaming_query.js` - 流式查询处理
9. `query_visualizer.js` - 查询结果可视化工具
10. `ecommerce_query_system.js` - 电商数据查询系统示例