# 5.1 JSON验证与Schema

## JSON验证的重要性

在复杂的数据交换场景中，确保JSON数据符合预期的结构和类型是至关重要的。JSON验证可以帮助我们：

1. **数据完整性检查**：确保所有必需字段都存在
2. **类型安全**：验证字段值是否为正确的数据类型
3. **业务规则验证**：确保数据符合业务逻辑约束
4. **API契约保障**：验证请求和响应是否符合API规范
5. **错误预防**：在数据处理早期发现结构错误

## JSON Schema简介

JSON Schema是一种用于验证JSON文档结构的规范。它定义了一个JSON文档应该具有的结构、数据类型和约束条件。JSON Schema本身也是一个JSON文档。

### JSON Schema的基本结构

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "用户信息",
  "description": "用户基本信息的数据结构",
  "type": "object",
  "properties": {
    "id": {
      "description": "用户唯一标识",
      "type": "string",
      "pattern": "^user_[0-9]+$"
    },
    "name": {
      "description": "用户姓名",
      "type": "string",
      "minLength": 1,
      "maxLength": 50
    },
    "email": {
      "description": "用户邮箱",
      "type": "string",
      "format": "email"
    },
    "age": {
      "description": "用户年龄",
      "type": "integer",
      "minimum": 0,
      "maximum": 150
    },
    "isActive": {
      "description": "用户是否激活",
      "type": "boolean"
    },
    "roles": {
      "description": "用户角色列表",
      "type": "array",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "profile": {
      "description": "用户详细资料",
      "type": "object",
      "properties": {
        "bio": {
          "description": "个人简介",
          "type": "string"
        },
        "avatar": {
          "description": "头像URL",
          "type": "string",
          "format": "uri"
        }
      }
    }
  },
  "required": ["id", "name", "email"],
  "additionalProperties": false
}
```

## JSON Schema核心概念

### 1. 类型验证

JSON Schema支持多种数据类型验证：

```json
{
  "type": "object",
  "properties": {
    "stringField": {
      "type": "string"
    },
    "numberField": {
      "type": "number"
    },
    "integerField": {
      "type": "integer"
    },
    "booleanField": {
      "type": "boolean"
    },
    "arrayField": {
      "type": "array"
    },
    "objectField": {
      "type": "object"
    },
    "nullField": {
      "type": "null"
    }
  }
}
```

### 2. 多类型验证

允许一个字段可以是多种类型之一：

```json
{
  "type": "object",
  "properties": {
    "id": {
      "description": "用户ID，可以是字符串或数字",
      "type": ["string", "integer"]
    },
    "metadata": {
      "description": "元数据，可以是对象或null",
      "type": ["object", "null"]
    }
  }
}
```

### 3. 字符串验证

字符串类型的各种验证选项：

```json
{
  "type": "object",
  "properties": {
    "username": {
      "type": "string",
      "minLength": 3,
      "maxLength": 20,
      "pattern": "^[a-zA-Z0-9_]+$"
    },
    "email": {
      "type": "string",
      "format": "email"
    },
    "website": {
      "type": "string",
      "format": "uri"
    },
    "birthdate": {
      "type": "string",
      "format": "date"
    },
    "description": {
      "type": "string",
      "maxLength": 500
    }
  }
}
```

### 4. 数字验证

数字类型的验证选项：

```json
{
  "type": "object",
  "properties": {
    "age": {
      "type": "integer",
      "minimum": 0,
      "maximum": 150
    },
    "price": {
      "type": "number",
      "minimum": 0,
      "exclusiveMinimum": 0,  // 大于0
      "multipleOf": 0.01     // 必须是0.01的倍数
    },
    "rating": {
      "type": "number",
      "minimum": 1,
      "maximum": 5,
      "multipleOf": 0.5
    }
  }
}
```

### 5. 数组验证

数组类型的验证选项：

```json
{
  "type": "object",
  "properties": {
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "maxItems": 10,
      "uniqueItems": true
    },
    "scores": {
      "type": "array",
      "items": {
        "type": "number",
        "minimum": 0,
        "maximum": 100
      },
      "minItems": 1
    },
    "mixedArray": {
      "type": "array",
      "items": [
        {
          "type": "string"
        },
        {
          "type": "number"
        },
        {
          "type": "boolean"
        }
      ],
      "additionalItems": false
    }
  }
}
```

### 6. 对象验证

对象类型的验证选项：

```json
{
  "type": "object",
  "properties": {
    "user": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "email": {
          "type": "string"
        }
      },
      "required": ["id", "name"],
      "additionalProperties": false
    },
    "config": {
      "type": "object",
      "patternProperties": {
        "^env_": {
          "type": "string"
        }
      },
      "additionalProperties": {
        "type": "boolean"
      }
    }
  }
}
```

### 7. 条件验证

使用`if`、`then`、`else`和`dependentRequired`实现条件验证：

```json
{
  "type": "object",
  "properties": {
    "userType": {
      "type": "string",
      "enum": ["student", "teacher", "admin"]
    },
    "studentId": {
      "type": "string"
    },
    "employeeId": {
      "type": "string"
    },
    "adminLevel": {
      "type": "integer"
    }
  },
  "if": {
    "properties": {
      "userType": {
        "const": "student"
      }
    }
  },
  "then": {
    "required": ["studentId"],
    "properties": {
      "studentId": {
        "pattern": "^STU_[0-9]+$"
      }
    }
  },
  "else": {
    "if": {
      "properties": {
        "userType": {
          "const": "teacher"
        }
      }
    },
    "then": {
      "required": ["employeeId"]
    },
    "else": {
      "if": {
        "properties": {
          "userType": {
            "const": "admin"
          }
        }
      },
      "then": {
        "required": ["employeeId", "adminLevel"],
        "properties": {
          "adminLevel": {
            "minimum": 1,
            "maximum": 5
          }
        }
      }
    }
  }
}
```

## 高级Schema特性

### 1. 组合模式

使用`allOf`、`anyOf`、`oneOf`和`not`组合多个模式：

```json
{
  "type": "object",
  "properties": {
    "person": {
      "allOf": [
        {
          "type": "object",
          "properties": {
            "name": {
              "type": "string"
            },
            "age": {
              "type": "integer"
            }
          },
          "required": ["name"]
        },
        {
          "type": "object",
          "properties": {
            "email": {
              "type": "string",
              "format": "email"
            }
          },
          "required": ["email"]
        }
      ]
    },
    "contactMethod": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "type": {
              "const": "email"
            },
            "address": {
              "type": "string",
              "format": "email"
            }
          },
          "required": ["type", "address"]
        },
        {
          "type": "object",
          "properties": {
            "type": {
              "const": "phone"
            },
            "number": {
              "type": "string"
            }
          },
          "required": ["type", "number"]
        }
      ]
    },
    "notNegative": {
      "type": "number",
      "not": {
        "type": "number",
        "exclusiveMaximum": 0
      }
    }
  }
}
```

### 2. 引用和重用

使用`$ref`引用其他模式，实现模式重用：

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "definitions": {
    "address": {
      "type": "object",
      "properties": {
        "street": {
          "type": "string"
        },
        "city": {
          "type": "string"
        },
        "state": {
          "type": "string"
        },
        "zipCode": {
          "type": "string",
          "pattern": "^[0-9]{5}(-[0-9]{4})?$"
        }
      },
      "required": ["street", "city", "state", "zipCode"]
    },
    "contact": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["email", "phone", "mail"]
        },
        "value": {
          "type": "string"
        }
      },
      "required": ["type", "value"]
    }
  },
  "type": "object",
  "properties": {
    "id": {
      "type": "string"
    },
    "name": {
      "type": "string"
    },
    "shippingAddress": {
      "$ref": "#/definitions/address"
    },
    "billingAddress": {
      "$ref": "#/definitions/address"
    },
    "contacts": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/contact"
      }
    }
  },
  "required": ["id", "name", "shippingAddress"]
}
```

### 3. 自定义验证

使用自定义关键字扩展验证功能：

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "username": {
      "type": "string",
      "minLength": 3,
      "maxLength": 20
    },
    "password": {
      "type": "string",
      "minLength": 8
    },
    "confirmPassword": {
      "type": "string"
    }
  },
  "required": ["username", "password", "confirmPassword"],
  "customValidation": {
    "passwordMatch": {
      "description": "密码和确认密码必须匹配",
      "function": "function(data) { return data.password === data.confirmPassword; }"
    }
  }
}
```

## JSON Schema验证工具

### 1. JavaScript中的验证

使用`ajv`库进行JSON Schema验证：

```javascript
const Ajv = require("ajv");
const addFormats = require("ajv-formats");

// 创建AJV实例
const ajv = new Ajv({ allErrors: true });
addFormats(ajv);

// 定义JSON Schema
const userSchema = {
  type: "object",
  properties: {
    id: { type: "string", pattern: "^user_[0-9]+$" },
    name: { type: "string", minLength: 1, maxLength: 50 },
    email: { type: "string", format: "email" },
    age: { type: "integer", minimum: 0, maximum: 150 },
    isActive: { type: "boolean" },
    roles: { 
      type: "array", 
      items: { type: "string" },
      uniqueItems: true 
    }
  },
  required: ["id", "name", "email"],
  additionalProperties: false
};

// 编译Schema
const validate = ajv.compile(userSchema);

// 验证数据
function validateUser(userData) {
  const valid = validate(userData);
  
  if (valid) {
    console.log("数据验证通过");
    return true;
  } else {
    console.log("数据验证失败:");
    validate.errors.forEach(error => {
      console.log(`- ${error.instancePath || 'root'}: ${error.message}`);
    });
    return false;
  }
}

// 测试数据
const validUser = {
  id: "user_123",
  name: "张三",
  email: "zhangsan@example.com",
  age: 30,
  isActive: true,
  roles: ["user", "editor"]
};

const invalidUser = {
  id: "123",  // 不匹配模式
  name: "",   // 太短
  email: "invalid-email",  // 无效邮箱格式
  age: -5,    // 小于最小值
  roles: ["user", "user"]  // 重复项
};

validateUser(validUser);    // 验证通过
validateUser(invalidUser);  // 验证失败
```

### 2. Python中的验证

使用`jsonschema`库进行JSON Schema验证：

```python
import json
from jsonschema import validate, ValidationError, Draft7Validator
from jsonschema.exceptions import SchemaError

# 定义JSON Schema
user_schema = {
    "type": "object",
    "properties": {
        "id": {"type": "string", "pattern": "^user_[0-9]+$"},
        "name": {"type": "string", "minLength": 1, "maxLength": 50},
        "email": {"type": "string", "format": "email"},
        "age": {"type": "integer", "minimum": 0, "maximum": 150},
        "isActive": {"type": "boolean"},
        "roles": {
            "type": "array",
            "items": {"type": "string"},
            "uniqueItems": True
        }
    },
    "required": ["id", "name", "email"],
    "additionalProperties": False
}

# 验证函数
def validate_user(user_data):
    try:
        validate(instance=user_data, schema=user_schema)
        print("数据验证通过")
        return True
    except ValidationError as e:
        print(f"数据验证失败: {e.message}")
        print(f"错误路径: {' -> '.join(map(str, e.path)) if e.path else 'root'}")
        return False
    except SchemaError as e:
        print(f"Schema错误: {e.message}")
        return False

# 获取所有验证错误的函数
def get_validation_errors(user_data):
    validator = Draft7Validator(user_schema)
    errors = sorted(validator.iter_errors(user_data), key=lambda e: e.path)
    
    if not errors:
        return None
    
    error_list = []
    for error in errors:
        path = " -> ".join(map(str, error.path)) if error.path else "root"
        error_list.append({
            "path": path,
            "message": error.message,
            "failed_value": error.instance
        })
    
    return error_list

# 测试数据
valid_user = {
    "id": "user_123",
    "name": "张三",
    "email": "zhangsan@example.com",
    "age": 30,
    "isActive": True,
    "roles": ["user", "editor"]
}

invalid_user = {
    "id": "123",  # 不匹配模式
    "name": "",   # 太短
    "email": "invalid-email",  # 无效邮箱格式
    "age": -5,    # 小于最小值
    "roles": ["user", "user"]  # 重复项
}

# 测试
validate_user(valid_user)  # 验证通过
validate_user(invalid_user)  # 验证失败

# 获取所有错误
errors = get_validation_errors(invalid_user)
if errors:
    print("\n所有验证错误:")
    for error in errors:
        print(f"- {error['path']}: {error['message']} (值: {error['failed_value']})")
```

## 实际应用场景

### 1. API请求验证

使用JSON Schema验证API请求：

```javascript
// 用户注册API的Schema
const registrationSchema = {
  type: "object",
  properties: {
    username: {
      type: "string",
      minLength: 3,
      maxLength: 20,
      pattern: "^[a-zA-Z0-9_]+$"
    },
    email: {
      type: "string",
      format: "email"
    },
    password: {
      type: "string",
      minLength: 8,
      pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]"
    },
    confirmPassword: {
      type: "string",
      const: { "$data": "1/password" }
    },
    birthDate: {
      type: "string",
      format: "date"
    },
    terms: {
      type: "boolean",
      const: true
    }
  },
  required: ["username", "email", "password", "confirmPassword", "terms"],
  additionalProperties: false
};

// API端点处理函数
async function registerUser(req, res) {
  // 验证请求数据
  if (!validate(req.body, registrationSchema)) {
    return res.status(400).json({
      success: false,
      message: "请求数据无效",
      errors: validate.errors
    });
  }
  
  try {
    // 创建用户
    const user = await userService.create(req.body);
    res.status(201).json({
      success: true,
      message: "用户注册成功",
      data: {
        id: user.id,
        username: user.username,
        email: user.email
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: "注册失败，请稍后重试"
    });
  }
}
```

### 2. 配置文件验证

验证应用程序配置文件：

```python
import json
import yaml
from jsonschema import validate, ValidationError

# 配置文件Schema
config_schema = {
    "type": "object",
    "properties": {
        "server": {
            "type": "object",
            "properties": {
                "host": {"type": "string"},
                "port": {"type": "integer", "minimum": 1, "maximum": 65535},
                "ssl": {"type": "boolean"}
            },
            "required": ["host", "port"],
            "additionalProperties": False
        },
        "database": {
            "type": "object",
            "properties": {
                "type": {"type": "string", "enum": ["postgresql", "mysql", "sqlite"]},
                "host": {"type": "string"},
                "port": {"type": "integer"},
                "name": {"type": "string"},
                "credentials": {
                    "type": "object",
                    "properties": {
                        "username": {"type": "string"},
                        "password": {"type": "string"}
                    },
                    "required": ["username", "password"],
                    "additionalProperties": False
                }
            },
            "required": ["type", "name"],
            "additionalProperties": False
        },
        "logging": {
            "type": "object",
            "properties": {
                "level": {"type": "string", "enum": ["debug", "info", "warning", "error", "critical"]},
                "file": {"type": "string"},
                "console": {"type": "boolean"}
            },
            "additionalProperties": False
        }
    },
    "required": ["server", "database"],
    "additionalProperties": False
}

def load_config(config_path):
    """加载并验证配置文件"""
    # 根据文件扩展名选择解析器
    with open(config_path, 'r') as f:
        if config_path.endswith('.json'):
            config = json.load(f)
        elif config_path.endswith(('.yml', '.yaml')):
            config = yaml.safe_load(f)
        else:
            raise ValueError("不支持的配置文件格式")
    
    # 验证配置
    try:
        validate(instance=config, schema=config_schema)
        print("配置文件验证通过")
        return config
    except ValidationError as e:
        print(f"配置文件验证失败: {e.message}")
        print(f"错误路径: {' -> '.join(map(str, e.path)) if e.path else 'root'}")
        return None

# 使用示例
config = load_config("app_config.json")
if config:
    print("配置加载成功")
    # 使用配置启动应用
    start_app(config)
```

## 实验环节：JSON Schema设计与验证

### 实验1：设计电商产品Schema

设计一个电商产品的JSON Schema，包含：

1. 产品基本信息（ID、名称、描述、价格等）
2. 产品分类
3. 产品属性（根据类型不同而有不同属性）
4. 库存信息
5. 评价信息

**要求**：
- 使用适当的验证规则
- 使用条件验证
- 使用引用和重用
- 测试有效和无效的数据

### 实验2：构建Schema验证器

构建一个通用的JSON Schema验证器，支持：

1. 多种格式输入（JSON、YAML）
2. 详细的错误报告
3. 自定义验证规则
4. 批量验证
5. 报告生成

### 实验3：Schema版本管理

设计一个支持Schema版本管理的系统，包含：

1. Schema版本定义和存储
2. 数据版本兼容性检查
3. 自动数据迁移
4. 版本回滚机制

## 小结

本节我们深入探讨了JSON验证与Schema：

1. **JSON验证的重要性**：
   - 数据完整性检查
   - 类型安全
   - 业务规则验证
   - API契约保障
   - 错误预防

2. **JSON Schema核心概念**：
   - 类型验证（字符串、数字、布尔值、数组、对象、null）
   - 多类型验证
   - 字符串验证（长度、格式、模式）
   - 数字验证（范围、倍数）
   - 数组验证（项目类型、长度、唯一性）
   - 对象验证（属性、必需属性、额外属性）
   - 条件验证（if/then/else、dependentRequired）

3. **高级Schema特性**：
   - 组合模式（allOf、anyOf、oneOf、not）
   - 引用和重用（$ref、definitions）
   - 自定义验证

4. **JSON Schema验证工具**：
   - JavaScript中的验证（ajv库）
   - Python中的验证（jsonschema库）

5. **实际应用场景**：
   - API请求验证
   - 配置文件验证

JSON Schema为JSON数据提供了强大的验证机制，确保数据在不同系统间的交换过程中保持一致性和完整性。在下一节中，我们将探讨JSON查询与路径，了解如何高效地从JSON数据中提取和操作信息。

## 代码示例

请查看`code/chapter5/validation-schema`目录，其中包含了：

1. `user_schema.json` - 用户信息Schema
2. `product_schema.json` - 产品信息Schema
3. `api_request_schema.json` - API请求Schema
4. `config_schema.json` - 配置文件Schema
5. `javascript_validator.js` - JavaScript验证器示例
6. `python_validator.py` - Python验证器示例
7. `api_validation.js` - API请求验证示例
8. `config_validation.py` - 配置文件验证示例
9. `schema_versioning.py` - Schema版本管理示例
10. `custom_validation.js` - 自定义验证示例