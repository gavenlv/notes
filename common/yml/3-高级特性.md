# 第3章：YAML高级特性

## 3.1 锚点与别名

YAML的锚点（Anchor）和别名（Alias）机制允许我们在文档中定义一次数据，然后在多个地方引用它，类似于编程语言中的变量。

### 3.1.1 基本锚点和别名

使用`&`定义锚点，使用`*`引用别名：

```yaml
# 基本锚点和别名示例
defaults: &defaults
  timeout: 30
  retries: 3
  log_level: info

production:
  <<: *defaults
  host: prod.example.com
  port: 443

staging:
  <<: *defaults
  host: staging.example.com
  port: 8443
```

### 3.1.2 覆盖锚点值

可以在引用锚点后覆盖特定值：

```yaml
# 覆盖锚点值示例
base_config: &base_config
  timeout: 30
  retries: 3
  log_level: info

development:
  <<: *base_config
  log_level: debug  # 覆盖基础配置中的log_level
  host: dev.example.com
```

### 3.1.3 嵌套锚点

锚点可以嵌套在其他结构中：

```yaml
# 嵌套锚点示例
database: &database
  host: localhost
  port: 5432
  user: admin

services:
  web:
    database: *database
    port: 8080
  api:
    database: *database
    port: 8081
```

### 3.1.4 多个锚点

可以定义多个锚点并根据需要引用：

```yaml
# 多个锚点示例
http_config: &http_config
  protocol: http
  timeout: 30

https_config: &https_config
  protocol: https
  timeout: 60
  verify_ssl: true

services:
  web:
    <<: *http_config
    port: 80
  secure_web:
    <<: *https_config
    port: 443
  api:
    <<: *http_config
    port: 8080
  secure_api:
    <<: *https_config
    port: 8443
```

## 3.2 合并键

合并键（Merge Key，`<<:`）允许将一个或多个映射合并到当前映射中。

### 3.2.1 单个映射合并

```yaml
# 单个映射合并示例
base: &base
  name: John
  age: 30

person:
  <<: *base
  occupation: Developer
```

### 3.2.2 多个映射合并

```yaml
# 多个映射合并示例
personal_info: &personal_info
  name: Jane
  age: 25

contact_info: &contact_info
  email: jane@example.com
  phone: 555-1234

full_profile:
  <<: *personal_info
  <<: *contact_info
  occupation: Designer
```

### 3.2.3 合并顺序与覆盖

当合并多个映射时，后面的映射会覆盖前面的映射：

```yaml
# 合并顺序与覆盖示例
first: &first
  key1: value1
  key2: value2

second: &second
  key2: new_value2  # 会覆盖first中的key2
  key3: value3

merged:
  <<: *first
  <<: *second
  key4: value4
# 结果: key1=value1, key2=new_value2, key3=value3, key4=value4
```

## 3.3 标签与类型系统

YAML提供了丰富的标签系统，用于指定和自定义数据类型。

### 3.3.1 全局标签

```yaml
# 全局标签示例
string_value: !!str 123
integer_value: !!int "456"
float_value: !!float "3.14"
boolean_value: !!bool "true"
null_value: !!null "null"
timestamp_value: !!timestamp "2023-05-15T14:30:00Z"
binary_value: !!binary R0lGODlhDAAMAIQAAP//9/X17unp5WZmZgAAAOfn515eXvPz7Y6OjuDg4J+fn5OTk6enp56enmleECcgggoBADs=
```

### 3.3.2 自定义类型

```yaml
# 自定义类型示例
person: !person
  name: John Doe
  age: 30
  email: john@example.com

address: !address
  street: 123 Main St
  city: Anytown
  zip: 12345
```

### 3.3.3 本地标签

```yaml
# 本地标签示例
!!python/object:__main__.Person
name: John Doe
age: 30
```

## 3.4 多文档流

YAML支持在单个文件中包含多个文档，使用`---`分隔文档，使用`...`结束文档。

### 3.4.1 基本多文档

```yaml
# 基本多文档示例
---
# 文档1
name: John
age: 30
...
---
# 文档2
name: Jane
age: 25
...
```

### 3.4.2 多文档处理

```python
# Python处理多文档YAML
import yaml

with open('multi_document.yml', 'r') as file:
    documents = list(yaml.safe_load_all(file))
    for doc in documents:
        print(doc)
```

## 3.5 高级字符串处理

### 3.5.1 块标量详细控制

```yaml
# 块标量详细控制
literal_block: |
  This is a literal block
  It preserves all line breaks
  And indentation

folded_block: >
  This is a folded block
  It converts line breaks to spaces
  Creating a single paragraph

# 带缩进的块标量
indented_literal: |2
  This block has 2 spaces of indentation
  All lines are indented by at least 2 spaces
  Relative indentation is preserved

# 带缩进的折叠标量
indented_folded: >2
  This folded block has 2 spaces of indentation
  Line breaks are converted to spaces
  But the overall indentation is preserved
```

### 3.5.2 字符串中的特殊字符

```yaml
# 字符串中的特殊字符
escaped_chars: "This contains a \"quote\" and a \\ backslash"
unicode_chars: "Unicode: 中文测试"
newlines: "Line 1\nLine 2"
tabs: "Column1\tColumn2"
```

## 3.6 条件与循环

虽然YAML本身不支持编程逻辑，但可以通过一些技巧实现类似条件与循环的效果。

### 3.6.1 使用锚点模拟条件

```yaml
# 使用锚点模拟条件
default_config: &default_config
  timeout: 30
  retries: 3

development_config: &development_config
  <<: *default_config
  debug: true
  log_level: debug

production_config: &production_config
  <<: *default_config
  debug: false
  log_level: info

# 根据环境选择配置
environment: development
config: 
  <<: *development_config
```

### 3.6.2 使用序列模拟循环

```yaml
# 使用序列模拟循环
servers:
  - &server_template
    cpu: 2
    memory: 4GB
    disk: 20GB
  - <<: *server_template
    name: web-1
    ip: 192.168.1.10
  - <<: *server_template
    name: web-2
    ip: 192.168.1.11
  - <<: *server_template
    name: web-3
    ip: 192.168.1.12
```

## 3.7 模式验证与Schema

### 3.7.1 YAML Schema

YAML Schema用于验证YAML文档的结构和内容：

```yaml
# YAML Schema示例
type: object
properties:
  name:
    type: string
  age:
    type: integer
    minimum: 0
    maximum: 150
  email:
    type: string
    format: email
required:
  - name
  - age
```

### 3.7.2 使用PyKwalify验证

```python
# 使用PyKwalify验证YAML
from pykwalify.core import Core
from pykwalify.errors import SchemaError

# 定义schema
schema = {
    "type": "map",
    "mapping": {
        "name": {"type": "str", "required": True},
        "age": {"type": "int", "required": True},
        "email": {"type": "str", "required": False}
    }
}

# 验证YAML数据
data = {
    "name": "John",
    "age": 30,
    "email": "john@example.com"
}

c = Core(source_data=data, schema_data=schema)
try:
    c.validate()
    print("验证成功")
except SchemaError as e:
    print(f"验证失败: {e}")
```

## 3.8 安全考虑

### 3.8.1 安全加载YAML

```python
# 安全加载YAML
import yaml

# 不安全：可能执行任意Python代码
# data = yaml.load(yaml_string)

# 安全：只加载基本YAML标签
data = yaml.safe_load(yaml_string)

# 更安全：加载所有YAML标签但不执行Python对象
data = yaml.safe_load_all(yaml_string)
```

### 3.8.2 避免代码注入

```yaml
# 危险：可能执行任意代码
!!python/object/apply:os.system ["echo 'Hello, World!'"]

# 安全：只使用基本数据类型
name: John
age: 30
```

## 3.9 实验与验证

### 实验1：锚点与别名

```yaml
# anchors_and_aliases.yml
# 锚点与别名示例
---
# 基本锚点和别名
defaults: &defaults
  timeout: 30
  retries: 3
  log_level: info

production:
  <<: *defaults
  host: prod.example.com
  port: 443

staging:
  <<: *defaults
  host: staging.example.com
  port: 8443
  log_level: debug  # 覆盖默认值

# 嵌套锚点
database: &database
  host: localhost
  port: 5432
  user: admin
  password: secret

services:
  web:
    database: *database
    port: 8080
  api:
    database: *database
    port: 8081
    timeout: 60  # 覆盖默认值
```

### 实验2：多文档流

```yaml
# multi_document.yml
# 多文档流示例
---
# 文档1：用户信息
name: John Doe
age: 30
email: john@example.com
...
---
# 文档2：用户设置
theme: dark
notifications: true
language: en-US
...
---
# 文档3：用户权限
permissions:
  - read
  - write
  - delete
roles:
  - admin
  - editor
...
```

### 实验3：高级字符串处理

```yaml
# advanced_strings.yml
# 高级字符串处理示例
---
# 块标量
literal_block: |
  This is a literal block
  It preserves all line breaks
  And indentation exactly as written

folded_block: >
  This is a folded block
  It converts line breaks to spaces
  Creating a single paragraph

# 带缩进的块标量
indented_literal: |2
  This block has 2 spaces of indentation
  All lines are indented by at least 2 spaces
  Relative indentation is preserved

# 带缩进的折叠标量
indented_folded: >2
  This folded block has 2 spaces of indentation
  Line breaks are converted to spaces
  But the overall indentation is preserved

# 特殊字符
escaped_chars: "This contains a \"quote\" and a \\ backslash"
unicode_chars: "Unicode: 中文测试"
newlines: "Line 1\nLine 2"
tabs: "Column1\tColumn2"
```

### 实验4：自定义类型

```yaml
# custom_types.yml
# 自定义类型示例
---
# 自定义类型定义
person: !person
  name: John Doe
  age: 30
  email: john@example.com

address: !address
  street: 123 Main St
  city: Anytown
  zip: 12345

# 复杂自定义类型
company: !company
  name: Tech Corp
  founded: 2010
  employees: 150
  address: !address
    street: 456 Business Ave
    city: San Francisco
    zip: 94105
  ceo: !person
    name: Jane Smith
    age: 45
    email: jane@techcorp.com
```

## 3.10 实验验证代码

```python
# advanced_features.py
import yaml
import json

def test_anchors_and_aliases():
    """测试锚点与别名"""
    print("=== 锚点与别名测试 ===")
    with open('anchors_and_aliases.yml', 'r', encoding='utf-8') as file:
        data = yaml.safe_load(file)
        print("生产环境配置:")
        print(json.dumps(data['production'], indent=2))
        print("\nAPI服务配置:")
        print(json.dumps(data['services']['api'], indent=2))

def test_multi_document():
    """测试多文档流"""
    print("\n=== 多文档流测试 ===")
    with open('multi_document.yml', 'r', encoding='utf-8') as file:
        documents = list(yaml.safe_load_all(file))
        for i, doc in enumerate(documents, 1):
            print(f"\n文档 {i}:")
            print(json.dumps(doc, indent=2, ensure_ascii=False))

def test_advanced_strings():
    """测试高级字符串处理"""
    print("\n=== 高级字符串处理测试 ===")
    with open('advanced_strings.yml', 'r', encoding='utf-8') as file:
        data = yaml.safe_load(file)
        
        print("字面量块:")
        print(repr(data['literal_block']))
        print("\n折叠块:")
        print(repr(data['folded_block']))
        print("\n缩进字面量块:")
        print(repr(data['indented_literal']))
        print("\n缩进折叠块:")
        print(repr(data['indented_folded']))
        print("\n特殊字符:")
        print(f"转义字符: {data['escaped_chars']}")
        print(f"Unicode字符: {data['unicode_chars']}")
        print(f"换行符: {repr(data['newlines'])}")
        print(f"制表符: {repr(data['tabs'])}")

def test_custom_types():
    """测试自定义类型"""
    print("\n=== 自定义类型测试 ===")
    with open('custom_types.yml', 'r', encoding='utf-8') as file:
        data = yaml.safe_load(file)
        print("人物信息:")
        print(json.dumps(data['person'], indent=2, ensure_ascii=False))
        print("\n地址信息:")
        print(json.dumps(data['address'], indent=2, ensure_ascii=False))
        print("\n公司信息:")
        print(json.dumps(data['company'], indent=2, ensure_ascii=False))

def test_yaml_merge():
    """测试YAML合并"""
    print("\n=== YAML合并测试 ===")
    yaml_content = """
base: &base
  key1: value1
  key2: value2

override: &override
  key2: new_value2
  key3: value3

merged:
  <<: *base
  <<: *override
  key4: value4
"""
    data = yaml.safe_load(yaml_content)
    print("合并结果:")
    print(json.dumps(data['merged'], indent=2))

def test_security():
    """测试YAML安全性"""
    print("\n=== YAML安全性测试 ===")
    
    # 安全加载
    safe_yaml = "name: John\nage: 30"
    safe_data = yaml.safe_load(safe_yaml)
    print(f"安全加载: {safe_data}")
    
    # 不安全加载（仅作演示，实际应用中避免使用）
    try:
        # 这里只是演示，实际不要加载不可信的YAML
        unsafe_yaml = "name: !!python/object/apply:os.system ['echo Hello']"
        # unsafe_data = yaml.load(unsafe_yaml)  # 不安全，可能执行代码
        print("不安全加载示例已跳过，以避免执行潜在危险代码")
    except Exception as e:
        print(f"不安全加载失败: {e}")

# 运行所有测试
test_anchors_and_aliases()
test_multi_document()
test_advanced_strings()
test_custom_types()
test_yaml_merge()
test_security()
```

## 3.11 总结

本章介绍了YAML的高级特性：

1. **锚点与别名**：通过`&`和`*`实现数据重用
2. **合并键**：使用`<<:`合并多个映射
3. **标签与类型系统**：全局标签、自定义类型和本地标签
4. **多文档流**：在单个文件中包含多个文档
5. **高级字符串处理**：块标量、特殊字符处理
6. **条件与循环**：通过锚点和序列模拟编程逻辑
7. **模式验证与Schema**：验证YAML文档结构和内容
8. **安全考虑**：安全加载YAML，避免代码注入

掌握这些高级特性后，我们可以更加灵活和高效地使用YAML。在下一章中，我们将通过实际应用案例来展示YAML在各种场景中的使用方法。